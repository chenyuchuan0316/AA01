<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AA01計畫助手（快速填寫）</title>

  <!-- 行動端視窗與 iOS 安全區域 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover, user-scalable=yes" />
  <!-- 避免 iOS 自動辨識電話/Email 造成版面跳動 -->
  <meta name="format-detection" content="telephone=no, email=no, address=no" />
  <!-- 目前採用亮色；若未來要支援暗色可改為 "light dark" -->
  <meta name="color-scheme" content="light" />

  <style>
    /* ===== AA01 表單 — 放大字級、強對比、兩欄桌機、單欄手機、觸控友善 =====
       尺寸基準（依需求可再調）：
       - 根字級（html）：桌機 19→20px（視寬度），手機依檔位 clamp(20px~26px)
       - 內文/標籤：≥16–18px（依字級檔位調整）
       - 控制元件字級：標準 18px；大字約 22px；特大約 24px（避免 iOS 聚焦放大）
       - 輸入框高度：標準 52px 起，依檔位漸增；主按鈕同步放大；核取方塊 26→34px（觸控）
    */

    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111111;
      --border:#dfe3ea;

      --accent:#0B57D0;
      --accent-weak:rgba(11,87,208,.12);

      --status-complete:4 120 87;
      --status-partial:180 83 9;
      --status-pending:31 41 55;
      --status-optional:71 85 105;

      --space-xxs:4px;
      --space-xs:8px;
      --space-sm:12px;
      --space-md:16px;
      --space-lg:24px;

      --fs-base:1rem;
      --fs-title:clamp(1.25rem, 1.1rem + .35vw, 1.5rem);
      --fs-ctrl:18px;

      --radius:10px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --ctrl-padding-block:var(--space-xs);
      --ctrl-padding-inline:var(--space-sm);
      --button-padding-inline:var(--space-md);
      --button-small-padding-inline:var(--space-sm);
      --button-padding-block:calc(var(--ctrl-padding-block) - 1px);
      --button-padding-block-sm:calc(var(--ctrl-padding-block) - 3px);
      --h-input:calc(var(--fs-ctrl) + 2 * var(--ctrl-padding-block));
      --h-button:calc(var(--fs-ctrl) + 2 * var(--button-padding-block));
      --h-button-sm:calc(var(--fs-ctrl) + 2 * var(--button-padding-block-sm));
      --checkbox:calc(var(--space-lg) + var(--space-xxs));
      --fab-h:0px;
      --fab-gap:calc(max(20px, env(safe-area-inset-bottom) + 20px));
      --app-top-offset:0px;
      --side-nav-w:280px;
      --sticky-padding-block:var(--space-xs);
      --sticky-padding-inline:clamp(10px, 3.2vw, 18px);
      --wizard-index-size:34px;
      --wizard-index-font:0.95rem;
      --group-header-spacing:var(--space-xs);
      --bottom-bar-min-height:48px;
      --layout-max:1440px;
      --section-col-min:340px;
      --section-col-max:560px;
      --section-col-preferred:50%;
      --grid-col-min-2:220px;
      --grid-col-min-3:180px;
      --checkcol-min:190px;
      --textarea-min:110px;
      --intro-colw:clamp(260px, 28vw, 360px);
    }

    @media (max-width:1279px){
      :root{
        --intro-colw:clamp(220px, 60vw, 300px);
        --checkcol-min:160px;
      }
      html{ font-size:clamp(18px, 4.8vw, 20px); }
      .app-container{ padding-right:0; }
      .app-body-controls{ justify-content:center; }
    
      .row > div{ flex:1 1 100%; min-width:100%; }
    
      .app-sticky{ padding:var(--space-xxs) clamp(8px, 4vw, 16px) var(--space-xs); }
      .app-sticky-inner{ padding:var(--space-xs) var(--space-sm); gap:var(--space-xs); border-radius:14px; }
      .sticky-header-row{ flex-direction:column; align-items:flex-start; }
      .sticky-controls{ width:100%; justify-content:flex-start; }
      .sticky-summary{ flex-direction:column; align-items:flex-start; gap:var(--space-xs); }
      .summary-item{ flex-direction:row; }
      .summary-value{ font-size:1.05rem; }

      .wizard{
        overflow-x:auto;
        gap:var(--space-xs);
        padding-bottom:4px;
        scroll-snap-type:x proximity;
        -webkit-overflow-scrolling:touch;
      }
      .wizard::-webkit-scrollbar{ height:6px; }
      .wizard-step{
        flex:0 0 auto;
        min-width:140px;
        align-items:flex-start;
        scroll-snap-align:center;
      }
      .wizard-step::before{ display:none; }
      .wizard-label{ text-align:left; white-space:normal; font-size:0.92rem; }
      .wizard-index{ width:32px; height:32px; font-size:0.9rem; }
      .wizard-quickjump label{ display:none; }
    
      .cms-level-group{
        grid-template-columns:repeat(auto-fit, minmax(56px, 1fr));
      }
    
      #visitPartnersCard .extra-row{
        flex-direction:column;
        align-items:stretch;
      }
      #visitPartnersCard .extra-row .field-intro{
        flex:1 1 100%;
        max-width:100%;
      }
    
      #basicInfoGroup .case-manager-field,
      #basicInfoGroup .case-name-field,
      #basicInfoGroup .consult-name-field{
        min-width:260px;
      }
    
      #basicInfoGroup .basic-info-row{
        flex-direction:column;
        gap:var(--space-xs);
      }
      #basicInfoGroup .basic-info-field{
        flex:1 1 100%;
        max-width:100% !important;
        min-width:0 !important;
      }
      #basicInfoGroup .case-manager-field,
      #basicInfoGroup .case-name-field,
      #basicInfoGroup .consult-name-field{
        width:100%;
      }
    
      .checkcol{ grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); }
    
      .field-intro{
        flex:1 1 100%;
        max-width:100%;
        width:100%;
      }
      .field-intro-grid{
        grid-template-columns:1fr;
      }
    
      .extras-heading-grid{ grid-template-columns:1fr; }
    
      .side-nav{
        right:max(var(--space-sm), env(safe-area-inset-right) + var(--space-sm));
        bottom:max(var(--space-md), env(safe-area-inset-bottom) + var(--space-md));
        left:auto;
        width:min(92vw, 320px);
        transform:translateX(calc(100% + var(--space-md)));
        opacity:0;
        pointer-events:none;
        transition:transform .3s ease, opacity .3s ease;
      }
      body[data-side-nav-open="1"] .side-nav{
        transform:translateX(0);
        opacity:1;
        pointer-events:auto;
      }
      .side-nav-trigger{
        display:inline-flex;
        margin:var(--space-sm) 0 var(--space-xs);
      }
    
      #wizardPrevBtn{ display:none; }
      #wizardMoreWrapper{
        display:flex;
        justify-content:center;
        width:100%;
      }
      #wizardMoreBtn{
        display:inline-flex;
      }

      .floating-actions{
        left:12px;
        right:12px;
        bottom:var(--fab-gap);
        flex-direction:row;
        justify-content:space-between;
        gap:8px;
      }
      .floating-actions button{
        flex:1;
        min-width:0;
      }
      #validationToast{
        left:12px;
        right:12px;
        width:auto;
        bottom:calc(var(--fab-h, 0px) + var(--space-lg));
      }
    
      body{ margin:var(--space-sm); }
      .row, .autogrid{ gap:var(--space-sm); }
      .datebox input[type="date"]{ font-size:var(--fs-ctrl); }
      .titlebar{ margin-bottom:var(--space-xs); }
      .group, .section-card{ padding:var(--space-xs); }
      #contactVisitGroup .contact-visit-card{ padding:var(--space-xs); gap:var(--space-xxs); }
      #contactVisitGroup .contact-visit-card-body{ gap:var(--space-xs); }
      .preview{ font-size:calc(var(--fs-base) * 0.95); }
    
      .section-card-grid{ grid-template-columns:1fr; }
    
      .span-2,
      .span-3{ grid-column:auto; }
    

      body[data-fontscale="sm"]{ --checkbox:calc(var(--space-lg) + var(--space-xs)); }
    
      select{ min-height:64px; padding-top:14px; padding-bottom:14px; }
    
    }


    /* 根字級：桌機 19→20；手機 clamp(20–26) */
    html { font-size:19px; -webkit-text-size-adjust:100%; scroll-padding-top:calc(var(--app-top-offset) + var(--space-sm)); }
    @media (min-width:1280px){
      html{ font-size:20px; } 
      .app-container{ padding-right:calc(var(--side-nav-w) + 16px); }
      .page{ padding-right:calc(var(--side-nav-w) + clamp(12px, 4vw, 24px)); }
    
      .titlebar{ grid-template-columns:minmax(0, 1fr) auto auto; }
    
      .sticky-header{
        grid-template-columns:minmax(0, 1fr) minmax(280px, 360px);
        align-items:stretch;
      }
      .page-section[data-columns="2"][data-active="1"]{
        display:grid;
        grid-template-columns:repeat(2, minmax(var(--section-col-min), 1fr));
        gap:var(--space-md);
      }
      .page-section[data-columns="2"][data-active="1"] > .group[data-span="full"],
      .page-section[data-columns="2"][data-active="1"] > .section-intro-grid{
        grid-column:1 / -1;
      }
      #basicInfoGroup .basic-info-fields{
        display:grid;
        grid-template-columns:repeat(2, minmax(var(--intro-colw), 1fr));
        column-gap:var(--space-sm);
        row-gap:var(--space-sm);
        justify-content:flex-start;
      }
      #basicInfoGroup .basic-info-row{
        display:contents;
      }
      #basicInfoGroup .basic-info-field{
        width:100%;
        max-width:100%;
      }
      #basicInfoGroup .unit-code-field,
      #basicInfoGroup .case-manager-field,
      #basicInfoGroup .case-name-field,
      #basicInfoGroup .consult-name-field{
        width:100%;
        max-width:100%;
      }
      #basicInfoGroup .cms-level-row{
        grid-column:1 / -1;
      }
    
      #contactVisitGroup .contact-visit-cards{
        grid-template-columns:repeat(3, minmax(220px, 1fr));
      }
    
      #careGoals_block{
        display:grid;
        grid-template-columns:minmax(0, 1fr) clamp(320px, 38%, 420px);
        gap:var(--space-md);
        align-items:flex-start;
      }
      #careGoals_block .section-group[data-group-id="4"]{
        grid-column:2;
        grid-row:1 / span 3;
      }
      #careGoals_block .section-group:not([data-group-id="4"]) {
        grid-column:1;
      }
      #careGoals_block .care-goals-side-inner{
        position:sticky;
        top:calc(var(--app-top-offset) + var(--space-lg));
      }
    
      .plan-workspace{
        flex-direction:row;
        align-items:flex-start;
      }
      .plan-workspace-main{
        flex:1 1 0;
        min-width:0;
      }
      .plan-workspace-side{
        flex:0 0 clamp(320px, 38%, 420px);
        max-width:clamp(320px, 38%, 420px);
        position:sticky;
        top:calc(var(--app-top-offset) + var(--space-lg));
        max-height:calc(100vh - (var(--app-top-offset) + var(--space-lg) + var(--fab-gap) + 48px));
        overflow:auto;
        padding-right:4px;
      }
      .plan-workspace-side::-webkit-scrollbar{ width:8px; }
      .plan-workspace-side::-webkit-scrollbar-thumb{
        background:rgba(148,163,184,.5);
        border-radius:999px;
      }
    
      .plan-summary-totals{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    
      .plan-summary-totals{ grid-template-columns:repeat(3, minmax(0, 1fr)); }
    
      .side-nav-backdrop{ display:none; }
      .side-nav-trigger{ display:none !important; }
      body[data-side-nav-open]{ overflow:auto; }
    
      .side-nav{ width:var(--side-nav-w); }
    
    }

    

    html, body{ background:var(--bg); color:var(--text); }
    body{
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      font-size:var(--fs-base);
      line-height:1.65;
      letter-spacing:.2px;
      margin:clamp(var(--space-xs), 4vw, var(--space-md));
      -webkit-tap-highlight-color:transparent;
      text-rendering:optimizeLegibility;
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0 0 0 0);
      white-space:nowrap;
      border:0;
    }
    body[data-fontscale="sm"]{
      --fs-ctrl:20px;
      --checkbox:calc(var(--space-lg) + var(--space-xxs));
      line-height:1.7;
    }
    body[data-fontscale="xl"]{
      font-size:calc(var(--fs-base) * 1.15);
      --fs-ctrl:24px;
      --ctrl-padding-block:var(--space-sm);
      --ctrl-padding-inline:var(--space-md);
      --button-padding-inline:var(--space-lg);
      --button-small-padding-inline:var(--space-md);
      --checkbox:calc(var(--space-lg) + var(--space-sm));
      line-height:1.78;
    }
    body[data-uimode="comfort"] .group,
    body[data-uimode="comfort"] .section-card{ padding:var(--space-md); }
    body[data-uimode="comfort"] .app-main,
    body[data-uimode="comfort"] .page-section[data-active="1"]{ gap:var(--space-lg); }
    body[data-vertical-density="compact"]{
      line-height:1.55;
    }
    body[data-vertical-density="compact"] .group,
    body[data-vertical-density="compact"] .section-card{ padding:var(--space-xs); }
    body[data-vertical-density="compact"] .app-main,
    body[data-vertical-density="compact"] .page-section[data-active="1"]{ gap:var(--space-sm); }
    .app-container{
      width:100%;
      margin:0 auto;
      padding-top:var(--space-xs);
      padding-top:calc(var(--space-xs) + constant(safe-area-inset-top));
      padding-top:calc(var(--space-xs) + env(safe-area-inset-top));
      padding-bottom:calc(var(--fab-h, 0px) + var(--space-md));
      box-sizing:border-box;
    }
    .page{
      width:min(1360px, 100%);
      margin-inline:auto;
      padding-inline:clamp(12px, 4vw, 24px);
      box-sizing:border-box;
    }
    .app-shell{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:clamp(var(--space-lg), 4vw, calc(var(--space-lg) * 1.5));
    }
    .app-header{
      position:relative;
      z-index:20;
    }
    .app-body{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      position:relative;
    }
    .app-body-controls{
      display:flex;
      justify-content:flex-end;
      padding-inline:clamp(12px, 4vw, 24px);
    }
    .app-main{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
      padding-inline:clamp(12px, 4vw, 24px);
      box-sizing:border-box;
    }
    
    

    /* 卡片 */
    .group,
    .section-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--space-sm);
      box-shadow:var(--shadow);
      width:100%;
      box-sizing:border-box;
    }
    .group.card-main,
    .group.card-lg{
      display:block;
    }
    .group-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--group-header-spacing);
      margin-bottom:var(--space-xs);
      flex-wrap:wrap;
    }
    .group-header > .titlebar{
      flex:1 1 auto;
      margin:0;
    }
    .group[data-collapsed="1"] .group-header{ margin-bottom:0; }
    .group-content{ display:block; }
    .group[data-collapsed="1"] .group-content{ display:none; }
    .group-collapse{
      border:none;
      background:rgba(11,87,208,.08);
      color:var(--accent);
      font-weight:600;
      font-size:0.9rem;
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:background .2s ease, color .2s ease;
    }
    .group-collapse:hover,
    .group-collapse:focus-visible{
      background:rgba(11,87,208,.16);
      outline:none;
    }
    .group-collapse-icon{ display:inline-block; transition:transform .2s ease; }
    .group[data-collapsed="1"] .group-collapse-icon{ transform:rotate(-90deg); }
    body[data-uimode="review"] .group{ border-radius:8px; }
    /* 交錯輕底以分區（依 page-section 容器交錯） */
    .page-section[data-active="1"] > .group:nth-of-type(odd){ background:rgb(11 87 208 / 0.04); }

    /* 標題列與標題字（以 H 系列為主） */
    .titlebar{
      display:grid;
      grid-template-columns:minmax(0, 1fr) auto;
      align-items:center;
      gap:var(--space-xs);
      row-gap:var(--space-xxs);
      margin:0 0 var(--space-xs);
    }
    
    .titlebar--mt-xxs{ margin-top:var(--space-xxs); }
    .titlebar--mt-xs{ margin-top:var(--space-xs); }
    .titlebar--mt-sm{ margin-top:var(--space-sm); }
    .titlebar--mt-md{ margin-top:var(--space-md); }

    /* ===== Headings System (H1–H6) ===== */
    .h1{
      display:block;
      font-weight:800;
      color:rgb(17 17 17 / 0.95);
      font-size:clamp(26px, 2.5vw, 34px);
      margin-top:calc(var(--space-lg) + var(--space-md));
      margin-bottom:var(--space-lg);
      padding-bottom:6px;
      border-bottom:2px solid var(--accent);
    }
    .h2{
      display:block;
      font-weight:800;
      color:rgb(17 17 17 / 0.9);
      font-size:clamp(21px, 2.2vw, 28px);
      margin-top:calc(var(--space-lg) + var(--space-xs));
      margin-bottom:var(--space-md);
      padding-left:14px;
      border-left:5px solid var(--accent);
      border-bottom:none !important;
      letter-spacing:.01em;
    }
    .h3{
      display:block;
      font-weight:600;
      color:rgb(17 17 17 / 0.85);
      font-size:clamp(19px, 1.75vw, 23px);
      margin-top:var(--space-lg);
      margin-bottom:var(--space-sm);
      padding-bottom:6px;
      border-bottom:1px solid rgb(17 17 17 / 0.12);
      letter-spacing:.005em;
    }
    .h4{
      display:block;
      font-weight:500;
      color:rgb(17 17 17 / 0.75);
      font-size:16px;
      margin-top:var(--space-md);
      margin-bottom:var(--space-xs);
      padding:var(--space-xxs) var(--space-xs);
      background:#F9FAFB;
      border-radius:8px;
    }
    /* 段落（H5對應） */
    .paragraph{ font-size:16px; font-weight:400; color:#111827; line-height:1.5; }
    .h5{ font-size:16px; font-weight:400; color:#111827; line-height:1.5; }

    .heading-tier{ display:block; font-weight:700; }
    .h2.heading-tier,
    .h3.heading-tier,
    .h4.heading-tier,
    .h5.heading-tier{ border-left:none; border-bottom:none; padding-left:0; background:none; }
    .heading-tier--primary{
      color:rgb(17 17 17 / 0.9);
      font-size:clamp(22px, 1.9vw, 28px);
      margin-top:calc(var(--space-lg) + var(--space-xs));
      margin-bottom:var(--space-md);
      padding-bottom:6px;
      border-bottom:1px solid var(--border);
    }
    .heading-tier--section{
      color:rgb(17 17 17 / 0.85);
      font-size:clamp(19px, 1.6vw, 23px);
      margin-top:var(--space-lg);
      margin-bottom:var(--space-sm);
      border-left:4px solid var(--accent);
      padding-left:12px;
      border-radius:4px;
    }
    .heading-tier--subsection{
      color:rgb(17 17 17 / 0.7);
      font-size:18px;
      margin-top:var(--space-md);
      margin-bottom:var(--space-xs);
    }
    /* 佈局：桌機固定兩欄、行動單欄（避免三欄造成橫向拉長） */
    [data-section],
    .page-section,
    .group{
      scroll-margin-top:var(--app-top-offset);
    }
    .row{ display:flex; gap:var(--space-sm); flex-wrap:wrap; align-items:flex-start; margin-bottom:var(--space-xs); }
    .row > div{ flex:1 1 min(100%, 360px); min-width:min(100%, 240px); max-width:720px; }
    .row > [data-field-size="short"],
    .section-group-body > [data-field-size="short"]{
      flex:1 1 calc(33.333% - var(--space-sm));
      min-width:180px;
    }
    .row > [data-field-size="medium"],
    .section-group-body > [data-field-size="medium"]{
      flex:1 1 calc(50% - var(--space-sm));
      min-width:260px;
    }
    .row > [data-field-size="long"],
    .section-group-body > [data-field-size="long"]{
      flex:1 1 100%;
      min-width:100%;
    }
    

    /* 標籤與 Placeholder（加大字、提升對比） */
    label{ display:block; font-size:calc(var(--fs-ctrl) - 2px); margin-bottom:var(--space-xxs); color:rgb(17 17 17 / 0.75); }
    :where(input,select,textarea)::placeholder{ color:rgb(17 17 17 / 0.55); opacity:1; font-size:calc(var(--fs-ctrl) - 2px); }
    :where(input,select,textarea,button,.datebox){ scroll-margin-top:calc(var(--app-top-offset) + var(--space-md)); }

    /* 表單元件：20px 字級，56px 高度（iOS 聚焦不縮放） */
    input[type="text"], input[type="number"], input[type="tel"], input[type="email"],
    input[type="search"], input[type="date"], input[type="time"],
    select, textarea{
      width:100%; box-sizing:border-box;
      min-height:var(--h-input);
      padding:var(--ctrl-padding-block) var(--ctrl-padding-inline);
      font-size:var(--fs-ctrl);
      line-height:1.45;
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
      appearance:none;
    }
    textarea{ min-height:var(--textarea-min); height:auto; resize:vertical; }

    /* Focus 樣式：清楚但不刺眼 */
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-weak);
    }

    /* 禁用狀態：底色與字色明顯區隔 */
    input:disabled, select:disabled, textarea:disabled{
      background:#f3f5f7; color:#777; border-color:#e1e5ea;
    }

    /* 日期顯示盒（更清楚） */
    .datebox{
      display:block;
      width:100%;
    }
    .datebox input[type="date"]{
      width:100%;
      min-width:0;
      padding-right:var(--ctrl-padding-inline);
    }

    /* 按鈕與操作面積（以 padding 控制高度） */
    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:var(--space-xs); }
    button{
      min-height:var(--h-button);
      padding:var(--button-padding-block) var(--button-padding-inline);
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff; color:#111; font-weight:700; cursor:pointer;
      line-height:1.1; touch-action:manipulation; font-size:var(--fs-ctrl);
    }
    button:hover{ background:#f7f7f7; }
    button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    button.button-add,
    button[data-variant="add"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
      box-shadow:none;
    }
    button.button-add:hover,
    button[data-variant="add"]:hover{
      background:#0a4dc2;
      border-color:#0a4dc2;
    }
    button.small{
      min-height:max(var(--h-button-sm), 44px);
      min-width:56px;
      padding:calc(var(--button-padding-block-sm) + 2px) var(--button-small-padding-inline);
      font-size:var(--fs-ctrl);
    }
    /* 可選：若於按鈕加入 data-ic="plus"/"minus"，會自動加上 + / - 圖示 */
    button[data-ic="plus"]::before{ content:"+"; margin-right:.25em; font-weight:900; }
    button[data-ic="minus"]::before{ content:"–"; margin-right:.25em; font-weight:900; }

    .app-sticky{
      position:sticky;
      top:0;
      z-index:1000;
      padding:var(--sticky-padding-block) var(--sticky-padding-inline);
      margin-bottom:var(--space-md);
    }
    .app-sticky-inner{
      width:min(1360px, 100%);
      margin:0 auto;
      background:rgba(255,255,255,.94);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:var(--space-xs) var(--space-sm);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      backdrop-filter:saturate(180%) blur(6px);
      -webkit-backdrop-filter:saturate(180%) blur(6px);
    }
    .sticky-header{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .sticky-header-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-sm);
    }
    .sticky-controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      gap:var(--space-sm);
    }
    .wizard-quickjump{
      display:flex;
      align-items:center;
      gap:var(--space-xxs);
    }
    .wizard-quickjump label{
      font-weight:600;
      color:rgb(17 17 17 / 0.75);
      font-size:0.95rem;
    }
    .sticky-summary{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:var(--space-sm);
    }
    .summary-item{
      display:flex;
      align-items:center;
      gap:var(--space-xxs);
      min-width:0;
    }
    .summary-item.summary-progress{ flex-wrap:wrap; }
    .summary-label{ font-size:0.85rem; color:#475569; font-weight:600; }
    .summary-value{ font-size:1.05rem; font-weight:700; color:rgb(17 17 17 / 0.9); word-break:break-word; }
    .summary-progress-bar{ position:relative; height:10px; border-radius:999px; background:#e2e8f0; overflow:hidden; min-width:120px; }
    .summary-progress-fill{ position:absolute; inset:0; width:0%; border-radius:999px; background:var(--accent); transition:width .3s ease; }
    .summary-progress-text,
    .summary-remaining-text{ font-weight:600; color:#475569; font-size:0.95rem; }
    .font-scale-control{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow:none;
    }
    .font-scale-control button{
      min-width:38px;
      min-height:calc(var(--h-button-sm) - 2px);
      padding:var(--button-padding-block-sm) 12px;
      border:none;
      border-radius:999px;
      background:transparent;
      font-weight:600;
      font-size:0.95rem;
      color:var(--accent);
      cursor:pointer;
      transition:background .2s ease, color .2s ease;
    }
    .font-scale-control button[data-active="1"]{
      background:var(--accent);
      color:#fff;
    }
    .font-scale-control button:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .wizard-quickjump label{
      font-size:0.85rem;
      font-weight:600;
      color:#475569;
    }
    .wizard-quickjump select{
      min-height:var(--h-button-sm);
      padding:var(--button-padding-block-sm) var(--button-small-padding-inline);
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:rgb(17 17 17 / 0.75);
      font-size:var(--fs-ctrl);
    }
    .wizard-quickjump select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-weak);
    }
    
    .page-tabs{ display:flex; flex-wrap:wrap; gap:var(--space-xs); margin:0; }
    .page-tabs button{
      min-height:var(--h-button-sm);
      padding:var(--button-padding-block-sm) var(--button-small-padding-inline);
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:rgb(17 17 17 / 0.75);
      font-weight:600;
      cursor:pointer;
      transition:background .15s ease, color .15s ease, border-color .15s ease;
    }
    .page-tabs button.active{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .wizard{
      position:relative;
      display:flex;
      justify-content:flex-start;
      align-items:center;
      gap:var(--space-sm);
      flex-wrap:wrap;
    }
    .wizard-step{
      position:relative;
      flex:1 1 160px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:var(--space-xxs);
      border:none;
      background:none;
      cursor:pointer;
      color:rgb(17 17 17 / 0.75);
      font-weight:600;
      padding:var(--space-xxs) var(--space-xs);
      border-radius:12px;
      transition:background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    .wizard-step[data-locked="1"]{
      opacity:.55;
      cursor:not-allowed;
    }
    .wizard-step[data-locked="1"]:hover{
      background:none;
      color:rgb(17 17 17 / 0.75);
    }
    .wizard-step::before{
      content:'';
      position:absolute;
      top:calc(var(--wizard-index-size) / 2);
      left:-50%;
      width:100%;
      height:4px;
      background:#dbe5ff;
      z-index:-1;
      transform:translateY(-50%);
    }
    .wizard-step:first-child::before{ display:none; }
    .wizard-step[data-status="done"]::before,
    .wizard-step[data-status="active"]::before{
      background:var(--accent);
    }
    .wizard-step:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:4px;
    }
    .wizard-index{
      width:var(--wizard-index-size);
      height:var(--wizard-index-size);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#e2e8f0;
      color:#1f2937;
      font-weight:800;
      font-size:var(--wizard-index-font);
      transition:background .2s ease, color .2s ease, transform .2s ease;
    }
    .wizard-label{
      font-size:0.9rem;
      text-align:center;
      line-height:1.4;
    }
    .wizard-step:hover{
      background:rgba(11,87,208,.06);
      color:var(--accent);
    }
    .wizard-step[data-status="active"] .wizard-index,
    .wizard-step[data-status="done"] .wizard-index{
      background:var(--accent);
      color:#fff;
    }
    .wizard-step[data-status="active"]{
      background:rgba(11,87,208,.12);
      box-shadow:0 0 0 1px rgba(11,87,208,.18);
    }
    .wizard-step[data-status="active"] .wizard-index{
      transform:scale(1.05);
    }
    .wizard-step[data-status="active"] .wizard-label{ color:var(--accent); }
    .wizard-step[data-status="done"] .wizard-label{ color:rgb(var(--status-complete) / 1); }
    
    .page-section{
      display:none;
      width:100%;
      container-type:inline-size;
      container-name:page-section;
    }
    .page-section[data-columns="1"]{
      --section-col-min:100%;
      --section-col-max:100%;
      --section-col-preferred:100%;
    }
    .page-section[data-active="1"]{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-md);
      align-items:stretch;
      justify-content:flex-start;
      margin-bottom:var(--space-lg);
    }
    .page-section[data-columns="1"][data-active="1"]{
      flex-direction:column;
    }
    .page-section[data-active="1"] > .group{
      flex:1 1 clamp(var(--section-col-min), var(--section-col-preferred), var(--section-col-max));
      min-width:min(100%, var(--section-col-min));
    }
    .page-section[data-active="1"] > .group[data-span="full"]{
      flex:1 1 100%;
      min-width:100%;
    }

    @container page-section (min-width:900px) and (max-width:1200px){
      .page-section[data-columns="2"][data-active="1"]{
        display:grid;
        grid-template-columns:minmax(var(--section-col-min), .4fr) minmax(var(--section-col-min), .6fr);
        align-items:start;
        gap:var(--space-md);
      }
      .page-section[data-columns="2"][data-active="1"] > .group{
        min-width:0;
        width:100%;
      }
      .page-section[data-columns="2"][data-active="1"] > .group[data-span="full"],
      .page-section[data-columns="2"][data-active="1"] > .section-intro-grid{
        grid-column:1 / -1;
      }
    }

    .summary-title{ font-weight:700; color:rgb(17 17 17 / 0.9); margin-bottom:8px; }
    .summary-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .summary-table-wrapper{
      overflow:auto;
      max-height:clamp(280px, 48vh, 520px);
    }
    .summary-table{ width:100%; border-collapse:collapse; min-width:600px; }
    .summary-table th, .summary-table td{
      border:1px solid var(--border);
      padding:var(--space-xs) var(--space-sm);
      text-align:left;
      vertical-align:top;
    }
    .summary-table th{ background:#eef2ff; color:#1f2937; font-weight:700; }
    .summary-table thead{ position:sticky; top:0; z-index:1; }
    .summary-table thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#eef2ff;
      box-shadow:0 2px 0 rgba(148,163,184,.18);
    }

    .cms-level-group{
      display:grid;
      gap:var(--space-xs);
      grid-template-columns:repeat(auto-fit, minmax(64px, 1fr));
      align-items:stretch;
    }
    
    .cms-level-group button{
      min-width:0;
      min-height:48px;
      padding:0 12px;
      border-radius:999px;
      font-size:var(--fs-ctrl);
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cms-level-group button[data-active="1"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }

    #basicInfoGroup .basic-info-fields{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
    }
    #basicInfoGroup .basic-info-row{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-sm);
      align-items:flex-start;
    }
    #basicInfoGroup .basic-info-field{
      display:flex;
      flex-direction:column;
      gap:var(--space-xxs);
      min-width:0;
    }
    #basicInfoGroup .basic-info-field label{ margin-bottom:0; }
    #basicInfoGroup .unit-code-field{
      /* 與其他欄位一致寬度 */
      flex:0 0 var(--intro-colw);
      max-width:var(--intro-colw);
    }
    #basicInfoGroup .unit-code-field select{
      width:100%;
      min-width:0;
    }
    #basicInfoGroup .case-manager-field{
      flex:0 0 var(--intro-colw);
      max-width:var(--intro-colw);
      min-width:0;
      overflow:hidden;
    }
    #basicInfoGroup .case-name-field,
    #basicInfoGroup .consult-name-field{
      flex:0 0 var(--intro-colw);
      max-width:var(--intro-colw);
      min-width:0;
    }
    #basicInfoGroup .case-manager-field input,
    #basicInfoGroup .case-manager-field select,
    #basicInfoGroup .case-name-field input,
    #basicInfoGroup .consult-name-field select{
      width:100%;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    #basicInfoGroup .cms-level-row{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
      margin-top:var(--space-xxs);
    }
    #contactVisitGroup .contact-visit-cards{
      display:grid;
      gap:var(--space-sm);
    }
    
    #contactVisitGroup .contact-visit-card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:var(--space-sm);
      background:#fff;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
    }
    #contactVisitGroup .contact-visit-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-xs);
    }
    #contactVisitGroup .contact-visit-card-body{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
    }
    #contactVisitGroup .contact-visit-card .datebox{
      width:100%;
      max-width:100%;
    }
    #contactVisitGroup .contact-visit-card .inline-checkbox{
      margin:0;
    }
    #contactVisitGroup .plan-card-case-overview,
    #contactVisitGroup .plan-card-care-goals,
    #contactVisitGroup .plan-card-mismatch{
      grid-column:1 / -1;
    }
    #visitPartnersCard{
      position:relative;
    }
    #visitPartnersCard .extra-row{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-sm);
      align-items:flex-start;
      margin-top:var(--space-xs);
    }
    #visitPartnersCard .extra-row .field-intro{
      flex:0 0 var(--intro-colw);
      max-width:var(--intro-colw);
    }
    
    #visitPartnersCard .extra-row-actions{
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    #visitPartnersCard .extra-remove{
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
      line-height:1;
      cursor:pointer;
      color:#4b5563;
      transition:background .15s ease, border-color .15s ease, color .15s ease;
    }
    #visitPartnersCard .extra-remove:hover,
    #visitPartnersCard .extra-remove:focus{
      background:rgba(11,87,208,.12);
      border-color:var(--accent);
      color:var(--accent);
      outline:none;
    }
    #visitPartnersCard .extra-remove span{ pointer-events:none; }
    #extras_conflict{
      position:absolute;
      top:var(--space-sm);
      right:var(--space-sm);
      max-width:calc(100% - 2 * var(--space-sm));
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #facc15;
      background:#fef9c3;
      color:#854d0e;
      font-size:0.9rem;
      line-height:1.5;
      box-shadow:0 4px 12px rgba(250,204,21,.18);
      display:none;
      z-index:2;
    }
    #extras_conflict[data-show="1"]{ display:block; }
    #visitPartnersCard[data-conflict="1"]{
      background:linear-gradient(0deg, rgba(254,249,195,.55), rgba(254,249,195,.55)), var(--card);
      border-color:#facc15;
    }
    #basicInfoGroup input[type="text"],
    #basicInfoGroup input[type="search"],
    #basicInfoGroup select{
      min-height:52px;
      font-size:var(--fs-ctrl);
    }
    #basicInfoGroup input[type="search"],
    #basicInfoGroup select{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #basicInfoGroup input[type="search"]::-webkit-search-cancel-button{
      cursor:pointer;
    }
    
    

    .location-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:12px 0 8px;
      gap:var(--space-sm);
      flex-wrap:wrap;
    }
    .location-toolbar .location-current{ font-weight:600; color:rgb(17 17 17 / 0.75); }
    .location-toolbar .location-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .location-switch button[data-active="1"],
    .location-actions button[data-active="1"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }

    .section-controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
    }
    .section-controls button{
      min-height:var(--h-button-sm);
      padding:var(--button-padding-block-sm) var(--button-small-padding-inline);
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:rgb(17 17 17 / 0.75);
      font-weight:600;
      font-size:calc(var(--fs-ctrl) - 2px);
      cursor:pointer;
      transition:background .15s ease, color .15s ease, border-color .15s ease;
    }
    .section-controls button.active{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .section-controls button.section-toggle-all{
      background:#f7f9fc;
    }
    .section-advanced-count{
      margin-left:auto;
      font-size:0.85rem;
      color:#475569;
      font-weight:600;
    }
    .section-advanced-count[data-hidden="1"]{ display:none; }
    [data-section][data-show-advanced="0"] .section-advanced-count{
      color:#b45309;
    }

    .section-progress{
      margin:12px 0;
    }
    .section-progress-text{
      font-weight:600;
      color:rgb(17 17 17 / 0.75);
      margin-bottom:6px;
    }
    .section-progress-bar{
      position:relative;
      width:100%;
      height:8px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .section-progress-bar-fill{
      position:absolute;
      inset:0;
      width:0%;
      background:var(--accent);
      transition:width .2s ease;
    }

    .section-group{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      margin-bottom:10px;
      background:#fff;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
    }
    .section-group[data-level="advanced"]{
      background:#f8fafc;
    }
    .section-group-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .section-group-toggle{
      background:none;
      border:none;
      padding:0;
      font-size:1.05rem;
      font-weight:700;
      color:var(--accent);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      flex:1 1 auto;
      justify-content:flex-start;
    }
    .section-group-toggle::before{
      content:'▾';
      font-size:.9rem;
      color:var(--accent);
      transition:transform .2s ease;
    }
    .section-group[data-collapsed="1"] .section-group-toggle::before{
      transform:rotate(-90deg);
    }
    .section-group[data-level="advanced"] .section-group-toggle,
    .section-group[data-level="advanced"] .section-group-toggle::before{
      color:#0b1d4d;
    }
    .section-group-progress{ display:none !important; }
    .section-group-body{
      margin-top:var(--space-xs);
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
    }
    .section-group[data-collapsed="1"] .section-group-body{
      display:none;
    }
    .section-group-empty{
      display:none;
      font-size:.95rem;
      color:#6b7280;
      padding:var(--space-xs) var(--space-sm);
      border-radius:8px;
      background:#f3f4f6;
    }
    .section-group[data-empty="1"] .section-group-empty{
      display:block;
    }

    [data-section]{
      position:relative;
      display:block;
    }
    [data-section][data-hide-filled="1"] [data-field-container][data-filled="1"]{
      display:none !important;
    }
    [data-section][data-show-advanced="0"] .section-group[data-level="advanced"],
    [data-section][data-show-advanced="0"] [data-field-container][data-level="advanced"]{
      display:none !important;
    }


    /* 黏底主要動作列（避開 iOS 底部工具列） */
    .group:last-of-type .btnbar{
      position:sticky; bottom:max(18px, env(safe-area-inset-bottom));
      padding:var(--space-sm);
      background:rgba(255,255,255,.92);
      border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    }

    /* 勾選清單（點擊面積提升） */
    fieldset.checkcol{ border:0; margin:0; padding:0; min-inline-size:0; }
    .checkcol{ display:grid; gap:var(--space-xs); grid-template-columns:repeat(auto-fit, minmax(var(--checkcol-min), 1fr)); }
    
    .checkcol label{
      display:flex; align-items:center; gap:var(--space-xs); padding:var(--space-xs) var(--space-sm);
      border:1px solid var(--border); border-radius:12px; background:#fff; color:#222; font-size:var(--fs-base);
      margin:0; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .checkcol label::before{ content:''; display:none; }
    .inline-checkbox{
      display:inline-flex; align-items:center; gap:var(--space-xxs); font-size:calc(var(--fs-ctrl) - 2px); color:rgb(17 17 17 / 0.75); flex-wrap:wrap;
    }
    .inline-checkbox input[type="checkbox"]{ width:calc(var(--checkbox) - 4px); height:calc(var(--checkbox) - 4px); }
    .checkcol input[type=checkbox]{ width:var(--checkbox); height:var(--checkbox); }
    .checkcol label[data-auto="1"]{
      border-color:rgba(11,87,208,.4);
      background:rgba(11,87,208,.08);
    }

    /* 需要固定欄寬的首欄位（關係/姓名等） */
    .field-intro{
      flex:0 0 var(--intro-colw);
      max-width:var(--intro-colw);
      min-width:0;
      width:var(--intro-colw);
    }
    .field-intro-grid{
      grid-template-columns:minmax(var(--intro-colw), var(--intro-colw)) minmax(var(--intro-colw), var(--intro-colw)) minmax(0, 1fr);
    }
    .field-intro select,
    .field-intro input[type="text"],
    .field-intro input[type="tel"],
    .field-intro input[type="number"],
    .field-intro input[type="email"]{
      width:100%;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    

    .checkcol label[data-auto="1"]::after{
      content:'（系統預選）';
      margin-left:8px;
      color:var(--accent);
      font-size:.9rem;
      font-weight:600;
    }
    .checkcol label[data-checked="1"],
    .check-item[data-checked="1"]{
      border-color:var(--accent);
      background:rgba(11,87,208,.12);
      box-shadow:0 0 0 1.5px rgba(11,87,208,.25);
    }
    .checkcol label[data-checked="1"]::before,
    .check-item[data-checked="1"]::before{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      content:'✓';
      font-size:.75rem;
      font-weight:700;
      color:#fff;
      background:var(--accent);
      border-radius:50%;
      width:1.25em;
      height:1.25em;
    }
     /* 觸控設備放大到 32px */
    body[data-vertical-density="compact"] .checkcol{ gap:var(--space-xs); }
    body[data-vertical-density="compact"] .checkcol label{ padding:var(--space-xs) var(--space-sm); }

    .checkcol-wrapper{ display:flex; flex-direction:column; gap:var(--space-xs); }
    .checkcol-wrapper > .checkcol{ width:100%; }
    .checkcol-wrapper[data-has-selection="1"] > .checkcol{ border-color:transparent; }

    .virtual-checklist{ position:relative; border:1px solid var(--border); border-radius:var(--radius); background:#fff; }
    .virtual-checklist-viewport{ position:relative; max-height:320px; overflow-y:auto; }
    .virtual-checklist-visible{ position:absolute; top:0; left:0; right:0; display:flex; flex-direction:column; }
    .virtual-checklist-spacer{ height:0; width:1px; }
    .virtual-checklist-item{ display:flex; align-items:center; gap:var(--space-xs); padding:var(--space-xs) var(--space-sm); border-bottom:1px solid rgba(15,23,42,.08); background:#fff; }
    .virtual-checklist-item:last-child{ border-bottom:none; }
    .virtual-checklist-item input[type="checkbox"]{ width:var(--checkbox); height:var(--checkbox); }
    .virtual-checklist-print{ display:none; margin-top:var(--space-xs); font-size:0.9rem; line-height:1.45; color:#0f172a; }
    .virtual-checklist-print ol{ margin:var(--space-xxs) 0 0 1.25em; padding-left:1.25em; }
    .virtual-checklist-print li{ margin-bottom:4px; }

    #careGoals_block{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
    }
    #careGoals_block .section-group{
      margin:0;
    }
    #careGoals_block .section-group-body{
      gap:var(--space-xs);
    }
    #careGoals_block .care-goal-block{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
    }
    #careGoals_block .care-goal-heading{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:var(--space-xs);
      margin-bottom:var(--space-xs);
    }
    #careGoals_block .care-goals-side-inner{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    #problemCount{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 12px;
      border-radius:999px;
      background:rgba(11,87,208,.12);
      color:#0b1d4d;
      font-size:0.9rem;
      font-weight:700;
      min-width:0;
    }
    .section-selection-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 12px;
      border-radius:999px;
      background:rgba(11,87,208,.12);
      color:#0b1d4d;
      font-size:0.9rem;
      font-weight:600;
      min-width:0;
      justify-self:end;
    }
    .section-selection-badge[data-hidden="1"]{ display:none; }
    

    .lesion-mode{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .lesion-mode button.small{ min-width:112px; }
    .lesion-mode button[data-active="1"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .lesion-size-grid{ display:flex; gap:var(--space-sm); flex-wrap:wrap; }
    .lesion-size-field{ flex:1 1 140px; position:relative; }
    .lesion-size-field input{ padding-right:42px; }
    .lesion-size-field .unit{ position:absolute; right:14px; top:50%; transform:translateY(-50%); color:rgb(17 17 17 / 0.75); font-weight:600; pointer-events:none; }
    .lesion-area{ margin-top:var(--space-xs); font-weight:600; color:rgb(17 17 17 / 0.75); }
    .action-list{ display:flex; flex-direction:column; gap:var(--space-sm); }
    .action-item{ border:1px dashed var(--border); border-radius:var(--radius); padding:var(--space-sm); background:#fff; display:flex; flex-direction:column; gap:var(--space-xs); }
    .action-item-fields{ display:flex; flex-direction:column; gap:var(--space-xs); }
    .action-item textarea{ resize:vertical; min-height:96px; }
    .action-item select{ font-size:var(--fs-ctrl); }
    .action-item-controls{ display:flex; justify-content:flex-end; }
    .mismatch-diff{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0; }
    .mismatch-diff .badge{ background:var(--accent-weak); color:var(--accent); }
    [data-field-container="1"]{
      display:flex;
      flex-direction:column;
      gap:var(--space-xxs);
      position:relative;
    }
    [data-field-container="1"] > label{
      margin-bottom:0;
    }
    .field-error{
      color:#b3261e;
      font-size:0.9rem;
      margin-top:0;
      align-self:flex-end;
      text-align:right;
      display:none;
      line-height:1.4;
    }
    .field-error[data-show="1"]{ display:block; }

    

    .plan-editor{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
      margin-top:var(--space-sm);
    }
    .plan-workspace{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
      width:100%;
    }
    .plan-workspace-main,
    .plan-workspace-side{
      display:flex;
      flex-direction:column;
      gap:var(--space-md);
    }
    .plan-workspace-main > .group,
    .plan-workspace-side > .group{
      margin:0;
    }
    
    .plan-category{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .extras-heading-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:var(--space-sm);
      margin-bottom:var(--space-xs);
      align-items:end;
    }
    
    .plan-category-heading{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-sm);
    }
    .plan-category-heading .h3{
      font-weight:700;
      color:var(--accent);
      margin:0;
    }
    .plan-category-body{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .plan-category-meta{
      border-style:dashed;
      background:rgb(11 87 208 / 0.05);
    }
    .plan-empty-hint{
      font-size:0.95rem;
      color:rgb(17 17 17 / 0.75);
      padding:var(--space-sm);
      border:1px dashed var(--border);
      border-radius:var(--radius);
      background:#f8fafc;
    }
    .plan-entry{
      border:1px dashed var(--border);
      border-radius:var(--radius);
      padding:var(--space-sm);
      background:rgb(11 87 208 / 0.05);
    }
    .plan-entry + .plan-entry{ margin-top:var(--space-sm); }
    .plan-entry-header{
      font-weight:700;
      margin-bottom:var(--space-xs);
    }
    .plan-entry-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
      gap:var(--space-sm);
      align-items:start;
    }
    .plan-entry-grid textarea,
    .plan-entry-grid .full{ grid-column:1/-1; }
    .plan-hint{
      font-size:0.9rem;
      color:rgb(17 17 17 / 0.75);
      opacity:0.85;
      margin-top:var(--space-xs);
    }
    .plan-field.auto-summary .auto-summary-box{
      padding:12px 16px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#f0f4ff;
      color:#0b1d4d;
      font-weight:600;
      line-height:1.6;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .plan-field.auto-summary .auto-summary-box.empty{
      color:#4b5563;
      font-weight:500;
      background:#f8fafc;
      border-style:dashed;
    }
    .selfpay-field .selfpay-hint{
      margin-top:var(--space-xs);
      font-size:0.95rem;
      color:#475569;
      display:none;
    }
    .selfpay-field .selfpay-hint[data-show="1"]{ display:block; }
    .plan-qty-toolbar{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
      margin-top:var(--space-xs);
    }
    .plan-qty-hint{
      font-weight:600;
      color:rgb(17 17 17 / 0.75);
      font-size:0.95rem;
      margin-right:4px;
    }
    button.tiny{
      min-height:calc(var(--h-button-sm) + 4px);
      padding:var(--button-padding-block-sm) 12px;
      font-size:17px;
      border-radius:10px;
    }
    .plan-qty-toolbar button[data-variant="ghost"]{
      background:#f7f9fc;
      border-color:var(--border);
      color:#3f3f46;
    }
    .plan-qty-toolbar button[data-variant="ghost"]:hover{
      background:#edf1ff;
    }
    .plan-summary-totals{
      display:grid;
      grid-template-columns:repeat(1, minmax(0, 1fr));
      gap:var(--space-sm);
      margin-bottom:12px;
    }
    .plan-summary-controls{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-xs);
      margin-bottom:var(--space-sm);
      align-items:center;
    }
    .plan-summary-controls .inline-checkbox{
      margin:0;
    }
    .plan-summary-controls .hint{
      margin:0;
    }
    
    
    .plan-summary-total-card{
      min-width:0;
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 16px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .plan-summary-total-label{
      font-size:0.95rem;
      color:#475569;
      margin-bottom:var(--space-xs);
      font-weight:600;
    }
    .plan-summary-total-value{
      font-size:1.35rem;
      font-weight:800;
      color:#0b1d4d;
    }
    .plan-summary-total-value.negative{
      color:#b3261e;
    }
    .summary-total-selfpay{
      margin-top:var(--space-sm);
      padding-top:var(--space-xs);
      border-top:1px solid var(--border);
      text-align:right;
      font-weight:700;
      font-size:1rem;
      color:#0b1d4d;
    }
    .plan-summary-totals-hint{
      font-size:0.95rem;
      color:#b3261e;
      margin-bottom:var(--space-sm);
      display:none;
    }
    .plan-summary-totals-hint[data-show="1"]{
      display:block;
    }
    .plan-guideline{
      margin-bottom:var(--space-md);
      padding:var(--space-sm) var(--space-md);
      border-radius:12px;
      border:1px solid var(--border);
      background:#f7f9fc;
      color:#475569;
      font-size:0.95rem;
      line-height:1.6;
    }
    .plan-guideline p{ margin:0 0 var(--space-xs); }
    .plan-guideline p:last-child{ margin-bottom:0; }
    .plan-meta-grid{
      display:grid;
      gap:var(--space-sm);
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    }
    .plan-meta-grid > div{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .plan-meta-grid textarea{ min-height:96px; }
    .plan-preview{
      width:100%;
      min-height:220px;
      padding:16px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#f7f9fc;
      font-size:.95rem;
      line-height:1.6;
      box-sizing:border-box;
      white-space:pre-wrap;
    }

    .auto-hint{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .auto-hint button.small{
      height:auto;
      padding:6px 12px;
      font-size:.95rem;
    }

    /* Home care 卡式清單（維持放大字與輸入） */
    .home-care-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:var(--space-sm); }
    .home-care-item{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      padding:16px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadow);
      cursor:pointer;
      transition:border-color .18s ease, box-shadow .18s ease, transform .18s ease;
      outline:none;
    }
    .home-care-item::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:16px;
      border:2px solid transparent;
      pointer-events:none;
      transition:border-color .18s ease;
    }
    .home-care-item:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 18px rgba(15,23,42,.12);
    }
    .home-care-item:focus-visible::after{
      border-color:var(--accent);
    }
    .home-care-item[data-selected="1"]{
      border-color:rgba(11,87,208,.45);
      box-shadow:0 10px 22px rgba(15,23,42,.14);
    }
    .home-care-item[data-selected="1"]::after{
      border-color:rgba(11,87,208,.45);
    }
    .home-care-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-sm);
    }
    .home-care-title{
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
      min-width:0;
    }
    .home-care-code{
      font-weight:800;
      color:#0b1d4d;
      font-size:1.05rem;
      letter-spacing:.5px;
    }
    .home-care-name{
      color:#111;
      font-weight:600;
      font-size:0.98rem;
      line-height:1.4;
    }
    .home-care-status{
      font-size:0.9rem;
      font-weight:600;
      color:#475569;
    }
    .home-care-extra{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transition:max-height .2s ease, opacity .2s ease;
    }
    .home-care-item[data-selected="1"] .home-care-extra{
      max-height:140px;
      opacity:1;
    }
    .home-care-qty-wrap{
      display:flex;
      align-items:center;
      gap:var(--space-xs);
    }
    .home-care-qty-label{
      font-weight:600;
      color:#1f2937;
      white-space:nowrap;
    }
    .home-care-qty{
      width:120px;
      min-height:var(--h-input);
      padding:var(--ctrl-padding-block) var(--space-sm);
      font-size:var(--fs-ctrl);
      border:1px solid var(--border);
      border-radius:10px;
      box-sizing:border-box;
    }
    .home-care-item[data-has-qty="1"] .home-care-main{
      align-items:flex-start;
    }

    /* 預覽框：顏色加深以凸顯區塊 */
    .preview{
      padding:var(--space-sm) var(--space-md);
      background:#eef4ff;
      border:1px solid #cdd9ff; border-radius:12px;
      white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:#0f172a; max-height:55vh; overflow:auto; font-size:calc(var(--fs-base) * 0.95);
    }
    #goalPreview.goal-preview-empty{ color:#6b7280; }
    .preview-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .preview-card-container{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      margin-top:var(--space-xs);
    }
    .preview-card-container[data-empty="1"]{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:16px;
      background:#f8fafc;
    }
    .preview-empty{ color:#6b7280; font-size:.95rem; }
    .preview-card{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:var(--space-sm) var(--space-md);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
    }
    .preview-card[data-changed="1"]{
      border-color:#f97316;
      box-shadow:0 0 0 1px rgba(249,115,22,.2), var(--shadow);
    }
    .preview-card[data-empty="1"] .preview-card-body{ color:#6b7280; }
    .preview-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-sm);
    }
    .preview-card-title{
      font-weight:700;
      color:var(--accent);
      font-size:1.05rem;
    }
    .preview-card-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .preview-card-body{
      line-height:1.7;
      color:#111827;
      font-size:1rem;
    }
    .preview-card-body .diff-add{
      background:rgba(34,197,94,.18);
      border-radius:4px;
      padding:0 2px;
    }
    .preview-card-body .diff-del{
      text-decoration:line-through;
      color:#b91c1c;
      background:rgba(239,68,68,.12);
      border-radius:4px;
      padding:0 2px;
    }
    .preview-card-body .diff-empty{
      color:#6b7280;
    }
    .preview-card-previous{
      margin-top:var(--space-xs);
      padding:var(--space-xs) var(--space-sm);
      border-radius:10px;
      background:#f8fafc;
      color:#4b5563;
      font-size:.95rem;
    }
    .preview-card-previous strong{ color:#1f2937; }
    .preview-toggle.active{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .rule-invalid{
      border-color:#f97316 !important;
      box-shadow:0 0 0 2px rgba(249,115,22,.18) !important;
    }

    /* 提示／狀態色與區隔線 */
    .hint{ font-size:.95rem; color:#4b5563; }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(11,87,208,.08);
      color:var(--accent);
      font-weight:600;
      min-height:38px;
    }
    .danger{ color:#b00020; }
    .error-messages{ 
      display:none;
      margin:10px 0;
      padding:12px 14px;
      border:1px solid #fca5a5;
      border-radius:var(--radius);
      background:#fef2f2;
      color:#b91c1c;
      font-size:.95rem;
    }
    .error-messages ul{ margin:0; padding-left:20px; }
    .error-messages li{ margin-bottom:4px; }
    .error-summary{
      display:none;
      margin:var(--space-xs) 0;
      padding:12px 14px;
      border-radius:var(--radius);
      border:1px solid #fbbf24;
      background:#fef3c7;
      color:#92400e;
      font-size:.95rem;
      line-height:1.5;
    }
    .error-summary a{ color:inherit; text-decoration:underline; }
    .error-summary a:hover{ text-decoration:none; }
    .error-summary ul{ margin:0; padding-left:20px; }
    #section1_block[data-hide-filled="1"] #section1_error_summary[data-show="1"]{ display:block; }
    #section1_block #section1_error_summary[data-show="0"]{ display:none; }
    .side-nav{
      position:fixed;
      right:max(var(--space-md), env(safe-area-inset-right) + var(--space-md));
      top:calc(var(--app-top-offset) + var(--space-md));
      width:var(--side-nav-w);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:var(--space-sm);
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
      z-index:38;
      color:rgb(17 17 17 / 0.9);
      max-height:calc(100vh - var(--app-top-offset) - 2 * var(--space-md));
      overflow:auto;
      overscroll-behavior:contain;
    }
    .side-nav[data-empty="1"]{ display:none; }
    .side-nav-title{ font-weight:700; color:rgb(17 17 17 / 0.9); font-size:1rem; }
    .side-nav-list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:var(--space-xs); }
    .side-nav-item{
      display:flex;
      align-items:center;
      gap:var(--space-xs);
      padding:var(--space-xs) var(--space-sm);
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      transition:background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .side-nav-item[data-level="3"]{ padding-left:calc(var(--space-sm) + 12px); }
    .side-nav-item[data-level="4"]{ padding-left:calc(var(--space-sm) + 20px); }
    .side-nav-item[data-level="5"]{ padding-left:calc(var(--space-sm) + 28px); }
    .side-nav-item[data-level="6"]{ padding-left:calc(var(--space-sm) + 36px); }
    .side-nav-item:focus-within{ box-shadow:0 0 0 2px var(--accent-weak); }
    .side-nav-link{
      flex:1;
      min-width:0;
      text-align:left;
      background:none;
      border:none;
      padding:0;
      color:rgb(17 17 17 / 0.65);
      font-size:0.95rem;
      cursor:pointer;
      transition:color .2s ease;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .side-nav-link:hover,
    .side-nav-link:focus{ color:var(--accent); outline:none; }
    .side-nav-count{
      margin-left:auto;
      font-size:0.85rem;
      font-weight:600;
      color:rgb(17 17 17 / 0.75);
      font-variant-numeric:tabular-nums;
      text-align:right;
    }
    .side-nav-item[data-status="complete"]{
      background:rgb(var(--status-complete) / 0.14);
      border-color:rgb(var(--status-complete) / 0.45);
    }
    .side-nav-item[data-status="complete"] .side-nav-link,
    .side-nav-item[data-status="complete"] .side-nav-count{ color:rgb(var(--status-complete) / 1); }
    .side-nav-item[data-status="partial"]{
      background:rgb(var(--status-partial) / 0.18);
      border-color:rgb(var(--status-partial) / 0.45);
    }
    .side-nav-item[data-status="partial"] .side-nav-link,
    .side-nav-item[data-status="partial"] .side-nav-count{ color:rgb(var(--status-partial) / 1); }
    .side-nav-item[data-status="pending"]{
      background:rgb(var(--status-pending) / 0.18);
      border-color:rgb(var(--status-pending) / 0.45);
    }
    .side-nav-item[data-status="pending"] .side-nav-link,
    .side-nav-item[data-status="pending"] .side-nav-count{ color:rgb(var(--status-pending) / 1); }
    .side-nav-item[data-status="optional"]{
      background:rgb(var(--status-optional) / 0.12);
      border-color:rgb(var(--status-optional) / 0.35);
    }
    .side-nav-item[data-status="optional"] .side-nav-link,
    .side-nav-item[data-status="optional"] .side-nav-count{ color:rgb(var(--status-optional) / 1); }
    body[data-side-nav-open="1"]{ overflow:hidden; }
    .side-nav-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      backdrop-filter:blur(2px);
      -webkit-backdrop-filter:blur(2px);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
      z-index:37;
    }
    body[data-side-nav-open="1"] .side-nav-backdrop{
      opacity:1;
      pointer-events:auto;
    }
    .side-nav-trigger{
      display:none;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 16px;
      border:none;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(15,23,42,.18);
      transition:background .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    .side-nav-trigger:hover,
    .side-nav-trigger:focus-visible{
      background:#0a4cbb;
      outline:none;
      box-shadow:0 10px 24px rgba(15,23,42,.22);
    }
    .side-nav-trigger:focus-visible{ outline:2px solid rgba(255,255,255,.75); outline-offset:2px; }
    .side-nav-trigger.is-active{ background:#0a4cbb; }
    .side-nav-trigger[disabled]{ background:#c7d2fe; color:#334155; cursor:not-allowed; box-shadow:none; }
    .side-nav-trigger[disabled]:hover,
    .side-nav-trigger[disabled]:focus-visible{
      background:#c7d2fe;
      box-shadow:none;
    }
    .side-nav-trigger-icon{
      position:relative;
      width:20px;
      height:2px;
      background:currentColor;
      border-radius:999px;
    }
    .side-nav-trigger-icon::before,
    .side-nav-trigger-icon::after{
      content:"";
      position:absolute;
      left:0;
      width:20px;
      height:2px;
      background:currentColor;
      border-radius:999px;
      transition:transform .2s ease, top .2s ease, background .2s ease;
    }
    .side-nav-trigger-icon::before{ top:-6px; }
    .side-nav-trigger-icon::after{ top:6px; }
    .side-nav-trigger.is-active .side-nav-trigger-icon{ background:transparent; }
    .side-nav-trigger.is-active .side-nav-trigger-icon::before{ top:0; transform:rotate(45deg); }
    .side-nav-trigger.is-active .side-nav-trigger-icon::after{ top:0; transform:rotate(-45deg); }
    
    
    
    .floating-actions{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      min-height:var(--bottom-bar-min-height);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      gap:var(--space-xxs);
      padding:var(--space-xs) var(--space-md);
      padding-left:max(var(--space-md), calc(env(safe-area-inset-left) + var(--space-md)));
      padding-right:max(var(--space-md), calc(env(safe-area-inset-right) + var(--space-md)));
      padding-bottom:max(var(--space-xs), calc(env(safe-area-inset-bottom) + var(--space-xs)));
      background:rgba(255,255,255,.95);
      border-top:1px solid rgba(148,163,184,.35);
      box-shadow:0 -6px 18px rgba(15,23,42,.08);
      backdrop-filter:saturate(160%) blur(12px);
      -webkit-backdrop-filter:saturate(160%) blur(12px);
      z-index:80;
    }
    .floating-actions button{
      min-width:128px;
      box-shadow:none;
    }
    .floating-actions button[data-variant="ghost"]{
      background:rgba(248,250,252,.9);
    }
    #wizardMoreWrapper{
      position:relative;
      display:none;
    }
    #wizardMoreBtn{
      display:none;
      min-width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      padding:0;
      font-size:1.5rem;
      line-height:1;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:background .15s ease, border-color .15s ease, color .15s ease;
    }
    #wizardMoreBtn:hover{
      background:#eef2ff;
    }
    .floating-more-menu{
      position:absolute;
      bottom:calc(100% + 6px);
      right:0;
      min-width:180px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      box-shadow:0 16px 32px rgba(15,23,42,.16);
      padding:var(--space-xs);
      display:none;
      flex-direction:column;
      gap:var(--space-xs);
      z-index:90;
    }
    .floating-more-menu[data-open="1"]{ display:flex; }
    .floating-more-menu button{ min-width:0; width:100%; }
    
    #wizardSaveBtn{ order:1; }
    #wizardMoreWrapper{ order:2; }
    #wizardNextBtn{ order:3; }
    #wizardPrevBtn{ order:4; }
    #errorSummary{
      display:none;
      margin-top:var(--space-sm);
      padding:16px;
      border:1px solid #fca5a5;
      border-radius:var(--radius);
      background:#fff5f5;
      color:#b3261e;
      font-size:.95rem;
    }
    #errorSummary[data-show="1"]{ display:block; }
    #errorSummary .error-panel-title{
      font-weight:700;
      margin-bottom:var(--space-xs);
    }
    #errorSummary .error-panel-section{
      padding-top:var(--space-sm);
      margin-top:var(--space-sm);
      border-top:1px solid rgba(185,38,38,.2);
    }
    #errorSummary .error-panel-section:first-of-type{
      border-top:none;
      padding-top:0;
      margin-top:0;
    }
    #errorSummary .error-panel-section-title{
      font-weight:700;
      font-size:1rem;
      margin-bottom:var(--space-xs);
    }
    #errorSummary ul{ margin:0; padding-left:20px; }
    #errorSummary li{ margin-bottom:var(--space-xs); }
    #errorSummary a{
      color:#b3261e;
      text-decoration:underline;
      cursor:pointer;
      font-weight:600;
    }
    #validationToast{
      position:fixed;
      right:24px;
      bottom:calc(var(--fab-h, 0px) + var(--space-lg));
      max-width:360px;
      width:calc(100% - 48px);
      background:#111827;
      color:#fff;
      padding:16px;
      border-radius:16px;
      box-shadow:0 18px 40px rgba(15,23,42,.25);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      opacity:0;
      transform:translateY(12px);
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      z-index:999;
      box-sizing:border-box;
    }
    #validationToast[data-show="1"]{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    #validationToast .toast-title{
      font-weight:700;
      font-size:1rem;
    }
    #validationToast .toast-message{
      font-size:.95rem;
      line-height:1.5;
    }
    #validationToast .toast-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    #validationToast button.small{
      min-height:var(--h-button-sm);
    }
    #validationToast[data-type="warn"]{
      background:#854d0e;
      color:#fff7ed;
    }
    #validationToast[data-type="warn"] button.primary{
      background:#fff7ed;
      color:#854d0e;
      border-color:#fff7ed;
    }
    #headingSpecToast{
      position:fixed;
      right:24px;
      bottom:calc(var(--fab-h, 0px) + var(--space-lg) + 96px);
      max-width:320px;
      width:calc(100% - 48px);
      background:#1f2937;
      color:#f8fafc;
      padding:14px;
      border-radius:14px;
      box-shadow:0 12px 28px rgba(15,23,42,.2);
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
      opacity:0;
      transform:translateY(12px);
      pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;
      z-index:998;
      box-sizing:border-box;
    }
    #headingSpecToast[data-show="1"]{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    #headingSpecToast .toast-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    #headingSpecToast button.small{ min-height:var(--h-button-sm); }
    
    .input-invalid{
      border-color:#d92d20 !important;
      box-shadow:0 0 0 2px rgba(217,45,32,.2) !important;
    }
    .input-complete{
      border-color:rgb(var(--status-complete) / 0.45) !important;
      box-shadow:0 0 0 2px rgb(var(--status-complete) / 0.25) !important;
    }
    .basic-info-field[data-state="complete"] label{
      color:rgb(var(--status-complete) / 1);
    }
    .basic-info-field[data-state="invalid"] label{
      color:rgb(17 17 17 / 0.75);
    }
    .basic-info-status{
      font-size:0.82rem;
      font-weight:600;
      min-height:1.25em;
      display:flex;
      align-items:center;
      gap:4px;
      color:#475569;
    }
    .basic-info-status::before{ content:''; font-weight:700; }
    .basic-info-status[data-state="invalid"]{ color:#b91c1c; }
    .basic-info-status[data-state="invalid"]::before{ content:'!'; }
    .basic-info-status[data-state="complete"]{ color:rgb(var(--status-complete) / 1); }
    .basic-info-status[data-state="complete"]::before{ content:'✓'; }
    .cms-level-row #cmsLevelGroup{
      transition:box-shadow .2s ease;
    }
    .cms-level-row[data-status="invalid"] #cmsLevelGroup{
      box-shadow:0 0 0 2px rgba(217,45,32,.2);
      border-radius:16px;
    }
    .cms-level-row[data-status="complete"] #cmsLevelGroup{
      box-shadow:0 0 0 2px rgb(var(--status-complete) / 0.25);
      border-radius:16px;
    }
    .cms-level-row[data-status="complete"] > .h3{ color:rgb(var(--status-complete) / 1); }
    .cms-level-row[data-status="invalid"] > .h3{ color:rgb(17 17 17 / 0.75); }
    .group[data-plan-locked="1"] .group-header{ opacity:.85; }
    .group[data-plan-locked="1"] .group-collapse{
      cursor:not-allowed;
      background:rgba(148,163,184,.16);
      color:#64748b;
      border-color:rgba(148,163,184,.4);
    }
    .group[data-plan-locked="1"] .group-collapse:hover,
    .group[data-plan-locked="1"] .group-collapse:focus-visible{
      background:rgba(148,163,184,.16);
      color:#64748b;
    }
    .group-collapse.is-locked .group-collapse-icon{ opacity:.6; }
    .checkcol.input-invalid{
      border:1px solid #fca5a5;
      border-radius:var(--radius);
      padding:12px 14px;
      background:#fef2f2;
    }
    .hr{ border-top:1px dashed #d8dce3; margin:14px 0; }

    /* Placeholder 選項（select 的置放字） */
    .placeholder-option{ color:#555; font-size:var(--fs-ctrl); }

    /* Tooltip：於元素加 data-tooltip="說明..." 即會顯示 */
    [data-tooltip]{ position:relative; }
    [data-tooltip]:hover::after{
      content:attr(data-tooltip);
      position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 8px);
      white-space:normal; width:max-content; max-width:260px;
      padding:8px 10px; background:#111; color:#fff; border-radius:8px; font-size:.9rem; line-height:1.4;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    [data-tooltip]:hover::before{
      content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 4px);
      border:6px solid transparent; border-top-color:#111;
    }

    /* 行動端微調 */
    
    /* === Section card 通用網格與工具類 === */
    .section-card-grid{
      display:grid;
      gap:var(--space-sm);
      grid-template-columns:repeat(auto-fit, minmax(280px, min(50%, 1fr)));
      align-items:start;
    }
    
    .section-card{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      break-inside:avoid;
      -webkit-column-break-inside:avoid;
      page-break-inside:avoid;
    }
    .section-card > .titlebar{
      display:flex;
      align-items:center;
      gap:var(--space-xs);
      flex-wrap:wrap;
    }
    .section-card > .titlebar > .h3,
    .section-card > .titlebar > .h4{
      flex:1 1 auto;
    }
    .autogrid{
      display:grid;
      gap:var(--autogrid-gap, var(--space-sm));
      grid-template-columns:repeat(auto-fit, minmax(var(--col-min, 280px), 1fr));
      align-items:start;
    }
    .autogrid--tight{ --autogrid-gap:var(--space-xs); --col-min:240px; }
    .autogrid--wide{ --autogrid-gap:var(--space-md); --col-min:320px; }
    .span-2{ grid-column:span 2; }
    .span-3{ grid-column:span 3; }
    
    .autogrid .field{
      display:grid;
      gap:8px;
      grid-template-columns:1fr;
    }
    .autogrid .field > label{ color:#374151; }
    @container (min-width:440px){
      .autogrid .field{
        grid-template-columns:160px 1fr;
        align-items:center;
      }
      .autogrid .field > label{ justify-self:end; }
    }
    .checkgrid{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      align-items:start;
    }
    .checkgrid .check-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--border, #e5e7eb);
      border-radius:10px;
      background:#fff;
    }

    /* 停用舊的 intro grid 三欄比例，保持區塊本體高度 */
    .section-intro-grid{ width:100%; }
    .page-section[data-active="1"] > .section-intro-grid{
      width:100%;
    }

    
</style>
</head>



<body data-fontscale="sm" data-side-nav-open="0">

  <div class="app-container" id="appContainer">
    <div class="app-shell">
      <header class="app-header">
        <div class="app-sticky" id="appSticky" data-expanded="0">
          <div class="app-sticky-inner">
            <div class="sticky-header">
              <div class="sticky-header-row">
                <div class="wizard" id="wizardSteps" aria-label="填寫進度">
                  <button type="button" class="wizard-step" data-step="1" data-page="basic" data-anchor="#basicInfoGroup">
                    <span class="wizard-index">1</span>
                    <span class="wizard-label">基本資訊</span>
                  </button>
                  <button type="button" class="wizard-step" data-step="2" data-page="goals" data-anchor="#contactVisitGroup">
                    <span class="wizard-index">2</span>
                    <span class="wizard-label">計畫目標</span>
                  </button>
                  <button type="button" class="wizard-step" data-step="3" data-page="execution" data-anchor="#planExecutionCard">
                    <span class="wizard-index">3</span>
                    <span class="wizard-label">計畫執行規劃</span>
                  </button>
                  <button type="button" class="wizard-step" data-step="4" data-page="notes" data-anchor="#planOtherGroup">
                    <span class="wizard-index">4</span>
                    <span class="wizard-label">其他備註</span>
                  </button>
                </div>
                <div class="sticky-controls" id="pageToolbar">
                  <div class="font-scale-control" id="fontScaleControl" role="group" aria-label="字級設定">
                    <button type="button" data-scale="sm" title="標準字級（20px）">A</button>
                    <button type="button" data-scale="xl" title="大字（約 24px）">A+</button>
                  </div>
                  <div class="wizard-quickjump" id="wizardQuickJump">
                    <label for="wizardJumpSelect">快速前往</label>
                    <select id="wizardJumpSelect" aria-label="快速跳轉階段">
                      <option value="">選擇階段</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="sticky-summary" id="stickySummary" aria-live="polite">
                <div class="summary-item">
                  <span class="summary-label">個案</span>
                  <span class="summary-value" id="summaryCaseName">—</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">CMS 等級</span>
                  <span class="summary-value" id="summaryCmsLevel">—</span>
                </div>
                <div class="summary-item summary-progress">
                  <span class="summary-label">完成度</span>
                  <div class="summary-progress-bar" role="presentation">
                    <div class="summary-progress-fill" id="summaryProgressFill"></div>
                  </div>
                  <span class="summary-progress-text" id="summaryProgressText">—</span>
                  <span class="summary-remaining-text" id="summaryRemainingText">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <div class="app-body">
        <div class="app-body-controls">
          <button type="button" class="side-nav-trigger" id="sideNavToggleButton" aria-controls="sideNav" aria-expanded="false">
            <span class="side-nav-trigger-icon" aria-hidden="true"></span>
            <span>群組導覽</span>
          </button>
        </div>
        <div class="side-nav-backdrop" id="sideNavBackdrop" role="presentation" aria-hidden="true"></div>
        <nav class="side-nav" id="sideNav" aria-label="群組導覽" data-empty="1" tabindex="-1">
          <div class="side-nav-title">群組導覽</div>
          <ul class="side-nav-list" id="sideNavList"></ul>
        </nav>
        <main class="app-main" id="appMain">
          <div class="page-section" data-page="basic" data-active="1" data-columns="1">
    <div class="group" id="basicInfoGroup">
      <div class="group-header">
        <div class="titlebar">
          <span class="h1">基本資訊</span>
        </div>
      </div>
      <div class="group-content">
        <div class="section-card-grid">
          <section class="section-card" id="basicInfoSection">
            <div class="titlebar">
              <span class="h2">基本資訊</span>
            </div>
            <div class="basic-info-fields">
              <div class="basic-info-row" data-row="1">
                <div class="basic-info-field unit-code-field field-intro" data-field-size="short">
                  <label class="h3" for="unitCode">單位代碼</label>
                  <select id="unitCode" onchange="loadManagers(); loadConsultants();">
                    <option>FNA1</option><option>FNA2</option><option>FNA3</option>
                  </select>
                </div>
                <div class="basic-info-field case-manager-field field-intro" data-field-size="medium" data-basic-required="1">
                  <label class="h3" for="caseManagerName">個案管理師</label>
                  <select id="caseManagerName">
                    <option value="" class="placeholder-option" disabled selected>請選擇</option>
                  </select>
                  <div class="basic-info-status" id="caseManagerStatus" role="status" aria-live="polite"></div>
                </div>
              </div>
              <div class="basic-info-row" data-row="2">
                <div class="basic-info-field case-name-field field-intro" data-field-size="medium" data-basic-required="1">
                  <label class="h3" for="caseName">個案姓名</label>
                  <input id="caseName" type="text" placeholder="請輸入">
                  <div class="basic-info-status" id="caseNameStatus" role="status" aria-live="polite"></div>
                </div>
                <div class="basic-info-field consult-name-field field-intro" data-field-size="medium" data-basic-required="1">
                  <label class="h3" for="consultName">照專姓名</label>
                  <select id="consultName">
                    <option value="" class="placeholder-option" disabled selected>請選擇</option>
                  </select>
                  <div class="basic-info-status" id="consultStatus" role="status" aria-live="polite"></div>
                </div>
              </div>
              <div class="cms-level-row" data-row="3" data-basic-required="1">
                <label class="h3" for="cmsLevelValue">CMS 等級</label>
                <div id="cmsLevelGroup" class="cms-level-group">
                  <button type="button" data-level="2">2</button>
                  <button type="button" data-level="3">3</button>
                  <button type="button" data-level="4">4</button>
                  <button type="button" data-level="5">5</button>
                  <button type="button" data-level="6">6</button>
                  <button type="button" data-level="7">7</button>
                  <button type="button" data-level="8">8</button>
                </div>
                <div class="hint cms-level-hint">選擇 CMS 等級後會同步填入隱藏欄位。</div>
                <div class="basic-info-status" id="cmsLevelStatus" role="status" aria-live="polite"></div>
                <input type="hidden" id="cmsLevelValue" value="">
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <div class="page-section" data-page="goals" data-active="0" data-columns="2">
    <div class="group card-main" id="contactVisitGroup" data-collapsed="0" data-plan-locked="0">
      <div class="group-header">
        <div class="titlebar">
          <span class="h1">計畫目標</span>
        </div>
      </div>
      <div class="group-content">
        <div class="section-card-grid">
            <section class="section-card contact-visit-card" data-card="call">
              <div class="titlebar contact-visit-card-header">
                <span class="h2">一、電聯日期</span>
              </div>
              <div class="contact-visit-card-body">
                <label class="h3" for="callDate">電聯日期</label>
                <div id="callDateControls" class="datebox">
                  <input id="callDate" type="date">
                </div>
                <label class="inline-checkbox" style="display:block; margin-top:var(--space-xs);">
                  <input id="isConsultVisit" type="checkbox" onchange="toggleCallDateByConsultVisit()"> 照顧專員約訪
                </label>
                <div id="consultVisitText" class="subtle" style="display:none; margin-top:var(--space-xs);"></div>
              </div>
            </section>

            <section class="section-card contact-visit-card" data-card="visit">
              <div class="titlebar contact-visit-card-header">
                <span class="h2">二、家訪日期</span>
              </div>
              <div class="contact-visit-card-body">
                <label class="h3" for="visitDate">家訪日期</label>
                <div class="datebox">
                  <input id="visitDate" type="date">
                </div>
                <label class="inline-checkbox" style="display:block; margin-top:var(--space-xs);">
                  <input id="isDischarge" type="checkbox" onchange="toggleDischarge()"> 填寫出院日期
                </label>
                <div id="dischargeBox" style="display:none; margin-top:var(--space-xs);">
                  <label class="h3" for="dischargeDate">出院日期</label>
                  <div class="datebox">
                    <input id="dischargeDate" type="date">
                  </div>
                </div>
              </div>
            </section>

            <section class="section-card contact-visit-card" id="visitPartnersCard" data-card="partners">
              <div class="titlebar contact-visit-card-header">
                <span class="h2">三、偕同訪視者</span>
              </div>
              <div class="contact-visit-card-body">
                <div class="row">
                  <div class="field-intro" data-field-size="short">
                    <label class="h3" for="primaryRel">主要照顧者關係</label>
                    <select id="primaryRel" onchange="enforcePrimaryExclusionOnExtras()">
                      <option value="" class="placeholder-option" disabled selected>請選擇</option>
                      <optgroup label="配偶"><option>案妻</option><option>案夫</option></optgroup>
                      <optgroup label="子女"><option>案長子</option><option>案次子</option><option>案長女</option><option>案次女</option></optgroup>
                      <optgroup label="父母"><option>案父</option><option>案母</option></optgroup>
                      <optgroup label="手足"><option>案兄</option><option>案姊</option><option>案弟</option><option>案妹</option></optgroup>
                      <optgroup label="姻親"><option>案媳</option><option>案女婿</option></optgroup>
                      <optgroup label="孫輩"><option>案孫</option><option>案孫女</option></optgroup>
                      <optgroup label="自訂"><option>自訂角色</option></optgroup>
                    </select>
                  </div>
                  <div class="field-intro" data-field-size="medium">
                    <label class="h3" for="primaryName">主要照顧者姓名</label>
                    <input id="primaryName" type="text" placeholder="請輸入">
                  </div>
                  <div class="field-intro" data-field-size="medium">
                    <label class="h3" for="primaryPhone">主要照顧者電話</label>
                    <input id="primaryPhone" type="tel" inputmode="tel" placeholder="例如：0912-345678">
                  </div>
                </div>
                <input type="hidden" id="includePrimary" value="true">
                <div class="titlebar titlebar--mt-xxs">
                  <label class="h3">其他參與者</label>
                  <button type="button" class="small button-add" data-ic="plus" onclick="addExtraRow()">新增參與者</button>
                </div>
                <div id="extrasHeading" class="extras-heading-grid">
                  <h3 id="h3-goals-extra-rel" class="h3" data-anchor="h3-goals-extra-rel">其他參與者關係</h3>
                  <h3 id="h3-goals-extra-name" class="h3" data-anchor="h3-goals-extra-name">其他參與者姓名</h3>
                </div>
                <div id="extras"></div>
                <div id="extras_conflict" role="status" aria-live="polite"></div>
              </div>
            </section>
          </div>
        </div>
      </div>

        <!-- 四、個案概況 -->
        <div class="group plan-card-case-overview" id="caseOverviewGroup" data-span="full" data-collapsed="0">
          <div class="group-header">
            <div class="titlebar">
              <span class="h2 heading-tier heading-tier--primary">四、個案概況</span>
              <span class="hint" style="margin:0;">系統已即時檢查必填欄位，缺漏將以紅框提示。</span>
            </div>
          </div>

          <div class="group-content">
            <div id="section1_block" data-section="s1">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（一）身心概況</label>
              </div>
              <!-- (一) 身心概況：已更新 + 連動 + 自動產文 -->
              <div id="section1_error_summary" class="error-summary" data-group-ignore="1" data-show="0" aria-live="polite"></div>

                <div class="section-card-grid" id="caseProfileBasicGroup">
                  <section class="section-card" id="caseProfileBasicCard">
                    <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="short">
                            <label class="h3" for="s1_age">年齡</label>
                            <input id="s1_age" type="number" min="1" max="120" value="70">
                          </div>
                          <div class="field" data-field-size="short">
                            <label class="h3" for="s1_gender">性別</label>
                            <select id="s1_gender">
                              <option>男</option>
                              <option>女</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="long">
                            <label class="h3">溝通語言／方式</label>
                            <div class="checkcol" id="s1_lang_box"></div>
                            <input id="s1_lang_note" type="text" placeholder="備註（例如：以台語為主）" style="margin-top:var(--space-xs);">
                          </div>
                    </div>
                  </section>
                </div>

                <div class="group" id="caseProfileSensoryGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">感官功能</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileVisionCard">
                        <span class="h5 heading-tier heading-tier--subsection">視力</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_vision">視力程度</label>
                            <select id="s1_vision" onchange="toggleVisionNotes()">
                              <option>視力清晰</option>
                              <option>靠近才能辨識</option>
                              <option>即使配戴眼鏡，仍難以辨識</option>
                              <option>僅能分辨明暗，無法辨識人臉或物體輪廓</option>
                              <option>完全失去視覺功能，無法感知光線</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3">視力補充說明【選填】</label>
                            <div class="checkcol" id="s1_vision_note_box"></div>
                            <input id="s1_vision_other" type="text" placeholder="其他說明" style="display:none; margin-top:var(--space-xs);">
                            <div id="s1_glasses_adherence_wrap" style="display:none; margin-top:var(--space-xs);">
                              <label class="h4" for="s1_glasses_adherence">配戴情形</label>
                              <select id="s1_glasses_adherence">
                                <option value="" class="placeholder-option" disabled selected>配戴情形</option>
                                <option>常態配戴</option>
                                <option>偶爾配戴</option>
                                <option>不配戴</option>
                              </select>
                            </div>
                            <div id="s1_vision_auto_hint" class="hint auto-hint" style="display:none; margin-top:var(--space-xs);">
                              <span>已依視力狀態預選建議補充（標記為「系統預選」）。</span>
                              <button type="button" class="small" onclick="resetVisionSuggestions()">還原為預設</button>
                            </div>
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfileHearingCard">
                        <span class="h5 heading-tier heading-tier--subsection">聽力</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_hearing_level">聽力程度</label>
                            <select id="s1_hearing_level" onchange="renderHearingDetails()">
                              <option>無明顯異常</option>
                              <option>輕度受損</option>
                              <option>中度受損</option>
                              <option>重度受損</option>
                              <option>極重度受損</option>
                              <option>完全失聰</option>
                            </select>
                          </div>
                          <div class="field" id="s1_hearing_detail_wrap" data-field-size="medium" style="display:none;">
                            <label class="h3">聽力補充說明【選填】</label>
                            <div class="checkcol" id="s1_hearing_detail_box"></div>
                            <div id="s1_hearing_device_wrap" style="display:none; margin-top:var(--space-xs);">
                              <label class="h4" for="s1_hearing_device_adherence">助聽／擴音依從性</label>
                              <select id="s1_hearing_device_adherence">
                                <option value="" class="placeholder-option" disabled selected>助聽／擴音依從性</option>
                                <option>持續使用</option>
                                <option>間斷使用</option>
                                <option>不使用</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileOralGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">口腔與吞嚥功能</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileSwallowCard">
                        <span class="h5 heading-tier heading-tier--subsection">吞嚥功能</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_swallow">吞嚥／嗆咳程度</label>
                            <select id="s1_swallow" onchange="toggleSwallow()">
                              <option>無困難</option>
                              <option>輕度</option>
                              <option>明顯困難</option>
                              <option>危險（需專評）</option>
                            </select>
                          </div>
                          <div class="field" id="s1_swallow_sx_wrap" data-field-size="medium" style="display:none;">
                            <label class="h3">吞嚥症狀</label>
                            <div id="s1_swallow_sx_hint" class="hint" style="display:none;">例：嗆咳、殘留、口水外漏等，勾選可快速完成紀錄。</div>
                            <div class="checkcol" id="s1_swallow_sx_box"></div>
                          </div>
                          <div class="field" id="s1_diet_wrap" data-field-size="medium" style="display:none;">
                            <label class="h3">飲食質地</label>
                            <div class="checkcol" id="s1_diet_texture_box"></div>
                            <span class="h4" style="margin-top:var(--space-sm); display:block;">管灌方式</span>
                            <div class="checkcol" id="s1_feeding_tube_box"></div>
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfileOralCard">
                        <span class="h5 heading-tier heading-tier--subsection">口腔與牙齒</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <label class="h3">口腔牙齒／假牙</label>
                            <div class="checkcol" id="s1_oral_box"></div>
                            <input id="s1_oral_note" type="text" placeholder="備註" style="margin-top:var(--space-xs);">
                          </div>
                        </div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileMobilityGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">移動功能</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileMobilityCard">
                        <span class="h5 heading-tier heading-tier--subsection">移動功能</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_transfer">起身／移位能力</label>
                            <select id="s1_transfer" onchange="toggleAdlHow('s1_transfer')">
                              <option selected>獨立</option>
                              <option>需要輕扶</option>
                              <option>中度協助</option>
                              <option>重度協助</option>
                              <option>完全依賴</option>
                            </select>
                            <input id="s1_transfer_how" type="text" placeholder="請說明協助方式" style="display:none; margin-top:var(--space-xs);" data-show-values="中度協助,重度協助">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_walk_indoor">室內行走能力</label>
                            <select id="s1_walk_indoor">
                              <option selected>無輔具緩慢</option>
                              <option>單拐</option>
                              <option>四腳拐</option>
                              <option>助行器</option>
                              <option>輪椅</option>
                              <option>無法</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_walk_outdoor">外出行走能力</label>
                            <select id="s1_walk_outdoor">
                              <option>獨立</option>
                              <option selected>單拐</option>
                              <option>四腳拐</option>
                              <option>助行器</option>
                              <option>輪椅</option>
                              <option>無法</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_stairs">上下樓梯能力</label>
                            <select id="s1_stairs">
                              <option>可獨立</option>
                              <option selected>需扶手</option>
                              <option>需人協助</option>
                              <option>無法</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="short">
                            <label class="h3" for="s1_weak_laterality">偏側無力</label>
                            <select id="s1_weak_laterality">
                              <option>無</option>
                              <option>左側</option>
                              <option>右側</option>
                              <option>雙側</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_fall_history">跌倒史</label>
                            <select id="s1_fall_history" onchange="toggleFallDetail()">
                              <option>無</option>
                              <option>過去1年1次</option>
                              <option>過去1年≧2次</option>
                              <option>不明</option>
                            </select>
                            <input id="s1_fall_times" type="number" min="0" placeholder="次數" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" data-field-size="long">
                            <label class="h3">平衡程度</label>
                            <div class="checkcol" id="s1_balance_box"></div>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_sitting_stability">坐姿穩定性與輪椅安全</label>
                            <select id="s1_sitting_stability" onchange="toggleSittingSupports()">
                              <option value="" class="placeholder-option" disabled selected>請選擇</option>
                              <option>穩定</option>
                              <option>易前傾</option>
                              <option>易滑落</option>
                            </select>
                            <div class="checkcol" id="s1_sitting_support_box" style="display:none; margin-top:var(--space-xs);"></div>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_gait">步態</label>
                            <select id="s1_gait">
                              <option value="" class="placeholder-option" disabled selected>請選擇</option>
                              <option>正常</option>
                              <option>拖步</option>
                              <option>小碎步</option>
                              <option>步寬增大</option>
                              <option>偏斜</option>
                              <option>跨步不穩</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_gait_note" type="text" placeholder="備註" style="margin-top:var(--space-xs);">
                          </div>
                        </div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileAdlGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">ADL（日常生活活動）</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileAdlCard">
                        <span class="h5 heading-tier heading-tier--subsection">ADL 日常生活活動</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_adl_eating">進食</label>
                            <select id="s1_adl_eating" onchange="toggleAdlHow('s1_adl_eating')">
                              <option selected>獨立</option>
                              <option>部分協助</option>
                              <option>完全協助</option>
                            </select>
                            <input id="s1_adl_eating_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_adl_eating" data-required-label="進食的部分協助方式">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_adl_groom">盥洗（刷牙／洗臉）</label>
                            <select id="s1_adl_groom" onchange="toggleAdlHow('s1_adl_groom')">
                              <option selected>獨立</option>
                              <option>部分協助</option>
                              <option>完全協助</option>
                            </select>
                            <input id="s1_adl_groom_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_adl_groom" data-required-label="刷牙/洗臉的部分協助方式">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_adl_bathing">洗澡</label>
                            <select id="s1_adl_bathing" onchange="toggleAdlHow('s1_adl_bathing')">
                              <option selected>獨立</option>
                              <option>部分協助</option>
                              <option>完全協助</option>
                            </select>
                            <input id="s1_adl_bathing_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_adl_bathing" data-required-label="洗澡的部分協助方式">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_adl_dressing">穿脫衣</label>
                            <select id="s1_adl_dressing" onchange="toggleAdlHow('s1_adl_dressing')">
                              <option selected>獨立</option>
                              <option>部分協助</option>
                              <option>完全協助</option>
                            </select>
                            <input id="s1_adl_dressing_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_adl_dressing" data-required-label="穿脫衣的部分協助方式">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_post_toilet">如廁後清潔</label>
                            <select id="s1_post_toilet" onchange="toggleAdlHow('s1_post_toilet')">
                              <option selected>獨立</option>
                              <option>部分協助</option>
                              <option>完全協助</option>
                            </select>
                            <input id="s1_post_toilet_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_post_toilet" data-required-label="如廁後清潔的部分協助方式">
                          </div>
                        </div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileIadlGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">IADL（工具性日常活動）</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileIadlCard">
                        <span class="h5 heading-tier heading-tier--subsection">IADL 工具性日常活動</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_phone">電話使用</label>
                            <select id="s1_phone" onchange="togglePhoneNotes()">
                              <option selected>會撥打與接聽</option>
                              <option>僅能接聽</option>
                              <option>不會使用</option>
                            </select>
                            <div id="s1_phone_note_wrap" style="display:none; margin-top:var(--space-xs);">
                              <div class="checkcol" id="s1_phone_note_box"></div>
                              <input id="s1_phone_note_other" type="text" placeholder="其他說明" style="display:none; margin-top:var(--space-xs);">
                            </div>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_shopping">外出購物</label>
                            <select id="s1_shopping" onchange="toggleShoppingHow()">
                              <option>可獨立</option>
                              <option selected>需陪同</option>
                              <option>不外出</option>
                            </select>
                            <select id="s1_shopping_how" style="display:none; margin-top:var(--space-xs);" onchange="toggleShoppingHow()">
                              <option value="" class="placeholder-option" disabled selected>方式/說明</option>
                              <option>家屬陪同購物</option>
                              <option>由家屬代購</option>
                              <option>使用外送平台</option>
                              <option>居服員陪同／代購</option>
                              <option>外看（看護／志工）代購</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_shopping_how_other" type="text" placeholder="請說明" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_meal_prep">備餐</label>
                            <select id="s1_meal_prep" onchange="toggleAdlHow('s1_meal_prep')">
                              <option>獨立</option>
                              <option selected>部分協助</option>
                              <option>完全由家屬</option>
                            </select>
                            <input id="s1_meal_prep_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_meal_prep" data-required-label="備餐的部分協助方式">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_dishwash">餐具清洗</label>
                            <select id="s1_dishwash" onchange="toggleDishwashHow()">
                              <option>乾淨</option>
                              <option selected>尚可或不一定乾淨</option>
                              <option>無法自行清洗</option>
                            </select>
                            <select id="s1_dishwash_how" style="display:none; margin-top:var(--space-xs);" onchange="toggleDishwashHow()">
                              <option>由他人代辦</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_dishwash_how_other" type="text" placeholder="請說明" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_housework">家務整理</label>
                            <select id="s1_housework" onchange="toggleAdlHow('s1_housework')">
                              <option>獨立</option>
                              <option selected>部分協助</option>
                              <option>完全由家屬</option>
                            </select>
                            <input id="s1_housework_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_housework" data-required-label="家務整理的部分協助方式">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_finance">財務管理</label>
                            <select id="s1_finance" onchange="toggleAdlHow('s1_finance')">
                              <option selected>獨立</option>
                              <option>部分協助</option>
                              <option>他人代辦</option>
                            </select>
                            <input id="s1_finance_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:var(--space-xs);" data-required-when="partial" data-required-source="s1_finance" data-required-label="財務管理的部分協助方式">
                          </div>
                        </div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileExcretionGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">排泄功能</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileExcretionCard">
                        <span class="h5 heading-tier heading-tier--subsection">排泄功能</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <label class="h3">排泄輔具</label>
                            <div class="checkcol" id="s1_excretion_aids_box"></div>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_urine_day">日間排尿情形</label>
                            <select id="s1_urine_day" onchange="toggleUrineOther('day')">
                              <option selected>正常（4–6次）</option>
                              <option>偏少（少於3次）</option>
                              <option>偏多（7–9次）</option>
                              <option>失禁</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_urine_day_other" type="text" placeholder="請說明" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" id="s1_urine_night_wrap" data-field-size="medium">
                            <label class="h3" for="s1_urine_night">夜間排尿情形</label>
                            <select id="s1_urine_night" onchange="toggleUrineOther('night')">
                              <option selected>夜間未起夜</option>
                              <option>夜間起夜1次</option>
                              <option>夜間起夜2–3次</option>
                              <option>夜間起夜≥4次</option>
                              <option>夜間有尿失禁</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_urine_night_other" type="text" placeholder="請說明" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" id="s1_nocturia_wrap" data-field-size="short" style="display:none;">
                            <label class="h3" for="s1_nocturia_count">夜尿次數數值</label>
                            <input id="s1_nocturia_count" type="number" min="0" max="10" placeholder="0-10">
                          </div>
                        </div>
                        <div id="s1_night_catheter_note" class="hint" style="display:none;">夜間以導尿／集尿袋處理，不以起夜次數評估</div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileHealthGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">健康狀況與病史</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileDiseaseCard">
                        <span class="h5 heading-tier heading-tier--subsection">病史與過敏</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <label class="h3">慢性病史</label>
                            <div class="checkcol" id="s1_dhx_box"></div>
                            <input id="s1_dhx_other" type="text" placeholder="其他慢性病" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_surgery">手術史【選填】</label>
                            <input id="s1_surgery" type="text" placeholder="例：10多年前髖關節手術">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_allergy">藥物過敏【選填】</label>
                            <input id="s1_allergy" type="text" placeholder="無則留空">
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfileMedicationCard">
                        <span class="h5 heading-tier heading-tier--subsection">用藥與就醫</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <label class="h3">現用藥物種類</label>
                            <div class="checkcol" id="s1_med_classes_box"></div>
                            <input id="s1_med_classes_other" type="text" placeholder="其他用藥" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_follow_clinic">固定就醫單位【選填】</label>
                            <input id="s1_follow_clinic" type="text" placeholder="例：嘉誠診所">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_rx_type">處方型態【選填】</label>
                            <select id="s1_rx_type">
                              <option>慢性處方箋</option>
                              <option>一般門診</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_med_manage">用藥管理方式</label>
                            <select id="s1_med_manage">
                              <option>可自行規則服藥</option>
                              <option>需提醒</option>
                              <option>他人給藥</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_visit_transport">就醫交通方式【選填】</label>
                            <select id="s1_visit_transport" onchange="toggleTransportOther()">
                              <option>計程車</option>
                              <option>家屬接送</option>
                              <option>交通接送服務</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_visit_transport_other" type="text" placeholder="請填寫其他交通方式" style="display:none; margin-top:var(--space-xs);">
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfileDeviceCard">
                        <span class="h5 heading-tier heading-tier--subsection">管路／裝置</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <label class="h3">管路／裝置</label>
                            <div class="checkcol" id="s1_devices_box"></div>
                            <input id="s1_devices_note" type="text" placeholder="備註" style="margin-top:var(--space-xs);">
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfileDisabilityCard">
                        <span class="h5 heading-tier heading-tier--subsection">身心障礙資訊</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3">身心障礙等級</label>
                            <div id="s1_dis_level_text" class="badge">—</div>
                          </div>
                          <div class="field" id="s1_dis_cat_box" data-field-size="medium" style="display:none;">
                            <label class="h3">身心障礙類別</label>
                            <div id="s1_dis_cat_text" class="badge">—</div>
                          </div>
                        </div>
                        <div class="hint" style="margin-top:var(--space-xs);">身心障礙資訊同步自(二)經濟收入，此處為唯讀顯示。</div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfilePsychGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">心理與行為狀態</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfilePsychBehaviorCard">
                        <span class="h5 heading-tier heading-tier--subsection">心理與行為</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3">情緒狀態</label>
                            <div class="checkcol" id="s1_emotion_box"></div>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3">行為表現</label>
                            <div class="checkcol" id="s1_behavior_box"></div>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_motivation">執行動機與督促需求</label>
                            <select id="s1_motivation">
                              <option value="" class="placeholder-option" disabled selected>請選擇</option>
                              <option>主動配合</option>
                              <option>需提醒／督促</option>
                              <option>拒絕／抗拒</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_cognition">認知功能【選填】</label>
                            <select id="s1_cognition">
                              <option>清楚可應答</option>
                              <option>需重複或放慢</option>
                              <option>健忘／短期記憶不佳</option>
                              <option>表達或理解困難</option>
                              <option>無法溝通</option>
                              <option>無法評估</option>
                            </select>
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_awareness">意識狀態【選填】</label>
                            <select id="s1_awareness">
                              <option>清楚</option>
                              <option>遲鈍</option>
                              <option>混亂</option>
                              <option>模糊</option>
                              <option>嗜睡</option>
                              <option>昏迷</option>
                            </select>
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfilePsychSleepCard">
                        <span class="h5 heading-tier heading-tier--subsection">睡眠與日間活動</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_sleep">睡眠品質</label>
                            <select id="s1_sleep" onchange="toggleSleepReason()">
                              <option>良好</option>
                              <option>尚可</option>
                              <option selected>不佳</option>
                            </select>
                            <select id="s1_sleep_reason" style="display:none; margin-top:var(--space-xs);" onchange="toggleSleepReasonDetail()">
                              <option value="" class="placeholder-option" disabled selected>失眠原因</option>
                              <option>疼痛</option>
                              <option>頻尿</option>
                              <option>慢性疾病</option>
                              <option>焦慮、憂鬱</option>
                              <option>生活壓力</option>
                              <option>環境干擾</option>
                              <option>不良睡眠習慣</option>
                              <option>日夜顛倒</option>
                              <option>藥物影響</option>
                              <option>咖啡因</option>
                              <option>酒精</option>
                              <option>其他</option>
                            </select>
                            <select id="s1_sleep_reason_detail" style="display:none; margin-top:var(--space-xs);"></select>
                            <input id="s1_sleep_reason_other" type="text" placeholder="請說明" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_daytime">白天活動【選填】</label>
                            <input id="s1_daytime" type="text" placeholder="例：坐後門外看電視，累了打盹">
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfilePainSkinCard">
                        <span class="h5 heading-tier heading-tier--subsection">疼痛與皮膚狀態</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_pain">疼痛【選填】</label>
                            <select id="s1_pain" onchange="togglePainCombined()">
                              <option selected>無</option>
                              <option>有</option>
                              <option>未知</option>
                            </select>
                          </div>
                          <div class="field" id="s1_pain_score_wrap" data-field-size="short" style="display:none;">
                            <label class="h3" for="s1_pain_score">疼痛強度（1-10）</label>
                            <input id="s1_pain_score" type="number" min="1" max="10" step="1">
                            <div class="field-error" id="s1_pain_score_error"></div>
                          </div>
                        </div>
                        <div id="s1_location_block" style="display:none;" data-level="advanced">
                          <div class="location-toolbar" id="s1_location_toolbar" style="display:none;">
                            <span class="location-current">目前編輯：<span id="s1_location_active_label">疼痛部位</span></span>
                            <div class="location-switch btnbar">
                              <button type="button" class="small" data-context="pain" onclick="switchLocationContext('pain')">編輯疼痛部位</button>
                              <button type="button" class="small" data-context="lesion" onclick="switchLocationContext('lesion')">編輯病灶部位</button>
                            </div>
                            <div class="location-actions btnbar">
                              <button type="button" class="small" id="location_copy_btn" onclick="copyLocationFromOther()">同疼痛部位</button>
                            </div>
                          </div>
                          <div class="autogrid autogrid--wide">
                            <div class="field" data-field-size="medium">
                              <label class="h3" for="s1_location_region">部位大分類</label>
                              <select id="s1_location_region" onchange="onSharedRegionChange()">
                                <option value="" class="placeholder-option" disabled selected>請選擇</option>
                                <option>頭頸部</option>
                                <option>上肢</option>
                                <option>軀幹</option>
                                <option>下肢</option>
                                <option>全身性</option>
                              </select>
                            </div>
                            <div class="field" data-field-size="medium">
                              <label class="h3" for="s1_location_subregion">細部分位</label>
                              <select id="s1_location_subregion" onchange="onSharedSubregionChange()">
                                <option value="" class="placeholder-option" disabled selected>請選擇</option>
                              </select>
                              <input id="s1_location_subregion_other" type="text" placeholder="請填寫其他部位" style="display:none; margin-top:var(--space-xs);" oninput="onSharedSubregionOtherInput()">
                            </div>
                            <div class="field" data-field-size="short">
                              <label class="h3" for="s1_location_laterality">側別</label>
                              <select id="s1_location_laterality" onchange="onSharedLateralityChange()">
                                <option value="" class="placeholder-option" disabled selected>請選擇</option>
                                <option>左側</option>
                                <option>右側</option>
                                <option>雙側</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="medium">
                            <label class="h3" for="s1_lesion_has">皮膚病灶【選填】</label>
                            <select id="s1_lesion_has" onchange="toggleLesionCombined()">
                              <option selected>無</option>
                              <option>有</option>
                              <option>未知</option>
                            </select>
                          </div>
                          <div class="field" id="s1_lesion_layer_wrap" data-field-size="medium" style="display:none;">
                            <label class="h3" for="s1_lesion_layer">病灶層次</label>
                            <select id="s1_lesion_layer" onchange="toggleLesionLayerOther()">
                              <option>無</option>
                              <option>表皮</option>
                              <option>皮下</option>
                              <option>關節附近</option>
                              <option>其他</option>
                            </select>
                            <input id="s1_lesion_layer_other" type="text" placeholder="請填寫" style="display:none; margin-top:var(--space-xs);">
                          </div>
                          <div class="field" id="s1_lesion_size_wrap" data-field-size="medium" style="display:none;">
                            <label class="h3">病灶大小</label>
                            <div class="lesion-size-grid">
                              <div class="lesion-size-field">
                                <input id="s1_lesion_length" type="number" min="0" step="0.1" placeholder="長" oninput="updateLesionAreaDisplay()">
                                <span class="unit">cm</span>
                              </div>
                              <div class="lesion-size-field">
                                <input id="s1_lesion_width" type="number" min="0" step="0.1" placeholder="寬" oninput="updateLesionAreaDisplay()">
                                <span class="unit">cm</span>
                              </div>
                            </div>
                            <div class="hint" id="s1_lesion_size_hint">請輸入長與寬，系統將即時計算面積。</div>
                            <div class="lesion-area" id="s1_lesion_area_display">面積：— cm²</div>
                            <div class="field-error" id="s1_lesion_size_error"></div>
                          </div>
                        </div>
                        <div id="s1_lesion_more" style="display:none;" data-level="advanced">
                          <div class="autogrid autogrid--wide">
                            <div class="field" data-field-size="medium">
                              <label class="h3">病灶症狀</label>
                              <div class="lesion-mode" id="s1_lesion_mode">
                                <button type="button" class="small" data-mode="none" onclick="setLesionSymptomMode('none')">無不適</button>
                                <button type="button" class="small" data-mode="symptom" onclick="setLesionSymptomMode('symptom')">有症狀</button>
                              </div>
                              <div class="checkcol" id="s1_lesion_sx_box"></div>
                            </div>
                            <div class="field" data-field-size="medium">
                              <label class="h3" for="s1_lesion_eval">醫療評估</label>
                              <select id="s1_lesion_eval" onchange="toggleLesionHospital()">
                                <option>未評估</option>
                                <option>醫師評估無大礙</option>
                                <option>已安排追蹤</option>
                                <option>持續治療中</option>
                              </select>
                              <input id="s1_lesion_hospital" type="text" placeholder="醫療院所名稱" style="display:none; margin-top:var(--space-xs);">
                            </div>
                          </div>
                        </div>
                        <div class="field-error" id="s1_pain_location_error"></div>
                      </section>
                    </div>
                  </div>
                </div>

                <div class="group" id="caseProfileSummaryGroup" data-collapsed="0">
                  <div class="group-header">
                    <span class="h3 heading-tier heading-tier--section">總結建議</span>
                  </div>
                  <div class="group-content">
                    <div class="section-card-grid">
                      <section class="section-card" id="caseProfileActionsCard">
                        <div class="titlebar">
                          <span class="h5 heading-tier heading-tier--subsection">建議措施</span>
                          <button type="button" class="small" onclick="addActionEntry()">＋新增</button>
                        </div>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <div id="s1_actions_list" class="action-list"></div>
                            <div class="hint" id="s1_actions_hint" style="display:none;">尚未新增建議措施。</div>
                            <div class="field-error" id="s1_actions_error"></div>
                          </div>
                        </div>
                      </section>
                      <section class="section-card" id="caseProfileNotesCard">
                        <span class="h5 heading-tier heading-tier--subsection">補充內容</span>
                        <div class="autogrid autogrid--wide">
                          <div class="field" data-field-size="long">
                            <label class="h3" for="s1_notes">補充內容【選填】</label>
                            <textarea id="s1_notes" placeholder="其他未涵蓋重點（限簡要）；將附加於段落末端。"></textarea>
                          </div>
                        </div>
                      </section>
                    </div>
                    <textarea id="section1_out" style="display:none;" data-progress-ignore="1"></textarea>
                    <div id="section1_errors" class="error-messages" data-progress-ignore="1"></div>
                    <div class="preview-toolbar" style="margin-top:var(--space-xs);">
                      <span class="hint">預覽（主題分段）：</span>
                      <button type="button" class="small preview-toggle" id="section1_diff_toggle" data-active="0">只看變更</button>
                    </div>
                    <div id="section1_rule_errors" class="error-messages" data-progress-ignore="1"></div>
                    <div id="section1_preview_cards" class="preview-card-container" data-empty="1">
                      <div class="preview-empty">尚未產生預覽內容。</div>
                    </div>
                  </div>
                </div>
              </div>

        <div id="section2_block" data-section="s2">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（二）經濟收入</label>
              </div>
                <div class="autogrid autogrid--wide">
                  <div>
                    <label class="h4">主要經濟來源</label>
                    <div class="checkcol" id="s2_sources"></div>
                  </div>
                  <div>
                    <div class="autogrid autogrid--wide">
                      <div>
                        <label class="h4">戶籍／福利身分</label>
                        <select id="s2_id">
                          <option>一般戶</option><option>中低收入戶</option><option>低收入戶</option>
                        </select>
                      </div>
                      <div>
                        <label class="h4">身心障礙等級</label>
                        <select id="s2_dis_level" onchange="syncDisab()"><!-- 選擇身心障礙等級 -->
                          <option>無</option><option>輕度</option><option>中度</option><option>重度</option><option>極重度</option>
                        </select>
                      </div>
                    </div>
                    <div id="disCatBox" style="display:none; margin-top:var(--space-xs);"><!-- 類別欄位，預設隱藏 -->
                      <label class="h4">身心障礙類別（等級≠無才需選）</label>
                      <select id="s2_dis_cat" onchange="syncDisab()"><!-- 選擇身心障礙類別 --></select>
                    </div>
                  </div>
                </div>
              <textarea id="section2_out" style="display:none;" data-progress-ignore="1"></textarea>
            </div>
        <div id="section3_block" data-section="s3">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（三）居住環境</label>
              </div>
                <div class="autogrid autogrid--wide">
                  <div>
                    <label class="h4">居住型態</label>
                    <select id="s3_type" onchange="toggleOtherType()">
                      <option>透天</option><option>鐵皮屋</option><option>公寓</option><option>大樓</option><option>套房</option><option>其他</option>
                    </select>
                    <input id="s3_type_other" type="text" placeholder="請輸入其他型態" style="display:none; margin-top:var(--space-xs);">
                  </div>
                  <div>
                    <label class="h4">居住權屬</label>
                    <select id="s3_own" onchange="toggleRentFields()"><option>自有</option><option>租賃</option><option>借住</option></select>
                  </div>
                  <div>
                    <label class="h4">整潔度／異味</label>
                    <select id="s3_clean"><option>非常整潔</option><option>整潔</option><option>尚可</option><option>需改善</option><option>髒亂</option></select>
                  </div>
                </div>
                <div class="autogrid autogrid--wide" style="margin-top:var(--space-xs);">
                  <div id="s3_rent_amount_wrap" style="display:none;">
                    <label class="h5">租金金額（元/月）</label>
                    <input id="s3_rent_amount" type="number" min="0" placeholder="例：12000">
                  </div>
                  <div id="s3_rent_fee_wrap" style="display:none;">
                    <label class="h5">是否含管理費</label>
                    <select id="s3_rent_fee">
                      <option value="" class="placeholder-option" disabled selected>請選擇</option>
                      <option value="含管理費">含管理費</option>
                      <option value="不含管理費">不含管理費</option>
                    </select>
                  </div>
                  <div>
                    <label class="h5">異味</label>
                    <select id="s3_smell"><option>無</option><option>輕微</option><option>明顯</option></select>
                  </div>
                </div>
                <div class="autogrid autogrid--wide" style="margin-top:var(--space-xs);">
                  <div>
                    <label class="h4">無障礙設施</label>
                    <div class="checkcol" id="s3_fac"></div>
                  </div>
                  <div>
                    <label class="h4">輔具</label>
                    <div class="checkcol" id="s3_aids"></div>
                  </div>
                </div>
              <textarea id="section3_out" style="display:none;" data-progress-ignore="1"></textarea>
            </div>
        <div id="section4_block" data-section="s4">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（四）社會支持</label>
              </div>

                <div class="autogrid autogrid--wide">
                  <div>
                    <label class="h4">主照者關係</label>
                    <div id="sp_primaryRel_text" class="badge">—</div>
                  </div>
                  <div>
                    <label class="h4">主照者姓名</label>
                    <div id="sp_primaryName_text" class="badge">—</div>
                  </div>
                  <div>
                    <label class="h4">同住狀態</label>
                    <select id="sp_cohabit"><option value="">—不選—</option><option>同住</option><option>不同住</option></select>
                  </div>
                </div>


                <div class="hr"></div>

                <div class="titlebar titlebar--mt-sm">
                  <label class="h4">主要聯繫人/決策者</label>
                  <button type="button" class="small" onclick="copyFromH1Primary()">設為主照者</button>
                </div>
                <div class="autogrid autogrid--wide">
                  <div class="field-intro">
                    <label class="h4">關係</label>
                    <select id="sp_deciderRel">
                      <option value="">—不選—</option>
                      <optgroup label="配偶"><option>案妻</option><option>案夫</option></optgroup>
                      <optgroup label="子女"><option>案長子</option><option>案次子</option><option>案長女</option><option>案次女</option></optgroup>
                      <optgroup label="父母"><option>案父</option><option>案母</option></optgroup>
                      <optgroup label="手足"><option>案兄</option><option>案姊</option><option>案弟</option><option>案妹</option></optgroup>
                      <optgroup label="姻親"><option>案媳</option><option>案女婿</option></optgroup>
                      <optgroup label="孫輩"><option>案孫</option><option>案孫女</option></optgroup>
                      <optgroup label="自訂"><option>自訂角色</option></optgroup>
                    </select>
                  </div>
                  <div class="field-intro">
                    <label class="h4">姓名</label>
                    <input id="sp_deciderName" type="text" placeholder="請選擇">
                  </div>
                  <div>
                    <label class="h4">聯絡電話</label>
                    <input id="sp_deciderPhone" type="tel" placeholder="例如：0912-345678">
                  </div>
                </div>

                <div class="hr"></div>

                <div class="titlebar titlebar--mt-sm">
                  <label class="h4">共同照顧者（可多筆）</label>
                  <button type="button" class="small" onclick="addCoCare()">＋新增共同照顧者</button>
                </div>
                <div id="coCare"></div>

                <div class="hr"></div>

                <div>
                  <label class="h4">正式資源（多選）</label>
                  <div class="muted">固定：<span class="badge">社區整合型服務中心為福安</span></div>
                  <div class="checkcol" id="sp_formal"></div>
                  <div id="homeCareWrap" style="display:none; margin-top:var(--space-xs);">
                    <div class="titlebar">
                      <label class="h4">居家服務項目（多選）</label>
                      <button class="small" type="button" onclick="resetCareServicePhrases()">重新套用片語</button>
                    </div>
                    <div id="homeCareList" class="home-care-grid"></div>
                    <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整；如需記錄用量，請於右側欄位輸入數量。</div>
                  </div>
                  <div id="dayCareWrap" style="display:none; margin-top:var(--space-xs);">
                    <div class="titlebar">
                      <label class="h4">日間照顧服務項目（多選）</label>
                      <button class="small" type="button" onclick="resetCareServicePhrases()">重新套用片語</button>
                    </div>
                    <div id="dayCareList" class="home-care-grid"></div>
                    <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
                  </div>
                  <div id="profServiceWrap" style="display:none; margin-top:var(--space-xs);">
                    <div class="titlebar">
                      <label class="h4">專業服務項目（多選）</label>
                      <button class="small" type="button" onclick="resetProfessionalPhrases()">重新套用片語</button>
                    </div>
                    <div id="profServiceList" class="home-care-grid"></div>
                    <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
                  </div>
                  <div id="transportServiceWrap" style="display:none; margin-top:var(--space-xs);">
                    <div class="titlebar">
                      <label class="h4">交通接送項目（多選）</label>
                      <button class="small" type="button" onclick="resetTransportPhrases()">重新套用片語</button>
                    </div>
                    <div id="transportServiceList" class="home-care-grid"></div>
                    <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
                  </div>
                  <div id="respServiceWrap" style="display:none; margin-top:var(--space-xs);">
                    <div class="titlebar">
                      <label class="h4">喘息服務項目（多選）</label>
                      <button class="small" type="button" onclick="resetRespitePhrases()">重新套用片語</button>
                    </div>
                    <div id="respServiceList" class="home-care-grid"></div>
                    <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
                  </div>
                  <div id="mealServiceWrap" style="display:none; margin-top:var(--space-xs);">
                    <div class="titlebar">
                      <label class="h4">營養送餐項目（多選）</label>
                      <button class="small" type="button" onclick="resetMealPhrases()">重新套用片語</button>
                    </div>
                    <div id="mealServiceList" class="home-care-grid"></div>
                    <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
                  </div>
                </div>

                <div class="hr"></div>

                <div>
                  <label class="h4">非正式資源（多選，每類需填「單位名稱」）</label>
                  <div>
                    <label class="h5 inline"><input type="checkbox" id="sp_inf_pt" onchange="toggleInfInput('pt')"> 據點</label>
                    <input id="sp_inf_pt_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
                    <select id="sp_inf_pt_freq" style="display:none; margin-top:var(--space-xs);"><!-- 據點頻率 -->
                    <option value="">—請選擇頻率—</option>
                    <option>每週</option>
                    <option>每月</option>
                    <option>不定期</option>
                    <option>未知</option>
                  </select>

                  </div>
                  <div>
                    <label class="h5 inline"><input type="checkbox" id="sp_inf_nb" onchange="toggleInfInput('nb')"> 鄰里</label>
                    <input id="sp_inf_nb_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
                    <select id="sp_inf_nb_freq" style="display:none; margin-top:var(--space-xs);"><!-- 鄰里頻率 -->
                    <option value="">—請選擇頻率—</option>
                    <option>每週</option>
                    <option>每月</option>
                    <option>不定期</option>
                    <option>未知</option>
                  </select>

                  </div>
                  <div>
                    <label class="h5 inline"><input type="checkbox" id="sp_inf_rg" onchange="toggleInfInput('rg')"> 宗教社團</label>
                    <input id="sp_inf_rg_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
                    <select id="sp_inf_rg_freq" style="display:none; margin-top:var(--space-xs);"><!-- 宗教社團頻率 -->
                    <option value="">—請選擇頻率—</option>
                    <option>每週</option>
                    <option>每月</option>
                    <option>不定期</option>
                    <option>未知</option>
                  </select>

                  </div>
                  <div>
                    <label class="h5 inline"><input type="checkbox" id="sp_inf_fw" onchange="toggleInfInput('fw')"> 財團／社會福利</label>
                    <input id="sp_inf_fw_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
                    <select id="sp_inf_fw_freq" style="display:none; margin-top:var(--space-xs);"><!-- 財團頻率 -->
                    <option value="">—請選擇頻率—</option>
                    <option>每週</option>
                    <option>每月</option>
                    <option>不定期</option>
                    <option>未知</option>
                  </select>

                  </div>
                </div>

                <div class="hr"></div>
                <div>
                  <label class="h4">高風險評估（多選）</label>
                  <div class="checkcol" id="sp_risks"></div>
                  <div class="subtle">勾選將只輸出「標題短語」，說明文字僅作參考。</div>
                </div>

              <textarea id="section4_out" style="display:none;" data-progress-ignore="1"></textarea>
            </div>
        <div id="section5_block" data-section="s5">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（五）其他</label>
              </div>
              <textarea id="section5" placeholder="如個案成長背景、職業、生活習慣、價值觀等。"></textarea>
            </div>
        <div id="section6_block" data-section="s6">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（六）複評評值</label>
              </div>
              <div class="autogrid autogrid--wide">
                <div><label class="h4">介入前</label><textarea id="s6_before" placeholder="如果為新評，則無需輸入"></textarea></div>
                <div><label class="h4">介入後</label><textarea id="s6_after" placeholder="如果為新評，則無需輸入"></textarea></div>
              </div>
              <textarea id="section6_struct" style="display:none;" data-progress-ignore="1"></textarea>
            </div>
    </div>


        <!-- 五、照顧目標（原功能保留） -->
        <div class="group card-lg span-2 plan-card-care-goals" id="careGoalsGroup" data-span="full">
          <div class="group-header">
            <div class="titlebar">
              <span class="h2">五、照顧目標</span>
            </div>
          </div>

          <div class="group-content">
            <div id="careGoals_block" data-section="cg">
              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（一）照顧問題（最多選 5 項）</label>
              </div>
              <div class="care-goal-block">
                <div class="care-goal-heading">
                  <div id="problemCount">已選 0 / 5</div>
                </div>
                <div class="checkcol" id="problemList"></div>
                <div class="virtual-checklist-print" id="problemListPrint" aria-hidden="true"></div>
                <label class="h4" style="margin-top:var(--space-xs);">補充說明（可選）</label>
                <textarea id="problemNote" placeholder="例如：近期以移位與吞嚥為優先風險…"></textarea>
              </div>

              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（二）短期目標（0–3 個月）</label>
              </div>
              <div class="care-goal-block">
                <div class="autogrid autogrid--wide">
                  <div id="short_care_wrap"><label class="h4">照顧服務</label><textarea id="short_care" placeholder="填寫欄位"></textarea></div>
                  <div id="short_prof_wrap"><label class="h4">專業服務</label><textarea id="short_prof" placeholder="填寫欄位"></textarea></div>
                  <div id="short_car_wrap"><label class="h4">交通接送</label><textarea id="short_car"  placeholder="填寫欄位"></textarea></div>
                  <div id="short_resp_wrap"><label class="h4">喘息服務</label><textarea id="short_resp" placeholder="填寫欄位"></textarea></div>
                  <div id="short_access_wrap"><label class="h4">無障礙及輔具</label><textarea id="short_access" placeholder="填寫欄位"></textarea></div>
                  <div id="short_meal_wrap"><label class="h4">營養送餐</label><textarea id="short_meal" placeholder="填寫欄位"></textarea></div>
                </div>
              </div>

              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（三）中期目標（3–4 個月）</label>
              </div>
              <div class="care-goal-block">
                <div class="autogrid autogrid--wide">
                  <div id="mid_care_wrap"><label class="h4">照顧服務</label><textarea id="mid_care" placeholder="填寫欄位"></textarea></div>
                  <div id="mid_prof_wrap"><label class="h4">專業服務</label><textarea id="mid_prof" placeholder="填寫欄位"></textarea></div>
                  <div id="mid_car_wrap"><label class="h4">交通接送</label><textarea id="mid_car"  placeholder="填寫欄位"></textarea></div>
                  <div id="mid_resp_wrap"><label class="h4">喘息服務</label><textarea id="mid_resp" placeholder="填寫欄位"></textarea></div>
                  <div id="mid_access_wrap"><label class="h4">無障礙及輔具</label><textarea id="mid_access" placeholder="填寫欄位"></textarea></div>
                  <div id="mid_meal_wrap"><label class="h4">營養送餐</label><textarea id="mid_meal" placeholder="填寫欄位"></textarea></div>
                </div>
              </div>

              <div class="titlebar">
                <label class="h3 heading-tier heading-tier--primary">（四）長期目標（4–6 個月）</label>
              </div>
              <div class="care-goals-side-inner">
                <textarea id="long_goal" placeholder="將由短/中期彙整自動填入；可再微調。"></textarea>
                <div class="hr"></div>
                <label class="h4">目標文字預覽（含碼別與各期結構）</label>
                <div id="goalPreview" class="preview goal-preview-empty">（尚未選擇服務或填寫內容）</div>
              </div>
            </div>
          </div>
    </div>


        <!-- 六、與照專…（原功能保留） -->
        <div class="group card-lg span-2 plan-card-mismatch" id="mismatchPlanGroup" data-span="full">
          <div class="group-header">
            <div class="titlebar">
              <span class="h2">六、與照專建議服務項目、問題清單不一致原因說明及未來規劃、後續追蹤計劃</span>
            </div>
          </div>
          <div class="group-content">
            <div class="row"><div>
              <label class="h3">（一）目標達成的狀況以及未達成的差距</label>
              <textarea id="reason1" placeholder="填寫欄位"></textarea>
            </div></div>
            <div class="row"><div>
              <label class="h3">（二）資源的變動情形</label>
              <textarea id="reason2" placeholder="填寫欄位"></textarea>
            </div></div>
            <div class="row"><div>
              <label class="h3">（三）未使用的替代方案或是可能的影響</label>
              <textarea id="reason3" placeholder="填寫欄位"></textarea>
              <div class="hr"></div>
              <label class="h4">常用快捷（勾選即加入第 3 格）</label>
              <div style="margin:var(--space-xs) 0;">
                <input id="rq1_no" type="text" placeholder="原服務，例如：備餐" style="margin-right:4px;">
                <input id="rq1_alt" type="text" placeholder="替代服務，例如：代購服務">
              </div>
              <label class="h5 inline"><input type="checkbox" id="rq1"> 1.經與<span id="rq1_who">案○</span>討論，目前暫無<span id="rq1_no_preview" data-def="備餐">備餐</span>之需求，改為<span id="rq1_alt_preview" data-def="代購服務">代購服務</span>。</label>
              <div style="margin:var(--space-xs) 0;">
                <input id="rq2_service" type="text" placeholder="服務，例如：專業服務">
              </div>
              <label class="h5 inline"><input type="checkbox" id="rq2"> 2.經與<span id="rq2_who">案○</span>討論，目前因個案身體狀況，暫無<span id="rq2_service_preview" data-def="專業服務">專業服務</span>需求，日後待個案狀況好轉後，依當下狀況核定，續追蹤。</label>
              <div id="mismatch_diff_block" style="display:none; margin-top:var(--space-sm);">
                <div class="hint" id="mismatch_diff_text">與照專建議服務不一致項目：</div>
                <div class="mismatch-diff" id="mismatch_diff_list"></div>
                <div class="checkcol" id="mismatch_reason_box" data-legend="與照專建議服務不一致項目"></div>
                <input id="mismatch_reason_other" type="text" placeholder="請說明其他原因" style="display:none; margin-top:var(--space-xs);">
                <div class="field-error" id="mismatch_reason_error"></div>
              </div>
            </div></div>
          </div>
    </div>

  </div>

  <div class="page-section" data-page="execution" data-columns="2">
    <div class="group" data-span="full" data-collapsed="1">
      <div class="group-header">
        <div class="titlebar">
          <span class="h1">計畫執行規劃</span>
        </div>
      </div>
      <div class="group-content">
        <div class="section-card-grid">
        <section class="section-card" id="planExecutionCard">
          <div class="titlebar">
            <label class="h2">一、長照服務核定項目、頻率</label>
          </div>
          <div class="plan-guideline">
            <p>請依核定的正式資源填寫承接方式、指定單位、用量與使用方式，系統會同步整理附件二預覽與額度統計。</p>
            <p>若同一服務由不同單位提供，或同時含自費段，請個別建立明細並清楚標註說明。</p>
          </div>
          <div id="planEditor" class="plan-editor"></div>
          <div class="plan-category plan-category-meta" data-plan-category="EMERGENCY">
            <div class="plan-category-heading">
              <h3 class="h3" id="h3-exec-emergency" data-anchor="h3-exec-emergency">（八）緊急救援服務</h3>
            </div>
            <div class="plan-category-body">
              <label class="h4" for="plan_emergency_note">救援需求說明</label>
              <textarea id="plan_emergency_note" placeholder="例：申請○○緊急救援系統，因跌倒風險與夜間頻繁起夜"></textarea>
            </div>
          </div>
        </section>

        <section class="section-card" id="planReferralCard">
          <div class="titlebar">
            <label class="h2">二、轉介其他服務資源</label>
          </div>
          <textarea id="plan_referral_extra" placeholder="例：慈濟資源站－已聯繫，提供物資協助"></textarea>
          <div class="plan-meta-grid">
            <div>
              <label class="h3" for="plan_station_info">巷弄長照站資訊</label>
              <textarea id="plan_station_info" placeholder="例：○○巷弄長照站（地址，距離1.2公里，電話0000-000000）"></textarea>
            </div>
            <div>
              <label class="h3" for="plan_station_willingness">參與意願</label>
              <select id="plan_station_willingness">
                <option value="">—請選擇—</option>
                <option value="有意願">有意願</option>
                <option value="無意願">無意願</option>
              </select>
            </div>
          </div>
        </section>

        <section class="section-card" id="planSummaryCard">
          <div class="titlebar">
            <label class="h2">附件二（服務計畫明細）預覽</label>
          </div>
          <div class="summary-actions">
            <button type="button" class="small" id="planSummaryCopyBtn">複製表格</button>
            <button type="button" class="small" id="planSummaryCopyPlainBtn">複製為純文字</button>
          </div>
          <div class="plan-summary-controls">
            <label class="inline-checkbox" for="hasForeignCare">
              <input id="hasForeignCare" type="checkbox" /> 案家聘有外籍看護（扣減 30%）
            </label>
            <div class="hint">勾選後將自動扣減 CMS 月額度 30%，計算餘額與自付額時一併套用。</div>
          </div>
          <span class="h3">額度統計</span>
          <div id="planSummaryTotals" class="plan-summary-totals">
            <div class="plan-summary-total-card">
              <div class="plan-summary-total-label">CMS 等級月額度</div>
              <div class="plan-summary-total-value" id="planSummaryCap">—</div>
            </div>
            <div class="plan-summary-total-card">
              <div class="plan-summary-total-label">B/C 預估耗用</div>
              <div class="plan-summary-total-value" id="planSummaryUsage">—</div>
            </div>
            <div class="plan-summary-total-card">
              <div class="plan-summary-total-label">預估餘額</div>
              <div class="plan-summary-total-value" id="planSummaryRemaining">—</div>
            </div>
            <div class="plan-summary-total-card">
              <div class="plan-summary-total-label">上限內自付</div>
              <div class="plan-summary-total-value" id="planSummaryWithin">—</div>
            </div>
            <div class="plan-summary-total-card">
              <div class="plan-summary-total-label">超額自付</div>
              <div class="plan-summary-total-value" id="planSummaryExcess">—</div>
            </div>
            <div class="plan-summary-total-card">
              <div class="plan-summary-total-label">總自付</div>
              <div class="plan-summary-total-value" id="planSummarySelfPay">—</div>
            </div>
          </div>
          <div id="planSummaryTotalsHint" class="plan-summary-totals-hint" data-show="0"></div>
          <span class="h3">預覽內容</span>
          <div id="planSummaryPreview" class="summary-table-wrapper">
            <div class="hint">尚未選擇服務項目。</div>
          </div>
        </section>

        <section class="section-card" id="planExecutionPreviewCard">
          <div class="titlebar">
            <label class="h2">附件一：計畫執行規劃預覽</label>
          </div>
          <span class="h3">預覽內容</span>
          <div class="hint">預覽（可複製貼上至計畫執行規劃頁面）：</div>
          <textarea id="plan_text" class="plan-preview" readonly></textarea>
        </section>
      </div>
      </div>
    </div>
    <div class="group">
      <div class="group-content">
        <div class="btnbar">
        <button class="primary" onclick="applyAndSave()">產出（複製/升版並開啟新檔）</button>
      </div>
        <div id="errorSummary" data-show="0"></div>
        <div id="msg" class="hint" style="margin-top:var(--space-xs);"></div>
      </div>
    </div>
  </div>

  <div class="page-section" data-page="notes" data-columns="1">
    <div class="group" id="planOtherGroup" data-span="full" data-collapsed="1">
      <div class="group-header">
        <div class="titlebar">
          <span class="h1">其他備註</span>
        </div>
      </div>
      <div class="group-content">
        <div class="section-card-grid">
        <section class="section-card">
          <div class="titlebar">
            <span class="h2">其他</span>
          </div>
          <div class="hint">個案特殊狀況或其他未盡事宜可備註於此。</div>
          <label class="h3" for="plan_other">補充說明</label>
          <textarea id="plan_other" placeholder="如有補充事項請於此敘述"></textarea>
        </section>
      </div>
    </div>
  </div>
        </main>
      </div>

      <div class="floating-actions" id="floatingActions" aria-label="頁面操作">
        <button type="button" class="primary" id="wizardSaveBtn">存檔</button>
        <div id="wizardMoreWrapper">
          <button type="button" id="wizardMoreBtn" aria-haspopup="true" aria-expanded="false" aria-controls="wizardMoreMenu" aria-label="更多操作" title="更多操作">⋯</button>
          <div class="floating-more-menu" id="wizardMoreMenu" role="menu" data-open="0">
            <button type="button" class="small" id="wizardPrevCompactBtn" role="menuitem">返回</button>
          </div>
        </div>
        <button type="button" id="wizardNextBtn">下一步</button>
        <button type="button" data-variant="ghost" id="wizardPrevBtn">返回</button>
      </div>

      <div id="validationToast" data-show="0" role="alert" aria-live="assertive">
        <div class="toast-title">提交前請先修正</div>
        <div class="toast-message" id="validationToastText">表單有未完成的欄位，請補齊後再提交。</div>
        <div class="toast-actions">
          <button type="button" class="small primary" id="validationToastAction">前往修正</button>
          <button type="button" class="small" id="validationToastClose">稍後再看</button>
        </div>
      </div>

      <div id="headingSpecToast" data-show="0" role="status" aria-live="polite">
        <div class="toast-message" id="headingSpecToastMessage"></div>
        <div class="toast-actions">
          <button type="button" class="small primary" id="headingSpecToastApply">重新套用標題</button>
          <button type="button" class="small" id="headingSpecToastDismiss">稍後處理</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    /* ===== 版面配置工具 ===== */
    const FONT_SCALE_STORAGE_KEY = 'AA01.fontScale';
    const FONT_SCALE_DEFAULT = 'sm';
    const FONT_SCALE_OPTIONS = ['sm','xl'];
    const FONT_SCALE_ALIASES = { md:'xl', lg:'xl' };
    function normalizeFontScale(scale){
      if(!scale) return null;
      const alias = FONT_SCALE_ALIASES[scale];
      if(alias) return alias;
      return FONT_SCALE_OPTIONS.indexOf(scale) !== -1 ? scale : null;
    }
    const SUMMARY_ELEMENT_IDS = {
      root:'stickySummary',
      caseName:'summaryCaseName',
      cmsLevel:'summaryCmsLevel',
      progressFill:'summaryProgressFill',
      progressText:'summaryProgressText',
      remainingText:'summaryRemainingText'
    };
    const PAGE_LABELS = {
      basic:'基本資訊',
      goals:'計畫目標',
      execution:'計畫執行規劃',
      notes:'其他備註'
    };

    const HEADING_SCHEMA_VERSION = '2025-10-01';
    const HEADING_SCHEMA_VERSION_STORAGE_KEY = 'AA01.headingSchema.version';
    const LEGACY_HEADING_VERSION_STORAGE_KEY = 'AA01.headingSpec.version';

    const HEADING_SCHEMA = Object.freeze([
      {
        id:'h1-basic', tag:'h1', label:'基本資訊', page:'basic',
        dom:{ selector:'#basicInfoGroup .titlebar .h1', mode:'replace', className:'h1' },
        children:[
          { id:'h2-basic-unit-code', tag:'h2', label:'單位代碼',
            dom:{ selector:'#basicInfoGroup label[for="unitCode"]', mode:'labelHeading', className:'h2' } },
          { id:'h2-basic-case-manager', tag:'h2', label:'個案管理師',
            dom:{ selector:'#basicInfoGroup label[for="caseManagerName"]', mode:'labelHeading', className:'h2' } },
          { id:'h2-basic-case-name', tag:'h2', label:'個案姓名',
            dom:{ selector:'#basicInfoGroup label[for="caseName"]', mode:'labelHeading', className:'h2' } },
          { id:'h2-basic-consultant-name', tag:'h2', label:'照專姓名',
            dom:{ selector:'#basicInfoGroup label[for="consultName"]', mode:'labelHeading', className:'h2' } },
          { id:'h2-basic-cms-level', tag:'h2', label:'CMS 等級',
            dom:{ selector:'.cms-level-row > label[for="cmsLevelValue"]', mode:'labelHeading', className:'h2' } }
        ]
      },
      {
        id:'h1-goals', tag:'h1', label:'計畫目標', page:'goals',
        dom:{ selector:'#contactVisitGroup .titlebar .h1', mode:'replace', className:'h1' },
        children:[
          {
            id:'h2-goals-call', tag:'h2', label:'一、電聯日期',
            dom:{ selector:'#contactVisitGroup .contact-visit-card[data-card="call"] .titlebar .h2', mode:'replace', className:'h2' },
            children:[
              { id:'h3-goals-call-date', tag:'h3', label:'電聯日期',
                dom:{ selector:'#contactVisitGroup label[for="callDate"]', mode:'labelHeading', className:'h3' } },
              { id:'h3-goals-call-consult', tag:'h3', label:'照顧專員約訪',
                dom:{ selector:'#contactVisitGroup .contact-visit-card[data-card="call"] label.inline-checkbox', mode:'labelHeading', className:'h3' } }
            ]
          },
          {
            id:'h2-goals-homevisit', tag:'h2', label:'二、家訪日期',
            dom:{ selector:'#contactVisitGroup .contact-visit-card[data-card="visit"] .titlebar .h2', mode:'replace', className:'h2' },
            children:[
              { id:'h3-goals-homevisit-date', tag:'h3', label:'家訪日期',
                dom:{ selector:'#contactVisitGroup label[for="visitDate"]', mode:'labelHeading', className:'h3' } },
              { id:'h3-goals-prep-date', tag:'h3', label:'出院日期',
                dom:{ selector:'#dischargeBox label[for="dischargeDate"]', mode:'labelHeading', className:'h3' } }
            ]
          },
          {
            id:'h2-goals-companions', tag:'h2', label:'三、偕同訪視者',
            dom:{ selector:'#visitPartnersCard .titlebar .h2', mode:'replace', className:'h2' },
            children:[
              { id:'h3-goals-primary-rel', tag:'h3', label:'主要照顧者關係',
                dom:{ selector:'#visitPartnersCard label[for="primaryRel"]', mode:'labelHeading', className:'h3' } },
              { id:'h3-goals-primary-name', tag:'h3', label:'主要照顧者姓名',
                dom:{ selector:'#visitPartnersCard label[for="primaryName"]', mode:'labelHeading', className:'h3' } },
              { id:'h3-goals-extra-rel', tag:'h3', label:'其他參與者關係' },
              { id:'h3-goals-extra-name', tag:'h3', label:'其他參與者姓名' }
            ]
          },
          {
            id:'h2-goals-overview', tag:'h2', label:'四、個案概況',
            dom:{ selector:'#caseOverviewGroup .titlebar .h2', mode:'replace', className:'h2 heading-tier heading-tier--primary' },
            children:[
              { id:'h3-goals-s1', tag:'h3', label:'（一）身心概況',
                dom:{ selector:'#section1_block > .titlebar label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-s2', tag:'h3', label:'（二）經濟收入',
                dom:{ selector:'#section2_block > .titlebar label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-s3', tag:'h3', label:'（三）居住環境',
                dom:{ selector:'#section3_block > .titlebar label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-s4', tag:'h3', label:'（四）社會支持',
                dom:{ selector:'#section4_block > .titlebar label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-s5', tag:'h3', label:'（五）其他',
                dom:{ selector:'#section5_block > .titlebar label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-s6', tag:'h3', label:'（六）複評評值',
                dom:{ selector:'#section6_block > .titlebar label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } }
            ]
          },
          {
            id:'h2-goals-targets', tag:'h2', label:'五、照顧目標',
            dom:{ selector:'#careGoalsGroup .titlebar .h2', mode:'replace', className:'h2' },
            children:[
              { id:'h3-goals-targets-problems', tag:'h3', label:'（一）照顧問題',
                dom:{ selector:'#careGoals_block > .titlebar:nth-of-type(1) label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-targets-short', tag:'h3', label:'（二）短期目標（0–3 個月）',
                dom:{ selector:'#careGoals_block > .titlebar:nth-of-type(2) label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-targets-mid', tag:'h3', label:'（三）中期目標（3–4 個月）',
                dom:{ selector:'#careGoals_block > .titlebar:nth-of-type(3) label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } },
              { id:'h3-goals-targets-long', tag:'h3', label:'（四）長期目標（4–6 個月）',
                dom:{ selector:'#careGoals_block > .titlebar:nth-of-type(4) label', mode:'replace', className:'h3 heading-tier heading-tier--primary' } }
            ]
          },
          {
            id:'h2-goals-mismatch', tag:'h2', label:'六、與照專建議服務項目、問題清單不一致原因說明及未來規劃、後續追蹤計劃',
            dom:{ selector:'#mismatchPlanGroup .titlebar .h2', mode:'replace', className:'h2' },
            children:[
              { id:'h3-goals-mismatch-1', tag:'h3', label:'（一）目標達成的狀況以及未達成的差距',
                dom:{ selector:'#mismatchPlanGroup textarea#reason1', mode:'previousLabelHeading', className:'h3' } },
              { id:'h3-goals-mismatch-2', tag:'h3', label:'（二）資源的變動情形',
                dom:{ selector:'#mismatchPlanGroup textarea#reason2', mode:'previousLabelHeading', className:'h3' } },
              { id:'h3-goals-mismatch-3', tag:'h3', label:'（三）未使用的替代方案或是可能的影響',
                dom:{ selector:'#mismatchPlanGroup textarea#reason3', mode:'previousLabelHeading', className:'h3' } }
            ]
          }
        ]
      },
      {
        id:'h1-exec', tag:'h1', label:'計畫執行規劃', page:'execution',
        dom:{ selector:'.page-section[data-page="execution"] .group > .group-header .titlebar .h1', mode:'replace', className:'h1' },
        children:[
          {
            id:'h2-exec-services', tag:'h2', label:'一、長照服務核定項目、頻率',
            dom:{ selector:'#planExecutionCard .titlebar label', mode:'replace', className:'h2' },
            children:[
              { id:'h3-exec-b', tag:'h3', label:'（一）B碼',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="B"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-c', tag:'h3', label:'（二）C碼',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="C"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-d', tag:'h3', label:'（三）D碼',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="D"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-ef', tag:'h3', label:'（四）E.F碼',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="EF"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-g', tag:'h3', label:'（五）G碼',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="G"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-sc', tag:'h3', label:'（六）SC碼',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="SC"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-nutrition', tag:'h3', label:'（七）營養餐飲服務',
                dom:{ selector:'#planEditor .plan-category[data-plan-category="MEAL"] .plan-category-heading h3', mode:'replace', className:'h3' } },
              { id:'h3-exec-emergency', tag:'h3', label:'（八）緊急救援服務',
                dom:{ selector:'#planExecutionCard .plan-category[data-plan-category="EMERGENCY"] .plan-category-heading h3', mode:'replace', className:'h3' } }
            ]
          },
          { id:'h2-exec-referral', tag:'h2', label:'二、轉介其他服務資源',
            dom:{ selector:'#planReferralCard .titlebar label', mode:'replace', className:'h2' } },
          { id:'h2-exec-station', tag:'h2', label:'三、巷弄長照站資訊與意願' },
          { id:'h2-exec-emergency-note', tag:'h2', label:'四、緊急救援服務說明' },
          { id:'h2-exec-attachment2', tag:'h2', label:'附件二（服務計畫明細）預覽' },
          { id:'h2-exec-attachment1', tag:'h2', label:'附件一：計畫執行規劃預覽' }
        ]
      },
      {
        id:'h1-notes', tag:'h1', label:'其他備註', page:'notes',
        dom:{ selector:'#planOtherGroup .titlebar .h1', mode:'replace', className:'h1' },
        children:[
          { id:'h2-notes-other', tag:'h2', label:'其他（個案特殊狀況或其他未盡事宜可備註於此）',
            dom:{ selector:'#planOtherGroup .section-card .titlebar .h2, #planOtherGroup .section-card .titlebar span.h2', mode:'replace', className:'h2' } }
        ]
      }
    ]);

    const HEADING_INDEX = {};
    const HEADING_NODE_LIST = [];
    const HEADING_DOM_REGISTRY = {};
    let HEADING_INDEX_ORDER = 0;

    const VALID_HEADING_TAGS = ['h1','h2','h3','h4','h5','h6'];

    function normalizeHeadingTag(tag, parent){
      const text = typeof tag === 'string' ? tag.trim().toLowerCase() : '';
      if(text && VALID_HEADING_TAGS.indexOf(text) !== -1){
        return text;
      }
      if(parent && parent.level){
        const level = Math.min(6, parent.level + 1);
        return 'h' + level;
      }
      return 'h1';
    }

    function inferHeadingLevel(tag, parent){
      if(typeof tag === 'string'){
        const match = tag.toLowerCase().match(/h([1-6])/);
        if(match){
          return Number(match[1]);
        }
      }
      if(parent && typeof parent.level === 'number'){
        return parent.level + 1;
      }
      return 1;
    }

    function assignHeadingEntries(entries, parent){
      if(!Array.isArray(entries)) return;
      entries.forEach(function(entry){
        if(!entry || !entry.id) return;
        const tag = normalizeHeadingTag(entry.tag, parent);
        const node = {
          id:String(entry.id),
          label:entry.label || '',
          tag:tag,
          level:inferHeadingLevel(tag, parent),
          page:entry.page || (parent ? parent.page : ''),
          parentId:parent ? parent.id : null,
          order:HEADING_INDEX_ORDER++,
          children:Array.isArray(entry.children)
            ? entry.children.map(function(child){ return child && child.id ? child.id : null; }).filter(Boolean)
            : [],
          domConfig:entry.dom || null,
          dom:entry.dom || null,
          elements:[],
          element:null
        };
        HEADING_INDEX[node.id] = node;
        HEADING_NODE_LIST.push(node);
        if(Array.isArray(entry.children) && entry.children.length){
          assignHeadingEntries(entry.children, node);
        }
      });
    }

    function rebuildHeadingIndex(schema){
      Object.keys(HEADING_INDEX).forEach(function(key){
        delete HEADING_INDEX[key];
      });
      Object.keys(HEADING_DOM_REGISTRY).forEach(function(key){
        delete HEADING_DOM_REGISTRY[key];
      });
      HEADING_NODE_LIST.length = 0;
      HEADING_INDEX_ORDER = 0;
      const source = Array.isArray(schema) ? schema : HEADING_SCHEMA;
      assignHeadingEntries(source, null);
      return HEADING_INDEX;
    }

    rebuildHeadingIndex(HEADING_SCHEMA);

    function getHeadingNode(anchorId){
      return anchorId ? HEADING_INDEX[anchorId] || null : null;
    }

    function getHeadingEntry(anchorId){
      return getHeadingNode(anchorId);
    }

    function forEachHeading(callback){
      if(typeof callback !== 'function') return;
      HEADING_NODE_LIST
        .slice()
        .sort(function(a,b){ return a.order - b.order; })
        .forEach(function(node){ callback(node); });
    }

    function getPageOfHeading(anchorId){
      const node = getHeadingNode(anchorId);
      return node && node.page ? node.page : '';
    }

    function resetHeadingDomRegistry(){
      Object.keys(HEADING_DOM_REGISTRY).forEach(function(key){
        delete HEADING_DOM_REGISTRY[key];
      });
      HEADING_NODE_LIST.forEach(function(node){
        if(!node) return;
        node.elements = [];
        node.element = null;
      });
    }

    function recordHeadingDom(nodeId, element){
      if(!nodeId || !element) return;
      const node = getHeadingNode(nodeId);
      if(node){
        if(!Array.isArray(node.elements)){
          node.elements = [];
        }
        if(node.elements.indexOf(element) === -1){
          node.elements.push(element);
        }
        node.element = node.elements[0] || element;
      }
      if(!HEADING_DOM_REGISTRY[nodeId]){
        HEADING_DOM_REGISTRY[nodeId] = [];
      }
      if(HEADING_DOM_REGISTRY[nodeId].indexOf(element) === -1){
        HEADING_DOM_REGISTRY[nodeId].push(element);
      }
    }

    const simpleGroupControllers = {};
    const headingGroupRegistry = {};

    function registerHeadingGroup(anchorId, section, group){
      if(!anchorId || !section || !group) return;
      headingGroupRegistry[anchorId] = { section:section, group:group };
      if(!section.__headingGroupMap){ section.__headingGroupMap = {}; }
      section.__headingGroupMap[anchorId] = group;
    }

    function resetHeadingGroupRegistry(){
      Object.keys(headingGroupRegistry).forEach(function(key){ delete headingGroupRegistry[key]; });
    }

    function getHeadingGroup(anchorId){
      return anchorId ? headingGroupRegistry[anchorId] || null : null;
    }

    const SIDE_NAV_MEDIA_QUERY = '(max-width: 1279px)';
    const SIDE_NAV_TOGGLE_STATE = { button:null, backdrop:null, media:null, expanded:false };

    function getSideNavToggleElements(){
      if(!SIDE_NAV_TOGGLE_STATE.button){
        SIDE_NAV_TOGGLE_STATE.button = document.getElementById('sideNavToggleButton');
      }
      if(!SIDE_NAV_TOGGLE_STATE.backdrop){
        SIDE_NAV_TOGGLE_STATE.backdrop = document.getElementById('sideNavBackdrop');
      }
      if(!SIDE_NAV_TOGGLE_STATE.media && typeof window !== 'undefined' && window.matchMedia){
        SIDE_NAV_TOGGLE_STATE.media = window.matchMedia(SIDE_NAV_MEDIA_QUERY);
      }
      return SIDE_NAV_TOGGLE_STATE;
    }

    function isSideNavOverlayMode(){
      const toggle=getSideNavToggleElements();
      if(toggle.media){
        return !!toggle.media.matches;
      }
      if(typeof window !== 'undefined' && typeof window.innerWidth === 'number'){
        return window.innerWidth <= 1279;
      }
      return false;
    }

    function setSideNavExpanded(expanded){
      const next = !!expanded;
      const body=document.body;
      if(body){
        body.setAttribute('data-side-nav-open', next ? '1' : '0');
      }
      const toggle=getSideNavToggleElements();
      if(toggle.button){
        toggle.button.setAttribute('aria-expanded', next ? 'true' : 'false');
        toggle.button.classList.toggle('is-active', next);
      }
      toggle.expanded = next;
    }

    function focusFirstSideNavItem(){
      const nav=document.getElementById('sideNav');
      if(!nav) return;
      const focusable=nav.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if(focusable && typeof focusable.focus === 'function'){
        focusable.focus();
      }else if(typeof nav.focus === 'function'){
        nav.focus();
      }
    }

    function openSideNav(){
      setSideNavExpanded(true);
      if(isSideNavOverlayMode()){
        window.requestAnimationFrame(()=>focusFirstSideNavItem());
      }
    }

    function closeSideNav(options){
      const opts = options || {};
      const previouslyExpanded = getSideNavToggleElements().expanded;
      setSideNavExpanded(false);
      if(opts.restoreFocus && previouslyExpanded){
        const toggleBtn=getSideNavToggleElements().button;
        if(toggleBtn && typeof toggleBtn.focus === 'function'){
          toggleBtn.focus();
        }
      }
    }

    function syncSideNavToggleAvailability(hasItems){
      const toggle=getSideNavToggleElements().button;
      const available=!!hasItems;
      if(toggle){
        toggle.disabled = !available;
        toggle.setAttribute('aria-disabled', available ? 'false' : 'true');
      }
      if(!available){
        closeSideNav({ force:true });
      }
    }

    function initSideNavToggle(){
      const state=getSideNavToggleElements();
      const button=state.button;
      const backdrop=state.backdrop;
      if(button){
        button.setAttribute('aria-expanded', 'false');
        button.setAttribute('aria-disabled', button.disabled ? 'true' : 'false');
        button.addEventListener('click', ()=>{
          if(button.disabled) return;
          const expanded=button.getAttribute('aria-expanded') === 'true';
          if(expanded){
            closeSideNav({ force:true, restoreFocus:true });
          }else{
            openSideNav();
          }
        });
      }
      if(backdrop){
        backdrop.addEventListener('click', ()=>closeSideNav({ force:true, restoreFocus:true }));
      }
      document.addEventListener('keydown', event=>{
        if(event && event.key === 'Escape' && getSideNavToggleElements().expanded && isSideNavOverlayMode()){
          closeSideNav({ force:true, restoreFocus:true });
        }
      });
      const media=getSideNavToggleElements().media;
      const handleMediaChange=evt=>{
        if(evt && evt.matches === false){
          setSideNavExpanded(false);
        }
      };
      if(media){
        if(media.addEventListener){
          media.addEventListener('change', handleMediaChange);
        }else if(media.addListener){
          media.addListener(handleMediaChange);
        }
        handleMediaChange(media);
      }else{
        setSideNavExpanded(false);
      }
      syncSideNavToggleAvailability(Array.isArray(SIDE_NAV_STATE.items) && SIDE_NAV_STATE.items.length > 0);
    }

    function resolveSectionKey(source){
      if(!source) return '';
      if(typeof source === 'string') return source;
      if(source.dataset && source.dataset.section) return source.dataset.section;
      return source.id || '';
    }

    function isSectionCardTitlebar(node){
      if(!node || node.nodeType !== 1) return false;
      if(!node.classList || !node.classList.contains('titlebar')) return false;
      const label=node.querySelector('.h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6, label, span');
      return !!(label && label.textContent && label.textContent.trim());
    }

    function findFirstCardNode(section){
      if(!section || !section.children) return null;
      const nodes=Array.from(section.children);
      for(let i=0;i<nodes.length;i++){
        const node=nodes[i];
        if(isSectionCardTitlebar(node)) return node;
        if(node && node.querySelector && node.querySelector('.h1, .h2, .h3, .h4, .h5, .h6')) return node;
      }
      return null;
    }

    function isHeadingElement(node){
      if(!node || node.nodeType !== 1) return false;
      if(node.classList){
        if(node.classList.contains('titlebar')) return true;
        const headingClasses=['h1','h2','h3','h4','h5','h6'];
        for(let i=0;i<headingClasses.length;i++){
          if(node.classList.contains(headingClasses[i])) return true;
        }
        if(node.classList.contains('heading-tier')) return true;
      }
      const tag=node.tagName ? node.tagName.toUpperCase() : '';
      if(tag && /^H[1-6]$/.test(tag)) return true;
      if(tag === 'LABEL') return true;
      return false;
    }

    function ensureGroupTitlebar(group){
      if(!group || !group.querySelector) return null;
      let titlebar=group.querySelector(':scope > .titlebar');
      if(titlebar) return titlebar;
      const firstElement=group.firstElementChild;
      if(isHeadingElement(firstElement)){
        if(firstElement.classList && firstElement.classList.contains('titlebar')){
          titlebar=firstElement;
        }else{
          titlebar=document.createElement('div');
          titlebar.className='titlebar';
          group.insertBefore(titlebar, firstElement);
          titlebar.appendChild(firstElement);
        }
        return titlebar;
      }
      return null;
    }

    function ensureGroupContentWrapper(group){
      if(!group || !group.classList || !group.classList.contains('group')) return null;
      const children = Array.from(group.children || []);
      if(!children.length) return null;
      const header = children.find(child=>child && child.classList && child.classList.contains('group-header'));
      if(!header) return null;
      let body = children.find(child=>child && child.classList && child.classList.contains('group-content'));
      if(body) return body;
      body = document.createElement('div');
      body.className = 'group-content';
      while(header.nextSibling){
        body.appendChild(header.nextSibling);
      }
      group.appendChild(body);
      return body;
    }

    function ensureAllGroupBodies(root){
      if(!root || !root.querySelectorAll) return;
      const groups = root.querySelectorAll('.group');
      groups.forEach(group=>ensureGroupContentWrapper(group));
    }

    function ensureUniqueIdsWithin(root){
      if(!root || !root.querySelectorAll) return;
      const preferred = Object.create(null);
      const nodes = Array.from(document.querySelectorAll('[id]'));
      nodes.forEach(node=>{
        if(!node || !node.id) return;
        const key=node.id;
        const insideRoot = root.contains ? root.contains(node) : false;
        const record = preferred[key];
        if(!record || (insideRoot && !record.inside)){
          preferred[key] = { node, inside: insideRoot };
        }
      });
      const used = new Set();
      const counters = Object.create(null);
      nodes.forEach(node=>{
        if(!node || !node.id) return;
        const key=node.id;
        const record = preferred[key];
        if(record && record.node === node){
          used.add(key);
          return;
        }
        let base = key;
        let index = counters[base] || 1;
        let candidate = `${base}__${index}`;
        while(used.has(candidate) || (document.getElementById(candidate) && document.getElementById(candidate) !== node)){
          index += 1;
          candidate = `${base}__${index}`;
        }
        counters[base] = index + 1;
        const scope = node.closest ? (node.closest('[data-section]') || node.closest('.group') || node.parentElement || root || document) : document;
        updateIdReferences(key, candidate, scope);
        node.id = candidate;
        used.add(candidate);
      });
    }

    function updateIdReferences(oldId, newId, scope){
      if(!oldId || !newId || oldId === newId) return;
      const root = scope && scope.querySelectorAll ? scope : document;
      const attrList=['for','aria-controls','aria-describedby','aria-labelledby','aria-owns','aria-activedescendant'];
      attrList.forEach(attr=>{
        root.querySelectorAll(`[${attr}]`).forEach(el=>{
          const value=el.getAttribute(attr);
          if(!value) return;
          if(attr === 'for' || attr === 'aria-controls'){
            if(value === oldId){
              el.setAttribute(attr, newId);
            }
            return;
          }
          const parts=value.split(/\s+/).filter(Boolean);
          let changed=false;
          for(let i=0;i<parts.length;i++){
            if(parts[i] === oldId){
              parts[i] = newId;
              changed=true;
            }
          }
          if(changed){
            el.setAttribute(attr, parts.join(' '));
          }
        });
      });
      root.querySelectorAll(`[href="#${oldId}"]`).forEach(el=>{
        el.setAttribute('href', `#${newId}`);
      });
    }

    function escapeCssId(id){
      if(typeof id !== 'string') return '';
      if(window.CSS && typeof window.CSS.escape === 'function'){
        return window.CSS.escape(id);
      }
      return id.replace(/([\\.#:\[\]\(\),>+~*^$|='"{}\s])/g, '\\$1');
    }

    const PAGE_SECTION_DEFAULTS = {
      basic:{ columns:'1', active:'1' },
      goals:{ columns:'2', active:'0' },
      execution:{ columns:'2', active:'0' },
      notes:{ columns:'1', active:'0' }
    };

    function ensurePageSectionSkeleton(){
      const map = {};
      const host = document.getElementById('appMain');
      if(!host) return map;
      const order = Array.isArray(PAGE_ORDER) ? PAGE_ORDER : Object.keys(PAGE_LABELS || {});
      order.forEach(pageId=>{
        if(!pageId) return;
        let section = host.querySelector(`.page-section[data-page="${pageId}"]`);
        if(!section){
          section = document.createElement('div');
          section.className = 'page-section';
          section.dataset.page = pageId;
          host.appendChild(section);
        }
        const defaults = PAGE_SECTION_DEFAULTS[pageId] || { columns:'1', active:'0' };
        section.dataset.page = pageId;
        section.dataset.columns = defaults.columns;
        section.dataset.active = defaults.active;
        map[pageId] = section;
      });
      order.forEach(pageId=>{
        const section = map[pageId];
        if(section && section.parentElement === host){
          host.appendChild(section);
        }
      });
      return map;
    }

    function cardizePageSections(){
      const sections = Array.from(document.querySelectorAll('[data-section]'));
      sections.forEach(section=>{
        normalizeLayout(section);
        cleanupEmptyContainers(section);
      });
      ensureAllGroupBodies(document);
      return sections;
    }

    function prepareSectionContainers(sections){
      const prepared = [];
      const list = Array.isArray(sections) ? sections : Array.from(document.querySelectorAll('[data-section]'));
      list.forEach(section=>{
        if(!section) return;
        const groups = buildSectionGroups(section);
        section.__groups = groups;
        const containerInfo = prepareFieldContainers(section);
        section.__fieldContainers = containerInfo.containers;
        section.__dependencies = containerInfo.dependencies;
        prepared.push({ section, groups, containers:containerInfo.containers, dependencies:containerInfo.dependencies });
      });
      return prepared;
    }

    function enhanceInitialCheckcols(){
      refreshCheckcols(document);
    }

    function buildInitialDomStructure(){
      ensurePageSectionSkeleton();
      applyHeadingsToDOM(HEADING_SCHEMA);
      applyGridUtilities(document);
      const sections = cardizePageSections();
      enforceSection1CardLayout();
      resetHeadingGroupRegistry();
      prepareSectionContainers(sections);
      enhanceInitialCheckcols();
      persistHeadingSchemaVersion(HEADING_SCHEMA_VERSION);
      return sections;
    }

    function createCardFromTitlebar(titlebar, sectionKey){
      const card=document.createElement('section');
      card.className='section-card';
      card.appendChild(titlebar);
      if(sectionKey) card.dataset.section = sectionKey;
      card.dataset.card='1';
      if(titlebar.dataset && titlebar.dataset.collapsed){
        card.dataset.collapsed = titlebar.dataset.collapsed === '1' ? '1' : '0';
      }else{
        card.dataset.collapsed='0';
      }
      const titleText=(titlebar.textContent || '').trim();
      if(titleText) card.dataset.cardTitle = titleText;
      return card;
    }

    function normalizeLayout(node, options){
      if(!node) return null;

      function isCardLike(target){
        if(!target || target.nodeType !== 1 || !target.classList) return false;
        if(target.classList.contains('section-card')) return true;
        if(target.classList.contains('group')) return true;
        if(target.dataset && target.dataset.card === '1') return true;
        return false;
      }

      function ensureCard(target, sectionKey, sectionElement, forceCard){
        if(!target || target.nodeType !== 1) return target;
        const forced = !!forceCard;
        const asCard = forced || (target.classList && target.classList.contains('section-card'));
        if(asCard){
          if(target.classList.contains('group')){
            target.classList.remove('group');
          }
          if(target.classList.contains('card')){
            target.classList.remove('card');
          }
          if(target.classList && !target.classList.contains('section-card')){
            target.classList.add('section-card');
          }
          if(target.dataset){
            if(!target.dataset.card){
              target.dataset.card='1';
            }
            if(!target.dataset.collapsible){
              const hasCollapsedAttr=target.hasAttribute && target.hasAttribute('data-collapsed');
              target.dataset.collapsible = hasCollapsedAttr ? '1' : '0';
            }
            if(!target.dataset.collapsed){
              target.dataset.collapsed='0';
            }
            if(sectionKey && !target.dataset.section){
              target.dataset.section = sectionKey;
            }
          }
        }else{
          if(!target.classList.contains('group')){
            target.classList.add('group');
          }
          if(target.classList.contains('section-card')){
            target.classList.remove('section-card');
          }
          if(target.classList.contains('card')){
            target.classList.remove('card');
          }
          if(target.dataset && !target.dataset.collapsed){
            target.dataset.collapsed='0';
          }
          if(sectionKey && target.dataset && !target.dataset.section){
            target.dataset.section = sectionKey;
          }
        }
        const titlebar=ensureGroupTitlebar(target);
        if(titlebar && titlebar !== target.firstElementChild){
          target.insertBefore(titlebar, target.firstChild);
        }
        if(target.dataset && !target.dataset.cardTitle){
          const label=(titlebar || target).querySelector('.h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6, label, span');
          const text=label && label.textContent ? label.textContent.trim() : (titlebar ? titlebar.textContent || '' : '').trim();
          if(text) target.dataset.cardTitle = text;
        }
        Array.from(target.children || []).forEach(child=>{
          process(child, {
            sectionElement: sectionElement || (target.closest ? target.closest('[data-section]') : null),
            sectionKey
          });
        });
        return target;
      }

      function normalizeGrid(grid, sectionKey, sectionElement){
        if(!grid) return grid;
        const hostSection = sectionElement || (grid.closest ? grid.closest('[data-section]') : null);
        const key = sectionKey || resolveSectionKey(hostSection);
        let current=null;
        let nodeChild=grid.firstChild;
        while(nodeChild){
          const next=nodeChild.nextSibling;
          if(nodeChild.nodeType !== 1){
            if(current){ current.appendChild(nodeChild); }
            nodeChild=next;
            continue;
          }
          if(nodeChild.classList && nodeChild.classList.contains('section-card-grid')){
            process(nodeChild, { sectionElement: hostSection, sectionKey: key });
            current=null;
            nodeChild=next;
            continue;
          }
          if(nodeChild.classList && (nodeChild.classList.contains('group') || nodeChild.classList.contains('section-card'))){
            current = process(nodeChild, { sectionElement: hostSection, sectionKey: key, forceCard:true });
            nodeChild=next;
            continue;
          }
          if(isSectionCardTitlebar(nodeChild)){
            const card=createCardFromTitlebar(nodeChild, key);
            process(card, { sectionElement: hostSection, sectionKey: key, forceCard:true });
            grid.insertBefore(card, nodeChild);
            nodeChild.remove();
            current = card;
            nodeChild=next;
            continue;
          }
          if(nodeChild.classList && nodeChild.classList.contains('hr')){
            nodeChild.remove();
            nodeChild=next;
            continue;
          }
          if(current){
            current.appendChild(nodeChild);
          }
          nodeChild=next;
        }
        return grid;
      }

      function normalizeSection(sectionNode, sectionKey){
        if(!sectionNode) return sectionNode;
        const hostSection = sectionNode;
        const key = sectionKey || resolveSectionKey(sectionNode);
        const children=Array.from(sectionNode.children || []);
        const firstCardNode=findFirstCardNode(sectionNode);
        const hasGrid=children.some(child=>child && child.classList && child.classList.contains('section-card-grid'));
        if(firstCardNode && !hasGrid){
          const grid=document.createElement('div');
          grid.className='section-card-grid';
          sectionNode.insertBefore(grid, firstCardNode);
          let current=null;
          let nodeChild=firstCardNode;
          while(nodeChild){
            const next=nodeChild.nextSibling;
            if(nodeChild.nodeType !== 1){
              if(current){ current.appendChild(nodeChild); }
              nodeChild=next;
              continue;
            }
            if(nodeChild.classList && nodeChild.classList.contains('hr')){
              nodeChild.remove();
              nodeChild=next;
              continue;
            }
            if(isSectionCardTitlebar(nodeChild)){
              const card=createCardFromTitlebar(nodeChild, key);
              process(card, { sectionElement: hostSection, sectionKey:key, forceCard:true });
              grid.appendChild(card);
              nodeChild.remove();
              current=card;
            }else if(nodeChild.classList && (nodeChild.classList.contains('group') || nodeChild.classList.contains('section-card'))){
              current=process(nodeChild, { sectionElement: hostSection, sectionKey:key, forceCard:true });
              grid.appendChild(current);
            }else if(current){
              current.appendChild(nodeChild);
            }else{
              grid.appendChild(nodeChild);
            }
            nodeChild=next;
          }
        }
        sectionNode.querySelectorAll('.section-card-grid').forEach(grid=>process(grid, { sectionElement: hostSection, sectionKey:key }));
        promoteFieldHeadings(sectionNode, key, card=>{
          process(card, { sectionElement: hostSection, sectionKey:key, forceCard:true });
        });
        cleanupEmptyContainers(sectionNode);
        return sectionNode;
      }

      function process(target, opts){
        if(!target || target.nodeType !== 1) return target;
        const optSection = opts && opts.sectionElement ? opts.sectionElement : (target.matches && target.matches('[data-section]') ? target : (target.closest ? target.closest('[data-section]') : null));
        const key = opts && opts.sectionKey ? opts.sectionKey : resolveSectionKey(optSection);
        if(opts && opts.forceCard){
          return ensureCard(target, key, optSection, true);
        }
        if(target.matches && target.matches('[data-section]')){
          return normalizeSection(target, key);
        }
        if(target.classList && target.classList.contains('section-card-grid')){
          return normalizeGrid(target, key, optSection);
        }
        if(isCardLike(target)){
          return ensureCard(target, key, optSection, false);
        }
        Array.from(target.children || []).forEach(child=>process(child, { sectionElement: optSection, sectionKey: key }));
        return target;
      }

      const initialSection = options && options.sectionElement ? options.sectionElement : (node.matches && node.matches('[data-section]') ? node : (node.closest ? node.closest('[data-section]') : null));
      const initialKey = options && options.sectionKey ? options.sectionKey : resolveSectionKey(initialSection);
      return process(node, { sectionElement: initialSection, sectionKey: initialKey });
    }

    function promoteFieldHeadings(section, sectionKeyOverride, onPromote){
      if(!section) return;
      const headings=Array.from(section.querySelectorAll('.h3, .h4')).filter(heading=>{
        if(heading.closest('.group')) return false;
        if(heading.closest('.section-card')) return false;
        if(heading.closest('.titlebar')) return false;
        return true;
      });
      headings.forEach(heading=>{
        const container=heading.parentElement;
        if(!container) return;
        const grid=container.closest('.section-card-grid');
        if(!grid) return;
        const hostSection=grid.closest('[data-section]') || section;
        const sectionKey=sectionKeyOverride || resolveSectionKey(hostSection);
        const card=document.createElement('section');
        card.className='section-card';
        const titlebar=document.createElement('div');
        titlebar.className='titlebar';
        titlebar.appendChild(heading);
        card.appendChild(titlebar);
        container.parentNode.insertBefore(card, container);
        card.appendChild(container);
        if(typeof onPromote === 'function'){
          onPromote(card, sectionKey, hostSection);
        }
        grid.appendChild(card);
      });
    }

    function cleanupEmptyContainers(root){
      if(!root || !root.querySelectorAll) return;
      const nodes=Array.from(root.querySelectorAll('div'));
      nodes.forEach(node=>{
        if(!node) return;
        if(node.children.length) return;
        if((node.textContent || '').trim() !== '') return;
        if(node.id) return;
        if(node.dataset && Object.keys(node.dataset).length) return;
        node.remove();
      });
    }

    function applyGridUtilities(root){
      if(!root || !root.querySelectorAll) return;
      root.querySelectorAll('.row').forEach(el=>{
        el.classList.remove('row');
        el.classList.add('autogrid','autogrid--wide');
      });
      const legacyGridClasses=['grid2','grid3','form-row-2col','form-row-3col'];
      legacyGridClasses.forEach(cls=>{
        root.querySelectorAll(`.${cls}`).forEach(el=>{
          el.classList.remove(...legacyGridClasses);
          el.classList.add('autogrid','autogrid--wide');
        });
      });
      root.querySelectorAll('.checkcol').forEach(el=>{
        el.classList.add('checkgrid');
        el.querySelectorAll('label').forEach(label=>label.classList.add('check-item'));
      });
    }

    function upgradeLegacyContainers(section){
      if(!section) return;
      normalizeLayout(section);
      applyGridUtilities(section);
    }

    function enforceSection1CardLayout(){
      const section = document.getElementById('section1_block');
      if(!section) return;
      const sectionKey = resolveSectionKey(section) || (section.dataset ? section.dataset.section : '');
      const titlebar = section.querySelector(':scope > .titlebar');
      const errorSummary = section.querySelector('#section1_error_summary');
      const structuralNodes = new Set();
      if(titlebar) structuralNodes.add(titlebar);
      if(errorSummary) structuralNodes.add(errorSummary);

      function ensureCardMeta(card){
        if(!card || card.nodeType !== 1) return card;
        if(card.classList && !card.classList.contains('section-card')){
          card.classList.add('section-card');
        }
        if(card.dataset){
          if(!card.dataset.card){
            card.dataset.card = '1';
          }
          if(sectionKey && !card.dataset.section){
            card.dataset.section = sectionKey;
          }
          if(!card.dataset.collapsible){
            card.dataset.collapsible = '0';
          }
        }
        return card;
      }

      function promoteContainerToCards(container){
        const cards = [];
        if(!container) return cards;
        if(container.classList && container.classList.contains('section-card')){
          cards.push(ensureCardMeta(container));
          return cards;
        }
        if(container.classList && container.classList.contains('section-card-grid')){
          const children = Array.from(container.children || []);
          children.forEach(child=>{
            promoteContainerToCards(child).forEach(card=>cards.push(card));
          });
          container.remove();
          return cards;
        }
        const titlebarNode = container.querySelector(':scope > .titlebar');
        let card = null;
        if(titlebarNode){
          card = createCardFromTitlebar(titlebarNode, sectionKey);
        }else{
          card = document.createElement('section');
          card.className = 'section-card';
        }
        while(container.firstChild){
          card.appendChild(container.firstChild);
        }
        container.remove();
        cards.push(ensureCardMeta(card));
        return cards;
      }

      function ensureGrid(){
        const directChildren = Array.from(section.children || []).filter(child=>child && child.nodeType === 1);
        let grid = directChildren.find(child=>child.classList && child.classList.contains('section-card-grid')) || null;
        if(!grid){
          grid = document.createElement('div');
          grid.className = 'section-card-grid';
          grid.dataset.role = 'section1-card-grid';
          const insertBefore = directChildren.find(child=>!structuralNodes.has(child));
          section.insertBefore(grid, insertBefore || null);
        }else{
          grid.dataset.role = grid.dataset.role || 'section1-card-grid';
        }
        const nodesToMove = Array.from(section.children || []).filter(child=>{
          if(!child || child.nodeType !== 1) return false;
          if(structuralNodes.has(child)) return false;
          if(child === grid) return false;
          if(child.classList && child.classList.contains('group')) return false;
          return child.parentElement === section;
        });
        nodesToMove.forEach(node=>grid.appendChild(node));
        return grid;
      }

      const grid = ensureGrid();
      if(!grid){
        const auditFallback = getUiAuditState();
        if(auditFallback){
          auditFallback.s1_cardized = false;
        }
        return;
      }
      let firstCard = grid.querySelector(':scope > .section-card');
      if(!firstCard){
        const candidate = grid.firstElementChild;
        if(candidate){
          const produced = promoteContainerToCards(candidate);
          if(produced.length){
            const fragment = document.createDocumentFragment();
            produced.forEach(card=>fragment.appendChild(card));
            grid.insertBefore(fragment, grid.firstChild);
            firstCard = produced[0] || null;
          }
        }
      }else{
        ensureCardMeta(firstCard);
      }
      const hasCard = !!grid.querySelector(':scope > .section-card');
      if(hasCard && errorSummary){
        const targetCard = firstCard || grid.querySelector(':scope > .section-card');
        if(targetCard && !targetCard.contains(errorSummary)){
          targetCard.insertBefore(errorSummary, targetCard.firstChild);
        }
      }
      if(section.dataset){
        section.dataset.s1Cardized = hasCard ? '1' : '0';
      }
      const audit = getUiAuditState();
      if(audit){
        audit.s1_cardized = hasCard;
      }
      cleanupEmptyContainers(section);
      normalizeLayout(section);
      scheduleAllMeasurements();
    }

    function applyHeadingsToDOM(schema){
      const targetSchema = Array.isArray(schema) ? schema : HEADING_SCHEMA;
      if(schema && targetSchema !== HEADING_SCHEMA){
        rebuildHeadingIndex(targetSchema);
      }else if(!HEADING_NODE_LIST.length){
        rebuildHeadingIndex(targetSchema);
      }
      resetHeadingDomRegistry();
      const missing = [];
      forEachHeading(function(entry){
        if(!entry || !entry.id) return;
        const domConfig = entry.domConfig || entry.dom;
        if(!domConfig) return;
        const configs = Array.isArray(domConfig) ? domConfig : [domConfig];
        configs.forEach(function(config){
          if(!config || !config.selector) return;
          const mode = (config.mode || 'replace').toLowerCase();
          const className = config.className || (entry.tag ? entry.tag.toLowerCase() : '');
          const labelText = typeof config.label === 'string' ? config.label : (entry.label || '');
          if(mode === 'replace'){
            let target = null;
            try{ target = document.querySelector(config.selector); }catch(err){ target = null; }
            if(!target || !target.parentNode){ missing.push(entry.id); return; }
            let heading = null;
            if(target.id === entry.id && target.tagName && target.tagName.toLowerCase() === (entry.tag || 'h3').toLowerCase()){
              heading = target;
              heading.dataset.anchor = entry.id;
              heading.textContent = labelText;
              if(className){ heading.className = className; }
            }else{
              heading = document.createElement(entry.tag || 'h3');
              if(className){ heading.className = className; }
              heading.id = entry.id;
              heading.dataset.anchor = entry.id;
              heading.textContent = labelText;
              target.parentNode.replaceChild(heading, target);
            }
            recordHeadingDom(entry.id, heading);
            return;
          }
          if(mode === 'labelheading'){
            let label = null;
            try{ label = document.querySelector(config.selector); }catch(err){ label = null; }
            if(!label){ missing.push(entry.id); return; }
            let heading = label.querySelector('#' + entry.id);
            const desiredTag = entry.tag || 'h3';
            if(!heading || heading.tagName.toLowerCase() !== desiredTag.toLowerCase()){
              heading = document.createElement(desiredTag);
              label.innerHTML = '';
              label.appendChild(heading);
            }
            heading.id = entry.id;
            heading.dataset.anchor = entry.id;
            heading.textContent = labelText;
            heading.className = className || (entry.tag ? entry.tag.toLowerCase() : 'h3');
            recordHeadingDom(entry.id, heading);
            return;
          }
          if(mode === 'previouslabelheading'){
            let field = null;
            try{ field = document.querySelector(config.selector); }catch(err){ field = null; }
            if(!field){ missing.push(entry.id); return; }
            const container = field.closest ? field.closest('div') : null;
            const label = container ? container.querySelector('label') : (field.parentElement ? field.parentElement.querySelector('label') : null);
            if(!label){ missing.push(entry.id); return; }
            let heading = label.querySelector('#' + entry.id);
            const desiredTag = entry.tag || 'h3';
            if(!heading || heading.tagName.toLowerCase() !== desiredTag.toLowerCase()){
              heading = document.createElement(desiredTag);
              label.innerHTML = '';
              label.appendChild(heading);
            }
            heading.id = entry.id;
            heading.dataset.anchor = entry.id;
            heading.textContent = labelText;
            heading.className = className || (entry.tag ? entry.tag.toLowerCase() : 'h3');
            recordHeadingDom(entry.id, heading);
            return;
          }
        });
      });
      ensureGoalsExtraHeadings();
      forEachHeading(function(entry){
        if(!entry || !entry.id) return;
        const existing = document.getElementById(entry.id);
        if(existing){
          recordHeadingDom(entry.id, existing);
        }
      });
      const audit = getUiAuditState();
      if(audit){
        const entry = getHeadingNode('h3-goals-prep-date');
        const domNode = document.getElementById('h3-goals-prep-date');
        const entryLabel = entry && entry.label ? entry.label.trim() : '';
        const domLabel = domNode && domNode.textContent ? domNode.textContent.trim() : '';
        audit.discharge_label_ok = entryLabel === '出院日期' && domLabel === '出院日期';
      }
      if(missing.length){
        console.warn('缺少標題對應元素', missing);
      }
      return missing;
    }

    function ensureGoalsExtraHeadings(){
      const host = document.getElementById('extras');
      if(!host) return;
      const entryRel = getHeadingNode('h3-goals-extra-rel');
      const entryName = getHeadingNode('h3-goals-extra-name');
      const relId = 'h3-goals-extra-rel';
      const nameId = 'h3-goals-extra-name';
      let wrap = document.getElementById('extrasHeading');
      if(!wrap){
        wrap = document.createElement('div');
        wrap.id = 'extrasHeading';
        wrap.className = 'extras-heading-grid';
        if(host.parentNode){
          host.parentNode.insertBefore(wrap, host);
        }
      }else if(!wrap.classList.contains('extras-heading-grid')){
        wrap.className = 'extras-heading-grid';
      }
      const ensureHeading = function(current, config, id){
        const desiredTag = (config && config.tag) ? String(config.tag) : 'h3';
        const desiredLabel = config && config.label ? config.label : '';
        const desiredClass = config && config.tag ? config.tag.toLowerCase() : 'h3';
        const fallbackLabel = id === relId ? '其他參與者關係' : '其他參與者姓名';
        if(!current || current.tagName.toLowerCase() !== desiredTag.toLowerCase()){
          const nextHeading = document.createElement(desiredTag);
          nextHeading.id = id;
          if(current && current.parentNode === wrap){
            wrap.replaceChild(nextHeading, current);
          }else{
            wrap.appendChild(nextHeading);
          }
          current = nextHeading;
        }
        current.id = id;
        current.dataset.anchor = id;
        current.className = desiredClass || 'h3';
        current.textContent = desiredLabel || current.textContent || fallbackLabel;
        return current;
      };
      let relHeading = document.getElementById(relId);
      relHeading = ensureHeading(relHeading, entryRel, relId);
      recordHeadingDom(relId, relHeading);
      let nameHeading = document.getElementById(nameId);
      nameHeading = ensureHeading(nameHeading, entryName, nameId);
      recordHeadingDom(nameId, nameHeading);
    }

    function refreshExecutionHeadingRegistry(){
      if(!sectionViewsReady) return;
      const meta = getHeadingGroup('h2-exec-services');
      if(!meta || !meta.section || !meta.group) return;
      const anchors = [];
      if(typeof PLAN_CATEGORY_GROUPS !== 'undefined' && Array.isArray(PLAN_CATEGORY_GROUPS)){
        PLAN_CATEGORY_GROUPS.forEach(function(group){
          if(group && group.anchor){ anchors.push(group.anchor); }
        });
      }
      anchors.push('h3-exec-emergency');
      anchors.forEach(function(anchorId){
        if(!anchorId) return;
        const heading = document.getElementById(anchorId);
        if(!heading) return;
        registerHeadingGroup(anchorId, meta.section, meta.group);
      });
      scheduleSideNavRender();
    }

    function validateHeadingSchema(){
      const doc = typeof document === 'undefined' ? null : document;
      const issues = [];
      if(!doc){
        return { valid:true, issues:issues, invalidAnchors:[], missing:[] };
      }
      const seenIds = new Set();
      forEachHeading(function(entry){
        if(!entry || !entry.id) return;
        const id = entry.id;
        if(seenIds.has(id)){
          issues.push({ type:'duplicate-id', id:id, message:'標題 ID 重複' });
        }else{
          seenIds.add(id);
        }
        const tag = (entry.tag || '').toLowerCase();
        if(tag && VALID_HEADING_TAGS.indexOf(tag) === -1){
          issues.push({ type:'invalid-tag', id:id, tag:entry.tag, message:'不支援的標題標籤' });
        }
        const page = entry.page;
        if(page && !PAGE_LABELS[page]){
          issues.push({ type:'invalid-page', id:id, page:page, message:'未定義的頁面代碼' });
        }
        const domConfig = entry.domConfig || entry.dom;
        const configs = Array.isArray(domConfig) ? domConfig : (domConfig ? [domConfig] : []);
        configs.forEach(function(config){
          if(!config || !config.selector) return;
          let nodes = [];
          try{
            nodes = Array.from(doc.querySelectorAll(config.selector));
          }catch(err){
            issues.push({ type:'invalid-selector', id:id, selector:config.selector, message:'無法解析的選擇器' });
            return;
          }
          if(!nodes.length){
            issues.push({ type:'dom-not-found', id:id, selector:config.selector, message:'找不到選擇器對應元素' });
          }
        });
        let duplicates = [];
        let selector = '#' + escapeCssId(id);
        try{
          duplicates = Array.from(doc.querySelectorAll(selector));
        }catch(err){
          try{ duplicates = Array.from(doc.querySelectorAll('#' + id)); }catch(err2){ duplicates = []; }
        }
        if(duplicates.length > 1){
          issues.push({ type:'dom-duplicate', id:id, count:duplicates.length, message:'文件存在重複的標題 ID' });
        }
      });
      const invalidAnchors = Array.from(new Set(issues.map(function(issue){ return issue.id; }).filter(Boolean)));
      return {
        valid: issues.length === 0,
        issues: issues,
        invalidAnchors: invalidAnchors,
        missing: invalidAnchors
      };
    }

    function logHeadingSchemaReport(){
      const report = validateHeadingSchema();
      if(!window || !window.console) return report;
      if(console.groupCollapsed){ console.groupCollapsed('HEADING_SCHEMA 驗證報告'); }
      else if(console.group){ console.group('HEADING_SCHEMA 驗證報告'); }
      if(report.issues.length){
        if(console.table){
          console.table(report.issues);
        }else{
          console.warn('HEADING_SCHEMA 驗證錯誤', report.issues);
        }
        if(report.invalidAnchors.length){
          console.warn('存在問題的標題錨點', report.invalidAnchors);
        }
      }else{
        console.info('所有 HEADING_SCHEMA 定義的錨點皆已就緒。');
      }
      if(console.groupEnd){ console.groupEnd(); }
      return report;
    }

    const HEADING_SCHEMA_TOAST_STATE = { element:null, message:null, apply:null, dismiss:null };

    function getHeadingSchemaToastState(){
      if(!HEADING_SCHEMA_TOAST_STATE.element){
        HEADING_SCHEMA_TOAST_STATE.element = document.getElementById('headingSpecToast');
        HEADING_SCHEMA_TOAST_STATE.message = document.getElementById('headingSpecToastMessage');
        HEADING_SCHEMA_TOAST_STATE.apply = document.getElementById('headingSpecToastApply');
        HEADING_SCHEMA_TOAST_STATE.dismiss = document.getElementById('headingSpecToastDismiss');
      }
      if(!HEADING_SCHEMA_TOAST_STATE.element){
        return null;
      }
      return HEADING_SCHEMA_TOAST_STATE;
    }

    function formatHeadingNames(anchorIds){
      if(!Array.isArray(anchorIds)) return [];
      return anchorIds.map(id=>{
        const entry = getHeadingNode(id);
        return entry && entry.label ? entry.label : id;
      });
    }

    function showHeadingSchemaToast(invalidAnchors){
      const state = getHeadingSchemaToastState();
      if(!state || !state.element || !state.message) return;
      const names = formatHeadingNames(Array.isArray(invalidAnchors) ? invalidAnchors : []);
      const text = names.length ? `標題設定異常：${names.join('、')}` : '標題設定異常';
      state.message.textContent = text;
      state.element.dataset.show = '1';
    }

    function hideHeadingSchemaToast(){
      const state = getHeadingSchemaToastState();
      if(!state || !state.element) return;
      state.element.dataset.show = '0';
    }

    function handleHeadingSchemaValidation(report){
      const invalidAnchors = report && Array.isArray(report.invalidAnchors)
        ? report.invalidAnchors
        : (report && Array.isArray(report.missing) ? report.missing : []);
      if(invalidAnchors.length){
        showHeadingSchemaToast(invalidAnchors);
        const audit = getUiAuditState();
        if(audit){
          audit.heading_show_toast_if_missing = 'shown';
        }
      }else{
        hideHeadingSchemaToast();
        const audit = getUiAuditState();
        if(audit){
          if(audit.heading_show_toast_if_missing === 'shown'){
            audit.heading_show_toast_if_missing = 'resolved';
          }else if(audit.heading_show_toast_if_missing === 'pending'){
            audit.heading_show_toast_if_missing = 'ready';
          }else if(audit.heading_show_toast_if_missing !== 'resolved'){
            audit.heading_show_toast_if_missing = 'ready';
          }
        }
      }
    }

    function initHeadingSchemaToast(){
      const state = getHeadingSchemaToastState();
      if(!state || !state.element) return;
      const audit = getUiAuditState();
      if(audit){
        audit.heading_toast_present = true;
        if(audit.heading_show_toast_if_missing === 'pending'){
          audit.heading_show_toast_if_missing = 'ready';
        }
      }
      if(state.apply && !state.apply.dataset.boundToast){
        state.apply.dataset.boundToast = '1';
        state.apply.addEventListener('click', ()=>{
          hideHeadingSchemaToast();
          applyHeadingsToDOM();
          const report = logHeadingSchemaReport();
          handleHeadingSchemaValidation(report);
        });
      }
      if(state.dismiss && !state.dismiss.dataset.boundToast){
        state.dismiss.dataset.boundToast = '1';
        state.dismiss.addEventListener('click', ()=>hideHeadingSchemaToast());
      }
    }

    function readHeadingSchemaVersion(){
      const store = getSafeLocalStorage();
      if(!store) return null;
      try{
        let value = store.getItem(HEADING_SCHEMA_VERSION_STORAGE_KEY);
        if(!value && LEGACY_HEADING_VERSION_STORAGE_KEY){
          value = store.getItem(LEGACY_HEADING_VERSION_STORAGE_KEY);
        }
        return value || null;
      }catch(err){
        return null;
      }
    }

    function persistHeadingSchemaVersion(version){
      const store = getSafeLocalStorage();
      if(!store) return;
      try{ store.setItem(HEADING_SCHEMA_VERSION_STORAGE_KEY, version); }catch(err){}
      if(LEGACY_HEADING_VERSION_STORAGE_KEY && LEGACY_HEADING_VERSION_STORAGE_KEY !== HEADING_SCHEMA_VERSION_STORAGE_KEY){
        try{ store.removeItem(LEGACY_HEADING_VERSION_STORAGE_KEY); }catch(err){}
      }
    }

    function applyHeadingSchemaVersionUpgrade(){
      const stored = readHeadingSchemaVersion();
      if(stored === HEADING_SCHEMA_VERSION) return false;
      let changed = false;
      const sections = document.querySelectorAll('[data-section]');
      sections.forEach(section=>{
        if(!section) return;
        const state = section.__state || (section.__state = readSectionState(section.dataset.section));
        let updated = false;
        if(state.hideFilled){
          state.hideFilled = false;
          updated = true;
        }
        if(!state.showAdvanced){
          state.showAdvanced = true;
          updated = true;
        }
        section.dataset.hideFilled = '0';
        section.dataset.showAdvanced = '1';
        const groups = Array.isArray(section.__groups) ? section.__groups : [];
        if(groups.length){
          const firstGroup = groups.find(group=>group && group.element) || groups[0];
          if(firstGroup){
            if(state.collapsedGroups && state.collapsedGroups[firstGroup.id]){
              delete state.collapsedGroups[firstGroup.id];
              updated = true;
            }
            setGroupCollapsed(section, firstGroup, false, { save:false });
          }
        }
        applySectionState(section, state);
        updateAllGroupEmptyStates(section);
        if(updated){
          writeSectionState(section.dataset.section, state);
          updateSideNavForSection(section);
          changed = true;
        }
      });
      persistHeadingSchemaVersion(HEADING_SCHEMA_VERSION);
      if(changed){
          scheduleSummaryUpdate();
        scheduleSideNavRender();
        scheduleAllMeasurements();
      }
      return changed;
    }

    function registerDevDiagnostics(){
      if(typeof window === 'undefined') return;
      const tools = {
        applyHeadingSchemaVersionUpgrade: applyHeadingSchemaVersionUpgrade,
        ensureGoalsPageDefaults: ensureGoalsPageDefaults,
        logHeadingSchemaReport: logHeadingSchemaReport
      };
      try{
        window.AA01_DEVTOOLS = Object.freeze(tools);
      }catch(err){
        window.AA01_DEVTOOLS = tools;
      }
    }

    const PAGE_ORDER = ['basic','goals','execution','notes'];
    let summaryElements = null;
    let lastSavedTimestamp = null;

    const SIDE_NAV_STATE = {
      root:null,
      list:null,
      items:[]
    };
    const Scheduler = (function(){
      let rafId = 0;
      const queues = {
        measure:new Map(),
        compute:new Map(),
        render:new Map()
      };
      const observers = new Set();

      function priorityValue(priority){
        if(priority === 'high') return 0;
        if(priority === 'low') return 2;
        return 1;
      }

      function getNow(){
        if(typeof window !== 'undefined' && window.performance && typeof window.performance.now === 'function'){
          return window.performance.now();
        }
        return Date.now();
      }

      function enqueue(stage, key, fn, priority){
        const map = queues[stage];
        if(!map || !key || typeof fn !== 'function') return;
        map.set(key, { fn: fn, priority: priority || 'normal' });
        requestFrame();
      }

      function drainStage(stage){
        const map = queues[stage];
        if(!map || map.size === 0){
          return { stage: stage, count:0, duration:0 };
        }
        const jobs = Array.from(map.values()).sort(function(a, b){
          return priorityValue(a.priority) - priorityValue(b.priority);
        });
        map.clear();
        const stageStart = getNow();
        for(let i=0; i<jobs.length; i+=1){
          const job = jobs[i];
          if(!job || typeof job.fn !== 'function') continue;
          try{
            job.fn();
          }catch(err){
            if(typeof window !== 'undefined' && window.console && typeof window.console.error === 'function'){
              window.console.error('Scheduler job error:', stage, err);
            }
          }
        }
        return { stage: stage, count: jobs.length, duration: getNow() - stageStart };
      }

      function hasPendingJobs(){
        return queues.measure.size > 0 || queues.compute.size > 0 || queues.render.size > 0;
      }

      function notifyObservers(report){
        if(!observers.size) return;
        observers.forEach(function(observer){
          if(typeof observer !== 'function') return;
          try{
            observer(report);
          }catch(err){
            if(typeof window !== 'undefined' && window.console && typeof window.console.warn === 'function'){
              window.console.warn('Scheduler observer error:', err);
            }
          }
        });
      }

      function frame(timestamp){
        rafId = 0;
        const frameStart = getNow();
        const reports = [];
        reports.push(drainStage('measure'));
        reports.push(drainStage('compute'));
        reports.push(drainStage('render'));
        if(hasPendingJobs()){
          requestFrame();
        }
        notifyObservers({
          timestamp: timestamp,
          start: frameStart,
          duration: getNow() - frameStart,
          stages: reports.filter(function(entry){ return entry.count > 0; })
        });
      }

      function requestFrame(){
        if(rafId) return;
        if(typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function'){
          rafId = window.requestAnimationFrame(frame);
        }else{
          rafId = setTimeout(function(){ frame(getNow()); }, 16);
        }
      }

      function addObserver(fn){
        if(typeof fn === 'function'){ observers.add(fn); }
        return function(){ removeObserver(fn); };
      }

      function removeObserver(fn){
        if(observers.has(fn)) observers.delete(fn);
      }

      function flush(){
        if(!rafId && hasPendingJobs()){
          frame(getNow());
        }
      }

      return {
        enqueue: enqueue,
        requestFrame: requestFrame,
        addObserver: addObserver,
        removeObserver: removeObserver,
        flush: flush
      };
    })();

    const UiFrameCoordinator = (function(){
      let needsLayout = false;
      let needsSummary = false;
      let needsSummaryProgress = false;
      let needsSideNav = false;
      let measureJobScheduled = false;
      let renderJobScheduled = false;

      function ensureMeasureJob(){
        if(measureJobScheduled) return;
        measureJobScheduled = true;
        Scheduler.enqueue('measure','ui:measure', runMeasure, 'high');
      }

      function ensureRenderJob(){
        if(renderJobScheduled) return;
        renderJobScheduled = true;
        Scheduler.enqueue('render','ui:render', runRender, 'high');
      }

      function runMeasure(){
        measureJobScheduled = false;
        if(!needsLayout) return;
        updateVerticalDensityMode();
        measureStickyLayout();
        measureFloatingActionsMetrics();
      }

      function runRender(){
        renderJobScheduled = false;
        if(needsLayout){
          renderStickyLayout();
          renderFloatingActionsMetrics();
          needsLayout = false;
        }
        if(needsSummary || needsSummaryProgress){
          refreshStickySummary();
          needsSummary = false;
          needsSummaryProgress = false;
        }
        if(needsSideNav){
          renderSideNav();
          needsSideNav = false;
        }
      }

      function requestLayout(){
        needsLayout = true;
        ensureMeasureJob();
        ensureRenderJob();
      }

      function requestSummary(){
        needsSummary = true;
        ensureRenderJob();
      }

      function requestSummaryProgress(){
        needsSummaryProgress = true;
        ensureRenderJob();
      }

      function requestSideNav(){
        needsSideNav = true;
        ensureRenderJob();
      }

      return {
        requestLayout: requestLayout,
        requestSummary: requestSummary,
        requestSummaryProgress: requestSummaryProgress,
        requestSideNav: requestSideNav
      };
    })();

    const UI_AUDIT_STATE = {
      discharge_label_ok:false,
      s1_cardized:false,
      goals_defaults_ok:false,
      checkcol_highlight_exists:false,
      contactVisit_init_open:false,
      heading_toast_present:false,
      heading_show_toast_if_missing:'pending'
    };

    function getUiAuditState(){
      return UI_AUDIT_STATE;
    }

    function reportUiAudit(extra){
      const state = getUiAuditState();
      const report = Object.assign({}, state, extra || {});
      if(console && console.groupCollapsed){
        console.groupCollapsed('UI 稽核報告');
        if(console.table){
          console.table(report);
        }else{
          console.log(report);
        }
        console.groupEnd();
      }else if(console){
        console.log('UI 稽核報告', report);
      }
      return report;
    }

    function getPageLabel(pageId){
      if(!pageId) return '其他';
      return PAGE_LABELS[pageId] || pageId;
    }

    const PROBLEM_MAX_SELECTION = 5;
    const problemSelection = new Set();
    let problemListVirtual = null;

    const AUTO_SAVE_STORAGE_KEY = 'AA01.formDraft';
    const AUTO_SAVE_VERSION = 1;
    const AUTO_SAVE_DELAY = 4000;
    let autoSaveTimer = null;
    let isRestoringDraft = false;
    let draftLoadComplete = false;

    let executionPageInitialized = false;

    let currentPageId = 'basic';
    let currentScrollOffset = 0;
    let sectionViewsReady = false;
    let currentVerticalDensityMode = '';
    let planStateSyncOptions = null;
    let pendingStickyLayoutMetrics = null;
    let pendingFloatingActionsMetrics = null;
    const wizardMoreMenuState = { outsideHandler:null, keydownHandler:null };

    function getSafeLocalStorage(){
      if(typeof window === 'undefined') return null;
      try{ return window.localStorage || null; }catch(err){ return null; }
    }

    function readAutoSaveDraft(){
      const store = getSafeLocalStorage();
      if(!store) return null;
      try{
        const raw = store.getItem(AUTO_SAVE_STORAGE_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(!parsed || parsed.version !== AUTO_SAVE_VERSION) return null;
        return parsed;
      }catch(err){
        return null;
      }
    }

    function writeAutoSaveDraft(data){
      const store = getSafeLocalStorage();
      if(!store) return false;
      try{
        store.setItem(AUTO_SAVE_STORAGE_KEY, JSON.stringify(data));
        return true;
      }catch(err){
        return false;
      }
    }

    function clearAutoSaveDraft(){
      const store = getSafeLocalStorage();
      if(!store) return;
      try{ store.removeItem(AUTO_SAVE_STORAGE_KEY); }catch(err){}
    }

    function readExtrasRows(){
      const rows=[];
      document.querySelectorAll('[id^="extra-"]').forEach(row=>{
        const idx = row.id.split('-')[1];
        const roleEl=document.getElementById(`ex-role-${idx}`);
        const customEl=document.getElementById(`ex-custom-${idx}`);
        const nameEl=document.getElementById(`ex-name-${idx}`);
        rows.push({
          role: roleEl ? roleEl.value : '',
          customRole: customEl ? customEl.value : '',
          name: nameEl ? nameEl.value : ''
        });
      });
      return rows;
    }

    function readCoCareRows(){
      const rows=[];
      document.querySelectorAll('[id^="cc-"]').forEach(row=>{
        const idx=row.id.split('-')[1];
        const relEl=document.getElementById(`cc-rel-${idx}`);
        const customEl=document.getElementById(`cc-custom-${idx}`);
        const nameEl=document.getElementById(`cc-name-${idx}`);
        rows.push({
          rel: relEl ? relEl.value : '',
          customRel: customEl ? customEl.value : '',
          name: nameEl ? nameEl.value : ''
        });
      });
      return rows;
    }

    function collectActionDraft(){
      return readActionEntries().map(entry=>({ source: entry.source || '', text: entry.text || '' }));
    }

    function collectDraftSnapshot(){
      const snapshot={
        version:AUTO_SAVE_VERSION,
        timestamp:Date.now(),
        fields:{},
        extrasDraft:readExtrasRows(),
        coCareDraft:readCoCareRows(),
        actionsDraft:collectActionDraft(),
        problems:Array.from(problemSelection),
        servicePlan:serializeServicePlan(),
        planMeta:Object.assign({}, planMetaState)
      };
      const root=document.getElementById('appContainer') || document;
      const inputs=root.querySelectorAll('input, select, textarea');
      inputs.forEach(field=>{
        if(!field || !field.id) return;
        if(field.dataset.autosaveIgnore === '1') return;
        if(/^ex-/.test(field.id) || /^cc-/.test(field.id)) return;
        if(field.closest('.virtual-checklist')) return;
        const type=(field.type || '').toLowerCase();
        if(type === 'checkbox' || type === 'radio'){
          snapshot.fields[field.id] = { type, checked: !!field.checked };
        }else{
          snapshot.fields[field.id] = { type, value: field.value };
        }
      });
      return snapshot;
    }

    function applyFieldEntry(id, entry){
      const el=document.getElementById(id);
      if(!el) return false;
      const type=(entry && entry.type ? entry.type.toLowerCase() : '').replace(/[^a-z]/g,'');
      if(type === 'checkbox' || type === 'radio'){
        const targetChecked = !!entry.checked;
        if(el.checked !== targetChecked){
          el.checked = targetChecked;
        }
        try{ el.dispatchEvent(new Event('change', { bubbles:true })); }catch(err){}
        return true;
      }
      const value = entry && entry.value !== undefined ? entry.value : '';
      if(el.value !== value){
        el.value = value;
      }
      const tag=(el.tagName || '').toLowerCase();
      const eventName = tag === 'select' ? 'change' : 'input';
      try{ el.dispatchEvent(new Event(eventName, { bubbles:true })); }catch(err){}
      if(eventName !== 'change'){
        try{ el.dispatchEvent(new Event('change', { bubbles:true })); }catch(err){}
      }
      return true;
    }

    function applyDraftFields(map){
      if(!map || typeof map !== 'object') return;
      let entries = Object.keys(map).map(id=>({ id, entry: map[id] }));
      let attempt = 0;
      while(entries.length && attempt < 3){
        const pending=[];
        entries.forEach(item=>{
          if(!applyFieldEntry(item.id, item.entry)) pending.push(item);
        });
        entries = pending;
        attempt++;
      }
    }

    function restoreProblemSelection(list){
      problemSelection.clear();
      if(Array.isArray(list)){
        list.forEach(code=>{
          if(code !== undefined && code !== null){
            problemSelection.add(String(code));
          }
        });
      }
      renderProblems();
    }

    function getServiceCardConfig(card){
      if(!card) return null;
      const host = card.closest('#homeCareList, #dayCareList, #profServiceList, #transportServiceList, #respServiceList, #mealServiceList');
      if(!host) return null;
      const id = host.id || '';
      if(id === 'homeCareList') return { hasQty:true };
      if(id === 'dayCareList') return { hasQty:false };
      if(id === 'profServiceList') return { hasQty:false };
      if(id === 'transportServiceList') return { hasQty:false };
      if(id === 'respServiceList') return { hasQty:false };
      if(id === 'mealServiceList') return { hasQty:false };
      return null;
    }

    function restoreServicePlan(entries){
      const list=Array.isArray(entries) ? entries : [];
      const codeSet=new Set(list.map(entry=>String(entry && entry.code ? entry.code : '')).filter(Boolean));
      const entryMap=new Map();
      list.forEach(item=>{
        const code = item && item.code ? String(item.code) : '';
        if(code) entryMap.set(code, item);
      });
      document.querySelectorAll('.home-care-item').forEach(card=>{
        const code = card.dataset ? (card.dataset.code || '') : '';
        const config = getServiceCardConfig(card) || { hasQty:false };
        setServiceCardSelected(card, codeSet.has(code));
        const qty=card.querySelector('.home-care-qty');
        if(config.hasQty){
          if(codeSet.has(code)){
            const saved = entryMap.get(code);
            if(qty){ qty.value = saved && saved.monthlyUnits ? saved.monthlyUnits : (saved && saved.monthlyUnitsComputed ? saved.monthlyUnitsComputed : ''); }
          }else if(qty){
            qty.value='';
          }
        }
      });
      updateCareServicePhrases();
      updateProfessionalServicePhrases();
      updateTransportServicePhrases();
      updateRespiteServicePhrases();
      updateMealServicePhrases();
      syncPlanStateWithSelections({ force:true, skipPreview:true });
      list.forEach(entry=>{
        const code=entry && entry.code ? String(entry.code) : '';
        if(!code) return;
        const state=ensurePlanEntry(code);
        if(!state) return;
        Object.keys(entry).forEach(key=>{
          if(key === 'code') return;
          state[key] = entry[key];
        });
      });
      applyAutomaticPlanning();
      renderServicePlanEditor();
      updateMismatchReasons({ skipPreview:true });
      buildPlanSummaryPreview();
      buildApprovalPlanPreview();
    }

    function applyDraftSnapshot(draft){
      if(!draft || typeof draft !== 'object') return;
      if(Array.isArray(draft.extrasDraft)){ restoreExtras(draft.extrasDraft); }
      if(Array.isArray(draft.coCareDraft)){ restoreCoCare(draft.coCareDraft); }
      if(Array.isArray(draft.actionsDraft)){ restoreActionEntries(draft.actionsDraft); }
      applyDraftFields(draft.fields || {});
      if(Array.isArray(draft.problems)) restoreProblemSelection(draft.problems);
      if(Array.isArray(draft.servicePlan)) restoreServicePlan(draft.servicePlan);
      if(draft.planMeta && typeof draft.planMeta === 'object'){
        Object.assign(planMetaState, draft.planMeta);
        if(Object.prototype.hasOwnProperty.call(draft.planMeta, 'foreignCare')){
          const foreignCareField = document.getElementById('hasForeignCare');
          if(foreignCareField){
            foreignCareField.checked = !!draft.planMeta.foreignCare;
            try{ foreignCareField.dispatchEvent(new Event('change', { bubbles:true })); }catch(err){}
          }
        }
      }
      updateParticipantConflictHint();
      syncSocialPrimary();
      updateConsultVisitText();
      toggleCallDateByConsultVisit();
      toggleDischarge();
      buildSection1();
      buildS2();
      buildS3();
      buildSection4();
      buildLongGoal();
      buildApprovalPlanPreview();
      buildPlanSummaryPreview();
      renderSection1Preview(section1PreviewState.segments || []);
      refreshCheckcols(document);
      scheduleAllMeasurements();
      scheduleSummaryUpdate();
    }

    function scheduleAutoSave(){
      if(isRestoringDraft || !draftLoadComplete) return;
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(()=>{
        autoSaveTimer = null;
        performAutoSave();
      }, AUTO_SAVE_DELAY);
    }

    function performAutoSave(){
      if(isRestoringDraft || !draftLoadComplete) return;
      const snapshot = collectDraftSnapshot();
      if(!snapshot) return;
      if(writeAutoSaveDraft(snapshot)){
        lastSavedTimestamp = snapshot.timestamp;
        scheduleSummaryUpdate();
      }
    }

    function restoreAutoSaveDraft(){
      const draft = readAutoSaveDraft();
      if(!draft) return;
      isRestoringDraft = true;
      try{
        applyDraftSnapshot(draft);
        lastSavedTimestamp = draft.timestamp || null;
      }finally{
        isRestoringDraft = false;
      }
    }

    function handleDraftChangeEvent(){
      if(isRestoringDraft) return;
      scheduleAutoSave();
    }

    function initAutoSave(){
      const host=document.getElementById('appContainer') || document;
      host.addEventListener('input', handleDraftChangeEvent, true);
      host.addEventListener('change', handleDraftChangeEvent, true);
      restoreAutoSaveDraft();
      draftLoadComplete = true;
      scheduleSummaryUpdate();
    }

    function schedulePlanStateSync(options){
      if(!planStateSyncOptions){ planStateSyncOptions = Object.assign({}, options); }
      else if(options){ planStateSyncOptions = Object.assign(planStateSyncOptions, options); }
      Scheduler.enqueue('compute','planSync', runPlanStateSyncJob, 'high');
    }

    function runPlanStateSyncJob(){
      const opts = planStateSyncOptions || {};
      planStateSyncOptions = null;
      syncPlanStateWithSelections(Object.assign({ force:true }, opts));
    }

    function measureFloatingActionsMetrics(){
      const actions=document.getElementById('floatingActions');
      if(!actions){
        pendingFloatingActionsMetrics = { total:0, gap:null };
        return;
      }
      const rect=actions.getBoundingClientRect();
      const visibleHeight=Math.max(0, rect.height || 0);
      let viewportHeight = 0;
      if(typeof window !== 'undefined' && typeof window.innerHeight === 'number'){
        viewportHeight = window.innerHeight;
      }
      const gap=Math.max(16, Math.ceil(Math.max(0, viewportHeight - rect.bottom)));
      const total=Math.max(0, Math.ceil(visibleHeight + gap));
      pendingFloatingActionsMetrics = { total: total, gap: gap };
    }

    function renderFloatingActionsMetrics(){
      if(!pendingFloatingActionsMetrics) return;
      const metrics = pendingFloatingActionsMetrics;
      pendingFloatingActionsMetrics = null;
      if(!document.documentElement) return;
      document.documentElement.style.setProperty('--fab-h', `${metrics.total || 0}px`);
      if(metrics.gap !== null && metrics.gap !== undefined){
        document.documentElement.style.setProperty('--fab-gap', `${metrics.gap}px`);
      }
    }

    function measureStickyLayout(){
      const sticky=document.getElementById('appSticky');
      let offset=0;
      if(sticky){
        const rect=sticky.getBoundingClientRect();
        let marginBottom = 0;
        if(typeof window !== 'undefined' && typeof window.getComputedStyle === 'function'){
          const style=window.getComputedStyle(sticky);
          marginBottom=parseFloat(style.marginBottom) || 0;
        }
        offset=Math.max(0, Math.ceil(rect.height + marginBottom));
      }
      pendingStickyLayoutMetrics = { offset: offset };
    }

    function renderStickyLayout(){
      if(!pendingStickyLayoutMetrics) return;
      const metrics = pendingStickyLayoutMetrics;
      pendingStickyLayoutMetrics = null;
      currentScrollOffset = metrics.offset || 0;
      if(document.documentElement){
        document.documentElement.style.setProperty('--app-top-offset', `${currentScrollOffset}px`);
      }
    }

    function updateVerticalDensityMode(){
      if(!document.body) return;
      let height = 0;
      if(window.visualViewport && typeof window.visualViewport.height === 'number'){
        height = window.visualViewport.height;
      }
      if(!height && typeof window.innerHeight === 'number'){
        height = window.innerHeight;
      }
      const compact = height > 0 && height < 640;
      const nextMode = compact ? 'compact' : '';
      if(currentVerticalDensityMode === nextMode) return;
      currentVerticalDensityMode = nextMode;
      if(compact){
        document.body.dataset.verticalDensity = 'compact';
      }else{
        document.body.removeAttribute('data-vertical-density');
      }
    }

    function scheduleAllMeasurements(){
      UiFrameCoordinator.requestLayout();
    }

    function getSummaryElements(){
      if(summaryElements) return summaryElements;
      summaryElements = {
        root:document.getElementById(SUMMARY_ELEMENT_IDS.root),
        caseName:document.getElementById(SUMMARY_ELEMENT_IDS.caseName),
        cmsLevel:document.getElementById(SUMMARY_ELEMENT_IDS.cmsLevel),
        progressFill:document.getElementById(SUMMARY_ELEMENT_IDS.progressFill),
        progressText:document.getElementById(SUMMARY_ELEMENT_IDS.progressText),
        remainingText:document.getElementById(SUMMARY_ELEMENT_IDS.remainingText)
      };
      return summaryElements;
    }

    function getGlobalProgressState(){
      let totalRequired = 0;
      let totalFilled = 0;
      document.querySelectorAll('[data-section]').forEach(section=>{
        const counts = section && section.__progressCounts ? section.__progressCounts : null;
        if(!counts) return;
        totalRequired += counts.required || 0;
        totalFilled += counts.filled || 0;
      });
      let percent = totalRequired ? Math.round((totalFilled / totalRequired) * 100) : 100;
      if(!Number.isFinite(percent)) percent = 100;
      percent = Math.max(0, Math.min(100, percent));
      return { required: totalRequired, filled: totalFilled, percent };
    }

    function pad2(num){
      return String(num).padStart(2, '0');
    }

    function refreshStickySummary(){
      const els = getSummaryElements();
      if(!els.root) return;
      const nameInput=document.getElementById('caseName');
      const caseNameValue = nameInput ? (nameInput.value || '').trim() : '';
      if(els.caseName) els.caseName.textContent = caseNameValue || '—';
      const cmsLevel = typeof getCmsLevel === 'function' ? (getCmsLevel() || '') : '';
      if(els.cmsLevel) els.cmsLevel.textContent = cmsLevel || '—';
      const progress = getGlobalProgressState();
      const hasRequired = !!(progress.required);
      const remainingCount = hasRequired ? Math.max(0, (progress.required || 0) - (progress.filled || 0)) : 0;
      if(els.progressFill) els.progressFill.style.width = `${progress.percent || 0}%`;
      if(els.progressText){
        if(hasRequired){
          els.progressText.textContent = `已完成 ${progress.filled} / ${progress.required}（${progress.percent}%）`;
        }else if(sectionViewsReady){
          els.progressText.textContent = '無必填欄位';
        }else{
          els.progressText.textContent = '—';
        }
      }
      if(els.remainingText){
        if(hasRequired){
          els.remainingText.textContent = remainingCount > 0 ? `剩餘 ${remainingCount} 項` : '全部完成';
        }else if(sectionViewsReady){
          els.remainingText.textContent = '無必填欄位';
        }else{
          els.remainingText.textContent = '—';
        }
      }
    }

    function scheduleSummaryUpdate(){
      UiFrameCoordinator.requestSummary();
    }

    function scheduleSummaryProgressRender(){
      UiFrameCoordinator.requestSummaryProgress();
    }

    function getSideNavElements(){
      if(!SIDE_NAV_STATE.root){
        SIDE_NAV_STATE.root = document.getElementById('sideNav');
        SIDE_NAV_STATE.list = document.getElementById('sideNavList');
      }
      return SIDE_NAV_STATE;
    }

    function determineProgressStatus(filled, required){
      const req = Number(required) || 0;
      const done = Number(filled) || 0;
      if(req <= 0){
        return done > 0 ? 'complete' : 'optional';
      }
      if(done >= req) return 'complete';
      if(done > 0) return 'partial';
      return 'pending';
    }

    function formatProgressDisplay(filled, required){
      const req = Number(required) || 0;
      const done = Number(filled) || 0;
      if(req <= 0){
        return done > 0 ? `已填 ${done}` : '選填';
      }
      return `${done}/${req}`;
    }

    function formatSideNavCount(filled, required){
      return formatProgressDisplay(filled, required);
    }

    function scrollToAnchorId(anchorId, options){
      if(!anchorId) return;
      const anchor = document.getElementById(anchorId);
      if(!anchor) return;
      const rect = anchor.getBoundingClientRect();
      const offset = Math.max(0, currentScrollOffset || 0);
      const nextTop = rect.top + window.pageYOffset - offset + 4;
      window.scrollTo({ top: Math.max(0, nextTop), behavior: options && options.instant ? 'auto' : 'smooth' });
    }

    function focusSectionGroupByElement(target){
      if(!target) return;
      let groupElement = null;
      let section = null;
      let targetGroup = null;
      if(target.classList && target.classList.contains('section-group')){
        groupElement = target;
      }else{
        const anchorId = target.id || '';
        if(anchorId){
          const meta = getHeadingGroup(anchorId);
          if(meta && meta.group && meta.group.element){
            section = meta.section || meta.group.element.closest('[data-section]');
            targetGroup = meta.group;
            groupElement = meta.group.element;
          }
        }
        if(!groupElement && target.closest){
          groupElement = target.closest('.section-group');
        }
      }
      if(!groupElement){
        return;
      }
      if(!section){
        section = groupElement.closest('[data-section]');
      }
      if(!section || !section.__groups){
        return;
      }
      if(!targetGroup){
        (section.__groups || []).forEach(group=>{
          if(group && group.element === groupElement){
            targetGroup = group;
          }
        });
      }
      if(!targetGroup){
        return;
      }
      (section.__groups || []).forEach(group=>{
        if(!group) return;
        const collapse = group !== targetGroup;
        setGroupCollapsed(section, group, collapse, { save:false });
      });
      updateToggleButtons(section);
      updateAllGroupEmptyStates(section);
      scheduleSideNavRender();
      if(section.__state && section.dataset && section.dataset.section){
        writeSectionState(section.dataset.section, section.__state);
      }
      updateSideNavForSection(section);
    }

    function handleSideNavClick(event){
      const target=event && event.currentTarget ? event.currentTarget : null;
      if(!target) return;
      const anchorId = target.dataset ? target.dataset.target : '';
      if(!anchorId) return;
      const pageId = target.dataset ? target.dataset.page : '';
      const anchorEl=document.getElementById(anchorId);
      if(anchorEl){
        if(blockIfPlanGroupLocked(anchorEl)) return;
        const step = resolveWizardStepForElement(anchorEl);
        if(step && isWizardStepLocked(step)){
          handleWizardStepLocked(step);
          return;
        }
        const performScroll = ()=>{
          focusSectionGroupByElement(anchorEl);
          if(step) updateWizardVisual(step);
          scrollToAnchorId(anchorId);
        };
        if(pageId && pageId !== currentPageId){
          if(setActivePage(pageId, { step: step }) === false){
            return;
          }
          window.requestAnimationFrame(performScroll);
        }else{
          performScroll();
        }
      }else if(pageId && pageId !== currentPageId){
        if(setActivePage(pageId) !== false){
          window.requestAnimationFrame(()=>scrollToAnchorId(anchorId));
        }
      }
      if(isSideNavOverlayMode()){
        closeSideNav({ force:true });
      }
    }

    function renderSideNav(){
      const state = getSideNavElements();
      if(!state.root || !state.list) return;
      state.list.innerHTML='';
      const activePage = currentPageId || '';
      state.root.dataset.page = activePage;
      if(state.items && state.items.length){
        state.items.forEach(item=>{
          if(!item) return;
          item.element = null;
          item.button = null;
          item.countEl = null;
        });
      }
      const visibleItems = (state.items || []).filter(item=>{
        if(!item) return false;
        if(!item.pageId || !activePage) return true;
        return item.pageId === activePage;
      });
      syncSideNavToggleAvailability(visibleItems.length > 0);
      if(!visibleItems.length){
        state.root.dataset.empty = '1';
        return;
      }
      state.root.dataset.empty = '0';
      visibleItems.forEach(item=>{
        const li=document.createElement('li');
        li.className='side-nav-item';
        li.dataset.page = item.pageId || '';
        li.dataset.level = String(item.level || 2);
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='side-nav-link';
        btn.textContent=item.label || '未命名群組';
        btn.dataset.target=item.anchorId || '';
        btn.dataset.page=item.pageId || '';
        btn.dataset.level = String(item.level || 2);
        btn.addEventListener('click', handleSideNavClick);
        const count=document.createElement('span');
        count.className='side-nav-count';
        const stats=item.stats || { filled:0, required:0 };
        const status=item.status || determineProgressStatus(stats.filled || 0, stats.required || 0);
        item.status = status;
        count.textContent = formatSideNavCount(stats.filled || 0, stats.required || 0);
        li.dataset.status = status;
        btn.dataset.status = status;
        li.appendChild(btn);
        li.appendChild(count);
        state.list.appendChild(li);
        item.element = li;
        item.button = btn;
        item.countEl = count;
      });
      scheduleAllMeasurements();
    }

    function getWizardJumpSelect(){
      if(WIZARD_JUMP_STATE.select) return WIZARD_JUMP_STATE.select;
      const select=document.getElementById('wizardJumpSelect');
      if(select){
        WIZARD_JUMP_STATE.select = select;
        select.addEventListener('change', handleWizardJumpChange);
      }
      return WIZARD_JUMP_STATE.select;
    }

    function refreshWizardJumpOptions(){
      const select = getWizardJumpSelect();
      if(!select) return;
      const previous = select.value;
      select.innerHTML='';
      const placeholder=document.createElement('option');
      placeholder.value='';
      placeholder.textContent='選擇階段';
      select.appendChild(placeholder);
      wizardStepsMeta.forEach(meta=>{
        if(!meta) return;
        const option=document.createElement('option');
        option.value=String(meta.step);
        option.textContent=meta.element ? (meta.element.querySelector('.wizard-label')?.textContent || `步驟 ${meta.step}`) : `步驟 ${meta.step}`;
        select.appendChild(option);
      });
      if(previous && wizardStepLookup[Number(previous)]){
        select.value=previous;
      }else{
        select.value='';
      }
    }

    function handleWizardJumpChange(event){
      const select = event && event.target ? event.target : getWizardJumpSelect();
      if(!select) return;
      const step = Number(select.value);
      if(step){
        if(isWizardStepLocked(step)){
          handleWizardStepLocked(step);
        }else{
          setCurrentWizardStep(step, { focus:true });
        }
      }
      select.value='';
      if(typeof select.blur === 'function'){ select.blur(); }
    }

    function scheduleSideNavRender(){
      UiFrameCoordinator.requestSideNav();
    }

    function registerSideNavGroups(){
      const state = getSideNavElements();
      if(!state.root || !state.list) return;
      const items=[];
      forEachHeading(function(entry){
        if(!entry || entry.level <= 1) return;
        const anchorEl=document.getElementById(entry.id);
        if(!anchorEl) return;
        const groupMeta=getHeadingGroup(entry.id);
        const section = groupMeta ? groupMeta.section : null;
        const group = groupMeta ? groupMeta.group : null;
        const sectionId = section && section.dataset ? section.dataset.section || '' : '';
        const stats = (section && group && section.__groupStats && section.__groupStats[group.id])
          ? section.__groupStats[group.id]
          : { filled:0, required:0 };
        const status = group
          ? determineProgressStatus(stats.filled || 0, stats.required || 0)
          : (stats.required > 0 ? determineProgressStatus(stats.filled || 0, stats.required || 0) : 'optional');
        const item = {
          sectionId: sectionId,
          pageId: entry.page || '',
          groupId: group ? group.id : '',
          anchorId: entry.id,
          headingId: entry.id,
          label: entry.label || '',
          level: entry.level || 2,
          stats: { filled: stats.filled || 0, required: stats.required || 0 },
          status: status,
          element:null,
          button:null,
          countEl:null
        };
        if(group){
          group.navItem = item;
        }
        items.push(item);
      });
      state.items = items;
      scheduleSideNavRender();
    }

    function updateSideNavForSection(section){
      if(!section) return;
      const state = getSideNavElements();
      if(!state.items.length) return;
      if(!section.__headingGroupMap) return;
      Object.keys(section.__headingGroupMap).forEach(anchorId=>{
        const group = section.__headingGroupMap[anchorId];
        if(!group) return;
        const navItem = group.navItem;
        if(!navItem) return;
        const stats = section.__groupStats && group.id ? section.__groupStats[group.id] : { filled:0, required:0 };
        const status = determineProgressStatus(stats.filled || 0, stats.required || 0);
        navItem.stats = { filled: stats.filled || 0, required: stats.required || 0 };
        navItem.status = status;
        if(navItem.countEl){
          navItem.countEl.textContent = formatSideNavCount(navItem.stats.filled, navItem.stats.required);
        }
        if(navItem.element){
          navItem.element.dataset.status = status;
        }
        if(navItem.button){
          if(group.toggle){
            const text = (group.toggle.textContent || '').trim();
            if(text){
              navItem.label = text;
              navItem.button.textContent = text;
            }
          }
          navItem.button.dataset.status = status;
        }
      });
    }

    const CHECKCOL_PRIORITY_MAP = {
      s1_vision_note_box:['配戴眼鏡','老花','白內障術後','單眼視力不佳'],
      s1_lang_box:['國語','台語','客語'],
      s1_swallow_sx_box:['嗆咳','吞嚥延遲','殘留'],
      s1_diet_texture_box:['一般','軟質','碎食','泥狀'],
      s1_feeding_tube_box:['鼻胃管（NGT）','胃造口（PEG）'],
      s1_oral_box:['自然牙完整','缺牙','口腔衛生不佳','口乾'],
      s1_lesion_sx_box:['無不適','疼痛','紅腫','出血'],
      s1_balance_box:['站立不穩','頭暈','TUG>12s'],
      s1_sitting_support_box:['需安全帶','需托盤／擋板','坐墊／防滑具'],
      s1_excretion_aids_box:['紙尿褲','便盆椅','留置導尿管','間歇導尿管'],
      s1_phone_note_box:['易受詐騙','重聽需擴音'],
      s1_emotion_box:['情緒穩定','焦慮','憂鬱','易怒'],
      s1_behavior_box:['遊走','日夜顛倒','重複行為','妄想'],
      s1_devices_box:['鼻胃管','胃造口管（PEG）','氣切管','氧氣機'],
      s1_dhx_box:['高血壓','糖尿病','心臟病','腦中風','失智症'],
      s1_med_classes_box:['降壓藥','降脂藥','抗血栓／抗凝','降血糖／胰島素','利尿劑','睡眠用藥'],
      s2_sources:['子女/親屬支持','退休金（軍公教/勞退）','勞保/農保年金','老人福利津貼'],
      s3_fac:['扶手','止滑','斜坡'],
      s3_aids:['輪椅','助行器','拐杖','照顧床'],
      sp_formal:['居家服務','日間照顧','專業服務','喘息服務','交通接送','營養送餐','無障礙及輔具'],
      sp_risks:['被照顧者嚴重情緒/干擾行為','高齡照顧者','沒有照顧替手','資源不符/變動或突發緊急需求'],
      mismatch_reason_box:['身體狀況','資源限制','個案意願','經濟考量','其他']
    };

    function findCheckcolLegendSource(element){
      let current = element;
      while(current){
        let prev = current.previousElementSibling;
        while(prev){
          if(prev.matches && prev.matches('label, .h1, .h2, .h3, .h4, .h5, .h6')){
            return prev;
          }
          prev = prev.previousElementSibling;
        }
        current = current.parentElement;
      }
      return null;
    }

    function deriveCheckcolLegend(element){
      if(!element) return '';
      if(element.dataset && element.dataset.legend){
        return element.dataset.legend.trim();
      }
      const ariaLabel = element.getAttribute ? element.getAttribute('aria-label') : '';
      if(ariaLabel){
        return ariaLabel.trim();
      }
      const source = findCheckcolLegendSource(element);
      if(source){
        return (source.textContent || '').replace(/\s+/g, ' ').trim();
      }
      return '選項';
    }

    function ensureCheckcolFieldset(element){
      if(!element) return null;
      let target = element;
      const legendText = deriveCheckcolLegend(element);
      if(element.tagName !== 'FIELDSET'){
        const fieldset = document.createElement('fieldset');
        Array.prototype.slice.call(element.attributes).forEach(attr=>{
          fieldset.setAttribute(attr.name, attr.value);
        });
        while(element.firstChild){
          fieldset.appendChild(element.firstChild);
        }
        if(element.parentNode){
          element.parentNode.replaceChild(fieldset, element);
        }
        target = fieldset;
      }
      if(legendText){
        let legend = null;
        let child = target.firstElementChild;
        while(child){
          if(child.tagName === 'LEGEND' && child.classList.contains('checkcol-legend')){
            legend = child;
            break;
          }
          child = child.nextElementSibling;
        }
        if(!legend){
          legend = document.createElement('legend');
          legend.className = 'sr-only checkcol-legend';
          target.insertBefore(legend, target.firstChild || null);
        }
        legend.textContent = legendText;
      }
      return target;
    }

    function getCheckcolLabelValue(label){
      if(!label) return '';
      const input = label.querySelector('input[type=checkbox]');
      if(input && input.value !== undefined) return String(input.value).trim();
      return label.textContent.trim();
    }

    function applyCheckcolPriority(box){
      if(!box) return;
      const id = box.id || '';
      const priorities = CHECKCOL_PRIORITY_MAP[id];
      if(!priorities || !priorities.length) return;
      const labels = Array.from(box.querySelectorAll('label'));
      if(!labels.length) return;
      const orderMap = new Map();
      priorities.forEach((value,index)=>{ orderMap.set(String(value), index); });
      labels.sort((a,b)=>{
        const aValue = getCheckcolLabelValue(a);
        const bValue = getCheckcolLabelValue(b);
        const aOrder = orderMap.has(aValue) ? orderMap.get(aValue) : Infinity;
        const bOrder = orderMap.has(bValue) ? orderMap.get(bValue) : Infinity;
        if(aOrder !== bOrder) return aOrder - bOrder;
        const aOther = /其他/.test(aValue) ? 1 : 0;
        const bOther = /其他/.test(bValue) ? 1 : 0;
        if(aOther !== bOther) return aOther - bOther;
        return aValue.localeCompare(bValue, 'zh-Hant');
      });
      labels.forEach(label=>box.appendChild(label));
    }

    function updateCheckcolEnhancements(box){
      if(!box || !box.__checkcolState) return;
      const labels = Array.from(box.querySelectorAll('label'));
      let hasChecked = false;
      labels.forEach(label=>{
        const input = label.querySelector('input[type=checkbox]');
        const checked = !!(input && input.checked);
        if(checked){
          label.setAttribute('data-checked', '1');
          hasChecked = true;
        }else{
          label.removeAttribute('data-checked');
        }
      });
      const audit = getUiAuditState();
      if(audit && labels.length){
        audit.checkcol_highlight_exists = true;
      }
    }

    function updateSectionSelectionSummary(box){
      if(!box || !box.__checkcolState) return;
      const wrapper = box.__checkcolState.wrapper;
      if(!wrapper) return;
      const section = wrapper.closest('[data-section]') || box.closest('[data-section]');
      if(!section) return;
      const badge = ensureSectionSelectionBadge(section);
      if(!badge) return;
      let total = 0;
      section.querySelectorAll('.checkcol-wrapper').forEach(node=>{
        total += Number(node.dataset.selectedCount || 0);
      });
      if(total > 0){
        badge.textContent = `本區已選（${total}）`;
        badge.dataset.hidden = '0';
      }else{
        badge.textContent = '';
        badge.dataset.hidden = '1';
      }
    }

    function enhanceCheckcol(box){
      if(!box) return;
      box = ensureCheckcolFieldset(box);
      if(!box || box.__checkcolState) return;
      const wrapper=document.createElement('div');
      wrapper.className='checkcol-wrapper';
      const parent = box.parentNode;
      if(parent){ parent.insertBefore(wrapper, box); }
      wrapper.appendChild(box);
      box.__checkcolState = { wrapper };
      box.dataset.checkcolEnhanced = '1';
      box.addEventListener('change', ()=>updateCheckcolEnhancements(box));
      box.addEventListener('input', ()=>updateCheckcolEnhancements(box));
      applyCheckcolPriority(box);
      updateCheckcolEnhancements(box);
    }

    function refreshCheckcol(target){
      let box = typeof target === 'string' ? document.getElementById(target) : target;
      if(!box) return;
      box = ensureCheckcolFieldset(box);
      if(!box || box.dataset.virtualChecklist === '1') return;
      if(!box.__checkcolState){
        enhanceCheckcol(box);
      }else{
        applyCheckcolPriority(box);
        updateCheckcolEnhancements(box);
      }
    }

    function refreshCheckcols(scope){
      const root = typeof scope === 'string' ? document.getElementById(scope) : (scope || document);
      if(!root) return;
      root.querySelectorAll('.checkcol').forEach(el=>refreshCheckcol(el));
    }

    function isCoarsePointer(){
      if(typeof window === 'undefined' || typeof window.matchMedia !== 'function') return false;
      try{ return window.matchMedia('(pointer: coarse)').matches; }catch(err){ return false; }
    }

    function isMobileViewport(){
      if(typeof window === 'undefined' || typeof window.matchMedia !== 'function') return false;
      try{ return window.matchMedia('(max-width: 1279px)').matches; }catch(err){ return false; }
    }

    function shouldUseMobileDefaults(){
      return isCoarsePointer() || isMobileViewport();
    }

    function ensureElementId(el, prefix){
      if(!el) return '';
      if(el.id) return el.id;
      let base = prefix || 'el';
      base = String(base);
      if(!base){
        base = 'el';
      }
      base = base.replace(/[^a-zA-Z0-9_-]/g, '_');
      if(!base){
        base = 'el';
      }
      let candidate = base;
      let counter = 1;
      while(document.getElementById(candidate)){
        candidate = `${base}_${counter++}`;
      }
      el.id = candidate;
      return candidate;
    }

    function updateFontScaleButtons(active){
      const control=document.getElementById('fontScaleControl');
      if(!control) return;
      const normalizedActive = normalizeFontScale(active) || FONT_SCALE_DEFAULT;
      control.querySelectorAll('button[data-scale]').forEach(btn=>{
        const isActive=btn.dataset.scale === normalizedActive;
        btn.dataset.active = isActive ? '1' : '0';
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    function applyFontScale(scale, options){
      const normalized = normalizeFontScale(scale) || FONT_SCALE_DEFAULT;
      if(document.body){
        document.body.dataset.fontscale = normalized;
      }
      if(!(options && options.skipSave) && window.localStorage){
        try{ window.localStorage.setItem(FONT_SCALE_STORAGE_KEY, normalized); }catch(err){}
      }
      updateFontScaleButtons(normalized);
      scheduleAllMeasurements();
    }

    function setSectionHideFilled(section, hide, options){
      if(!section) return;
      const state = section.__state || (section.__state = readSectionState(section.dataset.section));
      const target = hide ? '1' : '0';
      if(section.dataset.hideFilled === target && !!state.hideFilled === !!hide) return;
      state.hideFilled = !!hide;
      section.dataset.hideFilled = target;
      updateToggleButtons(section);
      updateAllGroupEmptyStates(section);
      updateSectionProgress(section);
      if(!(options && options.persist === false)){
        writeSectionState(section.dataset.section, state);
      }
    }

    function setSectionShowAdvanced(section, show, options){
      if(!section) return;
      const state = section.__state || (section.__state = readSectionState(section.dataset.section));
      const target = show ? '1' : '0';
      if(section.dataset.showAdvanced === target && !!state.showAdvanced === !!show) return;
      state.showAdvanced = !!show;
      section.dataset.showAdvanced = target;
      updateToggleButtons(section);
      updateAllGroupEmptyStates(section);
      updateSectionProgress(section);
      if(!(options && options.persist === false)){
        writeSectionState(section.dataset.section, state);
      }
    }

    function setSectionCollapseStrategy(section, strategy, options){
      if(!section) return;
      const state = section.__state || (section.__state = readSectionState(section.dataset.section));
      const groups = section.__groups || [];
      if(!groups.length) return;
      let firstBasicSeen = false;
      groups.forEach(group=>{
        let collapse = false;
        const level = determineGroupLevel(group);
        if(strategy === 'focus'){
          if(level === 'advanced'){
            collapse = true;
          }else{
            if(!firstBasicSeen){
              firstBasicSeen = true;
            }else{
              collapse = true;
            }
          }
        }else if(strategy === 'expand'){
          collapse = false;
        }else if(strategy === 'advanced'){
          collapse = level === 'advanced';
        }
        setGroupCollapsed(section, group, collapse, { save:false });
      });
      updateToggleButtons(section);
      updateAllGroupEmptyStates(section);
      updateSectionProgress(section);
      if(!(options && options.persist === false)){
        writeSectionState(section.dataset.section, state);
      }
    }

    function applyInitialUiPreferences(){
      let storedScale = null;
      if(window.localStorage){
        try{ storedScale = window.localStorage.getItem(FONT_SCALE_STORAGE_KEY); }catch(err){}
      }
      const normalizedStoredScale = normalizeFontScale(storedScale);
      if(normalizedStoredScale){
        applyFontScale(normalizedStoredScale, { skipSave:true });
      }else if(shouldUseMobileDefaults()){
        applyFontScale('xl', { skipSave:true });
      }else{
        applyFontScale(FONT_SCALE_DEFAULT, { skipSave:true });
      }
    }

    function initFontScaleControls(){
      const control=document.getElementById('fontScaleControl');
      if(!control) return;
      control.querySelectorAll('button[data-scale]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ applyFontScale(btn.dataset.scale); });
      });
      const active = document.body && document.body.dataset.fontscale ? document.body.dataset.fontscale : FONT_SCALE_DEFAULT;
      updateFontScaleButtons(active);
    }

    /* ===== 日期工具 ===== */
    function toYMD(d){const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2);return `${y}-${m}-${da}`;}
    function parseDateInput(value){
      if(!value) return null;
      const parts=String(value).split('-');
      if(parts.length!==3) return null;
      const y=Number(parts[0]), m=Number(parts[1]), da=Number(parts[2]);
      if(!y || !m || !da) return null;
      const date=new Date(y, m-1, da);
      if(Number.isNaN(date.getTime())) return null;
      return date;
    }
    function setDateBox(id,d){
      if(!(d instanceof Date) || Number.isNaN(d.getTime())) return;
      const text=toYMD(d);
      const input=document.getElementById(id);
      if(input) input.value=text;
    }
    function getDateBox(id){
      const input=document.getElementById(id);
      return input && input.value ? input.value : '';
    }
    function shiftDate(id,delta){
      const cur=getDateBox(id);
      const base=cur?parseDateInput(cur):new Date();
      if(!base) return;
      base.setDate(base.getDate()+delta);
      setDateBox(id,base);
    }
    function attachDateInputEvents(id){
      const input=document.getElementById(id);
      if(!input) return;
      input.setAttribute('title','↑/↓ 調整 ±1 天');
      input.addEventListener('keydown', ev=>{
        if(ev.key==='ArrowUp' || ev.key==='ArrowDown'){
          const delta = ev.key==='ArrowUp' ? 1 : -1;
          shiftDate(id, delta);
          ev.preventDefault();
        }
      });
    }
    function initDateInputs(){
      ['callDate','visitDate','dischargeDate'].forEach(attachDateInputEvents);
    }
    function toggleDischarge(){const on=document.getElementById('isDischarge').checked; document.getElementById('dischargeBox').style.display=on?'':'none'; if(on&&!getDateBox('dischargeDate')) setDateBox('dischargeDate', new Date());}
    function updateConsultVisitText(){
      const box=document.getElementById('consultVisitText');
      if(!box) return;
      const caseName=(document.getElementById('caseName').value||'').trim();
      const consultName=(document.getElementById('consultName').value||'').trim();
      const caseDisplay=caseName||'未填個案姓名';
      const consultDisplay=consultName||'未選擇照專';
      box.textContent=`本案(${caseDisplay}) 由照顧專員(${consultDisplay})進行約訪`;
    }
    function toggleCallDateByConsultVisit(){
      const input=document.getElementById('isConsultVisit');
      const controls=document.getElementById('callDateControls');
      const box=document.getElementById('consultVisitText');
      if(!input) return;
      const on=input.checked;
      if(controls) controls.style.display=on?'none':'';
      if(box){
        if(on){
          updateConsultVisitText();
          box.style.display='';
        }else{
          box.style.display='none';
        }
      }
    }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, function(ch){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch] || ch;
      });
    }
    function renderOutputMessage(res){
      const box=document.getElementById('msg');
      if(!box) return;
      if(res && res.file && res.file.url){
        const messageText = res && res.message ? escapeHtml(res.message) : '已建立新檔';
        const safeUrl = escapeHtml(res.file.url);
        const safeName = escapeHtml(res.file.name || '新文件');
        box.innerHTML = `${messageText} → <a href="${safeUrl}" target="_blank" rel="noopener">${safeName}</a> <button type="button" class="small" data-url="${safeUrl}" onclick="openProducedFile(this.dataset.url)">開啟</button>`;
      }else{
        box.textContent = res && res.message ? res.message : '';
      }
    }
    function openProducedFile(url){
      if(!url) return;
      const opened = window.open(url, '_blank');
      if(opened){ opened.opener = null; }
    }
    function nl2br(str){
      if(!str) return '';
      return escapeHtml(str).replace(/\n/g,'<br>');
    }

    let wizardStepsMeta = [];
    let wizardStepLookup = {};
    let currentWizardStep = null;
    const TAB_STATUS_PRIORITY = { todo:0, done:1, active:2 };
    const WIZARD_JUMP_STATE = { select:null };


    /* ===== 段落視圖（分層/收合/進度） ===== */
    const SECTION_STORAGE_PREFIX = 'AA01.section.state.';
    const SECTION_DEFAULT_TEMPLATE = { hideFilled:false, showAdvanced:false, collapsedGroups:{} };

    function getSectionDefaultState(){
      return {
        hideFilled: shouldUseMobileDefaults(),
        showAdvanced:false,
        collapsedGroups:{}
      };
    }

    function readSectionState(sectionId){
      const defaults = getSectionDefaultState();
      if(!sectionId || typeof window === 'undefined' || !window.localStorage){
        defaults.__persisted = false;
        return defaults;
      }
      try{
        const raw = window.localStorage.getItem(SECTION_STORAGE_PREFIX + sectionId);
        if(!raw){
          defaults.__persisted = false;
          return defaults;
        }
        const parsed = JSON.parse(raw);
        return {
          hideFilled: !!(parsed && parsed.hideFilled),
          showAdvanced: !!(parsed && parsed.showAdvanced),
          collapsedGroups: parsed && parsed.collapsedGroups && typeof parsed.collapsedGroups === 'object' ? parsed.collapsedGroups : {},
          __persisted: true
        };
      }catch(err){
        defaults.__persisted = false;
        return defaults;
      }
    }

    function writeSectionState(sectionId, state){
      if(!sectionId || typeof window === 'undefined' || !window.localStorage) return;
      try{
        const payload = {
          hideFilled: !!(state && state.hideFilled),
          showAdvanced: !!(state && state.showAdvanced),
          collapsedGroups: state && state.collapsedGroups && typeof state.collapsedGroups === 'object' ? state.collapsedGroups : {}
        };
        window.localStorage.setItem(SECTION_STORAGE_PREFIX + sectionId, JSON.stringify(payload));
        if(state) state.__persisted = true;
      }catch(err){}
    }

    function isOptionalText(text){
      if(!text) return false;
      return /選填|非必填|可選|選擇性/.test(String(text));
    }

    function isInlineHidden(element, stop){
      let node = element;
      while(node && node !== stop){
        if(node.style && (node.style.display === 'none' || node.style.visibility === 'hidden')) return true;
        node = node.parentElement;
      }
      if(stop && stop.style && (stop.style.display === 'none' || stop.style.visibility === 'hidden')) return true;
      return false;
    }

    function determineGroupLevel(group){
      if(!group) return 'basic';
      if(group.element && group.element.dataset.level) return group.element.dataset.level;
      if(group.body){
        const first = group.body.firstElementChild;
        if(first && first.dataset && first.dataset.level) return first.dataset.level;
      }
      return 'basic';
    }

    function extractGroupTitleFromNode(node){
      if(!node) return '';
      if(node.dataset){
        const datasetTitle = (node.dataset.title || node.dataset.cardTitle || '').trim();
        if(datasetTitle) return datasetTitle;
      }
      const children = Array.from(node.children || []);
      for(let i=0;i<children.length;i++){
        const child = children[i];
        if(!child) continue;
        if(child.dataset){
          const childTitle = (child.dataset.title || child.dataset.cardTitle || '').trim();
          if(childTitle) return childTitle;
        }
        if(child.classList && child.classList.contains('titlebar')){
          const label = child.querySelector('.h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6, label, span');
          const text = label && label.textContent ? label.textContent.trim() : '';
          if(text) return text;
        }
        if(child.classList && child.classList.contains('group-header')){
          const heading = child.querySelector('.h1, .h2, .h3, .h4, h1, h2, h3, h4, label, span');
          const text = heading && heading.textContent ? heading.textContent.trim() : '';
          if(text) return text;
        }
        if(child.tagName && /^H[1-6]$/.test(child.tagName)){
          const text = child.textContent ? child.textContent.trim() : '';
          if(text) return text;
        }
        if(child.classList && (child.classList.contains('h1') || child.classList.contains('h2') || child.classList.contains('h3') || child.classList.contains('h4') || child.classList.contains('h5') || child.classList.contains('h6'))){
          const text = child.textContent ? child.textContent.trim() : '';
          if(text) return text;
        }
        if(child.classList && (child.classList.contains('section-card') || child.classList.contains('section-card-grid') || child.classList.contains('group'))){
          const nested = extractGroupTitleFromNode(child);
          if(nested) return nested;
        }
      }
      return '';
    }

    function updateGroupTitle(group){
      if(!group || !group.toggle) return;
      const body = group.body;
      let title = group.title || '';
      if(!title && body){
        title = extractGroupTitleFromNode(body);
      }
      if(!title && body){
        const label = body.querySelector('label');
        if(label && label.textContent){
          title = label.textContent.trim();
        }
      }
      if(!title) title = `群組 ${group.id || ''}`.trim();
      group.title = title;
      if(group.element){
        group.element.dataset.title = title;
      }
      group.toggle.textContent = title;
      if(group.navItem){
        group.navItem.label = title;
        if(group.navItem.button){
          group.navItem.button.textContent = title;
        }
      }
    }

    function buildSectionGroups(section){
      const groups = [];
      if(!section) return groups;
      const sectionKey = section.dataset && section.dataset.section ? section.dataset.section : 'section';
      const sectionId = ensureElementId(section, `section_${sectionKey}`);
      const children = Array.from(section.children);
      if(!children.length) return groups;
      const mainTitle = children.find(child => child.classList && child.classList.contains('titlebar'));
      const startIndex = mainTitle ? (children.indexOf(mainTitle) + 1) : 0;
      let current = null;
      let counter = 0;
      for(let i=startIndex; i<children.length; i++){
        const node = children[i];
        if(!node) continue;
        if(node.classList && node.classList.contains('section-progress')) continue;
        if(node.dataset && node.dataset.groupIgnore === '1') continue;
        const isTitlebar = node.classList && node.classList.contains('titlebar');
        if(!current || isTitlebar){
          const wrapper = document.createElement('div');
          wrapper.className = 'section-group';
          const groupId = String(++counter);
          wrapper.dataset.groupId = groupId;
          wrapper.dataset.collapsed = '0';
          const header = document.createElement('div');
          header.className = 'section-group-header';
          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.className = 'section-group-toggle';
          toggle.setAttribute('aria-expanded', 'true');
          toggle.textContent = '';
          header.appendChild(toggle);
          const progress = document.createElement('span');
          progress.className = 'section-group-progress';
          progress.textContent = '—';
          header.appendChild(progress);
          const body = document.createElement('div');
          body.className = 'section-group-body';
          const bodyId = ensureElementId(body, `${sectionId}_group_${groupId}`);
          toggle.setAttribute('aria-controls', bodyId);
          const empty = document.createElement('div');
          empty.className = 'section-group-empty';
          empty.textContent = '此群組皆已完成';
          body.appendChild(empty);
          wrapper.appendChild(header);
          wrapper.appendChild(body);
          section.insertBefore(wrapper, node);
          current = { element: wrapper, header, toggle, body, empty, progress, id: groupId, title:'' };
          groups.push(current);
        }
        if(isTitlebar){
          let anchorId='';
          let headingEl=node.querySelector('#' + (node.dataset && node.dataset.anchor ? node.dataset.anchor : '')) || node.querySelector('h1, h2, h3, h4, h5, h6');
          if(headingEl){
            anchorId = headingEl.id || headingEl.dataset.anchor || '';
            if(!anchorId){
              anchorId = (headingEl.textContent || '').trim();
            }
            if(!headingEl.dataset.anchor) headingEl.dataset.anchor = anchorId;
            if(anchorId && !headingEl.id) headingEl.id = anchorId;
            if(headingEl.parentNode && headingEl.parentNode !== node){
              headingEl.parentNode.removeChild(headingEl);
            }else if(headingEl.parentNode === node){
              node.removeChild(headingEl);
            }
          }
          const remainingNodes = Array.from(node.childNodes);
          remainingNodes.forEach(child=>node.removeChild(child));
          if(current){
            if(!current.title){
              const labelText = headingEl ? (headingEl.textContent || '').trim() : (node.textContent || '').trim();
              if(labelText){
                current.title = labelText;
                if(current.element && current.element.dataset) current.element.dataset.title = labelText;
              }
            }
            const emptyMarker = current.empty || current.body.querySelector('.section-group-empty');
            if(headingEl){
              current.body.insertBefore(headingEl, emptyMarker);
            }
            if(remainingNodes.length){
              const fragment=document.createDocumentFragment();
              remainingNodes.forEach(child=>{
                if(child.nodeType===1 && child.tagName && child.tagName.toLowerCase()==='label' && !child.children.length){
                  return;
                }
                fragment.appendChild(child);
              });
              if(fragment.childNodes.length){
                const ref = headingEl ? headingEl.nextSibling : emptyMarker;
                current.body.insertBefore(fragment, ref);
              }
            }
          }
          if(anchorId && current){
            current.element.dataset.headingId = anchorId;
            registerHeadingGroup(anchorId, section, current);
          }
          if(node.parentNode) node.parentNode.removeChild(node);
          continue;
        }
        if(current && current.body){
          current.body.appendChild(node);
        }
      }
      groups.forEach(group=>{
        updateGroupTitle(group);
        group.element.dataset.level = determineGroupLevel(group);
        group.element.dataset.status = group.element.dataset.status || 'pending';
        if(group.progress){
          group.progress.textContent = group.progress.textContent || '—';
        }
      });
      return groups;
    }

    function isContainerVisible(section, container){
      if(!container || container.dataset.fieldContainer !== '1') return false;
      if(section){
        if(section.dataset.showAdvanced === '0' && container.dataset.level === 'advanced') return false;
        if(section.dataset.hideFilled === '1' && container.dataset.filled === '1') return false;
        const parentGroup = container.closest('.section-group');
        if(parentGroup && parentGroup.dataset.level === 'advanced' && section.dataset.showAdvanced === '0') return false;
        if(parentGroup && parentGroup.dataset.collapsed === '1') return false;
      }
      const style = window.getComputedStyle(container);
      if(style.display === 'none' || style.visibility === 'hidden') return false;
      return true;
    }

    function updateGroupEmptyState(section, group){
      if(!group || !group.body) return;
      const containers = group.body.querySelectorAll('[data-field-container]');
      let hasVisible = false;
      containers.forEach(container=>{
        if(isContainerVisible(section, container)) hasVisible = true;
      });
      const hideFilled = section && section.dataset ? section.dataset.hideFilled === '1' : false;
      const status = group.element && group.element.dataset ? group.element.dataset.status : '';
      const showEmpty = !hasVisible && hideFilled && status === 'complete';
      group.element.dataset.empty = showEmpty ? '1' : '0';
    }

    function updateAllGroupEmptyStates(section){
      if(!section || !section.__groups) return;
      section.__groups.forEach(group=>updateGroupEmptyState(section, group));
    }

    function setGroupCollapsed(section, group, collapsed, opts){
      if(!group || !group.element) return;
      const target = collapsed ? '1' : '0';
      group.element.dataset.collapsed = target;
      if(group.toggle) group.toggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      if(section && section.__state){
        const state = section.__state;
        state.collapsedGroups = state.collapsedGroups || {};
        if(collapsed){
          state.collapsedGroups[group.id] = true;
        }else{
          delete state.collapsedGroups[group.id];
        }
        if(!opts || opts.save !== false){
          writeSectionState(section.dataset.section, state);
        }
      }
    }

    function isFieldEligible(field){
      if(!field) return false;
      if(field.type === 'hidden') return false;
      if(field.dataset && field.dataset.progressIgnore === '1') return false;
      if(field.closest('[data-progress-ignore="1"]')) return false;
      if(field.id && /^section\d+_(out|struct)$/.test(field.id)) return false;
      return true;
    }

    function getContainerForField(field, body){
      let el = field;
      while(el && el.parentElement !== body){
        el = el.parentElement;
      }
      return el || field;
    }

    function determineFillMode(container){
      const fields = container.__fields || [];
      if(!fields.length) return 'all';
      const checkable = fields.filter(field=>field.type === 'checkbox' || field.type === 'radio');
      if(checkable.length && checkable.length === fields.length) return 'any';
      return 'all';
    }

    function detectContainerBaseRequired(container){
      if(!container) return false;
      const explicit = container.getAttribute && container.getAttribute('data-required');
      if(explicit === '0') return false;
      if(explicit === '1') return true;
      if(container.dataset && container.dataset.level === 'advanced') return false;
      if(container.dataset && container.dataset.optional === '1') return false;
      const label = container.querySelector && container.querySelector('label');
      if(label && isOptionalText(label.textContent)) return false;
      const fields = container.__fields || [];
      for(let i=0; i<fields.length; i++){
        const field = fields[i];
        const placeholder = field.getAttribute && field.getAttribute('placeholder');
        if(isOptionalText(placeholder) || field.dataset.optional === '1') return false;
      }
      return true;
    }

    function prepareFieldContainers(section){
      const containers = [];
      const dependencies = new Map();
      const fields = section.querySelectorAll('input, select, textarea');
      fields.forEach(field=>{
        if(!isFieldEligible(field)) return;
        const body = field.closest('.section-group-body');
        if(!body) return;
        const container = getContainerForField(field, body);
        if(!container || (container.classList && container.classList.contains('section-group-empty'))) return;
        if(!container.dataset.fieldContainer){
          container.dataset.fieldContainer = '1';
          container.__fields = [];
          containers.push(container);
          const group = container.closest('.section-group');
          if(group){
            container.dataset.groupId = group.dataset.groupId || '';
            container.dataset.level = container.dataset.level || group.dataset.level || 'basic';
          }
          container.__conditionalRules = [];
        }
        if(container.__fields.indexOf(field) === -1){
          container.__fields.push(field);
        }
        const ruleType = field.dataset.requiredWhen;
        const sourceId = field.dataset.requiredSource;
        if(ruleType && sourceId){
          container.__conditionalRules.push({ type: ruleType, sourceId: sourceId });
          if(!dependencies.has(sourceId)) dependencies.set(sourceId, []);
          const list = dependencies.get(sourceId);
          if(list.indexOf(container) === -1) list.push(container);
        }
      });
      containers.forEach(container=>{
        if(!Array.isArray(container.__fields)) container.__fields = [];
        container.__fillMode = determineFillMode(container);
        container.dataset.fillMode = container.__fillMode;
        const baseRequired = detectContainerBaseRequired(container);
        container.dataset.requiredBase = baseRequired ? '1' : '0';
        container.dataset.required = baseRequired ? '1' : '0';
        if(!container.dataset.level){
          const group = container.closest('.section-group');
          container.dataset.level = group ? (group.dataset.level || 'basic') : 'basic';
        }
      });
      return { containers, dependencies };
    }

    function evaluateContainerRequirement(section, container){
      if(!container) return false;
      const baseRequired = container.dataset.requiredBase === '1';
      let required = baseRequired;
      const rules = container.__conditionalRules || [];
      if(rules.length){
        let conditionMet = false;
        rules.forEach(rule=>{
          if(rule.type === 'partial' && rule.sourceId){
            const source = document.getElementById(rule.sourceId);
            if(source && source.value === '部分協助') conditionMet = true;
          }
        });
        if(conditionMet){
          required = true;
        }else if(!baseRequired){
          required = false;
        }
      }
      container.dataset.required = required ? '1' : '0';
      return required;
    }

    function isFieldValueFilled(field, container){
      if(!field) return false;
      if(isInlineHidden(field, container)) return true;
      if(field.type === 'checkbox'){
        const inputs = container.querySelectorAll('input[type=checkbox]');
        return Array.from(inputs).some(input=>input.checked);
      }
      if(field.type === 'radio'){
        const radios = container.querySelectorAll(`input[type=radio][name="${field.name}"]`);
        if(radios.length) return Array.from(radios).some(radio=>radio.checked);
        return field.checked;
      }
      if(field.tagName === 'SELECT'){
        const value = field.value;
        if(value === undefined || value === null || value === '') return false;
        const option = field.options[field.selectedIndex];
        if(option && (option.disabled || option.classList.contains('placeholder-option'))) return false;
        return true;
      }
      if(field.type === 'number'){
        const val = field.value;
        if(val === undefined || val === null) return false;
        return String(val).trim() !== '';
      }
      if(field.type === 'date' || field.type === 'time'){
        return !!field.value;
      }
      if(field.tagName === 'TEXTAREA' || field.type === 'text' || field.type === 'email' || field.type === 'tel' || field.type === 'search' || field.type === 'url'){
        return String(field.value || '').trim() !== '';
      }
      return String(field.value || '').trim() !== '';
    }

    function updateContainerFilled(section, container){
      if(!container) return false;
      const fields = container.__fields || [];
      if(!fields.length){
        container.dataset.filled = '1';
        return true;
      }
      const fillMode = container.__fillMode || 'all';
      let filled = false;
      if(fillMode === 'any'){
        filled = fields.some(field=>isFieldValueFilled(field, container));
      }else{
        filled = fields.every(field=>isFieldValueFilled(field, container));
      }
      container.dataset.filled = filled ? '1' : '0';
      return filled;
    }

    function bindFieldListeners(section, container){
      const fields = container.__fields || [];
      const handler = ()=>{
        evaluateContainerRequirement(section, container);
        updateContainerFilled(section, container);
        updateSectionProgress(section);
      };
      fields.forEach(field=>{
        if(field.dataset.progressListener) return;
        field.addEventListener('input', handler);
        field.addEventListener('change', handler);
        field.dataset.progressListener = '1';
      });
    }

    function updateSectionProgress(section){
      if(!section) return;
      const progress = section.__progress;
      const containers = section.__fieldContainers || [];
      const groupStats = {};
      (section.__groups || []).forEach(group=>{
        if(group && group.id){
          groupStats[group.id] = { required:0, filled:0 };
        }
      });
      let requiredCount = 0;
      let filledCount = 0;
      let advancedCount = 0;
      containers.forEach(container=>{
        const required = evaluateContainerRequirement(section, container);
        const filled = updateContainerFilled(section, container);
        if(container && container.dataset && container.dataset.level === 'advanced'){
          advancedCount++;
        }
        if(required){
          requiredCount++;
          if(filled) filledCount++;
        }
        const groupId = container && container.dataset ? container.dataset.groupId : '';
        if(groupId && groupStats[groupId]){
          if(required) groupStats[groupId].required++;
          if(required && filled) groupStats[groupId].filled++;
        }
      });
      section.__progressCounts = { required: requiredCount, filled: filledCount };
      section.__groupStats = groupStats;
      section.__advancedCount = advancedCount;
      updateSectionAdvancedCount(section);
      if(progress){
        let percent = requiredCount ? Math.round((filledCount / requiredCount) * 100) : 100;
        if(!Number.isFinite(percent)) percent = 100;
        progress.text.textContent = `已完成 ${filledCount} / ${requiredCount}（${percent}%）`;
        progress.bar.style.width = `${percent}%`;
      }
      (section.__groups || []).forEach(group=>{
        if(!group || !group.element) return;
        const stats = groupStats[group.id] || { filled:0, required:0 };
        const status = determineProgressStatus(stats.filled || 0, stats.required || 0);
        group.element.dataset.status = status;
        if(group.navItem){
          group.navItem.status = status;
          group.navItem.stats = { filled: stats.filled || 0, required: stats.required || 0 };
        }
      });
      updateAllGroupEmptyStates(section);
      updateSideNavForSection(section);
      scheduleSummaryProgressRender();
    }

    function createSectionProgress(section){
      if(!section) return;
      const progress = document.createElement('div');
      progress.className = 'section-progress';
      const text = document.createElement('div');
      text.className = 'section-progress-text';
      text.textContent = '已完成 0 / 0（0%）';
      const barWrap = document.createElement('div');
      barWrap.className = 'section-progress-bar';
      const bar = document.createElement('div');
      bar.className = 'section-progress-bar-fill';
      barWrap.appendChild(bar);
      progress.appendChild(text);
      progress.appendChild(barWrap);
      const firstGroup = section.querySelector('.section-group');
      if(firstGroup){
        section.insertBefore(progress, firstGroup);
      }else{
        section.appendChild(progress);
      }
      section.__progress = { element: progress, text, bar };
    }

    function updateToggleButtons(section){
      if(!section) return;
      const controls = section.__controls || {};
      const state = section.__state || SECTION_DEFAULT_TEMPLATE;
      if(controls.onlyBtn){
        controls.onlyBtn.classList.toggle('active', !!state.hideFilled);
        controls.onlyBtn.setAttribute('aria-pressed', state.hideFilled ? 'true' : 'false');
      }
      if(controls.advancedBtn){
        controls.advancedBtn.classList.toggle('active', !!state.showAdvanced);
        controls.advancedBtn.setAttribute('aria-pressed', state.showAdvanced ? 'true' : 'false');
        controls.advancedBtn.textContent = state.showAdvanced ? '隱藏進階' : '顯示進階';
      }
      if(controls.toggleAllBtn){
        const groups = section.__groups || [];
        const allCollapsed = groups.length ? groups.every(group=>group.element.dataset.collapsed === '1') : false;
        controls.toggleAllBtn.textContent = allCollapsed ? '全部展開' : '全部收合';
        controls.toggleAllBtn.setAttribute('aria-expanded', allCollapsed ? 'false' : 'true');
      }
    }

    function updateSectionAdvancedCount(section){
      if(!section || !section.__controls || !section.__controls.advancedCount) return;
      const label = section.__controls.advancedCount;
      const count = Number(section.__advancedCount || 0);
      if(!count){
        label.textContent='';
        label.dataset.hidden='1';
        return;
      }
      label.textContent = `進階 ${count} 項`;
      label.dataset.hidden='0';
    }

    function ensureSectionSelectionBadge(section){
      if(!section) return null;
      if(section.__selectionBadge && section.__selectionBadge.isConnected){
        return section.__selectionBadge;
      }
      const header = section.querySelector('.titlebar');
      if(!header) return null;
      let badge = header.querySelector('.section-selection-badge');
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'section-selection-badge';
        badge.dataset.hidden = '1';
        header.appendChild(badge);
      }
      section.__selectionBadge = badge;
      return badge;
    }

    function createSectionControls(section){
      const header = section.querySelector('.titlebar');
      if(!header) return;
      ensureSectionSelectionBadge(section);
      const controls = document.createElement('div');
      controls.className = 'section-controls';
      const sectionKey = section.dataset && section.dataset.section ? section.dataset.section : 'section';
      const sectionId = ensureElementId(section, `section_${sectionKey}`);
      const onlyBtn = document.createElement('button');
      onlyBtn.type = 'button';
      onlyBtn.textContent = '只看未填';
      onlyBtn.title = '系統會記住這個設定，重新整理後仍保留';
      onlyBtn.setAttribute('aria-pressed', 'false');
      if(sectionId){
        onlyBtn.setAttribute('aria-controls', sectionId);
      }
      const advancedBtn = document.createElement('button');
      advancedBtn.type = 'button';
      advancedBtn.textContent = '顯示進階';
      advancedBtn.setAttribute('aria-pressed', 'false');
      if(sectionId){
        advancedBtn.setAttribute('aria-controls', sectionId);
      }
      const toggleAllBtn = document.createElement('button');
      toggleAllBtn.type = 'button';
      toggleAllBtn.className = 'section-toggle-all';
      toggleAllBtn.textContent = '全部收合';
      if(sectionId){
        toggleAllBtn.setAttribute('aria-controls', sectionId);
      }
      toggleAllBtn.setAttribute('aria-expanded', 'true');
      const advancedCount = document.createElement('span');
      advancedCount.className = 'section-advanced-count';
      advancedCount.dataset.hidden = '1';
      controls.appendChild(onlyBtn);
      controls.appendChild(advancedBtn);
      controls.appendChild(toggleAllBtn);
      controls.appendChild(advancedCount);
      header.appendChild(controls);
      section.__controls = { onlyBtn, advancedBtn, toggleAllBtn, advancedCount };
      onlyBtn.addEventListener('click', ()=>{
        const state = section.__state || (section.__state = readSectionState(section.dataset.section));
        state.hideFilled = !state.hideFilled;
        section.dataset.hideFilled = state.hideFilled ? '1' : '0';
        updateToggleButtons(section);
        writeSectionState(section.dataset.section, state);
        updateAllGroupEmptyStates(section);
      });
      advancedBtn.addEventListener('click', ()=>{
        const state = section.__state || (section.__state = readSectionState(section.dataset.section));
        state.showAdvanced = !state.showAdvanced;
        section.dataset.showAdvanced = state.showAdvanced ? '1' : '0';
        updateToggleButtons(section);
        writeSectionState(section.dataset.section, state);
        updateAllGroupEmptyStates(section);
      });
      toggleAllBtn.addEventListener('click', ()=>{
        const groups = section.__groups || [];
        if(!groups.length) return;
        const allCollapsed = groups.every(group=>group.element.dataset.collapsed === '1');
        const target = !allCollapsed;
        groups.forEach(group=>setGroupCollapsed(section, group, target, { save:false }));
        const state = section.__state || (section.__state = readSectionState(section.dataset.section));
        state.collapsedGroups = {};
        if(target){
          groups.forEach(group=>{ state.collapsedGroups[group.id] = true; });
        }
        writeSectionState(section.dataset.section, state);
        updateToggleButtons(section);
        scheduleSideNavRender();
        });
      updateToggleButtons(section);
    }

    function applyMobileSectionDefaults(section, state){
      if(!section || !state) return;
      if(state.__persisted) return;
      const groups = section.__groups || [];
      let firstBasicVisible = false;
      state.hideFilled = shouldUseMobileDefaults();
      state.showAdvanced = false;
      state.collapsedGroups = state.collapsedGroups && typeof state.collapsedGroups === 'object' ? state.collapsedGroups : {};
      groups.forEach(group=>{
        const level = determineGroupLevel(group);
        let collapse = false;
        if(level === 'advanced'){
          collapse = true;
        }else{
          if(!firstBasicVisible){
            firstBasicVisible = true;
          }else{
            collapse = true;
          }
        }
        if(collapse){
          state.collapsedGroups[group.id] = true;
        }else{
          delete state.collapsedGroups[group.id];
        }
      });
    }

    function applyGoalInitialDefaults(section, state){
      if(!section || !state || state.__persisted) return;
      const page = section.closest('[data-page]');
      if(page && page.dataset && page.dataset.page === 'goals'){
        state.hideFilled = false;
        state.showAdvanced = true;
      }
    }

    function applySectionState(section, state){
      if(!section) return;
      section.dataset.hideFilled = state.hideFilled ? '1' : '0';
      section.dataset.showAdvanced = state.showAdvanced ? '1' : '0';
      const groups = section.__groups || [];
      groups.forEach(group=>{
        const collapsed = state.collapsedGroups && state.collapsedGroups[group.id];
        group.element.dataset.collapsed = collapsed ? '1' : '0';
        if(group.toggle) group.toggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      });
      updateToggleButtons(section);
    }

    function setupSection(section){
      if(!section || section.dataset.sectionInit === '1') return;
      section.dataset.sectionInit = '1';
      const hasPrebuiltGroups = Array.isArray(section.__groups) && section.__groups.length > 0;
      const groups = hasPrebuiltGroups ? section.__groups : buildSectionGroups(section);
      section.__groups = groups;
      if(Array.isArray(groups)){
        groups.forEach(group=>{
          const anchorId = group && group.element && group.element.dataset ? group.element.dataset.headingId : '';
          if(anchorId){
            registerHeadingGroup(anchorId, section, group);
          }
        });
      }
      createSectionProgress(section);
      createSectionControls(section);
      const hasPrebuiltContainers = Array.isArray(section.__fieldContainers) && section.__fieldContainers.length > 0;
      const prepared = hasPrebuiltContainers
        ? { containers: section.__fieldContainers, dependencies: section.__dependencies instanceof Map ? section.__dependencies : new Map() }
        : prepareFieldContainers(section);
      section.__fieldContainers = prepared.containers;
      section.__dependencies = prepared.dependencies instanceof Map ? prepared.dependencies : new Map();
      const state = readSectionState(section.dataset.section);
      section.__state = state;
      applyMobileSectionDefaults(section, state);
      applyGoalInitialDefaults(section, state);
      applySectionState(section, state);
      (section.__fieldContainers || []).forEach(container=>{
        bindFieldListeners(section, container);
        evaluateContainerRequirement(section, container);
        updateContainerFilled(section, container);
      });
      if(section.__dependencies){
        section.__dependencies.forEach((containers, sourceId)=>{
          const source = document.getElementById(sourceId);
          if(!source) return;
          const handler = ()=>{
            containers.forEach(container=>{
              evaluateContainerRequirement(section, container);
              updateContainerFilled(section, container);
            });
            updateSectionProgress(section);
          };
          source.addEventListener('change', handler);
          source.addEventListener('input', handler);
        });
      }
      (section.__groups || []).forEach(group=>{
        if(group.toggle){
          group.toggle.addEventListener('click', ()=>{
            const collapsed = group.element.dataset.collapsed === '1';
            if(collapsed){
              focusSectionGroupByElement(group.element);
            }else{
              setGroupCollapsed(section, group, true);
              updateToggleButtons(section);
              updateAllGroupEmptyStates(section);
              scheduleSideNavRender();
                    }
          });
        }
        if(group.body){
          group.body.addEventListener('focusin', ()=>{
            const isCollapsed = group.element.dataset.collapsed === '1';
            let othersOpen = false;
            if(section.__groups){
              for(let i=0;i<section.__groups.length;i++){
                const other = section.__groups[i];
                if(!other || other === group) continue;
                if(other.element && other.element.dataset.collapsed !== '1'){
                  othersOpen = true;
                  break;
                }
              }
            }
            if(isCollapsed || othersOpen){
              focusSectionGroupByElement(group.element);
              const step = resolveWizardStepForElement ? resolveWizardStepForElement(group.element) : null;
              if(step) updateWizardVisual(step);
            }
          });
        }
      });
      updateSectionProgress(section);
      updateAllGroupEmptyStates(section);
    }

    function initSectionViews(){
      resetHeadingGroupRegistry();
      ensureAllGroupBodies(document);
      const sections = document.querySelectorAll('[data-section]');
      sections.forEach(section=>setupSection(section));
      sectionViewsReady = true;
      registerSideNavGroups();
      sections.forEach(section=>updateSideNavForSection(section));
      scheduleSideNavRender();
      scheduleSummaryUpdate();
    }

    /* ===== 個管師名單 ===== */
    function loadManagers(){
      const unit=document.getElementById('unitCode').value;
      google.script.run.withSuccessHandler(list=>{
        const select=document.getElementById('caseManagerName');
        if(!select) return;
        const previousValue=(select.value || '').trim();
        const hasData=Array.isArray(list) && list.length > 0;
        select.innerHTML='';
        const placeholder=document.createElement('option');
        placeholder.value='';
        placeholder.textContent=hasData ? '請選擇' : '（無資料）';
        placeholder.className='placeholder-option';
        placeholder.disabled=true;
        placeholder.selected=true;
        select.appendChild(placeholder);
        let matched=false;
        if(hasData){
          list.forEach(name=>{
            const option=document.createElement('option');
            option.value=name;
            option.textContent=name;
            if(name === previousValue){
              option.selected=true;
              matched=true;
            }
            select.appendChild(option);
          });
          select.disabled=false;
          if(!matched){
            select.selectedIndex=0;
          }
        }else{
          select.disabled=true;
          select.selectedIndex=0;
        }
        buildApprovalPlanPreview();
        scheduleSummaryUpdate();
        updateBasicInfoCompletion({ silent:true });
      }).getCaseManagersByUnit(unit);
    }

    /* ===== 照專名單 ===== */
    function loadConsultants(){
      const unit = document.getElementById('unitCode').value;
      google.script.run.withSuccessHandler(list=>{
        const select=document.getElementById('consultName');
        if(!select) return;
        const previousValue=(select.value || '').trim();
        const hasData=Array.isArray(list) && list.length > 0;
        select.innerHTML='';
        const placeholder=document.createElement('option');
        placeholder.value='';
        placeholder.textContent=hasData ? '請選擇' : '（無資料）';
        placeholder.className='placeholder-option';
        placeholder.disabled=true;
        placeholder.selected=true;
        select.appendChild(placeholder);
        let matched=false;
        if(hasData){
          list.forEach(name=>{
            const option=document.createElement('option');
            option.value=name;
            option.textContent=name;
            if(name === previousValue){
              option.selected=true;
              matched=true;
            }
            select.appendChild(option);
          });
          select.disabled=false;
          if(!matched){
            select.selectedIndex=0;
          }
        }else{
          select.disabled=true;
          select.selectedIndex=0;
        }
        updateConsultVisitText();
        toggleCallDateByConsultVisit();
        scheduleSummaryUpdate();
        updateBasicInfoCompletion({ silent:true });
      }).getConsultantsByUnit(unit);
    }

    /* ===== 三、偕同訪視者（下拉＋多筆） ===== */
    let extraIdx=0, coCareIdx=0;
    function roleOptionsHTML(withPlaceholder=true){
      return `
        ${withPlaceholder ? '<option value="" class="placeholder-option" disabled selected>請選擇</option>' : ''}
        <optgroup label="配偶"><option>案妻</option><option>案夫</option></optgroup>
        <optgroup label="子女"><option>案長子</option><option>案次子</option><option>案長女</option><option>案次女</option></optgroup>
        <optgroup label="父母"><option>案父</option><option>案母</option></optgroup>
        <optgroup label="手足"><option>案兄</option><option>案姊</option><option>案弟</option><option>案妹</option></optgroup>
        <optgroup label="姻親"><option>案媳</option><option>案女婿</option></optgroup>
        <optgroup label="孫輩"><option>案孫</option><option>案孫女</option></optgroup>
        <optgroup label="自訂"><option>自訂角色</option></optgroup>`;
    }
    function addExtraRow(){
      const host=document.getElementById('extras');
      const idx=extraIdx++;
      const wrap=document.createElement('div');
      wrap.className='extra-row';
      wrap.id=`extra-${idx}`;
      wrap.innerHTML=`
      <div class="field-intro" data-field-size="short">
        <label class="h3" for="ex-role-${idx}">其他參與者關係</label>
        <select id="ex-role-${idx}" onchange="toggleCustomRole(${idx}, 'ex')">
          ${roleOptionsHTML(true)}
        </select>
        <input id="ex-custom-${idx}" type="text" placeholder="自訂角色" style="display:none; margin-top:var(--space-xs);">
      </div>
      <div class="field-intro" data-field-size="medium">
        <label class="h3" for="ex-name-${idx}">其他參與者姓名</label>
        <input id="ex-name-${idx}" type="text" placeholder="姓名，例如：李○○">
      </div>
      <div class="extra-row-actions">
        <button type="button" class="extra-remove" aria-label="移除參與者" title="移除參與者" onclick="removeExtraRow(${idx})">
          <span aria-hidden="true">×</span>
        </button>
      </div>`;
      host.appendChild(wrap);
      enforcePrimaryExclusionOnSelect(document.getElementById(`ex-role-${idx}`));
      updateParticipantConflictHint();
    }
    function toggleCustomRole(idx, prefix){
      const sel=document.getElementById(`${prefix}-role-${idx}`), custom=document.getElementById(`${prefix}-custom-${idx}`);
      const isCustom= sel && sel.value==='自訂角色'; if(custom) custom.style.display= isCustom?'':'none';
    }
    function removeExtraRow(idx){
      const el=document.getElementById(`extra-${idx}`);
      if(el) el.remove();
      enforcePrimaryExclusionOnExtras();
      updateParticipantConflictHint();
      buildApprovalPlanPreview();
      if(!isRestoringDraft) scheduleAutoSave();
    }

    function resetExtras(){
      document.querySelectorAll('[id^="extra-"]').forEach(el=>el.remove());
      extraIdx = 0;
    }

    function restoreExtras(list){
      resetExtras();
      if(!Array.isArray(list) || !list.length) return;
      list.forEach(entry=>{
        const rawRole = entry && entry.role !== undefined ? String(entry.role).trim() : '';
        const customRole = entry && entry.customRole !== undefined ? String(entry.customRole).trim() : '';
        const name = entry && entry.name !== undefined ? String(entry.name).trim() : '';
        if(!rawRole && !customRole && !name) return;
        const currentIndex = extraIdx;
        addExtraRow();
        const select=document.getElementById(`ex-role-${currentIndex}`);
        const custom=document.getElementById(`ex-custom-${currentIndex}`);
        const nameInput=document.getElementById(`ex-name-${currentIndex}`);
        let appliedCustom = false;
        if(select){
          const hasOption = rawRole && [...select.options].some(opt=>opt.value===rawRole);
          if(hasOption){
            select.value = rawRole;
          }else if(rawRole){
            select.value = '自訂角色';
            appliedCustom = true;
          }else if(customRole){
            select.value = '自訂角色';
            appliedCustom = true;
          }
          if(select.value === '自訂角色' && custom){
            custom.style.display='';
            custom.value = customRole || (!hasOption ? rawRole : '');
          }else if(custom){
            custom.style.display='none';
            custom.value='';
          }
        }
        if(appliedCustom && custom && !custom.value){
          custom.value = rawRole;
        }
        if(nameInput) nameInput.value = name;
      });
      enforcePrimaryExclusionOnExtras();
    }
    function enforcePrimaryExclusionOnSelect(sel){
      if(!sel) return;
      const primary = document.getElementById('primaryRel').value;
      [...sel.options].forEach(opt=>{
        if(!opt.value) return; // placeholder
        opt.disabled = (primary && opt.value===primary);
      });
      // 若當前選到與主照者相同，重置為 placeholder
      if(primary && sel.value===primary){
        sel.selectedIndex = 0;
      }
    }
    function enforcePrimaryExclusionOnExtras(){
      document.querySelectorAll('[id^="ex-role-"]').forEach(enforcePrimaryExclusionOnSelect);
      updateParticipantConflictHint();
    }
    function computeParticipantConflicts(){
      const primary=(document.getElementById('primaryRel').value||'').trim();
      if(!primary) return {hasConflict:false, roles:[]};
      const roles=new Set();
      document.querySelectorAll('[id^="ex-role-"]').forEach(sel=>{
        if(!sel) return;
        const idx=sel.id.split('-')[2];
        let role=(sel.value||'').trim();
        if(role==='自訂角色'){
          const custom=document.getElementById(`ex-custom-${idx}`);
          role=(custom?custom.value:'').trim();
        }
        if(role && role===primary){ roles.add(role); }
      });
      return {hasConflict: roles.size>0, roles:[...roles]};
    }
    function updateParticipantConflictHint(){
      const box=document.getElementById('extras_conflict');
      const group=document.getElementById('visitPartnersCard');
      if(!box){
        if(group) group.dataset.conflict='0';
        return {hasConflict:false, roles:[]};
      }
      const result=computeParticipantConflicts();
      if(result.hasConflict){
        box.textContent=`其他參與者不可與主要照顧者角色重覆（重覆角色：${result.roles.join('、')}）`;
        box.dataset.show='1';
        if(group) group.dataset.conflict='1';
      }else{
        box.textContent='';
        box.dataset.show='0';
        if(group) group.dataset.conflict='0';
      }
      return result;
    }
    function validateParticipantConflicts(){
      const result=updateParticipantConflictHint();
      const extrasBox=document.getElementById('extras');
      if(result.hasConflict){
        if(extrasBox) extrasBox.classList.add('input-invalid');
        return {
          ok:false,
          messages:[{ fieldId:'extras', pageId:'goals', text:'請調整參與者角色，避免與主要照顧者重覆。' }]
        };
      }
      if(extrasBox) extrasBox.classList.remove('input-invalid');
      return { ok:true, messages:[] };
    }
    function collectExtras(){
      const reserved=new Set(['個案','福安個管','照專']);
      const uniq=new Set(), out=[];
      const rows=[...document.querySelectorAll('[id^="extra-"]')];
      rows.forEach(row=>{
        const idx=row.id.split('-')[1];
        const sel=document.getElementById(`ex-role-${idx}`),
              custom=document.getElementById(`ex-custom-${idx}`),
              nameEl=document.getElementById(`ex-name-${idx}`);
        let role=(sel?sel.value:'').trim(); if(role==='自訂角色') role=(custom?custom.value:'').trim();
        const name=(nameEl?nameEl.value:'').trim();
        if(!role||!name) return; if(reserved.has(role)) return;
        const key=role+'|'+name; if(uniq.has(key)) return; uniq.add(key);
        out.push({role, name});
      });
      return out;
    }

    /* ================== (一) 身心概況：字典、連動、蒐集、產文 ================== */

    // 字典
    const S1_VISION_NOTES = ['白內障術後','配戴眼鏡','老花','單眼視力不佳','其他'];
    const VISION_NOTE_SUGGESTION = {
      '靠近才能辨識': ['配戴眼鏡'],
      '即使配戴眼鏡，仍難以辨識': ['配戴眼鏡'],
      '僅能分辨明暗，無法辨識人臉或物體輪廓': ['其他'],
      '完全失去視覺功能，無法感知光線': ['其他']
    };
    const S1_LESION_SX_LIST = ['疼痛','搔癢','出血','紅腫','滲液','潰瘍','脫屑','壓紅','無不適'];
    const S1_DHX_LIST     = ['高血壓','糖尿病','高脂血症','心臟病','腦中風','失智症','慢性腎臟病','慢性阻塞性肺病','退化性關節炎','其他'];
    const S1_MED_CLASSES  = ['降壓藥','甲狀腺藥','降脂藥','抗焦慮／鎮定','睡眠用藥','精神科用藥','抗血栓／抗凝','利尿劑','胃腸用藥','止痛藥','止咳化痰','降血糖／胰島素','攝護腺用藥','其他'];
    const S1_LANG_OPTIONS = ['國語','台語','客語','原住民語','英語','手勢／書寫','讀唇','溝通板／App'];
    const S1_SWALLOW_SX_OPTIONS = ['嗆咳','殘留','口水外漏','吞嚥延遲','需要吞嚥訓練'];
    const S1_DIET_TEXTURE_OPTIONS = ['一般','軟質','碎食','泥狀','蜂蜜稠','布丁稠'];
    const S1_FEEDING_TUBE_OPTIONS = ['鼻胃管（NGT）','胃造口（PEG）'];
    const S1_ORAL_OPTIONS = ['自然牙完整','缺牙','口腔衛生不佳','口乾','口臭','活動假牙（上）','活動假牙（下）','假牙不合／鬆動'];
    const S1_EXCRETION_AID_OPTIONS = ['紙尿褲','尿墊','便盆椅','尿壺','留置導尿管','間歇導尿管','尿造口袋','糞造口袋','夜間集尿袋'];
    const S1_BALANCE_OPTIONS = ['站立不穩','頭暈','TUG>12s'];
    const S1_SITTING_SUPPORT_OPTIONS = ['需安全帶','需托盤／擋板','坐墊／防滑具'];
    const S1_EMOTION_OPTIONS = ['情緒穩定','焦慮','憂鬱','易怒'];
    const S1_BEHAVIOR_OPTIONS = ['妄想','幻想性言談','遊走','重複行為','日夜顛倒','脫序行為','囤積'];
    const S1_PHONE_NOTE_OPTIONS = ['重聽需擴音','易受詐騙','其他'];
    const S1_DEVICE_OPTIONS = ['鼻胃管','胃造口管（PEG）','氣切管','鼻導管氧氣','氧氣機','中心靜脈導管','PICC 導管','呼吸輔助器（CPAP）','雙水平呼吸器（BiPAP）','血糖機','藥盒'];
    const INSOMNIA_DETAIL = {
      '疼痛': ['關節炎','骨刺','神經病變','慢性病帶來'],
      '頻尿': ['攝護腺肥大','膀胱功能下降','糖尿病','泌尿道疾病'],
      '慢性疾病': ['心臟衰竭','咳嗽','呼吸困難'],
      '生活壓力': ['經濟','家庭','健康狀況'],
      '環境干擾': ['光線','噪音','溫度過高','溫度過低','床墊不舒適'],
      '不良睡眠習慣': ['白天長時間小睡','晚間過度使用電視','晚間過度使用手機'],
      '藥物影響': ['降壓藥','利尿劑','類固醇','抗憂鬱藥']
    };

    // 聽力：兩層
    const HEARING_DETAIL = {
      '無明顯異常': ['對話流暢，無需特別協助'],
      '輕度受損':   ['需提高音量','在安靜環境下才能聽清'],
      '中度受損':   ['需近距離交談','借助助聽器才能理解','使用擴音設備','助聽器需維修／電量管理'],
      '重度受損':   ['助聽器效果有限','需讀唇或書寫輔助','使用擴音設備','助聽器需維修／電量管理','不配戴（依從性差）'],
      '極重度受損': ['僅能感知大聲或震動','幾乎無法辨識語音內容'],
      '完全失聰':   ['完全聽不見','無法感知聲音']
    };

    // 疼痛部位 × 皮膚病灶：大分類 → 細部分位 → 側別
    const REGION_MAP = {
      '頭頸部': ['頭部','眼睛','面部','口腔牙齒','咽喉','頸部'],
      '上肢':   ['肩膀','手臂','手部'],
      '軀幹':   ['胸部','腹部','背部','腰部','臀部'],
      '下肢':   ['大腿','膝蓋','小腿','足部'],
      '全身性': ['全身痠痛','多處關節','其他']
    };
    const SYMMETRIC_PARTS = new Set(['眼睛','肩膀','手臂','手部','大腿','膝蓋','小腿','足部']);

    const LOCATION_CONTEXTS = ['pain','lesion'];
    const locationState = {
      pain:  { region:'', subChoice:'', subOther:'', laterality:'' },
      lesion:{ region:'', subChoice:'', subOther:'', laterality:'' }
    };
    let activeLocationContext = 'pain';
    let lesionSymptomMode = 'none';

    // 渲染
    function renderS1() {
      // 視力補充
      const vbox=document.getElementById('s1_vision_note_box'); vbox.innerHTML='';
      S1_VISION_NOTES.forEach(name=>{
        const id='vnote_'+name;
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" id="${id}" onchange="onVisionNoteChange(event)"> ${name}`;
        vbox.appendChild(lab);
      });

      // 病灶症狀（互斥：無不適）
      setupLesionSymptomsBox();

      // 慢性病
      const dhx=document.getElementById('s1_dhx_box'); dhx.innerHTML='';
      S1_DHX_LIST.forEach(name=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="toggleDhxOther()"> ${name}`;
        dhx.appendChild(lab);
      });

      // 現用藥別
      const meds=document.getElementById('s1_med_classes_box'); meds.innerHTML='';
      S1_MED_CLASSES.forEach(name=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="toggleMedOther()"> ${name}`;
        meds.appendChild(lab);
      });

      const langBox=document.getElementById('s1_lang_box');
      if(langBox){
        langBox.innerHTML='';
        S1_LANG_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="lang_${i}"> ${name}`;
          langBox.appendChild(lab);
        });
      }

      const swallowBox=document.getElementById('s1_swallow_sx_box');
      if(swallowBox){
        swallowBox.innerHTML='';
        S1_SWALLOW_SX_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="swallow_${i}"> ${name}`;
          swallowBox.appendChild(lab);
        });
      }

      const dietBox=document.getElementById('s1_diet_texture_box');
      if(dietBox){
        dietBox.innerHTML='';
        S1_DIET_TEXTURE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="diet_${i}"> ${name}`;
          dietBox.appendChild(lab);
        });
      }

      const tubeBox=document.getElementById('s1_feeding_tube_box');
      if(tubeBox){
        tubeBox.innerHTML='';
        S1_FEEDING_TUBE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="tube_${i}"> ${name}`;
          tubeBox.appendChild(lab);
        });
      }

      const oralBox=document.getElementById('s1_oral_box');
      if(oralBox){
        oralBox.innerHTML='';
        S1_ORAL_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="oral_${i}"> ${name}`;
          oralBox.appendChild(lab);
        });
      }

      const excretionBox=document.getElementById('s1_excretion_aids_box');
      if(excretionBox){
        excretionBox.innerHTML='';
        S1_EXCRETION_AID_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="exaid_${i}" onchange="updateExcretionAidEffects()"> ${name}`;
          excretionBox.appendChild(lab);
        });
      }

      const balanceBox=document.getElementById('s1_balance_box');
      if(balanceBox){
        balanceBox.innerHTML='';
        S1_BALANCE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="balance_${i}"> ${name}`;
          balanceBox.appendChild(lab);
        });
      }

      const sittingSupportBox=document.getElementById('s1_sitting_support_box');
      if(sittingSupportBox){
        sittingSupportBox.innerHTML='';
        S1_SITTING_SUPPORT_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="sit_${i}"> ${name}`;
          sittingSupportBox.appendChild(lab);
        });
      }

      const emotionBox=document.getElementById('s1_emotion_box');
      if(emotionBox){
        emotionBox.innerHTML='';
        S1_EMOTION_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="emotion_${i}"> ${name}`;
          emotionBox.appendChild(lab);
        });
      }
      const behaviorBox=document.getElementById('s1_behavior_box');
      if(behaviorBox){
        behaviorBox.innerHTML='';
        S1_BEHAVIOR_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="behavior_${i}"> ${name}`;
          behaviorBox.appendChild(lab);
        });
      }

      const phoneNoteBox=document.getElementById('s1_phone_note_box');
      if(phoneNoteBox){
        phoneNoteBox.innerHTML='';
        S1_PHONE_NOTE_OPTIONS.forEach((name,i)=>{
          const handler = name==='其他' ? ' onchange="togglePhoneNoteOther()"' : '';
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="phonenote_${i}"${handler}> ${name}`;
          phoneNoteBox.appendChild(lab);
        });
      }

      const deviceBox=document.getElementById('s1_devices_box');
      if(deviceBox){
        deviceBox.innerHTML='';
        S1_DEVICE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="device_${i}"> ${name}`;
          deviceBox.appendChild(lab);
        });
      }

      refreshCheckcols(document.getElementById('section1_block'));
    }

    function setupLesionSymptomsBox(){
      const box = document.getElementById('s1_lesion_sx_box');
      if(!box) return;
      box.innerHTML='';
      S1_LESION_SX_LIST.forEach(name=>{
        const id = 'lsx_'+name;
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" id="${id}" onchange="syncNoDiscomfort('s1_lesion_sx_box')"> ${name}`;
        box.appendChild(lab);
      });
      box.dataset.mode = lesionSymptomMode;
      setLesionSymptomMode(lesionSymptomMode);
      refreshCheckcol('s1_lesion_sx_box');
    }

    // 連動
    function toggleVisionNotes(){
      const v=document.getElementById('s1_vision').value;
      const box=document.getElementById('s1_vision_note_box');
      if(box){
        box.querySelectorAll('input[data-auto="1"]').forEach(inp=>{
          inp.checked=false;
          inp.removeAttribute('data-auto');
          const lab=inp.closest('label');
          if(lab) lab.removeAttribute('data-auto');
        });
        box.querySelectorAll('label[data-auto="1"]').forEach(lab=>lab.removeAttribute('data-auto'));
        const suggest = VISION_NOTE_SUGGESTION[v] || [];
        suggest.forEach(label=>{
          const chk=box.querySelector(`input[value="${label}"]`);
          if(chk){
            chk.checked=true;
            chk.dataset.auto='1';
            const lab=chk.closest('label');
            if(lab) lab.dataset.auto='1';
          }
        });
      }
      toggleVisionOther();
      toggleGlassesAdherence();
      updateVisionAutoHint();
      refreshCheckcol('s1_vision_note_box');
    }
    function onVisionNoteChange(event){
      const target=event && event.target;
      if(target && target.matches('input[type=checkbox]')){
        target.removeAttribute('data-auto');
        const lab=target.closest('label');
        if(lab) lab.removeAttribute('data-auto');
      }
      toggleVisionOther();
      toggleGlassesAdherence();
      updateVisionAutoHint();
    }
    function toggleVisionOther(){
      const hasOther = document.querySelector('#s1_vision_note_box input[value="其他"]')?.checked;
      document.getElementById('s1_vision_other').style.display = hasOther?'':'none';
    }
    function toggleGlassesAdherence(){
      const wrap=document.getElementById('s1_glasses_adherence_wrap');
      if(!wrap) return;
      const checks=[...document.querySelectorAll('#s1_vision_note_box input[type=checkbox]:checked')].map(x=>x.value);
      const need=checks.some(v=>v==='配戴眼鏡');
      wrap.style.display = need ? '' : 'none';
      if(!need){
        const sel=document.getElementById('s1_glasses_adherence');
        if(sel) sel.value='';
      }
    }
    function updateVisionAutoHint(){
      const hint=document.getElementById('s1_vision_auto_hint');
      if(!hint) return;
      const hasAuto = !!document.querySelector('#s1_vision_note_box input[data-auto="1"]');
      hint.style.display = hasAuto ? '' : 'none';
    }
    function resetVisionSuggestions(){
      const box=document.getElementById('s1_vision_note_box');
      if(box){
        box.querySelectorAll('input[type=checkbox]').forEach(inp=>{
          inp.checked=false;
          inp.removeAttribute('data-auto');
        });
        box.querySelectorAll('label[data-auto]').forEach(lab=>lab.removeAttribute('data-auto'));
      }
      const otherInput=document.getElementById('s1_vision_other');
      if(otherInput) otherInput.value='';
      toggleVisionNotes();
    }

    // 聽力兩層渲染
    function renderHearingDetails(){
      const level = document.getElementById('s1_hearing_level').value;
      const wrap  = document.getElementById('s1_hearing_detail_wrap');
      const box   = document.getElementById('s1_hearing_detail_box');
      if(!level){ wrap.style.display='none'; box.innerHTML=''; return; }
      const items = (HEARING_DETAIL[level] || []).slice();
      const extra = '在嘈雜環境下理解困難';
      if(!items.includes(extra)) items.push(extra);
      box.innerHTML = '';
      items.forEach((txt, i)=>{
        const id = 'hear_'+i;
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${txt}" id="${id}" onchange="toggleHearingDeviceAdherence()"> ${txt}`;
        box.appendChild(lab);
      });
      wrap.style.display='';
      toggleHearingDeviceAdherence();
      refreshCheckcol('s1_hearing_detail_box');
    }

    function toggleHearingDeviceAdherence(){
      const wrap=document.getElementById('s1_hearing_device_wrap');
      if(!wrap) return;
      const checks=[...document.querySelectorAll('#s1_hearing_detail_box input[type=checkbox]')];
      const need=checks.some(c=>c.checked && (c.value==='借助助聽器才能理解' || c.value==='使用擴音設備'));
      wrap.style.display = need ? '' : 'none';
      if(!need){
        const sel=document.getElementById('s1_hearing_device_adherence');
        if(sel) sel.value='';
      }
    }

    function togglePainCombined(){
      const v  = document.getElementById('s1_pain').value;
      const on = (v === '有');

      document.getElementById('s1_pain_score_wrap').style.display = on ? '' : 'none';

      if(on){
        const ps = document.getElementById('s1_pain_score');
        if(ps && !ps.value) ps.value = 5;
        switchLocationContext('pain');
      }

      updateLocationVisibility();
    }

    function resetLocationState(context){
      if(locationState[context]){
        locationState[context].region='';
        locationState[context].subChoice='';
        locationState[context].subOther='';
        locationState[context].laterality='';
      }
    }

    function getLocationSubregionText(state){
      if(!state) return '';
      if(state.subChoice === '其他'){
        return state.subOther || '';
      }
      return state.subChoice || '';
    }

    function needsLaterality(state){
      return SYMMETRIC_PARTS.has(getLocationSubregionText(state));
    }

    function populateSubregionOptions(region, selected){
      const subSel=document.getElementById('s1_location_subregion');
      if(!subSel) return;
      subSel.innerHTML='<option value="" class="placeholder-option" disabled selected>請選擇</option>';
      if(region){
        (REGION_MAP[region] || []).forEach(name=>{
          const o=document.createElement('option'); o.textContent=name; subSel.appendChild(o);
        });
      }
      if(selected && [...subSel.options].some(opt=>opt.value===selected)){
        subSel.value = selected;
      }else{
        subSel.value='';
      }
    }

    function saveLocationFromUI(){
      const block=document.getElementById('s1_location_block');
      if(!block || block.style.display==='none') return;
      const state=locationState[activeLocationContext];
      if(!state) return;
      const regionSel=document.getElementById('s1_location_region');
      const subSel=document.getElementById('s1_location_subregion');
      const other=document.getElementById('s1_location_subregion_other');
      const latSel=document.getElementById('s1_location_laterality');
      if(regionSel) state.region = regionSel.value || '';
      if(subSel) state.subChoice = subSel.value || '';
      if(other && state.subChoice === '其他'){
        state.subOther = other.value || '';
      }else if(state.subChoice !== '其他'){
        state.subOther = '';
      }
      if(latSel && !latSel.disabled){
        state.laterality = latSel.value || '';
      }else{
        state.laterality = '';
      }
    }

    function isLocationStateEmpty(state){
      return !state || (!state.region && !state.subChoice && !state.subOther && !state.laterality);
    }

    function applyLocationStateToUI(){
      const state=locationState[activeLocationContext];
      const regionSel=document.getElementById('s1_location_region');
      const subSel=document.getElementById('s1_location_subregion');
      const other=document.getElementById('s1_location_subregion_other');
      const latSel=document.getElementById('s1_location_laterality');
      if(!state || !regionSel || !subSel || !other || !latSel) return;
      regionSel.value = state.region || '';
      populateSubregionOptions(state.region, state.subChoice);
      if(state.subChoice){
        const hasOption=[...subSel.options].some(opt=>opt.value===state.subChoice);
        subSel.value = hasOption ? state.subChoice : '';
        if(!hasOption){
          state.subChoice='';
          state.subOther='';
        }
      }else{
        subSel.value='';
      }
      if(state.subChoice === '其他'){
        other.style.display='';
        other.value = state.subOther || '';
      }else{
        other.style.display='none';
        other.value='';
      }
      const needLat = needsLaterality(state);
      latSel.parentElement.style.display = needLat ? '' : 'none';
      latSel.disabled = !needLat;
      if(needLat){
        latSel.value = state.laterality || '';
      }else{
        latSel.value='';
        state.laterality='';
      }
    }

    function updateLocationToolbar(){
      const label=document.getElementById('s1_location_active_label');
      if(label){
        label.textContent = activeLocationContext === 'lesion' ? '病灶部位' : '疼痛部位';
      }
      document.querySelectorAll('.location-switch button').forEach(btn=>{
        if(btn.dataset && btn.dataset.context){
          btn.dataset.active = (btn.dataset.context === activeLocationContext) ? '1' : '0';
        }
      });
      const toolbar=document.getElementById('s1_location_toolbar');
      if(toolbar){
        const painOn = document.getElementById('s1_pain').value === '有';
        const lesionOn = document.getElementById('s1_lesion_has').value === '有';
        toolbar.style.display = (painOn && lesionOn) ? '' : 'none';
        const copyBtn=document.getElementById('location_copy_btn');
        if(copyBtn){
          if(painOn && lesionOn){
            copyBtn.style.display='';
            const target = activeLocationContext;
            const source = target === 'lesion' ? 'pain' : 'lesion';
            copyBtn.textContent = target === 'lesion' ? '同疼痛部位' : '同病灶部位';
            const hasSource = !isLocationStateEmpty(locationState[source]);
            copyBtn.disabled = !hasSource;
            copyBtn.dataset.source = source;
            copyBtn.dataset.active = hasSource ? '1' : '0';
            copyBtn.title = hasSource ? '' : '來源尚未設定';
          }else{
            copyBtn.style.display='none';
          }
        }
      }
    }

    function copyLocationFromOther(){
      const painOn = document.getElementById('s1_pain').value === '有';
      const lesionOn = document.getElementById('s1_lesion_has').value === '有';
      if(!(painOn && lesionOn)) return;
      const target = activeLocationContext;
      const source = target === 'lesion' ? 'pain' : 'lesion';
      const sourceState = locationState[source];
      const targetState = locationState[target];
      if(!sourceState || !targetState || isLocationStateEmpty(sourceState)) return;
      targetState.region = sourceState.region || '';
      targetState.subChoice = sourceState.subChoice || '';
      targetState.subOther = sourceState.subOther || '';
      targetState.laterality = sourceState.laterality || '';
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function switchLocationContext(context, opts={}){
      if(!LOCATION_CONTEXTS.includes(context)) return;
      if(activeLocationContext !== context){
        saveLocationFromUI();
      }
      const target=locationState[context];
      if(opts.copyFrom && isLocationStateEmpty(target)){
        const src=locationState[opts.copyFrom];
        if(src){
          target.region = src.region || '';
          target.subChoice = src.subChoice || '';
          target.subOther = src.subOther || '';
          target.laterality = src.laterality || '';
        }
      }
      activeLocationContext = context;
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function updateLocationVisibility(){
      const block=document.getElementById('s1_location_block');
      const painOn = document.getElementById('s1_pain').value === '有';
      const lesionOn = document.getElementById('s1_lesion_has').value === '有';
      if(block){
        block.style.display = (painOn || lesionOn) ? '' : 'none';
      }
      if(!painOn && !lesionOn){
        saveLocationFromUI();
        updateLocationToolbar();
        return;
      }
      if(painOn && activeLocationContext !== 'pain'){
        switchLocationContext('pain');
      }else if(!painOn && lesionOn && activeLocationContext !== 'lesion'){
        switchLocationContext('lesion');
      }else{
        applyLocationStateToUI();
        updateLocationToolbar();
      }
    }

    function onSharedRegionChange(){
      const regionSel=document.getElementById('s1_location_region');
      const state=locationState[activeLocationContext];
      if(!regionSel || !state) return;
      state.region = regionSel.value || '';
      state.subChoice='';
      state.subOther='';
      state.laterality='';
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function onSharedSubregionChange(){
      const subSel=document.getElementById('s1_location_subregion');
      const state=locationState[activeLocationContext];
      if(!subSel || !state) return;
      state.subChoice = subSel.value || '';
      if(state.subChoice !== '其他'){ state.subOther=''; }
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function onSharedSubregionOtherInput(){
      const other=document.getElementById('s1_location_subregion_other');
      const state=locationState[activeLocationContext];
      if(!other || !state) return;
      state.subOther = other.value || '';
    }

    function onSharedLateralityChange(){
      const latSel=document.getElementById('s1_location_laterality');
      const state=locationState[activeLocationContext];
      if(!latSel || !state) return;
      if(latSel.disabled){ state.laterality=''; }
      else { state.laterality = latSel.value || ''; }
    }

    function getLocationData(context){
      const state = locationState[context] || { region:'', subChoice:'', subOther:'', laterality:'' };
      const region = state.region || '';
      const subChoice = state.subChoice || '';
      const subOther = subChoice === '其他' ? (state.subOther || '') : '';
      const subValue = subChoice === '其他' ? (state.subOther || '') : subChoice;
      const laterality = state.laterality || '';
      return { region, subChoice, subOther, subValue, laterality };
    }

    // 皮膚病灶顯示
    function toggleLesionCombined(){
      const v=document.getElementById('s1_lesion_has').value;
      const on=(v==='有');
      if(on){
        if(document.getElementById('s1_pain').value === '有'){
          switchLocationContext('lesion', { copyFrom: 'pain' });
        }else{
          switchLocationContext('lesion');
        }
        setLesionSymptomMode(lesionSymptomMode === 'symptom' ? 'symptom' : 'none');
      }else{
        lesionSymptomMode = 'none';
        setLesionSymptomMode('none');
        const lenInput=document.getElementById('s1_lesion_length');
        const widInput=document.getElementById('s1_lesion_width');
        if(lenInput) lenInput.value='';
        if(widInput) widInput.value='';
      }
      document.getElementById('s1_lesion_layer_wrap').style.display = on?'':'none';
      document.getElementById('s1_lesion_size_wrap').style.display = on?'':'none';
      document.getElementById('s1_lesion_more').style.display = on?'':'none';
      updateLesionAreaDisplay();
      updateLocationVisibility();
      toggleLesionHospital();
    }
    function toggleLesionLayerOther(){
      const v=document.getElementById('s1_lesion_layer').value;
      const other=document.getElementById('s1_lesion_layer_other');
      if(!other) return;
      const show=(v==='其他');
      other.style.display = show?'':'none';
      if(!show) other.value='';
    }

    function toggleLesionHospital(){
      const has=document.getElementById('s1_lesion_has').value;
      const evalv=document.getElementById('s1_lesion_eval').value;
      const input=document.getElementById('s1_lesion_hospital');
      if(!input) return;
      const show = (has==='有' && evalv!=='未評估');
      input.style.display = show ? '' : 'none';
      if(!show) input.value='';
    }

    function toggleSwallow(){
      const sel=document.getElementById('s1_swallow');
      const level=sel ? sel.value : '';
      const detailOn = level && level !== '無困難';
      const sxWrap=document.getElementById('s1_swallow_sx_wrap');
      const sxHint=document.getElementById('s1_swallow_sx_hint');
      if(sxWrap){
        sxWrap.style.display = detailOn ? '' : 'none';
        if(sxHint) sxHint.style.display = detailOn ? '' : 'none';
        if(!detailOn){
          sxWrap.querySelectorAll('input[type=checkbox]').forEach(c=>{ c.checked=false; });
        }
      }
      const dietWrap=document.getElementById('s1_diet_wrap');
      if(dietWrap){
        dietWrap.style.display = detailOn ? '' : 'none';
        if(!detailOn){
          document.querySelectorAll('#s1_diet_texture_box input[type=checkbox]').forEach(c=>{ c.checked=false; });
          document.querySelectorAll('#s1_feeding_tube_box input[type=checkbox]').forEach(c=>{ c.checked=false; });
        }
      }
      refreshCheckcol('s1_swallow_sx_box');
      refreshCheckcol('s1_diet_texture_box');
      refreshCheckcol('s1_feeding_tube_box');
    }

    function toggleFallDetail(){
      const sel=document.getElementById('s1_fall_history');
      const input=document.getElementById('s1_fall_times');
      if(!sel || !input) return;
      const value=sel.value;
      const show = value==='過去1年1次' || value==='過去1年≧2次';
      input.style.display = show ? '' : 'none';
      if(!show) input.value='';
    }

    function toggleSittingSupports(){
      const sel=document.getElementById('s1_sitting_stability');
      const box=document.getElementById('s1_sitting_support_box');
      if(!sel || !box) return;
      const show = sel.value && sel.value !== '穩定';
      box.style.display = show ? '' : 'none';
      if(!show){
        box.querySelectorAll('input[type=checkbox]').forEach(c=>{ c.checked=false; });
      }
      refreshCheckcol('s1_sitting_support_box');
    }

    function togglePhoneNotes(){
      const sel=document.getElementById('s1_phone');
      const wrap=document.getElementById('s1_phone_note_wrap');
      if(!sel || !wrap) return;
      const show = sel.value && sel.value !== '會撥打與接聽';
      wrap.style.display = show ? '' : 'none';
      if(!show){
        wrap.querySelectorAll('input[type=checkbox]').forEach(c=>{ c.checked=false; });
      }
      togglePhoneNoteOther();
      refreshCheckcol('s1_phone_note_box');
    }

    function togglePhoneNoteOther(){
      const other=document.getElementById('s1_phone_note_other');
      if(!other) return;
      const on=document.querySelector('#s1_phone_note_box input[value="其他"]')?.checked;
      other.style.display = on ? '' : 'none';
      if(!on) other.value='';
    }

    function hasNightCatheterSelection(){
      return [...document.querySelectorAll('#s1_excretion_aids_box input[type=checkbox]:checked')]
        .map(x=>x.value)
        .some(v=>v==='留置導尿管' || v==='間歇導尿管' || v==='尿造口袋' || v==='糞造口袋' || v==='夜間集尿袋');
    }

    function updateNocturiaCountVisibility(){
      const wrap=document.getElementById('s1_nocturia_wrap');
      const input=document.getElementById('s1_nocturia_count');
      if(hasNightCatheterSelection()){
        if(wrap) wrap.style.display='none';
        if(input) input.value='';
        return;
      }
      const sel=document.getElementById('s1_urine_night');
      if(!wrap || !sel){
        if(wrap) wrap.style.display='none';
        if(input) input.value='';
        return;
      }
      const value=sel.value;
      const show=value && value !== '夜間未起夜';
      wrap.style.display = show ? '' : 'none';
      if(!show && input) input.value='';
    }

    function updateExcretionAidEffects(){
      const nightWrap=document.getElementById('s1_urine_night_wrap');
      const other=document.getElementById('s1_urine_night_other');
      const note=document.getElementById('s1_night_catheter_note');
      const sel=document.getElementById('s1_urine_night');
      const hasCatheter=hasNightCatheterSelection();
      if(hasCatheter){
        if(nightWrap) nightWrap.style.display='none';
        if(note) note.style.display='';
        if(sel) sel.value='';
        if(other){ other.style.display='none'; other.value=''; }
      }else{
        if(nightWrap) nightWrap.style.display='';
        if(note) note.style.display='none';
        toggleUrineOther('night');
      }
      updateNocturiaCountVisibility();
    }

    function toggleAdlHow(id){
      const sel=document.getElementById(id);
      const input=document.getElementById(id+'_how');
      if(!sel||!input) return;
      const showValues = (input.dataset.showValues || '').split(',').map(v=>v.trim()).filter(Boolean);
      let show = false;
      if(showValues.length){
        show = showValues.indexOf(sel.value) !== -1;
      }else{
        show = sel.value==='部分協助';
      }
      input.style.display = show? '':'none';
      if(!show){
        input.value='';
        input.classList.remove('input-invalid');
      }
    }

    let actionEntryCounter = 0;

    function createActionSourceSelect(){
      const select=document.createElement('select');
      select.innerHTML = `
        <option value="" class="placeholder-option" disabled selected>請選擇來源</option>
        <option value="問題">問題</option>
        <option value="目標">目標</option>
        <option value="服務項目">服務項目</option>
      `;
      return select;
    }

    function updateActionRemoveButtons(){
      const host=document.getElementById('s1_actions_list');
      if(!host) return;
      const rows=[...host.querySelectorAll('.action-item')];
      rows.forEach(row=>{
        const btn=row.querySelector('.action-item-controls button');
        if(btn){ btn.style.display = rows.length>1 ? '' : 'none'; }
      });
    }

    function updateActionHint(){
      const hint=document.getElementById('s1_actions_hint');
      if(!hint) return;
      const entries=readActionEntries();
      const hasContent = entries.some(entry=>entry.text);
      hint.style.display = hasContent ? 'none' : '';
    }

    function addActionEntry(data){
      const host=document.getElementById('s1_actions_list');
      if(!host) return null;
      const entry=data || {};
      const row=document.createElement('div');
      row.className='action-item';
      row.dataset.actionId=`action-${actionEntryCounter++}`;

      const fields=document.createElement('div');
      fields.className='action-item-fields';
      const select=createActionSourceSelect();
      if(entry.source){ select.value=entry.source; }
      const textarea=document.createElement('textarea');
      textarea.placeholder='請輸入具體行動，例如：已提醒家屬設定白名單，避免詐騙來電。';
      if(entry.text){ textarea.value=entry.text; }
      fields.appendChild(select);
      fields.appendChild(textarea);
      row.appendChild(fields);

      const controls=document.createElement('div');
      controls.className='action-item-controls';
      const removeBtn=document.createElement('button');
      removeBtn.type='button';
      removeBtn.className='small';
      removeBtn.textContent='移除';
      removeBtn.addEventListener('click', ()=>removeActionEntry(row));
      controls.appendChild(removeBtn);
      row.appendChild(controls);

      host.appendChild(row);

      select.addEventListener('change', ()=>{ select.classList.remove('input-invalid'); updateActionHint(); buildSection1(); });
      textarea.addEventListener('input', ()=>{ textarea.classList.remove('input-invalid'); updateActionHint(); buildSection1(); });

      updateActionRemoveButtons();
      updateActionHint();
      return row;
    }

    function removeActionEntry(row){
      if(row) row.remove();
      const host=document.getElementById('s1_actions_list');
      if(host && host.childElementCount===0){
        addActionEntry();
      }
      updateActionRemoveButtons();
      updateActionHint();
      buildSection1();
      if(!isRestoringDraft && draftLoadComplete) scheduleAutoSave();
    }

    function restoreActionEntries(list){
      const host=document.getElementById('s1_actions_list');
      if(!host) return;
      host.innerHTML='';
      actionEntryCounter = 0;
      if(Array.isArray(list) && list.length){
        list.forEach(entry=>addActionEntry(entry));
      }
      if(host.childElementCount===0){
        addActionEntry();
      }
      updateActionRemoveButtons();
      updateActionHint();
    }

    function readActionEntries(){
      const host=document.getElementById('s1_actions_list');
      if(!host) return [];
      return [...host.querySelectorAll('.action-item')].map(row=>{
        const select=row.querySelector('select');
        const textarea=row.querySelector('textarea');
        return {
          row,
          select,
          textarea,
          source:(select && select.value ? select.value.trim() : ''),
          text:(textarea && textarea.value ? textarea.value.trim() : '')
        };
      });
    }

    function collectActionEntries(){
      return readActionEntries()
        .map(entry=>({source:entry.source, text:entry.text}))
        .filter(entry=>entry.source && entry.text);
    }

    function initActionEntries(){
      const host=document.getElementById('s1_actions_list');
      if(!host) return;
      if(host.childElementCount===0){ addActionEntry(); }
      updateActionRemoveButtons();
      updateActionHint();
    }

    // 病灶症狀互斥（無不適）
    function syncNoDiscomfort(containerId){
      const box = document.getElementById(containerId);
      if(!box) return;
      const mode = box.dataset.mode || 'symptom';
      const checks = [...box.querySelectorAll('input[type=checkbox]')];
      const none = checks.find(c=>c.value==='無不適');
      const others = checks.filter(c=>c!==none);
      if(mode === 'none'){
        if(none) none.checked = true;
        others.forEach(c=>{ c.checked=false; c.disabled=true; });
        return;
      }
      others.forEach(c=>{ c.disabled=false; });
      if(none && none.checked){
        others.forEach(c=>{ c.checked=false; });
      }
      refreshCheckcol(containerId);
    }

    function updateLesionModeControls(){
      const group=document.getElementById('s1_lesion_mode');
      if(group){
        const mode=lesionSymptomMode;
        group.querySelectorAll('button').forEach(btn=>{
          const active = btn.dataset.mode === mode;
          btn.dataset.active = active ? '1' : '0';
        });
      }
      const box=document.getElementById('s1_lesion_sx_box');
      if(box){
        box.dataset.mode = lesionSymptomMode;
        box.style.display = lesionSymptomMode === 'none' ? 'none' : '';
      }
    }

    function setLesionSymptomMode(mode){
      const normalized = mode === 'symptom' ? 'symptom' : 'none';
      lesionSymptomMode = normalized;
      const box=document.getElementById('s1_lesion_sx_box');
      if(!box) return;
      box.dataset.mode = normalized;
      box.style.display = normalized === 'none' ? 'none' : '';
      const checks=[...box.querySelectorAll('input[type=checkbox]')];
      const none=checks.find(c=>c.value==='無不適');
      const others=checks.filter(c=>c!==none);
      if(normalized==='none'){
        if(none) none.checked=true;
        others.forEach(c=>{ c.checked=false; c.disabled=true; });
      }else{
        others.forEach(c=>{ c.disabled=false; });
        if(none) none.checked=false;
      }
      syncNoDiscomfort('s1_lesion_sx_box');
      updateLesionModeControls();
    }

    function getLesionSizeState(){
      const lengthInput=document.getElementById('s1_lesion_length');
      const widthInput=document.getElementById('s1_lesion_width');
      const lengthRaw=lengthInput ? lengthInput.value : '';
      const widthRaw=widthInput ? widthInput.value : '';
      const lenNum=parseFloat(lengthRaw);
      const widNum=parseFloat(widthRaw);
      const validLen=!Number.isNaN(lenNum) && lenNum>0;
      const validWid=!Number.isNaN(widNum) && widNum>0;
      const area = (validLen && validWid) ? Number((lenNum*widNum).toFixed(2)) : null;
      return { lengthRaw, widthRaw, lenNum: validLen?lenNum:null, widNum: validWid?widNum:null, area };
    }

    function updateLesionAreaDisplay(){
      const state=getLesionSizeState();
      const display=document.getElementById('s1_lesion_area_display');
      if(display){
        if(state.area!==null){
          display.textContent=`面積：${state.area.toFixed(2)} cm²`;
        }else{
          display.textContent='面積：— cm²';
        }
      }
      const hint=document.getElementById('s1_lesion_size_hint');
      if(hint){
        hint.style.display = (state.lenNum!==null && state.widNum!==null) ? 'none' : '';
      }
    }

    function buildLesionSizeText(state){
      if(!state || state.lenNum===null || state.widNum===null) return '';
      const lenText=state.lenNum.toFixed(1);
      const widText=state.widNum.toFixed(1);
      if(state.area!==null){
        return `${lenText}×${widText} cm（面積 ${state.area.toFixed(2)} cm²）`;
      }
      return `${lenText}×${widText} cm`;
    }

    function toggleTransportOther(){
      const v=document.getElementById('s1_visit_transport').value;
      document.getElementById('s1_visit_transport_other').style.display = (v==='其他')?'':'none';
    }
    function toggleUrineOther(type){
      const selId = type === 'night' ? 's1_urine_night' : 's1_urine_day';
      const inputId = type === 'night' ? 's1_urine_night_other' : 's1_urine_day_other';
      const sel=document.getElementById(selId);
      const input=document.getElementById(inputId);
      if(!sel||!input) return;
      const show = sel.value==='其他';
      input.style.display = show?'':'none';
      if(!show) input.value='';
      if(type==='night') updateNocturiaCountVisibility();
    }
    function toggleDhxOther(){
      const on = document.querySelector('#s1_dhx_box input[value="其他"]')?.checked;
      document.getElementById('s1_dhx_other').style.display = on?'':'none';
    }
    function toggleMedOther(){
      const on = document.querySelector('#s1_med_classes_box input[value="其他"]')?.checked;
      document.getElementById('s1_med_classes_other').style.display = on?'':'none';
    }
    function toggleShoppingHow(){
      const sel=document.getElementById('s1_shopping');
      const how=document.getElementById('s1_shopping_how');
      const other=document.getElementById('s1_shopping_how_other');
      if(!sel||!how||!other) return;
      const show = sel.value==='需陪同' || sel.value==='不外出';
      how.style.display = show ? '' : 'none';
      if(!show){
        how.value=''; other.style.display='none'; other.value='';
        return;
      }
      const showOther = how.value==='其他';
      other.style.display = showOther ? '' : 'none';
      if(!showOther) other.value='';
    }
    function toggleDishwashHow(){
      const sel=document.getElementById('s1_dishwash');
      const how=document.getElementById('s1_dishwash_how');
      const other=document.getElementById('s1_dishwash_how_other');
      if(!sel||!how||!other) return;
      const show = sel.value==='無法自行清洗';
      how.style.display = show ? '' : 'none';
      if(!show){
        how.value='由他人代辦'; other.style.display='none'; other.value='';
        return;
      }
      const showOther = how.value==='其他';
      other.style.display = showOther ? '' : 'none';
      if(!showOther) other.value='';
    }
    function toggleSleepReason(){
      const sleep=document.getElementById('s1_sleep').value;
      const reason=document.getElementById('s1_sleep_reason');
      const detail=document.getElementById('s1_sleep_reason_detail');
      const other=document.getElementById('s1_sleep_reason_other');
      const show = sleep !== '良好';
      reason.style.display = show ? '' : 'none';
      if(!show){
        reason.value=''; detail.style.display='none'; detail.innerHTML=''; other.style.display='none'; other.value='';
        return;
      }
      toggleSleepReasonDetail();
    }
    function toggleSleepReasonDetail(){
      const reason=document.getElementById('s1_sleep_reason').value;
      const detail=document.getElementById('s1_sleep_reason_detail');
      const other=document.getElementById('s1_sleep_reason_other');
      const list=INSOMNIA_DETAIL[reason];
      if(list){
        detail.style.display=''; detail.innerHTML='<option value="" class="placeholder-option" disabled selected>請選擇</option>';
        list.forEach(name=>{ const o=document.createElement('option'); o.textContent=name; detail.appendChild(o); });
        other.style.display='none'; other.value='';
      }else{
        detail.style.display='none'; detail.innerHTML='';
        if(reason==='其他'){ other.style.display=''; }
        else { other.style.display='none'; other.value=''; }
      }
    }
    function syncDisab(){
      if(!document.getElementById('s2_dis_level')) return;
      toggleDisCategory();
    }

    // 蒐集
    function collectChecks(containerId, otherInputId){
      const list=[...document.querySelectorAll(`#${containerId} input[type=checkbox]`)].filter(x=>x.checked).map(x=>x.value);
      if(otherInputId){
        const idx = list.indexOf('其他');
        if(idx !== -1){
          const t=(document.getElementById(otherInputId).value||'').trim();
          if(t){
            list[idx] = t;
          }else{
            list.splice(idx,1);
          }
        }
      }
      return list;
    }

    function collectHearingDetails(){
      return [...document.querySelectorAll('#s1_hearing_detail_box input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
    }

    function resetSection1Validation(){
      document.querySelectorAll('#section1_block .input-invalid').forEach(el=>el.classList.remove('input-invalid'));
      document.querySelectorAll('#section1_block .field-error').forEach(el=>{ el.textContent=''; el.dataset.show='0'; });
      const box=document.getElementById('section1_errors');
      if(box){ box.innerHTML=''; box.style.display='none'; }
      updateSection1ErrorSummary();
    }

    function updateSection1ErrorSummary(){
      const summary=document.getElementById('section1_error_summary');
      if(!summary) return;
      const messages=[];
      const manualBox=document.getElementById('section1_errors');
      if(manualBox){
        manualBox.querySelectorAll('li').forEach(li=>{
          const text=(li.textContent||'').trim();
          if(text) messages.push({ type:'text', text });
        });
      }
      const ruleBox=document.getElementById('section1_rule_errors');
      if(ruleBox){
        ruleBox.querySelectorAll('li').forEach(li=>{
          const link=li.querySelector('a');
          if(link){
            const text=(link.textContent||'').trim();
            const target=link.dataset ? link.dataset.target : '';
            if(text) messages.push({ type:'link', text, target });
          }else{
            const text=(li.textContent||'').trim();
            if(text) messages.push({ type:'text', text });
          }
        });
      }
      if(!messages.length){
        summary.innerHTML='';
        summary.dataset.show='0';
        return;
      }
      const list=document.createElement('ul');
      messages.forEach(item=>{
        const li=document.createElement('li');
        if(item.type==='link' && item.target){
          const a=document.createElement('a');
          a.href='#';
          a.textContent=item.text;
          a.dataset.target=item.target;
          a.addEventListener('click', handleRuleErrorClick);
          li.appendChild(a);
        }else{
          li.textContent=item.text;
        }
        list.appendChild(li);
      });
      summary.innerHTML='';
      summary.appendChild(list);
      summary.dataset.show='1';
    }
    function markSection1Invalid(id){
      const el=document.getElementById(id);
      if(!el) return;
      el.classList.add('input-invalid');
    }

    function setFieldError(id, message){
      const el=document.getElementById(id);
      if(!el) return;
      if(message){
        el.textContent = message;
        el.dataset.show='1';
      }else{
        el.textContent='';
        el.dataset.show='0';
      }
    }

    function collectS1(){
      const s = {};
      // 基本
      s.s1_age = document.getElementById('s1_age').value;
      s.s1_gender = document.getElementById('s1_gender').value;
      s.s1_awareness = document.getElementById('s1_awareness').value;
      s.s1_cognition = document.getElementById('s1_cognition').value;
      s.s1_lang = collectChecks('s1_lang_box');
      s.s1_lang_note = document.getElementById('s1_lang_note').value;
      // 視聽
      s.s1_vision = document.getElementById('s1_vision').value;
      s.s1_vision_note = collectChecks('s1_vision_note_box','s1_vision_other');
      s.s1_glasses_adherence = document.getElementById('s1_glasses_adherence').value;
      s.s1_hearing_level = document.getElementById('s1_hearing_level').value;
      s.s1_hearing_details = collectHearingDetails();
      s.s1_hearing_device_adherence = document.getElementById('s1_hearing_device_adherence').value;
      // 吞嚥與口腔
      s.s1_swallow = document.getElementById('s1_swallow').value;
      s.s1_swallow_sx = collectChecks('s1_swallow_sx_box');
      s.s1_diet_texture = collectChecks('s1_diet_texture_box');
      s.s1_feeding_tubes = collectChecks('s1_feeding_tube_box');
      s.s1_oral = collectChecks('s1_oral_box');
      s.s1_oral_note = document.getElementById('s1_oral_note').value;
      // 疼痛/皮膚 + 部位
      s.s1_pain = document.getElementById('s1_pain').value;
      s.s1_pain_score = document.getElementById('s1_pain_score').value;
      const painLoc = getLocationData('pain');
      s.s1_body_region = painLoc.region;
      s.s1_subregion_choice = painLoc.subChoice;
      s.s1_subregion_other = painLoc.subOther;
      s.s1_subregion = painLoc.subValue;
      s.s1_laterality = painLoc.laterality;

      s.s1_lesion_has = document.getElementById('s1_lesion_has').value;
      const lesionLoc = getLocationData('lesion');
      s.s1_lesion_region = lesionLoc.region;
      s.s1_lesion_subregion_choice = lesionLoc.subChoice;
      s.s1_lesion_subregion_other = lesionLoc.subOther;
      s.s1_lesion_subregion = lesionLoc.subValue;
      s.s1_lesion_laterality = lesionLoc.laterality;
      let layer = document.getElementById('s1_lesion_layer').value;
      if(layer==='其他'){
        const lo=(document.getElementById('s1_lesion_layer_other').value||'').trim();
        layer = lo;
      }
      s.s1_lesion_layer = layer || '無';
      const lesionSizeState=getLesionSizeState();
      s.s1_lesion_length_cm = lesionSizeState.lengthRaw;
      s.s1_lesion_width_cm  = lesionSizeState.widthRaw;
      s.s1_lesion_area_cm2  = lesionSizeState.area!==null ? lesionSizeState.area.toFixed(2) : '';
      s.s1_lesion_size_text = buildLesionSizeText(lesionSizeState);
      s.s1_lesion_symptom_mode = lesionSymptomMode;
      s.s1_lesion_sx    = collectChecks('s1_lesion_sx_box');
      if(s.s1_lesion_has==='有' && Array.isArray(s.s1_lesion_sx) && s.s1_lesion_sx.length===0 && s.s1_lesion_symptom_mode !== 'symptom'){ s.s1_lesion_sx=['無不適']; }
      s.s1_lesion_eval  = document.getElementById('s1_lesion_eval').value;
      s.s1_lesion_hospital = document.getElementById('s1_lesion_hospital').value;

      // 行動/ADL/排泄
      s.s1_transfer = document.getElementById('s1_transfer').value;
      s.s1_transfer_how = document.getElementById('s1_transfer_how').value;
      s.s1_walk_indoor = document.getElementById('s1_walk_indoor').value;
      s.s1_walk_outdoor = document.getElementById('s1_walk_outdoor').value;
      s.s1_stairs = document.getElementById('s1_stairs').value;
      s.s1_weak_laterality = document.getElementById('s1_weak_laterality').value;
      s.s1_fall_history = document.getElementById('s1_fall_history').value;
      s.s1_fall_times = document.getElementById('s1_fall_times').value;
      s.s1_balance = collectChecks('s1_balance_box');
      s.s1_sitting_stability = document.getElementById('s1_sitting_stability').value;
      s.s1_sitting_supports = collectChecks('s1_sitting_support_box');
      s.s1_gait = document.getElementById('s1_gait').value;
      s.s1_gait_note = document.getElementById('s1_gait_note').value;
      s.s1_adl_eating = document.getElementById('s1_adl_eating').value;
      s.s1_adl_eating_how = document.getElementById('s1_adl_eating_how').value;
      s.s1_adl_groom = document.getElementById('s1_adl_groom').value;
      s.s1_adl_groom_how = document.getElementById('s1_adl_groom_how').value;
      s.s1_adl_bathing = document.getElementById('s1_adl_bathing').value;
      s.s1_adl_bathing_how = document.getElementById('s1_adl_bathing_how').value;
      s.s1_adl_dressing = document.getElementById('s1_adl_dressing').value;
      s.s1_adl_dressing_how = document.getElementById('s1_adl_dressing_how').value;
      s.s1_excretion_aids = collectChecks('s1_excretion_aids_box');
      const urineDaySel = document.getElementById('s1_urine_day').value;
      const urineDayOther = (document.getElementById('s1_urine_day_other').value||'').trim();
      s.s1_urine_day_choice = urineDaySel;
      s.s1_urine_day_is_other = (urineDaySel==='其他' && !!urineDayOther);
      s.s1_urine_day_other = s.s1_urine_day_is_other ? urineDayOther : '';
      s.s1_urine_day = s.s1_urine_day_is_other ? urineDayOther : urineDaySel;

      const urineNightSel = document.getElementById('s1_urine_night').value;
      const urineNightOther = (document.getElementById('s1_urine_night_other').value||'').trim();
      s.s1_urine_night_choice = urineNightSel;
      s.s1_urine_night_is_other = (urineNightSel==='其他' && !!urineNightOther);
      s.s1_urine_night_other = s.s1_urine_night_is_other ? urineNightOther : '';
      s.s1_urine_night = s.s1_urine_night_is_other ? urineNightOther : urineNightSel;
      s.s1_nocturia_count = document.getElementById('s1_nocturia_count').value;
      s.s1_post_toilet = document.getElementById('s1_post_toilet').value;
      s.s1_post_toilet_how = document.getElementById('s1_post_toilet_how').value;

      // 生活管理
      s.s1_phone = document.getElementById('s1_phone').value;
      s.s1_phone_notes = collectChecks('s1_phone_note_box','s1_phone_note_other');
      s.s1_shopping = document.getElementById('s1_shopping').value;
      s.s1_shopping_how = document.getElementById('s1_shopping_how').value;
      s.s1_shopping_how_other = document.getElementById('s1_shopping_how_other').value;
      s.s1_meal_prep = document.getElementById('s1_meal_prep').value;
      s.s1_meal_prep_how = document.getElementById('s1_meal_prep_how').value;
      s.s1_dishwash = document.getElementById('s1_dishwash').value;
      s.s1_dishwash_how = document.getElementById('s1_dishwash_how').value;
      s.s1_dishwash_how_other = document.getElementById('s1_dishwash_how_other').value;
      s.s1_housework = document.getElementById('s1_housework').value;
      s.s1_housework_how = document.getElementById('s1_housework_how').value;
      s.s1_finance = document.getElementById('s1_finance').value;
      s.s1_finance_how = document.getElementById('s1_finance_how').value;
      s.s1_sleep = document.getElementById('s1_sleep').value;
      s.s1_sleep_reason = document.getElementById('s1_sleep_reason').value;
      s.s1_sleep_reason_detail = document.getElementById('s1_sleep_reason_detail').value;
      s.s1_sleep_reason_other = document.getElementById('s1_sleep_reason_other').value;
      s.s1_daytime = document.getElementById('s1_daytime').value;
      s.s1_emotions = collectChecks('s1_emotion_box');
      s.s1_behaviors = collectChecks('s1_behavior_box');
      s.s1_motivation = document.getElementById('s1_motivation').value;
      s.s1_devices = collectChecks('s1_devices_box');
      s.s1_devices_note = document.getElementById('s1_devices_note').value;

      // 疾病/用藥/就醫
      s.s1_dhx = collectChecks('s1_dhx_box','s1_dhx_other');
      s.s1_surgery = document.getElementById('s1_surgery').value;
      s.s1_allergy = document.getElementById('s1_allergy').value;
      s.s1_follow_clinic = document.getElementById('s1_follow_clinic').value;
      s.s1_rx_type = document.getElementById('s1_rx_type').value;
      s.s1_med_manage = document.getElementById('s1_med_manage').value;
      let vt = document.getElementById('s1_visit_transport').value;
      const vtOther = (document.getElementById('s1_visit_transport_other').value||'').trim();
      if(vt==='其他') vt = vtOther;
      s.s1_visit_transport = vt;
      s.s1_med_classes = collectChecks('s1_med_classes_box','s1_med_classes_other');

      // 身心障礙
      const disLevelEl=document.getElementById('s2_dis_level');
      const disCatEl=document.getElementById('s2_dis_cat');
      const disLevel = disLevelEl ? disLevelEl.value : '';
      let disCat = '';
      if(disLevel && disLevel !== '無' && disCatEl){
        disCat = disCatEl.value || '';
      }
      s.s1_dis_level = disLevel; // 段一身心障礙等級（讀取自段二）
      s.s1_dis_cat = disCat;     // 段一身心障礙類別（讀取自段二）

      // 補充
      s.s1_actions = collectActionEntries();
      s.s1_notes = document.getElementById('s1_notes').value;

      return s;
    }

    function validateSection1(){
      resetSection1Validation();
      const messages=[];
      const plainMessages=[];
      const addMessage=(fieldId, text)=>{
        messages.push({ fieldId: fieldId, pageId: 'goals', text: text });
        plainMessages.push(text);
      };

      const hearingDetails = collectHearingDetails();
      const needDeviceStatus = Array.isArray(hearingDetails) && hearingDetails.some(item => /助聽器|擴音/.test(item));
      if (needDeviceStatus) {
        const adherence = (document.getElementById('s1_hearing_device_adherence')?.value || '').trim();
        if (!adherence) {
          addMessage('s1_hearing_device_adherence', '請選擇助聽器/擴音使用情形');
          markSection1Invalid('s1_hearing_device_adherence');
        }
      }

      const phoneStatus = (document.getElementById('s1_phone')?.value || '').trim();
      if (phoneStatus && phoneStatus !== '會撥打與接聽') {
        const phoneChecks = [...document.querySelectorAll('#s1_phone_note_box input[type=checkbox]:checked')];
        if (!phoneChecks.length) {
          addMessage('s1_phone_note_box', '請勾選電話使用原因');
          markSection1Invalid('s1_phone_note_box');
        }
        const otherPhone = document.querySelector('#s1_phone_note_box input[value="其他"]');
        if (otherPhone && otherPhone.checked) {
          const otherVal = (document.getElementById('s1_phone_note_other')?.value || '').trim();
          if (!otherVal) {
            addMessage('s1_phone_note_other', '請填寫電話使用其他原因');
            markSection1Invalid('s1_phone_note_other');
          }
        }
      }

      const nocturiaInput=document.getElementById('s1_nocturia_count');
      const nocturiaCount=nocturiaInput ? Number(nocturiaInput.value) : 0;
      const hasNightBag=!!document.querySelector('#s1_excretion_aids_box input[value="夜間集尿袋"]:checked');
      if(!Number.isNaN(nocturiaCount) && nocturiaCount >= 1 && hasNightBag){
        addMessage('s1_nocturia_count', '夜間記錄排尿次數時不可同時勾選夜間集尿袋');
        markSection1Invalid('s1_nocturia_count');
        markSection1Invalid('s1_excretion_aids_box');
      }

      const painOn = document.getElementById('s1_pain').value === '有';
      let painScoreError='';
      let painLocationError='';
      if(painOn){
        const score = document.getElementById('s1_pain_score').value;
        const scoreNum = Number(score);
        if(!score || Number.isNaN(scoreNum) || scoreNum < 1 || scoreNum > 10){
          addMessage('s1_pain_score', '請填寫疼痛強度（1-10）');
          markSection1Invalid('s1_pain_score');
          painScoreError='請輸入 1–10 分的疼痛強度';
        }
        const painLoc = getLocationData('pain');
        let missingLocation=false;
        if(!painLoc.region){
          addMessage('s1_location_region', '請選擇疼痛部位大分類');
          switchLocationContext('pain');
          markSection1Invalid('s1_location_region');
          missingLocation=true;
        }
        if(!painLoc.subChoice){
          addMessage('s1_location_subregion', '請選擇疼痛細部分位');
          switchLocationContext('pain');
          markSection1Invalid('s1_location_subregion');
          missingLocation=true;
        }else if(painLoc.subChoice==='其他' && !painLoc.subOther){
          addMessage('s1_location_subregion_other', '請填寫疼痛細部分位（其他）');
          switchLocationContext('pain');
          markSection1Invalid('s1_location_subregion_other');
          missingLocation=true;
        }
        if(SYMMETRIC_PARTS.has(getLocationSubregionText(painLoc))){
          if(!painLoc.laterality){
            addMessage('s1_location_laterality', '請選擇疼痛側別');
            switchLocationContext('pain');
            markSection1Invalid('s1_location_laterality');
            missingLocation=true;
          }
        }
        if(missingLocation){
          painLocationError='請完整填寫疼痛部位';
        }
      }
      setFieldError('s1_pain_score_error', painOn ? painScoreError : '');
      setFieldError('s1_pain_location_error', painOn ? painLocationError : '');

      const lesionOn = document.getElementById('s1_lesion_has').value === '有';
      let lesionSizeError='';
      if(lesionOn){
        const lesionLoc = getLocationData('lesion');
        if(!lesionLoc.region){
          addMessage('s1_location_region', '請選擇病灶部位大分類');
          switchLocationContext('lesion');
          markSection1Invalid('s1_location_region');
        }
        if(!lesionLoc.subChoice){
          addMessage('s1_location_subregion', '請選擇病灶細部分位');
          switchLocationContext('lesion');
          markSection1Invalid('s1_location_subregion');
        }else if(lesionLoc.subChoice==='其他' && !lesionLoc.subOther){
          addMessage('s1_location_subregion_other', '請填寫病灶細部分位（其他）');
          switchLocationContext('lesion');
          markSection1Invalid('s1_location_subregion_other');
        }
        if(SYMMETRIC_PARTS.has(getLocationSubregionText(lesionLoc))){
          if(!lesionLoc.laterality){
            addMessage('s1_location_laterality', '請選擇病灶側別');
            switchLocationContext('lesion');
            markSection1Invalid('s1_location_laterality');
          }
        }

        const layerSel = document.getElementById('s1_lesion_layer').value;
        const layerOther = (document.getElementById('s1_lesion_layer_other').value||'').trim();
        if(!layerSel){
          addMessage('s1_lesion_layer', '請選擇病灶層次');
          markSection1Invalid('s1_lesion_layer');
        }else if(layerSel==='其他' && !layerOther){
          addMessage('s1_lesion_layer_other', '請填寫病灶層次（其他）');
          markSection1Invalid('s1_lesion_layer_other');
        }

        const sizeState=getLesionSizeState();
        if(sizeState.lenNum===null || sizeState.widNum===null){
          addMessage('s1_lesion_length', '請填寫病灶大小（長、寬）');
          if(sizeState.lenNum===null) markSection1Invalid('s1_lesion_length');
          if(sizeState.widNum===null) markSection1Invalid('s1_lesion_width');
          lesionSizeError='請輸入長度與寬度（需大於 0 cm）';
        }

        const sx = collectChecks('s1_lesion_sx_box');
        if(!Array.isArray(sx) || !sx.length){
          addMessage('s1_lesion_sx_box', '請勾選至少一項病灶症狀');
          markSection1Invalid('s1_lesion_sx_box');
        }

        const evalSel = document.getElementById('s1_lesion_eval').value;
        if(evalSel && evalSel!=='未評估'){
          const hosp = (document.getElementById('s1_lesion_hospital').value||'').trim();
          if(!hosp){
            addMessage('s1_lesion_hospital', '請填寫醫療院所名稱');
            markSection1Invalid('s1_lesion_hospital');
          }
        }
      }
      setFieldError('s1_lesion_size_error', lesionOn ? lesionSizeError : '');

      const actionEntries = readActionEntries();
      let actionError='';
      actionEntries.forEach(entry=>{
        const hasSource = !!entry.source;
        const hasText = !!entry.text;
        if(hasText && !hasSource){
          if(!actionError){ addMessage('s1_actions_list', '請為建議措施選擇來源'); }
          if(entry.select) entry.select.classList.add('input-invalid');
          actionError = actionError || '請為建議措施選擇來源';
        }else if(hasSource && !hasText){
          if(!actionError){ addMessage('s1_actions_list', '請填寫建議措施內容'); }
          if(entry.textarea) entry.textarea.classList.add('input-invalid');
          actionError = actionError || '請填寫建議措施內容';
        }
      });
      setFieldError('s1_actions_error', actionError);

      const box=document.getElementById('section1_errors');
      if(box){
        if(plainMessages.length){
          box.innerHTML = `<ul>${plainMessages.map(text=>`<li>${text}</li>`).join('')}</ul>`;
          box.style.display='';
        }else{
          box.innerHTML='';
          box.style.display='none';
        }
      }

      updateSection1ErrorSummary();

      return { ok: messages.length===0, messages };
    }

    const SECTION1_PREVIEW_META = Object.freeze([
      { key:'overview', title:'基本資料', anchor:'h3-goals-s1', fieldId:'s1_age' },
      { key:'vision', title:'視力狀態', anchor:'h3-goals-s1', fieldId:'s1_vision' },
      { key:'hearing', title:'聽力程度', anchor:'h3-goals-s1', fieldId:'s1_hearing_level' },
      { key:'painLesion', title:'疼痛與皮膚', anchor:'h3-goals-s1', fieldId:'s1_pain' },
      { key:'swallow', title:'吞嚥與飲食', anchor:'h3-goals-s1', fieldId:'s1_swallow' },
      { key:'mobility', title:'移動功能', anchor:'h3-goals-s1', fieldId:'s1_transfer' },
      { key:'adl', title:'ADL／排泄', anchor:'h3-goals-s1', fieldId:'s1_adl_eating' },
      { key:'life', title:'IADL／情緒與睡眠', anchor:'h3-goals-s1', fieldId:'s1_phone' },
      { key:'disease', title:'醫療與用藥', anchor:'h3-goals-s1', fieldId:'s1_dhx_box' },
      { key:'actions', title:'建議措施', anchor:'h3-goals-s1', fieldId:'s1_actions_list' },
      { key:'notes', title:'補充內容', anchor:'h3-goals-s1', fieldId:'s1_notes' }
    ]);

    const SECTION1_PREVIOUS_STORAGE_KEY = 'AA01.section1.previousSegments';

    const section1PreviewState = {
      segments: [],
      previous: {},
      diffOnly: false
    };

    function encodePreviewText(text){
      return escapeHtml(text || '').replace(/\n/g,'<br>');
    }

    function diffStrings(oldText, newText){
      const oldArr = Array.from(oldText || '');
      const newArr = Array.from(newText || '');
      const m = oldArr.length;
      const n = newArr.length;
      const dp = Array(m + 1);
      for(let i=0;i<=m;i++){ dp[i] = Array(n + 1).fill(0); }
      for(let i=m-1;i>=0;i--){
        for(let j=n-1;j>=0;j--){
          if(oldArr[i] === newArr[j]) dp[i][j] = dp[i+1][j+1] + 1;
          else dp[i][j] = Math.max(dp[i+1][j], dp[i][j+1]);
        }
      }
      const parts = [];
      let i=0, j=0;
      while(i<m && j<n){
        if(oldArr[i] === newArr[j]){
          parts.push({ type:'same', value: oldArr[i] });
          i++; j++;
        }else if(dp[i+1][j] >= dp[i][j+1]){
          parts.push({ type:'removed', value: oldArr[i] });
          i++;
        }else{
          parts.push({ type:'added', value: newArr[j] });
          j++;
        }
      }
      while(i<m){ parts.push({ type:'removed', value: oldArr[i++] }); }
      while(j<n){ parts.push({ type:'added', value: newArr[j++] }); }
      const chunks=[];
      parts.forEach(function(part){
        if(!chunks.length || chunks[chunks.length-1].type !== part.type){
          chunks.push({ type:part.type, value:part.value });
        }else{
          chunks[chunks.length-1].value += part.value;
        }
      });
      return chunks.map(function(chunk){
        const encoded = encodePreviewText(chunk.value);
        if(chunk.type === 'added') return `<span class="diff-add">${encoded}</span>`;
        if(chunk.type === 'removed') return `<span class="diff-del">${encoded}</span>`;
        return encoded;
      }).join('');
    }

    function buildPreviewDiff(oldText, newText){
      const oldTrim = (oldText || '').trim();
      const newTrim = (newText || '').trim();
      if(!oldTrim && !newTrim){
        return { html:'', changed:false, oldHtml:'' };
      }
      if(oldTrim === newTrim){
        return { html: encodePreviewText(newTrim), changed:false, oldHtml: encodePreviewText(oldTrim) };
      }
      if(!oldTrim && newTrim){
        return { html: `<span class="diff-add">${encodePreviewText(newTrim)}</span>`, changed:true, oldHtml:'' };
      }
      if(oldTrim && !newTrim){
        return {
          html: '<span class="diff-empty">（本段無內容）</span>',
          changed:true,
          oldHtml: `<span class="diff-del">${encodePreviewText(oldTrim)}</span>`
        };
      }
      return {
        html: diffStrings(oldTrim, newTrim),
        changed:true,
        oldHtml: encodePreviewText(oldTrim)
      };
    }

    function renderSection1Preview(segments, options){
      const container=document.getElementById('section1_preview_cards');
      if(!container) return;
      container.innerHTML='';
      const placeholder=document.createElement('div');
      placeholder.className='preview-empty';
      container.appendChild(placeholder);
      if(!Array.isArray(segments) || !segments.length){
        container.dataset.empty='1';
        placeholder.textContent = options && options.placeholder ? options.placeholder : '尚未產生預覽內容。';
        section1PreviewState.previous = section1PreviewState.previous || readSection1Previous();
        updateSection1PreviewDiffMode();
        return;
      }
      placeholder.style.display='none';
      container.dataset.empty='0';
      const previousMap = Object.assign({}, section1PreviewState.previous || readSection1Previous());
      segments.forEach(function(segment){
        const card=document.createElement('div');
        card.className='preview-card';
        card.dataset.key=segment.key;
        const diff=buildPreviewDiff(previousMap[segment.key], segment.value);
        card.dataset.changed = diff.changed ? '1' : '0';
        card.dataset.empty = segment.value ? '0' : '1';
        const header=document.createElement('div');
        header.className='preview-card-header';
        const title=document.createElement('div');
        title.className='preview-card-title';
        title.textContent=segment.title;
        header.appendChild(title);
        const actions=document.createElement('div');
        actions.className='preview-card-actions';
        const anchorBtn=document.createElement('button');
        anchorBtn.type='button';
        anchorBtn.className='small';
        anchorBtn.textContent='回到來源欄位';
        anchorBtn.addEventListener('click', function(){ jumpToField(segment.anchor, segment.fieldId); });
        actions.appendChild(anchorBtn);
        header.appendChild(actions);
        card.appendChild(header);
        const body=document.createElement('div');
        body.className='preview-card-body';
        body.innerHTML = diff.html || '<span class="diff-empty">（未填寫）</span>';
        card.appendChild(body);
        if(diff.changed && diff.oldHtml){
          const prevBox=document.createElement('div');
          prevBox.className='preview-card-previous';
          prevBox.innerHTML = '<strong>上一版：</strong>' + diff.oldHtml;
          card.appendChild(prevBox);
        }
        container.appendChild(card);
      });
      updateSection1PreviewDiffMode();
    }

    function setSection1DiffMode(enabled){
      section1PreviewState.diffOnly = !!enabled;
      updateSection1PreviewDiffMode();
    }

    function updateSection1PreviewDiffMode(){
      const container=document.getElementById('section1_preview_cards');
      if(!container) return;
      const diffOnly=!!section1PreviewState.diffOnly;
      const toggleBtn=document.getElementById('section1_diff_toggle');
      if(toggleBtn){
        toggleBtn.classList.toggle('active', diffOnly);
        toggleBtn.dataset.active = diffOnly ? '1' : '0';
      }
      const placeholder=container.querySelector('.preview-empty');
      const cards=[...container.querySelectorAll('.preview-card')];
      let visibleCount=0;
      cards.forEach(function(card){
        const changed=card.dataset.changed === '1';
        const prevBox=card.querySelector('.preview-card-previous');
        if(prevBox) prevBox.style.display = diffOnly ? '' : 'none';
        if(diffOnly && !changed){
          card.style.display='none';
        }else{
          card.style.display='';
          visibleCount++;
        }
      });
      if(!cards.length){
        container.dataset.empty='1';
        if(placeholder){ placeholder.style.display=''; }
        return;
      }
      if(diffOnly && visibleCount===0){
        container.dataset.empty='1';
        if(placeholder){
          placeholder.textContent='目前與上一版內容相同。';
          placeholder.style.display='';
        }
      }else{
        container.dataset.empty='0';
        if(placeholder){
          placeholder.textContent='尚未產生預覽內容。';
          placeholder.style.display='none';
        }
      }
    }

    function toggleSection1DiffMode(){
      section1PreviewState.diffOnly = !section1PreviewState.diffOnly;
      updateSection1PreviewDiffMode();
    }

    function readSection1Previous(){
      if(typeof window === 'undefined' || !window.localStorage) return {};
      try{
        const raw = window.localStorage.getItem(SECTION1_PREVIOUS_STORAGE_KEY);
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === 'object') return parsed;
      }catch(err){ return {}; }
      return {};
    }

    function persistSection1Previous(){
      if(typeof window === 'undefined' || !window.localStorage) return;
      const map={};
      (section1PreviewState.segments || []).forEach(function(segment){
        map[segment.key] = segment && typeof segment.value === 'string' ? segment.value : '';
      });
      try{
        window.localStorage.setItem(SECTION1_PREVIOUS_STORAGE_KEY, JSON.stringify(map));
        section1PreviewState.previous = map;
      }catch(err){ /* ignore quota errors */ }
    }

    function initSection1Preview(){
      section1PreviewState.previous = readSection1Previous();
      const toggleBtn=document.getElementById('section1_diff_toggle');
      if(toggleBtn){
        toggleBtn.addEventListener('click', ()=>toggleSection1DiffMode());
      }
      updateSection1PreviewDiffMode();
    }

    const FORM_RULES = Object.freeze([
      {
        id:'urine-night-bag',
        if:[{ field:'s1_excretion_aids', op:'includes', value:'夜間集尿袋' }],
        then:[
          { action:'hide', field:'s1_urine_night_wrap' },
          { action:'hide', field:'s1_nocturia_wrap' },
          { action:'clear', field:'s1_urine_night' },
          { action:'clear', field:'s1_urine_night_other' },
          { action:'clear', field:'s1_nocturia_count' },
          { action:'warn', message:'已勾選夜間集尿袋，夜間排尿欄位已隱藏並清空。', fields:['s1_excretion_aids_box'] }
        ]
      },
      {
        id:'nocturia-inconsistent',
        if:[
          { field:'s1_nocturia_count', op:'>=', value:1 },
          { field:'s1_urine_night', op:'in', value:['', '夜間未起夜'] }
        ],
        then:[
          { action:'block', message:'夜尿次數大於 0 時，夜間排尿不可為「夜間未起夜」，請調整。', fields:['s1_urine_night','s1_nocturia_count'] }
        ]
      },
      {
        id:'swallow-diet',
        if:[
          { field:'s1_swallow', op:'in', value:['明顯困難','危險（需專評）'] },
          { field:'s1_diet_texture', op:'includes', value:'一般' }
        ],
        then:[
          { action:'fix', field:'s1_diet_texture_box', mode:'remove', value:'一般' },
          { action:'warn', message:'吞嚥評估為明顯困難，已移除「一般」飲食質地。', fields:['s1_diet_texture_box'] }
        ]
      },
      {
        id:'swallow-tube',
        if:[
          { field:'s1_swallow', op:'=', value:'無困難' },
          { field:'s1_feeding_tubes', op:'notEmpty' }
        ],
        then:[
          { action:'warn', message:'吞嚥狀態為「無困難」，請確認是否仍需勾選管灌方式。', fields:['s1_swallow','s1_feeding_tube_box'] }
        ]
      },
      {
        id:'transfer-walk',
        if:[
          { field:'s1_transfer', op:'in', value:['重度協助','完全依賴'] },
          { field:'s1_walk_indoor', op:'in', value:['無輔具緩慢','單拐','四腳拐'] }
        ],
        then:[
          { action:'block', message:'起身移位為重度協助／完全依賴時，請確認室內行走仍標示為可行走狀態。', fields:['s1_transfer','s1_walk_indoor'] }
        ]
      }
    ]);

    const section1RuleRuntime = {
      hiddenFields: new Set(),
      invalidFields: new Set(),
      warnings: [],
      blocks: []
    };

    function resetSection1RuleEffects(){
      Array.from(section1RuleRuntime.hiddenFields).forEach(function(fieldId){
        hideRuleField(fieldId, false);
      });
      section1RuleRuntime.hiddenFields.clear();
      Array.from(section1RuleRuntime.invalidFields).forEach(function(fieldId){
        markRuleInvalid(fieldId, false);
      });
      section1RuleRuntime.invalidFields.clear();
      section1RuleRuntime.warnings = [];
      section1RuleRuntime.blocks = [];
      renderSection1RuleMessages([]);
      clearRuleWarningToast();
    }

    function hideRuleField(fieldId, hidden){
      const el=document.getElementById(fieldId);
      if(!el) return;
      if(hidden){
        if(!section1RuleRuntime.hiddenFields.has(fieldId)){
          el.dataset.rulePrevDisplay = el.style.display || '';
          el.style.display='none';
          el.dataset.ruleHidden='1';
          section1RuleRuntime.hiddenFields.add(fieldId);
        }
      }else{
        if(section1RuleRuntime.hiddenFields.has(fieldId)){
          const prev = el.dataset.rulePrevDisplay;
          el.style.display = typeof prev === 'undefined' ? '' : prev;
          delete el.dataset.rulePrevDisplay;
          delete el.dataset.ruleHidden;
          section1RuleRuntime.hiddenFields.delete(fieldId);
        }
      }
    }

    function cssEscapeValue(value){
      return String(value).replace(/(["\\])/g,'\\$1');
    }

    function clearRuleField(fieldId){
      const el=document.getElementById(fieldId);
      if(!el) return false;
      let mutated=false;
      if(el.matches && el.matches('input[type=checkbox], input[type=radio]')){
        if(el.checked){ el.checked=false; mutated=true; }
      }else if(el.matches && el.matches('select')){
        if(el.value){ el.value=''; mutated=true; }
      }else if(el.matches && el.matches('input, textarea')){
        if(el.value){ el.value=''; mutated=true; }
      }else{
        const inputs=el.querySelectorAll('input[type=checkbox], input[type=radio]');
        inputs.forEach(function(input){
          if(input.checked){ input.checked=false; mutated=true; }
        });
        const textInputs=el.querySelectorAll('input:not([type=checkbox]):not([type=radio]), textarea, select');
        textInputs.forEach(function(input){
          if(input.value){ input.value=''; mutated=true; }
        });
      }
      return mutated;
    }

    function applyRuleFix(action){
      if(!action || !action.field) return false;
      if(action.mode === 'remove'){
        const host=document.getElementById(action.field);
        if(!host) return false;
        const selector='input[type=checkbox][value="' + cssEscapeValue(action.value) + '"]';
        let changed=false;
        host.querySelectorAll(selector).forEach(function(box){
          if(box.checked){ box.checked=false; changed=true; }
        });
        return changed;
      }
      if(action.mode === 'set'){
        const el=document.getElementById(action.field);
        if(!el) return false;
        if(el.matches && el.matches('select')){
          if(el.value !== action.value){ el.value = action.value; return true; }
        }else if(el.matches && el.matches('input, textarea')){
          if(el.value !== action.value){ el.value = action.value; return true; }
        }
      }
      return false;
    }

    function markRuleInvalid(fieldId, invalid){
      const el=document.getElementById(fieldId);
      if(!el) return;
      let target=el;
      if(!target.classList){
        target = el.querySelector('input,select,textarea');
      }
      if(target && target.classList){
        if(invalid){
          target.classList.add('rule-invalid');
          section1RuleRuntime.invalidFields.add(fieldId);
        }else{
          target.classList.remove('rule-invalid');
          section1RuleRuntime.invalidFields.delete(fieldId);
        }
      }
    }

    function getRuleFieldValue(state, key){
      if(!state || !key) return undefined;
      return state[key];
    }

    function evaluateRuleCondition(state, condition){
      if(!condition) return true;
      const current = getRuleFieldValue(state, condition.field);
      const op = condition.op || '=';
      const expected = condition.value;
      switch(op){
        case '=':
          return current === expected;
        case '!=':
          return current !== expected;
        case 'includes':
          return Array.isArray(current) ? current.indexOf(expected) !== -1 : false;
        case 'notIncludes':
          return Array.isArray(current) ? current.indexOf(expected) === -1 : true;
        case 'in':
          return Array.isArray(expected) ? expected.indexOf(current) !== -1 : false;
        case '>=':
          return Number(current) >= Number(expected);
        case '>':
          return Number(current) > Number(expected);
        case '<=':
          return Number(current) <= Number(expected);
        case '<':
          return Number(current) < Number(expected);
        case 'notEmpty':
          if(Array.isArray(current)) return current.length > 0;
          if(current === undefined || current === null) return false;
          return String(current).trim() !== '';
        case 'empty':
          if(Array.isArray(current)) return current.length === 0;
          if(current === undefined || current === null) return true;
          return String(current).trim() === '';
        default:
          return false;
      }
    }

    function applyRuleAction(rule, action, state, runtime){
      if(!action) return;
      switch(action.action){
        case 'hide':
          hideRuleField(action.field, true);
          break;
        case 'clear':
          if(clearRuleField(action.field)) runtime.mutated = true;
          break;
        case 'fix':
          if(applyRuleFix(action)) runtime.mutated = true;
          break;
        case 'warn':
          runtime.warnings.push({
            ruleId: rule.id,
            message: action.message || '',
            fields: Array.isArray(action.fields) ? action.fields.slice() : (action.field ? [action.field] : [])
          });
          break;
        case 'block':
          const blockFields = Array.isArray(action.fields) ? action.fields.slice() : (action.field ? [action.field] : []);
          blockFields.forEach(function(fieldId){ markRuleInvalid(fieldId, true); });
          runtime.blocks.push({
            ruleId: rule.id,
            message: action.message || '',
            fields: blockFields
          });
          break;
      }
    }

    function renderSection1RuleMessages(blocks){
      const box=document.getElementById('section1_rule_errors');
      if(!box) return;
      box.innerHTML='';
      if(!Array.isArray(blocks) || !blocks.length){
        box.style.display='none';
        box.dataset.show='0';
        updateSection1ErrorSummary();
        return;
      }
      const itemsHtml = blocks.map(function(block){
        const target = block.fields && block.fields[0] ? escapeHtml(block.fields[0]) : '';
        const text = escapeHtml(block.message || '請確認欄位內容');
        return `<li><a href="#" data-target="${target}">${text}</a></li>`;
      }).join('');
      box.innerHTML = `<ul>${itemsHtml}</ul>`;
      box.style.display='';
      box.dataset.show='1';
      box.querySelectorAll('a').forEach(function(link){
        link.addEventListener('click', handleRuleErrorClick);
      });
      updateSection1ErrorSummary();
    }

    function handleRuleErrorClick(evt){
      if(evt) evt.preventDefault();
      const link = evt && evt.currentTarget ? evt.currentTarget : null;
      if(!link) return;
      const targetId = link.dataset.target || '';
      const targetEl = targetId ? document.getElementById(targetId) : null;
      if(targetEl && blockIfPlanGroupLocked(targetEl)) return;
      const step = resolveWizardStepForField(targetId);
      if(step && isWizardStepLocked(step)){
        handleWizardStepLocked(step);
        return;
      }
      if(step){
        if(!setCurrentWizardStep(step, { scroll:false })){
          return;
        }
      }else{
        setActivePage('goals');
      }
      focusErrorTarget(targetId);
    }

    function showRuleWarningToast(message, warn){
      const toast=document.getElementById('validationToast');
      if(!toast) return;
      const activeType = toast.dataset.type || '';
      if(toast.dataset.show === '1' && activeType !== 'warn') return;
      const target = warn && warn.fields && warn.fields[0] ? warn.fields[0] : '';
      const step = resolveWizardStepForField(target);
      showValidationToast({ type:'warn', message: message || '請檢查欄位內容。', target: target, page:'goals', step: step });
    }

    function clearRuleWarningToast(){
      const toast=document.getElementById('validationToast');
      if(!toast) return;
      if(toast.dataset.show === '1' && toast.dataset.type === 'warn'){
        hideValidationToast();
      }
    }

    function applyRules(formState){
      resetSection1RuleEffects();
      const runtime = { mutated:false, warnings:[], blocks:[] };
      FORM_RULES.forEach(function(rule){
        if(!rule || !rule.then) return;
        const matches = (rule.if || []).every(function(condition){
          return evaluateRuleCondition(formState, condition);
        });
        if(matches){
          (rule.then || []).forEach(function(action){
            applyRuleAction(rule, action, formState, runtime);
          });
        }
      });
      section1RuleRuntime.blocks = runtime.blocks.slice();
      section1RuleRuntime.warnings = runtime.warnings.slice();
      renderSection1RuleMessages(section1RuleRuntime.blocks);
      if(section1RuleRuntime.warnings.length && !section1RuleRuntime.blocks.length){
        showRuleWarningToast(section1RuleRuntime.warnings[0].message, section1RuleRuntime.warnings[0]);
      }else{
        clearRuleWarningToast();
      }
      return runtime;
    }

    function runSection1Rules(){
      let state = collectS1();
      let result = applyRules(state);
      if(result && result.mutated){
        state = collectS1();
        result = applyRules(state);
      }
      return state;
    }

    function initFormRules(){
      section1RuleRuntime.hiddenFields = new Set();
      section1RuleRuntime.invalidFields = new Set();
      section1RuleRuntime.warnings = [];
      section1RuleRuntime.blocks = [];
      runSection1Rules();
    }

    function jumpToField(anchorId, focusId){
      if(!anchorId && !focusId) return;
      const anchorEl = anchorId ? document.getElementById(anchorId) : null;
      const focusElCandidate = focusId ? document.getElementById(focusId) : null;
      const targetEl = anchorEl || focusElCandidate;
      if(!targetEl){
        const fallbackPage = anchorId ? (document.getElementById(anchorId)?.closest('.page-section')?.dataset.page || 'goals') : 'goals';
        setActivePage(fallbackPage || 'goals');
        return;
      }
      if(blockIfPlanGroupLocked(targetEl)) return;
      const step = resolveWizardStepForElement(targetEl);
      if(step && isWizardStepLocked(step)){
        handleWizardStepLocked(step);
        return;
      }
      const section = targetEl.closest ? targetEl.closest('.page-section') : null;
      let pageId = section && section.dataset ? section.dataset.page : '';
      if(!pageId && anchorEl){
        const anchorSection = anchorEl.closest ? anchorEl.closest('.page-section') : null;
        pageId = anchorSection && anchorSection.dataset ? anchorSection.dataset.page : '';
      }
      const performScroll = ()=>{
        let anchorNode = null;
        if(anchorId){
          anchorNode = document.getElementById(anchorId);
        }
        if(anchorNode){
          focusSectionGroupByElement(anchorNode);
        }else{
          focusSectionGroupByElement(targetEl);
        }
        if(anchorNode){
          scrollToAnchorId(anchorId);
        }else if(targetEl.scrollIntoView){
          targetEl.scrollIntoView({ behavior:'smooth', block:'start' });
        }else{
          const rect = targetEl.getBoundingClientRect();
          const offset = Math.max(0, currentScrollOffset || 0);
          const top = window.pageYOffset + rect.top - offset;
          window.scrollTo({ top: top < 0 ? 0 : top, behavior:'smooth' });
        }
        let focusTarget = focusElCandidate || null;
        if(!focusTarget){
          if(targetEl.matches && targetEl.matches('input,select,textarea,button,[tabindex]')){
            focusTarget = targetEl;
          }else{
            focusTarget = targetEl.querySelector ? targetEl.querySelector('input,select,textarea,button,[tabindex]') : null;
          }
        }
        if(focusTarget && typeof focusTarget.focus === 'function'){
          focusTarget.focus({ preventScroll:true });
        }
      };
      const scheduleScroll = ()=>{ window.requestAnimationFrame(performScroll); };
      if(step){
        if(!setCurrentWizardStep(step, { scroll:false })){
          return;
        }
        scheduleScroll();
        return;
      }
      const desiredPage = pageId || 'goals';
      if(desiredPage !== currentPageId){
        if(setActivePage(desiredPage) === false){
          return;
        }
        scheduleScroll();
      }else{
        performScroll();
      }
    }


    // 產文（新版）
    function buildSection1Text_v2(s) {
      const has = v => {
        if(Array.isArray(v)) return v.length > 0;
        return v !== undefined && v !== null && String(v).trim() !== "";
      };
      const join = arr => arr.filter(Boolean).join("，");
      const listCN = arr => arr.filter(Boolean).join("、");
      const sexWord = g => g === "男" ? "男性" : g === "女" ? "女性" : (g || "");
      function formatLocation(region, subChoice, subValue, subOther, laterality) {
        const parts = [];
        if (has(region)) parts.push(region);
        let subText = '';
        if (subChoice === '其他') {
          subText = has(subOther) ? `其他（${subOther}）` : '其他';
        } else {
          subText = subValue;
        }
        if (has(subText)) parts.push(subText);
        let text = parts.join('－');
        if (has(laterality)) text += `（${laterality}）`;
        return text;
      }
      function formatUrination(choice, isOther, value, extra) {
        if (isOther) {
          return has(value) ? `其他（${value}）` : '其他';
        }
        let text = choice || value || '';
        if (has(extra) && text && text !== '夜間未起夜') {
          text += `（夜尿 ${extra} 次）`;
        }
        return text;
      }
      function formatFallHistory(history, times) {
        if (!has(history)) return '';
        const count = has(times) ? Number(times) : NaN;
        switch (String(history)) {
          case '無':
            return '近一年無跌倒紀錄';
          case '過去1年1次':
            if (!Number.isNaN(count) && count > 0) return `過去一年曾跌倒${count}次`;
            return '過去一年曾跌倒1次';
          case '過去1年≧2次':
            if (!Number.isNaN(count) && count > 0) return `過去一年曾跌倒${count}次`;
            return '過去一年跌倒兩次以上';
          case '不明':
            return '跌倒史不明';
          default:
            return `跌倒史：${history}`;
        }
      }

      const EXCRETION_OUTPUT_MAP = {
        '紙尿褲': '使用紙尿褲',
        '尿墊': '使用尿墊',
        '便盆椅': '排泄依靠便盆椅',
        '尿壺': '使用尿壺協助排尿',
        '留置導尿管': '以留置導尿管排尿',
        '間歇導尿管': '以間歇導尿管排尿',
        '尿造口袋': '使用尿造口袋收集尿液',
        '糞造口袋': '使用糞造口袋收集排泄物',
        '夜間集尿袋': '夜間需使用集尿袋'
      };
      function formatExcretionAids(list) {
        const arr = Array.isArray(list) ? list : [];
        return arr.map(item => EXCRETION_OUTPUT_MAP[item] || `使用${item}`);
      }

      const DEVICE_OUTPUT_MAP = {
        '鼻胃管': '目前以鼻胃管進食',
        '胃造口管（PEG）': '使用胃造口管餵食',
        '氣切管': '留置氣切管維持呼吸道暢通',
        '鼻導管氧氣': '使用鼻導管給氧',
        '氧氣機': '使用氧氣機輔助呼吸',
        '中心靜脈導管': '留置中心靜脈導管',
        'PICC 導管': '留置 PICC 導管',
        '呼吸輔助器（CPAP）': '持續使用 CPAP 呼吸輔助器',
        '雙水平呼吸器（BiPAP）': '持續使用 BiPAP 呼吸輔助器',
        '血糖機': '透過血糖機監測血糖',
        '藥盒': '使用藥盒管理用藥'
      };
      function formatDeviceUsage(list, note) {
        const arr = Array.isArray(list) ? list : [];
        const sentences = arr.map(item => DEVICE_OUTPUT_MAP[item] || item);
        if (sentences.length && has(note)) {
          sentences[sentences.length - 1] += `（${note}）`;
        } else if (!sentences.length && has(note)) {
          sentences.push(note);
        }
        return sentences;
      }

      const PHONE_STATUS_TEXT = {
        '會撥打與接聽': '電話操作無困難',
        '僅能接聽': '僅能接聽電話，不會撥打',
        '不會使用': '電話使用困難'
      };
      const PHONE_NOTE_TEXT = {
        '重聽需擴音': '需擴音設備',
        '易受詐騙': '曾多次受詐騙電話干擾'
      };
      function formatPhoneUsage(status, notes) {
        if (!has(status)) return '';
        const base = PHONE_STATUS_TEXT[status] || `電話${status}`;
        const extras = (Array.isArray(notes) ? notes : []).map(note => PHONE_NOTE_TEXT[note] || note);
        if (extras.length) {
          return `${base}，${extras.join('，')}`;
        }
        return base;
      }

      function phraseAwareness(v) {
        if (!has(v)) return "";
        switch (String(v)) {
          case "清楚": return "意識清楚";
          case "遲鈍": return "意識遲鈍";
          case "混亂": return "意識混亂";
          case "模糊": return "意識模糊";
          case "嗜睡": return "呈嗜睡狀態";
          case "昏迷": return "呈昏迷狀態";
          default: return `意識${v}`;
        }
      }
      function phraseCognition(v) {
        if (!has(v)) return "";
        switch (String(v)) {
          case "清楚可應答":     return "認知清楚可應答";
          case "需重複或放慢":   return "認知需重複或放慢";
          case "健忘／短期記憶不佳": return "認知健忘明顯";
          case "表達或理解困難": return "表達或理解困難";
          case "無法溝通":       return "無法溝通";
          case "無法評估":       return "認知狀態無法評估";
          default:               return `認知${v}`;
        }
      }
      function phraseVision(v) {
        if (!has(v)) return "";
        switch (String(v)) {
          case "視力清晰": return "視力清晰";
          case "靠近才能辨識": return "辨識時需額外光源及靠近物體";
          case "即使配戴眼鏡，仍難以辨識": return "即使配戴眼鏡，仍難以辨識";
          case "僅能分辨明暗，無法辨識人臉或物體輪廓": return "僅能分辨明暗，無法辨識人臉或物體輪廓";
          case "完全失去視覺功能，無法感知光線": return "完全失去視覺功能，無法感知光線";
          default: return v;
        }
      }

      // ① 基本
      const header = [];
      if (has(s.s1_age) || has(s.s1_gender)) header.push(`${s.s1_age||""}歲${sexWord(s.s1_gender)||""}`);
      const aw = phraseAwareness(s.s1_awareness);
      const cg = phraseCognition(s.s1_cognition);
      if (aw || cg) header.push([aw, cg].filter(Boolean).join("，"));
      const langArr = Array.isArray(s.s1_lang) ? s.s1_lang : [];
      if (langArr.length) {
        let langText = `溝通以${listCN(langArr)}為主`;
        if (has(s.s1_lang_note)) langText += `（${s.s1_lang_note}）`;
        header.push(langText);
      }
      const p1 = header.join("，");

      // ② 視聽
      let visionPhrase = phraseVision(s.s1_vision);
      const vNotesRaw = [].concat(Array.isArray(s.s1_vision_note) ? s.s1_vision_note : (has(s.s1_vision_note) ? [s.s1_vision_note] : []));
      const vNotes = vNotesRaw.map(note=>{
        if (note === '配戴眼鏡' && has(s.s1_glasses_adherence)) {
          return `${note}（${s.s1_glasses_adherence}）`;
        }
        return note;
      });
      if (visionPhrase && vNotes.length) visionPhrase += `（${listCN(vNotes)}）`;
      let hearingPhrase = '';
      if (has(s.s1_hearing_level)) {
        hearingPhrase = `聽力${s.s1_hearing_level}`;
        const hearingDetails = Array.isArray(s.s1_hearing_details) ? s.s1_hearing_details.slice() : [];
        if (hearingDetails.length && has(s.s1_hearing_device_adherence)){
          for (let i=0;i<hearingDetails.length;i++){
            const detail = hearingDetails[i];
            if(detail==='借助助聽器才能理解' || detail==='使用擴音設備'){
              hearingDetails[i] = `${detail}（${s.s1_hearing_device_adherence}）`;
            }
          }
        }
        if (hearingDetails.length){
          hearingPhrase += `（${listCN(hearingDetails)}）`;
        }
      }
      // ③ 疼痛/皮膚（合併）
      const painBits = [];
      if (String(s.s1_pain) === "有") {
        const painSite = formatLocation(
          s.s1_body_region,
          s.s1_subregion_choice,
          s.s1_subregion,
          s.s1_subregion_other,
          s.s1_laterality
        );
        painBits.push(`${painSite || '部位'}疼痛`);
        if (has(s.s1_pain_score)) painBits.push(`疼痛強度約 ${s.s1_pain_score}/10`);
      }
      const lesionBits = [];
      if (String(s.s1_lesion_has) === "有") {
        const lesionSite = formatLocation(
          s.s1_lesion_region,
          s.s1_lesion_subregion_choice,
          s.s1_lesion_subregion,
          s.s1_lesion_subregion_other,
          s.s1_lesion_laterality
        );
        const layer = has(s.s1_lesion_layer) ? s.s1_lesion_layer : '無';
        const size  = has(s.s1_lesion_size_text) ? s.s1_lesion_size_text : '無';
        const sxArr = Array.isArray(s.s1_lesion_sx) ? s.s1_lesion_sx : [];
        const sxTxt = sxArr.length ? listCN(sxArr) : '無不適';
        if (lesionSite) lesionBits.push(`病灶位於${lesionSite}`);
        lesionBits.push(`病灶層次：${layer}`);
        lesionBits.push(`大小：${size}`);
        lesionBits.push(`症狀：${sxTxt}`);
        lesionBits.push(`醫療評估：${s.s1_lesion_eval||'未評估'}`);
        if (has(s.s1_lesion_hospital) && s.s1_lesion_eval && s.s1_lesion_eval!=='未評估') {
          lesionBits.push(`醫療院所名稱：${s.s1_lesion_hospital}`);
        }
      }
      const p3 = [painBits.join('，'), lesionBits.join('，')].filter(Boolean).join('；');

      // 吞嚥/飲食/口腔
      const swallowBits=[];
      if (has(s.s1_swallow)) {
        let txt = `吞嚥${s.s1_swallow}`;
        if (s.s1_swallow !== '無困難') {
          const sxArr = Array.isArray(s.s1_swallow_sx) ? s.s1_swallow_sx : [];
          if (sxArr.length) txt += `（${listCN(sxArr)}）`;
        }
        swallowBits.push(txt);
      }
      const dietBits=[];
      const dietArr = Array.isArray(s.s1_diet_texture) ? s.s1_diet_texture : [];
      if (dietArr.length) dietBits.push(`飲食質地：${listCN(dietArr)}`);
      const tubeArr = Array.isArray(s.s1_feeding_tubes) ? s.s1_feeding_tubes : [];
      if (tubeArr.length) dietBits.push(`管灌方式：${listCN(tubeArr)}`);
      if (dietBits.length) swallowBits.push(dietBits.join('，'));
      const oralArr = Array.isArray(s.s1_oral) ? s.s1_oral : [];
      if (oralArr.length) {
        let oralText = `口腔狀況：${listCN(oralArr)}`;
        if (has(s.s1_oral_note)) oralText += `（${s.s1_oral_note}）`;
        swallowBits.push(oralText);
      }
      const pSwallow = swallowBits.join('；');

      // ④ 行動
      const moveBits=[];
      if (has(s.s1_transfer)) {
        let txt=`起身移位${s.s1_transfer}`;
        if((s.s1_transfer==='中度協助' || s.s1_transfer==='重度協助') && has(s.s1_transfer_how)){
          txt+=`（協助方式：${s.s1_transfer_how}）`;
        }
        moveBits.push(txt);
      }
      if (has(s.s1_walk_indoor)) moveBits.push(`在家${s.s1_walk_indoor}行走`);
      if (has(s.s1_walk_outdoor)) moveBits.push(`外出${s.s1_walk_outdoor}輔助`);
      if (has(s.s1_stairs)) moveBits.push(`上下樓${s.s1_stairs}`);
      if (has(s.s1_weak_laterality) && s.s1_weak_laterality !== '無') {
        moveBits.push(`偏側無力：${s.s1_weak_laterality}`);
      }
      const fallText = formatFallHistory(s.s1_fall_history, s.s1_fall_times);
      if (has(fallText)) moveBits.push(fallText);
      const balanceArr = Array.isArray(s.s1_balance) ? s.s1_balance : [];
      if (balanceArr.length) moveBits.push(`平衡狀態：${listCN(balanceArr)}`);
      if (has(s.s1_sitting_stability)) {
        let sitText = s.s1_sitting_stability === '穩定' ? '坐姿穩定' : `坐姿${s.s1_sitting_stability}`;
        const supportArr = Array.isArray(s.s1_sitting_supports) ? s.s1_sitting_supports : [];
        if (supportArr.length) sitText += `，需${listCN(supportArr)}`;
        moveBits.push(sitText);
      }
      if (has(s.s1_gait)) {
        let gaitText = s.s1_gait;
        if (gaitText === '其他' && has(s.s1_gait_note)) {
          gaitText = s.s1_gait_note;
        } else if (has(s.s1_gait_note)) {
          gaitText += `（${s.s1_gait_note}）`;
        }
        moveBits.push(`步態${gaitText}`);
      }
      const p4 = moveBits.join("，");

      // ⑤ ADL/排泄
      const adlBits=[];
      if (has(s.s1_adl_eating)){
        let txt=`進食${s.s1_adl_eating}`;
        if(s.s1_adl_eating==='部分協助' && has(s.s1_adl_eating_how)) txt+=`（部分協助方式：${s.s1_adl_eating_how}）`;
        adlBits.push(txt);
      }
      const adlSubArr=[];
      if (has(s.s1_adl_groom)){
        let txt=`刷牙/洗臉${s.s1_adl_groom}`;
        if(s.s1_adl_groom==='部分協助' && has(s.s1_adl_groom_how)) txt+=`（部分協助方式：${s.s1_adl_groom_how}）`;
        adlSubArr.push(txt);
      }
      if (has(s.s1_adl_bathing)){
        let txt=`洗澡${s.s1_adl_bathing}`;
        if(s.s1_adl_bathing==='部分協助' && has(s.s1_adl_bathing_how)) txt+=`（部分協助方式：${s.s1_adl_bathing_how}）`;
        adlSubArr.push(txt);
      }
      if (has(s.s1_adl_dressing)){
        let txt=`穿脫衣${s.s1_adl_dressing}`;
        if(s.s1_adl_dressing==='部分協助' && has(s.s1_adl_dressing_how)) txt+=`（部分協助方式：${s.s1_adl_dressing_how}）`;
        adlSubArr.push(txt);
      }
      const adlSub=adlSubArr.join("、");
      if (adlSub) adlBits.push(adlSub);
      const deviceArr = Array.isArray(s.s1_devices) ? s.s1_devices : [];
      const deviceSentences = formatDeviceUsage(deviceArr, s.s1_devices_note);
      if (deviceSentences.length) {
        adlBits.push(deviceSentences.join('、'));
      }
      const toiletBits=[];
      const dayUrine = formatUrination(s.s1_urine_day_choice, s.s1_urine_day_is_other, s.s1_urine_day);
      const excretionArr = Array.isArray(s.s1_excretion_aids) ? s.s1_excretion_aids : [];
      const nightCatheter = excretionArr.some(v=>['留置導尿管','間歇導尿管','尿造口袋','糞造口袋','夜間集尿袋'].includes(v));
      const excretionSentences = formatExcretionAids(excretionArr);
      if (excretionSentences.length) toiletBits.push(excretionSentences.join('、'));
      if (has(dayUrine)) toiletBits.push(`白天排尿${dayUrine}`);
      if (nightCatheter) {
        toiletBits.push('夜間以導尿／集尿袋處理，不以起夜次數評估');
      } else {
        const nightUrine = formatUrination(s.s1_urine_night_choice, s.s1_urine_night_is_other, s.s1_urine_night, s.s1_nocturia_count);
        if (has(nightUrine)) toiletBits.push(`夜間排尿${nightUrine}`);
      }
      if (has(s.s1_post_toilet)){
        let txt=`如廁後清潔${s.s1_post_toilet}`;
        if(s.s1_post_toilet==='部分協助' && has(s.s1_post_toilet_how)) txt+=`（部分協助方式：${s.s1_post_toilet_how}）`;
        toiletBits.push(txt);
      }
      const p5 = [adlBits.join("；"), toiletBits.join("，")].filter(Boolean).join("；");

      // ⑥ 生活管理/睡眠
      const lifeBits=[];
      if (has(s.s1_phone)) {
        const phoneArr = Array.isArray(s.s1_phone_notes) ? s.s1_phone_notes : [];
        const phoneText = formatPhoneUsage(s.s1_phone, phoneArr);
        if (has(phoneText)) lifeBits.push(phoneText);
      }
      if (has(s.s1_shopping)){
        let shopping = s.s1_shopping;
        if((shopping==='需陪同' || shopping==='不外出') && has(s.s1_shopping_how)){
          let how = s.s1_shopping_how;
          if(how==='其他' && has(s.s1_shopping_how_other)) how = s.s1_shopping_how_other;
          if(has(how)) shopping += `（${how}）`;
        }
        lifeBits.push(`外出購物${shopping}`);
      }
      const mealBits=[];
      if (has(s.s1_meal_prep)){
        let txt=`備餐${s.s1_meal_prep}`;
        if(s.s1_meal_prep==='部分協助' && has(s.s1_meal_prep_how)) txt+=`（部分協助方式：${s.s1_meal_prep_how}）`;
        mealBits.push(txt);
      }
      if (has(s.s1_dishwash)){
        if(s.s1_dishwash==='無法自行清洗'){
          let how = s.s1_dishwash_how;
          if(how==='其他' && has(s.s1_dishwash_how_other)) how = s.s1_dishwash_how_other;
          if(!has(how)) how='由他人代辦';
          mealBits.push(`無法自行清洗餐具（${how}）`);
        }else{
          mealBits.push(`餐具清洗${s.s1_dishwash}`);
        }
      }
      if (has(s.s1_housework)){
        let txt=`家務整理${s.s1_housework}`;
        if(s.s1_housework==='部分協助' && has(s.s1_housework_how)) txt+=`（部分協助方式：${s.s1_housework_how}）`;
        mealBits.push(txt);
      }
      if (mealBits.length) lifeBits.push(mealBits.join("、"));
      if (has(s.s1_finance)){
        let txt=`具金錢觀念，財務管理${s.s1_finance}`;
        if(s.s1_finance==='部分協助' && has(s.s1_finance_how)) txt+=`（部分協助方式：${s.s1_finance_how}）`;
        lifeBits.push(txt);
      }
      if (has(s.s1_sleep)){
        let sleep = s.s1_sleep;
        if(s.s1_sleep!=='良好' && has(s.s1_sleep_reason)){
          let reason = s.s1_sleep_reason;
          if(reason==='其他' && has(s.s1_sleep_reason_other)){
            reason = s.s1_sleep_reason_other;
          }else if(has(s.s1_sleep_reason_detail)){
            reason += `：${s.s1_sleep_reason_detail}`;
          }
          sleep += `（${reason}）`;
        }
        lifeBits.push(`睡眠${sleep}`);
      }
      if (has(s.s1_daytime)) lifeBits.push(`白天活動以${s.s1_daytime}為主`);
      const emotionArr = Array.isArray(s.s1_emotions) ? s.s1_emotions : [];
      if (emotionArr.length) lifeBits.push(`情緒狀態：${listCN(emotionArr)}`);
      const behaviorArr = Array.isArray(s.s1_behaviors) ? s.s1_behaviors : [];
      if (behaviorArr.length) lifeBits.push(`行為表現：${listCN(behaviorArr)}`);
      if (has(s.s1_motivation)) lifeBits.push(`執行動機：${s.s1_motivation}`);
      const p6 = lifeBits.join("，");

      // ⑦ 疾病/用藥/就醫
      const dxArr = Array.isArray(s.s1_dhx)? s.s1_dhx : (has(s.s1_dhx)?[s.s1_dhx]:[]);
      const medArr= Array.isArray(s.s1_med_classes)? s.s1_med_classes : (has(s.s1_med_classes)?[s.s1_med_classes]:[]);
      const rxBits = [s.s1_rx_type, medArr.length ? listCN(medArr) : null].filter(Boolean);
      const p7 = join([
        dxArr.length ? `慢性病史包含：${listCN(dxArr)}` : null,
        has(s.s1_surgery) ? s.s1_surgery : null,
        (has(s.s1_follow_clinic)||rxBits.length)
          ? `定期於${s.s1_follow_clinic||"既定醫療院所"}就醫${rxBits.length?`（${rxBits.join("、")}）`:''}` : null,
        (has(s.s1_med_manage)||has(s.s1_visit_transport))
          ? `平時${s.s1_med_manage||""}，並以${s.s1_visit_transport||"既定方式"}就醫` : null
      ]);

      // ⑧ 身心障礙資訊移至經濟收入段落，故此不輸出
      const p8 = "";

      // ⑨ 補充（有才輸出）
      const p9 = has(s.s1_notes) ? s.s1_notes : "";
      function formatActions(actions){
        if(Array.isArray(actions)){
          const items = actions.filter(item=>item && has(item.source) && has(item.text));
          if(!items.length) return "";
          const parts = items.map(item=>`【${item.source}】${item.text}`);
          return `建議措施：${parts.join('；')}`;
        }
        if(has(actions)) return String(actions);
        return "";
      }

      const actionText = formatActions(s.s1_actions);

      const assembledSegments=[
        p1,
        [visionPhrase, hearingPhrase].filter(Boolean).join('，'),
        p3,
        pSwallow,
        p4,
        p5,
        p6,
        p7,
        actionText,
        p9
      ].filter(function(text){ return text && String(text).trim(); });

      let fullText='';
      if(assembledSegments.length){
        fullText=assembledSegments.join('。');
        if(!/[。！？]$/.test(fullText)){ fullText+='。'; }
      }else{
        fullText='。';
      }

      const pieceMap={
        overview:p1,
        vision:visionPhrase,
        hearing:hearingPhrase,
        painLesion:p3,
        swallow:pSwallow,
        mobility:p4,
        adl:p5,
        life:p6,
        disease:p7,
        actions:actionText,
        notes:p9
      };

      const previewSegments = SECTION1_PREVIEW_META.map(function(meta){
        const raw = pieceMap[meta.key] || '';
        return {
          key: meta.key,
          title: meta.title,
          anchor: meta.anchor,
          value: typeof raw === 'string' ? raw.trim() : raw
        };
      });

      return { fullText: fullText, segments: previewSegments };
    }

    function buildSection1(presetValidation){
      let state = runSection1Rules();
      const validation = presetValidation || validateSection1();
      if(!validation.ok){
        document.getElementById('section1_out').value = '';
        section1PreviewState.segments = [];
        const texts = Array.isArray(validation.messages)
          ? validation.messages.map(item=>item && item.text ? item.text : '').filter(Boolean)
          : [];
        const msg = texts.length ? texts.join('、') : '請補齊必填欄位';
        renderSection1Preview([], { placeholder: `（一）身心概況：${msg}` });
        return '';
      }
      if(!state || typeof state !== 'object'){
        state = collectS1();
      }
      const result = buildSection1Text_v2(state);
      document.getElementById('section1_out').value = result.fullText;
      section1PreviewState.segments = result.segments;
      renderSection1Preview(result.segments);
      return result.fullText;
    }

    /* ===== 四-(二) 經濟收入：原程式 ===== */
    const S2_SOURCES = ['退休金（軍公教/勞退）','老人福利津貼','勞保/農保年金','身心障礙生活補助','社會福利補助','子女/親屬支持','儲蓄/投資收益','房租收入','其他'];
    const S2_CATS = [
      '第一類：神經系統構造及精神、心智功能',
      '第二類：眼、耳及相關構造與感官功能及疼痛',
      '第三類：涉及聲音與言語構造及其功能',
      '第四類：循環、造血、免疫與呼吸系統構造及其功能',
      '第五類：消化、新陳代謝與內分泌系統相關構造及其功能',
      '第六類：泌尿與生殖系統相關構造及其功能',
      '第七類：神經、肌肉、骨骼之移動相關構造及其功能',
      '第八類：皮膚與相關構造及其功能',
      '未註明'
    ];
    function renderS2(){
      const host=document.getElementById('s2_sources'); host.innerHTML='';
      S2_SOURCES.forEach((name,i)=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="buildS2()"> ${name}`;
        host.appendChild(lab);
      });
      const catSel=document.getElementById('s2_dis_cat');
      if(catSel){
        catSel.innerHTML=''; // 段二身心障礙類別選單
        S2_CATS.forEach(c=>{ // 產生類別選項
          const o=document.createElement('option'); o.textContent=c; catSel.appendChild(o); // 段二加入選項
        });
      }
      refreshCheckcol('s2_sources');
    }
    function toggleDisCategory(){
      const levelEl=document.getElementById('s2_dis_level');
      if(!levelEl) return;
      const catEl=document.getElementById('s2_dis_cat');
      const level = levelEl ? levelEl.value : '';
      const cat = catEl ? catEl.value : '';
      const showCat = level && level !== '無';
      const box2=document.getElementById('disCatBox');
      if(box2) box2.style.display = showCat ? '' : 'none';

      const levelText=document.getElementById('s1_dis_level_text');
      if(levelText) levelText.textContent = level || '—';
      const box1=document.getElementById('s1_dis_cat_box');
      if(box1) box1.style.display = showCat ? '' : 'none';
      const catText=document.getElementById('s1_dis_cat_text');
      if(catText) catText.textContent = showCat ? (cat || '未註明') : '—';

      buildS2(); // 更新經濟收入段落
    }
    function buildS2(){
      const srcs=[...document.querySelectorAll('#s2_sources input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      const id=document.getElementById('s2_id').value;
      const lv=document.getElementById('s2_dis_level').value;
      const catSel=document.getElementById('s2_dis_cat'); const cat=(catSel && catSel.value)? catSel.value : '';
      let s='';
      if(srcs.length) s+=`主要經濟來源為${srcs.join('、')}`;
      if(id){ s += (s? '，':'') + `戶籍/福利身分為${id}`; }
      if(lv && lv!=='無'){ s += `；身心障礙等級：${lv}${cat? '（'+cat+'）':''}`; }
      if(s) s+='。';
      document.getElementById('section2_out').value=s;
    }

    /* ===== 四-(三) 居住環境：原程式 ===== */
    const S3_FAC = ['扶手','止滑','斜坡','樓梯升降設備'];
    const S3_AIDS= ['輪椅','助行器','拐杖','照顧床','氣墊床','便盆椅','助行拐'];
    function renderS3(){
      const facHost=document.getElementById('s3_fac'); facHost.innerHTML='';
      S3_FAC.forEach((name)=>{const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" value="${name}" onchange="buildS3()"> ${name}`; facHost.appendChild(lab);});
      const aidsHost=document.getElementById('s3_aids'); aidsHost.innerHTML='';
      S3_AIDS.forEach((name)=>{const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" value="${name}" onchange="buildS3()"> ${name}`; aidsHost.appendChild(lab);});
      refreshCheckcol('s3_fac');
      refreshCheckcol('s3_aids');
    }
    function toggleOtherType(){
      const sel=document.getElementById('s3_type'); const on= sel.value==='其他';
      document.getElementById('s3_type_other').style.display= on?'':'none';
      buildS3();
    }
    function toggleRentFields(){
      const ownSelect=document.getElementById('s3_own');
      const amountWrap=document.getElementById('s3_rent_amount_wrap');
      const feeWrap=document.getElementById('s3_rent_fee_wrap');
      const isRent=ownSelect && ownSelect.value==='租賃';
      if(amountWrap) amountWrap.style.display = isRent ? '' : 'none';
      if(feeWrap) feeWrap.style.display = isRent ? '' : 'none';
      if(!isRent){
        const amountInput=document.getElementById('s3_rent_amount');
        const feeSelect=document.getElementById('s3_rent_fee');
        if(amountInput){ amountInput.value=''; amountInput.classList.remove('input-invalid'); }
        if(feeSelect){ feeSelect.value=''; feeSelect.classList.remove('input-invalid'); }
      }
      buildS3();
    }
    function buildS3(){
      const typeSel=document.getElementById('s3_type'); let type=typeSel.value;
      if(type==='其他'){ const t=document.getElementById('s3_type_other').value.trim(); if(t) type=t; }
      const own=document.getElementById('s3_own').value;
      const rentAmountInput=document.getElementById('s3_rent_amount');
      const rentFeeSelect=document.getElementById('s3_rent_fee');
      let rentInfo='';
      if(own==='租賃'){
        const rawAmount=(rentAmountInput?.value || '').trim();
        const feeValue=(rentFeeSelect?.value || '').trim();
        if(rawAmount){
          const numeric=parseInt(rawAmount,10);
          const formatted=!Number.isNaN(numeric) && numeric>=0 ? numeric.toLocaleString('zh-TW') : rawAmount;
          rentInfo = `月租${formatted}元`;
          if(feeValue){ rentInfo += `（${feeValue}）`; }
        }else if(feeValue){
          rentInfo = feeValue;
        }
      }
      const clean=document.getElementById('s3_clean').value;
      const smell=document.getElementById('s3_smell').value;
      const fac=[...document.querySelectorAll('#s3_fac input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      const aids=[...document.querySelectorAll('#s3_aids input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      if(!type) { document.getElementById('section3_out').value=''; return; }
      let base=`現居住於${own}${type}`;
      if(rentInfo){ base += `，${rentInfo}`; }
      let s=`${base}，環境整潔度${clean}，${smell==='無'?'無異味':(smell+'異味')}。`;
      if(fac.length) s+=`無障礙設施：${fac.join('、')}。`;
      if(aids.length) s+=`已備輔具：${aids.join('、')}。`;
      document.getElementById('section3_out').value=s;
    }

    /* ===== 四-(四) 社會支持：原程式 ===== */
    const FORMAL = ['居家服務','專業服務','日間照顧','喘息服務','交通接送','無障礙及輔具','營養送餐'];
    const DEFAULT_SERVICE_CATALOG = {
      needLevelCaps: {
        '2': 10020,
        '3': 15460,
        '4': 18580,
        '5': 24100,
        '6': 28070,
        '7': 32090,
        '8': 36180
      },
      levelDetails: {
        '2': { bcMonthlyCap: 10020, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 32340, efThreeYearCap: 40000 },
        '3': { bcMonthlyCap: 15460, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 32340, efThreeYearCap: 40000 },
        '4': { bcMonthlyCap: 18580, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 32340, efThreeYearCap: 40000 },
        '5': { bcMonthlyCap: 24100, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 32340, efThreeYearCap: 40000 },
        '6': { bcMonthlyCap: 28070, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 32340, efThreeYearCap: 40000 },
        '7': { bcMonthlyCap: 32090, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 48510, efThreeYearCap: 40000 },
        '8': { bcMonthlyCap: 36180, dCaps: { '1': 1680, '2': 1840, '3': 2000, '4': 2400 }, gAnnualCap: 48510, efThreeYearCap: 40000 }
      },
      dayCareRequirements: {},
      dayCareLevels: {},
      serviceRates: {},
      transportRoundTrips: 2,
      copayRates: {
        'B/C（照顧及專業服務）': { '低收入戶': 0, '中低收入戶': 5, '一般戶': 16 },
        'D-第一類（交通接送）': { '低收入戶': 0, '中低收入戶': 10, '一般戶': 30 },
        'D-第二類（交通接送）': { '低收入戶': 0, '中低收入戶': 9,  '一般戶': 27 },
        'D-第三類（交通接送）': { '低收入戶': 0, '中低收入戶': 8,  '一般戶': 25 },
        'D-第四類（交通接送）': { '低收入戶': 0, '中低收入戶': 7,  '一般戶': 21 },
        'E/F（輔具/居家無障礙）': { '低收入戶': 0, '中低收入戶': 10, '一般戶': 30 },
        'G（喘息服務）': { '低收入戶': 0, '中低收入戶': 5, '一般戶': 16 }
      },
      transportCategory: '第二類'
    };
    let SERVICE_CATALOG = JSON.parse(JSON.stringify(DEFAULT_SERVICE_CATALOG));
    const HOME_CARE_ITEMS = [
      {
        code: 'BA01',
        name: '基本身體清潔',
        short: '協助個案完成基本身體清潔，維持良好衛生狀態，提升個人舒適感與自尊。',
        mid: '持續安排身體清潔服務，確保個案日常生活中維持清爽與健康，避免感染風險。',
        long: '建立穩定的清潔照護習慣，確保個案長期維持身體衛生與健康品質。'
      },
      {
        code: 'BA02',
        name: '基本日常照顧',
        short: '協助個案完成基本日常照顧活動，改善生活便利性。',
        mid: '持續提供日常照護支持，讓個案逐步形成規律生活，減少依賴與不便。',
        long: '透過長期支持，協助個案穩定自理能力，提升日常生活品質與安全感。'
      },
      {
        code: 'BA03',
        name: '測量生命徵象',
        short: '協助測量生命徵象，掌握個案即時健康狀態。',
        mid: '持續安排定期測量，讓健康狀況獲得追蹤與管理，及時回應變化。',
        long: '透過長期監測生命徵象，維持穩定的健康管理，預防突發狀況。'
      },
      {
        code: 'BA04',
        name: '協助進食或管灌餵食',
        short: '協助個案進食或管灌餵食，確保營養攝取充足，避免饑餓或體力下降。',
        mid: '持續安排餵食服務，維持營養平衡與健康狀況。',
        long: '建立穩定飲食支持機制，確保個案長期營養狀態良好，促進生活品質。'
      },
      {
        code: 'BA05',
        name: '餐食照顧',
        short: '協助個案處理餐食，確保用餐便利與安全。',
        mid: '持續安排餐食照顧，幫助個案維持飲食規律與營養。',
        long: '透過餐食支持，協助個案養成健康飲食習慣，長期維持良好營養狀態。'
      },
      {
        code: 'BA07',
        name: '協助沐浴及洗頭',
        short: '協助個案完成沐浴與洗頭，改善個人清潔與舒適度。',
        mid: '持續提供沐浴服務，協助維持個人衛生與清爽狀態。',
        long: '透過穩定支持，確保個案長期維持良好的身體清潔與尊嚴。'
      },
      {
        code: 'BA08',
        name: '足部照護',
        short: '協助進行足部清潔與照護，改善足部舒適與行動便利。',
        mid: '持續安排足部照護，預防感染或相關併發症，維持健康。',
        long: '確保持續照護，讓個案足部健康穩定，提升生活功能與行動力。'
      },
      {
        code: 'BA09',
        name: '到宅沐浴車服務—第一型',
        short: '安排到宅沐浴車（第一型），由專業人員與設備協助安全完成全身沐浴與清潔。',
        mid: '持續規劃第一型到宅沐浴車服務，確保定期洗浴、觀察皮膚狀況並降低跌倒風險。',
        long: '建立穩定的第一型到宅沐浴車服務流程，讓個案長期維持衛生習慣並減輕照顧者負擔。'
      },
      {
        code: 'BA09a',
        name: '到宅沐浴車服務—第二型',
        short: '安排到宅沐浴車（第二型），提供高照護需求者安全完整的沐浴與清潔支持。',
        mid: '持續使用第二型沐浴車服務，配合雙人協助與專業設備維持皮膚健康與舒適。',
        long: '長期串接第二型到宅沐浴車服務，確保高需求個案規律沐浴並維持身體潔淨。'
      },
      {
        code: 'BA10',
        name: '翻身拍背',
        short: '協助翻身拍背，預防壓瘡與改善呼吸狀況。',
        mid: '持續提供翻身支持，確保身體循環與舒適度。',
        long: '建立長期照護機制，減少壓瘡與呼吸道問題，確保健康穩定。'
      },
      {
        code: 'BA11',
        name: '肢體關節活動',
        short: '協助個案進行肢體關節活動，促進血液循環並改善活動力。',
        mid: '持續安排關節活動，維持肢體功能與肌肉力量。',
        long: '透過長期支持，預防關節僵硬或退化，確保持續活動能力。'
      },
      {
        code: 'BA12',
        name: '協助上下樓梯',
        short: '協助個案安全上下樓梯，改善行動便利與生活範圍。',
        mid: '持續提供上下樓梯支持，讓個案能穩定參與日常活動。',
        long: '建立穩定照護，確保個案長期安全行動，減少跌倒風險。'
      },
      {
        code: 'BA13',
        name: '陪同外出',
        short: '協助陪同外出，增加社會參與與心理支持。',
        mid: '持續安排外出陪伴，維持社交互動與生活樂趣。',
        long: '透過長期支持，協助個案保持社交網絡，提升生活品質。'
      },
      {
        code: 'BA14',
        name: '陪同就醫',
        short: '協助陪同就醫，確保醫療需求能即時獲得處理。',
        mid: '持續安排就醫陪伴，協助醫療追蹤與健康管理。',
        long: '透過長期就醫支持，維持個案健康穩定，減少延誤風險。'
      },
      {
        code: 'BA15',
        name: '家務協助',
        short: '協助處理家務，改善生活環境與便利性。',
        mid: '持續提供家務支持，確保日常生活穩定與整潔。',
        long: '建立長期家務支持，讓個案生活環境持續舒適與安全。'
      },
      {
        code: 'BA16',
        name: '代購或代領或代送服務',
        short: '協助代購、代領或代送生活物品，滿足即時需求並降低外出風險。',
        mid: '持續提供代購支持，確保生活所需穩定供應。',
        long: '透過長期協助，維持生活便利並減輕個案與家屬負擔。'
      },
      {
        code: 'BA17a',
        name: '人工氣道管內分泌物抽吸',
        short: '協助進行人工氣道管內分泌物抽吸，改善呼吸道通暢與舒適。',
        mid: '持續安排人工氣道分泌物抽吸支持，確保呼吸道暢通與健康。',
        long: '透過長期呼吸照護，維持個案呼吸安全並減少併發症。'
      },
      {
        code: 'BA17b',
        name: '口腔分泌物抽吸',
        short: '協助口腔分泌物抽吸，減輕不適與提升舒適度。',
        mid: '持續安排口腔照護，維持健康與安全。',
        long: '建立長期支持，避免併發症，確保生活品質。'
      },
      {
        code: 'BA17c',
        name: '尿管及鼻胃管之清潔與固定',
        short: '協助尿管及鼻胃管的清潔與固定，降低感染與滑脫風險。',
        mid: '持續安排管路照護，維持穩定使用。',
        long: '透過長期管路照護，減少併發症並確保生活品質。'
      },
      {
        code: 'BA17d1',
        name: '血糖機驗血糖',
        short: '協助血糖測量，掌握健康狀況。',
        mid: '持續追蹤血糖值，及時調整照護需求。',
        long: '建立長期監測，維持穩定健康管理。'
      },
      {
        code: 'BA17d2',
        name: '甘油球通便',
        short: '協助通便，緩解排便困難。',
        mid: '持續安排通便支持，維持腸道功能。',
        long: '透過長期照護，確保腸道健康與生活品質。'
      },
      {
        code: 'BA17e',
        name: '依指示置入藥盒',
        short: '協助依指示置入藥盒，改善用藥管理。',
        mid: '持續安排用藥支持，確保規律服藥。',
        long: '建立長期用藥管理，提升健康維護品質。'
      },
      {
        code: 'BA18',
        name: '安全看視',
        short: '協助安全看視，降低意外風險。',
        mid: '持續安排看視支持，確保日常安全。',
        long: '透過長期安全監護，維持穩定生活品質。'
      },
      {
        code: 'BA20',
        name: '陪伴服務',
        short: '協助陪伴，減輕孤單感並提供心理支持。',
        mid: '持續安排陪伴，維持社交互動與情感連結。',
        long: '建立長期陪伴關係，提升心理健康與生活滿意度。'
      },
      {
        code: 'BA22',
        name: '巡視服務',
        short: '協助巡視，關懷生活狀況與安全需求。',
        mid: '持續安排巡視服務，掌握個案生活穩定性。',
        long: '透過長期巡視支持，確保個案安全與生活品質。'
      },
      {
        code: 'BA23',
        name: '協助洗頭',
        short: '協助個案洗頭，改善清潔與舒適度。',
        mid: '持續安排洗頭支持，維持衛生與自尊。',
        long: '透過長期支持，確保持續清潔與健康。'
      },
      {
        code: 'BA24',
        name: '協助排泄',
        short: '協助排泄，維持基本生理需求。',
        mid: '持續安排排泄支持，確保健康與舒適。',
        long: '建立長期照護，避免併發症，維持生活品質。'
      }
    ];
    const HOME_CARE_MAP = {};
    HOME_CARE_ITEMS.forEach(item => { HOME_CARE_MAP[item.code] = item; });
    const BA_CODES = HOME_CARE_ITEMS
      .filter(item => item && item.code && item.code.indexOf('BA') === 0)
      .map(item => item.code);
    const BA_CODE_SET = new Set(BA_CODES);
    const BA_MANUAL_UNIT_CODES = new Set([]);
    const BA_DEFAULT_UNITS_PER_VISIT = {};
    const DAY_CARE_ITEMS = [
      {
        code: 'BB01',
        name: '日間照顧（全日）—第一型',
        short: '安排第一型全日型日間照顧，依照評估提供生活照顧、健康促進與社交活動，協助建立規律作息並減輕照顧者壓力。',
        mid: '持續參與第一型全日日照，穩定完成生活照護與團體活動，團隊定期追蹤健康變化並與家屬討論調整。',
        long: '長期規律使用第一型全日日照，維持生活功能與情緒穩定，建立完整紀錄並與家庭合作支持照護。'
      },
      {
        code: 'BB02',
        name: '日間照顧（半日）—第一型',
        short: '安排第一型半日型日間照顧，提供生活照顧、健康促進及社交互動，協助建立固定出席並給予照顧者喘息。',
        mid: '持續參與第一型半日日照，穩定完成照護與訓練，團隊追蹤健康狀態並與家屬分享照護重點。',
        long: '長期使用第一型半日日照，維持作息與社交參與，並透過紀錄與回饋支持家庭照護安排。'
      },
      {
        code: 'BB03',
        name: '日間照顧（全日）—第二型',
        short: '安排第二型全日型日間照顧，強化生活照顧、復能訓練與團體參與，協助高需求者維持穩定作息。',
        mid: '持續參與第二型全日日照，依功能狀態調整活動強度，團隊定期與家屬檢視照顧成果。',
        long: '長期使用第二型全日日照，建立完整照護紀錄並維持自理度與情緒穩定，提供家屬長期支持。'
      },
      {
        code: 'BB04',
        name: '日間照顧（半日）—第二型',
        short: '安排第二型半日型日間照顧，結合生活照護與健康促進，協助高需求者在安全環境中參與團體。',
        mid: '持續參與第二型半日日照，依個案狀態調整訓練與活動，並由團隊提供照護建議。',
        long: '長期規律使用第二型半日日照，維持生活節奏與社交參與，並與家屬共同檢視照護策略。'
      },
      {
        code: 'BB05',
        name: '日間照顧（全日）—第三型',
        short: '安排第三型全日型日間照顧，提供密集生活照護、復能及健康監測，支援失能程度較高之個案。',
        mid: '持續參與第三型全日日照，透過團隊合作調整照護介入並追蹤健康變化。',
        long: '長期使用第三型全日日照，維持生活品質並記錄照護成效，協助家屬掌握狀況與資源。'
      },
      {
        code: 'BB06',
        name: '日間照顧（半日）—第三型',
        short: '安排第三型半日型日間照顧，提供高照護密度的生活協助與訓練，確保安全參與。',
        mid: '持續參與第三型半日日照，依健康狀況調整照護重點並提供家屬教學。',
        long: '長期使用第三型半日日照，維持生活功能與情緒穩定，減輕照顧者負擔。'
      },
      {
        code: 'BB07',
        name: '日間照顧（全日）—第四型',
        short: '安排第四型全日型日間照顧，結合專業照護與復能活動，支援複合型需求者。',
        mid: '持續參與第四型全日日照，團隊整合護理、復健與社交活動，滾動調整照護。',
        long: '長期使用第四型全日日照，建立跨專業照護模式，維持健康與社交參與。'
      },
      {
        code: 'BB08',
        name: '日間照顧（半日）—第四型',
        short: '安排第四型半日型日間照顧，提供複合照護需求者短時段支持與團體參與。',
        mid: '持續參與第四型半日日照，透過團隊監測健康與行為變化並提供策略。',
        long: '長期使用第四型半日日照，維持功能並支援家屬銜接照顧計畫。'
      },
      {
        code: 'BB09',
        name: '日間照顧（全日）—第五型',
        short: '安排第五型全日型日間照顧，提供高度照護與醫療協調，支援複雜照護需求。',
        mid: '持續參與第五型全日日照，團隊密切觀察病情並調整照護流程。',
        long: '長期使用第五型全日日照，確保醫療與社會資源串連，維持生活品質。'
      },
      {
        code: 'BB10',
        name: '日間照顧（半日）—第五型',
        short: '安排第五型半日型日間照顧，提供密集照護與醫療銜接，確保安全參與。',
        mid: '持續參與第五型半日日照，透過團隊協調追蹤健康並提供照護建議。',
        long: '長期使用第五型半日日照，穩定功能並支援家庭照顧安排。'
      },
      {
        code: 'BB11',
        name: '日間照顧（全日）—第六型',
        short: '安排第六型全日型日間照顧，整合專業照護、醫療協調與行為管理，支援高度失能或失智者。',
        mid: '持續參與第六型全日日照，團隊依病程調整照護策略並與家屬緊密合作。',
        long: '長期使用第六型全日日照，維持安全環境與照護紀錄，協助家庭落實長期支持。'
      },
      {
        code: 'BB12',
        name: '日間照顧（半日）—第六型',
        short: '安排第六型半日型日間照顧，提供高強度照護與行為支持，協助家庭喘息。',
        mid: '持續參與第六型半日日照，團隊即時回饋健康與行為變化，協助家屬調整。',
        long: '長期使用第六型半日日照，維持生活品質並減少家庭照護壓力。'
      },
      {
        code: 'BB13',
        name: '日間照顧（全日）—第七型',
        short: '安排第七型全日型日間照顧，結合專業醫護、復能與安全監測，支援極高照護需求者。',
        mid: '持續參與第七型全日日照，團隊跨專業合作掌握病況並調整計畫。',
        long: '長期使用第七型全日日照，確保高度照護需求獲得穩定支持並維持生活品質。'
      },
      {
        code: 'BB14',
        name: '日間照顧（半日）—第七型',
        short: '安排第七型半日型日間照顧，提供極高照護需求者短時段專業支持與安全陪伴。',
        mid: '持續參與第七型半日日照，團隊密切掌握身心狀況並回饋照護建議。',
        long: '長期使用第七型半日日照，協助家庭維持高需求個案之照護品質。'
      },
      {
        code: 'BD01',
        name: '社區式協助沐浴',
        short: '個案將於日間照顧中心或托顧家庭接受協助沐浴服務，包含引導至浴間、協助穿脫衣物、全身淋浴或坐浴（含洗頭）、口腔及臉部清潔，並於沐浴後完成環境整理，以確保基本衛生與安全。',
        mid: '穩定使用社區式協助沐浴服務，維持規律清潔習慣。服務過程除執行洗浴與頭部清潔外，並持續監測皮膚狀況（如紅腫、壓痕），透過照護人員操作協助減少跌倒風險，同時提升舒適度與自我形象。',
        long: '長期持續於社區據點完成規律沐浴，保持身體清潔與皮膚健康，並建立穩定的清潔照護流程。透過專業協助降低感染及跌倒風險，提升生活品質與尊嚴，並減輕主要照顧者的負擔。'
      },
      {
        code: 'BD02',
        name: '社區式晚餐',
        short: '個案將於日間照顧中心或托顧家庭接受社區式晚餐服務，包括準備適合個別需求的餐點、協助進食或餵食，以及餐後口腔清潔，確保基本營養攝取。',
        mid: '穩定使用社區式晚餐服務，確保營養攝取均衡並維持適當進食量。餐食提供將依照個案狀況調整（如軟質、低鹽、糖尿病飲食），並落實餐後口腔清潔，以降低嗆咳與感染風險。',
        long: '長期維持晚餐服務使用，透過專業規劃與協助，確保個案獲得持續且均衡的營養，進而支持身體健康與活動參與。餐食紀錄與口腔清潔紀錄將定期檢核，確保飲食衛教與習慣養成。'
      },
      {
        code: 'BD03',
        name: '社區式服務交通接送',
        short: '個案將使用社區式交通接送服務，安全往返住家與日間照顧中心、托顧家庭或小規模多機能據點，以確保能順利參與日間照顧或其他社區服務。',
        mid: '穩定使用交通接送，確保每次行程安全準點。服務人員將提供上下車協助與必要保護，並持續觀察個案上下車動作與身體狀況，確保安全無跌倒或不適事件。',
        long: '長期規律使用交通接送，確保個案能穩定參與社區服務，減少因交通不便而放棄活動的情況。透過持續追蹤與紀錄，建立固定路線與服務流程，確保安全率與準點率，並協助家屬降低接送壓力。'
      }
    ];
    const DAY_CARE_MAP = {};
    DAY_CARE_ITEMS.forEach(item => { DAY_CARE_MAP[item.code] = item; });
    const PROFESSIONAL_SERVICE_ITEMS = [
      {
        code: 'CA07',
        name: 'IADLs/ADLs 復能照護',
        short: '完成功能與生活能力初評，並與個案及家屬討論復能重點，擬定個別化計畫。安排基本日常活動訓練（如穿衣、如廁、進食、移位），由專業人員示範並記錄進展，協助個案建立參與信心。',
        mid: '持續執行復能計畫，逐步增加活動強度與複雜度，並透過專業人員監測功能變化。個案能在協助下完成部分日常活動，並透過重複練習提升耐力與技巧。家屬將接受照護技巧指導，以在居家情境中延續復能訓練。',
        long: '個案能穩定完成復能計畫中多數的日常生活活動，並逐步減少協助需求。透過規律性訓練維持自理能力，避免退化；服務單位定期檢核成果，將改善情況與困難處回饋家屬，並滾動修正計畫內容。'
      },
      {
        code: 'CA08',
        name: '個別化服務計畫（ISP）擬定與執行',
        short: '完成個案功能與心理社交評估，並與家屬討論需求。擬定個別化服務計畫，涵蓋生活自理、人際互動、社交技巧、休閒與健康促進等面向，設定近期可達成之行為與生活目標。',
        mid: '穩定執行 ISP，逐步提升個案生活自理能力，並參與社交與休閒活動。由專業人員持續追蹤效果，針對退化或困難項目調整策略，並提供家屬支持與訓練，使家庭能共同配合服務計畫。',
        long: '透過持續執行 ISP，協助個案維持並強化自理功能與社會參與，延緩退化。服務單位將依據評估結果與家屬回饋，定期修正與優化計畫，確保個案在生活、健康與社交等層面均獲得持續支持。'
      },
      {
        code: 'CB01',
        name: '營養照護',
        short: '完成營養狀況初評（包含體重、飲食習慣、吞嚥能力），並提出飲食改善建議。提供家屬與個案飲食衛教，建立飲食紀錄，以利後續追蹤。',
        mid: '持續監測個案營養狀態，並依實際情況調整餐食內容或質地。透過專業人員指導，改善營養攝取不足或偏差的情況。必要時轉介醫師或營養師進一步評估。',
        long: '維持均衡飲食與營養良好狀態，避免體重異常變化與營養不良。服務單位定期檢視營養紀錄，持續提供衛教，協助個案及家屬養成健康飲食習慣。'
      },
      {
        code: 'CB02',
        name: '進食與吞嚥照護',
        short: '完成吞嚥與進食功能評估，確認風險並給予初步指導。安排合適的飲食質地（如軟質、泥狀），並透過姿勢與口腔運動訓練，降低嗆咳風險。',
        mid: '持續進行吞嚥訓練與飲食調整，提升個案口腔與吞嚥肌群功能。專業人員追蹤進食過程，必要時指導家屬協助，減少誤吸與嗆咳事件。',
        long: '維持進食與吞嚥安全，確保個案能長期攝取足夠營養。持續監測進食過程，避免併發症（如吸入性肺炎），並建立穩定的照護模式，支持個案生活品質。'
      },
      {
        code: 'CB03',
        name: '困擾行為照護',
        short: '完成困擾行為評估，記錄發生頻率與情境，並給予初步安撫策略。與家屬討論行為誘因，建立紀錄基準。',
        mid: '持續執行行為介入策略，降低困擾行為發生率。透過正向強化與環境調整，協助個案改善行為模式，並提供家屬因應技巧，提升家庭照護能力。',
        long: '建立穩定行為管理模式，使困擾行為大幅減少或控制在可接受範圍。服務單位將定期回饋成效，並持續調整介入策略，以確保個案生活品質與家庭照護負擔的改善。'
      },
      {
        code: 'CB04',
        name: '臥床或長期活動受限照護',
        short: '完成全面性評估，確認臥床或活動受限相關風險（如壓瘡、肌肉萎縮）。提供翻身、肢體關節活動與皮膚護理的初步指導。',
        mid: '持續執行翻身與肢體活動，並監測皮膚完整性與關節活動度。專業人員指導家屬日常照護技巧，降低壓瘡及感染風險。',
        long: '建立長期臥床照護模式，確保翻身與護理規律執行。透過持續追蹤與紀錄，預防併發症，並維持個案在可行範圍內的活動與生活品質。'
      },
      {
        code: 'CC01',
        name: '居家環境安全或無障礙空間規劃',
        short: '完成居家環境與動線安全評估，提出優先改善建議，並提供家屬基本安全指導。',
        mid: '執行居家環境改善（如增設扶手、防滑設施），並安排輔具使用。由專業人員示範正確操作方式，確保日常生活動線更安全。',
        long: '維持環境安全，避免跌倒與意外事件。服務單位定期檢視改善效果與輔具使用狀況，並持續提供調整建議，以符合個案長期需求。'
      },
      {
        code: 'CD02',
        name: '居家護理指導與諮詢',
        short: '進行居家護理需求與家庭功能評估，擬定初步護理計畫，並提供基本照護技巧指導。',
        mid: '執行居家護理計畫，持續指導個案與家屬進行正確照護（如傷口處理、管路照護）。進行跨專業轉介與社區資源連結，並持續追蹤成效。',
        long: '建立長期護理支持系統，提升個案與家屬的自我照護能力。透過定期成效評估，持續改善照護策略，確保生活品質與健康狀態獲得提升。'
      }
    ];
    const PROFESSIONAL_SERVICE_MAP = {};
    PROFESSIONAL_SERVICE_ITEMS.forEach(item => { PROFESSIONAL_SERVICE_MAP[item.code] = item; });
    const TRANSPORT_SERVICE_ITEMS = [
      {
        code: 'DA01',
        name: '交通接送（就醫/復健/透析）',
        short: '個案將開始使用交通接送服務，協助往返居家與醫療院所、復健中心或透析治療地點。服務提供單位安排具職業駕照之駕駛，並於上車及下車過程給予必要的協助，確保安全。透過此服務，個案能準時參與治療與檢查，減少因交通不便而影響就醫之情況，並協助家屬減輕接送壓力。',
        mid: '個案已能穩定使用交通接送服務完成定期就醫與復健治療，行程安排逐步固定化。服務單位將持續追蹤準點率與安全性，並在必要時進行路線或時間調整，以符合醫療需求。服務人員在接送過程中同時觀察個案身體狀況，如發現異常將即時回報，確保醫療銜接不中斷。',
        long: '個案能長期規律地透過交通接送服務完成就醫、復健或透析，維持治療連續性。服務單位建立完善的交通排程與紀錄制度，確保安全、準時並提升使用滿意度。藉由穩定的接送服務，降低家屬長期負擔，並支持個案健康狀態維持與醫療成效之落實。'
      }
    ];
    const TRANSPORT_SERVICE_MAP = {};
    TRANSPORT_SERVICE_ITEMS.forEach(item => { TRANSPORT_SERVICE_MAP[item.code] = item; });
    const RESPITE_SERVICE_ITEMS = [
      {
        code: 'GA03',
        name: '日間照顧中心喘息—全日',
        short: '個案將開始使用日間照顧中心全日喘息服務，服務內容包含生活起居協助（更衣、如廁、移位）、護理照護（服藥管理、健康監測）、協助沐浴、餐食供應與進食協助，以及文康休閒活動的參與。服務期間含交通接送，確保個案能準時到達與返家。此階段的重點在於協助個案熟悉中心環境與人員，建立規律的日間生活型態，並讓主要照顧者獲得整日的休息與喘息機會。',
        mid: '個案能穩定出席全日喘息服務，並逐步建立參與日間活動的習慣。服務單位將持續監測健康狀況（如血壓、血糖、營養狀態），確保進食與服藥安全，並透過規律的文康休閒活動提升認知與情緒狀態。同時，服務團隊將定期與家屬溝通，提供健康與生活回饋，幫助家屬在居家時延續照護品質。',
        long: '個案能長期規律使用全日喘息服務，並在安全環境中維持生活自理功能與社交參與。服務單位會建立完整的照顧紀錄（出席率、健康檢視、活動參與度），定期檢討照顧成果並回饋給家屬。透過長期喘息支持，不僅能延緩個案退化，也能有效降低家庭主要照顧者的負荷，達到長期穩定的支持系統。'
      },
      {
        code: 'GA04',
        name: '日間照顧中心喘息—半日',
        short: '個案將使用日間照顧中心半日喘息服務，接受生活照顧（移位、如廁、整潔協助）、護理照護、餐食供應與進食協助，以及文康休閒活動參與。含交通接送，以減少家屬接送負擔，並提供主要照顧者半日的休息時段。',
        mid: '個案能穩定參與半日服務，保持生活照顧品質與日常活動參與。服務單位持續觀察健康狀況，確保餐食與用藥安全，並透過適當的活動安排維持社交互動與認知參與。家屬能獲得固定的喘息時間，以緩解長期照護壓力。',
        long: '個案能長期規律參與半日喘息服務，並在此環境中維持身體健康與社交參與，避免因長期居家而產生孤立或退化。服務單位將定期提供參與紀錄與健康追蹤，確保計畫成效，並與家屬保持溝通，共同支持長期照護安排。'
      },
      {
        code: 'GA05',
        name: '機構住宿式喘息服務',
        short: '個案將入住住宿式長照機構，接受 24 小時照顧與護理，內容涵蓋生活起居協助、護理照護（用藥管理、健康監測）、沐浴、餐食與進食協助，以及規律活動安排。含交通接送，確保入住與返家過程順利。主要照顧者可因此獲得完整休養時間。',
        mid: '個案能穩定適應機構住宿環境，並接受完整的生活與健康照護。服務團隊將建立規律的日夜間照護模式，持續追蹤營養狀態、睡眠品質與皮膚健康，避免壓瘡與感染。家屬可透過喘息獲得生活調整的空間，並透過服務單位回饋掌握個案狀況。',
        long: '長期使用住宿式喘息服務，個案在專業照護下維持穩定健康與生活品質，避免功能快速退化。服務單位會建立完整的住宿照顧紀錄，包含健康監測與活動參與情況，並定期回饋給家屬，確保家庭與機構照護銜接順暢，減輕長期照顧壓力。'
      },
      {
        code: 'GA06',
        name: '小規模多機能—夜間喘息',
        short: '個案於夜間（18:00–08:00）至小規模多機能中心接受喘息服務，由工作人員提供夜間生活照顧（如如廁、翻身、進食）、服藥管理、沐浴及住宿。此安排讓主要照顧者能獲得夜間睡眠與休息，減少長期疲憊。',
        mid: '個案能穩定參與夜間喘息，服務單位將持續監測夜間睡眠品質、排泄與行動安全，避免跌倒或夜間意外事件。主要照顧者能透過固定的夜間休息，改善身心狀態並提升白天照護品質。',
        long: '長期使用夜間喘息服務，個案能維持規律作息，健康狀態穩定，並避免夜間失能惡化或安全事件發生。服務單位將建立夜間照護紀錄，並定期與家屬檢討，確保照護策略與家庭需求一致。'
      },
      {
        code: 'GA07',
        name: '巷弄長照站喘息（時）',
        short: '個案將至巷弄長照站接受短時段喘息服務，內容包含進食、服藥協助及簡單活動安排。此服務能讓主要照顧者獲得暫時喘息，減輕即時負擔。',
        mid: '個案能穩定參與巷弄長照站活動，維持基本社交互動與日常生活規律。照顧者可在此期間獲得喘息，並透過服務紀錄了解個案狀況，增進家庭照護信心。',
        long: '長期規律使用巷弄長照站喘息，個案能透過社區互動維持身心功能，避免孤立與退化。服務單位會定期提供健康與參與回饋，協助家屬規劃長期照顧。'
      },
      {
        code: 'GA09',
        name: '居家喘息服務（2小時為一單位）',
        short: '由受過專業訓練之照顧服務員至個案家中，提供如廁、沐浴、更衣、進食、服藥、翻身拍背、肢體活動與上下床協助等照顧。此安排能讓主要照顧者即時獲得休息，並確保個案於熟悉環境中獲得基本生活支持。',
        mid: '穩定使用居家喘息，服務員能熟悉個案需求並提供規律照顧，確保衛生、營養及安全。服務過程中觀察並記錄個案狀況，若有異常立即回報，讓家屬在喘息同時也能掌握健康狀況。',
        long: '長期規律安排居家喘息，個案能在熟悉環境中獲得持續照顧，維持生活品質並避免功能退化或照護缺口。服務單位將建立完整紀錄，定期與家屬討論成效，確保家庭照護與喘息服務能長期銜接與互補。'
      }
    ];
    const RESPITE_SERVICE_MAP = {};
    RESPITE_SERVICE_ITEMS.forEach(item => { RESPITE_SERVICE_MAP[item.code] = item; });
    const MEAL_SERVICE_ITEMS = [
      {
        code: 'OT01',
        name: '營養送餐',
        short: '個案經本市長照管理中心評估後，將開始接受營養送餐服務，每日提供午餐與晚餐共二餐。餐點依個案吞嚥能力與身體狀況調整質地與份量，配送同時完成飲食衛教與保存加熱說明，並建立固定送餐時段與交付簽收紀錄。針對列冊低收入戶、中低收入戶及符合長照低收入戶、中低收補助者，全額或部分補助餐費，其他一般戶則由服務單位依規收取餐費。',
        mid: '個案持續接受每日二餐送餐，餐點內容隨季節與健康需求調整，涵蓋均衡營養、低油鹽飲食及高蛋白質攝取。服務團隊定期檢核個案的體重變化、食量與用餐狀況，並落實餐後回收紀錄。補助資格定期檢視並持續套用正確身分類別，確保餐食供應不中斷。',
        long: '個案長期維持每日二餐送餐服務，確保在居家情境中穩定獲得營養支持。服務單位建立長期的送餐追蹤紀錄，包括出餐準時率、餐食品質檢驗與個案身體狀況回報。定期向家屬提供完整用餐紀錄與健康狀態摘要，確保營養供應、生活品質與家庭照護三方面穩定銜接。'
      }
    ];
    const MEAL_SERVICE_MAP = {};
    MEAL_SERVICE_ITEMS.forEach(item => { MEAL_SERVICE_MAP[item.code] = item; });
    const RISKS = [
      ['被照顧者嚴重情緒/干擾行為','BPSD、自/他傷、攻擊破壞、遊走、妄想、吼叫等'],
      ['高齡照顧者','≥65歲；原住民≥55歲；<18歲應通報'],
      ['無照顧經驗/知能不足','家庭變故或病況改變致知能不足'],
      ['沒有照顧替手','每週≥20小時主要照顧、難求助/抗拒資源'],
      ['需照顧兩人以上','含雙老家庭、多名身心障礙或精神病人'],
      ['照顧者疾病/身心影響能力或意願','精神疾患/憂鬱焦慮失眠/重大傷病'],
      ['資源不符/變動或突發緊急需求','不符補助或突發事故致負擔'],
      ['三個月內照顧情境改變','急性醫療、病況改變、外籍看護空窗、資源中斷'],
      ['家暴或照顧疏忽風險','含自述暴力意念、疑似未通報'],
      ['自殺風險','意念/企圖/具體計畫/準備']
    ];
    function renderFormal(){
      const host=document.getElementById('sp_formal');
      host.innerHTML='';
      baFrequencyDisplays = {};
      FORMAL.forEach((name)=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="toggleGoalInputs()"> ${name}`;
        host.appendChild(lab);
      });
      const rHost=document.getElementById('sp_risks');
      rHost.innerHTML='';
      RISKS.forEach((it,i)=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${it[0]}"> ${i+1}. ${it[0]} <span class="muted">（${it[1]}）</span>`;
        rHost.appendChild(lab);
      });
      toggleGoalInputs();
      refreshCheckcol('sp_formal');
      refreshCheckcol('sp_risks');
    }

    function setServiceCardSelected(card, selected){
      if(!card) return;
      card.dataset.selected = selected ? '1' : '0';
      card.setAttribute('aria-pressed', selected ? 'true' : 'false');
      card.classList.toggle('is-selected', selected);
      const status = card.querySelector('.home-care-status');
      if(status){ status.textContent = selected ? '已選取' : '未選取'; }
      const qty = card.querySelector('.home-care-qty');
      if(qty){
        qty.disabled = !selected;
        qty.tabIndex = selected ? 0 : -1;
        if(!selected){ qty.value=''; }
      }
    }

    function handleServiceCardToggle(card, shouldSelect, callback, focusQuantity){
      setServiceCardSelected(card, shouldSelect);
      if(typeof callback === 'function'){
        callback(card, shouldSelect);
      }
      if(shouldSelect && focusQuantity){
        const qty = card.querySelector('.home-care-qty');
        if(qty){ setTimeout(()=>{ qty.focus(); qty.select(); }, 0); }
      }
    }

    function createServiceCard(item, options){
      options = options || {};
      const card=document.createElement('div');
      card.className='home-care-item';
      card.dataset.code = item.code || '';
      card.dataset.selected='0';
      card.setAttribute('role','button');
      card.setAttribute('tabindex','0');
      card.setAttribute('aria-pressed','false');
      card.setAttribute('aria-label', `${item.code || ''} ${item.name || ''}`.trim());
      if(options.hasQuantity){ card.dataset.hasQty='1'; }

      const main=document.createElement('div');
      main.className='home-care-main';
      const title=document.createElement('div');
      title.className='home-care-title';
      const codeEl=document.createElement('span');
      codeEl.className='home-care-code';
      codeEl.textContent=item.code || '';
      const nameEl=document.createElement('span');
      nameEl.className='home-care-name';
      nameEl.textContent=item.name ? `[${item.name}]` : '';
      title.appendChild(codeEl);
      title.appendChild(nameEl);
      main.appendChild(title);
      const status=document.createElement('span');
      status.className='home-care-status';
      status.textContent='未選取';
      main.appendChild(status);
      card.appendChild(main);

      if(options.hasQuantity){
        const extra=document.createElement('div');
        extra.className='home-care-extra';
        const wrap=document.createElement('div');
        wrap.className='home-care-qty-wrap';
        const label=document.createElement('span');
        label.className='home-care-qty-label';
        label.textContent=options.quantityLabel || '月次';
        const input=document.createElement('input');
        input.type='number';
        input.className='home-care-qty';
        input.dataset.code=item.code || '';
        input.min='0';
        input.step=options.quantityStep || '1';
        input.placeholder=options.quantityPlaceholder || '數量';
        input.disabled=true;
        input.tabIndex=-1;
        input.setAttribute('aria-controls','planSummaryPreview planEditor');
        input.addEventListener('input', evt=>{ onHomeCareQuantityChange(evt.target); });
        input.addEventListener('keydown', evt=>{
          if(evt.key === 'Escape'){
            evt.stopPropagation();
            input.blur();
            card.focus();
          }
        });
        input.addEventListener('click', evt=>{ evt.stopPropagation(); });
        wrap.appendChild(label);
        wrap.appendChild(input);
        extra.appendChild(wrap);
        card.appendChild(extra);
      }

      const toggle = ()=>{
        const nextSelected = card.dataset.selected !== '1';
        handleServiceCardToggle(card, nextSelected, options.onToggle, options.hasQuantity);
      };
      card.addEventListener('click', evt=>{
        if(evt.target && evt.target.closest('.home-care-qty-wrap')) return;
        toggle();
      });
      card.addEventListener('keydown', evt=>{
        if(evt.key === ' ' || evt.key === 'Enter'){
          evt.preventDefault();
          toggle();
        }
      });
      return card;
    }

    function renderHomeCareServices(){
      const host=document.getElementById('homeCareList');
      if(!host) return;
      host.innerHTML='';
      HOME_CARE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          hasQuantity:true,
          quantityLabel:'月目標次數',
          onToggle:(card, selected)=>{ onHomeCareToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderDayCareServices(){
      const host=document.getElementById('dayCareList');
      if(!host) return;
      host.innerHTML='';
      DAY_CARE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onDayCareToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function ensureSingleDayCareSelection(activeCard){
      if(!activeCard || activeCard.dataset.selected !== '1') return;
      const code = activeCard.dataset.code || '';
      if(code.indexOf('BB') !== 0) return;
      document.querySelectorAll('#dayCareList .home-care-item[data-selected="1"]').forEach(card=>{
        if(card === activeCard) return;
        const otherCode = card.dataset.code || '';
        if(otherCode.indexOf('BB') === 0){
          handleServiceCardToggle(card, false, (node)=>{ onDayCareToggle(node, false); }, false);
        }
      });
    }

    function refreshDayCareAvailability(){
      const level = getCmsLevel();
      const requirementMap = SERVICE_CATALOG && SERVICE_CATALOG.dayCareRequirements ? SERVICE_CATALOG.dayCareRequirements : {};
      const levelStr = level ? String(level) : '';
      document.querySelectorAll('#dayCareList .home-care-item').forEach(card=>{
        const code = card.dataset.code || '';
        const required = requirementMap && Object.prototype.hasOwnProperty.call(requirementMap, code)
          ? String(requirementMap[code])
          : '';
        const allow = !levelStr || !required || required === levelStr;
        card.style.display = allow ? '' : 'none';
        if(!allow && card.dataset.selected === '1'){
          handleServiceCardToggle(card, false, (node)=>{ onDayCareToggle(node, false); }, false);
        }
      });
    }

    function renderProfessionalServices(){
      const host=document.getElementById('profServiceList');
      if(!host) return;
      host.innerHTML='';
      PROFESSIONAL_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onProfessionalToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderTransportServices(){
      const host=document.getElementById('transportServiceList');
      if(!host) return;
      host.innerHTML='';
      TRANSPORT_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onTransportToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderRespiteServices(){
      const host=document.getElementById('respServiceList');
      if(!host) return;
      host.innerHTML='';
      RESPITE_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onRespiteToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderMealServices(){
      const host=document.getElementById('mealServiceList');
      if(!host) return;
      host.innerHTML='';
      MEAL_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onMealToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }


    const servicePlanState = {};
    let baFrequencyDisplays = {};
    let selfPayHintDisplays = {};
    const MISMATCH_REASON_OPTIONS = [
      { value:'身體狀況', label:'身體狀況變化', short:'身體狀況' },
      { value:'個案意願', label:'個案意願', short:'個案意願' },
      { value:'資源限制', label:'資源或額度限制', short:'資源限制' },
      { value:'經濟考量', label:'經濟考量', short:'經濟考量' },
      { value:'其他', label:'其他（請說明）', short:'其他' }
    ];
    const MISMATCH_CATEGORY_KEYS = new Set(['居家服務','日間照顧','專業服務','交通接送','喘息服務','無障礙及輔具','營養送餐']);
    const MISMATCH_REASON_LOOKUP = {};
    MISMATCH_REASON_OPTIONS.forEach(opt=>{ MISMATCH_REASON_LOOKUP[opt.value] = opt; });
    let mismatchReasonInitialized = false;
    let currentMismatchDiff = [];
    const planMetaState = {
      referralExtra: '',
      stationInfo: '',
      stationWillingness: '',
      emergencyNote: '',
      foreignCare: false
    };

    const PLAN_CATEGORY_GROUPS = [
      { id:'B', label:'（一）B碼', includes:['B'], anchor:'h3-exec-b' },
      { id:'C', label:'（二）C碼', includes:['C'], anchor:'h3-exec-c' },
      { id:'D', label:'（三）D碼', includes:['D'], anchor:'h3-exec-d' },
      { id:'EF', label:'（四）E.F碼', includes:['EF'], anchor:'h3-exec-ef' },
      { id:'G', label:'（五）G碼', includes:['G'], anchor:'h3-exec-g' },
      { id:'SC', label:'（六）SC碼', includes:['SC'], anchor:'h3-exec-sc' },
      { id:'MEAL', label:'（七）營養餐飲服務', includes:['MEAL'], anchor:'h3-exec-nutrition' }
    ];
    const PLAN_CATEGORY_LOOKUP = {};
    PLAN_CATEGORY_GROUPS.forEach(group=>{
      (group.includes || []).forEach(cat=>{ PLAN_CATEGORY_LOOKUP[String(cat).toUpperCase()] = group.id; });
    });
    const PLAN_CATEGORY_FALLBACK_ID = 'MEAL';
    const UNKNOWN_PLAN_CATEGORY_KEYS = new Set();

    function determineServiceCategory(code){
      if(!code) return '';
      if(code.startsWith('SC')) return 'SC';
      if(code.startsWith('OT')) return 'MEAL';
      if(code.startsWith('DA')) return 'D';
      const first = code.charAt(0);
      if(first === 'B') return 'B';
      if(first === 'C') return 'C';
      if(first === 'D') return 'D';
      if(first === 'E' || first === 'F') return 'EF';
      if(first === 'G') return 'G';
      return '';
    }

    function getPlanCategoryGroupId(cat){
      const key = String(cat || '').toUpperCase();
      if(PLAN_CATEGORY_LOOKUP[key]) return PLAN_CATEGORY_LOOKUP[key];
      if(key && !UNKNOWN_PLAN_CATEGORY_KEYS.has(key)){
        UNKNOWN_PLAN_CATEGORY_KEYS.add(key);
        console.warn('未知服務類別，已套用預設分類', key);
      }
      return PLAN_CATEGORY_FALLBACK_ID;
    }

    function lookupServiceItem(code){
      return HOME_CARE_MAP[code] || DAY_CARE_MAP[code] || PROFESSIONAL_SERVICE_MAP[code] ||
        TRANSPORT_SERVICE_MAP[code] || RESPITE_SERVICE_MAP[code] || MEAL_SERVICE_MAP[code] || null;
    }

    function isBaCode(code){
      return !!(code && BA_CODE_SET.has(code));
    }

    function requiresBaManualUnits(code){
      return !!(code && BA_MANUAL_UNIT_CODES.has(code));
    }

    function ensurePlanEntry(code, initialMonthlyUnits){
      if(!code) return null;
      const item = lookupServiceItem(code);
      if(!servicePlanState[code]){
        servicePlanState[code] = {
          code: code,
          name: item ? (item.name || '') : '',
          category: determineServiceCategory(code),
          vendorMode: '輪派',
          vendorName: '',
          monthlyUnits: '',
          monthlyUnitsComputed: '',
          autoMonthlyUnits: '',
          monthlyUnitsManual: false,
          weeklyFreq: '',
          unitPerVisit: '',
          monthlyExtraVisits: '',
          monthlyExtraUnit: '',
          monthlyExtraDesc: '',
          frequency: '',
          autoFrequencyText: '',
          frequencyManual: false,
          usage: '',
          extra: '',
          period: '',
          planned: '',
          remaining: '',
          original: '',
          mealsPerDay: '',
          mealType: '',
          autoPlanMonthlyVisits: null,
          autoPlanWeeklyVisits: null,
          autoPlanMonthlyUnits: null,
          autoPlanMonthlyUnitCount: null,
          autoPlanRemainingCap: null,
          autoPlanUnitLabel: '',
          autoUsageText: '',
          usageManual: false,
          selfPayAmount: '',
          selfPayManual: false,
          autoWithinCapCopay: null,
          autoExcessSelfPay: null,
          autoTotalSelfPay: null,
          autoPublicExpense: null
        };
      }else if(item && !servicePlanState[code].name){
        servicePlanState[code].name = item.name || '';
      }
      if(item){
        // 由預設詞庫提供基本的「使用方式」描述，
        // 讓填寫者僅需微調即可完成內容；若使用者之後手動覆寫，
        // onPlanFieldChange 會將 usageManual 標記為 true，避免再被自動更新。
        applyAutoUsage(servicePlanState[code], item.short || '');
      }
      if(isBaCode(code) && requiresBaManualUnits(code)){
        const defaultUnits = getBaDefaultUnitsPerVisit(code);
        if(defaultUnits > 0 && !servicePlanState[code].unitPerVisit){
          servicePlanState[code].unitPerVisit = formatPlanNumber(defaultUnits);
        }
      }
      const entry = servicePlanState[code];
      if(entry.selfPayAmount === undefined) entry.selfPayAmount = '';
      if(entry.selfPayManual === undefined) entry.selfPayManual = false;
      if(entry.autoWithinCapCopay === undefined) entry.autoWithinCapCopay = null;
      if(entry.autoExcessSelfPay === undefined) entry.autoExcessSelfPay = null;
      if(entry.autoTotalSelfPay === undefined) entry.autoTotalSelfPay = null;
      if(entry.autoPublicExpense === undefined) entry.autoPublicExpense = null;
      if(initialMonthlyUnits && !servicePlanState[code].monthlyUnits){
        servicePlanState[code].monthlyUnits = initialMonthlyUnits;
        servicePlanState[code].monthlyUnitsManual = true;
        servicePlanState[code].autoMonthlyUnits = null;
      }
      return servicePlanState[code];
    }

    function renderMismatchReasonOptions(){
      if(mismatchReasonInitialized) return;
      const host=document.getElementById('mismatch_reason_box');
      if(!host) return;
      host.innerHTML='';
      MISMATCH_REASON_OPTIONS.forEach(option=>{
        const label=document.createElement('label');
        const input=document.createElement('input');
        input.type='checkbox';
        input.value=option.value;
        input.dataset.mismatchReason='1';
        label.appendChild(input);
        label.appendChild(document.createTextNode(' '+option.label));
        host.appendChild(label);
      });
      mismatchReasonInitialized = true;
      refreshCheckcol('mismatch_reason_box');
    }

    function getSelectedMismatchReasons(){
      return [...document.querySelectorAll('#mismatch_reason_box input[type=checkbox]:checked')]
        .map(input=>input.value);
    }

    function mapEntryToMismatchCategory(entry){
      if(!entry) return '';
      const code=(entry.code || '').trim();
      if(!code) return '';
      if(code.startsWith('BB')) return '日間照顧';
      if(code === 'BD03' || code.startsWith('DA')) return '交通接送';
      const first=code.charAt(0);
      if(first === 'B') return '居家服務';
      if(first === 'C') return '專業服務';
      if(first === 'D') return '交通接送';
      if(first === 'G') return '喘息服務';
      if(first === 'E' || first === 'F') return '無障礙及輔具';
      if(code.startsWith('OT')) return '營養送餐';
      return '';
    }

    function computeMismatchDifferences(){
      const recommended=[...document.querySelectorAll('#sp_formal input[type=checkbox]:checked')]
        .map(input=>input.value)
        .filter(value=>MISMATCH_CATEGORY_KEYS.has(value));
      if(!recommended.length) return [];
      const provided=new Set();
      Object.values(servicePlanState).forEach(entry=>{
        const cat=mapEntryToMismatchCategory(entry);
        if(cat && MISMATCH_CATEGORY_KEYS.has(cat)){
          provided.add(cat);
        }
      });
      const diff=[];
      recommended.forEach(cat=>{
        if(!provided.has(cat)) diff.push(cat);
      });
      return diff;
    }

    function setMismatchError(message){
      const box=document.getElementById('mismatch_reason_error');
      if(!box) return;
      if(message){
        box.textContent=message;
        box.dataset.show='1';
        box.style.display='';
      }else{
        box.textContent='';
        box.dataset.show='0';
        box.style.display='none';
      }
    }

    function updateMismatchReasonOtherVisibility(){
      const other=document.getElementById('mismatch_reason_other');
      if(!other) return;
      const selected=getSelectedMismatchReasons();
      const show=selected.includes('其他');
      other.style.display = show ? '' : 'none';
      if(!show){
        other.value='';
        other.classList.remove('input-invalid');
      }
    }

    function validateMismatchReasons(){
      const diff=currentMismatchDiff || [];
      const other=document.getElementById('mismatch_reason_other');
      const inputs=[...document.querySelectorAll('#mismatch_reason_box input[type=checkbox]')];
      inputs.forEach(input=>input.classList.remove('input-invalid'));
      if(other) other.classList.remove('input-invalid');
      const messages=[];
      if(!diff.length){
        setMismatchError('');
        return { ok:true, messages };
      }
      const selected=getSelectedMismatchReasons();
      if(!selected.length){
        const text='請勾選不一致原因';
        setMismatchError(text);
        inputs.forEach(input=>input.classList.add('input-invalid'));
        messages.push({ fieldId:'mismatch_reason_box', pageId:'goals', text });
      }
      if(selected.includes('其他')){
        const textValue=(other?.value || '').trim();
        if(!textValue){
          const text='請填寫其他原因說明';
          setMismatchError(text);
          if(other) other.classList.add('input-invalid');
          messages.push({ fieldId:'mismatch_reason_other', pageId:'goals', text });
        }
      }
      if(messages.length){
        return { ok:false, messages };
      }
      setMismatchError('');
      return { ok:true, messages:[] };
    }

    function updateMismatchReasons(opts){
      opts = opts || {};
      const diff=computeMismatchDifferences();
      currentMismatchDiff = diff;
      const block=document.getElementById('mismatch_diff_block');
      const list=document.getElementById('mismatch_diff_list');
      const hint=document.getElementById('mismatch_diff_text');
      if(diff.length){
        if(block) block.style.display='';
        if(hint) hint.textContent=`與照專建議服務不一致項目：${diff.join('、')}`;
        if(list){
          list.innerHTML='';
          diff.forEach(name=>{
            const badge=document.createElement('span');
            badge.className='badge';
            badge.textContent=name;
            list.appendChild(badge);
          });
        }
      }else{
        if(block) block.style.display='none';
        if(list) list.innerHTML='';
        setMismatchError('');
      }
      updateMismatchReasonOtherVisibility();
      if(diff.length){
        validateMismatchReasons();
      }
      if(!opts.skipPreview){
        buildApprovalPlanPreview();
      }
    }

    function onMismatchReasonChange(evt){
      const target=evt && evt.target ? evt.target : null;
      if(target && target.type === 'checkbox'){
        target.classList.remove('input-invalid');
      }
      setMismatchError('');
      updateMismatchReasonOtherVisibility();
      updateMismatchReasons();
    }

    function initMismatchReasonControls(){
      renderMismatchReasonOptions();
      const box=document.getElementById('mismatch_reason_box');
      if(box){
        box.addEventListener('change', onMismatchReasonChange);
      }
      const other=document.getElementById('mismatch_reason_other');
      if(other){
        other.addEventListener('input', ()=>{
          other.classList.remove('input-invalid');
          setMismatchError('');
          buildApprovalPlanPreview();
        });
      }
      updateMismatchReasonOtherVisibility();
      updateMismatchReasons({skipPreview:true});
    }

    function getMismatchReasonSummary(){
      if(!currentMismatchDiff || !currentMismatchDiff.length) return '';
      const selected=getSelectedMismatchReasons();
      if(!selected.length) return '';
      const names=[];
      selected.forEach(value=>{
        const option=MISMATCH_REASON_LOOKUP[value];
        if(value === '其他'){
          const other=(document.getElementById('mismatch_reason_other')?.value || '').trim();
          if(other){
            names.push(other);
          }
        }else if(option && option.short){
          names.push(option.short);
        }else{
          names.push(value);
        }
      });
      const unique=[];
      names.forEach(name=>{
        if(name && unique.indexOf(name) === -1){
          unique.push(name);
        }
      });
      if(!unique.length) return '';
      return `不一致原因：${unique.join('、')}`;
    }

    function removePlanEntry(code){
      if(servicePlanState[code]) delete servicePlanState[code];
    }

    function getAllSelectedServiceCodes(){
      const codes = new Set();
      document.querySelectorAll('#homeCareList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#dayCareList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#profServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#transportServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#respServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#mealServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      return Array.from(codes);
    }

    function syncPlanStateWithSelections(options){
      options = options || {};
      if(isRestoringDraft && !options.force){
        schedulePlanStateSync(options);
        return;
      }
      const skipPreview = !!options.skipPreview;
      const selected = new Set(getAllSelectedServiceCodes());
      Object.keys(servicePlanState).forEach(code=>{
        if(!selected.has(code)) delete servicePlanState[code];
      });
      selected.forEach(code=>{
        let initial='';
        if(code.startsWith('BA') || code.startsWith('BD')){
          const qtyInput=document.querySelector(`#homeCareList .home-care-qty[data-code="${code}"]`);
          if(qtyInput && qtyInput.value.trim()) initial = qtyInput.value.trim();
        }
        ensurePlanEntry(code, initial);
      });
      applyAutomaticPlanning();
      renderServicePlanEditor();
      updateMismatchReasons({ skipPreview: skipPreview });
      if(!skipPreview){
        buildPlanSummaryPreview();
        buildApprovalPlanPreview();
      }
      if(!isRestoringDraft && draftLoadComplete) scheduleAutoSave();
    }

    function isFiniteNumber(value){
      return typeof value === 'number' && isFinite(value);
    }

    function formatAutoInteger(value){
      if(!isFiniteNumber(value)) return '';
      return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatAutoDecimal(value){
      if(!isFiniteNumber(value)) return '';
      const rounded = Math.round(value * 10) / 10;
      if(Math.abs(rounded - Math.round(rounded)) < 1e-6) return String(Math.round(rounded));
      return rounded.toFixed(1).replace(/\.0$/, '');
    }

    function toCurrencyInt(value){
      if(value === undefined || value === null) return 0;
      const num = Number(value);
      if(!Number.isFinite(num)) return 0;
      return Math.max(0, Math.floor(num));
    }

    function computeFinancials(options){
      options = options || {};
      const copayCandidate = Number(options.copayRate);
      const transportCandidate = Number(options.transportTierRate);
      const ratePercent = Number.isFinite(copayCandidate) ? copayCandidate : (Number.isFinite(transportCandidate) ? transportCandidate : 0);
      const rate = Math.max(0, ratePercent);
      const cap = toCurrencyInt(options.cap);
      const sum = toCurrencyInt(options.sum);
      const hasForeignCare = !!options.hasForeignCare;
      const foreignRateCandidate = options.foreignCare30;
      let foreignRate = 0.3;
      let applyForeignDeduct = hasForeignCare;
      if(foreignRateCandidate !== undefined && foreignRateCandidate !== null && foreignRateCandidate !== ''){
        const numeric = Number(foreignRateCandidate);
        if(Number.isFinite(numeric)){
          applyForeignDeduct = applyForeignDeduct || numeric > 0;
          if(numeric > 1){
            foreignRate = numeric / 100;
          }else if(numeric >= 0){
            foreignRate = numeric;
          }
        }
      }
      if(!Number.isFinite(foreignRate) || foreignRate < 0){
        foreignRate = 0;
      }
      if(foreignRate > 1){
        foreignRate = 1;
      }
      let effectiveCap = cap;
      let foreignDeduct = 0;
      if(applyForeignDeduct && cap > 0 && foreignRate > 0){
        foreignDeduct = toCurrencyInt(cap * foreignRate);
        effectiveCap = Math.max(0, cap - foreignDeduct);
      }
      if(options.annualCap !== undefined){
        const annual = toCurrencyInt(options.annualCap);
        if(annual > 0){
          effectiveCap = effectiveCap > 0 ? Math.min(effectiveCap, annual) : annual;
        }
      }
      if(options.threeYearCap !== undefined){
        const threeYear = toCurrencyInt(options.threeYearCap);
        if(threeYear > 0){
          effectiveCap = effectiveCap > 0 ? Math.min(effectiveCap, threeYear) : threeYear;
        }
      }
      const withinCapUsage = Math.min(sum, effectiveCap);
      const withinCapCopay = toCurrencyInt(withinCapUsage * (rate / 100));
      const publicExpense = Math.max(0, withinCapUsage - withinCapCopay);
      const excessUsage = Math.max(0, sum - effectiveCap);
      const excessSelfPay = toCurrencyInt(excessUsage);
      const totalSelfPay = withinCapCopay + excessSelfPay;
      return {
        cap: cap,
        effectiveCap: effectiveCap,
        foreignDeduct: foreignDeduct,
        usage: sum,
        withinCapUsage: withinCapUsage,
        withinCapCopay: withinCapCopay,
        publicExpense: publicExpense,
        excessSelfPay: excessSelfPay,
        totalSelfPay: totalSelfPay
      };
    }

    function getHouseholdStatus(){
      const field = document.getElementById('s2_id');
      if(!field) return '一般戶';
      const value = (field.value || '').trim();
      return value || '一般戶';
    }

    function getCopayRate(bucket){
      if(!bucket) return 0;
      const status = getHouseholdStatus();
      const map = SERVICE_CATALOG && SERVICE_CATALOG.copayRates ? SERVICE_CATALOG.copayRates[bucket] : null;
      if(map && Object.prototype.hasOwnProperty.call(map, status)){
        const num = Number(map[status]);
        if(!Number.isNaN(num)) return num;
      }
      const fallback = DEFAULT_SERVICE_CATALOG.copayRates && DEFAULT_SERVICE_CATALOG.copayRates[bucket]
        ? DEFAULT_SERVICE_CATALOG.copayRates[bucket]
        : null;
      if(fallback && Object.prototype.hasOwnProperty.call(fallback, status)){
        const num = Number(fallback[status]);
        return Number.isNaN(num) ? 0 : num;
      }
      return 0;
    }

    function getBcCopayRate(){
      return getCopayRate('B/C（照顧及專業服務）');
    }

    function getTransportCategory(){
      const category = SERVICE_CATALOG && SERVICE_CATALOG.transportCategory
        ? SERVICE_CATALOG.transportCategory
        : DEFAULT_SERVICE_CATALOG.transportCategory;
      return category || '第二類';
    }

    function getTransportCopayRate(){
      const category = getTransportCategory();
      return getCopayRate(`D-${category}（交通接送）`);
    }

    function getLevelDetails(level){
      const key = level ? String(level) : '';
      if(!key) return null;
      const fromCatalog = SERVICE_CATALOG && SERVICE_CATALOG.levelDetails ? SERVICE_CATALOG.levelDetails[key] : null;
      if(fromCatalog) return fromCatalog;
      const fallback = DEFAULT_SERVICE_CATALOG.levelDetails ? DEFAULT_SERVICE_CATALOG.levelDetails[key] : null;
      return fallback || null;
    }

    function getGAnnualCap(level){
      const details = getLevelDetails(level);
      if(!details) return 0;
      return Number(details.gAnnualCap) || 0;
    }

    function getEfThreeYearCap(level){
      const details = getLevelDetails(level);
      if(!details) return 0;
      return Number(details.efThreeYearCap) || 0;
    }

    function hasForeignCareFlag(){
      const field = document.getElementById('hasForeignCare');
      if(!field) return false;
      if(field.type === 'checkbox') return field.checked;
      const value = String(field.value || '').trim();
      return value === '是' || value === 'Y' || value === 'true';
    }

    function getCmsMonthlyCap(level){
      if(!level) return 0;
      const catalogCaps = SERVICE_CATALOG && SERVICE_CATALOG.needLevelCaps ? SERVICE_CATALOG.needLevelCaps : {};
      if(catalogCaps && Object.prototype.hasOwnProperty.call(catalogCaps, level)){
        const cap = Number(catalogCaps[level]);
        if(!isNaN(cap)) return cap;
      }
      const fallback = DEFAULT_SERVICE_CATALOG.needLevelCaps[level];
      return fallback ? Number(fallback) : 0;
    }

    function getServiceRate(code){
      if(!code) return null;
      const rates = SERVICE_CATALOG && SERVICE_CATALOG.serviceRates ? SERVICE_CATALOG.serviceRates : null;
      if(rates && rates[code]) return rates[code];
      return null;
    }

    function applyAutoUsage(entry, text){
      if(!entry) return;
      const content = (text || '').trim();
      entry.autoUsageText = content;
      if(!content) return;
      if(!entry.usageManual || !entry.usage || entry.usage === content){
        entry.usage = content;
        entry.usageManual = false;
      }
    }

    function clearAutoPlan(entry){
      if(!entry) return;
      entry.autoPlanMonthlyVisits = null;
      entry.autoPlanWeeklyVisits = null;
      entry.autoPlanMonthlyUnits = null;
      entry.autoPlanRemainingCap = null;
      entry.autoPlanUnitLabel = '';
      entry.autoFrequencyText = '';
      entry.autoWithinCapCopay = null;
      entry.autoExcessSelfPay = null;
      entry.autoTotalSelfPay = null;
      entry.autoPublicExpense = null;
      updateSelfPayHint(entry.code);
    }

    function updateEntryAutoValues(entry, info){
      if(!entry || !info) return;
      if(typeof info.monthlyVisits === 'number' && isFinite(info.monthlyVisits)){
        entry.autoPlanMonthlyVisits = Math.max(0, Math.floor(info.monthlyVisits));
      }else{
        entry.autoPlanMonthlyVisits = null;
      }
      if(typeof info.weeklyVisits === 'number' && isFinite(info.weeklyVisits)){
        entry.autoPlanWeeklyVisits = Math.max(0, info.weeklyVisits);
      }else{
        entry.autoPlanWeeklyVisits = null;
      }
      if(typeof info.monthlyUnits === 'number' && isFinite(info.monthlyUnits)){
        entry.autoPlanMonthlyUnits = Math.max(0, info.monthlyUnits);
      }else{
        entry.autoPlanMonthlyUnits = null;
      }
      if(typeof info.remaining === 'number' && isFinite(info.remaining)){
        entry.autoPlanRemainingCap = Math.max(0, info.remaining);
      }else{
        entry.autoPlanRemainingCap = null;
      }
      if(info.unitLabel){
        entry.autoPlanUnitLabel = info.unitLabel;
      }
      if(Object.prototype.hasOwnProperty.call(info, 'withinCapCopay')){
        entry.autoWithinCapCopay = info.withinCapCopay === null ? null : toCurrencyInt(info.withinCapCopay);
      }
      if(Object.prototype.hasOwnProperty.call(info, 'excessSelfPay')){
        entry.autoExcessSelfPay = info.excessSelfPay === null ? null : toCurrencyInt(info.excessSelfPay);
      }
      if(Object.prototype.hasOwnProperty.call(info, 'totalSelfPay')){
        entry.autoTotalSelfPay = info.totalSelfPay === null ? null : toCurrencyInt(info.totalSelfPay);
      }
      if(Object.prototype.hasOwnProperty.call(info, 'publicExpense')){
        entry.autoPublicExpense = info.publicExpense === null ? null : toCurrencyInt(info.publicExpense);
      }
      updateSelfPayHint(entry.code);
    }

    function buildAutoSummaryText(entry){
      if(!entry) return '';
      const unitLabel = entry.autoPlanUnitLabel || (entry.code === 'BD03' ? '趟' : '次');
      const parts=[];
      if(isFiniteNumber(entry.autoPlanMonthlyVisits)){
        const monthly = formatAutoInteger(entry.autoPlanMonthlyVisits);
        const weekly = formatAutoDecimal(entry.autoPlanWeeklyVisits);
        if(weekly){
          const weekUnit = unitLabel === '趟' ? '趟' : '次';
          parts.push(`每月約${monthly}${unitLabel}（每週約${weekly}${weekUnit}）`);
        }else{
          parts.push(`每月約${monthly}${unitLabel}`);
        }
      }
      if(isFiniteNumber(entry.autoPlanMonthlyUnits)){
        parts.push(`預估耗用${formatAutoInteger(entry.autoPlanMonthlyUnits)}元`);
      }
      if(isFiniteNumber(entry.autoPlanRemainingCap)){
        parts.push(`預估餘額${formatAutoInteger(entry.autoPlanRemainingCap)}元`);
      }
      if(isFiniteNumber(entry.autoWithinCapCopay)){
        parts.push(`上限內自付${formatAutoInteger(entry.autoWithinCapCopay)}元`);
      }
      if(isFiniteNumber(entry.autoExcessSelfPay)){
        parts.push(`超額自付${formatAutoInteger(entry.autoExcessSelfPay)}元`);
      }
      if(isFiniteNumber(entry.autoTotalSelfPay)){
        parts.push(`總自付${formatAutoInteger(entry.autoTotalSelfPay)}元`);
      }
      const freq = (entry.autoFrequencyText || '').trim();
      if(freq && parts.indexOf(freq) === -1){
        parts.push(freq);
      }
      return parts.join('，');
    }

    function applyAutomaticPlanning(){
      updateDayCareAutoPlan();
    }

    function updateDayCareAutoPlan(){
      const cmsLevel = getCmsLevel();
      const cap = getCmsMonthlyCap(cmsLevel);
      const dayCareEntries = getSelectedDayCareEntries();
      const dayCareCode = dayCareEntries
        .map(entry => entry && entry.code ? entry.code : '')
        .find(code => code.indexOf('BB') === 0);
      const dayCareEntry = dayCareCode ? ensurePlanEntry(dayCareCode) : null;
      const transportEntry = servicePlanState['BD03'] ? servicePlanState['BD03'] : null;
      const dayCareItem = dayCareEntry ? DAY_CARE_MAP[dayCareEntry.code] : null;
      const dayCareRate = dayCareEntry ? getServiceRate(dayCareEntry.code) : null;
      const transportRate = transportEntry ? getServiceRate('BD03') : null;
      const roundTrips = SERVICE_CATALOG && SERVICE_CATALOG.transportRoundTrips ? SERVICE_CATALOG.transportRoundTrips : 2;
      const transportItem = transportEntry ? lookupServiceItem('BD03') : null;
      const weeksPerMonth = 4.5; // 依據長照給付計算基準，平均每月約 4.5 週。

      if(dayCareEntry){
        applyAutoUsage(dayCareEntry, dayCareItem ? dayCareItem.short : '');
      }
      if(transportEntry){
        applyAutoUsage(transportEntry, transportItem ? transportItem.short : '');
      }

      if(!dayCareEntry || !dayCareItem || !dayCareRate){
        if(dayCareEntry) clearAutoPlan(dayCareEntry);
        if(transportEntry) clearAutoPlan(transportEntry);
        return;
      }

      const basePerVisit = Number(dayCareRate.price) || 0;
      const transportPerVisit = transportEntry && transportRate ? (Number(transportRate.price) || 0) * roundTrips : 0;
      const totalPerVisit = basePerVisit + transportPerVisit;

      if(cap <= 0 || totalPerVisit <= 0){
        clearAutoPlan(dayCareEntry);
        if(transportEntry) clearAutoPlan(transportEntry);
        dayCareEntry.autoFrequencyText = '請先設定 CMS 等級與可用額度。';
        if(transportEntry) transportEntry.autoFrequencyText = '待日間照顧額度確認後再安排交通。';
        return;
      }

      const weeklyLimit = 7;
      const limitMonthly = Math.floor(weeksPerMonth * weeklyLimit);
      const rawMonthlyVisits = Math.max(0, Math.floor(cap / totalPerVisit));
      const monthlyVisits = Math.min(rawMonthlyVisits, limitMonthly);
      const cappedByWeeklyLimit = rawMonthlyVisits > limitMonthly;
      const weeklyVisits = monthlyVisits > 0 ? Math.min(weeklyLimit, monthlyVisits / weeksPerMonth) : 0;
      const dayCareUsage = toCurrencyInt(basePerVisit * monthlyVisits);
      const transportUsage = toCurrencyInt(transportPerVisit * monthlyVisits);
      const totalUsage = dayCareUsage + transportUsage;
      const copayRate = getBcCopayRate();
      const financials = computeFinancials({
        cap: cap,
        sum: totalUsage,
        copayRate: copayRate,
        hasForeignCare: hasForeignCareFlag()
      });
      const remainingCap = Math.max(0, financials.effectiveCap - financials.withinCapUsage);

      function allocateAmount(totalAmount, weights){
        const result = weights.map(()=>0);
        const normalizedWeights = weights.map(weight=>Math.max(0, toCurrencyInt(weight)));
        const totalWeight = normalizedWeights.reduce((sum, weight)=>sum + weight, 0);
        const totalInt = toCurrencyInt(totalAmount);
        if(!(totalInt > 0) || totalWeight <= 0){
          return result;
        }
        let remainder = totalInt;
        normalizedWeights.forEach((weight, idx)=>{
          if(weight <= 0){
            result[idx] = 0;
            return;
          }
          const share = Math.floor((totalInt * weight) / totalWeight);
          result[idx] = share;
          remainder -= share;
        });
        if(remainder > 0){
          const order = normalizedWeights
            .map((weight, idx)=>({ weight, idx }))
            .filter(item=>item.weight > 0)
            .sort((a,b)=>{
              if(b.weight === a.weight){
                return a.idx - b.idx;
              }
              return b.weight - a.weight;
            });
          for(let i=0;i<order.length && remainder>0;i++){
            result[order[i].idx] += 1;
            remainder -= 1;
          }
        }
        return result;
      }

      const usageWeights = [dayCareUsage, transportUsage];
      const withinShares = allocateAmount(financials.withinCapCopay, usageWeights);
      const excessShares = allocateAmount(financials.excessSelfPay, usageWeights);
      const publicShares = allocateAmount(financials.publicExpense, usageWeights);
      const dayWithin = withinShares[0];
      const transportWithin = withinShares[1];
      const dayExcess = excessShares[0];
      const transportExcess = excessShares[1];
      const dayPublic = publicShares[0];
      const transportPublic = publicShares[1];
      const dayTotalSelfPay = dayWithin + dayExcess;
      const transportTotalSelfPay = transportWithin + transportExcess;

      updateEntryAutoValues(dayCareEntry, {
        monthlyVisits: monthlyVisits,
        weeklyVisits: weeklyVisits,
        monthlyUnits: dayCareUsage,
        remaining: remainingCap,
        unitLabel: '次',
        withinCapCopay: dayWithin,
        excessSelfPay: dayExcess,
        totalSelfPay: dayTotalSelfPay,
        publicExpense: dayPublic
      });
      if(monthlyVisits > 0){
        const weeklyText = formatAutoDecimal(weeklyVisits) || '0';
        let freqText = `預估每月${monthlyVisits}次（約每週${weeklyText}次）`;
        freqText += '，每日最多 1 次，每週不超過 7 次';
        if(cappedByWeeklyLimit){
          freqText += '（已套用上限）';
        }
        dayCareEntry.autoFrequencyText = freqText + '。';
      }else{
        dayCareEntry.autoFrequencyText = '額度不足以安排日間照顧，請調整服務組合。';
      }

      if(transportEntry){
        const transportMonthly = monthlyVisits * roundTrips;
        const transportWeekly = monthlyVisits > 0 ? (transportMonthly / weeksPerMonth) : 0;
        updateEntryAutoValues(transportEntry, {
          monthlyVisits: transportMonthly,
          weeklyVisits: transportWeekly,
          monthlyUnits: transportUsage,
          remaining: remainingCap,
          unitLabel: '趟',
          withinCapCopay: transportWithin,
          excessSelfPay: transportExcess,
          totalSelfPay: transportTotalSelfPay,
          publicExpense: transportPublic
        });
        transportEntry.autoFrequencyText = monthlyVisits > 0
          ? `搭配日間照顧往返${roundTrips}趟／次，月計約${formatAutoInteger(transportEntry.autoPlanMonthlyVisits)}趟（每週約${formatAutoDecimal(transportWeekly)}趟）`
          : '待日間照顧額度確認後再安排交通。';
      }else if(monthlyVisits > 0 && transportRate){
        dayCareEntry.autoFrequencyText += '（如需交通接送，請勾選 BD03 以納入額度）';
      }
    }

    function createPlanInput(entry, field, label, opts){
      opts = opts || {};
      const wrap=document.createElement('div');
      wrap.className='plan-field' + (opts.className ? ' '+opts.className : '');
      const lab=document.createElement('label');
      lab.textContent=label;
      wrap.appendChild(lab);
      let input;
      if(opts.as === 'textarea'){
        input=document.createElement('textarea');
        input.value = entry[field] || '';
      }else if(opts.as === 'select'){
        input=document.createElement('select');
        (opts.options || []).forEach(opt=>{
          const option=document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          input.appendChild(option);
        });
        input.value = entry[field] || (opts.defaultValue || (opts.options && opts.options[0] ? opts.options[0].value : ''));
      }else{
        input=document.createElement('input');
        input.type = opts.type || 'text';
        if(opts.attrs){
          Object.keys(opts.attrs).forEach(key=> input.setAttribute(key, opts.attrs[key]));
        }
        input.value = entry[field] || '';
      }
      if(opts.placeholder) input.placeholder = opts.placeholder;
      input.dataset.planCode = entry.code;
      input.dataset.planField = field;
      input.addEventListener(opts.as === 'select' ? 'change' : 'input', onPlanFieldChange);
      wrap.appendChild(input);
      if(field === 'monthlyUnits'){
        const toolbar=document.createElement('div');
        toolbar.className='plan-qty-toolbar';
        const hint=document.createElement('span');
        hint.className='plan-qty-hint';
        hint.textContent='快速調整';
        toolbar.appendChild(hint);
        const steps=[
          {label:'－1', delta:-1},
          {label:'＋1', delta:1},
          {label:'＋5', delta:5},
          {label:'＋10', delta:10}
        ];
        steps.forEach(step=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='tiny';
          btn.textContent=step.label;
          btn.addEventListener('click', ()=>{ adjustMonthlyUnits(entry.code, step.delta); });
          toolbar.appendChild(btn);
        });
        const clearBtn=document.createElement('button');
        clearBtn.type='button';
        clearBtn.className='tiny';
        clearBtn.dataset.variant='ghost';
        clearBtn.textContent='清除';
        clearBtn.addEventListener('click', ()=>{ setMonthlyUnitsValue(entry.code, 0); });
        toolbar.appendChild(clearBtn);
        wrap.appendChild(toolbar);
      }
      return {wrap, input};
    }

    function onPlanFieldChange(evt){
      const field = evt.target.dataset.planField;
      const code = evt.target.dataset.planCode;
      if(!field || !code) return;
      const entry = servicePlanState[code];
      if(!entry) return;
      entry[field] = evt.target.value;
      let skipPreview=false;
      const isBa=isBaCode(code);
      if(field === 'vendorMode'){
        updatePlanVendorVisibility(code);
      }else if(field === 'monthlyUnits'){
        if((entry[field]||'').trim()){
          entry.monthlyUnitsManual = true;
          if(!isBa) entry.autoMonthlyUnits = null;
        }else{
          entry.monthlyUnitsManual = false;
          if(!isBa) entry.autoMonthlyUnits = '';
        }
        if(isBa){
          updateBaEntryDerived(code);
          skipPreview=true;
        }else{
          updatePlanMonthlyComputation(code);
          skipPreview=true;
        }
      }else if(field === 'selfPayAmount'){
        const value = (entry[field] || '').trim();
        entry.selfPayManual = value !== '';
        updateSelfPayHint(code);
      }else if(field === 'frequency'){
        if((entry[field]||'').trim()){
          entry.frequencyManual = true;
        }else{
          entry.frequencyManual = false;
          entry.autoFrequencyText = '';
          if(isBa){
            updateBaEntryDerived(code);
            skipPreview=true;
          }else{
            updatePlanMonthlyComputation(code);
            skipPreview=true;
          }
        }
      }else if(field === 'weeklyFreq' || field === 'unitPerVisit' || field === 'monthlyExtraVisits' || field === 'monthlyExtraUnit' || field === 'monthlyExtraDesc'){
        if(isBa && field === 'unitPerVisit'){
          updateBaEntryDerived(code);
          skipPreview=true;
        }else if(!isBa){
          updatePlanMonthlyComputation(code);
          skipPreview=true;
        }
      }else if(field === 'usage'){
        entry.usageManual = !!((entry.usage || '').trim() && entry.usage !== entry.autoUsageText);
      }
      if(!skipPreview) buildApprovalPlanPreview();
    }

    function getPlanFieldElement(code, field){
      return document.querySelector(`[data-plan-code="${code}"][data-plan-field="${field}"]`);
    }

    function parsePlanNumber(value){
      if(value === undefined || value === null) return 0;
      const num=parseFloat(String(value).replace(/[^0-9\-\.]/g,''));
      return isNaN(num) ? 0 : num;
    }

    function formatPlanNumber(value){
      if(value === undefined || value === null) return '';
      const num = typeof value === 'number' ? value : parseFloat(value);
      if(!isFinite(num)) return '';
      const fixed = Math.round(num * 100) / 100;
      if(Math.abs(fixed - Math.round(fixed)) < 1e-6) return String(Math.round(fixed));
      return fixed.toFixed(2).replace(/\.00$/, '').replace(/0$/, '');
    }

    function getBaDefaultUnitsPerVisit(code){
      if(code && Object.prototype.hasOwnProperty.call(BA_DEFAULT_UNITS_PER_VISIT, code)){
        const configured = Number(BA_DEFAULT_UNITS_PER_VISIT[code]);
        if(Number.isFinite(configured) && configured > 0){
          return configured;
        }
      }
      return 1;
    }

    function getBaPerVisitUnits(entry){
      if(!entry) return 1;
      const code = entry.code || '';
      if(requiresBaManualUnits(code)){
        const manual = parsePlanNumber(entry.unitPerVisit);
        if(manual > 0) return manual;
      }
      return getBaDefaultUnitsPerVisit(code);
    }

    function buildBaWeeklyText(entry){
      if(!entry || !isBaCode(entry.code)) return '';
      const weekly = isFiniteNumber(entry.autoPlanWeeklyVisits) ? entry.autoPlanWeeklyVisits : 0;
      const perVisit = getBaPerVisitUnits(entry);
      const unitCount = isFiniteNumber(entry.autoPlanMonthlyUnitCount)
        ? entry.autoPlanMonthlyUnitCount
        : 0;
      if(!(weekly > 0 && perVisit > 0 && unitCount > 0)) return '';
      const weeklyText = formatPlanNumber(weekly);
      const perVisitText = formatPlanNumber(perVisit);
      const monthlyText = formatPlanNumber(unitCount);
      const targetVisits = parsePlanNumber(entry.monthlyUnits);
      const targetText = targetVisits > 0 ? formatPlanNumber(targetVisits) : '';
      const suffix = targetText ? `（月目標${targetText}次）` : '';
      return `每週${weeklyText}次×每次${perVisitText}單位＝約${monthlyText}單位/月${suffix}`;
    }

    function updateBaFrequencyDisplay(code){
      if(!code) return;
      const box = baFrequencyDisplays[code];
      if(!box || !box.isConnected){
        if(baFrequencyDisplays[code]) delete baFrequencyDisplays[code];
        return;
      }
      const entry = servicePlanState[code];
      const text = buildBaWeeklyText(entry);
      if(text){
        box.textContent = text;
        box.classList.remove('empty');
      }else{
        box.textContent = '尚未設定月目標';
        box.classList.add('empty');
      }
    }

    function updateBaEntryDerived(code, opts){
      if(!code || !isBaCode(code)) return;
      const entry = servicePlanState[code];
      if(!entry) return;
      const targetVisits = parsePlanNumber(entry.monthlyUnits);
      const weeklyVisits = targetVisits > 0 ? Math.ceil(targetVisits / 4.5) : 0;
      const perVisitUnits = getBaPerVisitUnits(entry);
      const scheduledMonthlyVisits = weeklyVisits > 0 ? weeklyVisits * 4.5 : 0;
      const monthlyUnitCount = (weeklyVisits > 0 && perVisitUnits > 0)
        ? scheduledMonthlyVisits * perVisitUnits
        : 0;
      entry.autoPlanUnitLabel = '次';
      entry.autoPlanWeeklyVisits = weeklyVisits > 0 ? weeklyVisits : null;
      entry.autoPlanMonthlyVisits = scheduledMonthlyVisits > 0 ? scheduledMonthlyVisits : null;
      entry.autoPlanMonthlyUnitCount = monthlyUnitCount > 0 ? monthlyUnitCount : null;
      entry.monthlyUnitsComputed = monthlyUnitCount > 0 ? formatPlanNumber(monthlyUnitCount) : '';
      entry.autoMonthlyUnits = entry.monthlyUnitsComputed;
      const rate = getServiceRate(code);
      let price = 0;
      if(rate && rate.price !== undefined && rate.price !== null){
        const numericPrice = Number(rate.price);
        if(Number.isFinite(numericPrice) && numericPrice > 0){
          price = numericPrice;
        }
      }
      const monthlyCost = monthlyUnitCount > 0 && price > 0 ? monthlyUnitCount * price : 0;
      const costInt = monthlyCost > 0 ? toCurrencyInt(monthlyCost) : 0;
      entry.autoPlanMonthlyUnits = costInt > 0 ? costInt : null;
      const freqText = buildBaWeeklyText(entry);
      if(freqText){
        entry.autoFrequencyText = freqText;
        if(!entry.frequencyManual || !entry.frequency || entry.frequency === entry.autoFrequencyText){
          entry.frequency = freqText;
          entry.frequencyManual = false;
        }
      }else if(!entry.frequencyManual){
        entry.autoFrequencyText = '';
        entry.frequency = '';
      }
      updateBaFrequencyDisplay(code);
      if(!(opts && opts.skipPreview)){
        buildApprovalPlanPreview();
        buildPlanSummaryPreview();
      }
    }

    function updatePlanMonthlyComputation(code, opts){
      const entry = servicePlanState[code];
      if(!entry) return;
      const weekly = parsePlanNumber(entry.weeklyFreq);
      const perVisit = parsePlanNumber(entry.unitPerVisit);
      const extraVisits = parsePlanNumber(entry.monthlyExtraVisits);
      let extraUnit = parsePlanNumber(entry.monthlyExtraUnit);
      if(extraVisits > 0 && (!entry.monthlyExtraUnit || !entry.monthlyExtraUnit.trim()) && perVisit > 0){
        extraUnit = perVisit;
        entry.monthlyExtraUnit = formatPlanNumber(perVisit);
        const extraUnitInput = getPlanFieldElement(code, 'monthlyExtraUnit');
        if(extraUnitInput && extraUnitInput !== document.activeElement){
          extraUnitInput.value = formatPlanNumber(perVisit);
        }
      }
      const baseUnits = weekly > 0 && perVisit > 0 ? weekly * perVisit * 4.5 : 0;
      const extraUnits = extraVisits > 0 && extraUnit > 0 ? extraVisits * extraUnit : 0;
      const total = baseUnits + extraUnits;
      const computed = total > 0 ? String(Math.ceil(total)) : '';
      entry.monthlyUnitsComputed = computed;
      if(computed && entry.autoMonthlyUnits !== null){
        if(!entry.monthlyUnitsManual || !entry.monthlyUnits || entry.monthlyUnits === entry.autoMonthlyUnits || entry.autoMonthlyUnits === ''){
          entry.monthlyUnits = computed;
          entry.autoMonthlyUnits = computed;
          const monthlyInput = getPlanFieldElement(code, 'monthlyUnits');
          if(monthlyInput && monthlyInput !== document.activeElement){
            monthlyInput.value = computed;
          }
        }else{
          entry.autoMonthlyUnits = computed;
        }
      }
      if(!computed && entry.autoMonthlyUnits !== null && !entry.monthlyUnitsManual){
        entry.autoMonthlyUnits = '';
      }

      const freqParts=[];
      if(weekly > 0 && perVisit > 0){
        const baseText = `${formatPlanNumber(weekly)}×${formatPlanNumber(perVisit)}×4.5=${formatPlanNumber(baseUnits)}`;
        freqParts.push(`每週${formatPlanNumber(weekly)}次，每次${formatPlanNumber(perVisit)}單位（${baseText}）`);
      }
      if(extraVisits > 0){
        const unitEach = extraUnit > 0 ? formatPlanNumber(extraUnit) : '';
        const extraCalc = extraUnit > 0 ? `（${formatPlanNumber(extraVisits)}×${unitEach}=${formatPlanNumber(extraUnits)}）` : '';
        let extraDesc = `另每月${formatPlanNumber(extraVisits)}次`;
        if(unitEach) extraDesc += `，每次${unitEach}單位`;
        extraDesc += extraCalc;
        if(entry.monthlyExtraDesc){
          extraDesc += `，${entry.monthlyExtraDesc}`;
        }
        freqParts.push(extraDesc);
      }else if(entry.monthlyExtraDesc){
        freqParts.push(entry.monthlyExtraDesc);
      }
      if(total > 0){
        const baseText = formatPlanNumber(baseUnits);
        const extraText = formatPlanNumber(extraUnits);
        if(extraUnits > 0){
          freqParts.push(`共計${baseText}+${extraText}=${computed}（單位/月）`);
        }else{
          freqParts.push(`共計${computed || baseText}（單位/月）`);
        }
      }
      const freqText = freqParts.join('，');
      if(freqText){
        if(!entry.frequencyManual || !entry.frequency || entry.frequency === entry.autoFrequencyText){
          entry.frequency = freqText;
          entry.autoFrequencyText = freqText;
          const freqInput = getPlanFieldElement(code, 'frequency');
          if(freqInput && freqInput !== document.activeElement){
            freqInput.value = freqText;
          }
        }else{
          entry.autoFrequencyText = freqText;
        }
      }
      if(!(opts && opts.skipPreview)){
        buildApprovalPlanPreview();
      }
    }

    function setMonthlyUnitsValue(code, value){
      if(!code) return;
      const input = getPlanFieldElement(code, 'monthlyUnits');
      if(!input) return;
      let numeric = 0;
      if(typeof value === 'number' && isFinite(value)){
        numeric = value;
      }else if(typeof value === 'string' && value.trim()){
        numeric = parsePlanNumber(value);
      }
      const str = numeric > 0 ? formatPlanNumber(numeric) : '';
      input.value = str;
      input.dispatchEvent(new Event('input', { bubbles:true }));
    }

    function adjustMonthlyUnits(code, delta){
      if(!code) return;
      const numericDelta = (typeof delta === 'number' && isFinite(delta)) ? delta : parsePlanNumber(delta);
      if(!isFinite(numericDelta)) return;
      const input = getPlanFieldElement(code, 'monthlyUnits');
      if(!input) return;
      const current = parsePlanNumber(input.value);
      const next = Math.max(0, current + numericDelta);
      setMonthlyUnitsValue(code, next);
    }

    function updatePlanVendorVisibility(code){
      const entry = servicePlanState[code];
      const show = entry && entry.vendorMode === '指定';
      document.querySelectorAll(`[data-plan-vendor-name="${code}"]`).forEach(el=>{
        el.style.display = show ? '' : 'none';
      });
    }

    function planCategoryLabel(cat){
      const groupId = getPlanCategoryGroupId(cat);
      const group = PLAN_CATEGORY_GROUPS.find(item=>item.id === groupId);
      if(!group) return '其他服務';
      if(group.anchor){
        const entry = getHeadingEntry(group.anchor);
        if(entry && entry.label) return entry.label;
      }
      return group.label || '其他服務';
    }

    function formatSummaryVendorName(entry){
      if(!entry) return '';
      const mode = (entry.vendorMode || '').trim();
      if(mode === '指定'){
        return entry.vendorName || '（請填單位）';
      }
      return entry.vendorName || '';
    }

    function formatSummaryAmount(entry){
      if(!entry) return '';
      const category = (entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
      const lines = [];
      if(category === 'B'){
        const hasAuto = isFiniteNumber(entry.autoPlanMonthlyVisits) || isFiniteNumber(entry.autoPlanMonthlyUnits);
        if(hasAuto){
          if(isFiniteNumber(entry.autoPlanMonthlyVisits)){
            const unitLabel = entry.autoPlanUnitLabel || (entry.code === 'BD03' ? '趟' : '次');
            const monthly = formatAutoInteger(entry.autoPlanMonthlyVisits);
            if(isFiniteNumber(entry.autoPlanWeeklyVisits)){
              const weeklyUnit = unitLabel === '趟' ? '趟' : '次';
              lines.push(`每月約${monthly}${unitLabel}（每週約${formatAutoDecimal(entry.autoPlanWeeklyVisits)}${weeklyUnit}）`);
            }else{
              lines.push(`每月約${monthly}${unitLabel}`);
            }
          }
          if(isFiniteNumber(entry.autoPlanMonthlyUnits)){
            lines.push(`預估耗用：${formatAutoInteger(entry.autoPlanMonthlyUnits)} 元`);
          }
          if(isFiniteNumber(entry.autoPlanRemainingCap)){
            lines.push(`預估餘額：${formatAutoInteger(entry.autoPlanRemainingCap)} 元`);
          }
          if(isFiniteNumber(entry.autoWithinCapCopay) || isFiniteNumber(entry.autoExcessSelfPay) || isFiniteNumber(entry.autoTotalSelfPay)){
            if(isFiniteNumber(entry.autoWithinCapCopay)){
              lines.push(`上限內自付：${formatAutoInteger(entry.autoWithinCapCopay)} 元`);
            }
            if(isFiniteNumber(entry.autoExcessSelfPay)){
              lines.push(`超額自付：${formatAutoInteger(entry.autoExcessSelfPay)} 元`);
            }
            if(isFiniteNumber(entry.autoTotalSelfPay)){
              lines.push(`總自付：${formatAutoInteger(entry.autoTotalSelfPay)} 元`);
            }
          }
          if(lines.length) return lines.join('\n');
        }
      }
      if(category === 'EF'){
        if(entry.original) lines.push(`原額度：${entry.original}`);
        if(entry.planned)  lines.push(`核定：${entry.planned}`);
        if(entry.remaining) lines.push(`餘額：${entry.remaining}`);
      }else if(category === 'G' || category === 'SC'){
        if(entry.planned)  lines.push(`規劃：${entry.planned}`);
        if(entry.remaining) lines.push(`餘額：${entry.remaining}`);
      }else if(category === 'MEAL'){
        if(entry.mealsPerDay) lines.push(`每日${entry.mealsPerDay}餐`);
        if(entry.mealType) lines.push(entry.mealType);
      }else{
        if(category !== 'C'){
          const monthly = entry.monthlyUnits || entry.monthlyUnitsComputed;
          if(monthly) lines.push(`${monthly} 單位/月`);
          if(entry.monthlyExtraDesc) lines.push(entry.monthlyExtraDesc);
        }
      }
      if(!lines.length && entry.planned) lines.push(entry.planned);
      return lines.join('\n');
    }

    function formatSummaryUsage(entry){
      if(!entry) return '';
      const lines = [];
      const category = (entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
      if(entry.period) lines.push(`期間：${entry.period}`);
      const freq = entry.frequencyManual ? entry.frequency : (entry.autoFrequencyText || entry.frequency);
      if(freq && category !== 'C') lines.push(freq);
      if(isBaCode(entry.code)){
        const weeklyText=buildBaWeeklyText(entry);
        if(weeklyText) lines.push(weeklyText);
      }
      if(entry.usage){
        lines.push(entry.usage);
      }else if(entry.autoUsageText){
        lines.push(entry.autoUsageText);
      }
      if(entry.extra) lines.push(entry.extra);
      return lines.join('\n');
    }

    function computeEntrySelfPay(entry){
      if(!entry) return 0;
      if(entry.selfPayManual && (entry.selfPayAmount || '').trim()){
        return toCurrencyInt(parsePlanNumber(entry.selfPayAmount));
      }
      if(isFiniteNumber(entry.autoTotalSelfPay)){
        return toCurrencyInt(entry.autoTotalSelfPay);
      }
      return 0;
    }

    function formatSummarySelfPay(entry){
      if(!entry) return '';
      const manualValue = (entry.selfPayAmount || '').trim();
      const autoTotal = isFiniteNumber(entry.autoTotalSelfPay) ? toCurrencyInt(entry.autoTotalSelfPay) : null;
      if(entry.selfPayManual && manualValue){
        const manualInt = toCurrencyInt(parsePlanNumber(manualValue));
        let text = `${formatAutoInteger(manualInt)} 元`;
        if(autoTotal !== null && autoTotal !== manualInt){
          const within = isFiniteNumber(entry.autoWithinCapCopay) ? formatAutoInteger(toCurrencyInt(entry.autoWithinCapCopay)) : null;
          const excess = isFiniteNumber(entry.autoExcessSelfPay) ? formatAutoInteger(toCurrencyInt(entry.autoExcessSelfPay)) : null;
          const pieces = [];
          if(within !== null) pieces.push(`上限內 ${within} 元`);
          if(excess !== null) pieces.push(`超額 ${excess} 元`);
          pieces.push(`共 ${formatAutoInteger(autoTotal)} 元`);
          text += `（系統估算：${pieces.join('；')}）`;
        }
        return text;
      }
      if(autoTotal !== null){
        const within = isFiniteNumber(entry.autoWithinCapCopay) ? formatAutoInteger(toCurrencyInt(entry.autoWithinCapCopay)) : null;
        const excess = isFiniteNumber(entry.autoExcessSelfPay) ? formatAutoInteger(toCurrencyInt(entry.autoExcessSelfPay)) : null;
        const segments = [];
        if(within !== null) segments.push(`上限內 ${within} 元`);
        if(excess !== null) segments.push(`超額 ${excess} 元`);
        segments.push(`共 ${formatAutoInteger(autoTotal)} 元`);
        return segments.join('；');
      }
      return '';
    }

    function getEntryMonthlyUnits(entry){
      if(!entry) return {units:0, hasValue:false};
      const fields=['monthlyUnits','monthlyUnitsComputed','autoMonthlyUnits'];
      for(let i=0;i<fields.length;i++){
        const field=fields[i];
        if(entry[field] !== undefined && entry[field] !== null){
          const raw=String(entry[field]).trim();
          if(raw){
            return {units:parsePlanNumber(raw), hasValue:true};
          }
        }
      }
      return {units:0, hasValue:false};
    }

    function getEntryUsagePoints(entry){
      if(!entry) return {points:0, computed:false, missing:false};
      if(isFiniteNumber(entry.autoPlanMonthlyUnits)){
        const points=Math.max(0, entry.autoPlanMonthlyUnits);
        return {points:points, computed:true, missing:false};
      }
      const unitInfo=getEntryMonthlyUnits(entry);
      if(!unitInfo.hasValue){
        return {points:0, computed:false, missing:false};
      }
      if(unitInfo.units <= 0){
        return {points:0, computed:true, missing:false};
      }
      const rate=getServiceRate(entry.code);
      if(rate && rate.price !== undefined && rate.price !== null){
        const price=Number(rate.price);
        if(!isNaN(price) && isFinite(price)){
          const points=unitInfo.units * price;
          return {points:points, computed:true, missing:false};
        }
      }
      return {points:0, computed:false, missing:true};
    }

    function calculatePlanPointTotals(){
      const level=getCmsLevel();
      let capValue=null;
      if(level){
        const capNum=getCmsMonthlyCap(level);
        if(isFiniteNumber(capNum) && capNum > 0){
          capValue = capNum;
        }else{
          capValue = null;
        }
      }
      let totalPoints=0;
      let computedEntries=0;
      let totalEntries=0;
      const missingRates=[];
      Object.values(servicePlanState).forEach(entry=>{
        if(!entry) return;
        const category=(entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
        if(category !== 'B' && category !== 'C') return;
        totalEntries++;
        const usageInfo=getEntryUsagePoints(entry);
        if(usageInfo.missing){
          missingRates.push(entry.code);
          return;
        }
        if(usageInfo.computed){
          computedEntries++;
          if(usageInfo.points > 0){
            totalPoints += toCurrencyInt(usageInfo.points);
          }
        }
      });
      const uniqueMissing=Array.from(new Set(missingRates));
      let remaining=null;
      let withinCopay=null;
      let excessSelfPay=null;
      let totalSelfPay=null;
      let effectiveCap = capValue;
      let foreignDeduct = 0;
      if(isFiniteNumber(capValue) && capValue > 0 && computedEntries > 0){
        const financials = computeFinancials({
          cap: capValue,
          sum: totalPoints,
          copayRate: getBcCopayRate(),
          hasForeignCare: hasForeignCareFlag()
        });
        effectiveCap = financials.effectiveCap;
        foreignDeduct = financials.foreignDeduct;
        withinCopay = financials.withinCapCopay;
        excessSelfPay = financials.excessSelfPay;
        totalSelfPay = financials.totalSelfPay;
        remaining = Math.max(0, financials.effectiveCap - financials.withinCapUsage);
      }else if(capValue !== null && computedEntries > 0){
        remaining = capValue - totalPoints;
      }
      return {
        level:level,
        cap:capValue,
        usage:totalPoints,
        computedEntries:computedEntries,
        totalEntries:totalEntries,
        missingRates:uniqueMissing,
        remaining:remaining,
        withinCopay:withinCopay,
        excessSelfPay:excessSelfPay,
        totalSelfPay:totalSelfPay,
        effectiveCap:effectiveCap,
        foreignDeduct:foreignDeduct
      };
    }

    function formatPointValue(value){
      if(value === null || value === undefined || value === '') return '—';
      const num = typeof value === 'number' ? value : Number(value);
      if(!Number.isFinite(num)) return '—';
      const integerCandidate = num < 0 ? Math.ceil(num) : Math.floor(num);
      if(Math.abs(num - integerCandidate) < 1e-4){
        return `${formatAutoInteger(integerCandidate)} 元`;
      }
      const rounded=Math.round(num * 10) / 10;
      if(Math.abs(rounded - Math.round(rounded)) < 1e-6){
        return `${formatAutoInteger(Math.round(rounded))} 元`;
      }
      const fixed=rounded.toFixed(1);
      const sign=fixed.startsWith('-') ? '-' : '';
      const abs=sign ? fixed.slice(1) : fixed;
      const parts=abs.split('.');
      const intPart=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      const decimal=parts[1] ? `.${parts[1].replace(/0+$/, '')}` : '';
      return `${sign}${intPart}${decimal} 元`;
    }

    function updatePlanSummaryTotals(){
      const totals=calculatePlanPointTotals();
      const capBox=document.getElementById('planSummaryCap');
      if(capBox){
        if(totals.level){
          const levelText=`第${totals.level}級`;
          if(isFiniteNumber(totals.cap)){
            capBox.textContent=`${levelText}｜${formatAutoInteger(totals.cap)} 元`;
          }else{
            capBox.textContent=`${levelText}｜—`;
          }
        }else{
          capBox.textContent='—';
        }
      }
      const usageBox=document.getElementById('planSummaryUsage');
      if(usageBox){
        if(totals.computedEntries > 0){
          usageBox.textContent=formatPointValue(totals.usage);
        }else if(totals.totalEntries > 0){
          usageBox.textContent='—';
        }else{
          usageBox.textContent='—';
        }
      }
      const remainBox=document.getElementById('planSummaryRemaining');
      if(remainBox){
        if(totals.remaining !== null && totals.computedEntries > 0){
          remainBox.textContent=formatPointValue(totals.remaining);
          remainBox.classList.toggle('negative', totals.remaining < 0);
        }else{
          remainBox.textContent='—';
          remainBox.classList.remove('negative');
        }
      }
      const withinBox=document.getElementById('planSummaryWithin');
      if(withinBox){
        if(isFiniteNumber(totals.withinCopay)){
          withinBox.textContent=formatPointValue(totals.withinCopay);
        }else{
          withinBox.textContent='—';
        }
      }
      const excessBox=document.getElementById('planSummaryExcess');
      if(excessBox){
        if(isFiniteNumber(totals.excessSelfPay)){
          excessBox.textContent=formatPointValue(totals.excessSelfPay);
        }else{
          excessBox.textContent='—';
        }
      }
      const selfPayBox=document.getElementById('planSummarySelfPay');
      if(selfPayBox){
        if(isFiniteNumber(totals.totalSelfPay)){
          selfPayBox.textContent=formatPointValue(totals.totalSelfPay);
        }else{
          selfPayBox.textContent='—';
        }
      }
      const hintBox=document.getElementById('planSummaryTotalsHint');
      if(hintBox){
        const hints=[];
        if(!totals.level){
          hints.push('請設定 CMS 等級以計算月額度與餘額。');
        }else if(totals.cap === null){
          hints.push('查無對應的 CMS 月額度，請確認服務資料設定。');
        }
        if(totals.missingRates.length){
          hints.push(`缺少 SERVICE_RATES 單價：${totals.missingRates.join('、')}，無法納入金額預估。`);
        }
        if(isFiniteNumber(totals.foreignDeduct) && totals.foreignDeduct > 0){
          const effectiveText = isFiniteNumber(totals.effectiveCap)
            ? `扣除後可用 ${formatPointValue(totals.effectiveCap)}`
            : '已依規定扣除';
          hints.push(`案家聘有外籍看護，上限扣減 ${formatPointValue(totals.foreignDeduct)}，${effectiveText}。`);
        }
        if(hints.length){
          hintBox.textContent=hints.join(' ');
          hintBox.dataset.show='1';
        }else{
          hintBox.textContent='';
          hintBox.dataset.show='0';
        }
      }
    }


    function aggregatePlanSummaryRows(entries){
      const aggregated={};
      (entries || []).forEach(entry=>{
        if(!entry) return;
        const mode=((entry.vendorMode || '輪派').trim() || '輪派');
        const name=(entry.vendorName || '').trim();
        const key=`${mode}||${name}`;
        if(!aggregated[key]){
          aggregated[key]={ vendorMode:mode, vendorName:name, entries:[] };
        }
        aggregated[key].entries.push(entry);
      });
      const groups=Object.keys(aggregated).map(key=>aggregated[key]);
      groups.forEach(group=>{
        group.entries = group.entries.slice().sort((a,b)=>{
          const ac=(a && a.code) ? a.code : '';
          const bc=(b && b.code) ? b.code : '';
          return ac.localeCompare(bc);
        });
      });
      groups.sort((a,b)=>{
        const ac=(a.entries[0] && a.entries[0].code) ? a.entries[0].code : '';
        const bc=(b.entries[0] && b.entries[0].code) ? b.entries[0].code : '';
        return ac.localeCompare(bc);
      });
      return groups.map(group=>{
        const codes=[];
        const names=[];
        const amountParts=[];
        const usageParts=[];
        const selfPayParts=[];
        let totalSelfPay=0;
        group.entries.forEach(entry=>{
          const code=entry && entry.code ? entry.code : '';
          const name=entry && entry.name ? entry.name : '';
          if(code) codes.push(code);
          if(name) names.push(name);
          const amount=formatSummaryAmount(entry);
          if(amount){
            amountParts.push(code ? `${code}：${amount}` : amount);
          }
          const usage=formatSummaryUsage(entry);
          if(usage){
            usageParts.push(code ? `${code}：${usage}` : usage);
          }
          const selfPay=formatSummarySelfPay(entry);
          if(selfPay){
            selfPayParts.push(code ? `${code}：${selfPay}` : selfPay);
          }
          totalSelfPay += computeEntrySelfPay(entry);
        });
        const amountText=amountParts.join('\n');
        const usageText=usageParts.join('\n');
        let selfPayText='';
        if(totalSelfPay > 0){
          selfPayText = `合計 ${formatAutoInteger(totalSelfPay)} 元`;
          if(selfPayParts.length){
            selfPayText += '\n' + selfPayParts.join('\n');
          }
        }else if(selfPayParts.length){
          selfPayText = selfPayParts.join('\n');
        }
        return {
          vendorMode:group.vendorMode || '輪派',
          vendorName:group.vendorName || '',
          codes:codes.join('、'),
          names:names.join('、'),
          amountText:amountText,
          usageText:usageText,
          selfPayText:selfPayText,
          totalSelfPay:totalSelfPay
        };
      });
    }

    function collectPlanSummaryGroups(){
      const groupedById={};
      Object.values(servicePlanState).forEach(entry=>{
        if(!entry) return;
        const category=(entry.category || determineServiceCategory(entry.code) || 'OTHER').toUpperCase();
        const groupId=getPlanCategoryGroupId(category);
        if(!groupedById[groupId]) groupedById[groupId]=[];
        groupedById[groupId].push(entry);
      });
      const groups=[];
      PLAN_CATEGORY_GROUPS.forEach(group=>{
        const list=groupedById[group.id];
        if(!list || !list.length) return;
        const rows=aggregatePlanSummaryRows(list);
        if(!rows.length) return;
        groups.push({ id:group.id, label:planCategoryLabel(group.id), rows:rows });
      });
      return groups;
    }

    function sanitizeSummaryCell(value){
      return (value || '').replace(/\s*\n\s*/g, ' / ').replace(/\t/g, ' ').trim();
    }

    const planSummaryCopyState = { buttonId:'planSummaryCopyBtn', defaultLabel:'複製表格', text:'', timer:null };
    const planSummaryPlainState = { buttonId:'planSummaryCopyPlainBtn', defaultLabel:'複製為純文字', text:'', timer:null };

    function updateCopyButtonState(state, text){
      const normalized = text ? String(text) : '';
      const changed = normalized !== state.text;
      state.text = normalized;
      const btn=document.getElementById(state.buttonId);
      if(!btn) return;
      if(!btn.dataset.originalLabel){
        btn.dataset.originalLabel = btn.textContent || state.defaultLabel || '複製';
      }
      let copyState = btn.dataset.copyState || '';
      if(changed && state.timer){
        clearTimeout(state.timer);
        state.timer = null;
        if(copyState && copyState !== 'busy'){
          btn.textContent = btn.dataset.originalLabel;
          copyState = '';
          btn.dataset.copyState = '';
        }
      }
      const hasText = !!state.text;
      if(!hasText && copyState !== 'busy'){
        btn.textContent = btn.dataset.originalLabel;
        if(copyState){
          btn.dataset.copyState = '';
          copyState = '';
        }
      }
      const disabled = !hasText || copyState === 'busy';
      btn.disabled = disabled;
      btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    }

    function showCopyFeedback(state, btn, message, isError){
      if(!btn) return;
      if(!btn.dataset.originalLabel){
        btn.dataset.originalLabel = btn.textContent || state.defaultLabel || '複製';
      }
      btn.textContent = message;
      btn.dataset.copyState = isError ? 'error' : 'success';
      if(state.timer){
        clearTimeout(state.timer);
      }
      state.timer = window.setTimeout(function(){
        state.timer = null;
        btn.textContent = btn.dataset.originalLabel;
        btn.dataset.copyState = '';
        if(!state.text){
          btn.disabled = true;
          btn.setAttribute('aria-disabled', 'true');
        }
      }, 2000);
    }

    function setPlanSummaryClipboard(text){
      updateCopyButtonState(planSummaryCopyState, text);
    }

    function setPlanSummaryPlainText(text){
      updateCopyButtonState(planSummaryPlainState, text);
    }

    function writeClipboardText(text){
      const value = text ? String(text) : '';
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(value);
      }
      return new Promise(function(resolve, reject){
        const textarea=document.createElement('textarea');
        textarea.value=value;
        textarea.setAttribute('readonly','');
        textarea.style.position='fixed';
        textarea.style.top='-9999px';
        textarea.style.opacity='0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        let successful=false;
        try{
          successful=document.execCommand('copy');
        }catch(err){
          document.body.removeChild(textarea);
          reject(err);
          return;
        }
        document.body.removeChild(textarea);
        if(successful){
          resolve();
        }else{
          reject(new Error('copy failed'));
        }
      });
    }

    function handleCopyButtonClick(state, evt){
      if(evt) evt.preventDefault();
      const btn = evt && evt.currentTarget ? evt.currentTarget : document.getElementById(state.buttonId);
      if(!btn || !state.text){
        return;
      }
      btn.disabled = true;
      btn.dataset.copyState = 'busy';
      btn.setAttribute('aria-disabled', 'true');
      writeClipboardText(state.text).then(function(){
        const hasText = !!state.text;
        btn.disabled = !hasText;
        btn.setAttribute('aria-disabled', hasText ? 'false' : 'true');
        showCopyFeedback(state, btn, '已複製', false);
      }).catch(function(){
        const hasText = !!state.text;
        btn.disabled = !hasText;
        btn.setAttribute('aria-disabled', hasText ? 'false' : 'true');
        showCopyFeedback(state, btn, '複製失敗', true);
      });
    }

    function handlePlanSummaryCopyClick(evt){
      handleCopyButtonClick(planSummaryCopyState, evt);
    }

    function handlePlanSummaryPlainCopyClick(evt){
      handleCopyButtonClick(planSummaryPlainState, evt);
    }

    function buildPlanSummaryPreview(){
      updatePlanSummaryTotals();
      const host=document.getElementById('planSummaryPreview');
      if(!host) return;
      const groups=collectPlanSummaryGroups();
      if(!groups.length){
        host.innerHTML='<div class="hint">尚未選擇服務項目。</div>';
        setPlanSummaryClipboard('');
        setPlanSummaryPlainText('');
        scheduleAllMeasurements();
        return;
      }
      const header=['服務代碼','服務名稱','承接','指定單位','額度／單位','自費金額','使用頻率／說明'];
      const copyLines=[];
      const plainLines=[];
      let html='';
      let totalSelfPayValue=0;
      groups.forEach((group,index)=>{
        if(index>0){
          html += '<div class="hr" aria-hidden="true"></div>';
          copyLines.push('');
          plainLines.push('');
        }
        html += `<div class=\"summary-title\">${escapeHtml(group.label)}</div>`;
        html += '<div class="summary-table-wrapper">';
        html += '<table class="summary-table"><thead><tr>';
        header.forEach(label=>{ html += `<th>${escapeHtml(label)}</th>`; });
        html += '</tr></thead><tbody>';
        copyLines.push(group.label);
        copyLines.push(header.join('    '));
        plainLines.push(group.label);
        plainLines.push(header.join('\t'));
        group.rows.forEach(row=>{
          html += '<tr>';
          html += `<td>${escapeHtml(row.codes)}</td>`;
          html += `<td>${escapeHtml(row.names)}</td>`;
          html += `<td>${escapeHtml(row.vendorMode)}</td>`;
          html += `<td>${escapeHtml(row.vendorName)}</td>`;
          html += `<td>${row.amountText ? nl2br(row.amountText) : '—'}</td>`;
          html += `<td>${row.selfPayText ? nl2br(row.selfPayText) : '—'}</td>`;
          html += `<td>${row.usageText ? nl2br(row.usageText) : '—'}</td>`;
          html += '</tr>';
          const copyRow=[
            row.codes,
            row.names,
            row.vendorMode,
            row.vendorName,
            sanitizeSummaryCell(row.amountText),
            sanitizeSummaryCell(row.selfPayText),
            sanitizeSummaryCell(row.usageText)
          ];
          copyLines.push(copyRow.join(' '));
          plainLines.push(copyRow.join('\t'));
          totalSelfPayValue += row.totalSelfPay || 0;
        });
        html += '</tbody></table></div>';
      });
      const totalLine=`自費總額：${formatAutoInteger(totalSelfPayValue)} 元`;
      html += `<div class=\"summary-total-selfpay\">${escapeHtml(totalLine)}</div>`;
      host.innerHTML = html;
      const copyText = copyLines.join('\n');
      const plainText = plainLines.join('\n');
      setPlanSummaryClipboard(copyText ? `${copyText}\n${totalLine}` : totalLine);
      setPlanSummaryPlainText(plainText ? `${plainText}\n${totalLine}` : totalLine);
      scheduleAllMeasurements();
    }

    function initPlanSummaryCopy(){
      const tableBtn=document.getElementById('planSummaryCopyBtn');
      if(tableBtn){
        tableBtn.addEventListener('click', handlePlanSummaryCopyClick);
      }
      const plainBtn=document.getElementById('planSummaryCopyPlainBtn');
      if(plainBtn){
        plainBtn.addEventListener('click', handlePlanSummaryPlainCopyClick);
      }
      setPlanSummaryClipboard(planSummaryCopyState.text);
      setPlanSummaryPlainText(planSummaryPlainState.text);
    }
    function buildConsentParties(){
      const parties=[];
      const includePrimary = ((document.getElementById('includePrimary')?.value || '').trim().toLowerCase() !== 'false');
      const primaryRel = (document.getElementById('primaryRel')?.value || '').trim();
      const primaryName = (document.getElementById('primaryName')?.value || '').trim();
      if(includePrimary && primaryRel){
        parties.push({ role: primaryRel, name: primaryName, source: 'primary' });
      }
      const extras = collectExtras();
      if(Array.isArray(extras)){
        extras.forEach(extra=>{
          if(extra && extra.role && extra.name){
            parties.push({ role: extra.role, name: extra.name, source: 'extra' });
          }
        });
      }
      if(!parties.length){
        const fallbackName = (document.getElementById('caseName')?.value || '').trim();
        parties.push({ role:'本人', name:fallbackName, source:'fallback' });
      }
      return parties;
    }

    function formatConsentParty(part){
      if(!part) return '';
      const role=(part.role || '').trim();
      const name=(part.name || '').trim();
      if(!role && !name) return '';
      if(role === '本人'){
        return '本人';
      }
      if(part.source === 'primary'){
        const pieces=[role, name].filter(Boolean).join(' ');
        return pieces ? `主要照顧者（${pieces}）` : '主要照顧者';
      }
      if(name){
        return role ? `${role}（${name}）` : name;
      }
      return role;
    }

    function buildConsentDisplay(){
      const parties = buildConsentParties();
      const seen=new Set();
      const formatted=[];
      parties.forEach(part=>{
        const text=formatConsentParty(part);
        if(text && !seen.has(text)){
          seen.add(text);
          formatted.push({ text:text, isSelf:(part.role || '').trim() === '本人' });
        }
      });
      if(!formatted.length){
        formatted.push({ text:'本人', isSelf:true });
      }
      const notifyText = formatted.map(item=>item.text).join('、');
      return {
        notifyText: notifyText,
        signerText: notifyText
      };
    }

    function renderServicePlanEditor(){
      const host=document.getElementById('planEditor');
      if(!host) return;
      host.innerHTML='';
      selfPayHintDisplays = {};
      baFrequencyDisplays = {};
      const entries=Object.values(servicePlanState);
      const groupedById={};
      entries.forEach(entry=>{
        if(!entry) return;
        const rawCategory=(entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
        const groupId=getPlanCategoryGroupId(rawCategory);
        if(!groupedById[groupId]) groupedById[groupId]=[];
        groupedById[groupId].push(entry);
      });
      let totalEntries=0;
      PLAN_CATEGORY_GROUPS.forEach(group=>{
        const section=document.createElement('section');
        section.className='plan-category';
        section.dataset.planCategory = group.id;
        const headingWrap=document.createElement('div');
        headingWrap.className='plan-category-heading';
        const headingEntry=group.anchor ? getHeadingEntry(group.anchor) : null;
        const heading=document.createElement('h3');
        heading.className='h3';
        if(group.anchor){
          heading.id = group.anchor;
          heading.dataset.anchor = group.anchor;
        }
        heading.textContent = headingEntry && headingEntry.label ? headingEntry.label : (group.label || '服務項目');
        headingWrap.appendChild(heading);
        section.appendChild(headingWrap);
        const body=document.createElement('div');
        body.className='plan-category-body';
        const list=(groupedById[group.id] || []).slice().sort((a,b)=>(a.code || '').localeCompare(b.code || ''));
        if(list.length){
          totalEntries += list.length;
          list.forEach(entry=>{
            const entryBox=document.createElement('div');
            entryBox.className='plan-entry';
            const header=document.createElement('div');
            header.className='plan-entry-header';
            header.textContent=`${entry.code}［${entry.name || ''}］`;
            entryBox.appendChild(header);
            const grid=document.createElement('div');
            grid.className='plan-entry-grid';
            appendSelfPayField(grid, entry);
            const entryCategory=(entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
            if(entryCategory==='B'){
              if(entry.code && entry.code.indexOf('BB') === 0){
                const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
                grid.appendChild(vendorField.wrap);
                const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○日照中心'});
                vendorNameField.wrap.dataset.planVendorName=entry.code;
                grid.appendChild(vendorNameField.wrap);
                appendAutoSummaryField(grid, entry, '預估使用概況');
                const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'系統已提供建議內容，可依個案調整',className:'full'});
                grid.appendChild(usageField.wrap);
              }else if(entry.code === 'BD03'){
                const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
                grid.appendChild(vendorField.wrap);
                const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○交通車'});
                vendorNameField.wrap.dataset.planVendorName=entry.code;
                grid.appendChild(vendorNameField.wrap);
                appendAutoSummaryField(grid, entry, '預估交通安排');
                const usageField=createPlanInput(entry,'usage','交通使用方式',{as:'textarea',placeholder:'系統已提供建議內容，可再補充乘車安排',className:'full'});
                grid.appendChild(usageField.wrap);
              }else if(isBaCode(entry.code)){
                const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
                grid.appendChild(vendorField.wrap);
                const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○服務單位'});
                vendorNameField.wrap.dataset.planVendorName=entry.code;
                grid.appendChild(vendorNameField.wrap);
                if(requiresBaManualUnits(entry.code)){
                  const unitVisitField=createPlanInput(entry,'unitPerVisit','每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
                  grid.appendChild(unitVisitField.wrap);
                }
                const unitField=createPlanInput(entry,'monthlyUnits','月目標次數',{placeholder:'例：10',attrs:{inputmode:'decimal',min:'0'}});
                grid.appendChild(unitField.wrap);
                const weeklyWrap=document.createElement('div');
                weeklyWrap.className='plan-field full';
                const weeklyLabel=document.createElement('label');
                weeklyLabel.textContent='排程換算';
                weeklyWrap.appendChild(weeklyLabel);
                const weeklyBox=document.createElement('div');
                weeklyBox.className='auto-summary-box empty';
                weeklyBox.dataset.planBaDisplay = entry.code;
                weeklyWrap.appendChild(weeklyBox);
                const weeklyHint=document.createElement('div');
                weeklyHint.className='plan-hint';
                weeklyHint.textContent='每週次數以 4.5 週換算，排程取整；金額計算仍以向下取整（元）。';
                weeklyWrap.appendChild(weeklyHint);
                grid.appendChild(weeklyWrap);
                baFrequencyDisplays[entry.code] = weeklyBox;
                appendAutoSummaryField(grid, entry, '預估使用概況');
                const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'請描述服務內容、案主期待或家屬配合情況'});
                grid.appendChild(usageField.wrap);
              }else{
                const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
                grid.appendChild(vendorField.wrap);
                const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○服務單位'});
                vendorNameField.wrap.dataset.planVendorName=entry.code;
                grid.appendChild(vendorNameField.wrap);
                const weeklyField=createPlanInput(entry,'weeklyFreq','每週次數',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
                grid.appendChild(weeklyField.wrap);
                const unitVisitField=createPlanInput(entry,'unitPerVisit','每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
                grid.appendChild(unitVisitField.wrap);
                const extraVisitField=createPlanInput(entry,'monthlyExtraVisits','每月額外次數',{type:'number',attrs:{step:'1',min:'0',inputmode:'decimal'}});
                grid.appendChild(extraVisitField.wrap);
                const extraUnitField=createPlanInput(entry,'monthlyExtraUnit','額外每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
                grid.appendChild(extraUnitField.wrap);
                const extraDescField=createPlanInput(entry,'monthlyExtraDesc','額外排班說明',{placeholder:'例：雙十國慶排班 2 次'});
                grid.appendChild(extraDescField.wrap);
                appendAutoSummaryField(grid, entry, '預估使用概況');
                const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'請描述服務內容、案主期待或家屬配合情況'});
                grid.appendChild(usageField.wrap);
              }
            }else if(entryCategory==='C'){
              const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
              grid.appendChild(vendorField.wrap);
              const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○專業服務單位'});
              vendorNameField.wrap.dataset.planVendorName=entry.code;
              grid.appendChild(vendorNameField.wrap);
              const frequencyField=createPlanInput(entry,'frequency','頻率/時數',{placeholder:'例：每月 2 次，每次 60 分鐘'});
              grid.appendChild(frequencyField.wrap);
              const usageField=createPlanInput(entry,'usage','服務內容',{as:'textarea',placeholder:'例：評估院內復能程度，提供衛教指導與復健訓練'});
              grid.appendChild(usageField.wrap);
            }else if(entryCategory==='D'){
              const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
              grid.appendChild(vendorField.wrap);
              const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○交通車'});
              vendorNameField.wrap.dataset.planVendorName=entry.code;
              grid.appendChild(vendorNameField.wrap);
              const routeField=createPlanInput(entry,'route','接送路線',{placeholder:'例：住家→日照中心→住家'});
              grid.appendChild(routeField.wrap);
              const periodField=createPlanInput(entry,'period','服務期間',{placeholder:'例：113年01月~113年12月'});
              grid.appendChild(periodField.wrap);
              const frequencyField=createPlanInput(entry,'frequency','頻率',{placeholder:'例：每週 2 次'});
              grid.appendChild(frequencyField.wrap);
              const usageField=createPlanInput(entry,'usage','交通需求與安排',{as:'textarea',placeholder:'例：安排專車接送至日照中心（去程07:30，回程16:30）'});
              grid.appendChild(usageField.wrap);
            }else if(entryCategory==='EF'){
              const originalField=createPlanInput(entry,'original','原核定金額',{placeholder:'例：28,000'});
              grid.appendChild(originalField.wrap);
              const plannedField=createPlanInput(entry,'planned','核定金額',{placeholder:'例：28,000'});
              grid.appendChild(plannedField.wrap);
              const remainField=createPlanInput(entry,'remaining','餘額',{placeholder:'例：剩餘20單位'});
              grid.appendChild(remainField.wrap);
              const usageField=createPlanInput(entry,'usage','服務說明',{as:'textarea',placeholder:'例：核配金額依長照中心核定，將安排輔具廠商製作與裝設。'});
              grid.appendChild(usageField.wrap);
            }else if(entryCategory==='G'){
              const plannedField=createPlanInput(entry,'planned','核定額度',{placeholder:'例：12日'});
              grid.appendChild(plannedField.wrap);
              const remainField=createPlanInput(entry,'remaining','餘額',{placeholder:'例：剩餘8日'});
              grid.appendChild(remainField.wrap);
              const usageField=createPlanInput(entry,'usage','喘息安排',{as:'textarea',placeholder:'例：安排週三全日喘息，主要照顧者於此時段休息並處理家務。'});
              grid.appendChild(usageField.wrap);
            }else if(entryCategory==='SC'){
              const periodField=createPlanInput(entry,'period','短照額度期間',{placeholder:'例：113年01月~113年12月'});
              grid.appendChild(periodField.wrap);
              const noteField=createPlanInput(entry,'usage','比例或使用說明',{as:'textarea',placeholder:'例：本月短照占比18%，符合政策規範（≦20%）。'});
              grid.appendChild(noteField.wrap);
            }else if(entryCategory==='MEAL'){
              const mealsField=createPlanInput(entry,'mealsPerDay','1日核定餐數',{placeholder:'例：2（午、晚餐）'});
              grid.appendChild(mealsField.wrap);
              const mealTypeField=createPlanInput(entry,'mealType','餐別／質地',{placeholder:'例：午餐、晚餐；軟質餐'});
              grid.appendChild(mealTypeField.wrap);
              const usageField=createPlanInput(entry,'usage','送餐備註',{as:'textarea',placeholder:'例：含到宅關懷與餐點保溫指導；列冊中低收入戶享有補助。'});
              grid.appendChild(usageField.wrap);
            }else{
              const usageField=createPlanInput(entry,'usage','服務說明',{as:'textarea',placeholder:'請填寫此服務之使用方式或補充說明'});
              grid.appendChild(usageField.wrap);
            }
            entryBox.appendChild(grid);
            body.appendChild(entryBox);
            if(isBaCode(entry.code)){
              updateBaEntryDerived(entry.code, {skipPreview:true});
            }
            updatePlanVendorVisibility(entry.code);
            if(!(entry.code && entry.code.indexOf('BB') === 0) && entry.code !== 'BD03' && !isBaCode(entry.code)){
              updatePlanMonthlyComputation(entry.code, {skipPreview:true});
            }
          });
        }else{
          const hint=document.createElement('div');
          hint.className='plan-empty-hint';
          hint.textContent='尚未選擇此類服務。';
          body.appendChild(hint);
        }
        section.appendChild(body);
        host.appendChild(section);
      });
      host.dataset.empty = totalEntries > 0 ? '0' : '1';
      applyHeadingsToDOM();
      const headingReport = validateHeadingSchema();
      handleHeadingSchemaValidation(headingReport);
      if(sectionViewsReady){
        refreshExecutionHeadingRegistry();
      }
      scheduleSummaryUpdate();
      scheduleAllMeasurements();
    }
    function updateSelfPayHint(code){
      if(!code) return;
      const hint = selfPayHintDisplays[code];
      if(!hint || !hint.isConnected){
        if(selfPayHintDisplays[code]) delete selfPayHintDisplays[code];
        return;
      }
      const entry = servicePlanState[code];
      if(!entry){
        hint.textContent='';
        hint.dataset.show='0';
        return;
      }
      const manualValue = parsePlanNumber(entry.selfPayAmount);
      const hasManual = !!((entry.selfPayManual || false) && manualValue > 0);
      const within = isFiniteNumber(entry.autoWithinCapCopay) ? toCurrencyInt(entry.autoWithinCapCopay) : 0;
      const excess = isFiniteNumber(entry.autoExcessSelfPay) ? toCurrencyInt(entry.autoExcessSelfPay) : 0;
      const total = isFiniteNumber(entry.autoTotalSelfPay) ? toCurrencyInt(entry.autoTotalSelfPay) : 0;
      if(hasManual){
        if(total > 0){
          hint.textContent = `系統估算：上限內 ${formatAutoInteger(within)} 元；超額 ${formatAutoInteger(excess)} 元（共 ${formatAutoInteger(total)} 元）`;
        }else{
          hint.textContent = '系統估算尚未完成。';
        }
        hint.dataset.show = '1';
        return;
      }
      if(total > 0){
        hint.textContent = `系統估算：上限內 ${formatAutoInteger(within)} 元；超額 ${formatAutoInteger(excess)} 元（共 ${formatAutoInteger(total)} 元）`;
        hint.dataset.show = '1';
      }else{
        hint.textContent = '';
        hint.dataset.show = '0';
      }
    }

    function updateAllSelfPayHints(){
      Object.keys(selfPayHintDisplays).forEach(updateSelfPayHint);
    }

    function appendAutoSummaryField(grid, entry, label){
      const wrap=document.createElement('div');
      wrap.className='plan-field full auto-summary';
      const lab=document.createElement('label');
      lab.textContent=label;
      wrap.appendChild(lab);
      const box=document.createElement('div');
      box.className='auto-summary-box';
      const summary = buildAutoSummaryText(entry);
      if(summary){
        box.textContent=summary;
      }else{
        box.textContent='尚未計算，請確認已設定 CMS 等級與服務項目。';
        box.classList.add('empty');
      }
      wrap.appendChild(box);
      grid.appendChild(wrap);
    }

    function appendSelfPayField(grid, entry){
      const field=createPlanInput(entry,'selfPayAmount','自費金額（元）',{type:'number',attrs:{step:'1',min:'0',inputmode:'decimal'}});
      field.input.placeholder = '例：4500';
      field.wrap.classList.add('selfpay-field');
      const hint=document.createElement('div');
      hint.className='selfpay-hint';
      hint.dataset.show='0';
      field.wrap.appendChild(hint);
      selfPayHintDisplays[entry.code] = hint;
      grid.appendChild(field.wrap);
      updateSelfPayHint(entry.code);
    }

    function getPlanEntriesByCategory(cat){
      return Object.values(servicePlanState)
        .filter(entry => (entry.category || '') === cat)
        .sort((a,b)=>a.code.localeCompare(b.code));
    }

    function formatPlanEntryB(entry, idx){
      if(!entry) return '';
      let vendor='';
      if(entry.vendorMode === '指定'){
        vendor = `（指定${entry.vendorName || '○○○單位'}）`;
      }else if(entry.vendorMode === '輪派'){
        vendor = '（輪派）';
      }else if(entry.vendorMode){
        vendor = `（${entry.vendorMode}）`;
      }else{
        vendor = '（請填輪派或指定單位）';
      }
      if(isBaCode(entry.code)){
        const usageText = (entry.usage || entry.autoUsageText || '').trim();
        const monthlyUnitsText = (entry.monthlyUnitsComputed || entry.autoMonthlyUnits || entry.monthlyUnits || '').trim();
        const freqText = buildBaWeeklyText(entry);
        const costText = isFiniteNumber(entry.autoPlanMonthlyUnits)
          ? `預估耗用${formatAutoInteger(entry.autoPlanMonthlyUnits)} 元`
          : '';
        const monthlySegment = monthlyUnitsText
          ? `核定${monthlyUnitsText}單位/月${costText ? `（${costText}）` : ''}`
          : `核定（請填月目標）${costText ? `（${costText}）` : ''}`;
        const freqSegment = freqText || '排程未設定';
        const usageSegment = usageText || '請補充使用方式或案主期待。';
        const totalSegment = monthlyUnitsText ? `共 ${monthlyUnitsText} 單位/月` : '共（請填月目標）';
        let text = `${idx}.${entry.code}[${entry.name || ''}]${vendor}`;
        text += `｜${monthlySegment}｜${freqSegment}｜${usageSegment}｜${totalSegment}`;
        if(!text.endsWith('。')) text += '。';
        return text;
      }
      const summary = buildAutoSummaryText(entry);
      const usageText = (entry.usage || entry.autoUsageText || '').trim();
      let text=`${idx}.${entry.code}[${entry.name || ''}]${vendor}`;
      if(summary){
        text += `，${summary}`;
        if(usageText){
          text += `；${usageText}`;
        }else{
          text += '；請補充使用方式或案主期待。';
        }
      }else{
        const monthly = entry.monthlyUnits ? `*${entry.monthlyUnits}` : '*（請填月單位）';
        const parts=[];
        if(entry.frequency) parts.push(entry.frequency);
        if(usageText) parts.push(usageText);
        text=`${idx}.${entry.code}[${entry.name || ''}]${monthly}${vendor}`;
        if(parts.length){
          text += `，${parts.join('；')}`;
        }else{
          text += '，請補充頻率、計算說明及使用方式。';
        }
      }
      if(!text.endsWith('。')) text += '。';
      return text;
    }

    function formatPlanEntryC(entry, idx){
      if(!entry) return '';
      let vendor='';
      if(entry.vendorMode === '指定'){
        vendor = `（指定${entry.vendorName || '○○○單位'}）`;
      }else if(entry.vendorMode === '輪派'){
        vendor = '（輪派）';
      }else if(entry.vendorMode){
        vendor = `（${entry.vendorMode}）`;
      }
      const period=(entry.period || '').trim();
      const usageText=(entry.usage || entry.autoUsageText || '').trim();
      const parts=[];
      if(period) parts.push(`期間：${period}`);
      if(usageText){
        parts.push(usageText);
      }else{
        parts.push('請補充單次規劃說明');
      }
      let text=`${idx}.${entry.code}[${entry.name || ''}]${vendor}`;
      if(parts.length){
        text += `：${parts.join('；')}`;
      }else{
        text += '：請補充單次規劃說明。';
      }
      if(!text.endsWith('。')) text += '。';
      return text;
    }

    function formatPlanEntryD(entry, idx){
      if(!entry) return '';
      const vendor = entry.vendorMode === '指定'
        ? `指定${entry.vendorName || '○○○單位'}`
        : '輪派照會3家服務單位';
      const monthly = entry.monthlyUnits ? `*${entry.monthlyUnits}` : '';
      const parts=[];
      if(entry.frequency) parts.push(entry.frequency);
      if(entry.usage) parts.push(entry.usage);
      let text=`${idx}.${vendor} ${entry.code}[${entry.name || ''}]${monthly}`;
      if(parts.length){
        text += `，${parts.join('；')}`;
      }else{
        text += '，請補充頻率與使用方式。';
      }
      if(!text.endsWith('。')) text += '。';
      return text;
    }

    function gatherPlanReferrals(){
      const lines=[];
      const mapping=[
        {key:'pt', label:'據點'},
        {key:'nb', label:'鄰里'},
        {key:'rg', label:'宗教/社團'},
        {key:'fw', label:'財團/社會福利'}
      ];
      mapping.forEach(item=>{
        const chk=document.getElementById('sp_inf_'+item.key);
        if(chk && chk.checked){
          const name=(document.getElementById('sp_inf_'+item.key+'_name')?.value || '').trim();
          const freq=(document.getElementById('sp_inf_'+item.key+'_freq')?.value || '').trim();
          let text=item.label;
          if(name) text += `-${name}`;
          if(freq) text += `-${freq}`;
          lines.push(text);
        }
      });
      const extra=(planMetaState.referralExtra || '').trim();
      if(extra){
        extra.split(/\r?\n/).map(line=>line.trim()).filter(Boolean).forEach(line=>lines.push(line));
      }
      return lines;
    }

    function getSelectedProblemTexts(){
      if(typeof getSelectedProblems !== 'function') return [];
      const codes=getSelectedProblems();
      if(!codes || !codes.length) return [];
      return codes.map(code=>{
        const label = PROBLEMS && PROBLEMS[code] ? PROBLEMS[code] : '';
        return label ? `${code}.${label}` : `${code}`;
      });
    }

    function formatCaseDisplay(){
      const gender=(document.getElementById('s1_gender')?.value || '').trim();
      const caseName=(document.getElementById('caseName')?.value || '').trim();
      let prefix='案主';
      if(gender==='男') prefix='案男';
      else if(gender==='女') prefix='案女';
      return caseName ? `${prefix}-${caseName}` : prefix;
    }

    function formatSummaryDate(value){
      if(!value) return '';
      if(/^(\d{4})-(\d{2})-(\d{2})$/.test(value)){
        const parts=value.split('-');
        return `${parts[0]}/${parts[1]}/${parts[2]}`;
      }
      const parsed = typeof parseDateInput === 'function' ? parseDateInput(value) : null;
      if(parsed && !Number.isNaN(parsed.getTime())){
        return `${parsed.getFullYear()}/${pad2(parsed.getMonth()+1)}/${pad2(parsed.getDate())}`;
      }
      return value;
    }

    function buildExportSummaryLines(){
      const lines=[];
      const caseName=(document.getElementById('caseName')?.value || '').trim();
      const caseDisplay = caseName ? formatCaseDisplay() : '';
      lines.push(`案主：${caseDisplay || '尚未填寫'}`);
      const cmsLevel = getCmsLevel();
      lines.push(`CMS 等級：${cmsLevel || '尚未設定'}`);
      const callDate = formatSummaryDate(getDateBox('callDate'));
      const visitDate = formatSummaryDate(getDateBox('visitDate'));
      const dischargeEnabled = document.getElementById('isDischarge')?.checked;
      const dischargeDateValue = dischargeEnabled ? formatSummaryDate(getDateBox('dischargeDate')) : '';
      let visitLine = `電聯日期：${callDate || '—'}；家訪日期：${visitDate || '—'}`;
      if(dischargeEnabled && dischargeDateValue){
        visitLine += `、出院日期：${dischargeDateValue}`;
      }
      lines.push(visitLine);
      const primaryRel=(document.getElementById('primaryRel')?.value || '').trim();
      const primaryName=(document.getElementById('primaryName')?.value || '').trim();
      const primaryLine = primaryRel || primaryName ? `${primaryRel || '—'}${primaryName ? `－${primaryName}` : ''}` : '尚未填寫';
      lines.push(`主照者：${primaryLine}`);
      const deciderRel=(document.getElementById('sp_deciderRel')?.value || '').trim();
      const deciderName=(document.getElementById('sp_deciderName')?.value || '').trim();
      const deciderPhone=(document.getElementById('sp_deciderPhone')?.value || '').trim();
      const deciderParts=[];
      if(deciderRel) deciderParts.push(deciderRel);
      if(deciderName) deciderParts.push(deciderName);
      if(deciderPhone) deciderParts.push(deciderPhone);
      lines.push(`主要聯繫人：${deciderParts.length ? deciderParts.join('／') : '尚未指定'}`);
      const manager=(document.getElementById('caseManagerName')?.value || '').trim();
      lines.push(`個案管理員：${manager || '尚未填寫'}`);
      return lines;
    }

    function buildApprovalPlanPreview(){
      const box=document.getElementById('plan_text');
      if(!box) return;
      const lines=[];
      const summaryLines = buildExportSummaryLines();
      if(summaryLines.length){
        lines.push('【摘要】');
        summaryLines.forEach(text=>lines.push(text));
        lines.push('');
      }
      lines.push('一、長照服務核定項目、頻率：');
      const bEntries=getPlanEntriesByCategory('B');
      if(bEntries.length){
        lines.push('（一）B碼（輪派/指定○○○單位）');
        lines.push('服務代碼*核定數量+使用頻率及方式');
        bEntries.forEach((entry,idx)=>{ const text=formatPlanEntryB(entry, idx+1); if(text) lines.push(text); });
      }else{
        lines.push('（一）B碼：暫無設定。');
      }
      const cEntries=getPlanEntriesByCategory('C');
      if(cEntries.length){
        lines.push('（二）C碼（輪派/指定○○○單位）');
        lines.push('服務代碼+案主最希望改善之項目及配合狀況');
        cEntries.forEach((entry,idx)=>{ const text=formatPlanEntryC(entry, idx+1); if(text) lines.push(text); });
      }else{
        lines.push('（二）C碼：暫無規劃。');
      }
      const dEntries=getPlanEntriesByCategory('D');
      if(dEntries.length){
        lines.push('（三）D碼：輪派照會3家服務單位／指定○○○單位（代碼＋名稱）');
        dEntries.forEach((entry,idx)=>{ const text=formatPlanEntryD(entry, idx+1); if(text) lines.push(text); });
      }else{
        lines.push('（三）D碼：暫無規劃。');
      }
      const efEntries=getPlanEntriesByCategory('EF');
      if(efEntries.length){
        lines.push('（四）E.F碼：');
        efEntries.forEach(entry=>{
          const period=entry.period || '（請填期間）';
          const original=entry.original || '（請填原額度）';
          const approved=entry.planned || '（請填本次核定）';
          const remaining=entry.remaining || '（請填剩餘額度）';
          let text=`期間${period}；原有額度${original}元，本次核定${approved}元，剩餘${remaining}元。`;
          if(entry.usage){
            text += entry.usage.endsWith('。') ? entry.usage : ` ${entry.usage}`;
          }
          lines.push(text);
        });
      }else{
        lines.push('（四）E.F碼：暫無申請。');
      }
      const gEntries=getPlanEntriesByCategory('G');
      if(gEntries.length){
        lines.push('（五）G碼：');
        gEntries.forEach(entry=>{
          const period=entry.period || '（請填期間）';
          const planned=entry.planned || '（請填規劃）';
          const remaining=entry.remaining || '（請填餘額）';
          let text=`喘息額度期間${period}；本次規劃${planned}，餘額${remaining}。`;
          if(entry.usage){
            text += entry.usage.endsWith('。') ? entry.usage : entry.usage + '。';
          }
          lines.push(text);
        });
      }else{
        lines.push('（五）G碼：暫無規劃。');
      }
      const scEntries=getPlanEntriesByCategory('SC');
      if(scEntries.length){
        lines.push('（六）SC碼：');
        scEntries.forEach(entry=>{
          const period=entry.period || '（請填期間）';
          const note=entry.usage || '（請敘明比例或使用狀況）';
          lines.push(`短照額度期間${period}；${note}`);
        });
      }else{
        lines.push('（六）SC碼：暫無規劃。');
      }
      const mealEntries=getPlanEntriesByCategory('MEAL');
      if(mealEntries.length){
        lines.push('（七）營養餐飲服務：');
        mealEntries.forEach(entry=>{
          const meals=entry.mealsPerDay || '（請填餐數）';
          const mealType=entry.mealType || '（請填午／晚餐）';
          let text=`1日核定${meals}餐（${mealType}）`;
          if(entry.usage){
            text += entry.usage.endsWith('。') ? entry.usage : `。${entry.usage}`;
          }else{
            text += '。';
          }
          lines.push(text);
        });
      }else{
        lines.push('（七）營養餐飲服務：尚未設定。');
      }
      const emergencyNote=(planMetaState.emergencyNote || '').trim();
      lines.push(`（八）緊急救援服務：${emergencyNote || '（請說明是否申請及啟用原因）'}`);
      lines.push('二、轉介其他服務資源：');
      const referralLines=gatherPlanReferrals();
      if(referralLines.length){
        referralLines.forEach(line=>{
          const trimmed=line.trim();
          if(!trimmed) return;
          if(/^[-•\u2022]/.test(trimmed)){ lines.push(trimmed); }
          else{ lines.push(`- ${trimmed}`); }
        });
      }else{
        lines.push('- （尚未填寫）');
      }
      const cmsLevel=getCmsLevel();
      if(cmsLevel==='2' || cmsLevel==='3'){
        const stationInfo=(planMetaState.stationInfo || '').trim() || '請補充鄰近巷弄長照站資訊';
        const willing=(planMetaState.stationWillingness || '').trim() || '請確認意願';
        lines.push(`- 鄰近巷弄長照站：${stationInfo}；意願：${willing}。將於AA02服務紀錄持續追蹤。`);
        lines.push('※另針對長照需要等級第2~3級長照服務使用者，請提供鄰近巷弄長照站資訊，並確認個案有／無意願，將於AA02服務紀錄持續追蹤。');
      }
      const problemTexts=getSelectedProblemTexts();
      if(problemTexts.length){
        lines.push(`（服務對應問題：${problemTexts.join('、')}）`);
      }
      const mismatchSummary=getMismatchReasonSummary();
      if(mismatchSummary){
        lines.push(mismatchSummary);
      }
      const consentInfo = buildConsentDisplay();
      const notifyText = consentInfo.notifyText || formatCaseDisplay();
      const signerText = consentInfo.signerText || '本人';
      lines.push('告知與同意：');
      lines.push(`上述計畫，均告知${notifyText}其了解計畫內容並同意服務使用，並簽訂服務使用確認單。（請單位留存確認單備查）`);
      if(signerText){
        lines.push(`簽署人：${signerText}`);
      }
      const manager=(document.getElementById('caseManagerName')?.value || '').trim() || '（請填寫個管師姓名）';
      lines.push(`個案管理員：${manager}`);
      box.value = lines.join('\n');
      buildPlanSummaryPreview();
    }

    function serializeServicePlan(){
      return Object.values(servicePlanState).map(entry=>Object.assign({}, entry));
    }

    function initPlanMetaFields(){
      const ref=document.getElementById('plan_referral_extra');
      if(ref){ ref.addEventListener('input', evt=>{ planMetaState.referralExtra = evt.target.value; buildApprovalPlanPreview(); }); }
      const stationInfo=document.getElementById('plan_station_info');
      if(stationInfo){ stationInfo.addEventListener('input', evt=>{ planMetaState.stationInfo = evt.target.value; buildApprovalPlanPreview(); }); }
      const stationWill=document.getElementById('plan_station_willingness');
      if(stationWill){ stationWill.addEventListener('change', evt=>{ planMetaState.stationWillingness = evt.target.value; buildApprovalPlanPreview(); }); }
      const emergency=document.getElementById('plan_emergency_note');
      if(emergency){ emergency.addEventListener('input', evt=>{ planMetaState.emergencyNote = evt.target.value; buildApprovalPlanPreview(); }); }
      const foreignCareField=document.getElementById('hasForeignCare');
      if(foreignCareField){
        const syncForeignCare = ()=>{
          planMetaState.foreignCare = hasForeignCareFlag();
          buildPlanSummaryPreview();
          scheduleSummaryUpdate();
          if(!isRestoringDraft && draftLoadComplete) scheduleAutoSave();
        };
        foreignCareField.addEventListener('change', syncForeignCare);
        syncForeignCare();
      }
    }

    function setCmsLevel(level, options){
      const value = level ? String(level) : '';
      const hidden=document.getElementById('cmsLevelValue');
      if(hidden) hidden.value = value;
      document.querySelectorAll('#cmsLevelGroup button').forEach(btn=>{
        btn.dataset.active = btn.dataset.level === value ? '1' : '0';
      });
      refreshDayCareAvailability();
      syncPlanStateWithSelections();
      scheduleSummaryUpdate();
      if(!isRestoringDraft && draftLoadComplete) scheduleAutoSave();
      updateBasicInfoCompletion(options);
    }

    function getCmsLevel(){
      const value = (document.getElementById('cmsLevelValue')?.value || '').trim();
      return VALID_CMS_LEVELS.includes(value) ? value : '';
    }

    function initCmsLevelButtons(){
      const group=document.getElementById('cmsLevelGroup');
      if(!group) return;
      group.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{ setCmsLevel(btn.dataset.level); });
      });
      const current = (document.getElementById('cmsLevelValue')?.value || '').trim();
      if(current) setCmsLevel(current, { silent:true });
    }

    function loadServiceCatalog(){
      google.script.run.withSuccessHandler(data=>{
        const nextCatalog = JSON.parse(JSON.stringify(DEFAULT_SERVICE_CATALOG));
        if(data && typeof data === 'object'){
          if(data.needLevelCaps) nextCatalog.needLevelCaps = data.needLevelCaps;
          if(data.levelDetails) nextCatalog.levelDetails = data.levelDetails;
          if(data.dayCareRequirements) nextCatalog.dayCareRequirements = data.dayCareRequirements;
          if(data.dayCareLevels) nextCatalog.dayCareLevels = data.dayCareLevels;
          if(data.serviceRates) nextCatalog.serviceRates = data.serviceRates;
          if(typeof data.transportRoundTrips === 'number') nextCatalog.transportRoundTrips = data.transportRoundTrips;
          if(data.copayRates) nextCatalog.copayRates = data.copayRates;
          if(data.transportCategory) nextCatalog.transportCategory = data.transportCategory;
        }
        SERVICE_CATALOG = nextCatalog;
        refreshDayCareAvailability();
        syncPlanStateWithSelections();
      }).getServiceCatalog();
    }

    function onHomeCareToggle(card, selected){
      if(!card) return;
      const code = card.dataset ? card.dataset.code : '';
      if(!code) return;
      if(!selected){
        const input = card.querySelector('.home-care-qty');
        if(input){ input.value=''; }
      }
      updateCareServicePhrases();
      syncPlanStateWithSelections();
    }

    function onHomeCareQuantityChange(input){
      if(!input) return;
      const card = input.closest('.home-care-item');
      if(!card || card.dataset.selected !== '1'){
        buildApprovalPlanPreview();
        return;
      }
      const code = card.dataset ? card.dataset.code : '';
      if(!code) return;
      updateCareServicePhrases();
      const value = input.value ? input.value.trim() : '';
      if(value){
        const entry = servicePlanState[code];
        if(entry && !entry.monthlyUnits){
          entry.monthlyUnits = value;
          const planInput=document.querySelector(`[data-plan-code="${code}"][data-plan-field="monthlyUnits"]`);
          if(planInput && planInput !== document.activeElement){ planInput.value = value; }
        }
      }
      if(isBaCode(code)){
        updateBaEntryDerived(code);
      }else{
        buildApprovalPlanPreview();
      }
    }

    function onDayCareToggle(card, selected){
      if(selected){
        ensureSingleDayCareSelection(card);
      }
      updateCareServicePhrases();
      syncPlanStateWithSelections();
    }
    function applyAutoText(id, text){
      const el=document.getElementById(id);
      if(!el) return;
      const prevAuto = el.dataset.autoValue === undefined ? undefined : el.dataset.autoValue;
      const userEdited = el.dataset.userEdited === 'true';
      const current = el.value;
      if(!userEdited || current === prevAuto){
        el.value = text;
        el.dataset.userEdited = 'false';
      }
      el.dataset.autoValue = text;
    }
    function bindAutoGoalField(id){
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{
        const auto = el.dataset.autoValue;
        if(auto === undefined){
          el.dataset.userEdited = el.value ? 'true' : 'false';
        }else{
          el.dataset.userEdited = el.value === auto ? 'false' : 'true';
        }
      });
    }
    function resetGoalAutoState(ids){
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.dataset.userEdited = 'false';
      });
    }
    function resetCareServicePhrases(){
      resetGoalAutoState(['short_care','mid_care','long_goal']);
      updateCareServicePhrases();
    }
    function resetProfessionalPhrases(){
      resetGoalAutoState(['short_prof','mid_prof','long_goal']);
      updateProfessionalServicePhrases();
    }
    function resetTransportPhrases(){
      resetGoalAutoState(['short_car','mid_car','long_goal']);
      updateTransportServicePhrases();
    }
    function resetRespitePhrases(){
      resetGoalAutoState(['short_resp','mid_resp','long_goal']);
      updateRespiteServicePhrases();
    }
    function resetMealPhrases(){
      resetGoalAutoState(['short_meal','mid_meal','long_goal']);
      updateMealServicePhrases();
    }
    function getSelectedHomeCareEntries(){
      const rows=[...document.querySelectorAll('#homeCareList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=HOME_CARE_MAP[code];
        if(!item) return null;
        const qtyInput=row.querySelector('.home-care-qty');
        const quantity = qtyInput ? qtyInput.value.trim() : '';
        return { code, item, quantity };
      }).filter(Boolean);
    }
    function getSelectedDayCareEntries(){
      const rows=[...document.querySelectorAll('#dayCareList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=DAY_CARE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function onProfessionalToggle(){
      updateProfessionalServicePhrases();
      syncPlanStateWithSelections();
    }
    function onTransportToggle(){
      updateTransportServicePhrases();
      syncPlanStateWithSelections();
    }
    function onRespiteToggle(){
      updateRespiteServicePhrases();
      syncPlanStateWithSelections();
    }
    function onMealToggle(){
      updateMealServicePhrases();
      syncPlanStateWithSelections();
    }
    function getSelectedProfessionalEntries(){
      const rows=[...document.querySelectorAll('#profServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=PROFESSIONAL_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedTransportEntries(){
      const rows=[...document.querySelectorAll('#transportServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=TRANSPORT_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedRespiteEntries(){
      const rows=[...document.querySelectorAll('#respServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=RESPITE_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedMealEntries(){
      const rows=[...document.querySelectorAll('#mealServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=MEAL_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedHomeCareCodes(){
      return getSelectedHomeCareEntries().map(entry=>entry.code);
    }
    function isHomeCareSelected(){
      return !!document.querySelector('#sp_formal input[type=checkbox][value="居家服務"]:checked');
    }
    function isDayCareSelected(){
      return !!document.querySelector('#sp_formal input[type=checkbox][value="日間照顧"]:checked');
    }
    function getSelectedCareEntries(){
      let entries=[];
      if(isHomeCareSelected()) entries = entries.concat(getSelectedHomeCareEntries());
      if(isDayCareSelected()) entries = entries.concat(getSelectedDayCareEntries());
      return entries;
    }
    function updateCareServicePhrases(){
      const entries = getSelectedCareEntries();
      const shortText = entries.map(entry=>formatCareServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatCareServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_care', shortText);
      applyAutoText('mid_care', midText);
      buildLongGoal();
    }
    function updateProfessionalServicePhrases(){
      const entries = getSelectedProfessionalEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_prof', shortText);
      applyAutoText('mid_prof', midText);
      buildLongGoal();
    }
    function updateTransportServicePhrases(){
      const entries = getSelectedTransportEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_car', shortText);
      applyAutoText('mid_car', midText);
      buildLongGoal();
    }
    function updateRespiteServicePhrases(){
      const entries = getSelectedRespiteEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_resp', shortText);
      applyAutoText('mid_resp', midText);
      buildLongGoal();
    }
    function updateMealServicePhrases(){
      const entries = getSelectedMealEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_meal', shortText);
      applyAutoText('mid_meal', midText);
      buildLongGoal();
    }
    function toggleInfInput(key){
      const on  = document.getElementById('sp_inf_'+key).checked;
      const name= document.getElementById('sp_inf_'+key+'_name');
      const freq= document.getElementById('sp_inf_'+key+'_freq');
      if(name){
        name.style.display = on ? '' : 'none'; 
        if(!on) name.value='';
      }
      // 頻率僅在「有勾選且名稱非空」時顯示
      if(freq){
        const showFreq = on && name && name.value.trim();
        freq.style.display = showFreq ? '' : 'none';
        if(!showFreq) freq.value='';
      }
      buildApprovalPlanPreview();
    }
    function bindInfNameToFreq(key){
      const name = document.getElementById('sp_inf_'+key+'_name');
      const freq = document.getElementById('sp_inf_'+key+'_freq');
      if(!name || !freq) return;
      name.addEventListener('input', ()=>{
      if(name.value.trim()){
        freq.style.display='';
      }else{
        freq.style.display='none';
        freq.value='';
      }
      buildApprovalPlanPreview();
    });
    freq.addEventListener('change', buildApprovalPlanPreview);
    freq.addEventListener('input', buildApprovalPlanPreview);
  }

    function toggleGoalInputs(){
      const selected=[...document.querySelectorAll('#sp_formal input[type=checkbox]:checked')].map(b=>b.value);
      const hasCare = selected.includes('居家服務') || selected.includes('日間照顧');
      const hasHomeCare = selected.includes('居家服務');
      const hasDayCare = selected.includes('日間照顧');
      const hasProf = selected.includes('專業服務');
      const hasCar  = selected.includes('交通接送');
      const hasResp = selected.includes('喘息服務');
      const hasAcc  = selected.includes('無障礙及輔具');
      const hasMeal = selected.includes('營養送餐');
      setVisible('short_care_wrap', hasCare); setVisible('mid_care_wrap', hasCare);
      setVisible('short_prof_wrap', hasProf); setVisible('mid_prof_wrap', hasProf);
      setVisible('short_car_wrap', hasCar);   setVisible('mid_car_wrap', hasCar);
      setVisible('short_resp_wrap', hasResp); setVisible('mid_resp_wrap', hasResp);
      setVisible('short_access_wrap', hasAcc); setVisible('mid_access_wrap', hasAcc);
      setVisible('short_meal_wrap', hasMeal);  setVisible('mid_meal_wrap', hasMeal);
      setVisible('homeCareWrap', hasHomeCare);
      setVisible('dayCareWrap', hasDayCare);
      setVisible('profServiceWrap', hasProf);
      setVisible('transportServiceWrap', hasCar);
      setVisible('respServiceWrap', hasResp);
      setVisible('mealServiceWrap', hasMeal);
      if(!hasHomeCare){
        document.querySelectorAll('#homeCareList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
          const qty = card.querySelector('.home-care-qty');
          if(qty){ qty.value=''; }
        });
      }
      if(!hasDayCare){
        document.querySelectorAll('#dayCareList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasProf){
        document.querySelectorAll('#profServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasCar){
        document.querySelectorAll('#transportServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasResp){
        document.querySelectorAll('#respServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasMeal){
        document.querySelectorAll('#mealServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      updateCareServicePhrases();
      if(!hasProf) updateProfessionalServicePhrases();
      if(!hasCar)  updateTransportServicePhrases();
      if(!hasResp) updateRespiteServicePhrases();
      if(!hasMeal) updateMealServicePhrases();
      syncPlanStateWithSelections();
    }
    function setVisible(id,on){ const el=document.getElementById(id); if(el) el.style.display = on? '' : 'none'; }

    function bindQuickReasons(){
      ['rq1_no','rq1_alt','rq2_service'].forEach(id=>{
        const inp=document.getElementById(id);
        const span=document.getElementById(id+'_preview');
        if(inp && span){ const def=span.dataset.def; inp.addEventListener('input', ()=>{ span.textContent = inp.value || def; }); }
      });
      const rel=document.getElementById('sp_deciderRel');
      const name=document.getElementById('sp_deciderName');
      rel?.addEventListener('change', syncQuickWho);
      name?.addEventListener('input', syncQuickWho);
      syncQuickWho();
      document.getElementById('rq1')?.addEventListener('change', ()=>toggleQuick(1));
      document.getElementById('rq2')?.addEventListener('change', ()=>toggleQuick(2));
    }
    function syncQuickWho(){
      const rel=document.getElementById('sp_deciderRel')?.value || '案';
      const name=(document.getElementById('sp_deciderName')?.value || '').trim() || '○';
      const who=rel+name;
      ['rq1_who','rq2_who'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=who; });
    }
    function toggleQuick(idx){
      const area=document.getElementById('reason3');
      let text=''; let box;
      const who=document.getElementById('rq1_who')?.textContent || '案○';
      if(idx===1){
        box=document.getElementById('rq1');
        const no=document.getElementById('rq1_no').value || document.getElementById('rq1_no_preview').dataset.def;
        const alt=document.getElementById('rq1_alt').value || document.getElementById('rq1_alt_preview').dataset.def;
        text=`經與${who}討論，目前暫無${no}之需求，改為${alt}。`;
      }else if(idx===2){
        box=document.getElementById('rq2');
        const svc=document.getElementById('rq2_service').value || document.getElementById('rq2_service_preview').dataset.def;
        text=`經與${who}討論，目前因個案身體狀況，暫無${svc}需求，日後待個案狀況好轉後，依當下狀況核定，續追蹤。`;
      }
      if(!box) return;
      if(box.checked){
        area.value = appendSentence(area.value, text);
        box.dataset.text=text;
      }else{
        area.value = removeSentence(area.value, box.dataset.text);
        box.dataset.text='';
      }
    }
    function appendSentence(base, text){
      base=base.trim();
      if(!base) return text;
      if(!base.endsWith('。')) base+='。';
      return base+text;
    }
    function removeSentence(base, text){
      return (base||'').replace(text,'').trim();
    }

    function copyFromH1Primary(){
      const relSelect=document.getElementById('primaryRel');
      const nameInput=document.getElementById('primaryName');
      const caseName=(document.getElementById('caseName').value||'').trim();
      let rel=relSelect ? relSelect.value : '';
      let name=nameInput ? nameInput.value.trim() : '';
      if(!rel){ rel='本人'; if(!name) name=caseName; }
      if(!name){ alert('三、偕同訪視者的主要照顧者尚未完整。'); return; }
      const phoneField = document.getElementById('primaryPhone');
      const sourcePhone = phoneField ? (phoneField.value || '').trim() : '';
      const deciderRel=document.getElementById('sp_deciderRel');
      const deciderName=document.getElementById('sp_deciderName');
      const deciderPhone=document.getElementById('sp_deciderPhone');
      if(deciderRel){
        const optionExists=[...deciderRel.options].some(opt=>opt.value===rel);
        deciderRel.value = optionExists ? rel : '';
        deciderRel.dispatchEvent(new Event('change', {bubbles:true}));
      }
      if(deciderName){
        deciderName.value = name;
        deciderName.dispatchEvent(new Event('input', {bubbles:true}));
      }
      if(deciderPhone){
        deciderPhone.value = sourcePhone;
        deciderPhone.dispatchEvent(new Event('input', {bubbles:true}));
      }
      syncQuickWho();
      buildSection4();
    }
    function addCoCare(){
      const host=document.getElementById('coCare');
      const idx=coCareIdx++;
      const wrap=document.createElement('div'); wrap.className='row'; wrap.id=`cc-${idx}`;
      wrap.innerHTML=`
        <div class="field-intro">
          <label class="h4">關係</label>
          <select id="cc-rel-${idx}" onchange="toggleCustomRole(${idx}, 'cc')">
            ${roleOptionsHTML()}
          </select>
          <input id="cc-custom-${idx}" type="text" placeholder="自訂角色" style="display:none; margin-top:var(--space-xs);">
        </div>
        <div class="field-intro"><label class="h4">姓名</label><input id="cc-name-${idx}" type="text" placeholder="例如：李○○"></div>
        <div style="flex:0; align-self:flex-end;"><button class="small" onclick="removeCoCareRow(${idx})">移除</button></div>
      `;
      host.appendChild(wrap);
    }

    function removeCoCareRow(idx){
      const row=document.getElementById(`cc-${idx}`);
      if(row) row.remove();
      buildSection4();
      if(!isRestoringDraft) scheduleAutoSave();
    }

    function resetCoCare(){
      document.querySelectorAll('[id^="cc-"]').forEach(el=>el.remove());
      coCareIdx = 0;
    }

    function restoreCoCare(list){
      resetCoCare();
      if(!Array.isArray(list) || !list.length) return;
      list.forEach(entry=>{
        const rel = entry && entry.rel !== undefined ? String(entry.rel).trim() : '';
        const customRel = entry && entry.customRel !== undefined ? String(entry.customRel).trim() : '';
        const name = entry && entry.name !== undefined ? String(entry.name).trim() : '';
        if(!rel && !customRel && !name) return;
        const currentIndex = coCareIdx;
        addCoCare();
        const select=document.getElementById(`cc-rel-${currentIndex}`);
        const custom=document.getElementById(`cc-custom-${currentIndex}`);
        const nameInput=document.getElementById(`cc-name-${currentIndex}`);
        let appliedCustom=false;
        if(select){
          const hasOption = rel && [...select.options].some(opt=>opt.value===rel);
          if(hasOption){
            select.value = rel;
          }else if(rel){
            select.value = '自訂角色';
            appliedCustom = true;
          }else if(customRel){
            select.value = '自訂角色';
            appliedCustom = true;
          }
          if(select.value === '自訂角色' && custom){
            custom.style.display='';
            custom.value = customRel || (!hasOption ? rel : '');
          }else if(custom){
            custom.style.display='none';
            custom.value='';
          }
        }
        if(appliedCustom && custom && !custom.value){
          custom.value = rel;
        }
        if(nameInput) nameInput.value = name;
      });
    }
    function collectCoCare(){
      const out=[]; const rows=[...document.querySelectorAll('[id^="cc-"]')];
      rows.forEach(row=>{
        const idx=row.id.split('-')[1];
        const sel=document.getElementById(`cc-rel-${idx}`), custom=document.getElementById(`cc-custom-${idx}`), nameEl=document.getElementById(`cc-name-${idx}`);
        let rel=(sel?sel.value:'').trim(); if(rel==='自訂角色') rel=(custom?custom.value:'').trim();
        const name=(nameEl?nameEl.value:'').trim();
        if(rel && name) out.push({rel, name});
      });
      return out;
    }
    function buildSection4(){
      // ① 主照者（改讀三、偕同訪視者）
      let pr = (document.getElementById('primaryRel').value || '').trim();
      let pn = (document.getElementById('primaryName').value || '').trim();
      const caseName=(document.getElementById('caseName').value||'').trim();
      if(!pr){ pr='本人'; if(!pn) pn=caseName; }
      const ch = (document.getElementById('sp_cohabit').value || '').trim();

      // ② 主要聯繫人/決策者（維持原機制）
      let dr = (document.getElementById('sp_deciderRel').value || '').trim();
      if(dr==='自訂角色') dr = '（自訂）';
      const dn = (document.getElementById('sp_deciderName').value || '').trim();

      // ③ 共同照顧者（原機制）
      const cc = collectCoCare();

      // ④ 正式資源（原機制）
      const formal=[...document.querySelectorAll('#sp_formal input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);

      // ⑤ 非正式資源（改為每類各自名稱＋頻率）
      function infText(key, label){
        const chk = document.getElementById('sp_inf_'+key);
        if(!chk || !chk.checked) return '';
        const name = (document.getElementById('sp_inf_'+key+'_name')?.value || '').trim();
        const freq = (document.getElementById('sp_inf_'+key+'_freq')?.value || '').trim();
        if(name && freq) return `${label}（單位：${name}；頻率：${freq}）`;
        if(name)         return `${label}（單位：${name}）`;
        return label;
      }
      const infParts = [
        infText('pt','據點'),
        infText('nb','鄰里'),
        infText('rg','宗教/社團'),
        infText('fw','財團/社會福利')
      ].filter(Boolean);

      // ⑥ 風險（原機制）
      const risks=[...document.querySelectorAll('#sp_risks input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);

      // ⑦ 組字（維持原用語順序；僅變更主照者來源與非正式資源格式）
      let s='';
      if(pr && pn) s += `主照者為${pr}(${pn})${ch? '（'+ch+'）':''}`;
      if(dr && dn) s += (s? '，':'') + `主要聯繫人/決策者為${dr}(${dn})`;
      if(cc.length){
        const list = cc.map(x=>`${x.rel}(${x.name})`).join('、');
        s += (s? '，':'') + `並由${list}等共同協助`;
      }
      s += (s? '；':'') + '社區整合型服務中心為福安';
      if(formal.length) s += `，目前可運用資源：${formal.join('、')}`;
      if(infParts.length) s += `；非正式資源：${infParts.join('、')}`;
      if(risks.length) s += `；高風險評估：${risks.join('、')}`;
      if(s) s+='。';
      document.getElementById('section4_out').value = s;
    }
    function syncSocialPrimary(){
      let rel  = document.getElementById('primaryRel')?.value || '';
      let name = (document.getElementById('primaryName')?.value || '').trim();
      const caseName = (document.getElementById('caseName')?.value || '').trim();
      if(!rel){ rel='本人'; if(!name) name=caseName; }
      const relBox  = document.getElementById('sp_primaryRel_text');
      const nameBox = document.getElementById('sp_primaryName_text');
      if(relBox)  relBox.textContent  = rel || '—';
      if(nameBox) nameBox.textContent = name || '—';
    }


    /* ===== (六) 複評（結構→單行） ===== */
    function buildSection6(){
      const b=(document.getElementById('s6_before').value||'').trim();
      const a=(document.getElementById('s6_after').value||'').trim();
      let s='';
      if(b) s += `介入前：${b}`;
      if(a) s += (s? '；':'') + `介入後：${a}`;
      if(s) s+='。'; else s='此個案為新案，無複評評值。';
      document.getElementById('section6_struct').value = s;
    }

    /* ===== 五、照顧目標（原程式） ===== */
    const PROBLEMS = {
      1:'進食問題',2:'洗澡問題',3:'個人修飾問題',4:'穿脫衣物問題',5:'大小便控制問題',
      6:'上廁所問題',7:'移位問題',8:'走路問題',9:'上下樓梯問題',10:'使用電話問題',
      11:'購物或外出問題',12:'備餐問題',13:'處理家務問題',14:'用藥問題',15:'處理財務問題',
      16:'溝通問題',17:'短期記憶障礙',18:'疼痛問題',19:'不動症候群風險',20:'皮膚照護問題',
      21:'傷口問題',22:'水份及營養問題',23:'吞嚥問題',24:'管路照顧問題',25:'其他醫療照護問題',
      26:'跌倒風險',27:'安全疑慮',28:'居住環境障礙',29:'社會參與需協助',30:'困擾行為',
      31:'照顧負荷過重',32:'輔具使用問題',33:'感染問題',34:'其他問題'
    };

    function createVirtualChecklist(host, items, options){
      if(!host) return null;
      options = options || {};
      const rowHeight = options.rowHeight || 48;
      const buffer = options.buffer || 3;
      const wrapper=document.createElement('div');
      wrapper.className='virtual-checklist';
      const viewport=document.createElement('div');
      viewport.className='virtual-checklist-viewport';
      const spacer=document.createElement('div');
      spacer.className='virtual-checklist-spacer';
      spacer.style.height = `${items.length * rowHeight}px`;
      const visible=document.createElement('div');
      visible.className='virtual-checklist-visible';
      viewport.appendChild(spacer);
      viewport.appendChild(visible);
      wrapper.appendChild(viewport);
      host.appendChild(wrapper);
      const state={ host, wrapper, viewport, spacer, visible, items, rowHeight, buffer };
      function render(){
        const scrollTop = viewport.scrollTop || 0;
        const viewportHeight = viewport.clientHeight || 0;
        const start = Math.max(0, Math.floor(scrollTop / rowHeight) - buffer);
        const end = Math.min(items.length, Math.ceil((scrollTop + viewportHeight) / rowHeight) + buffer);
        visible.style.transform = `translateY(${start * rowHeight}px)`;
        visible.innerHTML='';
        for(let i=start; i<end; i++){
          const item = items[i];
          if(!item) continue;
          const node = typeof options.renderItem === 'function' ? options.renderItem(item, i, state) : null;
          if(node) visible.appendChild(node);
        }
      }
      const handleScroll = ()=>render();
      const handleResize = ()=>render();
      viewport.addEventListener('scroll', handleScroll);
      window.addEventListener('resize', handleResize);
      state.render = render;
      state.destroy = ()=>{
        viewport.removeEventListener('scroll', handleScroll);
        window.removeEventListener('resize', handleResize);
      };
      render();
      return state;
    }

    function updateProblemListPrintSummary(){
      const box=document.getElementById('problemListPrint');
      if(!box) return;
      box.innerHTML='';
      if(!problemSelection.size){
        box.textContent='（尚未選擇照顧問題）';
        return;
      }
      const items = Array.from(problemSelection).map(code=>{
        const label = PROBLEMS && PROBLEMS[code] ? PROBLEMS[code] : '';
        return { code:String(code), label };
      });
      items.sort((a,b)=>Number(a.code) - Number(b.code));
      const list=document.createElement('ol');
      items.forEach(item=>{
        const li=document.createElement('li');
        if(item.label){
          li.textContent = `${item.code}.${item.label}`;
        }else{
          li.textContent = item.code;
        }
        list.appendChild(li);
      });
      box.appendChild(list);
    }

    function toggleProblemSelection(code, checked, input){
      const value = String(code);
      if(checked){
        if(!problemSelection.has(value) && problemSelection.size >= PROBLEM_MAX_SELECTION){
          if(input) input.checked = false;
          return false;
        }
        problemSelection.add(value);
      }else{
        problemSelection.delete(value);
      }
      if(problemListVirtual && typeof problemListVirtual.render === 'function'){
        problemListVirtual.render();
      }
      limitProblems();
      return true;
    }

    function renderProblems(){
      const host=document.getElementById('problemList');
      if(!host) return;
      if(problemListVirtual && typeof problemListVirtual.destroy === 'function'){
        problemListVirtual.destroy();
      }
      problemListVirtual = null;
      host.innerHTML='';
      host.dataset.virtualChecklist='1';
      const items=[];
      for(let n=1;n<=34;n++){
        items.push({ code:String(n), label:`${n}.${PROBLEMS[n]}` });
      }
      problemListVirtual = createVirtualChecklist(host, items, {
        rowHeight:48,
        buffer:4,
        renderItem:(item)=>{
          const label=document.createElement('label');
          label.className='virtual-checklist-item';
          const input=document.createElement('input');
          input.type='checkbox';
          input.value=item.code;
          input.id=`problem_item_${item.code}`;
          input.checked = problemSelection.has(item.code);
          input.disabled = !input.checked && problemSelection.size >= PROBLEM_MAX_SELECTION;
          input.addEventListener('change', evt=>{ toggleProblemSelection(item.code, evt.target.checked, evt.target); });
          const text=document.createElement('span');
          text.textContent=item.label;
          label.appendChild(input);
          label.appendChild(text);
          return label;
        }
      });
      updateProblemListPrintSummary();
      limitProblems();
    }

    function limitProblems(){
      const counter=document.getElementById('problemCount');
      if(counter) counter.textContent=`已選 ${problemSelection.size} / ${PROBLEM_MAX_SELECTION}`;
      const reached = problemSelection.size >= PROBLEM_MAX_SELECTION;
      if(problemListVirtual && problemListVirtual.visible){
        problemListVirtual.visible.querySelectorAll('input[type=checkbox]').forEach(input=>{
          if(!input) return;
          const code = String(input.value || '');
          if(problemSelection.has(code)){
            input.disabled = false;
          }else{
            input.disabled = reached;
          }
        });
      }
      updateProblemListPrintSummary();
      buildApprovalPlanPreview();
    }

    function getSelectedProblems(){
      return Array.from(problemSelection).map(code=>parseInt(code,10)).filter(num=>!Number.isNaN(num));
    }
    function buildLongGoal(){
      const careEntries = getSelectedCareEntries();
      const profEntries = getSelectedProfessionalEntries();
      const carEntries  = getSelectedTransportEntries();
      const respEntries = getSelectedRespiteEntries();
      const mealEntries = getSelectedMealEntries();
      const sections = [];

      const careLines = careEntries.map(entry=>formatCareServiceSentence(entry, 'long')).filter(Boolean);
      if(careLines.length){
        sections.push('照顧服務：');
        careLines.forEach(line=>sections.push(`- ${line}`));
      }

      const profSummary = gatherLongSummary('short_prof','mid_prof');
      const profLong = profEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(profLong.length){
        profLong.forEach(line=>profSummary.push(`長期：${line}`));
      }
      if(profSummary.length){
        sections.push('專業服務：');
        profSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const carSummary = gatherLongSummary('short_car','mid_car');
      const carLong = carEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(carLong.length){
        carLong.forEach(line=>carSummary.push(`長期：${line}`));
      }
      if(carSummary.length){
        sections.push('交通接送：');
        carSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const respSummary = gatherLongSummary('short_resp','mid_resp');
      const respLong = respEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(respLong.length){
        respLong.forEach(line=>respSummary.push(`長期：${line}`));
      }
      if(respSummary.length){
        sections.push('喘息服務：');
        respSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const accessSummary = gatherLongSummary('short_access','mid_access');
      if(accessSummary.length){
        sections.push('無障礙及輔具：');
        accessSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const mealSummary = gatherLongSummary('short_meal','mid_meal');
      const mealLong = mealEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(mealLong.length){
        mealLong.forEach(line=>mealSummary.push(`長期：${line}`));
      }
      if(mealSummary.length){
        sections.push('營養送餐：');
        mealSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const finalText = sections.join('\n');
      applyAutoText('long_goal', finalText);
      buildGoalPreview();
    }

    function formatCareServiceSentence(entry, key){
      if(!entry || !entry.item) return '';
      const item = entry.item;
      const desc = item[key] || '';
      if(!desc.trim()) return '';
      const quantity = entry.quantity ? entry.quantity.trim() : '';
      const qtyText = quantity ? `（數量：${quantity}）` : '';
      return `${item.code}[${item.name}]${qtyText}：${desc}`;
    }
    function formatGoalServiceSentence(entry, key){
      if(!entry || !entry.item) return '';
      const item = entry.item;
      const desc = item[key] || '';
      if(!desc.trim()) return '';
      return `${item.code}[${item.name}]：${desc}`;
    }

    function normalizeBulletLine(line){
      return (line || '').replace(/^[\-\u2022\u2023\u25E6．\s]+/, '').trim();
    }

    function extractLines(text){
      if(!text) return [];
      return text
        .split(/\r?\n/)
        .map(normalizeBulletLine)
        .filter(Boolean);
    }

    function gatherLongSummary(shortId, midId){
      const shortLines = extractLines(document.getElementById(shortId)?.value || '');
      const midLines = extractLines(document.getElementById(midId)?.value || '');
      const result=[];
      if(shortLines.length){
        result.push(`短期：${shortLines.join('；')}`);
      }
      if(midLines.length){
        result.push(`中期：${midLines.join('；')}`);
      }
      return result;
    }

    function parseLongGoalForPreview(){
      const map={};
      const text=(document.getElementById('long_goal')?.value || '').trim();
      if(!text) return map;
      const lines=text.split(/\r?\n/);
      let current='';
      lines.forEach(line=>{
        const trimmed=line.trim();
        if(!trimmed) return;
        const headingMatch=trimmed.match(/^(.+?)：$/);
        if(headingMatch){
          current=headingMatch[1].trim();
          if(!map[current]) map[current]=[];
          return;
        }
        if(current){
          const normalized=normalizeBulletLine(trimmed);
          if(normalized) map[current].push(normalized);
        }
      });
      return map;
    }

    function buildPreviewSection(period){
      let heading='';
      const categories=[];
      if(period==='short'){
        heading='(二) 短期目標（0–3 個月）';
        [
          ['照顧服務','short_care'],
          ['專業服務','short_prof'],
          ['交通接送','short_car'],
          ['喘息服務','short_resp'],
          ['無障礙及輔具','short_access'],
          ['營養送餐','short_meal']
        ].forEach(([label, field])=>{
          const lines = extractLines(document.getElementById(field)?.value || '');
          if(lines.length) categories.push({label, lines});
        });
      }else if(period==='mid'){
        heading='(三) 中期目標（3–4 個月）';
        [
          ['照顧服務','mid_care'],
          ['專業服務','mid_prof'],
          ['交通接送','mid_car'],
          ['喘息服務','mid_resp'],
          ['無障礙及輔具','mid_access'],
          ['營養送餐','mid_meal']
        ].forEach(([label, field])=>{
          const lines = extractLines(document.getElementById(field)?.value || '');
          if(lines.length) categories.push({label, lines});
        });
      }else if(period==='long'){
        heading='(四) 長期目標（4–6 個月）';
        const longMap = parseLongGoalForPreview();
        ['照顧服務','專業服務','交通接送','喘息服務','無障礙及輔具','營養送餐'].forEach(label=>{
          const lines = longMap[label] || [];
          if(lines.length) categories.push({label, lines});
        });
      }

      if(!categories.length) return '';
      const lines=['======================================', heading, '======================================'];
      categories.forEach((cat, idx)=>{
        lines.push(`${idx+1}.${cat.label}`);
        cat.lines.forEach(text=>{ lines.push(` - ${text}`); });
      });
      return lines.join('\n');
    }

    function buildGoalPreview(){
      const box=document.getElementById('goalPreview');
      if(!box) return;
      const sections=['short','mid','long'].map(buildPreviewSection).filter(Boolean);
      if(sections.length){
        box.textContent = sections.join('\n\n');
        box.classList.remove('goal-preview-empty');
      }else{
        box.textContent = '（尚未選擇服務或填寫內容）';
        box.classList.add('goal-preview-empty');
      }
    }

    /* ===== 送出 ===== */
    function validateConditionalRequired(){
      const messages=[];
      const items=[...document.querySelectorAll('[data-required-when]')];
      items.forEach(field=>{
        const rule=field.dataset.requiredWhen;
        const sourceId=field.dataset.requiredSource;
        let required=false;
        if(rule==='partial' && sourceId){
          const source=document.getElementById(sourceId);
          required = source && source.value === '部分協助';
        }
        if(required){
          const value=field.value !== undefined && field.value !== null ? String(field.value).trim() : '';
          if(!value){
            field.classList.add('input-invalid');
            const label=field.dataset.requiredLabel || '';
            const text = label ? `請填寫：${label}` : '請補齊必要欄位';
            messages.push({ fieldId: field.id, pageId: 'goals', text });
          }else{
            field.classList.remove('input-invalid');
          }
        }else{
          field.classList.remove('input-invalid');
        }
      });
      return { ok: messages.length===0, messages };
    }

    function normalizeLabelText(text){
      return text ? text.replace(/\s+/g, ' ').trim() : '';
    }

    function getErrorSectionLabelFromField(field){
      if(!field) return '';
      if(field.closest){
        const sectionBlock = field.closest('[data-section]');
        if(sectionBlock){
          const headerLabel = normalizeLabelText(sectionBlock.querySelector('.titlebar label')?.textContent);
          if(headerLabel) return headerLabel;
        }
        const sectionGroup = field.closest('.section-group');
        if(sectionGroup){
          const toggleLabel = normalizeLabelText(sectionGroup.querySelector('.section-group-toggle')?.textContent);
          if(toggleLabel) return toggleLabel;
          const innerTitle = normalizeLabelText(sectionGroup.querySelector('.titlebar label')?.textContent);
          if(innerTitle) return innerTitle;
        }
      }
      let node = field;
      while(node){
        if(node.classList && node.classList.contains('group')){
          for(let i=0; i<node.children.length; i++){
            const child=node.children[i];
            if(child && child.tagName && child.tagName.toLowerCase()==='label'){
              const label=normalizeLabelText(child.textContent);
              if(label) return label;
            }
          }
        }
        node = node.parentElement;
      }
      return '';
    }

    function resolveErrorSectionLabel(msg){
      if(!msg) return '其他';
      if(msg.section){
        const labeled = normalizeLabelText(msg.section);
        if(labeled) return labeled;
      }
      if(msg.fieldId){
        const field=document.getElementById(msg.fieldId);
        const label=getErrorSectionLabelFromField(field);
        if(label) return label;
      }
      if(msg.pageId){
        const tab=document.querySelector(`.page-tabs [data-page="${msg.pageId}"]`);
        const tabLabel=normalizeLabelText(tab?.textContent);
        if(tabLabel) return tabLabel;
      }
      return '其他';
    }

    function groupErrorsBySection(messages){
      const ordered=[];
      const map=new Map();
      (messages || []).forEach(msg=>{
        const sectionLabel=resolveErrorSectionLabel(msg);
        if(!map.has(sectionLabel)){
          map.set(sectionLabel, { label: sectionLabel, items: [] });
          ordered.push(map.get(sectionLabel));
        }
        map.get(sectionLabel).items.push(msg);
      });
      return ordered;
    }

    function renderErrorSummary(messages){
      const box=document.getElementById('errorSummary');
      if(!box) return;
      box.innerHTML='';
      if(!Array.isArray(messages) || !messages.length){
        box.dataset.show='0';
        return;
      }
      const grouped = groupErrorsBySection(messages);
      const sectionsHtml = grouped.map(group=>{
        const sectionTitle = escapeHtml(group.label || '其他');
        const itemsHtml = (group.items || []).map(msg=>{
          const fieldId = msg && msg.fieldId ? msg.fieldId : '';
          const pageId = msg && msg.pageId ? msg.pageId : '';
          const text = msg && msg.text ? msg.text : '';
          const safeText = escapeHtml(text);
          const attrs = `data-target="${escapeHtml(fieldId)}" data-page="${escapeHtml(pageId)}"`;
          return `<li><a href="#" ${attrs}>${safeText}</a></li>`;
        }).join('');
        return `<div class="error-panel-section"><div class="error-panel-section-title">${sectionTitle}</div><ul>${itemsHtml}</ul></div>`;
      }).join('');
      box.innerHTML = `<div class="error-panel-title">請修正以下欄位：</div>${sectionsHtml}`;
      box.dataset.show='1';
      box.querySelectorAll('a').forEach(link=>{
        link.addEventListener('click', handleErrorSummaryClick);
      });
    }

    function showValidationToast(options){
      const toast=document.getElementById('validationToast');
      const textEl=document.getElementById('validationToastText');
      const titleEl=toast ? toast.querySelector('.toast-title') : null;
      const actionBtn=document.getElementById('validationToastAction');
      if(!toast || !textEl) return;
      const payload=options || {};
      const type=payload.type || 'error';
      const sectionLabel=payload.sectionLabel || '';
      let message=payload.message;
      if(!message){
        if(type === 'warn'){
          message = '請留意表單欄位的提醒。';
        }else{
          const normalized=normalizeLabelText(sectionLabel);
          const label = normalized && normalized !== '其他' ? normalized : '表單';
          message = `${label} 有未完成的欄位，請補齊後再提交。`;
        }
      }
      textEl.textContent = message;
      if(titleEl){
        titleEl.textContent = type === 'warn' ? '提醒' : '提交前請先修正';
      }
      toast.dataset.type = type;
      toast.dataset.show='1';
      toast.dataset.target = payload.target || '';
      toast.dataset.page = payload.page || '';
      toast.dataset.step = (payload.step !== undefined && payload.step !== null) ? String(payload.step) : '';
      if(actionBtn){
        actionBtn.style.display = payload.target ? '' : 'none';
      }
    }

    function hideValidationToast(){
      const toast=document.getElementById('validationToast');
      const action=document.getElementById('validationToastAction');
      if(!toast) return;
      toast.dataset.show='0';
      toast.dataset.target='';
      toast.dataset.page='';
      toast.dataset.type='';
      toast.dataset.step='';
      if(action){ action.style.display=''; }
    }

    function initValidationToast(){
      const toast=document.getElementById('validationToast');
      if(!toast) return;
      hideValidationToast();
      const action=document.getElementById('validationToastAction');
      if(action){
        action.addEventListener('click', ()=>{
          const pageId=toast.dataset.page;
          const targetId=toast.dataset.target;
          const stepValue=toast.dataset.step;
          const step = stepValue ? Number(stepValue) : null;
          hideValidationToast();
          if(pageId) setActivePage(pageId, { step: step });
          else if(step) setCurrentWizardStep(step, { scroll:false });
          focusErrorTarget(targetId);
        });
      }
      const close=document.getElementById('validationToastClose');
      if(close){
        close.addEventListener('click', ()=>hideValidationToast());
      }
    }

    function handleErrorSummaryClick(evt){
      if(evt) evt.preventDefault();
      const link=evt && evt.currentTarget ? evt.currentTarget : null;
      if(!link) return;
      const pageId=link.dataset.page;
      const fieldId=link.dataset.target;
      const step = resolveWizardStepForField(fieldId);
      hideValidationToast();
      const fieldEl = fieldId ? document.getElementById(fieldId) : null;
      if(fieldEl && blockIfPlanGroupLocked(fieldEl)) return;
      if(step && isWizardStepLocked(step)){
        handleWizardStepLocked(step);
        return;
      }
      if(pageId){
        if(setActivePage(pageId, { step: step }) === false){
          return;
        }
      }else if(step){
        if(!setCurrentWizardStep(step, { scroll:false })){
          return;
        }
      }
      focusErrorTarget(fieldId);
    }

    function focusErrorTarget(fieldId){
      if(!fieldId) return;
      const el=document.getElementById(fieldId);
      if(!el) return;
      if(blockIfPlanGroupLocked(el)) return;
      if(typeof el.scrollIntoView === 'function'){
        el.scrollIntoView({behavior:'smooth', block:'center'});
      }
      let focusEl=null;
      if(typeof el.focus === 'function'){
        focusEl=el;
      }else{
        focusEl=el.querySelector('input,select,textarea,button,[tabindex]');
      }
      const highlightTarget=focusEl || el;
      if(highlightTarget && highlightTarget.classList){
        highlightTarget.classList.add('input-invalid');
      }
      if(focusEl && typeof focusEl.focus === 'function'){
        focusEl.focus();
      }
    }

    const STYLE_CHECK_FIELDS = Object.freeze([
      { id:'section1_out', label:'（一）身心概況', pageId:'goals' },
      { id:'section2_out', label:'（二）經濟收入', pageId:'goals' },
      { id:'section3_out', label:'（三）居住環境', pageId:'goals' },
      { id:'section4_out', label:'（四）社會支持', pageId:'goals' },
      { id:'section5', label:'（五）其他', pageId:'goals' },
      { id:'section6_struct', label:'（六）複評評值', pageId:'goals' },
      { id:'plan_text', label:'附件一：計畫執行規劃', pageId:'execution' }
    ]);

    function clearStyleCheckerMarks(){
      STYLE_CHECK_FIELDS.forEach(function(field){
        const el=document.getElementById(field.id);
        if(el && el.classList){
          el.classList.remove('input-invalid');
        }
      });
    }

    function runStyleChecker(){
      clearStyleCheckerMarks();
      const issues=[];
      STYLE_CHECK_FIELDS.forEach(function(field){
        const el=document.getElementById(field.id);
        if(!el) return;
        const text=(el.value || '').trim();
        if(!text) return;
        if(/\s{2,}/.test(text)){
          issues.push({ fieldId: field.id, pageId: field.pageId, message: field.label + ' 出現連續空白，請調整。' });
        }
        if(/[,.!?]/.test(text)){
          issues.push({ fieldId: field.id, pageId: field.pageId, message: field.label + ' 建議改用全形標點符號。' });
        }
        if(/ [。，、；：]/.test(text)){
          issues.push({ fieldId: field.id, pageId: field.pageId, message: field.label + ' 含前置空白，請確認標點前的空格。' });
        }
      });
      return { ok: issues.length === 0, issues: issues };
    }

    function applyAndSave(){
      const msg=document.getElementById('msg');
      if(msg) msg.textContent='';
      hideValidationToast();
      renderErrorSummary([]);
      const unitCode=document.getElementById('unitCode').value;
      const caseManagerName=document.getElementById('caseManagerName').value;
      const caseNameInput=document.getElementById('caseName');
      const caseName=(caseNameInput?.value||'').trim();
      const consultName=(document.getElementById('consultName').value||'').trim();
      const errors=[];
      if(!caseName){
        if(caseNameInput){
          caseNameInput.classList.add('input-invalid');
        }
        errors.push({ fieldId:'caseName', pageId:'basic', text:'請輸入：個案姓名' });
      }else if(caseNameInput){
        caseNameInput.classList.remove('input-invalid');
      }
      let primaryCaregiverRel = (document.getElementById('primaryRel').value||'').trim();
      let primaryCaregiverName= (document.getElementById('primaryName').value||'').trim();
      if(!primaryCaregiverRel){ primaryCaregiverRel='本人'; if(!primaryCaregiverName) primaryCaregiverName = caseName; }

      const conditionalValidation = validateConditionalRequired();
      if(!conditionalValidation.ok){
        errors.push.apply(errors, conditionalValidation.messages);
      }
      const participantValidation = validateParticipantConflicts();
      if(!participantValidation.ok){
        errors.push.apply(errors, participantValidation.messages);
      }
      const section1Validation = validateSection1();
      if(!section1Validation.ok){
        errors.push.apply(errors, section1Validation.messages);
      }
      const mismatchValidation = validateMismatchReasons();
      if(!mismatchValidation.ok){
        errors.push.apply(errors, mismatchValidation.messages);
      }

      if(errors.length){
        renderErrorSummary(errors);
        if(msg) msg.textContent='請先修正標記欄位後再產出。';
        const first=errors[0];
        if(first){
          const step = resolveWizardStepForField(first.fieldId);
          if(first.pageId) setActivePage(first.pageId, { step: step });
          else if(step) setCurrentWizardStep(step, { scroll:false });
          focusErrorTarget(first.fieldId);
          const sectionLabel=resolveErrorSectionLabel(first);
          showValidationToast({
            type:'error',
            sectionLabel:sectionLabel,
            target:first.fieldId,
            page:first.pageId,
            step:step
          });
        }
        return;
      }
      renderErrorSummary([]);
      if(msg) msg.textContent='';

      // 組裝各段
      buildSection1(section1Validation);
      buildS2(); buildS3(); buildSection4(); buildSection6(); buildLongGoal();

      buildApprovalPlanPreview();

      const ruleBlocks = Array.isArray(section1RuleRuntime.blocks) ? section1RuleRuntime.blocks : [];
      if(ruleBlocks.length){
        if(msg) msg.textContent='請先排除跨欄位矛盾後再產出。';
        const firstBlock = ruleBlocks[0] || {};
        const blockField = Array.isArray(firstBlock.fields) && firstBlock.fields.length ? firstBlock.fields[0] : '';
        const step = resolveWizardStepForField(blockField);
        if(step){
          setCurrentWizardStep(step, { scroll:false });
        }else{
          setActivePage('goals');
        }
        showValidationToast({
          type:'error',
          message:firstBlock.message || '請修正跨欄位矛盾後再提交。',
          target:blockField,
          page:'goals',
          step:step
        });
        if(blockField) focusErrorTarget(blockField);
        return;
      }

      const styleCheck = runStyleChecker();
      if(!styleCheck.ok){
        if(msg) msg.textContent='樣式檢查未通過，請依提示調整後再提交。';
        styleCheck.issues.forEach(function(issue){
          const fieldEl=document.getElementById(issue.fieldId);
          if(fieldEl && fieldEl.classList){ fieldEl.classList.add('input-invalid'); }
        });
        const firstIssue = styleCheck.issues[0] || {};
        const targetField = firstIssue.fieldId || '';
        const pageId = firstIssue.pageId || 'goals';
        const step = resolveWizardStepForField(targetField);
        showValidationToast({
          type:'warn',
          message:firstIssue.message || '請調整文字樣式後再提交。',
          target:targetField,
          page:pageId,
          step:step
        });
        if(pageId) setActivePage(pageId, { step: step });
        else if(step) setCurrentWizardStep(step, { scroll:false });
        if(targetField) focusErrorTarget(targetField);
        return;
      }

      const consentParties = buildConsentParties();
      const form = {
        unitCode, caseManagerName, caseName, consultName,
        cmsLevel: getCmsLevel(),
        callDate: getDateBox('callDate'),
        isConsultVisit: document.getElementById('isConsultVisit').checked,
        visitDate: getDateBox('visitDate'),
        isDischarge: document.getElementById('isDischarge').checked,
        dischargeDate: getDateBox('dischargeDate'),
        // 三、偕同訪視者
        primaryCaregiverRel: primaryCaregiverRel,
        primaryCaregiverName: primaryCaregiverName,
        includePrimary: true,              // 固定預設輸出
        extras: collectExtras(),
        consentParties: consentParties,
        // 四、個案概況（已組句）
        section1: (document.getElementById('section1_out').value || '').trim().replace(/^（一）身心概況：/, ''),
        section2: (document.getElementById('section2_out').value || '').trim(),
        section3: (document.getElementById('section3_out').value || '').trim(),
        section4: (document.getElementById('section4_out').value || '').trim(),
        section5: (document.getElementById('section5').value || '').trim(),
        section6: (document.getElementById('section6_struct').value || '').trim(),
        // 五、照顧目標
        problemKeys: getSelectedProblems(),
        problemNote: (document.getElementById('problemNote').value || '').trim(),
        short_care: (document.getElementById('short_care').value || '').trim(),
        short_prof: (document.getElementById('short_prof').value || '').trim(),
        short_car : (document.getElementById('short_car').value  || '').trim(),
        short_resp: (document.getElementById('short_resp').value || '').trim(),
        short_access: (document.getElementById('short_access').value || '').trim(),
        short_meal: (document.getElementById('short_meal').value || '').trim(),
        mid_care: (document.getElementById('mid_care').value || '').trim(),
        mid_prof: (document.getElementById('mid_prof').value || '').trim(),
        mid_car : (document.getElementById('mid_car').value  || '').trim(),
        mid_resp: (document.getElementById('mid_resp').value || '').trim(),
        mid_access: (document.getElementById('mid_access').value || '').trim(),
        mid_meal: (document.getElementById('mid_meal').value || '').trim(),
        long_goal: (document.getElementById('long_goal').value || '').trim(),
        servicePlan: serializeServicePlan(),
        hasForeignCare: hasForeignCareFlag(),
        planMeta: Object.assign({}, planMetaState),
        planText: (document.getElementById('plan_text').value || '').trim(),
        planOther: (document.getElementById('plan_other')?.value || '').trim()
      };

      google.script.run
        .withSuccessHandler(res=>{
          renderOutputMessage(res);
          persistSection1Previous();
          clearStyleCheckerMarks();
          renderSection1Preview(section1PreviewState.segments);
          clearAutoSaveDraft();
          lastSavedTimestamp = Date.now();
          scheduleSummaryUpdate();
          if (res && res.file && res.file.url) openProducedFile(res.file.url);
        })
        .withFailureHandler(err=>{
          msg.innerHTML = '<span class="danger">錯誤：</span>' + (err && err.message ? err.message : err);
        })
        .applyAndSave(form);
    }


    /* ===== Wizard Flow 與浮動操作 ===== */

    function findFirstWizardStepForPage(pageId){
      if(!pageId) return null;
      let candidate=null;
      for(let i=0;i<wizardStepsMeta.length;i++){
        const meta=wizardStepsMeta[i];
        if(meta && meta.page === pageId){
          if(!candidate || meta.step < candidate.step){
            candidate = meta;
          }
        }
      }
      return candidate;
    }

    function getWizardStepMeta(step){
      const stepNum = Number(step);
      return wizardStepLookup[stepNum] || null;
    }

    function getWizardIndex(step){
      const stepNum = Number(step);
      for(let i=0;i<wizardStepsMeta.length;i++){
        if(wizardStepsMeta[i].step === stepNum){
          return i;
        }
      }
      return -1;
    }

    function getWizardMoreElements(){
      return {
        button: document.getElementById('wizardMoreBtn'),
        menu: document.getElementById('wizardMoreMenu')
      };
    }

    function detachWizardMoreMenuEvents(){
      if(wizardMoreMenuState.outsideHandler){
        document.removeEventListener('mousedown', wizardMoreMenuState.outsideHandler, true);
        document.removeEventListener('touchstart', wizardMoreMenuState.outsideHandler, true);
        wizardMoreMenuState.outsideHandler = null;
      }
      if(wizardMoreMenuState.keydownHandler){
        document.removeEventListener('keydown', wizardMoreMenuState.keydownHandler, true);
        wizardMoreMenuState.keydownHandler = null;
      }
    }

    function attachWizardMoreMenuEvents(){
      if(wizardMoreMenuState.outsideHandler || wizardMoreMenuState.keydownHandler) return;
      wizardMoreMenuState.outsideHandler = evt=>{
        const { button, menu } = getWizardMoreElements();
        if(!menu || !button) return;
        const target = evt && evt.target;
        if(target && (menu.contains(target) || button.contains(target))){
          return;
        }
        closeWizardMoreMenu();
      };
      wizardMoreMenuState.keydownHandler = evt=>{
        if(!evt) return;
        if(evt.key === 'Escape' || evt.key === 'Esc'){
          const { button } = getWizardMoreElements();
          closeWizardMoreMenu();
          if(button && typeof button.focus === 'function'){
            button.focus({ preventScroll:true });
          }
        }
      };
      document.addEventListener('mousedown', wizardMoreMenuState.outsideHandler, true);
      document.addEventListener('touchstart', wizardMoreMenuState.outsideHandler, true);
      document.addEventListener('keydown', wizardMoreMenuState.keydownHandler, true);
    }

    function openWizardMoreMenu(){
      const { button, menu } = getWizardMoreElements();
      if(!button || !menu) return;
      const wasOpen = menu.dataset.open === '1';
      if(!wasOpen){
        menu.dataset.open='1';
        button.setAttribute('aria-expanded','true');
        attachWizardMoreMenuEvents();
        scheduleAllMeasurements();
      }
    }

    function closeWizardMoreMenu(){
      const { button, menu } = getWizardMoreElements();
      const wasOpen = menu && menu.dataset.open === '1';
      if(menu){
        menu.dataset.open='0';
      }
      if(button){
        button.setAttribute('aria-expanded','false');
      }
      detachWizardMoreMenuEvents();
      if(wasOpen){
        scheduleAllMeasurements();
      }
    }

    function toggleWizardMoreMenu(force){
      const { menu } = getWizardMoreElements();
      if(!menu) return;
      const shouldOpen = typeof force === 'boolean' ? force : menu.dataset.open !== '1';
      if(shouldOpen){
        openWizardMoreMenu();
      }else{
        closeWizardMoreMenu();
      }
    }

    function updateWizardButtons(){
      const prevBtn=document.getElementById('wizardPrevBtn');
      const nextBtn=document.getElementById('wizardNextBtn');
      const saveBtn=document.getElementById('wizardSaveBtn');
      const prevCompact=document.getElementById('wizardPrevCompactBtn');
      const total=wizardStepsMeta.length;
      const index=getWizardIndex(currentWizardStep);
      const hasSteps = total > 0 && index !== -1;
      const canPrev = hasSteps && index > 0;
      const canNext = hasSteps && index < total - 1;
      if(prevBtn){
        prevBtn.disabled = !canPrev;
        prevBtn.setAttribute('aria-disabled', canPrev ? 'false' : 'true');
      }
      if(nextBtn){
        nextBtn.disabled = !canNext;
        nextBtn.setAttribute('aria-disabled', canNext ? 'false' : 'true');
      }
      if(saveBtn){
        saveBtn.disabled = false;
        saveBtn.setAttribute('aria-disabled', 'false');
      }
      if(prevCompact){
        prevCompact.disabled = !canPrev;
        prevCompact.setAttribute('aria-disabled', canPrev ? 'false' : 'true');
      }
      if(!canPrev){
        closeWizardMoreMenu();
      }
    }

    function syncTabStatuses(){
      const tabs=document.querySelectorAll('.page-tabs [data-page]');
      if(!tabs.length){
        return;
      }
      if(!wizardStepsMeta.length){
        tabs.forEach(btn=>{
          const isActive=btn.classList ? btn.classList.contains('active') : false;
          btn.dataset.status = isActive ? 'active' : 'todo';
        });
        return;
      }
      const statusByPage = {};
      wizardStepsMeta.forEach(meta=>{
        if(!meta || !meta.page) return;
        let status = meta.element && meta.element.dataset ? (meta.element.dataset.status || '') : '';
        if(!status){
          if(currentWizardStep === meta.step){ status='active'; }
          else if(meta.step < currentWizardStep){ status='done'; }
          else{ status='todo'; }
        }
        const prev = statusByPage[meta.page];
        if(!prev || (TAB_STATUS_PRIORITY[status] || 0) > (TAB_STATUS_PRIORITY[prev] || 0)){
          statusByPage[meta.page] = status;
        }
      });
      tabs.forEach(btn=>{
        const page=btn.dataset.page || '';
        const assigned = statusByPage[page];
        if(assigned){
          btn.dataset.status = assigned;
        }else{
          const isActive=btn.classList ? btn.classList.contains('active') : false;
          btn.dataset.status = isActive ? 'active' : 'todo';
        }
      });
    }

    function updateWizardVisual(step, options){
      if(!wizardStepsMeta.length){
        currentWizardStep = null;
        updateWizardButtons();
        syncTabStatuses();
        return;
      }
      let targetStep = Number(step);
      if(!wizardStepLookup[targetStep]){
        targetStep = wizardStepsMeta[0].step;
      }
      wizardStepsMeta.forEach(function(meta){
        if(!meta || !meta.element) return;
        let status='todo';
        if(meta.step < targetStep){ status='done'; }
        else if(meta.step === targetStep){ status='active'; }
        meta.element.dataset.status = status;
        meta.element.setAttribute('aria-current', status === 'active' ? 'step' : 'false');
      });
      currentWizardStep = targetStep;
      closeWizardMoreMenu();
      updateWizardButtons();
      syncPageWithWizardStep(targetStep);
      syncTabStatuses();
      const jumpSelect=getWizardJumpSelect();
      if(jumpSelect){ jumpSelect.value=''; }
    }

    function syncPageWithWizardStep(step){
      if(typeof isWizardStepLocked === 'function' && isWizardStepLocked(step)){
        return;
      }
      const meta = getWizardStepMeta(step);
      if(!meta || !meta.page){
        return;
      }
      const targetPageId = meta.page;
      if(!targetPageId || currentPageId === targetPageId){
        return;
      }
      const sections = Array.from(document.querySelectorAll('.page-section'));
      if(!sections.length){
        return;
      }
      let activeSection = null;
      for(let i=0;i<sections.length;i++){
        const section = sections[i];
        if(section && section.dataset && section.dataset.page === targetPageId){
          activeSection = section;
          break;
        }
      }
      if(!activeSection){
        return;
      }
      const activation = applyPageActivation(sections, activeSection);
      const finalPageId = activation.finalPageId || targetPageId;
      currentPageId = finalPageId;
      updatePageTabActiveState(finalPageId);
      scheduleSideNavRender();
      scheduleAllMeasurements();
    }

    function determineWizardStepForPage(pageId, options){
      if(!wizardStepsMeta.length || !pageId) return null;
      if(options && options.step !== undefined){
        const desired = Number(options.step);
        if(wizardStepLookup[desired]) return desired;
      }
      const currentMeta = wizardStepLookup[currentWizardStep];
      if(currentMeta && currentMeta.page === pageId){
        return currentMeta.step;
      }
      const fallback = findFirstWizardStepForPage(pageId);
      return fallback ? fallback.step : null;
    }

    function scrollToWizardAnchor(anchor, options){
      if(!anchor) return;
      const element = typeof anchor === 'string' ? document.querySelector(anchor) : anchor;
      if(!element) return;
      if(typeof element.scrollIntoView === 'function'){
        element.scrollIntoView({ behavior: options && options.instant ? 'auto' : 'smooth', block:'start' });
      }else{
        const rect = element.getBoundingClientRect();
        const offset = Math.max(0, (currentScrollOffset || 0));
        const top = window.pageYOffset + rect.top - offset;
        window.scrollTo({ top: top < 0 ? 0 : top, behavior: options && options.instant ? 'auto' : 'smooth' });
      }
    }

    function setCurrentWizardStep(step, options){
      if(isWizardStepLocked(step)){
        handleWizardStepLocked(step);
        return false;
      }
      const meta = getWizardStepMeta(step);
      if(!meta) return false;
      if(setActivePage(meta.page, { step: meta.step }) === false){
        return false;
      }
      if(!options || options.scroll !== false){
        const anchor = meta.anchorElement || (meta.anchor ? document.querySelector(meta.anchor) : null);
        scrollToWizardAnchor(anchor, options);
      }
      if(options && options.focus){
        const anchor = meta.anchorElement || (meta.anchor ? document.querySelector(meta.anchor) : null);
        const focusTarget = anchor && anchor.querySelector ? anchor.querySelector('input,select,textarea,button,[tabindex]') : null;
        if(focusTarget && typeof focusTarget.focus === 'function'){
          focusTarget.focus({ preventScroll:true });
        }
      }
      return true;
    }

    function goWizardRelative(delta){
      if(!wizardStepsMeta.length) return;
      const index = getWizardIndex(currentWizardStep);
      if(index === -1) return;
      const target = wizardStepsMeta[index + delta];
      if(target){
        if(isWizardStepLocked(target.step)){
          handleWizardStepLocked(target.step);
          return;
        }
        setCurrentWizardStep(target.step, { focus:true });
      }
    }

    function resolveWizardStepForElement(el){
      if(!el) return null;
      for(let i=0;i<wizardStepsMeta.length;i++){
        const meta = wizardStepsMeta[i];
        if(!meta) continue;
        const anchorEl = meta.anchorElement || (meta.anchor ? document.querySelector(meta.anchor) : null);
        if(anchorEl){
          if(anchorEl === el || anchorEl.contains(el) || (typeof el.closest === 'function' && el.closest(meta.anchor))){
            return meta.step;
          }
        }
      }
      const section = el.closest ? el.closest('.page-section') : null;
      if(section && section.dataset && section.dataset.page){
        const pageId = section.dataset.page;
        const precedingMask = (typeof Node !== 'undefined' && Node.DOCUMENT_POSITION_PRECEDING) ? Node.DOCUMENT_POSITION_PRECEDING : 2;
        const followingMask = (typeof Node !== 'undefined' && Node.DOCUMENT_POSITION_FOLLOWING) ? Node.DOCUMENT_POSITION_FOLLOWING : 4;
        let fallback = null;
        let lastBefore = null;
        for(let i=0;i<wizardStepsMeta.length;i++){
          const meta = wizardStepsMeta[i];
          if(!meta || meta.page !== pageId) continue;
          if(!fallback) fallback = meta;
          if(!meta.anchorElement && meta.anchor){
            meta.anchorElement = document.querySelector(meta.anchor);
          }
          const anchorEl = meta.anchorElement;
          if(!anchorEl || typeof anchorEl.compareDocumentPosition !== 'function'){
            continue;
          }
          const position = anchorEl.compareDocumentPosition(el);
          if(position === 0){
            return meta.step;
          }
          if(position & followingMask){
            lastBefore = meta;
            continue;
          }
          if(position & precedingMask){
            return lastBefore ? lastBefore.step : meta.step;
          }
        }
        if(lastBefore){
          return lastBefore.step;
        }
        if(fallback){
          return fallback.step;
        }
      }
      return null;
    }

    function resolveWizardStepForField(fieldId){
      if(!fieldId) return null;
      const el = document.getElementById(fieldId);
      return resolveWizardStepForElement(el);
    }

    function initWizardFlow(){
      wizardStepsMeta = [];
      wizardStepLookup = {};
      const buttons = document.querySelectorAll('#wizardSteps .wizard-step');
      buttons.forEach(function(btn){
        const step = Number(btn.dataset.step);
        if(!step) return;
        const meta = {
          step: step,
          element: btn,
          page: btn.dataset.page || '',
          anchor: btn.dataset.anchor || '',
          anchorElement: null
        };
        const labelText = (btn.querySelector('.wizard-label')?.textContent || '').trim();
        if(labelText){
          btn.setAttribute('title', `跳至${labelText}`);
        }
        meta.anchorElement = meta.anchor ? document.querySelector(meta.anchor) : null;
        wizardStepsMeta.push(meta);
        wizardStepLookup[step] = meta;
        btn.addEventListener('click', function(){
          if(isWizardStepLocked(step)){
            handleWizardStepLocked(step);
            return;
          }
          setCurrentWizardStep(step, { focus:true });
        });
      });
      wizardStepsMeta.sort(function(a,b){ return a.step - b.step; });
      if(wizardStepsMeta.length){
        const activeSection = document.querySelector('.page-section[data-active="1"]');
        let initialStep = null;
        if(activeSection && activeSection.dataset){
          const pageId = activeSection.dataset.page;
          const match = findFirstWizardStepForPage(pageId);
          if(match) initialStep = match.step;
        }
        if(initialStep === null){
          initialStep = wizardStepsMeta[0].step;
        }
        updateWizardVisual(initialStep);
        applyWizardStepLockStates();
      }else{
        currentWizardStep = null;
        updateWizardButtons();
      }
      refreshWizardJumpOptions();
      scheduleAllMeasurements();
    }

    function initFloatingActions(){
      const prevBtn=document.getElementById('wizardPrevBtn');
      const nextBtn=document.getElementById('wizardNextBtn');
      const saveBtn=document.getElementById('wizardSaveBtn');
      const moreBtn=document.getElementById('wizardMoreBtn');
      const prevCompact=document.getElementById('wizardPrevCompactBtn');
      if(prevBtn){
        prevBtn.addEventListener('click', function(){
          closeWizardMoreMenu();
          goWizardRelative(-1);
        });
      }
      if(nextBtn){
        nextBtn.addEventListener('click', function(){
          closeWizardMoreMenu();
          goWizardRelative(1);
        });
      }
      if(saveBtn){
        saveBtn.addEventListener('click', function(){ applyAndSave(); });
      }
      if(prevCompact){
        prevCompact.addEventListener('click', function(){
          closeWizardMoreMenu();
          goWizardRelative(-1);
        });
      }
      if(moreBtn){
        moreBtn.addEventListener('click', function(evt){
          if(evt) evt.preventDefault();
          toggleWizardMoreMenu();
        });
      }
      updateWizardButtons();
      scheduleAllMeasurements();
    }


        /* ===== 初始化 ===== */
    function handlePageTabClick(event){
      const el = event ? (event.currentTarget || event.target) : null;
      if(!el) return;
      const btn = el.closest ? el.closest('[data-page]') : el;
      const pageId = btn && btn.dataset ? btn.dataset.page : '';
      setActivePage(pageId);
    }

    function applyPageActivation(sections, activeSection){
      if(!Array.isArray(sections) || !sections.length || !activeSection){
        return { finalPageId: '', changed: false };
      }
      let finalPageId = '';
      let changed = false;
      sections.forEach(section=>{
        if(!section) return;
        const isActive = section === activeSection;
        const nextValue = isActive ? '1' : '0';
        const prevValue = section.dataset ? (section.dataset.active || '') : section.getAttribute('data-active');
        if(section.dataset){
          if(prevValue !== nextValue){
            section.dataset.active = nextValue;
            changed = true;
          }
        }else if(prevValue !== nextValue){
          section.setAttribute('data-active', nextValue);
          changed = true;
        }
        const desiredDisplay = isActive ? '' : 'none';
        if(section.style && section.style.display !== desiredDisplay){
          section.style.display = desiredDisplay;
          changed = true;
        }
        if(isActive){
          finalPageId = section.dataset ? (section.dataset.page || '') : (section.getAttribute('data-page') || '');
        }
      });
      return { finalPageId, changed };
    }

    function updatePageTabActiveState(finalPageId){
      document.querySelectorAll('.page-tabs [data-page]').forEach(btn=>{
        const btnPage = btn && btn.dataset ? btn.dataset.page : '';
        const isActive = finalPageId ? btnPage === finalPageId : false;
        if(btn.classList){
          btn.classList.toggle('active', isActive);
        }
        if(typeof btn.setAttribute === 'function'){
          btn.setAttribute('aria-current', isActive ? 'page' : 'false');
        }
      });
    }

    function applyGoalsSectionDefaults(section){
      if(!section || !section.dataset) return false;
      const state = section.__state || (section.__state = readSectionState(section.dataset.section));
      let changed = false;
      if(state.hideFilled){
        state.hideFilled = false;
        changed = true;
      }
      if(!state.showAdvanced){
        state.showAdvanced = true;
        changed = true;
      }
      section.dataset.hideFilled = '0';
      section.dataset.showAdvanced = '1';
      const groups = Array.isArray(section.__groups) ? section.__groups : [];
      if(groups.length){
        const firstGroup = groups.find(group=>group && group.element) || groups[0];
        if(firstGroup){
          if(state.collapsedGroups && state.collapsedGroups[firstGroup.id]){
            delete state.collapsedGroups[firstGroup.id];
            changed = true;
          }
          setGroupCollapsed(section, firstGroup, false, { save:false });
        }
      }
      applySectionState(section, state);
      updateAllGroupEmptyStates(section);
      if(changed){
        writeSectionState(section.dataset.section, state);
      }
      return changed;
    }

    function ensureGoalsPageDefaults(activeSection){
      const planGroup=document.getElementById('contactVisitGroup');
      if(planGroup){
        planGroup.dataset.planLocked = '0';
        planGroup.dataset.collapsed = '0';
      }
      const host = activeSection || document.querySelector('.page-section[data-page="goals"]');
      if(!host){
        const audit = getUiAuditState();
        if(audit){
          audit.goals_defaults_ok = false;
          audit.contactVisit_init_open = !!(planGroup && planGroup.dataset && planGroup.dataset.planLocked === '0' && planGroup.dataset.collapsed === '0');
        }
        return;
      }
      const sections = host.querySelectorAll('[data-section]');
      sections.forEach(section=>{
        if(applyGoalsSectionDefaults(section)){
          updateSideNavForSection(section);
        }
      });
      const audit = getUiAuditState();
      if(audit){
        const defaultsApplied = Array.from(sections).every(section=>{
          if(!section || !section.dataset) return false;
          const hideOk = section.dataset.hideFilled === '0';
          const showOk = section.dataset.showAdvanced === '1';
          const firstGroup = section.querySelector('.section-group');
          const firstGroupOpen = !firstGroup || firstGroup.dataset.collapsed !== '1';
          return hideOk && showOk && firstGroupOpen;
        });
        audit.goals_defaults_ok = defaultsApplied;
        audit.contactVisit_init_open = !!(planGroup && planGroup.dataset && planGroup.dataset.planLocked === '0' && planGroup.dataset.collapsed === '0');
      }
      scheduleSummaryUpdate();
      scheduleSideNavRender();
      scheduleAllMeasurements();
    }

    function inspectPageSectionVisibility(activeSection){
      const section = activeSection || document.querySelector(`.page-section[data-page="${currentPageId}"]`);
      if(!section) return;
      const groups = section.querySelectorAll('.section-group');
      if(!groups.length) return;
      const rect = section.getBoundingClientRect();
      if(rect.height > 2) return;
      let culprit = section;
      let reason = 'unknown';
      let node = section;
      while(node && node !== document.body){
        const style = window.getComputedStyle(node);
        if(style.display === 'none'){
          culprit = node;
          reason = 'display:none';
          break;
        }
        if(style.visibility === 'hidden'){
          culprit = node;
          reason = 'visibility:hidden';
          break;
        }
        if((style.overflow === 'hidden' || style.overflowY === 'hidden' || style.overflowX === 'hidden') && node.scrollHeight === 0){
          culprit = node;
          reason = 'overflow hidden (zero height)';
          break;
        }
        node = node.parentElement;
      }
      let fixed = false;
      if(culprit){
        if(culprit.dataset && culprit.dataset.collapsed === '1'){
          culprit.dataset.collapsed = '0';
          fixed = true;
        }
        if(culprit.style){
          if(culprit.style.display === 'none'){
            culprit.style.display = '';
            fixed = true;
          }
          if(culprit.style.visibility === 'hidden'){
            culprit.style.visibility = '';
            fixed = true;
          }
        }
      }
      console.warn('頁面高度巡檢', {
        page: section.dataset ? section.dataset.page : currentPageId,
        reason,
        culprit,
        fixed
      });
      if(fixed){
        scheduleAllMeasurements();
      }
    }

    function setActivePage(pageId, options){
      const sections = Array.from(document.querySelectorAll('.page-section'));
      if(!sections.length) return false;
      const requestedId = typeof pageId === 'string' ? pageId : (pageId ? String(pageId) : '');
      const opts = options || {};
      const targetStep = requestedId ? determineWizardStepForPage(requestedId, opts) : null;
      if(targetStep !== null && isWizardStepLocked(targetStep)){
        handleWizardStepLocked(targetStep);
        return false;
      }
      let activeSection = null;
      if(requestedId){
        for(let i=0;i<sections.length;i++){
          const section = sections[i];
          if(section && section.dataset && section.dataset.page === requestedId){
            activeSection = section;
            break;
          }
        }
      }
      if(!activeSection){
        activeSection = sections[0] || null;
      }
      if(!activeSection) return false;
      const activation = applyPageActivation(sections, activeSection);
      const finalPageId = activation.finalPageId || (activeSection.dataset ? (activeSection.dataset.page || '') : '');
      currentPageId = finalPageId;
      updatePageTabActiveState(finalPageId);
      let effectiveStep = null;
      if(finalPageId){
        if(finalPageId === requestedId){
          effectiveStep = targetStep;
        }else{
          effectiveStep = determineWizardStepForPage(finalPageId, {});
        }
      }
      if(effectiveStep !== null){
        updateWizardVisual(effectiveStep, { fromPageActivation: true });
      }else{
        updateWizardButtons();
        syncTabStatuses();
      }
      if(finalPageId === 'goals'){
        ensureGoalsPageDefaults(activeSection);
      }
      inspectPageSectionVisibility(activeSection);
      scheduleSideNavRender();
      scheduleAllMeasurements();
      return true;
    }

    function initPageTabs(){
      const tabs=[...document.querySelectorAll('.page-tabs [data-page]')];
      if(!tabs.length) return;
      tabs.forEach(btn=>{
        btn.addEventListener('click', handlePageTabClick);
      });
      const initial = tabs.find(btn=>btn.classList && btn.classList.contains('active')) || tabs[0];
      if(initial){
        const initialPageId = initial.dataset ? initial.dataset.page : '';
        setActivePage(initialPageId || '');
      }else{
        setActivePage('');
      }
    }

    const VALID_CMS_LEVELS = Object.freeze(['2','3','4','5','6','7','8']);

    const BASIC_INFO_REQUIRED_FIELDS = Object.freeze([
      { fieldId:'caseManagerName', type:'select', statusId:'caseManagerStatus', label:'個案管理師' },
      { fieldId:'consultName', type:'select', statusId:'consultStatus', label:'照專姓名' },
      { fieldId:'caseName', type:'input', statusId:'caseNameStatus', label:'個案姓名' },
      { fieldId:'cmsLevelGroup', type:'cms', statusId:'cmsLevelStatus', label:'CMS 等級' }
    ]);

    const basicInfoState = { complete:false };
    const planGroupState = { locked:true, pendingExpand:false, hasOpened:false };

    function isBasicInfoComplete(){
      for(let i=0;i<BASIC_INFO_REQUIRED_FIELDS.length;i++){
        if(!getBasicInfoFieldValue(BASIC_INFO_REQUIRED_FIELDS[i])){
          return false;
        }
      }
      const unitSelect=document.getElementById('unitCode');
      const unitValue=(unitSelect && typeof unitSelect.value === 'string') ? unitSelect.value.trim() : '';
      return !!unitValue;
    }

    function getFirstIncompleteBasicInfoFieldId(){
      for(let i=0;i<BASIC_INFO_REQUIRED_FIELDS.length;i++){
        const field=BASIC_INFO_REQUIRED_FIELDS[i];
        if(!getBasicInfoFieldValue(field)){
          return field.fieldId;
        }
      }
      const unitSelect=document.getElementById('unitCode');
      if(unitSelect && !unitSelect.disabled && !(unitSelect.value || '').trim()){
        return 'unitCode';
      }
      return BASIC_INFO_REQUIRED_FIELDS.length ? BASIC_INFO_REQUIRED_FIELDS[0].fieldId : 'caseName';
    }

    function focusBasicInfoField(fieldId){
      if(!fieldId) return;
      const el=document.getElementById(fieldId);
      if(!el) return;
      if(typeof el.focus === 'function'){
        el.focus();
        return;
      }
      const focusEl=el.querySelector && el.querySelector('input,select,textarea,button,[tabindex]');
      if(focusEl && typeof focusEl.focus === 'function'){
        focusEl.focus();
      }
    }

    function isPlanGroupLocked(){
      return !!planGroupState.locked;
    }

    function applyPlanGroupLockState(options){
      const groupElement=document.getElementById('contactVisitGroup');
      if(groupElement){
        groupElement.dataset.planLocked = planGroupState.locked ? '1' : '0';
      }
      const ctrl=simpleGroupControllers['contactVisitGroup'];
      const shouldExpand = planGroupState.pendingExpand || (options && options.expand);
      if(!ctrl || !ctrl.element){
        if(groupElement){
          if(planGroupState.locked){
            if(groupElement.dataset.collapsed !== '1'){
              groupElement.dataset.collapsed = '1';
              scheduleAllMeasurements();
            }
            planGroupState.hasOpened = false;
          }else if(shouldExpand){
            if(groupElement.dataset.collapsed !== '0'){
              groupElement.dataset.collapsed = '0';
              scheduleAllMeasurements();
            }
            planGroupState.pendingExpand = false;
            planGroupState.hasOpened = true;
          }
        }
        return;
      }
      const toggle=ctrl.toggle || ctrl.element.querySelector('.group-collapse');
      if(toggle){
        toggle.classList.toggle('is-locked', planGroupState.locked);
        toggle.setAttribute('aria-disabled', planGroupState.locked ? 'true' : 'false');
        toggle.dataset.locked = planGroupState.locked ? '1' : '0';
        if(planGroupState.locked){
          toggle.setAttribute('title', '完成基本資訊後可展開');
        }else{
          toggle.removeAttribute('title');
        }
      }
      if(planGroupState.locked){
        if(ctrl.element.dataset.collapsed !== '1'){
          ctrl.applyState(true);
        }
        planGroupState.hasOpened = false;
      }else if(shouldExpand){
        ctrl.applyState(false);
        planGroupState.pendingExpand = false;
        planGroupState.hasOpened = true;
      }
    }

    function setPlanGroupLocked(locked, options){
      const requestUnlock = !locked;
      const shouldExpand = !!(options && options.expand);
      if(requestUnlock && !isBasicInfoComplete()){
        planGroupState.locked = true;
        planGroupState.pendingExpand = false;
        applyPlanGroupLockState();
        return;
      }
      planGroupState.locked = !!locked;
      if(planGroupState.locked){
        planGroupState.pendingExpand = false;
        planGroupState.hasOpened = false;
      }else if(shouldExpand || !planGroupState.hasOpened){
        planGroupState.pendingExpand = true;
      }
      applyPlanGroupLockState({ expand: shouldExpand });
    }

    function getBasicInfoFieldValue(field){
      if(!field) return '';
      if(field.type === 'cms'){
        const level = typeof getCmsLevel === 'function'
          ? (getCmsLevel() || '')
          : (document.getElementById('cmsLevelValue')?.value || '').trim();
        return VALID_CMS_LEVELS.includes(level) ? level : '';
      }
      const el=document.getElementById(field.fieldId);
      if(!el) return '';
      if(el.tagName === 'SELECT'){
        if(el.disabled) return '';
        const value=(el.value || '').trim();
        if(!value) return '';
        const option=el.options[el.selectedIndex];
        if(option && (option.disabled || option.classList.contains('placeholder-option'))){
          return '';
        }
        return value;
      }
      if(typeof el.value === 'string'){
        return el.value.trim();
      }
      return '';
    }

    function updateBasicInfoFieldState(field, filled){
      const status = filled ? 'complete' : 'invalid';
      if(field.type === 'cms'){
        const row=document.querySelector('.cms-level-row');
        if(row){
          row.dataset.status = status;
        }
      }else{
        const el=document.getElementById(field.fieldId);
        if(el && el.classList){
          if(filled){
            el.classList.remove('input-invalid');
            el.classList.add('input-complete');
          }else{
            el.classList.add('input-invalid');
            el.classList.remove('input-complete');
          }
          const container=el.closest('.basic-info-field');
          if(container){
            container.dataset.state = status;
          }
        }
      }
      const statusEl=document.getElementById(field.statusId);
      if(statusEl){
        statusEl.dataset.state = status;
        const label=field.label || '';
        if(filled){
          statusEl.textContent = label ? `「${label}」已完成` : '已完成';
        }else{
          statusEl.textContent = label ? `請完成「${label}」` : '請完成此欄位';
        }
      }
    }

    function applyWizardStepLockStates(){
      if(!Array.isArray(wizardStepsMeta) || !wizardStepsMeta.length) return;
      wizardStepsMeta.forEach(meta=>{
        if(!meta || !meta.element) return;
        const locked = meta.step > 1 && !basicInfoState.complete;
        meta.element.dataset.locked = locked ? '1' : '0';
        meta.element.setAttribute('aria-disabled', locked ? 'true' : 'false');
      });
    }

    function updateBasicInfoCompletion(options){
      let allFilled = true;
      BASIC_INFO_REQUIRED_FIELDS.forEach(field=>{
        const filled = !!getBasicInfoFieldValue(field);
        updateBasicInfoFieldState(field, filled);
        if(!filled){
          allFilled = false;
        }
      });
      const wasComplete = !!basicInfoState.complete;
      const ready = allFilled && isBasicInfoComplete();
      basicInfoState.complete = ready;
      applyWizardStepLockStates();
      const basicCtrl = simpleGroupControllers['basicInfoGroup'];
      if(ready){
        const shouldExpand = !wasComplete && !(options && options.silent);
        if(!wasComplete && shouldExpand){
          const element = basicCtrl && basicCtrl.element ? basicCtrl.element : document.getElementById('basicInfoGroup');
          if(element && element.dataset.collapsed !== '1'){
            if(basicCtrl && typeof basicCtrl.applyState === 'function'){
              basicCtrl.applyState(true);
            }else{
              element.dataset.collapsed = '1';
            }
          }
        }
        setPlanGroupLocked(false, { expand: shouldExpand });
        if(shouldExpand){
          setActivePage('goals', { step:2 });
          showValidationToast({
            type:'warn',
            message:'基本資訊完成，請繼續填寫計畫目標。',
            page:'goals',
            step:2
          });
          if(typeof scrollToAnchorId === 'function'){
            scrollToAnchorId('contactVisitGroup');
          }
        }
      }else{
        if(wasComplete){
          const element = basicCtrl && basicCtrl.element ? basicCtrl.element : document.getElementById('basicInfoGroup');
          if(element){
            if(basicCtrl && typeof basicCtrl.applyState === 'function'){
              basicCtrl.applyState(false);
            }else{
              element.dataset.collapsed = '0';
            }
          }
        }
        setPlanGroupLocked(true);
        if(currentWizardStep && currentWizardStep > 1 && typeof setCurrentWizardStep === 'function'){
          setCurrentWizardStep(1, { scroll:false });
        }
      }
      return ready;
    }

    function initBasicInfoValidation(){
      updateBasicInfoCompletion({ silent:true });
    }

    function handleLockedPlanAttempt(){
      updateBasicInfoCompletion({ silent:true });
      const focusTargetId=getFirstIncompleteBasicInfoFieldId();
      showValidationToast({
        type:'warn',
        message:'請先完成基本資訊。',
        target:focusTargetId,
        page:'basic',
        step:1
      });
      if(typeof setCurrentWizardStep === 'function'){
        setCurrentWizardStep(1, { scroll:false });
      }
      if(typeof scrollToAnchorId === 'function'){
        scrollToAnchorId('basicInfoGroup');
      }
      focusBasicInfoField(focusTargetId);
    }

    function shouldPreventPlanGroupExpansion(group){
      return group && group.id === 'contactVisitGroup' && isPlanGroupLocked();
    }

    function blockIfPlanGroupLocked(element){
      if(!element) return false;
      const group = element.id === 'contactVisitGroup'
        ? element
        : (typeof element.closest === 'function' ? element.closest('#contactVisitGroup') : null);
      if(group && shouldPreventPlanGroupExpansion(group)){
        handleLockedPlanAttempt();
        return true;
      }
      return false;
    }

    function isWizardStepLocked(step){
      const stepNum = Number(step);
      if(!stepNum || stepNum <= 1) return false;
      return !basicInfoState.complete;
    }

    function handleWizardStepLocked(step){
      if(Number(step) > 1){
        handleLockedPlanAttempt();
      }
    }

    function shouldBlockCollapseForBasicInfo(targetGroup){
      if(!targetGroup) return false;
      const basicCtrl=simpleGroupControllers['basicInfoGroup'];
      const planCtrl=simpleGroupControllers['contactVisitGroup'];
      if(!basicCtrl || !basicCtrl.element || !planCtrl || !planCtrl.element) return false;
      const isTargetBasic=basicCtrl.element === targetGroup;
      const isTargetPlan=planCtrl.element === targetGroup;
      if(!isTargetBasic && !isTargetPlan) return false;
      const basicCollapsed=basicCtrl.element.dataset.collapsed === '1';
      const planCollapsed=planCtrl.element.dataset.collapsed === '1';
      const willBasicCollapsed=isTargetBasic ? true : basicCollapsed;
      const willPlanCollapsed=isTargetPlan ? true : planCollapsed;
      if(willBasicCollapsed && willPlanCollapsed && !isBasicInfoComplete()){
        if(typeof basicCtrl.applyState === 'function'){
          basicCtrl.applyState(false);
        }else if(basicCtrl.element){
          basicCtrl.element.dataset.collapsed='0';
        }
        const focusTargetId=getFirstIncompleteBasicInfoFieldId();
        showValidationToast({
          type:'warn',
          message:'請先完成「基本資訊」欄位，再進行其他區塊。',
          target:focusTargetId,
          page:'basic',
          step:1
        });
        if(typeof scrollToAnchorId === 'function'){
          scrollToAnchorId('basicInfoGroup');
        }else if(basicCtrl.element && typeof basicCtrl.element.scrollIntoView === 'function'){
          basicCtrl.element.scrollIntoView({ behavior:'smooth', block:'start' });
        }
        focusBasicInfoField(focusTargetId);
        return true;
      }
      return false;
    }

    function initGroupCollapsibles(){
      Object.keys(simpleGroupControllers).forEach(key=>{ delete simpleGroupControllers[key]; });
      const groups=document.querySelectorAll('.group');
      groups.forEach(group=>{
        if(!group) return;
        if(group.closest('.section-group-body')){
          group.dataset.collapsible = '0';
          group.querySelectorAll('.group-collapse').forEach(btn=>btn.remove());
          ensureGroupContentWrapper(group);
          return;
        }
        if(group.querySelector(':scope > .group-header')) return;
        const collapsible = !(group.dataset && (group.dataset.collapsible === '0' || group.dataset.collapsible === 'disabled'));
        let heading=group.querySelector(':scope > .h1, :scope > .heading-tier');
        let header=null;
        if(heading){
          header=document.createElement('div');
          header.className='group-header';
          group.insertBefore(header, heading);
          header.appendChild(heading);
        }else{
          const titlebar=group.querySelector(':scope > .titlebar');
          const titleHeading=titlebar ? titlebar.querySelector('.h1, .heading-tier') : null;
          if(!titlebar || !titleHeading) return;
          heading=titleHeading;
          header=document.createElement('div');
          header.className='group-header';
          group.insertBefore(header, titlebar);
          header.appendChild(titlebar);
        }
        let toggle=null;
        let label=null;
        if(collapsible){
          group.dataset.collapsible = '1';
          toggle=document.createElement('button');
          toggle.type='button';
          toggle.className='group-collapse';
          const icon=document.createElement('span');
          icon.className='group-collapse-icon';
          icon.setAttribute('aria-hidden','true');
          icon.textContent='▾';
          label=document.createElement('span');
          label.className='group-collapse-label';
          label.textContent='收合';
          toggle.appendChild(icon);
          toggle.appendChild(label);
          header.appendChild(toggle);
        }else if(!group.dataset || !group.dataset.collapsible){
          group.dataset.collapsible = '0';
        }
        const body=document.createElement('div');
        body.className='group-content';
        const contentId=ensureElementId(body, `${group.id || 'group'}_content`);
        if(toggle) toggle.setAttribute('aria-controls', contentId);
        while(header.nextSibling){
          body.appendChild(header.nextSibling);
        }
        group.appendChild(body);
        const titleText=(heading.textContent || '').trim();
        const applyState=(collapsed)=>{
          const isCollapsed=!!collapsed;
          group.dataset.collapsed = isCollapsed ? '1' : '0';
          if(toggle){
            toggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
          }
          const actionText=isCollapsed ? '展開' : '收合';
          const ariaLabel=titleText ? `${actionText} ${titleText}` : actionText;
          if(toggle) toggle.setAttribute('aria-label', ariaLabel);
          if(label) label.textContent = actionText;
          scheduleAllMeasurements();
        };
        if(collapsible && toggle){
          const controller={ element:group, applyState, toggle };
          if(group.id){
            simpleGroupControllers[group.id] = controller;
          }
          toggle.addEventListener('click', ()=>{
            const isCollapsed=group.dataset.collapsed === '1';
            if(isCollapsed){
              if(shouldPreventPlanGroupExpansion(group)){
                handleLockedPlanAttempt();
                return;
              }
            }else if(shouldBlockCollapseForBasicInfo(group)){
              return;
            }
            applyState(!isCollapsed);
          });
        }
        const initialCollapsed = group.dataset && group.dataset.collapsed === '1';
        applyState(initialCollapsed);
      });
      applyPlanGroupLockState();
    }

    function initSection1State(){
      toggleVisionNotes(); toggleTransportOther(); toggleDhxOther(); toggleMedOther();
      toggleUrineOther('day'); toggleUrineOther('night');
      toggleLesionCombined(); toggleLesionLayerOther(); togglePainCombined(); toggleLesionHospital();
      renderHearingDetails();
      applyLocationStateToUI();
      updateLocationVisibility();
      toggleAdlHow('s1_transfer');
      toggleAdlHow('s1_adl_eating'); toggleAdlHow('s1_adl_groom'); toggleAdlHow('s1_adl_bathing');
      toggleAdlHow('s1_adl_dressing'); toggleAdlHow('s1_post_toilet'); toggleAdlHow('s1_meal_prep');
      toggleAdlHow('s1_housework'); toggleAdlHow('s1_finance');
      toggleShoppingHow(); toggleDishwashHow(); toggleSleepReason();
      toggleSwallow(); toggleFallDetail(); toggleSittingSupports(); togglePhoneNotes();
      updateExcretionAidEffects(); toggleGlassesAdherence(); toggleHearingDeviceAdherence();
      syncNoDiscomfort('s1_lesion_sx_box'); // 初始化互斥狀態
      updateLesionAreaDisplay();

      const s1block = document.getElementById('section1_block');
      if(s1block){
        s1block.addEventListener('input', buildSection1);
        s1block.addEventListener('change', buildSection1);
      }

      initActionEntries();

      initSection1Preview();
      initFormRules();

      buildSection1(); // 初次預覽一次
    }

    window.addEventListener('resize', scheduleAllMeasurements);
    window.addEventListener('orientationchange', scheduleAllMeasurements);
    window.addEventListener('focusin', scheduleAllMeasurements);
    window.addEventListener('focusout', scheduleAllMeasurements);
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize', scheduleAllMeasurements);
      window.visualViewport.addEventListener('scroll', scheduleAllMeasurements);
    }

    function applyEllipsisTooltips(){
      const selector='.group > label:first-child, .titlebar > label:first-child';
      document.querySelectorAll(selector).forEach(label=>{
        if(!label) return;
        const text=(label.textContent || '').trim();
        if(text){
          if(label.getAttribute('title') !== text){
            label.setAttribute('title', text);
          }
        }else{
          label.removeAttribute('title');
        }
      });
    }

    function initializeSidebarOnLoad(){
      buildInitialDomStructure();
      if(document.querySelector('.page-section .page-section')){
        console.error('偵測到巢狀 page-section，請檢查頁面結構。');
      }
      renderServicePlanEditor();
      const headingSchemaReport = logHeadingSchemaReport();
      handleHeadingSchemaValidation(headingSchemaReport);
      initHeadingSchemaToast();
      registerDevDiagnostics();
      initGroupCollapsibles();
      initSectionViews();
      refreshExecutionHeadingRegistry();
      ensureGoalsPageDefaults();
      scheduleSummaryUpdate();
      scheduleAllMeasurements();
      if(google && google.script && google.script.host && typeof google.script.host.setWidth === 'function'){
        try{ google.script.host.setWidth(900); }catch(err){}
      }
      initFontScaleControls();
      initWizardFlow();
      initFloatingActions();
      initPlanSummaryCopy();
      initSideNavToggle();
      initValidationToast();
      initDateInputs();
      setDateBox('callDate', new Date());
      setDateBox('visitDate', new Date());
      loadManagers();
      loadConsultants();
      initCmsLevelButtons();
      loadServiceCatalog();
      initBasicInfoValidation();
      initPageTabs();

      // S1
      renderS1(); initSection1State();

      const extrasBox=document.getElementById('extras');
      if(extrasBox){
        const extrasHandler=()=>{
          updateParticipantConflictHint();
          buildApprovalPlanPreview();
        };
        extrasBox.addEventListener('input', extrasHandler);
        extrasBox.addEventListener('change', extrasHandler);
      }
      updateParticipantConflictHint();

      // 偕同訪視者：初次建立一筆空白行以利輸入（選配）
      // addExtraRow();

      // 其它原有初始化
      renderS2(); syncDisab();
      renderS3(); toggleOtherType(); toggleRentFields();
      const goalFields=['short_care','short_prof','short_car','short_resp','short_access','short_meal','mid_care','mid_prof','mid_car','mid_resp','mid_access','mid_meal'];
      goalFields.forEach(id=>{
        bindAutoGoalField(id);
        const el=document.getElementById(id);
        if(el){ el.addEventListener('input', ()=>{ buildLongGoal(); }); }
      });
      bindAutoGoalField('long_goal');
      document.getElementById('long_goal')?.addEventListener('input', buildGoalPreview);
      renderFormal();
      renderHomeCareServices();
      renderDayCareServices();
      renderProfessionalServices();
      renderTransportServices();
      renderRespiteServices();
      renderMealServices();
      initPlanMetaFields();
      initMismatchReasonControls();
      planMetaState.referralExtra = document.getElementById('plan_referral_extra')?.value || '';
      planMetaState.stationInfo = document.getElementById('plan_station_info')?.value || '';
      planMetaState.stationWillingness = document.getElementById('plan_station_willingness')?.value || '';
      planMetaState.emergencyNote = document.getElementById('plan_emergency_note')?.value || '';
      planMetaState.foreignCare = hasForeignCareFlag();
      syncPlanStateWithSelections();
      buildApprovalPlanPreview();
      renderProblems(); limitProblems();
      updateCareServicePhrases();
      updateProfessionalServicePhrases();
      updateTransportServicePhrases();
      updateRespiteServicePhrases();
      updateMealServicePhrases();
      // 非正式資源：名稱→頻率 顯示/隱藏
      bindInfNameToFreq('pt');
      bindInfNameToFreq('nb');
      bindInfNameToFreq('rg');
      bindInfNameToFreq('fw');

      bindQuickReasons();

      // 主照者關係/姓名：自動連動到(四)唯讀展示
      syncSocialPrimary();
      const primaryRelField=document.getElementById('primaryRel');
      if(primaryRelField){
        primaryRelField.addEventListener('change', ()=>{
          syncSocialPrimary();
          updateParticipantConflictHint();
          buildApprovalPlanPreview();
          scheduleSummaryUpdate();
        });
      }
      const primaryNameField=document.getElementById('primaryName');
      if(primaryNameField){
        primaryNameField.addEventListener('input', ()=>{
          syncSocialPrimary();
          buildApprovalPlanPreview();
          scheduleSummaryUpdate();
        });
      }
      const caseNameInput=document.getElementById('caseName');
      if(caseNameInput){
        caseNameInput.addEventListener('input', ()=>{ updateBasicInfoCompletion(); });
        caseNameInput.addEventListener('input', syncSocialPrimary);
        caseNameInput.addEventListener('input', updateConsultVisitText);
        caseNameInput.addEventListener('input', buildApprovalPlanPreview);
        caseNameInput.addEventListener('input', scheduleSummaryUpdate);
      }
      const consultSelect=document.getElementById('consultName');
      if(consultSelect){
        consultSelect.addEventListener('change', updateConsultVisitText);
        consultSelect.addEventListener('change', scheduleSummaryUpdate);
        consultSelect.addEventListener('change', ()=>{ updateBasicInfoCompletion(); });
      }
      document.getElementById('s1_gender')?.addEventListener('change', buildApprovalPlanPreview);
      const caseManagerSelect=document.getElementById('caseManagerName');
      if(caseManagerSelect){
        caseManagerSelect.addEventListener('change', buildApprovalPlanPreview);
        caseManagerSelect.addEventListener('change', scheduleSummaryUpdate);
        caseManagerSelect.addEventListener('change', ()=>{ updateBasicInfoCompletion(); });
      }

      toggleCallDateByConsultVisit();
      updateConsultVisitText();
      buildApprovalPlanPreview();

      applyInitialUiPreferences();

      initAutoSave();

      applyEllipsisTooltips();

      scheduleAllMeasurements();

      reportUiAudit();

    }

    window.addEventListener('load', initializeSidebarOnLoad);
  </script>
</body>
</html>
