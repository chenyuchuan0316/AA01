<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AA01 計畫助手</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <style>
    :root {
      --bg:#f8fafc;
      --card:#ffffff;
      --border:#d0d7e2;
      --border-strong:#94a3b8;
      --text:#0f172a;
      --muted:#475569;
      --primary:#0b57d0;
      --primary-soft:rgba(11,87,208,.1);
      --danger:#b91c1c;
      --warning:#c05621;
      --success:#047857;
      --toast-bg:#0b1220;
      --toast-text:#f9fafb;
      --space-1:4px;
      --space-2:8px;
      --space-3:12px;
      --space-4:16px;
      --space-6:24px;
      --space-8:32px;
      --radius:12px;
      --shadow:0 8px 24px rgba(15,23,42,.12);
      --font-base:18px;
      --font-large:20px;
      --font-xlarge:22px;
      --nav-width:280px;
    }

    html { font-size:var(--font-base); }
    @media (min-width:1600px){ html{ font-size:var(--font-large); } }
    @media (max-width:600px){ html{ font-size:clamp(17px, 4.5vw, 21px); } }

    body {
      margin:0;
      padding:var(--space-3);
      background:var(--bg);
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif;
      color:var(--text);
      line-height:1.55;
    }

    .app {
      display:flex;
      flex-direction:column;
      gap:var(--space-3);
      max-width: min(1200px, 96vw);
      margin:0 auto;
      min-height:calc(100vh - var(--space-6));
    }

    .app-header {
      background:var(--card);
      border-radius:var(--radius);
      padding:var(--space-4);
      box-shadow:var(--shadow);
      position:sticky;
      top:var(--space-3);
      z-index:10;
    }

    .app-title {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:var(--space-3);
    }

    .app-title h1 {
      margin:0;
      font-size:1.35rem;
      letter-spacing:.02em;
    }

    .wizard {
      margin-top:var(--space-3);
      display:flex;
      gap:var(--space-2);
      flex-wrap:wrap;
    }

    .wizard button {
      border:none;
      padding:var(--space-2) var(--space-4);
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
    }

    .wizard button[aria-current="step"] {
      background:var(--primary);
      color:#fff;
    }

    .app-main {
      display:flex;
      gap:var(--space-3);
    }

    .side-nav {
      width:var(--nav-width);
      flex:0 0 var(--nav-width);
      background:var(--card);
      border-radius:var(--radius);
      padding:var(--space-4);
      box-shadow:var(--shadow);
      max-height:calc(100vh - 180px);
      overflow:auto;
      position:sticky;
      top:calc(var(--space-3) + 120px);
    }

    .side-nav h2 {
      margin:0 0 var(--space-2);
      font-size:1.05rem;
      color:var(--muted);
    }

    .side-nav ul {
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:var(--space-1);
    }

    .side-nav button {
      width:100%;
      text-align:left;
      border:none;
      background:none;
      padding:var(--space-2);
      border-radius:var(--space-2);
      cursor:pointer;
      color:var(--text);
    }

    .side-nav button[aria-current="true"] {
      background:var(--primary-soft);
      color:var(--primary);
    }

    .page {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:var(--space-3);
    }

    .page-section {
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--space-4);
      display:flex;
      flex-direction:column;
      gap:var(--space-4);
    }

    .section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      padding-bottom:var(--space-2);
    }

    .section-header h2 {
      margin:0;
      font-size:1.2rem;
    }

    fieldset {
      border:1px solid var(--border);
      border-radius:var(--space-2);
      padding:var(--space-3);
      display:flex;
      flex-direction:column;
      gap:var(--space-2);
    }

    legend {
      padding:0 var(--space-1);
      font-weight:600;
      color:var(--muted);
    }

    label {
      display:flex;
      flex-direction:column;
      gap:var(--space-1);
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      font-size:1rem;
      padding:var(--space-2);
      border-radius:var(--space-2);
      border:1px solid var(--border-strong);
      background:#fff;
      min-height:48px;
    }

    textarea { min-height:120px; resize:vertical; }

    .grid-2 {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:var(--space-3);
    }

    .inline {
      display:flex;
      gap:var(--space-2);
      align-items:center;
    }

    .checkbox-group {
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-2);
    }

    .checkbox-pill {
      border:1px solid var(--border-strong);
      border-radius:999px;
      padding:var(--space-1) var(--space-3);
      display:flex;
      align-items:center;
      gap:var(--space-1);
    }

    .table {
      border-collapse:collapse;
      width:100%;
    }

    .table th,
    .table td {
      border:1px solid var(--border);
      padding:var(--space-2);
      text-align:left;
    }

    .actions {
      display:flex;
      justify-content:flex-end;
      gap:var(--space-2);
      position:sticky;
      bottom:var(--space-2);
      margin-top:auto;
    }

    button.primary {
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:var(--space-2);
      padding:var(--space-2) var(--space-4);
      cursor:pointer;
      font-weight:600;
    }

    button.secondary {
      background:none;
      color:var(--primary);
      border:1px solid var(--primary);
      border-radius:var(--space-2);
      padding:var(--space-2) var(--space-4);
      cursor:pointer;
      font-weight:600;
    }

    .status-bar {
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-2);
      color:var(--muted);
      font-size:.95rem;
      margin-top:var(--space-2);
    }

    .toast {
      position:fixed;
      right:var(--space-4);
      bottom:var(--space-4);
      background:var(--toast-bg);
      color:var(--toast-text);
      padding:var(--space-3) var(--space-4);
      border-radius:var(--space-2);
      box-shadow:var(--shadow);
      display:none;
      flex-direction:column;
      gap:var(--space-2);
      max-width:360px;
      z-index:999;
    }

    .toast[aria-hidden="false"] { display:flex; }

    .error-summary {
      border:1px solid var(--danger);
      border-radius:var(--space-2);
      background:rgba(185,28,28,.05);
      color:var(--danger);
      padding:var(--space-3);
      display:none;
      flex-direction:column;
      gap:var(--space-2);
    }

    .error-summary[data-visible="true"] { display:flex; }

    .error-summary ul {
      margin:0;
      padding-left:var(--space-6);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:var(--space-1);
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary);
      padding:var(--space-1) var(--space-2);
      font-size:.85rem;
    }

    .plan-services tbody tr:nth-child(odd) { background:rgba(148,163,184,.08); }

    .link-button {
      background:none;
      border:none;
      color:var(--primary);
      cursor:pointer;
      padding:0;
      font-size:1rem;
    }

    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .chips {
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-2);
    }

    .chip {
      background:var(--primary-soft);
      color:var(--primary);
      border-radius:999px;
      padding:var(--space-1) var(--space-3);
      font-size:.9rem;
    }

    @media (max-width:1024px){
      .app-main { flex-direction:column; }
      .side-nav { position:static; width:100%; flex:auto; max-height:none; }
    }

    @media (max-width:720px){
      body{ padding:var(--space-2); }
      .app-header { position:static; }
      .wizard { overflow:auto; }
      .actions { position:static; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="app-header" id="appHeader">
      <div class="app-title">
        <h1>AA01 長照計畫助手</h1>
        <div class="status-bar" id="statusBar" aria-live="polite"></div>
      </div>
      <nav class="wizard" id="wizardNav" aria-label="章節導覽"></nav>
    </header>
    <div class="app-main">
      <aside class="side-nav" id="sideNav" aria-label="節點導覽"></aside>
      <main class="page" id="formRoot" tabindex="-1">
        <section class="page-section" data-page="basic" id="page-basic" aria-labelledby="heading-basic">
          <div class="section-header">
            <h2 id="heading-basic">基本資訊</h2>
            <span class="badge" id="basicProgress">0/5 完成</span>
          </div>
          <div class="grid-2">
            <label data-field="unitCode">
              <span>單位代碼 *</span>
              <input type="text" data-bind="basic.unitCode" data-field-id="basic.unitCode" required />
            </label>
            <label data-field="caseManagerName">
              <span>個案管理師 *</span>
              <input type="text" data-bind="basic.caseManagerName" data-field-id="basic.caseManagerName" required />
            </label>
            <label data-field="caseName">
              <span>個案姓名 *</span>
              <input type="text" data-bind="basic.caseName" data-field-id="basic.caseName" required />
            </label>
            <label data-field="consultName">
              <span>照顧專員姓名</span>
              <input type="text" data-bind="basic.consultName" data-field-id="basic.consultName" />
            </label>
            <label data-field="cmsLevel">
              <span>CMS 等級 *</span>
              <select data-bind="basic.cmsLevel" data-field-id="basic.cmsLevel" required>
                <option value="">請選擇</option>
                <option value="1">1 級</option>
                <option value="2">2 級</option>
                <option value="3">3 級</option>
                <option value="4">4 級</option>
                <option value="5">5 級</option>
              </select>
            </label>
          </div>
        </section>

        <section class="page-section" data-page="goals" id="page-contact" aria-labelledby="heading-contact">
          <div class="section-header">
            <h2 id="heading-contact">聯絡與家訪資訊</h2>
            <span class="badge" id="contactProgress">0/3 完成</span>
          </div>
          <div class="grid-2">
            <label data-field="callDate">
              <span>電聯日期 *</span>
              <input type="date" data-bind="contact.callDate" data-field-id="contact.callDate" required />
            </label>
            <label data-field="visitDate">
              <span>家訪日期 *</span>
              <input type="date" data-bind="contact.visitDate" data-field-id="contact.visitDate" required />
            </label>
            <label data-field="dischargeDate">
              <span>出院日期</span>
              <input type="date" data-bind="contact.dischargeDate" data-field-id="contact.dischargeDate" />
            </label>
            <label class="inline" for="isConsultVisit">
              <input type="checkbox" id="isConsultVisit" data-bind="contact.isConsultVisit" data-type="boolean" data-field-id="contact.isConsultVisit" />
              <span>本次由照顧專員約訪</span>
            </label>
          </div>
        </section>

        <section class="page-section" data-page="goals" id="page-participants" aria-labelledby="heading-participants">
          <div class="section-header">
            <h2 id="heading-participants">偕同訪視者</h2>
            <span class="badge" id="participantProgress">0/2 完成</span>
          </div>
          <fieldset>
            <legend>主要參與者</legend>
            <div class="grid-2">
              <label>
                <span>關係 *</span>
                <input type="text" data-bind="participants.primary.rel" data-field-id="participants.primary.rel" required />
              </label>
              <label>
                <span>姓名 *</span>
                <input type="text" data-bind="participants.primary.name" data-field-id="participants.primary.name" required />
              </label>
            </div>
          </fieldset>
          <fieldset id="extraParticipants" data-collection="participants.extras">
            <legend>其他參與者</legend>
            <div class="chips" id="extraParticipantsList" aria-live="polite"></div>
            <div class="grid-2">
              <label>
                <span>關係</span>
                <input type="text" id="extraRel" />
              </label>
              <label>
                <span>姓名</span>
                <input type="text" id="extraName" />
              </label>
            </div>
            <button type="button" class="secondary" id="addExtraParticipant">加入參與者</button>
          </fieldset>
        </section>

        <section class="page-section" data-page="goals" id="page-overview" aria-labelledby="heading-overview">
          <div class="section-header">
            <h2 id="heading-overview">個案概況</h2>
            <span class="badge" id="overviewProgress">6 區域</span>
          </div>
          <fieldset>
            <legend>（一）身心概況</legend>
            <textarea data-bind="overview.section1.summary" data-field-id="overview.section1.summary" placeholder="請描述身心狀況、既往病史、ADL。"></textarea>
            <div class="grid-2">
              <label>
                <span>夜間排尿情況</span>
                <select data-bind="overview.section1.urineNight" data-field-id="overview.section1.urineNight">
                  <option value="">請選擇</option>
                  <option value="夜間未起夜">夜間未起夜</option>
                  <option value="偶爾起夜">偶爾起夜</option>
                  <option value="常起夜">常起夜</option>
                </select>
              </label>
              <label>
                <span>夜尿次數（次/夜）</span>
                <input type="number" min="0" step="1" data-bind="overview.section1.nocturiaCount" data-field-id="overview.section1.nocturiaCount" />
              </label>
            </div>
            <div>
              <span>排泄輔具</span>
              <div class="checkbox-group" role="group" aria-labelledby="excretionAidsLabel" id="s1_excretion_aids_box">
                <span id="excretionAidsLabel" class="sr-only">排泄輔具</span>
                <label class="checkbox-pill"><input type="checkbox" value="尿布" data-bind="overview.section1.excretionAids" data-collect="array" data-field-id="overview.section1.excretionAids.尿布" />尿布</label>
                <label class="checkbox-pill"><input type="checkbox" value="便盆椅" data-bind="overview.section1.excretionAids" data-collect="array" data-field-id="overview.section1.excretionAids.便盆椅" />便盆椅</label>
                <label class="checkbox-pill"><input type="checkbox" value="夜間集尿袋" data-bind="overview.section1.excretionAids" data-collect="array" data-field-id="overview.section1.excretionAids.夜間集尿袋" />夜間集尿袋</label>
              </div>
            </div>
            <div class="grid-2">
              <label>
                <span>吞嚥狀態</span>
                <select data-bind="overview.section1.swallow" data-field-id="overview.section1.swallow">
                  <option value="">請選擇</option>
                  <option value="無困難">無困難</option>
                  <option value="輕微困難">輕微困難</option>
                  <option value="明顯困難">明顯困難</option>
                  <option value="危險（需專評）">危險（需專評）</option>
                </select>
              </label>
              <label>
                <span>飲食質地</span>
                <select multiple data-bind="overview.section1.dietTexture" data-collect="array" data-field-id="overview.section1.dietTexture">
                  <option value="一般">一般</option>
                  <option value="軟質">軟質</option>
                  <option value="泥狀">泥狀</option>
                  <option value="流質">流質</option>
                </select>
              </label>
            </div>
            <div class="grid-2">
              <label>
                <span>管灌方式</span>
                <select multiple data-bind="overview.section1.feedingTubes" data-collect="array" data-field-id="overview.section1.feedingTubes">
                  <option value="鼻胃管">鼻胃管</option>
                  <option value="胃造口">胃造口</option>
                  <option value="靜脈營養">靜脈營養</option>
                </select>
              </label>
              <label>
                <span>起身移位能力</span>
                <select data-bind="overview.section1.transfer" data-field-id="overview.section1.transfer">
                  <option value="">請選擇</option>
                  <option value="獨立">獨立</option>
                  <option value="部分協助">部分協助</option>
                  <option value="重度協助">重度協助</option>
                  <option value="完全依賴">完全依賴</option>
                </select>
              </label>
            </div>
            <label>
              <span>室內行走</span>
              <select data-bind="overview.section1.walkIndoor" data-field-id="overview.section1.walkIndoor">
                <option value="">請選擇</option>
                <option value="可獨立行走">可獨立行走</option>
                <option value="無輔具緩慢">無輔具緩慢</option>
                <option value="單拐">單拐</option>
                <option value="四腳拐">四腳拐</option>
                <option value="輪椅">輪椅</option>
              </select>
            </label>
          </fieldset>
          <fieldset>
            <legend>（二）經濟收入</legend>
            <textarea data-bind="overview.section2.summary" data-field-id="overview.section2.summary" placeholder="家庭成員、主要收入來源、支出負擔。"></textarea>
          </fieldset>
          <fieldset>
            <legend>（三）居住環境</legend>
            <textarea data-bind="overview.section3.summary" data-field-id="overview.section3.summary" placeholder="居住型態、環境安全、無障礙設備。"></textarea>
          </fieldset>
          <fieldset>
            <legend>（四）社會支持</legend>
            <textarea data-bind="overview.section4.summary" data-field-id="overview.section4.summary" placeholder="正式與非正式支持體系。"></textarea>
          </fieldset>
          <fieldset>
            <legend>（五）其他</legend>
            <textarea data-bind="overview.section5.summary" data-field-id="overview.section5.summary" placeholder="其他補充事項。"></textarea>
          </fieldset>
          <fieldset>
            <legend>（六）複評評值</legend>
            <div class="grid-2">
              <label>
                <span>介入前評估</span>
                <textarea data-bind="overview.section6.before" data-field-id="overview.section6.before"></textarea>
              </label>
              <label>
                <span>介入後評估</span>
                <textarea data-bind="overview.section6.after" data-field-id="overview.section6.after"></textarea>
              </label>
            </div>
          </fieldset>
        </section>
        <section class="page-section" data-page="goals" id="page-goals" aria-labelledby="heading-goals">
          <div class="section-header">
            <h2 id="heading-goals">照顧目標</h2>
            <span class="badge" id="goalProgress">0 項完成</span>
          </div>
          <fieldset>
            <legend>（一）照顧問題</legend>
            <div class="checkbox-group" id="problemChecklist">
              <label class="checkbox-pill"><input type="checkbox" value="mobility" data-collect="problems" />行動受限</label>
              <label class="checkbox-pill"><input type="checkbox" value="nutrition" data-collect="problems" />營養不良</label>
              <label class="checkbox-pill"><input type="checkbox" value="cognition" data-collect="problems" />認知障礙</label>
              <label class="checkbox-pill"><input type="checkbox" value="caregiver" data-collect="problems" />照顧者負荷</label>
              <label class="checkbox-pill"><input type="checkbox" value="others" data-collect="problems" />其他</label>
            </div>
          </fieldset>
          <fieldset>
            <legend>（二）短期目標（0–3 個月）</legend>
            <textarea data-bind="goals.short.summary" data-field-id="goals.short.summary"></textarea>
          </fieldset>
          <fieldset>
            <legend>（三）中期目標（3–4 個月）</legend>
            <textarea data-bind="goals.mid.summary" data-field-id="goals.mid.summary"></textarea>
          </fieldset>
          <fieldset>
            <legend>（四）長期目標（4–6 個月）</legend>
            <textarea data-bind="goals.long.summary" data-field-id="goals.long.summary"></textarea>
          </fieldset>
          <fieldset>
            <legend>預覽摘要（列印前檢閱）</legend>
            <textarea data-bind="goals.previewText" data-field-id="goals.previewText"></textarea>
          </fieldset>
        </section>

        <section class="page-section" data-page="execution" id="page-plan" aria-labelledby="heading-plan">
          <div class="section-header">
            <h2 id="heading-plan">計畫執行規劃</h2>
            <span class="badge" id="planProgress">服務項目</span>
          </div>
          <fieldset id="serviceList" data-collection="plan.services">
            <legend>長照服務核定項目、頻率</legend>
            <table class="table plan-services" aria-describedby="serviceListDesc">
              <caption id="serviceListDesc">請填寫服務代碼、提供者、頻率、單次量與部分負擔。</caption>
              <thead>
                <tr>
                  <th scope="col">代碼</th>
                  <th scope="col">提供者</th>
                  <th scope="col">頻率</th>
                  <th scope="col">單次量</th>
                  <th scope="col">部分負擔</th>
                  <th scope="col">操作</th>
                </tr>
              </thead>
              <tbody id="serviceTable"></tbody>
            </table>
            <button type="button" class="secondary" id="addService">新增服務</button>
          </fieldset>
          <fieldset>
            <legend>轉介其他服務資源</legend>
            <textarea data-bind="plan.referral.summary" data-field-id="plan.referral.summary"></textarea>
          </fieldset>
          <fieldset>
            <legend>緊急救援服務說明</legend>
            <textarea data-bind="plan.emergencyNote" data-field-id="plan.emergencyNote"></textarea>
          </fieldset>
        </section>

        <section class="page-section" data-page="notes" id="page-notes" aria-labelledby="heading-notes">
          <div class="section-header">
            <h2 id="heading-notes">其他備註</h2>
            <span class="badge" id="noteProgress">備註</span>
          </div>
          <textarea data-bind="notes.other" data-field-id="notes.other" placeholder="補充個案特殊狀況或後續追蹤事項。"></textarea>
        </section>

        <div class="error-summary" id="errorSummary" role="alert" aria-live="assertive"></div>
        <div class="actions">
          <button type="button" class="secondary" id="saveDraft">儲存草稿 (Ctrl+S)</button>
          <button type="button" class="primary" id="submitPlan">送出計畫</button>
        </div>
      </main>
    </div>
  </div>

  <div class="toast" id="toast" aria-hidden="true" role="status">
    <strong id="toastMessage">完成</strong>
    <div id="toastAction"></div>
  </div>

  <template id="serviceRowTemplate">
    <tr>
      <td><input type="text" data-name="code" aria-label="服務代碼" /></td>
      <td><input type="text" data-name="provider" aria-label="提供者" /></td>
      <td><input type="text" data-name="freq" aria-label="頻率" /></td>
      <td><input type="text" data-name="qty" aria-label="單次量" /></td>
      <td><input type="text" data-name="copay" aria-label="部分負擔" /></td>
      <td><button type="button" class="link-button" data-action="remove">移除</button></td>
    </tr>
  </template>

  <template id="extraParticipantTemplate">
    <span class="chip" data-index="0">
      <button type="button" class="link-button" data-action="jump"></button>
      <button type="button" class="link-button" data-action="remove" aria-label="移除參與者">✕</button>
    </span>
  </template>

  <script>
    (function(window, document){
      'use strict';

      var AA01 = window.AA01 = window.AA01 || {};

      AA01.HEADINGS = Object.freeze([
        {
          id:'h1-basic', tag:'h1', label:'基本資訊', page:'basic',
          children:[
            { id:'h2-basic-unit-code', tag:'h2', label:'單位代碼', field:'basic.unitCode' },
            { id:'h2-basic-case-manager', tag:'h2', label:'個案管理師', field:'basic.caseManagerName' },
            { id:'h2-basic-case-name', tag:'h2', label:'個案姓名', field:'basic.caseName' },
            { id:'h2-basic-consultant-name', tag:'h2', label:'照專姓名', field:'basic.consultName' },
            { id:'h2-basic-cms-level', tag:'h2', label:'CMS 等級', field:'basic.cmsLevel' }
          ]
        },
        {
          id:'h1-goals', tag:'h1', label:'計畫目標', page:'goals',
          children:[
            {
              id:'h2-goals-call', tag:'h2', label:'一、電聯日期',
              children:[
                { id:'h3-goals-call-date', tag:'h3', label:'電聯日期', field:'contact.callDate' },
                { id:'h3-goals-call-consult', tag:'h3', label:'照顧專員約訪', field:'contact.isConsultVisit' }
              ]
            },
            {
              id:'h2-goals-homevisit', tag:'h2', label:'二、家訪日期',
              children:[
                { id:'h3-goals-homevisit-date', tag:'h3', label:'家訪日期', field:'contact.visitDate' },
                { id:'h3-goals-prep-date', tag:'h3', label:'出院日期', field:'contact.dischargeDate' }
              ]
            },
            {
              id:'h2-goals-companions', tag:'h2', label:'三、偕同訪視者',
              children:[
                { id:'h3-goals-primary-rel', tag:'h3', label:'主要照顧者關係', field:'participants.primary.rel' },
                { id:'h3-goals-primary-name', tag:'h3', label:'主要照顧者姓名', field:'participants.primary.name' }
              ]
            },
            {
              id:'h2-goals-overview', tag:'h2', label:'四、個案概況',
              children:[
                { id:'h3-goals-s1', tag:'h3', label:'（一）身心概況', field:'overview.section1.summary' },
                { id:'h3-goals-s2', tag:'h3', label:'（二）經濟收入', field:'overview.section2.summary' },
                { id:'h3-goals-s3', tag:'h3', label:'（三）居住環境', field:'overview.section3.summary' },
                { id:'h3-goals-s4', tag:'h3', label:'（四）社會支持', field:'overview.section4.summary' },
                { id:'h3-goals-s5', tag:'h3', label:'（五）其他', field:'overview.section5.summary' },
                { id:'h3-goals-s6', tag:'h3', label:'（六）複評評值', field:'overview.section6.after' }
              ]
            },
            {
              id:'h2-goals-targets', tag:'h2', label:'五、照顧目標',
              children:[
                { id:'h3-goals-targets-problems', tag:'h3', label:'（一）照顧問題', field:'goals.problems' },
                { id:'h3-goals-targets-short', tag:'h3', label:'（二）短期目標（0–3 個月）', field:'goals.short.summary' },
                { id:'h3-goals-targets-mid', tag:'h3', label:'（三）中期目標（3–4 個月）', field:'goals.mid.summary' },
                { id:'h3-goals-targets-long', tag:'h3', label:'（四）長期目標（4–6 個月）', field:'goals.long.summary' }
              ]
            },
            {
              id:'h2-goals-mismatch', tag:'h2', label:'六、與照專建議服務項目、問題清單不一致原因說明及未來規劃、後續追蹤計劃',
              children:[
                { id:'h3-goals-mismatch-1', tag:'h3', label:'（一）目標達成的狀況以及未達成的差距', field:'goals.previewText' },
                { id:'h3-goals-mismatch-2', tag:'h3', label:'（二）資源的變動情形', field:'plan.referral.summary' },
                { id:'h3-goals-mismatch-3', tag:'h3', label:'（三）未使用的替代方案或是可能的影響', field:'plan.emergencyNote' }
              ]
            }
          ]
        },
        {
          id:'h1-exec', tag:'h1', label:'計畫執行規劃', page:'execution',
          children:[
            { id:'h2-exec-services', tag:'h2', label:'一、長照服務核定項目、頻率', field:'plan.services' },
            { id:'h2-exec-referral', tag:'h2', label:'二、轉介其他服務資源', field:'plan.referral.summary' },
            { id:'h2-exec-emergency-note', tag:'h2', label:'四、緊急救援服務說明', field:'plan.emergencyNote' }
          ]
        },
        {
          id:'h1-notes', tag:'h1', label:'其他備註', page:'notes',
          children:[
            { id:'h2-notes-other', tag:'h2', label:'其他（個案特殊狀況或其他未盡事宜可備註於此）', field:'notes.other' }
          ]
        }
      ]);

      AA01.HEADING_INDEX = (function(){
        var map = {};
        function walk(list){
          if(!Array.isArray(list)) return;
          list.forEach(function(node){
            if(!node || !node.id) return;
            map[node.id] = node;
            if(Array.isArray(node.children) && node.children.length){
              walk(node.children);
            }
          });
        }
        walk(AA01.HEADINGS);
        return map;
      })();

      AA01.batchFrame = (function(){
        var queued = {};
        return function frame(key, fn){
          if(!key) key = 'default';
          if(queued[key]) return;
          queued[key] = true;
          window.requestAnimationFrame(function(){
            queued[key] = false;
            try { fn(); } catch(err){ console.error(err); }
          });
        };
      })();

      AA01.persist = {
        save:function(data){
          if(!window.localStorage) return;
          try{
            window.localStorage.setItem('AA01.draft', JSON.stringify({ v:1, t:Date.now(), data:data }));
          }catch(err){ console.warn('儲存草稿失敗', err); }
        },
        load:function(){
          if(!window.localStorage) return null;
          try{
            var raw = window.localStorage.getItem('AA01.draft');
            if(!raw) return null;
            var parsed = JSON.parse(raw);
            return parsed && parsed.data ? parsed.data : null;
          }catch(err){ return null; }
        },
        clear:function(){
          if(!window.localStorage) return;
          try{ window.localStorage.removeItem('AA01.draft'); }catch(err){}
        }
      };

      AA01.store = {
        initialized:false,
        data:null,
        validation:null,
        lastSaved:null,
        fields:{},
        currentPage:'basic'
      };

      function setDeepValue(target, path, value){
        if(!target) return;
        var segments = path.split('.');
        var node = target;
        for(var i=0; i<segments.length; i++){
          var key = segments[i];
          if(i === segments.length - 1){
            node[key] = value;
          }else{
            if(typeof node[key] !== 'object' || node[key] === null){
              node[key] = {};
            }
            node = node[key];
          }
        }
      }

      function getDeepValue(source, path){
        if(!source) return undefined;
        var segments = path.split('.');
        var node = source;
        for(var i=0; i<segments.length; i++){
          if(node === null || typeof node === 'undefined') return undefined;
          node = node[segments[i]];
        }
        return node;
      }

      function parseArrayValue(input){
        if(input instanceof HTMLSelectElement && input.multiple){
          return Array.from(input.options).filter(function(option){ return option.selected; }).map(function(option){ return option.value; });
        }
        if(input.type === 'checkbox'){ return input.checked ? input.value : null; }
        return String(input.value || '').trim();
      }

      AA01.collect = function collect(root){
        var result = {
          basic:{ unitCode:'', caseManagerName:'', caseName:'', consultName:'', cmsLevel:'' },
          contact:{ callDate:'', visitDate:'', dischargeDate:'', isConsultVisit:false },
          participants:{ primary:{ rel:'', name:'' }, extras:[] },
          overview:{
            section1:{ summary:'', urineNight:'', nocturiaCount:null, excretionAids:[], swallow:'', dietTexture:[], feedingTubes:[], transfer:'', walkIndoor:'' },
            section2:{ summary:'' },
            section3:{ summary:'' },
            section4:{ summary:'' },
            section5:{ summary:'' },
            section6:{ before:'', after:'' }
          },
          goals:{
            problems:[],
            short:{ summary:'' },
            mid:{ summary:'' },
            long:{ summary:'' },
            previewText:''
          },
          plan:{
            services:[],
            referral:{ summary:'' },
            emergencyNote:''
          },
          notes:{ other:'' },
          meta:{ lastSaved:AA01.store.lastSaved || null, version:'v1' }
        };

        if(!root) return result;

        var arrayBuffers = {};

        var inputs = root.querySelectorAll('[data-bind]');
        inputs.forEach(function(input){
          var path = input.getAttribute('data-bind');
          if(!path) return;
          if(input.dataset.collect === 'array'){
            var value = parseArrayValue(input);
            if(value === null || value === '') return;
            if(!arrayBuffers[path]) arrayBuffers[path] = [];
            arrayBuffers[path].push(value);
            return;
          }
          var type = input.dataset.type || input.type;
          var rawValue;
          if(type === 'checkbox'){
            rawValue = input.checked;
          }else if(type === 'boolean'){
            rawValue = !!input.checked;
          }else if(type === 'number'){
            var val = input.value;
            rawValue = val === '' ? null : Number(val);
          }else{
            rawValue = input.value || '';
          }
          if(type === 'date' || input.type === 'date'){
            rawValue = input.value || '';
          }
          setDeepValue(result, path, rawValue);
        });

        Object.keys(arrayBuffers).forEach(function(path){
          setDeepValue(result, path, arrayBuffers[path]);
        });

        var extrasContainer = document.getElementById('extraParticipantsList');
        if(extrasContainer){
          var chips = extrasContainer.querySelectorAll('[data-index]');
          chips.forEach(function(chip){
            var rel = chip.getAttribute('data-rel') || '';
            var name = chip.getAttribute('data-name') || '';
            if(rel || name){
              result.participants.extras.push({ rel:rel, name:name });
            }
          });
        }

        var serviceRows = document.querySelectorAll('#serviceTable tr');
        serviceRows.forEach(function(row){
          var entry = {
            code:row.querySelector('[data-name="code"]').value.trim(),
            provider:row.querySelector('[data-name="provider"]').value.trim(),
            freq:row.querySelector('[data-name="freq"]').value.trim(),
            qty:row.querySelector('[data-name="qty"]').value.trim(),
            copay:row.querySelector('[data-name="copay"]').value.trim()
          };
          if(entry.code || entry.provider || entry.freq || entry.qty || entry.copay){
            result.plan.services.push(entry);
          }
        });

        var problems = [];
        var problemCheckboxes = document.querySelectorAll('#problemChecklist input[type="checkbox"][data-collect="problems"]');
        problemCheckboxes.forEach(function(box){ if(box.checked) problems.push(box.value); });
        result.goals.problems = problems;

        if(Array.isArray(result.overview.section1.dietTexture)){
          result.overview.section1.dietTexture = result.overview.section1.dietTexture.filter(Boolean);
        }

        var nocturia = result.overview.section1.nocturiaCount;
        if(nocturia !== null && nocturia !== '' && !isNaN(nocturia)){
          result.overview.section1.nocturiaCount = Number(nocturia);
        }else{
          result.overview.section1.nocturiaCount = nocturia === 0 ? 0 : null;
        }

        return result;
      };
      AA01.validators = {
        required:[
          { field:'basic.unitCode', message:'請填寫單位代碼。', group:'h2-basic-unit-code' },
          { field:'basic.caseManagerName', message:'請填寫個案管理師。', group:'h2-basic-case-manager' },
          { field:'basic.caseName', message:'請填寫個案姓名。', group:'h2-basic-case-name' },
          { field:'basic.cmsLevel', message:'請選擇 CMS 等級。', group:'h2-basic-cms-level' },
          { field:'contact.callDate', message:'請填寫電聯日期。', group:'h2-goals-call' },
          { field:'contact.visitDate', message:'請填寫家訪日期。', group:'h2-goals-homevisit' },
          { field:'participants.primary.rel', message:'請填寫主要參與者關係。', group:'h2-goals-companions' },
          { field:'participants.primary.name', message:'請填寫主要參與者姓名。', group:'h2-goals-companions' }
        ]
      };

      AA01.validate = function validate(data){
        var errors = [];
        if(!data) data = AA01.store.data || {};
        AA01.validators.required.forEach(function(rule){
          var value = getDeepValue(data, rule.field);
          if(value === null || value === undefined || value === ''){
            errors.push({ fieldId:rule.field, msg:rule.message, groupId:rule.group });
          }
        });

        var s1 = (data && data.overview && data.overview.section1) || {};
        if(Array.isArray(s1.excretionAids) && s1.excretionAids.indexOf('夜間集尿袋') > -1){
          if(s1.nocturiaCount !== null && s1.nocturiaCount !== '' && Number(s1.nocturiaCount) > 0){
            errors.push({ fieldId:'overview.section1.nocturiaCount', msg:'已使用夜間集尿袋時，夜尿次數應為 0。', groupId:'h3-goals-s1' });
          }
          if((s1.urineNight || '') !== ''){
            errors.push({ fieldId:'overview.section1.urineNight', msg:'已使用夜間集尿袋，夜間排尿欄位請留空。', groupId:'h3-goals-s1' });
          }
        }

        if(typeof s1.nocturiaCount === 'number' && s1.nocturiaCount > 0 && (s1.urineNight || '') === '夜間未起夜'){
          errors.push({ fieldId:'overview.section1.urineNight', msg:'夜尿次數大於 0 時，夜間排尿不可為「夜間未起夜」。', groupId:'h3-goals-s1' });
        }

        if(['明顯困難', '危險（需專評）'].indexOf(s1.swallow || '') > -1 && Array.isArray(s1.dietTexture) && s1.dietTexture.indexOf('一般') > -1){
          errors.push({ fieldId:'overview.section1.dietTexture', msg:'吞嚥困難時，不可選擇「一般」飲食質地。', groupId:'h3-goals-s1' });
        }

        if((s1.swallow || '') === '無困難' && Array.isArray(s1.feedingTubes) && s1.feedingTubes.length){
          errors.push({ fieldId:'overview.section1.feedingTubes', msg:'吞嚥無困難者請確認是否仍需管灌方式。', groupId:'h3-goals-s1' });
        }

        if(['重度協助','完全依賴'].indexOf(s1.transfer || '') > -1){
          var walk = s1.walkIndoor || '';
          if(['可獨立行走','無輔具緩慢','單拐','四腳拐'].indexOf(walk) > -1){
            errors.push({ fieldId:'overview.section1.walkIndoor', msg:'起身移位需重度協助時，室內行走不應為可獨立行走狀態。', groupId:'h3-goals-s1' });
          }
        }

        var ok = errors.length === 0;
        return {
          ok: ok,
          focusFieldId: ok ? null : errors[0].fieldId,
          errors: errors
        };
      };

      AA01.errors = {
        summarize:function(result){
          if(!result || !result.errors || !result.errors.length){
            return { hasErrors:false };
          }
          var groups = {};
          result.errors.forEach(function(err){
            var groupId = err.groupId || 'general';
            if(!groups[groupId]){
              groups[groupId] = { id:groupId, items:[] };
            }
            groups[groupId].items.push(err);
          });
          return {
            hasErrors:true,
            focus:result.errors[0].fieldId,
            groups:Object.keys(groups).map(function(key){
              var entry = groups[key];
              var heading = AA01.HEADING_INDEX[key];
              entry.label = heading && heading.label ? heading.label : (key === 'general' ? '表單' : key);
              return entry;
            })
          };
        }
      };

      AA01.ui = {
        init:function(){
          this.cacheDom();
          this.bindEvents();
          this.renderNavigation();
          this.restoreDraft();
          this.scheduleSync();
          this.updateStatusBar();
          this.registerShortcuts();
          AA01.store.initialized = true;
        },
        cacheDom:function(){
          this.root = document.getElementById('formRoot');
          this.toast = document.getElementById('toast');
          this.toastMessage = document.getElementById('toastMessage');
          this.toastAction = document.getElementById('toastAction');
          this.errorSummary = document.getElementById('errorSummary');
          this.statusBar = document.getElementById('statusBar');
          this.wizardNav = document.getElementById('wizardNav');
          this.sideNav = document.getElementById('sideNav');
          this.saveDraftBtn = document.getElementById('saveDraft');
          this.submitBtn = document.getElementById('submitPlan');
          this.extraRel = document.getElementById('extraRel');
          this.extraName = document.getElementById('extraName');
          this.extraList = document.getElementById('extraParticipantsList');
          this.addExtraBtn = document.getElementById('addExtraParticipant');
          this.addServiceBtn = document.getElementById('addService');
          this.serviceTable = document.getElementById('serviceTable');
          this.serviceTemplate = document.getElementById('serviceRowTemplate');
          this.extraTemplate = document.getElementById('extraParticipantTemplate');
        },
        bindEvents:function(){
          var self = this;
          this.root.addEventListener('input', function(){ self.scheduleSync(); });
          this.root.addEventListener('change', function(){ self.scheduleSync(); });
          this.saveDraftBtn.addEventListener('click', function(){ self.saveDraft(); });
          this.submitBtn.addEventListener('click', function(){ AA01.submit(); });
          this.addExtraBtn.addEventListener('click', function(){ self.addExtraParticipant(); });
          this.extraList.addEventListener('click', function(evt){ self.handleExtraAction(evt); });
          this.addServiceBtn.addEventListener('click', function(){ self.addServiceRow(); });
          this.serviceTable.addEventListener('click', function(evt){ self.handleServiceAction(evt); });
        },
        renderNavigation:function(){
          var self = this;
          this.wizardNav.innerHTML = '';
          var pages = [];
          AA01.HEADINGS.forEach(function(node){
            if(node.tag === 'h1') pages.push(node);
          });
          pages.forEach(function(page, index){
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.textContent = page.label;
            btn.setAttribute('data-page', page.page || page.id);
            btn.addEventListener('click', function(){ self.setPage(page.page || page.id); });
            if(index === 0){ btn.setAttribute('aria-current', 'step'); }
            self.wizardNav.appendChild(btn);
          });

          var sideList = document.createElement('div');
          AA01.HEADINGS.forEach(function(node){
            var title = document.createElement('h2');
            title.textContent = node.label;
            sideList.appendChild(title);
            if(Array.isArray(node.children)){
              var list = document.createElement('ul');
              node.children.forEach(function(child){
                var li = document.createElement('li');
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = child.label;
                btn.dataset.anchor = child.id;
                btn.addEventListener('click', function(){ self.scrollToField(child.id); });
                li.appendChild(btn);
                list.appendChild(li);
              });
              sideList.appendChild(list);
            }
          });
          this.sideNav.innerHTML = '';
          this.sideNav.appendChild(sideList);
          if(pages.length){
            var initial = AA01.store.currentPage || pages[0].page || pages[0].id;
            this.setPage(initial);
          }
        },
        setPage:function(pageId){
          AA01.store.currentPage = pageId;
          var sections = document.querySelectorAll('.page-section');
          sections.forEach(function(section){
            section.hidden = section.dataset.page && section.dataset.page !== pageId && pageId !== 'all' ? section.dataset.page !== pageId : false;
          });
          var buttons = this.wizardNav.querySelectorAll('button');
          buttons.forEach(function(btn){
            var current = btn.getAttribute('data-page');
            if(current === pageId){
              btn.setAttribute('aria-current','step');
            }else{
              btn.removeAttribute('aria-current');
            }
          });
        },
        scrollToField:function(anchorId){
          var target = document.querySelector('[data-field-id="' + anchorId + '"]');
          if(!target){
            var section = document.getElementById(anchorId);
            if(section){ section.scrollIntoView({ behavior:'smooth', block:'start' }); }
            return;
          }
          target.focus({ preventScroll:true });
          target.scrollIntoView({ behavior:'smooth', block:'center' });
          var navButtons = this.sideNav.querySelectorAll('button');
          navButtons.forEach(function(btn){
            btn.setAttribute('aria-current', btn.dataset.anchor === anchorId ? 'true' : 'false');
          });
        },
        addExtraParticipant:function(){
          var rel = (this.extraRel.value || '').trim();
          var name = (this.extraName.value || '').trim();
          if(!rel && !name){
            this.showToast('請填寫關係或姓名後再加入。');
            return;
          }
          var template = this.extraTemplate.content.firstElementChild.cloneNode(true);
          var index = this.extraList.querySelectorAll('[data-index]').length;
          template.setAttribute('data-index', index);
          template.setAttribute('data-rel', rel);
          template.setAttribute('data-name', name);
          var link = template.querySelector('[data-action="jump"]');
          link.textContent = rel ? rel + '／' + name : name;
          template.querySelector('[data-action="jump"]').addEventListener('click', function(evt){ evt.preventDefault(); });
          this.extraList.appendChild(template);
          this.extraRel.value = '';
          this.extraName.value = '';
          this.scheduleSync();
        },
        handleExtraAction:function(evt){
          var target = evt.target.closest('[data-action]');
          if(!target) return;
          var action = target.dataset.action;
          var chip = target.closest('[data-index]');
          if(!chip) return;
          if(action === 'remove'){
            chip.remove();
            this.scheduleSync();
          }
        },
        addServiceRow:function(){
          var row = this.serviceTemplate.content.firstElementChild.cloneNode(true);
          this.serviceTable.appendChild(row);
          this.scheduleSync();
        },
        handleServiceAction:function(evt){
          var btn = evt.target.closest('[data-action="remove"]');
          if(!btn) return;
          var row = btn.closest('tr');
          if(row){ row.remove(); this.scheduleSync(); }
        },
        scheduleSync:function(){
          var self = this;
          AA01.batchFrame('sync', function(){ self.syncState(); });
        },
        syncState:function(){
          var data = AA01.collect(this.root);
          AA01.store.data = data;
          var validation = AA01.validate(data);
          AA01.store.validation = validation;
          this.renderErrors(validation);
          this.updateProgressIndicators(data, validation);
          this.updateStatusBar();
          var self = this;
          AA01.batchFrame('autosave', function(){ self.autoSave(); });
        },
        renderErrors:function(validation){
          var summary = AA01.errors.summarize(validation);
          if(!summary.hasErrors){
            this.errorSummary.dataset.visible = 'false';
            this.errorSummary.innerHTML = '';
            this.toast.setAttribute('aria-hidden','true');
            return;
          }
          this.errorSummary.dataset.visible = 'true';
          var listHtml = summary.groups.map(function(group){
            var items = group.items.map(function(err){
              return '<li><button type="button" class="link-button" data-jump="'+err.fieldId+'">'+ err.msg +'</button></li>';
            }).join('');
            return '<div><strong>'+group.label+'</strong><ul>'+items+'</ul></div>';
          }).join('');
          this.errorSummary.innerHTML = listHtml;
          var self = this;
          this.errorSummary.querySelectorAll('[data-jump]').forEach(function(btn){
            btn.addEventListener('click', function(){ self.scrollToField(btn.getAttribute('data-jump')); });
          });
          this.showToast('請修正表單錯誤，共 ' + validation.errors.length + ' 項。');
        },
        updateProgressIndicators:function(data){
          var filledBasic = ['unitCode','caseManagerName','caseName','consultName','cmsLevel'].reduce(function(count, key){
            return count + ((data.basic && data.basic[key]) ? 1 : 0);
          }, 0);
          document.getElementById('basicProgress').textContent = filledBasic + '/5 完成';

          var contactFilled = 0;
          if(data.contact.callDate) contactFilled++;
          if(data.contact.visitDate) contactFilled++;
          if(data.contact.dischargeDate) contactFilled++;
          document.getElementById('contactProgress').textContent = contactFilled + '/3 完成';

          var participantFilled = 0;
          if(data.participants.primary.rel) participantFilled++;
          if(data.participants.primary.name) participantFilled++;
          document.getElementById('participantProgress').textContent = participantFilled + '/2 完成';

          var goalFilled = 0;
          if(data.goals.short.summary) goalFilled++;
          if(data.goals.mid.summary) goalFilled++;
          if(data.goals.long.summary) goalFilled++;
          document.getElementById('goalProgress').textContent = goalFilled + ' 項完成';

          document.getElementById('planProgress').textContent = (data.plan.services.length || 0) + ' 項服務';
          document.getElementById('noteProgress').textContent = data.notes.other ? '已填寫' : '備註';
        },
        updateStatusBar:function(){
          if(!this.statusBar) return;
          var now = AA01.store.lastSaved ? new Date(AA01.store.lastSaved) : null;
          var savedText = now ? '已自動儲存於 ' + now.toLocaleTimeString() : '尚未儲存';
          var errors = AA01.store.validation && AA01.store.validation.errors ? AA01.store.validation.errors.length : 0;
          this.statusBar.innerHTML = '';
          var items = [savedText, '錯誤 ' + errors + ' 項'];
          items.forEach(function(text){
            var span = document.createElement('span');
            span.textContent = text;
            this.statusBar.appendChild(span);
          }, this);
        },
        autoSave:function(){
          if(!AA01.store.initialized) return;
          var data = AA01.store.data;
          if(!data) return;
          AA01.persist.save(data);
          AA01.store.lastSaved = Date.now();
          this.updateStatusBar();
        },
        saveDraft:function(){
          var data = AA01.collect(this.root);
          AA01.persist.save(data);
          AA01.store.lastSaved = Date.now();
          this.showToast('草稿已儲存。');
          this.updateStatusBar();
        },
        restoreDraft:function(){
          var draft = AA01.persist.load();
          if(!draft) return;
          this.populateForm(draft);
          AA01.store.lastSaved = draft.meta && draft.meta.lastSaved ? draft.meta.lastSaved : Date.now();
        },
        populateForm:function(data){
          if(!data) return;
          var inputs = this.root.querySelectorAll('[data-bind]');
          inputs.forEach(function(input){
            var path = input.getAttribute('data-bind');
            var value = getDeepValue(data, path);
            if(input.dataset.collect === 'array'){
              if(input instanceof HTMLSelectElement && input.multiple){
                Array.from(input.options).forEach(function(option){ option.selected = Array.isArray(value) && value.indexOf(option.value) > -1; });
              }else if(input.type === 'checkbox'){
                input.checked = Array.isArray(value) && value.indexOf(input.value) > -1;
              }
              return;
            }
            var type = input.dataset.type || input.type;
            if(type === 'checkbox'){
              input.checked = !!value;
            }else if(type === 'boolean'){
              input.checked = !!value;
            }else if(input instanceof HTMLSelectElement && input.multiple){
              Array.from(input.options).forEach(function(option){ option.selected = Array.isArray(value) && value.indexOf(option.value) > -1; });
            }else{
              input.value = value === null || typeof value === 'undefined' ? '' : value;
            }
          });

          var extras = (data.participants && data.participants.extras) || [];
          this.extraList.innerHTML = '';
          for(var i=0; i<extras.length; i++){
            var entry = extras[i];
            var template = this.extraTemplate.content.firstElementChild.cloneNode(true);
            template.setAttribute('data-index', i);
            template.setAttribute('data-rel', entry.rel || '');
            template.setAttribute('data-name', entry.name || '');
            var link = template.querySelector('[data-action="jump"]');
            link.textContent = (entry.rel ? entry.rel + '／' : '') + (entry.name || '');
            this.extraList.appendChild(template);
          }

          var services = (data.plan && data.plan.services) || [];
          this.serviceTable.innerHTML = '';
          services.forEach(function(entry){
            var row = this.serviceTemplate.content.firstElementChild.cloneNode(true);
            row.querySelector('[data-name="code"]').value = entry.code || '';
            row.querySelector('[data-name="provider"]').value = entry.provider || '';
            row.querySelector('[data-name="freq"]').value = entry.freq || '';
            row.querySelector('[data-name="qty"]').value = entry.qty || '';
            row.querySelector('[data-name="copay"]').value = entry.copay || '';
            this.serviceTable.appendChild(row);
          }, this);
        },
        showToast:function(message){
          if(!this.toast) return;
          this.toastMessage.textContent = message;
          this.toastAction.innerHTML = '';
          this.toast.setAttribute('aria-hidden','false');
          var self = this;
          window.setTimeout(function(){ self.toast.setAttribute('aria-hidden','true'); }, 2500);
        },
        registerShortcuts:function(){
          var self = this;
          document.addEventListener('keydown', function(evt){
            if((evt.ctrlKey || evt.metaKey) && evt.key.toLowerCase() === 's'){
              evt.preventDefault();
              self.saveDraft();
              return;
            }
            if(evt.altKey && evt.shiftKey && evt.key.toLowerCase() === 'n'){
              evt.preventDefault();
              self.focusNextPage();
            }
            if(evt.altKey && evt.shiftKey && evt.key.toLowerCase() === 'p'){
              evt.preventDefault();
              self.focusPrevPage();
            }
          });
        },
        focusNextPage:function(){
          var buttons = Array.from(this.wizardNav.querySelectorAll('button'));
          var index = buttons.findIndex(function(btn){ return btn.getAttribute('aria-current') === 'step'; });
          if(index === -1) return;
          var next = buttons[index + 1] || buttons[0];
          next.click();
          next.focus();
        },
        focusPrevPage:function(){
          var buttons = Array.from(this.wizardNav.querySelectorAll('button'));
          var index = buttons.findIndex(function(btn){ return btn.getAttribute('aria-current') === 'step'; });
          if(index === -1) return;
          var prev = buttons[index - 1] || buttons[buttons.length - 1];
          prev.click();
          prev.focus();
        }
      };

      AA01.submit = function(){
        var data = AA01.collect(document.getElementById('formRoot'));
        var validation = AA01.validate(data);
        if(!validation.ok){
          AA01.store.validation = validation;
          AA01.ui.renderErrors(validation);
          if(validation.focusFieldId){ AA01.ui.scrollToField(validation.focusFieldId); }
          return;
        }
        if(window.google && google.script && google.script.run){
          google.script.run
            .withSuccessHandler(function(response){ AA01.ui.showToast(response && response.message ? response.message : '已送出。'); })
            .withFailureHandler(function(err){ console.error(err); AA01.ui.showToast('送出失敗，請稍後再試。'); })
            .applyAndSaveAA01(data);
        }else{
          console.log('Submit data', data);
          AA01.ui.showToast('模擬送出成功。');
        }
      };

      document.addEventListener('DOMContentLoaded', function(){ AA01.ui.init(); });
    })(window, document);
  </script>
</body>
</html>
