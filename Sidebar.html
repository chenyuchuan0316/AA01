<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AA01計畫助手（快速填寫）</title>

  <!-- 行動端視窗與 iOS 安全區域 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- 避免 iOS 自動辨識電話/Email 造成版面跳動 -->
  <meta name="format-detection" content="telephone=no, email=no, address=no" />
  <!-- 目前採用亮色；若未來要支援暗色可改為 "light dark" -->
  <meta name="color-scheme" content="light" />

  <style>
    /* ===== AA01 表單 — 放大字級、強對比、兩欄桌機、單欄手機、觸控友善 =====
       尺寸基準（依需求可再調）：
       - 根字級（html）：桌機 18→19→20px（視寬度），手機 clamp(18px, 4.8vw, 20px)
       - 內文/標籤：≥16–18px（隨根字級等比）
       - 控制元件字級：固定 20px（避免 iOS 聚焦放大）
       - 輸入框高度：≥56px；主按鈕：56px；小按鈕：48px；核取方塊：28→32px（觸控）
    */

    :root{
      /* 色彩（提高對比） */
      --bg:#ffffff;
      --card:#ffffff;
      --card-alt:#f9fbff;            /* 淺藍區隔不同 group（交錯使用） */
      --border:#dfe3ea;              /* 較實邊框 */
      --border-strong:#c7cfdb;
      --text:#111111;
      --label:#333333;               /* Label 由 #6a6a6a 提升為 #333 */
      --placeholder:#555555;         /* Placeholder 加深，避免與 disabled 混淆 */
      --title:#0B57D0;               /* 區塊標題與主色（可改為 #222 深灰） */
      --accent:#0B57D0;              /* 主要行為色（按鈕/Focus） */
      --accent-weak:rgba(11,87,208,.12); /* Focus ring */

      /* 尺寸系統 */
      --gap:14px;
      --radius:12px;
      --shadow:0 1px 2px rgba(0,0,0,.04), 0 6px 14px rgba(0,0,0,.06);

      --fs-base:1rem;                               /* 由 html 根字級決定（18–20px） */
      --fs-title:clamp(1.25rem, 1.1rem + .35vw, 1.5rem);
      --fs-label:1rem;                              /* label ≥16–18px */
      --fs-ctrl:20px;                               /* input/select/textarea 固定 20px */
      --h-input:56px;                               /* 輸入框高度 */
      --h-button:56px;                              /* 主按鈕高度 */
      --h-button-sm:48px;                           /* 小按鈕（±1天/±5天等） */
      --checkbox:28px;                              /* 核取方塊 */
    }

    /* 根字級：桌機 18→19→20；手機 clamp(18–20) */
    html { font-size:18px; -webkit-text-size-adjust:100%; }
    @media (min-width:1440px){ html{ font-size:19px; } }
    @media (min-width:1920px){ html{ font-size:20px; } }
    @media (max-width:480px){ html{ font-size:clamp(18px, 4.8vw, 20px); } }

    html, body{ background:var(--bg); color:var(--text); }
    body{
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      font-size:var(--fs-base);
      line-height:1.75;
      letter-spacing:.2px;
      margin:16px;
      -webkit-tap-highlight-color:transparent;
      text-rendering:optimizeLegibility;
    }
    .app-container{
      max-width:1200px;
      margin:0 auto 120px auto;
    }

    /* 卡片 */
    .group{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:22px;
      margin-bottom:16px;
      box-shadow:var(--shadow);
    }
    /* 交錯輕底以分區（不改 HTML 的情況下給予溫和導引） */
    .group:nth-of-type(odd){ background:var(--card-alt); }

    /* 標題列與標題字（加粗 + 底線 + 顏色導引） */
    .titlebar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .group > label:first-child, .titlebar > label:first-child{
      display:block; font-weight:800; font-size:var(--fs-title); color:var(--title);
      margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--border-strong);
    }

    /* 佈局：桌機固定兩欄、行動單欄（避免三欄造成橫向拉長） */
    .row{ display:flex; gap:var(--gap); flex-wrap:wrap; align-items:flex-start; margin-bottom:10px; }
    .row > div{ flex:1 1 360px; min-width:360px; }      /* ⬅️ 360px 下限，確保不會出現三欄 */
    .grid2, .grid3{ display:grid; gap:var(--gap); align-items:start; }
    .grid2{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    .grid3{ grid-template-columns:repeat(2, minmax(0,1fr)); } /* ⬅️ 將原本三欄統一限制為兩欄 */
    @media (max-width:1024px){
      .row > div{ flex:1 1 100%; min-width:100%; }
      .grid2, .grid3{ grid-template-columns:1fr; }
    }

    /* 標籤與 Placeholder（加大字、提升對比） */
    label{ display:block; font-size:var(--fs-label); margin-bottom:8px; color:var(--label); }
    :where(input,select,textarea)::placeholder{ color:var(--placeholder); opacity:1; }

    /* 表單元件：20px 字級，56px 高度（iOS 聚焦不縮放） */
    input[type="text"], input[type="number"], input[type="tel"], input[type="email"],
    input[type="search"], input[type="date"], input[type="time"],
    select, textarea{
      width:100%; box-sizing:border-box;
      min-height:var(--h-input);
      padding:12px 16px;
      font-size:var(--fs-ctrl); line-height:1.4;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
      appearance:none;
    }
    textarea{ min-height:132px; height:auto; resize:vertical; }

    /* Focus 樣式：清楚但不刺眼 */
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--title);
      box-shadow:0 0 0 3px var(--accent-weak);
    }

    /* 禁用狀態：底色與字色明顯區隔 */
    input:disabled, select:disabled, textarea:disabled{
      background:#f3f5f7; color:#777; border-color:#e1e5ea;
    }

    /* 日期顯示盒（更清楚） */
    .datebox{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .datebox input[type="date"]{
      width:auto;
      min-width:176px;
      flex:0 0 auto;
    }
    .date-controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .date-controls button.small{ min-width:64px; }
    .date-controls button.calendar-btn{ min-width:72px; }

    /* 按鈕與操作面積（主按鈕 56px，小按鈕 48px） */
    .btnbar{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    button{
      height:var(--h-button);
      padding:0 18px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff; color:#111; font-weight:700; cursor:pointer;
      line-height:1; touch-action:manipulation; font-size:18px;
    }
    button:hover{ background:#f7f7f7; }
    button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small{ height:var(--h-button-sm); padding:0 14px; font-size:18px; }
    /* 可選：若於按鈕加入 data-ic="plus"/"minus"，會自動加上 + / - 圖示 */
    button[data-ic="plus"]::before{ content:"+"; margin-right:.25em; font-weight:900; }
    button[data-ic="minus"]::before{ content:"–"; margin-right:.25em; font-weight:900; }

    .page-tabs{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
    .page-tabs button{
      height:44px;
      padding:0 18px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--label);
      font-weight:600;
      cursor:pointer;
      transition:background .15s ease, color .15s ease, border-color .15s ease;
    }
    .page-tabs button.active{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .page-section{ display:none; }
    .page-section[data-active="1"]{ display:block; }

    .summary-section{ margin-bottom:20px; }
    .summary-title{ font-weight:700; color:var(--title); margin-bottom:8px; }
    .summary-table-wrapper{ overflow-x:auto; }
    .summary-table{ width:100%; border-collapse:collapse; min-width:600px; }
    .summary-table th, .summary-table td{
      border:1px solid var(--border);
      padding:8px 10px;
      text-align:left;
      vertical-align:top;
    }
    .summary-table th{ background:#eef2ff; color:#1f2937; font-weight:700; }

    .cms-level-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .cms-level-group button{
      min-width:54px;
      height:var(--h-button-sm);
      padding:0 16px;
      border-radius:999px;
    }
    .cms-level-group button[data-active="1"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }

    .location-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:12px 0 8px;
      gap:12px;
      flex-wrap:wrap;
    }
    .location-toolbar .location-current{ font-weight:600; color:var(--label); }
    .location-toolbar .location-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .location-switch button[data-active="1"],
    .location-actions button[data-active="1"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }

    /* 黏底主要動作列（避開 iOS 底部工具列） */
    .group:last-of-type .btnbar{
      position:sticky; bottom:max(18px, env(safe-area-inset-bottom));
      padding:12px; background:rgba(255,255,255,.92);
      border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    }

    /* 勾選清單（點擊面積提升） */
    .checkcol{ columns:auto; column-gap:0; }
    .checkcol label{
      display:flex; align-items:center; gap:12px; padding:12px 14px;
      border:1px solid var(--border); border-radius:12px; margin-bottom:12px; background:#fff; color:#222; font-size:var(--fs-base);
    }
    .checkcol input[type=checkbox]{ width:var(--checkbox); height:var(--checkbox); }
    .checkcol label[data-auto="1"]{
      border-color:rgba(11,87,208,.4);
      background:rgba(11,87,208,.08);
    }
    .checkcol label[data-auto="1"]::after{
      content:'（系統預選）';
      margin-left:8px;
      color:var(--accent);
      font-size:.9rem;
      font-weight:600;
    }
    @media (pointer:coarse){ :root{ --checkbox:32px; } } /* 觸控設備放大到 32px */

    .lesion-mode{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .lesion-mode button.small{ min-width:112px; }
    .lesion-mode button[data-active="1"]{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .lesion-size-grid{ display:flex; gap:12px; flex-wrap:wrap; }
    .lesion-size-field{ flex:1 1 140px; position:relative; }
    .lesion-size-field input{ padding-right:42px; }
    .lesion-size-field .unit{ position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--label); font-weight:600; pointer-events:none; }
    .lesion-area{ margin-top:6px; font-weight:600; color:var(--label); }
    .action-list{ display:flex; flex-direction:column; gap:12px; }
    .action-item{ border:1px dashed var(--border); border-radius:var(--radius); padding:14px; background:#fff; display:flex; flex-direction:column; gap:10px; }
    .action-item-fields{ display:flex; flex-direction:column; gap:10px; }
    .action-item textarea{ resize:vertical; min-height:96px; }
    .action-item select{ font-size:var(--fs-ctrl); }
    .action-item-controls{ display:flex; justify-content:flex-end; }
    .mismatch-diff{ display:flex; flex-wrap:wrap; gap:8px; margin:8px 0; }
    .mismatch-diff .badge{ background:var(--accent-weak); color:var(--accent); }
    .field-error{ color:#b3261e; font-size:0.95rem; margin-top:6px; display:none; }
    .field-error[data-show="1"]{ display:block; }

    @media (pointer:coarse){
      select{ min-height:64px; padding-top:14px; padding-bottom:14px; }
    }

    .plan-editor{
      display:flex;
      flex-direction:column;
      gap:18px;
      margin-top:12px;
    }
    .plan-category{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      padding:16px;
    }
    .plan-category-title{
      font-weight:700;
      font-size:1.05rem;
      color:var(--title);
      margin-bottom:12px;
    }
    .plan-entry{
      border:1px dashed var(--border);
      border-radius:var(--radius);
      padding:12px;
      background:var(--card-alt);
    }
    .plan-entry + .plan-entry{ margin-top:12px; }
    .plan-entry-header{
      font-weight:700;
      margin-bottom:10px;
    }
    .plan-entry-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
      gap:12px;
      align-items:start;
    }
    .plan-entry-grid textarea,
    .plan-entry-grid .full{ grid-column:1/-1; }
    .plan-field.auto-summary .auto-summary-box{
      padding:12px 16px;
      border:1px solid var(--border-strong);
      border-radius:10px;
      background:#f0f4ff;
      color:#0b1d4d;
      font-weight:600;
      line-height:1.6;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .plan-field.auto-summary .auto-summary-box.empty{
      color:#4b5563;
      font-weight:500;
      background:#f8fafc;
      border-style:dashed;
    }
    .plan-qty-toolbar{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .plan-qty-hint{
      font-weight:600;
      color:var(--label);
      font-size:0.95rem;
      margin-right:4px;
    }
    button.tiny{
      height:44px;
      padding:0 12px;
      font-size:17px;
      border-radius:10px;
    }
    .plan-qty-toolbar button[data-variant="ghost"]{
      background:#f7f9fc;
      border-color:var(--border);
      color:#3f3f46;
    }
    .plan-qty-toolbar button[data-variant="ghost"]:hover{
      background:#edf1ff;
    }
    .plan-summary-totals{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:12px;
    }
    .plan-summary-total-card{
      flex:1 1 220px;
      min-width:200px;
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 16px;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .plan-summary-total-label{
      font-size:0.95rem;
      color:#475569;
      margin-bottom:6px;
      font-weight:600;
    }
    .plan-summary-total-value{
      font-size:1.35rem;
      font-weight:800;
      color:#0b1d4d;
    }
    .plan-summary-total-value.negative{
      color:#b3261e;
    }
    .plan-summary-totals-hint{
      font-size:0.95rem;
      color:#b3261e;
      margin-bottom:12px;
      display:none;
    }
    .plan-summary-totals-hint[data-show="1"]{
      display:block;
    }
    .plan-meta{
      display:grid;
      gap:12px;
      margin-top:12px;
    }
    .plan-meta textarea{ min-height:96px; }
    .plan-preview{
      width:100%;
      min-height:220px;
      padding:16px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#f7f9fc;
      font-size:.95rem;
      line-height:1.6;
      box-sizing:border-box;
      white-space:pre-wrap;
    }

    .auto-hint{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .auto-hint button.small{
      height:auto;
      padding:6px 12px;
      font-size:.95rem;
    }

    /* Home care 卡式清單（維持放大字與輸入） */
    .home-care-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:12px; }
    .home-care-item{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:16px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      box-shadow:var(--shadow);
      cursor:pointer;
      transition:border-color .18s ease, box-shadow .18s ease, transform .18s ease;
      outline:none;
    }
    .home-care-item::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:16px;
      border:2px solid transparent;
      pointer-events:none;
      transition:border-color .18s ease;
    }
    .home-care-item:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 18px rgba(15,23,42,.12);
    }
    .home-care-item:focus-visible::after{
      border-color:var(--accent);
    }
    .home-care-item[data-selected="1"]{
      border-color:rgba(11,87,208,.45);
      box-shadow:0 10px 22px rgba(15,23,42,.14);
    }
    .home-care-item[data-selected="1"]::after{
      border-color:rgba(11,87,208,.45);
    }
    .home-care-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .home-care-title{
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
      min-width:0;
    }
    .home-care-code{
      font-weight:800;
      color:#0b1d4d;
      font-size:1.05rem;
      letter-spacing:.5px;
    }
    .home-care-name{
      color:#111;
      font-weight:600;
      font-size:0.98rem;
      line-height:1.4;
    }
    .home-care-status{
      font-size:0.9rem;
      font-weight:600;
      color:#475569;
    }
    .home-care-extra{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transition:max-height .2s ease, opacity .2s ease;
    }
    .home-care-item[data-selected="1"] .home-care-extra{
      max-height:140px;
      opacity:1;
    }
    .home-care-qty-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .home-care-qty-label{
      font-weight:600;
      color:#1f2937;
      white-space:nowrap;
    }
    .home-care-qty{
      width:120px;
      height:46px;
      padding:8px 10px;
      font-size:var(--fs-ctrl);
      border:1px solid var(--border);
      border-radius:12px;
      box-sizing:border-box;
    }
    .home-care-item[data-has-qty="1"] .home-care-main{
      align-items:flex-start;
    }

    /* 預覽框：顏色加深以凸顯區塊 */
    .preview{
      padding:14px 16px; background:#eef4ff;
      border:1px solid #cdd9ff; border-radius:12px;
      white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:#0f172a; max-height:55vh; overflow:auto; font-size:17px;
    }
    #goalPreview.goal-preview-empty{ color:#6b7280; }

    /* 提示／狀態色與區隔線 */
    .hint{ font-size:.95rem; color:#4b5563; }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      background:rgba(11,87,208,.08);
      color:var(--accent);
      font-weight:600;
      min-height:38px;
    }
    .danger{ color:#b00020; }
    .error-messages{
      display:none;
      margin:10px 0;
      padding:12px 14px;
      border:1px solid #fca5a5;
      border-radius:var(--radius);
      background:#fef2f2;
      color:#b91c1c;
      font-size:.95rem;
    }
    .error-messages ul{ margin:0; padding-left:20px; }
    .error-messages li{ margin-bottom:4px; }
    .input-invalid{
      border-color:#d92d20 !important;
      box-shadow:0 0 0 2px rgba(217,45,32,.2) !important;
    }
    .checkcol.input-invalid{
      border:1px solid #fca5a5;
      border-radius:var(--radius);
      padding:12px 14px;
      background:#fef2f2;
    }
    .hr{ border-top:1px dashed #d8dce3; margin:14px 0; }

    /* Placeholder 選項（select 的置放字） */
    .placeholder-option{ color:#555; font-size:var(--fs-ctrl); }

    /* Tooltip：於元素加 data-tooltip="說明..." 即會顯示 */
    [data-tooltip]{ position:relative; }
    [data-tooltip]:hover::after{
      content:attr(data-tooltip);
      position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 8px);
      white-space:normal; width:max-content; max-width:260px;
      padding:8px 10px; background:#111; color:#fff; border-radius:8px; font-size:.9rem; line-height:1.4;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    [data-tooltip]:hover::before{
      content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 4px);
      border:6px solid transparent; border-top-color:#111;
    }

    /* 行動端微調 */
    @media (max-width:480px){
      body{ margin:12px; }
      .group{ padding:18px; margin-bottom:14px; }
      .row, .grid2, .grid3{ gap:12px; }
      .datebox input[type="date"]{ min-width:150px; font-size:18px; }
      .preview{ font-size:1rem; }
    }
  </style>
</head>



<body>

  <div class="app-container" id="appContainer">

  <div class="page-tabs" id="pageTabs">
    <button type="button" data-page="goals" class="active">計畫目標</button>
    <button type="button" data-page="execution">計畫執行規劃</button>
    <button type="button" data-page="notes">其他備註</button>
  </div>

  <div class="page-section" data-page="goals" data-active="1">
  <!-- 基本資訊 -->
  <div class="group">
    <label>★基本資訊</label>
    <div class="row">
      <div>
        <label>單位代碼</label>
        <select id="unitCode" onchange="loadManagers(); loadConsultants();">
          <option>FNA1</option><option>FNA2</option><option>FNA3</option>
        </select>
      </div>
      <div>
        <label>個案管理師</label>
        <select id="caseManagerName"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>個案姓名</label>
        <input id="caseName" type="text" placeholder="請輸入">
      </div>
      <div>
        <label>照專姓名</label>
        <select id="consultName">
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>CMS 等級</label>
        <div id="cmsLevelGroup" class="cms-level-group">
          <button type="button" data-level="2">2</button>
          <button type="button" data-level="3">3</button>
          <button type="button" data-level="4">4</button>
          <button type="button" data-level="5">5</button>
          <button type="button" data-level="6">6</button>
          <button type="button" data-level="7">7</button>
          <button type="button" data-level="8">8</button>
        </div>
        <input type="hidden" id="cmsLevelValue" value="">
      </div>
    </div>
  </div>

  <!-- 一、電聯日期 -->
  <div class="group">
    <label>一、電聯日期</label>
    <div id="callDateControls" class="datebox">
      <input id="callDate" type="date">
      <div class="date-controls">
        <button type="button" class="small" onclick="shiftDate('callDate', -5)">-5天</button>
        <button type="button" class="small" onclick="shiftDate('callDate',  5)">+5天</button>
        <button type="button" class="small" onclick="shiftDate('callDate', -1)">-1天</button>
        <button type="button" class="small" onclick="shiftDate('callDate',  1)">+1天</button>
        <button type="button" class="small calendar-btn" onclick="openDatePicker('callDate')">日曆</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label><input id="isConsultVisit" type="checkbox" onchange="toggleCallDateByConsultVisit()"> 照顧專員約訪</label>
      </div>
    </div>
    <div id="consultVisitText" class="subtle" style="display:none; margin-top:4px;"></div>
  </div>

  <!-- 二、家訪日期 + 出院 -->
  <div class="group">
    <label>二、家訪日期</label>
    <div class="datebox">
      <input id="visitDate" type="date">
      <div class="date-controls">
        <button type="button" class="small" onclick="shiftDate('visitDate', -5)">-5天</button>
        <button type="button" class="small" onclick="shiftDate('visitDate',  5)">+5天</button>
        <button type="button" class="small" onclick="shiftDate('visitDate', -1)">-1天</button>
        <button type="button" class="small" onclick="shiftDate('visitDate',  1)">+1天</button>
        <button type="button" class="small calendar-btn" onclick="openDatePicker('visitDate')">日曆</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label><input id="isDischarge" type="checkbox" onchange="toggleDischarge()"> 出院準備（勾選後顯示出院日期）</label>
      </div>
    </div>
    <div id="dischargeBox" style="display:none;">
      <div class="datebox">
        <input id="dischargeDate" type="date">
        <div class="date-controls">
          <button type="button" class="small" onclick="shiftDate('dischargeDate', -5)">-5天</button>
          <button type="button" class="small" onclick="shiftDate('dischargeDate',  5)">+5天</button>
          <button type="button" class="small" onclick="shiftDate('dischargeDate', -1)">-1天</button>
          <button type="button" class="small" onclick="shiftDate('dischargeDate',  1)">+1天</button>
          <button type="button" class="small calendar-btn" onclick="openDatePicker('dischargeDate')">日曆</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 三、偕同訪視者 -->
  <div class="group">
    <label><strong>三、偕同訪視者</strong></label>
    <div class="row">
      <div>
        <label>主要照顧者關係</label>
        <select id="primaryRel" onchange="enforcePrimaryExclusionOnExtras()">
          <option value="" class="placeholder-option" disabled selected>請選擇</option>
          <optgroup label="配偶"><option>案妻</option><option>案夫</option></optgroup>
          <optgroup label="子女"><option>案長子</option><option>案次子</option><option>案長女</option><option>案次女</option></optgroup>
          <optgroup label="父母"><option>案父</option><option>案母</option></optgroup>
          <optgroup label="手足"><option>案兄</option><option>案姊</option><option>案弟</option><option>案妹</option></optgroup>
          <optgroup label="姻親"><option>案媳</option><option>案女婿</option></optgroup>
          <optgroup label="孫輩"><option>案孫</option><option>案孫女</option></optgroup>
          <optgroup label="自訂"><option>自訂角色</option></optgroup>
        </select>
      </div>
      <div>
        <label>主要照顧者姓名</label>
        <input id="primaryName" type="text" placeholder="請輸入">
      </div>
    </div>

    <!-- 預設輸出主照者：移除勾選框，改用 hidden 固定為 true -->
    <input type="hidden" id="includePrimary" value="true">

    <div class="hr"></div>
    <label>其他參與者</label>
    <div id="extras"></div>
    <div class="field-error" id="extras_conflict"></div>
    <div class="btnbar">
      <button class="small" onclick="addExtraRow()">新增參與者</button>
    </div>
    <!-- （已移除原「輸出格式：個案(姓名)…」說明） -->
  </div>

  <!-- 四、個案概況 -->
  <div class="group">
    <div class="titlebar">
      <label>四、個案概況</label>
      <span class="hint" style="margin:0;">系統已即時檢查必填欄位，缺漏將以紅框提示。</span>
    </div>

    <!-- (一) 身心概況：已更新 + 連動 + 自動產文 -->
    <div class="row">
      <div id="section1_block">
        <div class="titlebar">
          <label>(一) 身心概況</label>
        </div>

        <!-- 基本＋意識/認知 -->
        <div class="grid3">
          <div><label>年齡</label><input id="s1_age" type="number" min="1" max="120" value="70"></div>
          <div>
            <label>性別</label>
            <select id="s1_gender">
              <option>男</option><option>女</option>
            </select>
          </div>
          <div>
            <label>認知溝通</label>
            <select id="s1_cognition">
              <option>清楚可應答</option>
              <option>需重複或放慢</option>
              <option>健忘／短期記憶不佳</option>
              <option>表達或理解困難</option>
              <option>無法溝通</option>
              <option>無法評估</option>
            </select>
          </div>
          <div>
            <label>意識狀態</label>
            <select id="s1_awareness">
              <option>清楚</option><option>遲鈍</option>
              <option>混亂</option><option>模糊</option><option>嗜睡</option><option>昏迷</option>
            </select>
          </div>
          <div>
            <label>視力狀態</label>
            <select id="s1_vision" onchange="toggleVisionNotes()">
              <option>視力清晰</option>
              <option>靠近才能辨識</option>
              <option>即使配戴眼鏡，仍難以辨識</option>
              <option>僅能分辨明暗，無法辨識人臉或物體輪廓</option>
              <option>完全失去視覺功能，無法感知光線</option>
            </select>
          </div>
          <div>
            <label>視力補充</label>
            <div class="checkcol" id="s1_vision_note_box"></div>
            <input id="s1_vision_other" type="text" placeholder="其他說明" style="display:none; margin-top:6px;">
            <div id="s1_glasses_adherence_wrap" style="display:none; margin-top:6px;">
              <select id="s1_glasses_adherence">
                <option value="" class="placeholder-option" disabled selected>配戴情形</option>
                <option>常態配戴</option>
                <option>偶爾配戴</option>
                <option>不配戴</option>
              </select>
            </div>
            <div id="s1_vision_auto_hint" class="hint auto-hint" style="display:none; margin-top:6px;">
              <span>已依視力狀態預選建議補充（標記為「系統預選」）。</span>
              <button type="button" class="small" onclick="resetVisionSuggestions()">還原為預設</button>
            </div>
          </div>

          <!-- 聽力（新版：兩層） -->
          <div>
            <label>聽力程度</label>
            <select id="s1_hearing_level" onchange="renderHearingDetails()">
              <option>無明顯異常</option>
              <option>輕度受損</option>
              <option>中度受損</option>
              <option>重度受損</option>
              <option>極重度受損</option>
              <option>完全失聰</option>
            </select>
          </div>
          <div id="s1_hearing_detail_wrap" style="display:none;">
            <label>狀態說明（可複選）</label>
            <div class="checkcol" id="s1_hearing_detail_box"></div>
            <div id="s1_hearing_device_wrap" style="display:none; margin-top:6px;">
              <select id="s1_hearing_device_adherence">
                <option value="" class="placeholder-option" disabled selected>助聽／擴音依從性</option>
                <option>持續使用</option>
                <option>間斷使用</option>
                <option>不使用</option>
              </select>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>溝通語言／方式</label>
            <div class="checkcol" id="s1_lang_box"></div>
            <input id="s1_lang_note" type="text" placeholder="備註（例如：以台語為主）" style="margin-top:6px;">
          </div>
        </div>

        <div class="grid3">
          <div>
            <label>吞嚥／嗆咳</label>
            <select id="s1_swallow" onchange="toggleSwallow()">
              <option>無困難</option>
              <option>輕度</option>
              <option>明顯困難</option>
              <option>危險（需專評）</option>
            </select>
          </div>
          <div id="s1_swallow_sx_wrap" style="display:none;">
            <label>吞嚥症狀</label>
            <div id="s1_swallow_sx_hint" class="hint" style="display:none;">例：嗆咳、殘留、口水外漏等，勾選可快速完成紀錄。</div>
            <div class="checkcol" id="s1_swallow_sx_box"></div>
          </div>
          <div id="s1_diet_wrap" style="display:none;">
            <label>飲食質地（可複選）</label>
            <div class="checkcol" id="s1_diet_texture_box"></div>
            <label style="margin-top:12px; display:block;">管灌方式（可複選）</label>
            <div class="checkcol" id="s1_feeding_tube_box"></div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>口腔牙齒／假牙</label>
            <div class="checkcol" id="s1_oral_box"></div>
            <input id="s1_oral_note" type="text" placeholder="備註" style="margin-top:6px;">
          </div>
        </div>

        <div class="hr"></div>

        <!-- 疼痛 × 皮膚病灶（合併與連動） -->
        <div class="grid3">
          <div>
            <label>疼痛</label>
            <select id="s1_pain" onchange="togglePainCombined()">
              <option selected>無</option><option>有</option><option>未知</option>
            </select>
          </div>
          <div id="s1_pain_score_wrap" style="display:none;">
            <label>疼痛強度（1-10）</label>
            <input id="s1_pain_score" type="number" min="1" max="10" step="1">
            <div class="field-error" id="s1_pain_score_error"></div>
          </div>
        </div>

        <div id="s1_location_block" style="display:none;">
          <div class="location-toolbar" id="s1_location_toolbar" style="display:none;">
            <span class="location-current">目前編輯：<span id="s1_location_active_label">疼痛部位</span></span>
            <div class="location-switch btnbar">
              <button type="button" class="small" data-context="pain" onclick="switchLocationContext('pain')">編輯疼痛部位</button>
              <button type="button" class="small" data-context="lesion" onclick="switchLocationContext('lesion')">編輯病灶部位</button>
            </div>
            <div class="location-actions btnbar">
              <button type="button" class="small" id="location_copy_btn" onclick="copyLocationFromOther()">同疼痛部位</button>
            </div>
          </div>
          <div class="grid3">
            <div>
              <label>部位大分類</label>
              <select id="s1_location_region" onchange="onSharedRegionChange()">
                <option value="" class="placeholder-option" disabled selected>請選擇</option>
                <option>頭頸部</option><option>上肢</option><option>軀幹</option><option>下肢</option><option>全身性</option>
              </select>
            </div>
            <div>
              <label>細部分位</label>
              <select id="s1_location_subregion" onchange="onSharedSubregionChange()">
                <option value="" class="placeholder-option" disabled selected>請選擇</option>
              </select>
              <input id="s1_location_subregion_other" type="text" placeholder="請填寫其他部位" style="display:none; margin-top:6px;" oninput="onSharedSubregionOtherInput()">
            </div>
            <div>
              <label>側別</label>
              <select id="s1_location_laterality" onchange="onSharedLateralityChange()">
                <option value="" class="placeholder-option" disabled selected>請選擇</option>
                <option>左側</option><option>右側</option><option>雙側</option>
              </select>
            </div>
          </div>
        </div>

          <div class="grid3">
            <div>
              <label>皮膚病灶</label>
            <select id="s1_lesion_has" onchange="toggleLesionCombined()">
              <option selected>無</option><option>有</option><option>未知</option>
            </select>
          </div>
          <div id="s1_lesion_layer_wrap" style="display:none;">
            <label>病灶部位</label>
            <select id="s1_lesion_layer" onchange="toggleLesionLayerOther()">
              <option>無</option><option>表皮</option><option>皮下</option><option>關節附近</option><option>其他</option>
            </select>
            <input id="s1_lesion_layer_other" type="text" placeholder="請填寫" style="display:none; margin-top:6px;">
          </div>
          <div id="s1_lesion_size_wrap" style="display:none;">
            <label>病灶大小</label>
            <div class="lesion-size-grid">
              <div class="lesion-size-field">
                <input id="s1_lesion_length" type="number" min="0" step="0.1" placeholder="長" oninput="updateLesionAreaDisplay()">
                <span class="unit">cm</span>
              </div>
              <div class="lesion-size-field">
                <input id="s1_lesion_width" type="number" min="0" step="0.1" placeholder="寬" oninput="updateLesionAreaDisplay()">
                <span class="unit">cm</span>
              </div>
            </div>
            <div class="hint" id="s1_lesion_size_hint">請輸入長與寬，系統將即時計算面積。</div>
            <div class="lesion-area" id="s1_lesion_area_display">面積：— cm²</div>
            <div class="field-error" id="s1_lesion_size_error"></div>
          </div>
          <div class="field-error" id="s1_pain_location_error"></div>
        </div>

        <div id="s1_lesion_more" style="display:none;">
          <div class="row">
            <div>
              <label>病灶症狀</label>
              <div class="lesion-mode" id="s1_lesion_mode">
                <button type="button" class="small" data-mode="none" onclick="setLesionSymptomMode('none')">無不適</button>
                <button type="button" class="small" data-mode="symptom" onclick="setLesionSymptomMode('symptom')">有症狀</button>
              </div>
              <div class="checkcol" id="s1_lesion_sx_box"></div>
            </div>
            <div>
              <label>醫療評估</label>
              <select id="s1_lesion_eval" onchange="toggleLesionHospital()">
                <option>未評估</option><option>醫師評估無大礙</option><option>已安排追蹤</option><option>持續治療中</option>
              </select>
              <input id="s1_lesion_hospital" type="text" placeholder="醫療院所名稱" style="display:none; margin-top:6px;">
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- 移位/行走/樓梯 -->
        <div class="grid3">
          <div>
            <label>起身/移位</label>
            <select id="s1_transfer" onchange="toggleAdlHow('s1_transfer')">
              <option selected>獨立</option><option>需要輕扶</option><option>中度協助</option><option>重度協助</option><option>完全依賴</option>
            </select>
            <input id="s1_transfer_how" type="text" placeholder="請說明協助方式" style="display:none; margin-top:6px;" data-show-values="中度協助,重度協助">
          </div>
          <div>
            <label>室內行走</label>
            <select id="s1_walk_indoor">
              <option selected>無輔具緩慢</option><option>單拐</option><option>四腳拐</option><option>助行器</option><option>輪椅</option><option>無法</option>
            </select>
          </div>
          <div>
            <label>外出行走</label>
            <select id="s1_walk_outdoor">
              <option>獨立</option><option selected>單拐</option><option>四腳拐</option><option>助行器</option><option>輪椅</option><option>無法</option>
            </select>
          </div>
          <div>
            <label>上下樓</label>
            <select id="s1_stairs">
              <option>可獨立</option><option selected>需扶手</option><option>需人協助</option><option>無法</option>
            </select>
          </div>
          <div>
            <label>偏側無力</label>
            <select id="s1_weak_laterality">
              <option>無</option>
              <option>左側</option>
              <option>右側</option>
              <option>雙側</option>
            </select>
          </div>
          <div>
            <label>跌倒史</label>
            <select id="s1_fall_history" onchange="toggleFallDetail()">
              <option>無</option>
              <option>過去1年1次</option>
              <option>過去1年≧2次</option>
              <option>不明</option>
            </select>
            <input id="s1_fall_times" type="number" min="0" placeholder="次數" style="display:none; margin-top:6px;">
          </div>
          <div style="grid-column:1 / -1;">
            <label>平衡狀態</label>
            <div class="checkcol" id="s1_balance_box"></div>
          </div>
          <div>
            <label>坐姿穩定／輪椅安全</label>
            <select id="s1_sitting_stability" onchange="toggleSittingSupports()">
              <option value="" class="placeholder-option" disabled selected>請選擇</option>
              <option>穩定</option>
              <option>易前傾</option>
              <option>易滑落</option>
            </select>
            <div class="checkcol" id="s1_sitting_support_box" style="display:none; margin-top:6px;"></div>
          </div>
          <div>
            <label>步態</label>
            <select id="s1_gait">
              <option value="" class="placeholder-option" disabled selected>請選擇</option>
              <option>正常</option>
              <option>拖步</option>
              <option>小碎步</option>
              <option>步寬增大</option>
              <option>偏斜</option>
              <option>跨步不穩</option>
              <option>其他</option>
            </select>
            <input id="s1_gait_note" type="text" placeholder="備註" style="margin-top:6px;">
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>排泄輔具</label>
            <div class="checkcol" id="s1_excretion_aids_box"></div>
          </div>
        </div>

        <!-- ADL + 排泄 -->
        <div class="grid3" style="margin-top:8px;">
          <div>
            <label>進食</label>
            <select id="s1_adl_eating" onchange="toggleAdlHow('s1_adl_eating')">
              <option selected>獨立</option><option>部分協助</option><option>完全協助</option>
            </select>
            <input id="s1_adl_eating_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_adl_eating" data-required-label="進食的部分協助方式">
          </div>
          <div>
            <label>刷牙/洗臉</label>
            <select id="s1_adl_groom" onchange="toggleAdlHow('s1_adl_groom')">
              <option selected>獨立</option><option>部分協助</option><option>完全協助</option>
            </select>
            <input id="s1_adl_groom_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_adl_groom" data-required-label="刷牙/洗臉的部分協助方式">
          </div>
          <div>
            <label>洗澡</label>
            <select id="s1_adl_bathing" onchange="toggleAdlHow('s1_adl_bathing')">
              <option selected>獨立</option><option>部分協助</option><option>完全協助</option>
            </select>
            <input id="s1_adl_bathing_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_adl_bathing" data-required-label="洗澡的部分協助方式">
          </div>
          <div>
            <label>穿脫衣</label>
            <select id="s1_adl_dressing" onchange="toggleAdlHow('s1_adl_dressing')">
              <option selected>獨立</option><option>部分協助</option><option>完全協助</option>
            </select>
            <input id="s1_adl_dressing_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_adl_dressing" data-required-label="穿脫衣的部分協助方式">
          </div>
          <div>
            <label>白天排尿</label>
            <select id="s1_urine_day" onchange="toggleUrineOther('day')">
              <option selected>正常（4–6次）</option><option>偏少（少於3次）</option><option>偏多（7–9次）</option><option>失禁</option><option>其他</option>
            </select>
            <input id="s1_urine_day_other" type="text" placeholder="請說明" style="display:none; margin-top:6px;">
          </div>
          <div id="s1_urine_night_wrap">
            <label>夜間排尿</label>
            <select id="s1_urine_night" onchange="toggleUrineOther('night')">
              <option selected>夜間未起夜</option><option>夜間起夜1次</option><option>夜間起夜2–3次</option><option>夜間起夜≥4次</option><option>夜間有尿失禁</option><option>其他</option>
            </select>
            <input id="s1_urine_night_other" type="text" placeholder="請說明" style="display:none; margin-top:6px;">
          </div>
          <div id="s1_nocturia_wrap" style="display:none;">
            <label>夜尿數值</label>
            <input id="s1_nocturia_count" type="number" min="0" max="10" placeholder="0-10">
          </div>
          <div id="s1_night_catheter_note" class="hint" style="display:none; grid-column:1 / -1;">夜間以導尿／集尿袋處理，不以起夜次數評估</div>
          <div>
            <label>如廁後清潔</label>
            <select id="s1_post_toilet" onchange="toggleAdlHow('s1_post_toilet')">
              <option selected>獨立</option><option>部分協助</option><option>完全協助</option>
            </select>
            <input id="s1_post_toilet_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_post_toilet" data-required-label="如廁後清潔的部分協助方式">
          </div>
        </div>

        <div class="hr"></div>

        <!-- 生活管理/社會參與 -->
        <div class="grid3">
          <div>
            <label>電話使用</label>
            <select id="s1_phone" onchange="togglePhoneNotes()">
              <option selected>會撥打與接聽</option><option>僅能接聽</option><option>不會使用</option>
            </select>
            <div id="s1_phone_note_wrap" style="display:none; margin-top:6px;">
              <div class="checkcol" id="s1_phone_note_box"></div>
              <input id="s1_phone_note_other" type="text" placeholder="其他說明" style="display:none; margin-top:6px;">
            </div>
          </div>
          <div>
            <label>外出購物</label>
            <select id="s1_shopping" onchange="toggleShoppingHow()">
              <option>可獨立</option><option selected>需陪同</option><option>不外出</option>
            </select>
            <select id="s1_shopping_how" style="display:none; margin-top:6px;" onchange="toggleShoppingHow()">
              <option value="" class="placeholder-option" disabled selected>方式/說明</option>
              <option>家屬陪同購物</option><option>由家屬代購</option><option>使用外送平台</option><option>居服員陪同／代購</option><option>外看（看護／志工）代購</option><option>其他</option>
            </select>
            <input id="s1_shopping_how_other" type="text" placeholder="請說明" style="display:none; margin-top:6px;">
          </div>
          <div>
            <label>備餐</label>
            <select id="s1_meal_prep" onchange="toggleAdlHow('s1_meal_prep')">
              <option>獨立</option><option selected>部分協助</option><option>完全由家屬</option>
            </select>
            <input id="s1_meal_prep_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_meal_prep" data-required-label="備餐的部分協助方式">
          </div>
          <div>
            <label>餐具清洗</label>
            <select id="s1_dishwash" onchange="toggleDishwashHow()">
              <option>乾淨</option><option selected>尚可或不一定乾淨</option><option>無法自行清洗</option>
            </select>
            <select id="s1_dishwash_how" style="display:none; margin-top:6px;" onchange="toggleDishwashHow()">
              <option>由他人代辦</option><option>其他</option>
            </select>
            <input id="s1_dishwash_how_other" type="text" placeholder="請說明" style="display:none; margin-top:6px;">
          </div>
          <div>
            <label>家務整理</label>
            <select id="s1_housework" onchange="toggleAdlHow('s1_housework')">
              <option>獨立</option><option selected>部分協助</option><option>完全由家屬</option>
            </select>
            <input id="s1_housework_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_housework" data-required-label="家務整理的部分協助方式">
          </div>
          <div>
            <label>財務管理</label>
            <select id="s1_finance" onchange="toggleAdlHow('s1_finance')">
              <option selected>獨立</option><option>部分協助</option><option>他人代辦</option>
            </select>
            <input id="s1_finance_how" type="text" placeholder="部分協助方式" style="display:none; margin-top:6px;" data-required-when="partial" data-required-source="s1_finance" data-required-label="財務管理的部分協助方式">
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>情緒／行為（可複選）</label>
            <div class="checkcol" id="s1_mood_behaviors_box"></div>
          </div>
          <div>
            <label>執行動機／需督促</label>
            <select id="s1_motivation">
              <option value="" class="placeholder-option" disabled selected>請選擇</option>
              <option>主動配合</option>
              <option>需提醒／督促</option>
              <option>拒絕／抗拒</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label>管路／裝置</label>
            <div class="checkcol" id="s1_devices_box"></div>
            <input id="s1_devices_note" type="text" placeholder="備註" style="margin-top:6px;">
          </div>
        </div>

        <div class="grid3" style="margin-top:8px;">
          <div>
            <label>睡眠品質</label>
            <select id="s1_sleep" onchange="toggleSleepReason()">
              <option>良好</option><option>尚可</option><option selected>不佳</option>
            </select>
            <select id="s1_sleep_reason" style="display:none; margin-top:6px;" onchange="toggleSleepReasonDetail()">
              <option value="" class="placeholder-option" disabled selected>失眠原因</option>
              <option>疼痛</option>
              <option>頻尿</option>
              <option>慢性疾病</option>
              <option>焦慮、憂鬱</option>
              <option>生活壓力</option>
              <option>環境干擾</option>
              <option>不良睡眠習慣</option>
              <option>日夜顛倒</option>
              <option>藥物影響</option>
              <option>咖啡因</option>
              <option>酒精</option>
              <option>其他</option>
            </select>
            <select id="s1_sleep_reason_detail" style="display:none; margin-top:6px;"></select>
            <input id="s1_sleep_reason_other" type="text" placeholder="請說明" style="display:none; margin-top:6px;">
          </div>
          <div>
            <label>白天活動（選填）</label>
            <input id="s1_daytime" type="text" placeholder="例：坐後門外看電視，累了打盹">
          </div>
        </div>

        <div class="hr"></div>

        <!-- 疾病/用藥/就醫 -->
        <div class="row">
          <div>
            <label>慢性病史</label>
            <div class="checkcol" id="s1_dhx_box"></div>
            <input id="s1_dhx_other" type="text" placeholder="其他慢性病" style="display:none; margin-top:6px;">
          </div>
        </div>
        <div class="grid3">
          <div><label>手術史（選填）</label><input id="s1_surgery" type="text" placeholder="例：10多年前髖關節手術"></div>
          <div><label>藥物過敏（選填）</label><input id="s1_allergy" type="text" placeholder="無則留空"></div>
          <div><label>固定就醫單位</label><input id="s1_follow_clinic" type="text" placeholder="例：嘉誠診所"></div>
          <div>
            <label>處方型態</label>
            <select id="s1_rx_type"><option>慢性處方箋</option><option>一般門診</option></select>
          </div>
          <div>
            <label>用藥管理</label>
            <select id="s1_med_manage">
              <option>可自行規則服藥</option><option>需提醒</option><option>他人給藥</option>
            </select>
          </div>
          <div>
            <label>就醫交通</label>
            <select id="s1_visit_transport" onchange="toggleTransportOther()">
              <option>計程車</option><option>家屬接送</option><option>交通接送服務</option><option>其他</option>
            </select>
            <input id="s1_visit_transport_other" type="text" placeholder="請填寫其他交通方式" style="display:none; margin-top:6px;">
          </div>
        </div>
        <div class="row">
          <div>
            <label>現用藥別</label>
            <div class="checkcol" id="s1_med_classes_box"></div>
            <input id="s1_med_classes_other" type="text" placeholder="其他用藥" style="display:none; margin-top:6px;">
          </div>
        </div>

        <div class="hr"></div>

        <!-- 身障資訊（與經濟收入連動） -->
        <div class="grid2"><!-- 兩欄排版 -->
          <div><!-- 等級欄位 -->
            <label>身障等級</label>
            <div id="s1_dis_level_text" class="badge">—</div>
          </div>
          <div id="s1_dis_cat_box" style="display:none;"><!-- 類別欄位，預設隱藏 -->
            <label>身障類別</label>
            <div id="s1_dis_cat_text" class="badge">—</div>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">身障資訊同步自(二)經濟收入，此處為唯讀顯示。</div>

        <div class="hr"></div>

        <!-- 補充內容 + 預覽（自動產文） -->
        <div class="titlebar" style="margin-top:18px;">
          <label>建議措施（已完成之提醒／安排）</label>
          <button type="button" class="small" onclick="addActionEntry()">＋新增</button>
        </div>
        <div id="s1_actions_list" class="action-list"></div>
        <div class="hint" id="s1_actions_hint" style="display:none;">尚未新增建議措施。</div>
        <div class="field-error" id="s1_actions_error"></div>
        <label>補充內容（選填）</label>
        <textarea id="s1_notes" placeholder="其他未涵蓋重點（限簡要）；將附加於段落末端。"></textarea>
        <textarea id="section1_out" style="display:none;"></textarea>
        <div id="section1_errors" class="error-messages"></div>
        <div class="hint" style="margin-top:6px;">預覽（重組後）：</div>
        <div id="section1_preview" class="preview"></div>
      </div>
    </div>

    <!-- (二) 經濟收入（原功能保留） -->
    <div class="row">
      <div>
        <div class="titlebar">
          <label>(二) 經濟收入</label>
        </div>
        <div class="grid2">
          <div>
            <label>主要經濟來源</label>
            <div class="checkcol" id="s2_sources"></div>
          </div>
          <div>
            <label>戶籍/福利身分</label>
            <select id="s2_id">
              <option>一般戶</option><option>中低收入戶</option><option>低收入戶</option>
            </select>
          </div>
          <div><!-- 等級欄位 -->
            <label>身障等級</label>
            <select id="s2_dis_level" onchange="syncDisab()"><!-- 選擇身障等級 -->
              <option>無</option><option>輕度</option><option>中度</option><option>重度</option><option>極重度</option>
            </select>
          </div>
          <div id="disCatBox" style="display:none;"><!-- 類別欄位，預設隱藏 -->
            <label>身障類別（等級≠無才需選）</label>
            <select id="s2_dis_cat" onchange="syncDisab()"><!-- 選擇身障類別 --></select>
          </div>
        </div>
        <textarea id="section2_out" style="display:none;"></textarea>
      </div>
    </div>

    <!-- (三) 居住環境（原功能保留） -->
    <div class="row">
      <div>
        <div class="titlebar">
          <label>(三) 居住環境</label>
        </div>
        <div class="grid3">
          <div>
            <label>居住型態</label>
            <select id="s3_type" onchange="toggleOtherType()">
              <option>透天</option><option>鐵皮屋</option><option>公寓</option><option>大樓</option><option>套房</option><option>其他</option>
            </select>
            <input id="s3_type_other" type="text" placeholder="請輸入其他型態" style="display:none; margin-top:6px;">
          </div>
          <div>
            <label>居住權屬</label>
            <select id="s3_own" onchange="toggleRentFields()"><option>自有</option><option>租賃</option><option>借住</option></select>
          </div>
          <div id="s3_rent_amount_wrap" style="display:none;">
            <label>租金金額（元/月）</label>
            <input id="s3_rent_amount" type="number" min="0" placeholder="例：12000">
          </div>
          <div id="s3_rent_fee_wrap" style="display:none;">
            <label>是否含管理費</label>
            <select id="s3_rent_fee">
              <option value="" class="placeholder-option" disabled selected>請選擇</option>
              <option value="含管理費">含管理費</option>
              <option value="不含管理費">不含管理費</option>
            </select>
          </div>
          <div>
            <label>整潔度</label>
            <select id="s3_clean"><option>非常整潔</option><option>整潔</option><option>尚可</option><option>需改善</option><option>髒亂</option></select>
          </div>
          <div>
            <label>異味</label>
            <select id="s3_smell"><option>無</option><option>輕微</option><option>明顯</option></select>
          </div>
          <div>
            <label>無障礙設施</label>
            <div class="checkcol" id="s3_fac"></div>
          </div>
          <div>
            <label>輔具</label>
            <div class="checkcol" id="s3_aids"></div>
          </div>
        </div>
        <textarea id="section3_out" style="display:none;"></textarea>
      </div>
    </div>

    <!-- (四) 社會支持（原功能保留） -->
    <div class="row">
      <div>
        <div class="titlebar">
          <label>(四) 社會支持</label>
        </div>

        <div class="grid2">
          <div>
            <label>主照者關係</label>
            <div id="sp_primaryRel_text" class="badge">—</div>
          </div>
          <div>
            <label>主照者姓名</label>
            <div id="sp_primaryName_text" class="badge">—</div>
          </div>
          <div>
            <label>同住狀態</label>
            <select id="sp_cohabit"><option value="">—不選—</option><option>同住</option><option>不同住</option></select>
          </div>
        </div>


        <div class="hr"></div>

        <div class="titlebar" style="margin-top:12px;">
          <label>主要聯繫人/決策者</label>
          <button type="button" class="small" onclick="copyFromH1Primary()">設為主照者</button>
        </div>
        <div class="grid2">
          <div>
            <label>關係</label>
            <select id="sp_deciderRel">
              <option value="">—不選—</option>
              <optgroup label="配偶"><option>案妻</option><option>案夫</option></optgroup>
              <optgroup label="子女"><option>案長子</option><option>案次子</option><option>案長女</option><option>案次女</option></optgroup>
              <optgroup label="父母"><option>案父</option><option>案母</option></optgroup>
              <optgroup label="手足"><option>案兄</option><option>案姊</option><option>案弟</option><option>案妹</option></optgroup>
              <optgroup label="姻親"><option>案媳</option><option>案女婿</option></optgroup>
              <optgroup label="孫輩"><option>案孫</option><option>案孫女</option></optgroup>
              <optgroup label="自訂"><option>自訂角色</option></optgroup>
            </select>
          </div>
          <div>
            <label>姓名</label>
            <input id="sp_deciderName" type="text" placeholder="請選擇">
          </div>
          <div style="grid-column:1 / -1;">
            <label>聯絡電話</label>
            <input id="sp_deciderPhone" type="tel" placeholder="例如：0912-345678">
          </div>
        </div>

        <div class="hr"></div>

        <label>共同照顧者（可多筆）</label>
        <div id="coCare"></div>
        <div class="btnbar"><button class="small" onclick="addCoCare()">＋新增共同照顧者</button></div>

        <div class="hr"></div>

        <div>
          <label>正式資源（多選）</label>
          <div class="muted">固定：<span class="badge">社區整合型服務中心為福安</span></div>
          <div class="checkcol" id="sp_formal"></div>
          <div id="homeCareWrap" style="display:none; margin-top:8px;">
            <div class="titlebar">
              <label>居家服務項目（多選）</label>
              <button class="small" type="button" onclick="resetCareServicePhrases()">重新套用片語</button>
            </div>
            <div id="homeCareList" class="home-care-grid"></div>
            <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整；如需記錄用量，請於右側欄位輸入數量。</div>
          </div>
          <div id="dayCareWrap" style="display:none; margin-top:8px;">
            <div class="titlebar">
              <label>日間照顧服務項目（多選）</label>
              <button class="small" type="button" onclick="resetCareServicePhrases()">重新套用片語</button>
            </div>
            <div id="dayCareList" class="home-care-grid"></div>
            <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
          </div>
          <div id="profServiceWrap" style="display:none; margin-top:8px;">
            <div class="titlebar">
              <label>專業服務項目（多選）</label>
              <button class="small" type="button" onclick="resetProfessionalPhrases()">重新套用片語</button>
            </div>
            <div id="profServiceList" class="home-care-grid"></div>
            <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
          </div>
          <div id="transportServiceWrap" style="display:none; margin-top:8px;">
            <div class="titlebar">
              <label>交通接送項目（多選）</label>
              <button class="small" type="button" onclick="resetTransportPhrases()">重新套用片語</button>
            </div>
            <div id="transportServiceList" class="home-care-grid"></div>
            <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
          </div>
          <div id="respServiceWrap" style="display:none; margin-top:8px;">
            <div class="titlebar">
              <label>喘息服務項目（多選）</label>
              <button class="small" type="button" onclick="resetRespitePhrases()">重新套用片語</button>
            </div>
            <div id="respServiceList" class="home-care-grid"></div>
            <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
          </div>
          <div id="mealServiceWrap" style="display:none; margin-top:8px;">
            <div class="titlebar">
              <label>營養送餐項目（多選）</label>
              <button class="small" type="button" onclick="resetMealPhrases()">重新套用片語</button>
            </div>
            <div id="mealServiceList" class="home-care-grid"></div>
            <div class="subtle">勾選後將自動套用至短/中期目標及長期彙整。</div>
          </div>
        </div>

        <div class="hr"></div>

        <div>
          <label>非正式資源（多選，每類需填「單位名稱」）</label>
          <div>
            <label class="inline"><input type="checkbox" id="sp_inf_pt" onchange="toggleInfInput('pt')"> 據點</label>
            <input id="sp_inf_pt_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
            <select id="sp_inf_pt_freq" style="display:none; margin-top:6px;"><!-- 據點頻率 -->
            <option value="">—請選擇頻率—</option>
            <option>每週</option>
            <option>每月</option>
            <option>不定期</option>
            <option>未知</option>
          </select>

          </div>
          <div>
            <label class="inline"><input type="checkbox" id="sp_inf_nb" onchange="toggleInfInput('nb')"> 鄰里</label>
            <input id="sp_inf_nb_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
            <select id="sp_inf_nb_freq" style="display:none; margin-top:6px;"><!-- 鄰里頻率 -->
            <option value="">—請選擇頻率—</option>
            <option>每週</option>
            <option>每月</option>
            <option>不定期</option>
            <option>未知</option>
          </select>

          </div>
          <div>
            <label class="inline"><input type="checkbox" id="sp_inf_rg" onchange="toggleInfInput('rg')"> 宗教/社團</label>
            <input id="sp_inf_rg_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
            <select id="sp_inf_rg_freq" style="display:none; margin-top:6px;"><!-- 宗教社團頻率 -->
            <option value="">—請選擇頻率—</option>
            <option>每週</option>
            <option>每月</option>
            <option>不定期</option>
            <option>未知</option>
          </select>

          </div>
          <div>
            <label class="inline"><input type="checkbox" id="sp_inf_fw" onchange="toggleInfInput('fw')"> 財團/社會福利</label>
            <input id="sp_inf_fw_name" type="text" placeholder="單位名稱，可多個以、分隔" style="display:none;">
            <select id="sp_inf_fw_freq" style="display:none; margin-top:6px;"><!-- 財團頻率 -->
            <option value="">—請選擇頻率—</option>
            <option>每週</option>
            <option>每月</option>
            <option>不定期</option>
            <option>未知</option>
          </select>

          </div>
        </div>

        <div class="hr"></div>
        <div>
          <label>高風險評估（多選）</label>
          <div class="checkcol" id="sp_risks"></div>
          <div class="subtle">勾選將只輸出「標題短語」，說明文字僅作參考。</div>
        </div>

        <textarea id="section4_out" style="display:none;"></textarea>
      </div>
    </div>

    <!-- (五) 其他 -->
    <div class="row">
      <div>
        <div class="titlebar">
          <label>(五) 其他</label>
        </div>
        <textarea id="section5" placeholder="如個案成長背景、職業、生活習慣、價值觀等。"></textarea>
      </div>
    </div>

    <!-- (六) 複評評值 -->
    <div class="row">
      <div>
        <div class="titlebar">
          <label>(六) 複評評值</label>
        </div>
        <div class="grid2">
          <div><label>介入前</label><textarea id="s6_before" placeholder="如果為新評，則無需輸入"></textarea></div>
          <div><label>介入後</label><textarea id="s6_after" placeholder="如果為新評，則無需輸入"></textarea></div>
        </div>
        <textarea id="section6_struct" style="display:none;"></textarea>
      </div>
    </div>
  </div>

  <!-- 五、照顧目標（原功能保留） -->
  <div class="group">
    <label>五、照顧目標</label>

    <div class="row"><div>
      <label>(一) 照顧問題（最多選 5 項）</label>
      <div class="checkcol" id="problemList"></div>
      <div class="count" id="problemCount">已選 0 / 5</div>
      <label style="margin-top:8px;">補充說明（可選）</label>
      <textarea id="problemNote" placeholder="例如：近期以移位與吞嚥為優先風險…"></textarea>
    </div></div>

    <div class="row"><div>
      <label>(二) 短期目標(0-3個月)</label>
      <div class="grid2">
        <div id="short_care_wrap"><label>照顧服務：</label><textarea id="short_care" placeholder="填寫欄位"></textarea></div>
        <div id="short_prof_wrap"><label>專業服務：</label><textarea id="short_prof" placeholder="填寫欄位"></textarea></div>
        <div id="short_car_wrap"><label>交通接送：</label><textarea id="short_car"  placeholder="填寫欄位"></textarea></div>
        <div id="short_resp_wrap"><label>喘息服務：</label><textarea id="short_resp" placeholder="填寫欄位"></textarea></div>
        <div id="short_access_wrap"><label>無障礙及輔具：</label><textarea id="short_access" placeholder="填寫欄位"></textarea></div>
        <div id="short_meal_wrap"><label>營養送餐：</label><textarea id="short_meal" placeholder="填寫欄位"></textarea></div>
      </div>
    </div></div>

    <div class="row"><div>
      <label>(三) 中期目標(3-4個月)</label>
      <div class="grid2">
        <div id="mid_care_wrap"><label>照顧服務：</label><textarea id="mid_care" placeholder="填寫欄位"></textarea></div>
        <div id="mid_prof_wrap"><label>專業服務：</label><textarea id="mid_prof" placeholder="填寫欄位"></textarea></div>
        <div id="mid_car_wrap"><label>交通接送：</label><textarea id="mid_car"  placeholder="填寫欄位"></textarea></div>
        <div id="mid_resp_wrap"><label>喘息服務：</label><textarea id="mid_resp" placeholder="填寫欄位"></textarea></div>
        <div id="mid_access_wrap"><label>無障礙及輔具：</label><textarea id="mid_access" placeholder="填寫欄位"></textarea></div>
        <div id="mid_meal_wrap"><label>營養送餐：</label><textarea id="mid_meal" placeholder="填寫欄位"></textarea></div>
      </div>
    </div></div>

    <div class="row"><div>
      <label>(四) 長期目標(4-6個月)</label>
      <textarea id="long_goal" placeholder="將由短/中期彙整自動填入；可再微調。"></textarea>
      <div class="hr"></div>
      <label>目標文字預覽（含碼別與各期結構）</label>
      <div id="goalPreview" class="preview goal-preview-empty">（尚未選擇服務或填寫內容）</div>
    </div></div>
  </div>

  <!-- 六、與照專…（原功能保留） -->
  <div class="group">
    <label>六、與照專建議服務項目、問題清單不一致原因說明及未來規劃、後續追蹤計劃</label>
    <div class="row"><div>
      <label>1. 目標達成的狀況以及未達成的差距</label>
      <textarea id="reason1" placeholder="填寫欄位"></textarea>
    </div></div>
    <div class="row"><div>
      <label>2. 資源的變動情形</label>
      <textarea id="reason2" placeholder="填寫欄位"></textarea>
    </div></div>
    <div class="row"><div>
      <label>3. 未使用的替代方案或是可能的影響</label>
      <textarea id="reason3" placeholder="填寫欄位"></textarea>
      <div class="hr"></div>
      <label>常用快捷（勾選即加入第 3 格）</label>
      <div style="margin:6px 0;">
        <input id="rq1_no" type="text" placeholder="原服務，例如：備餐" style="margin-right:4px;">
        <input id="rq1_alt" type="text" placeholder="替代服務，例如：代購服務">
      </div>
      <label><input type="checkbox" id="rq1"> 1.經與<span id="rq1_who">案○</span>討論，目前暫無<span id="rq1_no_preview" data-def="備餐">備餐</span>之需求，改為<span id="rq1_alt_preview" data-def="代購服務">代購服務</span>。</label>
      <div style="margin:6px 0;">
        <input id="rq2_service" type="text" placeholder="服務，例如：專業服務">
      </div>
      <label><input type="checkbox" id="rq2"> 2.經與<span id="rq2_who">案○</span>討論，目前因個案身體狀況，暫無<span id="rq2_service_preview" data-def="專業服務">專業服務</span>需求，日後待個案狀況好轉後，依當下狀況核定，續追蹤。</label>
      <div id="mismatch_diff_block" style="display:none; margin-top:12px;">
        <div class="hint" id="mismatch_diff_text">與照專建議服務不一致項目：</div>
        <div class="mismatch-diff" id="mismatch_diff_list"></div>
        <div class="checkcol" id="mismatch_reason_box"></div>
        <input id="mismatch_reason_other" type="text" placeholder="請說明其他原因" style="display:none; margin-top:6px;">
        <div class="field-error" id="mismatch_reason_error"></div>
      </div>
    </div></div>
  </div>

  </div>

  <div class="page-section" data-page="execution">
  <div class="group">
    <label>計畫執行規劃</label>
    <div class="hint">請針對核定之服務填寫頻率、使用方式或案主期待，系統將依格式預覽全文。</div>
    <div id="planEditor" class="plan-editor"></div>
    <div class="plan-meta">
      <div>
        <label>轉介資源補充（選填）</label>
        <textarea id="plan_referral_extra" placeholder="例：慈濟資源站－已聯繫，提供物資協助"></textarea>
      </div>
      <div>
        <label>巷弄長照站資訊（例：站名／地址／電話／距離）</label>
        <textarea id="plan_station_info" placeholder="例：○○巷弄長照站（地址，距離1.2公里，電話0000-000000）"></textarea>
      </div>
      <div>
        <label>巷弄長照站意願</label>
        <select id="plan_station_willingness">
          <option value="">—請選擇—</option>
          <option value="有意願">有意願</option>
          <option value="無意願">無意願</option>
        </select>
      </div>
      <div>
        <label>緊急救援服務說明</label>
        <textarea id="plan_emergency_note" placeholder="例：申請○○緊急救援系統，因跌倒風險與夜間頻繁起夜"></textarea>
      </div>
    </div>
  </div>
  </div>

  <div class="page-section" data-page="notes">
  <div class="group">
    <label>附件預覽</label>
    <div class="hint">預覽（可複製貼上至計畫執行規劃頁面）：</div>
    <textarea id="plan_text" class="plan-preview" readonly></textarea>
    <div class="hr"></div>
      <div class="summary-section">
        <div class="summary-title">服務計畫明細預覽（附件二）</div>
        <div id="planSummaryTotals" class="plan-summary-totals">
          <div class="plan-summary-total-card">
            <div class="plan-summary-total-label">CMS 等級月額度</div>
            <div class="plan-summary-total-value" id="planSummaryCap">—</div>
          </div>
          <div class="plan-summary-total-card">
            <div class="plan-summary-total-label">B/C 預估耗用</div>
            <div class="plan-summary-total-value" id="planSummaryUsage">—</div>
          </div>
          <div class="plan-summary-total-card">
            <div class="plan-summary-total-label">預估餘額</div>
            <div class="plan-summary-total-value" id="planSummaryRemaining">—</div>
          </div>
        </div>
        <div id="planSummaryTotalsHint" class="plan-summary-totals-hint" data-show="0"></div>
        <div id="planSummaryPreview" class="summary-table-wrapper">
          <div class="hint">尚未選擇服務項目。</div>
        </div>
      </div>
  </div>

  <!-- 動作 -->
  <div class="group">
    <div class="btnbar">
      <button class="primary" onclick="applyAndSave()">產出（複製/升版並開啟新檔）</button>
    </div>
    <div id="msg" class="hint" style="margin-top:8px;"></div>
  </div>
  </div>
  </div>

  <script>
    /* ===== 日期工具 ===== */
    function toYMD(d){const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2);return `${y}-${m}-${da}`;}
    function parseDateInput(value){
      if(!value) return null;
      const parts=String(value).split('-');
      if(parts.length!==3) return null;
      const y=Number(parts[0]), m=Number(parts[1]), da=Number(parts[2]);
      if(!y || !m || !da) return null;
      const date=new Date(y, m-1, da);
      if(Number.isNaN(date.getTime())) return null;
      return date;
    }
    function setDateBox(id,d){
      if(!(d instanceof Date) || Number.isNaN(d.getTime())) return;
      const text=toYMD(d);
      const input=document.getElementById(id);
      if(input) input.value=text;
    }
    function getDateBox(id){
      const input=document.getElementById(id);
      return input && input.value ? input.value : '';
    }
    function shiftDate(id,delta){
      const cur=getDateBox(id);
      const base=cur?parseDateInput(cur):new Date();
      if(!base) return;
      base.setDate(base.getDate()+delta);
      setDateBox(id,base);
    }
    function attachDateInputEvents(id){
      const input=document.getElementById(id);
      if(!input) return;
      input.setAttribute('title','↑/↓ ±1 天，Shift+↑/↓ ±5 天');
      input.addEventListener('keydown', ev=>{
        if(ev.key==='ArrowUp' || ev.key==='ArrowDown'){
          const step = ev.shiftKey ? 5 : 1;
          const delta = ev.key==='ArrowUp' ? step : -step;
          shiftDate(id, delta);
          ev.preventDefault();
        }
      });
    }
    function openDatePicker(id){
      const input=document.getElementById(id);
      if(!input) return;
      if(typeof input.showPicker === 'function'){
        input.showPicker();
      }else{
        input.focus();
        input.click();
      }
    }
    function initDateInputs(){
      ['callDate','visitDate','dischargeDate'].forEach(attachDateInputEvents);
    }
    function toggleDischarge(){const on=document.getElementById('isDischarge').checked; document.getElementById('dischargeBox').style.display=on?'':'none'; if(on&&!getDateBox('dischargeDate')) setDateBox('dischargeDate', new Date());}
    function updateConsultVisitText(){
      const box=document.getElementById('consultVisitText');
      if(!box) return;
      const caseName=(document.getElementById('caseName').value||'').trim();
      const consultName=(document.getElementById('consultName').value||'').trim();
      const caseDisplay=caseName||'未填個案姓名';
      const consultDisplay=consultName||'未選擇照專';
      box.textContent=`本案(${caseDisplay}) 由照顧專員(${consultDisplay})進行約訪`;
    }
    function toggleCallDateByConsultVisit(){
      const input=document.getElementById('isConsultVisit');
      const controls=document.getElementById('callDateControls');
      const box=document.getElementById('consultVisitText');
      if(!input) return;
      const on=input.checked;
      if(controls) controls.style.display=on?'none':'';
      if(box){
        if(on){
          updateConsultVisitText();
          box.style.display='';
        }else{
          box.style.display='none';
        }
      }
    }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, function(ch){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch] || ch;
      });
    }
    function renderOutputMessage(res){
      const box=document.getElementById('msg');
      if(!box) return;
      if(res && res.file && res.file.url){
        const messageText = res && res.message ? escapeHtml(res.message) : '已建立新檔';
        const safeUrl = escapeHtml(res.file.url);
        const safeName = escapeHtml(res.file.name || '新文件');
        box.innerHTML = `${messageText} → <a href="${safeUrl}" target="_blank" rel="noopener">${safeName}</a> <button type="button" class="small" data-url="${safeUrl}" onclick="openProducedFile(this.dataset.url)">開啟</button>`;
      }else{
        box.textContent = res && res.message ? res.message : '';
      }
    }
    function openProducedFile(url){
      if(!url) return;
      const opened = window.open(url, '_blank');
      if(opened){ opened.opener = null; }
    }
    function nl2br(str){
      if(!str) return '';
      return escapeHtml(str).replace(/\n/g,'<br>');
    }

    /* ===== 個管師名單 ===== */
    function loadManagers(){
      const unit=document.getElementById('unitCode').value;
      google.script.run.withSuccessHandler(list=>{
        const sel=document.getElementById('caseManagerName'); sel.innerHTML='';
        (list && list.length? list : ['（無資料）']).forEach(n=>{const o=document.createElement('option'); o.textContent=n; sel.appendChild(o);});
        buildApprovalPlanPreview();
      }).getCaseManagersByUnit(unit);
    }

    /* ===== 照專名單 ===== */
    function loadConsultants(){
      const unit = document.getElementById('unitCode').value;
      google.script.run.withSuccessHandler(list=>{
        const sel = document.getElementById('consultName');
        sel.innerHTML='';
        (list && list.length ? list : ['（無資料）']).forEach(n=>{const o=document.createElement('option'); o.textContent=n; sel.appendChild(o);}); sel.selectedIndex=0;
        updateConsultVisitText();
        toggleCallDateByConsultVisit();
      }).getConsultantsByUnit(unit);
    }

    /* ===== 三、偕同訪視者（下拉＋多筆） ===== */
    let extraIdx=0, coCareIdx=0;
    function roleOptionsHTML(withPlaceholder=true){
      return `
        ${withPlaceholder ? '<option value="" class="placeholder-option" disabled selected>請選擇</option>' : ''}
        <optgroup label="配偶"><option>案妻</option><option>案夫</option></optgroup>
        <optgroup label="子女"><option>案長子</option><option>案次子</option><option>案長女</option><option>案次女</option></optgroup>
        <optgroup label="父母"><option>案父</option><option>案母</option></optgroup>
        <optgroup label="手足"><option>案兄</option><option>案姊</option><option>案弟</option><option>案妹</option></optgroup>
        <optgroup label="姻親"><option>案媳</option><option>案女婿</option></optgroup>
        <optgroup label="孫輩"><option>案孫</option><option>案孫女</option></optgroup>
        <optgroup label="自訂"><option>自訂角色</option></optgroup>`;
    }
    function addExtraRow(){
      const host=document.getElementById('extras');
      const idx=extraIdx++;
      const wrap=document.createElement('div');
      wrap.className='row'; wrap.id=`extra-${idx}`;
      wrap.innerHTML=`
        <div>
          <label>角色</label>
          <select id="ex-role-${idx}" onchange="toggleCustomRole(${idx}, 'ex')">
            ${roleOptionsHTML(true)}
          </select>
          <input id="ex-custom-${idx}" type="text" placeholder="自訂角色" style="display:none; margin-top:6px;">
        </div>
        <div>
          <label>姓名</label>
          <input id="ex-name-${idx}" type="text" placeholder="姓名，例如：李○○">
        </div>
        <div style="flex:0; align-self:flex-end;">
          <button class="small" onclick="removeExtraRow(${idx})">移除</button>
        </div>`;
      host.appendChild(wrap);
      enforcePrimaryExclusionOnSelect(document.getElementById(`ex-role-${idx}`));
      updateParticipantConflictHint();
    }
    function toggleCustomRole(idx, prefix){
      const sel=document.getElementById(`${prefix}-role-${idx}`), custom=document.getElementById(`${prefix}-custom-${idx}`);
      const isCustom= sel && sel.value==='自訂角色'; if(custom) custom.style.display= isCustom?'':'none';
    }
    function removeExtraRow(idx){
      const el=document.getElementById(`extra-${idx}`);
      if(el) el.remove();
      updateParticipantConflictHint();
    }
    function enforcePrimaryExclusionOnSelect(sel){
      if(!sel) return;
      const primary = document.getElementById('primaryRel').value;
      [...sel.options].forEach(opt=>{
        if(!opt.value) return; // placeholder
        opt.disabled = (primary && opt.value===primary);
      });
      // 若當前選到與主照者相同，重置為 placeholder
      if(primary && sel.value===primary){
        sel.selectedIndex = 0;
      }
    }
    function enforcePrimaryExclusionOnExtras(){
      document.querySelectorAll('[id^="ex-role-"]').forEach(enforcePrimaryExclusionOnSelect);
      updateParticipantConflictHint();
    }
    function computeParticipantConflicts(){
      const primary=(document.getElementById('primaryRel').value||'').trim();
      if(!primary) return {hasConflict:false, roles:[]};
      const roles=new Set();
      document.querySelectorAll('[id^="ex-role-"]').forEach(sel=>{
        if(!sel) return;
        const idx=sel.id.split('-')[2];
        let role=(sel.value||'').trim();
        if(role==='自訂角色'){
          const custom=document.getElementById(`ex-custom-${idx}`);
          role=(custom?custom.value:'').trim();
        }
        if(role && role===primary){ roles.add(role); }
      });
      return {hasConflict: roles.size>0, roles:[...roles]};
    }
    function updateParticipantConflictHint(){
      const box=document.getElementById('extras_conflict');
      if(!box) return {hasConflict:false, roles:[]};
      const result=computeParticipantConflicts();
      if(result.hasConflict){
        box.textContent=`其他參與者不可與主要照顧者角色重覆（重覆角色：${result.roles.join('、')}）`;
        box.dataset.show='1';
      }else{
        box.textContent='';
        box.dataset.show='0';
      }
      return result;
    }
    function validateParticipantConflicts(msg){
      const result=updateParticipantConflictHint();
      if(result.hasConflict){
        if(msg) msg.textContent='請調整參與者角色，避免與主要照顧者重覆。';
        return false;
      }
      return true;
    }
    function collectExtras(){
      const reserved=new Set(['個案','福安個管','照專']);
      const uniq=new Set(), out=[];
      const rows=[...document.querySelectorAll('[id^="extra-"]')];
      rows.forEach(row=>{
        const idx=row.id.split('-')[1];
        const sel=document.getElementById(`ex-role-${idx}`),
              custom=document.getElementById(`ex-custom-${idx}`),
              nameEl=document.getElementById(`ex-name-${idx}`);
        let role=(sel?sel.value:'').trim(); if(role==='自訂角色') role=(custom?custom.value:'').trim();
        const name=(nameEl?nameEl.value:'').trim();
        if(!role||!name) return; if(reserved.has(role)) return;
        const key=role+'|'+name; if(uniq.has(key)) return; uniq.add(key);
        out.push({role, name});
      });
      return out;
    }

    /* ================== (一) 身心概況：字典、連動、蒐集、產文 ================== */

    // 字典
    const S1_VISION_NOTES = ['白內障術後','配戴眼鏡','老花','單眼視力不佳','其他'];
    const VISION_NOTE_SUGGESTION = {
      '靠近才能辨識': ['配戴眼鏡'],
      '即使配戴眼鏡，仍難以辨識': ['配戴眼鏡'],
      '僅能分辨明暗，無法辨識人臉或物體輪廓': ['其他'],
      '完全失去視覺功能，無法感知光線': ['其他']
    };
    const S1_LESION_SX_LIST = ['疼痛','搔癢','出血','紅腫','滲液','潰瘍','脫屑','壓紅','無不適'];
    const S1_DHX_LIST     = ['高血壓','糖尿病','高脂血症','心臟病','腦中風','失智症','慢性腎臟病','慢性阻塞性肺病','退化性關節炎','其他'];
    const S1_MED_CLASSES  = ['降壓藥','甲狀腺藥','降脂藥','抗焦慮／鎮定','睡眠用藥','精神科用藥','抗血栓／抗凝','利尿劑','胃腸用藥','止痛藥','止咳化痰','降血糖／胰島素','攝護腺用藥','其他'];
    const S1_LANG_OPTIONS = ['國語','台語','客語','原住民語','英語','手勢／書寫','讀唇','溝通板／App'];
    const S1_SWALLOW_SX_OPTIONS = ['嗆咳','殘留','口水外漏','吞嚥延遲','需要吞嚥訓練'];
    const S1_DIET_TEXTURE_OPTIONS = ['一般','軟質','碎食','泥狀','蜂蜜稠','布丁稠'];
    const S1_FEEDING_TUBE_OPTIONS = ['鼻胃管（NGT）','胃造口（PEG）'];
    const S1_ORAL_OPTIONS = ['自然牙完整','缺牙','口腔衛生不佳','口乾','口臭','活動假牙（上）','活動假牙（下）','假牙不合／鬆動'];
    const S1_EXCRETION_AID_OPTIONS = ['紙尿褲','尿墊','便盆椅','尿壺','留置導尿管','間歇導尿管','尿造口袋','糞造口袋','夜間集尿袋'];
    const S1_BALANCE_OPTIONS = ['站立不穩','頭暈','TUG>12s'];
    const S1_SITTING_SUPPORT_OPTIONS = ['需安全帶','需托盤／擋板','坐墊／防滑具'];
    const S1_MOOD_BEHAVIOR_OPTIONS = ['妄想','幻想性言談','焦慮','憂鬱','易怒','遊走','重複行為','日夜顛倒','脫序行為','囤積'];
    const S1_PHONE_NOTE_OPTIONS = ['重聽需擴音','易受詐騙','其他'];
    const S1_DEVICE_OPTIONS = ['鼻胃管','胃造口管（PEG）','氣切管','鼻導管氧氣','氧氣機','中心靜脈導管','PICC 導管','呼吸輔助器（CPAP）','雙水平呼吸器（BiPAP）','血糖機','藥盒'];
    const INSOMNIA_DETAIL = {
      '疼痛': ['關節炎','骨刺','神經病變','慢性病帶來'],
      '頻尿': ['攝護腺肥大','膀胱功能下降','糖尿病','泌尿道疾病'],
      '慢性疾病': ['心臟衰竭','咳嗽','呼吸困難'],
      '生活壓力': ['經濟','家庭','健康狀況'],
      '環境干擾': ['光線','噪音','溫度過高','溫度過低','床墊不舒適'],
      '不良睡眠習慣': ['白天長時間小睡','晚間過度使用電視','晚間過度使用手機'],
      '藥物影響': ['降壓藥','利尿劑','類固醇','抗憂鬱藥']
    };

    // 聽力：兩層
    const HEARING_DETAIL = {
      '無明顯異常': ['對話流暢，無需特別協助'],
      '輕度受損':   ['需提高音量','在安靜環境下才能聽清'],
      '中度受損':   ['需近距離交談','借助助聽器才能理解','使用擴音設備','助聽器需維修／電量管理'],
      '重度受損':   ['助聽器效果有限','需讀唇或書寫輔助','使用擴音設備','助聽器需維修／電量管理','不配戴（依從性差）'],
      '極重度受損': ['僅能感知大聲或震動','幾乎無法辨識語音內容'],
      '完全失聰':   ['完全聽不見','無法感知聲音']
    };

    // 疼痛部位 × 皮膚病灶：大分類 → 細部分位 → 側別
    const REGION_MAP = {
      '頭頸部': ['頭部','眼睛','面部','口腔牙齒','咽喉','頸部'],
      '上肢':   ['肩膀','手臂','手部'],
      '軀幹':   ['胸部','腹部','背部','腰部','臀部'],
      '下肢':   ['大腿','膝蓋','小腿','足部'],
      '全身性': ['全身痠痛','多處關節','其他']
    };
    const SYMMETRIC_PARTS = new Set(['眼睛','肩膀','手臂','手部','大腿','膝蓋','小腿','足部']);

    const LOCATION_CONTEXTS = ['pain','lesion'];
    const locationState = {
      pain:  { region:'', subChoice:'', subOther:'', laterality:'' },
      lesion:{ region:'', subChoice:'', subOther:'', laterality:'' }
    };
    let activeLocationContext = 'pain';
    let lesionSymptomMode = 'none';

    // 渲染
    function renderS1() {
      // 視力補充
      const vbox=document.getElementById('s1_vision_note_box'); vbox.innerHTML='';
      S1_VISION_NOTES.forEach(name=>{
        const id='vnote_'+name;
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" id="${id}" onchange="onVisionNoteChange(event)"> ${name}`;
        vbox.appendChild(lab);
      });

      // 病灶症狀（互斥：無不適）
      setupLesionSymptomsBox();

      // 慢性病
      const dhx=document.getElementById('s1_dhx_box'); dhx.innerHTML='';
      S1_DHX_LIST.forEach(name=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="toggleDhxOther()"> ${name}`;
        dhx.appendChild(lab);
      });

      // 現用藥別
      const meds=document.getElementById('s1_med_classes_box'); meds.innerHTML='';
      S1_MED_CLASSES.forEach(name=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="toggleMedOther()"> ${name}`;
        meds.appendChild(lab);
      });

      const langBox=document.getElementById('s1_lang_box');
      if(langBox){
        langBox.innerHTML='';
        S1_LANG_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="lang_${i}"> ${name}`;
          langBox.appendChild(lab);
        });
      }

      const swallowBox=document.getElementById('s1_swallow_sx_box');
      if(swallowBox){
        swallowBox.innerHTML='';
        S1_SWALLOW_SX_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="swallow_${i}"> ${name}`;
          swallowBox.appendChild(lab);
        });
      }

      const dietBox=document.getElementById('s1_diet_texture_box');
      if(dietBox){
        dietBox.innerHTML='';
        S1_DIET_TEXTURE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="diet_${i}"> ${name}`;
          dietBox.appendChild(lab);
        });
      }

      const tubeBox=document.getElementById('s1_feeding_tube_box');
      if(tubeBox){
        tubeBox.innerHTML='';
        S1_FEEDING_TUBE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="tube_${i}"> ${name}`;
          tubeBox.appendChild(lab);
        });
      }

      const oralBox=document.getElementById('s1_oral_box');
      if(oralBox){
        oralBox.innerHTML='';
        S1_ORAL_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="oral_${i}"> ${name}`;
          oralBox.appendChild(lab);
        });
      }

      const excretionBox=document.getElementById('s1_excretion_aids_box');
      if(excretionBox){
        excretionBox.innerHTML='';
        S1_EXCRETION_AID_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="exaid_${i}" onchange="updateExcretionAidEffects()"> ${name}`;
          excretionBox.appendChild(lab);
        });
      }

      const balanceBox=document.getElementById('s1_balance_box');
      if(balanceBox){
        balanceBox.innerHTML='';
        S1_BALANCE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="balance_${i}"> ${name}`;
          balanceBox.appendChild(lab);
        });
      }

      const sittingSupportBox=document.getElementById('s1_sitting_support_box');
      if(sittingSupportBox){
        sittingSupportBox.innerHTML='';
        S1_SITTING_SUPPORT_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="sit_${i}"> ${name}`;
          sittingSupportBox.appendChild(lab);
        });
      }

      const moodBox=document.getElementById('s1_mood_behaviors_box');
      if(moodBox){
        moodBox.innerHTML='';
        S1_MOOD_BEHAVIOR_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="mood_${i}"> ${name}`;
          moodBox.appendChild(lab);
        });
      }

      const phoneNoteBox=document.getElementById('s1_phone_note_box');
      if(phoneNoteBox){
        phoneNoteBox.innerHTML='';
        S1_PHONE_NOTE_OPTIONS.forEach((name,i)=>{
          const handler = name==='其他' ? ' onchange="togglePhoneNoteOther()"' : '';
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="phonenote_${i}"${handler}> ${name}`;
          phoneNoteBox.appendChild(lab);
        });
      }

      const deviceBox=document.getElementById('s1_devices_box');
      if(deviceBox){
        deviceBox.innerHTML='';
        S1_DEVICE_OPTIONS.forEach((name,i)=>{
          const lab=document.createElement('label');
          lab.innerHTML=`<input type="checkbox" value="${name}" id="device_${i}"> ${name}`;
          deviceBox.appendChild(lab);
        });
      }

    }

    function setupLesionSymptomsBox(){
      const box = document.getElementById('s1_lesion_sx_box');
      if(!box) return;
      box.innerHTML='';
      S1_LESION_SX_LIST.forEach(name=>{
        const id = 'lsx_'+name;
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" id="${id}" onchange="syncNoDiscomfort('s1_lesion_sx_box')"> ${name}`;
        box.appendChild(lab);
      });
      box.dataset.mode = lesionSymptomMode;
      setLesionSymptomMode(lesionSymptomMode);
    }

    // 連動
    function toggleVisionNotes(){
      const v=document.getElementById('s1_vision').value;
      const box=document.getElementById('s1_vision_note_box');
      if(box){
        box.querySelectorAll('input[data-auto="1"]').forEach(inp=>{
          inp.checked=false;
          inp.removeAttribute('data-auto');
          const lab=inp.closest('label');
          if(lab) lab.removeAttribute('data-auto');
        });
        box.querySelectorAll('label[data-auto="1"]').forEach(lab=>lab.removeAttribute('data-auto'));
        const suggest = VISION_NOTE_SUGGESTION[v] || [];
        suggest.forEach(label=>{
          const chk=box.querySelector(`input[value="${label}"]`);
          if(chk){
            chk.checked=true;
            chk.dataset.auto='1';
            const lab=chk.closest('label');
            if(lab) lab.dataset.auto='1';
          }
        });
      }
      toggleVisionOther();
      toggleGlassesAdherence();
      updateVisionAutoHint();
    }
    function onVisionNoteChange(event){
      const target=event && event.target;
      if(target && target.matches('input[type=checkbox]')){
        target.removeAttribute('data-auto');
        const lab=target.closest('label');
        if(lab) lab.removeAttribute('data-auto');
      }
      toggleVisionOther();
      toggleGlassesAdherence();
      updateVisionAutoHint();
    }
    function toggleVisionOther(){
      const hasOther = document.querySelector('#s1_vision_note_box input[value="其他"]')?.checked;
      document.getElementById('s1_vision_other').style.display = hasOther?'':'none';
    }
    function toggleGlassesAdherence(){
      const wrap=document.getElementById('s1_glasses_adherence_wrap');
      if(!wrap) return;
      const checks=[...document.querySelectorAll('#s1_vision_note_box input[type=checkbox]:checked')].map(x=>x.value);
      const need=checks.some(v=>v==='配戴眼鏡');
      wrap.style.display = need ? '' : 'none';
      if(!need){
        const sel=document.getElementById('s1_glasses_adherence');
        if(sel) sel.value='';
      }
    }
    function updateVisionAutoHint(){
      const hint=document.getElementById('s1_vision_auto_hint');
      if(!hint) return;
      const hasAuto = !!document.querySelector('#s1_vision_note_box input[data-auto="1"]');
      hint.style.display = hasAuto ? '' : 'none';
    }
    function resetVisionSuggestions(){
      const box=document.getElementById('s1_vision_note_box');
      if(box){
        box.querySelectorAll('input[type=checkbox]').forEach(inp=>{
          inp.checked=false;
          inp.removeAttribute('data-auto');
        });
        box.querySelectorAll('label[data-auto]').forEach(lab=>lab.removeAttribute('data-auto'));
      }
      const otherInput=document.getElementById('s1_vision_other');
      if(otherInput) otherInput.value='';
      toggleVisionNotes();
    }

    // 聽力兩層渲染
    function renderHearingDetails(){
      const level = document.getElementById('s1_hearing_level').value;
      const wrap  = document.getElementById('s1_hearing_detail_wrap');
      const box   = document.getElementById('s1_hearing_detail_box');
      if(!level){ wrap.style.display='none'; box.innerHTML=''; return; }
      const items = (HEARING_DETAIL[level] || []).slice();
      const extra = '在嘈雜環境下理解困難';
      if(!items.includes(extra)) items.push(extra);
      box.innerHTML = '';
      items.forEach((txt, i)=>{
        const id = 'hear_'+i;
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${txt}" id="${id}" onchange="toggleHearingDeviceAdherence()"> ${txt}`;
        box.appendChild(lab);
      });
      wrap.style.display='';
      toggleHearingDeviceAdherence();
    }

    function toggleHearingDeviceAdherence(){
      const wrap=document.getElementById('s1_hearing_device_wrap');
      if(!wrap) return;
      const checks=[...document.querySelectorAll('#s1_hearing_detail_box input[type=checkbox]')];
      const need=checks.some(c=>c.checked && (c.value==='借助助聽器才能理解' || c.value==='使用擴音設備'));
      wrap.style.display = need ? '' : 'none';
      if(!need){
        const sel=document.getElementById('s1_hearing_device_adherence');
        if(sel) sel.value='';
      }
    }

    function togglePainCombined(){
      const v  = document.getElementById('s1_pain').value;
      const on = (v === '有');

      document.getElementById('s1_pain_score_wrap').style.display = on ? '' : 'none';

      if(on){
        const ps = document.getElementById('s1_pain_score');
        if(ps && !ps.value) ps.value = 5;
        switchLocationContext('pain');
      }

      updateLocationVisibility();
    }

    function resetLocationState(context){
      if(locationState[context]){
        locationState[context].region='';
        locationState[context].subChoice='';
        locationState[context].subOther='';
        locationState[context].laterality='';
      }
    }

    function getLocationSubregionText(state){
      if(!state) return '';
      if(state.subChoice === '其他'){
        return state.subOther || '';
      }
      return state.subChoice || '';
    }

    function needsLaterality(state){
      return SYMMETRIC_PARTS.has(getLocationSubregionText(state));
    }

    function populateSubregionOptions(region, selected){
      const subSel=document.getElementById('s1_location_subregion');
      if(!subSel) return;
      subSel.innerHTML='<option value="" class="placeholder-option" disabled selected>請選擇</option>';
      if(region){
        (REGION_MAP[region] || []).forEach(name=>{
          const o=document.createElement('option'); o.textContent=name; subSel.appendChild(o);
        });
      }
      if(selected && [...subSel.options].some(opt=>opt.value===selected)){
        subSel.value = selected;
      }else{
        subSel.value='';
      }
    }

    function saveLocationFromUI(){
      const block=document.getElementById('s1_location_block');
      if(!block || block.style.display==='none') return;
      const state=locationState[activeLocationContext];
      if(!state) return;
      const regionSel=document.getElementById('s1_location_region');
      const subSel=document.getElementById('s1_location_subregion');
      const other=document.getElementById('s1_location_subregion_other');
      const latSel=document.getElementById('s1_location_laterality');
      if(regionSel) state.region = regionSel.value || '';
      if(subSel) state.subChoice = subSel.value || '';
      if(other && state.subChoice === '其他'){
        state.subOther = other.value || '';
      }else if(state.subChoice !== '其他'){
        state.subOther = '';
      }
      if(latSel && !latSel.disabled){
        state.laterality = latSel.value || '';
      }else{
        state.laterality = '';
      }
    }

    function isLocationStateEmpty(state){
      return !state || (!state.region && !state.subChoice && !state.subOther && !state.laterality);
    }

    function applyLocationStateToUI(){
      const state=locationState[activeLocationContext];
      const regionSel=document.getElementById('s1_location_region');
      const subSel=document.getElementById('s1_location_subregion');
      const other=document.getElementById('s1_location_subregion_other');
      const latSel=document.getElementById('s1_location_laterality');
      if(!state || !regionSel || !subSel || !other || !latSel) return;
      regionSel.value = state.region || '';
      populateSubregionOptions(state.region, state.subChoice);
      if(state.subChoice){
        const hasOption=[...subSel.options].some(opt=>opt.value===state.subChoice);
        subSel.value = hasOption ? state.subChoice : '';
        if(!hasOption){
          state.subChoice='';
          state.subOther='';
        }
      }else{
        subSel.value='';
      }
      if(state.subChoice === '其他'){
        other.style.display='';
        other.value = state.subOther || '';
      }else{
        other.style.display='none';
        other.value='';
      }
      const needLat = needsLaterality(state);
      latSel.parentElement.style.display = needLat ? '' : 'none';
      latSel.disabled = !needLat;
      if(needLat){
        latSel.value = state.laterality || '';
      }else{
        latSel.value='';
        state.laterality='';
      }
    }

    function updateLocationToolbar(){
      const label=document.getElementById('s1_location_active_label');
      if(label){
        label.textContent = activeLocationContext === 'lesion' ? '病灶部位' : '疼痛部位';
      }
      document.querySelectorAll('.location-switch button').forEach(btn=>{
        if(btn.dataset && btn.dataset.context){
          btn.dataset.active = (btn.dataset.context === activeLocationContext) ? '1' : '0';
        }
      });
      const toolbar=document.getElementById('s1_location_toolbar');
      if(toolbar){
        const painOn = document.getElementById('s1_pain').value === '有';
        const lesionOn = document.getElementById('s1_lesion_has').value === '有';
        toolbar.style.display = (painOn && lesionOn) ? '' : 'none';
        const copyBtn=document.getElementById('location_copy_btn');
        if(copyBtn){
          if(painOn && lesionOn){
            copyBtn.style.display='';
            const target = activeLocationContext;
            const source = target === 'lesion' ? 'pain' : 'lesion';
            copyBtn.textContent = target === 'lesion' ? '同疼痛部位' : '同病灶部位';
            const hasSource = !isLocationStateEmpty(locationState[source]);
            copyBtn.disabled = !hasSource;
            copyBtn.dataset.source = source;
            copyBtn.dataset.active = hasSource ? '1' : '0';
            copyBtn.title = hasSource ? '' : '來源尚未設定';
          }else{
            copyBtn.style.display='none';
          }
        }
      }
    }

    function copyLocationFromOther(){
      const painOn = document.getElementById('s1_pain').value === '有';
      const lesionOn = document.getElementById('s1_lesion_has').value === '有';
      if(!(painOn && lesionOn)) return;
      const target = activeLocationContext;
      const source = target === 'lesion' ? 'pain' : 'lesion';
      const sourceState = locationState[source];
      const targetState = locationState[target];
      if(!sourceState || !targetState || isLocationStateEmpty(sourceState)) return;
      targetState.region = sourceState.region || '';
      targetState.subChoice = sourceState.subChoice || '';
      targetState.subOther = sourceState.subOther || '';
      targetState.laterality = sourceState.laterality || '';
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function switchLocationContext(context, opts={}){
      if(!LOCATION_CONTEXTS.includes(context)) return;
      if(activeLocationContext !== context){
        saveLocationFromUI();
      }
      const target=locationState[context];
      if(opts.copyFrom && isLocationStateEmpty(target)){
        const src=locationState[opts.copyFrom];
        if(src){
          target.region = src.region || '';
          target.subChoice = src.subChoice || '';
          target.subOther = src.subOther || '';
          target.laterality = src.laterality || '';
        }
      }
      activeLocationContext = context;
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function updateLocationVisibility(){
      const block=document.getElementById('s1_location_block');
      const painOn = document.getElementById('s1_pain').value === '有';
      const lesionOn = document.getElementById('s1_lesion_has').value === '有';
      if(block){
        block.style.display = (painOn || lesionOn) ? '' : 'none';
      }
      if(!painOn && !lesionOn){
        saveLocationFromUI();
        updateLocationToolbar();
        return;
      }
      if(painOn && activeLocationContext !== 'pain'){
        switchLocationContext('pain');
      }else if(!painOn && lesionOn && activeLocationContext !== 'lesion'){
        switchLocationContext('lesion');
      }else{
        applyLocationStateToUI();
        updateLocationToolbar();
      }
    }

    function onSharedRegionChange(){
      const regionSel=document.getElementById('s1_location_region');
      const state=locationState[activeLocationContext];
      if(!regionSel || !state) return;
      state.region = regionSel.value || '';
      state.subChoice='';
      state.subOther='';
      state.laterality='';
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function onSharedSubregionChange(){
      const subSel=document.getElementById('s1_location_subregion');
      const state=locationState[activeLocationContext];
      if(!subSel || !state) return;
      state.subChoice = subSel.value || '';
      if(state.subChoice !== '其他'){ state.subOther=''; }
      applyLocationStateToUI();
      updateLocationToolbar();
    }

    function onSharedSubregionOtherInput(){
      const other=document.getElementById('s1_location_subregion_other');
      const state=locationState[activeLocationContext];
      if(!other || !state) return;
      state.subOther = other.value || '';
    }

    function onSharedLateralityChange(){
      const latSel=document.getElementById('s1_location_laterality');
      const state=locationState[activeLocationContext];
      if(!latSel || !state) return;
      if(latSel.disabled){ state.laterality=''; }
      else { state.laterality = latSel.value || ''; }
    }

    function getLocationData(context){
      const state = locationState[context] || { region:'', subChoice:'', subOther:'', laterality:'' };
      const region = state.region || '';
      const subChoice = state.subChoice || '';
      const subOther = subChoice === '其他' ? (state.subOther || '') : '';
      const subValue = subChoice === '其他' ? (state.subOther || '') : subChoice;
      const laterality = state.laterality || '';
      return { region, subChoice, subOther, subValue, laterality };
    }

    // 皮膚病灶顯示
    function toggleLesionCombined(){
      const v=document.getElementById('s1_lesion_has').value;
      const on=(v==='有');
      if(on){
        if(document.getElementById('s1_pain').value === '有'){
          switchLocationContext('lesion', { copyFrom: 'pain' });
        }else{
          switchLocationContext('lesion');
        }
        setLesionSymptomMode(lesionSymptomMode === 'symptom' ? 'symptom' : 'none');
      }else{
        lesionSymptomMode = 'none';
        setLesionSymptomMode('none');
        const lenInput=document.getElementById('s1_lesion_length');
        const widInput=document.getElementById('s1_lesion_width');
        if(lenInput) lenInput.value='';
        if(widInput) widInput.value='';
      }
      document.getElementById('s1_lesion_layer_wrap').style.display = on?'':'none';
      document.getElementById('s1_lesion_size_wrap').style.display = on?'':'none';
      document.getElementById('s1_lesion_more').style.display = on?'':'none';
      updateLesionAreaDisplay();
      updateLocationVisibility();
      toggleLesionHospital();
    }
    function toggleLesionLayerOther(){
      const v=document.getElementById('s1_lesion_layer').value;
      const other=document.getElementById('s1_lesion_layer_other');
      if(!other) return;
      const show=(v==='其他');
      other.style.display = show?'':'none';
      if(!show) other.value='';
    }

    function toggleLesionHospital(){
      const has=document.getElementById('s1_lesion_has').value;
      const evalv=document.getElementById('s1_lesion_eval').value;
      const input=document.getElementById('s1_lesion_hospital');
      if(!input) return;
      const show = (has==='有' && evalv!=='未評估');
      input.style.display = show ? '' : 'none';
      if(!show) input.value='';
    }

    function toggleSwallow(){
      const sel=document.getElementById('s1_swallow');
      const level=sel ? sel.value : '';
      const detailOn = level && level !== '無困難';
      const sxWrap=document.getElementById('s1_swallow_sx_wrap');
      const sxHint=document.getElementById('s1_swallow_sx_hint');
      if(sxWrap){
        sxWrap.style.display = detailOn ? '' : 'none';
        if(sxHint) sxHint.style.display = detailOn ? '' : 'none';
        if(!detailOn){
          sxWrap.querySelectorAll('input[type=checkbox]').forEach(c=>{ c.checked=false; });
        }
      }
      const dietWrap=document.getElementById('s1_diet_wrap');
      if(dietWrap){
        dietWrap.style.display = detailOn ? '' : 'none';
        if(!detailOn){
          document.querySelectorAll('#s1_diet_texture_box input[type=checkbox]').forEach(c=>{ c.checked=false; });
          document.querySelectorAll('#s1_feeding_tube_box input[type=checkbox]').forEach(c=>{ c.checked=false; });
        }
      }
    }

    function toggleFallDetail(){
      const sel=document.getElementById('s1_fall_history');
      const input=document.getElementById('s1_fall_times');
      if(!sel || !input) return;
      const value=sel.value;
      const show = value==='過去1年1次' || value==='過去1年≧2次';
      input.style.display = show ? '' : 'none';
      if(!show) input.value='';
    }

    function toggleSittingSupports(){
      const sel=document.getElementById('s1_sitting_stability');
      const box=document.getElementById('s1_sitting_support_box');
      if(!sel || !box) return;
      const show = sel.value && sel.value !== '穩定';
      box.style.display = show ? '' : 'none';
      if(!show){
        box.querySelectorAll('input[type=checkbox]').forEach(c=>{ c.checked=false; });
      }
    }

    function togglePhoneNotes(){
      const sel=document.getElementById('s1_phone');
      const wrap=document.getElementById('s1_phone_note_wrap');
      if(!sel || !wrap) return;
      const show = sel.value && sel.value !== '會撥打與接聽';
      wrap.style.display = show ? '' : 'none';
      if(!show){
        wrap.querySelectorAll('input[type=checkbox]').forEach(c=>{ c.checked=false; });
      }
      togglePhoneNoteOther();
    }

    function togglePhoneNoteOther(){
      const other=document.getElementById('s1_phone_note_other');
      if(!other) return;
      const on=document.querySelector('#s1_phone_note_box input[value="其他"]')?.checked;
      other.style.display = on ? '' : 'none';
      if(!on) other.value='';
    }

    function hasNightCatheterSelection(){
      return [...document.querySelectorAll('#s1_excretion_aids_box input[type=checkbox]:checked')]
        .map(x=>x.value)
        .some(v=>v==='留置導尿管' || v==='間歇導尿管' || v==='尿造口袋' || v==='糞造口袋' || v==='夜間集尿袋');
    }

    function updateNocturiaCountVisibility(){
      const wrap=document.getElementById('s1_nocturia_wrap');
      const input=document.getElementById('s1_nocturia_count');
      if(hasNightCatheterSelection()){
        if(wrap) wrap.style.display='none';
        if(input) input.value='';
        return;
      }
      const sel=document.getElementById('s1_urine_night');
      if(!wrap || !sel){
        if(wrap) wrap.style.display='none';
        if(input) input.value='';
        return;
      }
      const value=sel.value;
      const show=value && value !== '夜間未起夜';
      wrap.style.display = show ? '' : 'none';
      if(!show && input) input.value='';
    }

    function updateExcretionAidEffects(){
      const nightWrap=document.getElementById('s1_urine_night_wrap');
      const other=document.getElementById('s1_urine_night_other');
      const note=document.getElementById('s1_night_catheter_note');
      const sel=document.getElementById('s1_urine_night');
      const hasCatheter=hasNightCatheterSelection();
      if(hasCatheter){
        if(nightWrap) nightWrap.style.display='none';
        if(note) note.style.display='';
        if(sel) sel.value='';
        if(other){ other.style.display='none'; other.value=''; }
      }else{
        if(nightWrap) nightWrap.style.display='';
        if(note) note.style.display='none';
        toggleUrineOther('night');
      }
      updateNocturiaCountVisibility();
    }

    function toggleAdlHow(id){
      const sel=document.getElementById(id);
      const input=document.getElementById(id+'_how');
      if(!sel||!input) return;
      const showValues = (input.dataset.showValues || '').split(',').map(v=>v.trim()).filter(Boolean);
      let show = false;
      if(showValues.length){
        show = showValues.indexOf(sel.value) !== -1;
      }else{
        show = sel.value==='部分協助';
      }
      input.style.display = show? '':'none';
      if(!show){
        input.value='';
        input.classList.remove('input-invalid');
      }
    }

    let actionEntryCounter = 0;

    function createActionSourceSelect(){
      const select=document.createElement('select');
      select.innerHTML = `
        <option value="" class="placeholder-option" disabled selected>請選擇來源</option>
        <option value="問題">問題</option>
        <option value="目標">目標</option>
        <option value="服務項目">服務項目</option>
      `;
      return select;
    }

    function updateActionRemoveButtons(){
      const host=document.getElementById('s1_actions_list');
      if(!host) return;
      const rows=[...host.querySelectorAll('.action-item')];
      rows.forEach(row=>{
        const btn=row.querySelector('.action-item-controls button');
        if(btn){ btn.style.display = rows.length>1 ? '' : 'none'; }
      });
    }

    function updateActionHint(){
      const hint=document.getElementById('s1_actions_hint');
      if(!hint) return;
      const entries=readActionEntries();
      const hasContent = entries.some(entry=>entry.text);
      hint.style.display = hasContent ? 'none' : '';
    }

    function addActionEntry(data){
      const host=document.getElementById('s1_actions_list');
      if(!host) return null;
      const entry=data || {};
      const row=document.createElement('div');
      row.className='action-item';
      row.dataset.actionId=`action-${actionEntryCounter++}`;

      const fields=document.createElement('div');
      fields.className='action-item-fields';
      const select=createActionSourceSelect();
      if(entry.source){ select.value=entry.source; }
      const textarea=document.createElement('textarea');
      textarea.placeholder='請輸入具體行動，例如：已提醒家屬設定白名單，避免詐騙來電。';
      if(entry.text){ textarea.value=entry.text; }
      fields.appendChild(select);
      fields.appendChild(textarea);
      row.appendChild(fields);

      const controls=document.createElement('div');
      controls.className='action-item-controls';
      const removeBtn=document.createElement('button');
      removeBtn.type='button';
      removeBtn.className='small';
      removeBtn.textContent='移除';
      removeBtn.addEventListener('click', ()=>removeActionEntry(row));
      controls.appendChild(removeBtn);
      row.appendChild(controls);

      host.appendChild(row);

      select.addEventListener('change', ()=>{ select.classList.remove('input-invalid'); updateActionHint(); buildSection1(); });
      textarea.addEventListener('input', ()=>{ textarea.classList.remove('input-invalid'); updateActionHint(); buildSection1(); });

      updateActionRemoveButtons();
      updateActionHint();
      return row;
    }

    function removeActionEntry(row){
      if(row) row.remove();
      const host=document.getElementById('s1_actions_list');
      if(host && host.childElementCount===0){
        addActionEntry();
      }
      updateActionRemoveButtons();
      updateActionHint();
      buildSection1();
    }

    function readActionEntries(){
      const host=document.getElementById('s1_actions_list');
      if(!host) return [];
      return [...host.querySelectorAll('.action-item')].map(row=>{
        const select=row.querySelector('select');
        const textarea=row.querySelector('textarea');
        return {
          row,
          select,
          textarea,
          source:(select && select.value ? select.value.trim() : ''),
          text:(textarea && textarea.value ? textarea.value.trim() : '')
        };
      });
    }

    function collectActionEntries(){
      return readActionEntries()
        .map(entry=>({source:entry.source, text:entry.text}))
        .filter(entry=>entry.source && entry.text);
    }

    function initActionEntries(){
      const host=document.getElementById('s1_actions_list');
      if(!host) return;
      if(host.childElementCount===0){ addActionEntry(); }
      updateActionRemoveButtons();
      updateActionHint();
    }

    // 病灶症狀互斥（無不適）
    function syncNoDiscomfort(containerId){
      const box = document.getElementById(containerId);
      if(!box) return;
      const mode = box.dataset.mode || 'symptom';
      const checks = [...box.querySelectorAll('input[type=checkbox]')];
      const none = checks.find(c=>c.value==='無不適');
      const others = checks.filter(c=>c!==none);
      if(mode === 'none'){
        if(none) none.checked = true;
        others.forEach(c=>{ c.checked=false; c.disabled=true; });
        return;
      }
      others.forEach(c=>{ c.disabled=false; });
      if(none && none.checked){
        others.forEach(c=>{ c.checked=false; });
      }
    }

    function updateLesionModeControls(){
      const group=document.getElementById('s1_lesion_mode');
      if(group){
        const mode=lesionSymptomMode;
        group.querySelectorAll('button').forEach(btn=>{
          const active = btn.dataset.mode === mode;
          btn.dataset.active = active ? '1' : '0';
        });
      }
      const box=document.getElementById('s1_lesion_sx_box');
      if(box){
        box.dataset.mode = lesionSymptomMode;
        box.style.display = lesionSymptomMode === 'none' ? 'none' : '';
      }
    }

    function setLesionSymptomMode(mode){
      const normalized = mode === 'symptom' ? 'symptom' : 'none';
      lesionSymptomMode = normalized;
      const box=document.getElementById('s1_lesion_sx_box');
      if(!box) return;
      box.dataset.mode = normalized;
      box.style.display = normalized === 'none' ? 'none' : '';
      const checks=[...box.querySelectorAll('input[type=checkbox]')];
      const none=checks.find(c=>c.value==='無不適');
      const others=checks.filter(c=>c!==none);
      if(normalized==='none'){
        if(none) none.checked=true;
        others.forEach(c=>{ c.checked=false; c.disabled=true; });
      }else{
        others.forEach(c=>{ c.disabled=false; });
        if(none) none.checked=false;
      }
      syncNoDiscomfort('s1_lesion_sx_box');
      updateLesionModeControls();
    }

    function getLesionSizeState(){
      const lengthInput=document.getElementById('s1_lesion_length');
      const widthInput=document.getElementById('s1_lesion_width');
      const lengthRaw=lengthInput ? lengthInput.value : '';
      const widthRaw=widthInput ? widthInput.value : '';
      const lenNum=parseFloat(lengthRaw);
      const widNum=parseFloat(widthRaw);
      const validLen=!Number.isNaN(lenNum) && lenNum>0;
      const validWid=!Number.isNaN(widNum) && widNum>0;
      const area = (validLen && validWid) ? Number((lenNum*widNum).toFixed(2)) : null;
      return { lengthRaw, widthRaw, lenNum: validLen?lenNum:null, widNum: validWid?widNum:null, area };
    }

    function updateLesionAreaDisplay(){
      const state=getLesionSizeState();
      const display=document.getElementById('s1_lesion_area_display');
      if(display){
        if(state.area!==null){
          display.textContent=`面積：${state.area.toFixed(2)} cm²`;
        }else{
          display.textContent='面積：— cm²';
        }
      }
      const hint=document.getElementById('s1_lesion_size_hint');
      if(hint){
        hint.style.display = (state.lenNum!==null && state.widNum!==null) ? 'none' : '';
      }
    }

    function buildLesionSizeText(state){
      if(!state || state.lenNum===null || state.widNum===null) return '';
      const lenText=state.lenNum.toFixed(1);
      const widText=state.widNum.toFixed(1);
      if(state.area!==null){
        return `${lenText}×${widText} cm（面積 ${state.area.toFixed(2)} cm²）`;
      }
      return `${lenText}×${widText} cm`;
    }

    function toggleTransportOther(){
      const v=document.getElementById('s1_visit_transport').value;
      document.getElementById('s1_visit_transport_other').style.display = (v==='其他')?'':'none';
    }
    function toggleUrineOther(type){
      const selId = type === 'night' ? 's1_urine_night' : 's1_urine_day';
      const inputId = type === 'night' ? 's1_urine_night_other' : 's1_urine_day_other';
      const sel=document.getElementById(selId);
      const input=document.getElementById(inputId);
      if(!sel||!input) return;
      const show = sel.value==='其他';
      input.style.display = show?'':'none';
      if(!show) input.value='';
      if(type==='night') updateNocturiaCountVisibility();
    }
    function toggleDhxOther(){
      const on = document.querySelector('#s1_dhx_box input[value="其他"]')?.checked;
      document.getElementById('s1_dhx_other').style.display = on?'':'none';
    }
    function toggleMedOther(){
      const on = document.querySelector('#s1_med_classes_box input[value="其他"]')?.checked;
      document.getElementById('s1_med_classes_other').style.display = on?'':'none';
    }
    function toggleShoppingHow(){
      const sel=document.getElementById('s1_shopping');
      const how=document.getElementById('s1_shopping_how');
      const other=document.getElementById('s1_shopping_how_other');
      if(!sel||!how||!other) return;
      const show = sel.value==='需陪同' || sel.value==='不外出';
      how.style.display = show ? '' : 'none';
      if(!show){
        how.value=''; other.style.display='none'; other.value='';
        return;
      }
      const showOther = how.value==='其他';
      other.style.display = showOther ? '' : 'none';
      if(!showOther) other.value='';
    }
    function toggleDishwashHow(){
      const sel=document.getElementById('s1_dishwash');
      const how=document.getElementById('s1_dishwash_how');
      const other=document.getElementById('s1_dishwash_how_other');
      if(!sel||!how||!other) return;
      const show = sel.value==='無法自行清洗';
      how.style.display = show ? '' : 'none';
      if(!show){
        how.value='由他人代辦'; other.style.display='none'; other.value='';
        return;
      }
      const showOther = how.value==='其他';
      other.style.display = showOther ? '' : 'none';
      if(!showOther) other.value='';
    }
    function toggleSleepReason(){
      const sleep=document.getElementById('s1_sleep').value;
      const reason=document.getElementById('s1_sleep_reason');
      const detail=document.getElementById('s1_sleep_reason_detail');
      const other=document.getElementById('s1_sleep_reason_other');
      const show = sleep !== '良好';
      reason.style.display = show ? '' : 'none';
      if(!show){
        reason.value=''; detail.style.display='none'; detail.innerHTML=''; other.style.display='none'; other.value='';
        return;
      }
      toggleSleepReasonDetail();
    }
    function toggleSleepReasonDetail(){
      const reason=document.getElementById('s1_sleep_reason').value;
      const detail=document.getElementById('s1_sleep_reason_detail');
      const other=document.getElementById('s1_sleep_reason_other');
      const list=INSOMNIA_DETAIL[reason];
      if(list){
        detail.style.display=''; detail.innerHTML='<option value="" class="placeholder-option" disabled selected>請選擇</option>';
        list.forEach(name=>{ const o=document.createElement('option'); o.textContent=name; detail.appendChild(o); });
        other.style.display='none'; other.value='';
      }else{
        detail.style.display='none'; detail.innerHTML='';
        if(reason==='其他'){ other.style.display=''; }
        else { other.style.display='none'; other.value=''; }
      }
    }
    function syncDisab(){
      if(!document.getElementById('s2_dis_level')) return;
      toggleDisCategory();
    }

    // 蒐集
    function collectChecks(containerId, otherInputId){
      const list=[...document.querySelectorAll(`#${containerId} input[type=checkbox]`)].filter(x=>x.checked).map(x=>x.value);
      if(otherInputId){
        const idx = list.indexOf('其他');
        if(idx !== -1){
          const t=(document.getElementById(otherInputId).value||'').trim();
          if(t){
            list[idx] = t;
          }else{
            list.splice(idx,1);
          }
        }
      }
      return list;
    }

    function collectHearingDetails(){
      return [...document.querySelectorAll('#s1_hearing_detail_box input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
    }

    function resetSection1Validation(){
      document.querySelectorAll('#section1_block .input-invalid').forEach(el=>el.classList.remove('input-invalid'));
      document.querySelectorAll('#section1_block .field-error').forEach(el=>{ el.textContent=''; el.dataset.show='0'; });
      const box=document.getElementById('section1_errors');
      if(box){ box.innerHTML=''; box.style.display='none'; }
    }
    function markSection1Invalid(id){
      const el=document.getElementById(id);
      if(!el) return;
      el.classList.add('input-invalid');
    }

    function setFieldError(id, message){
      const el=document.getElementById(id);
      if(!el) return;
      if(message){
        el.textContent = message;
        el.dataset.show='1';
      }else{
        el.textContent='';
        el.dataset.show='0';
      }
    }

    function collectS1(){
      const s = {};
      // 基本
      s.s1_age = document.getElementById('s1_age').value;
      s.s1_gender = document.getElementById('s1_gender').value;
      s.s1_awareness = document.getElementById('s1_awareness').value;
      s.s1_cognition = document.getElementById('s1_cognition').value;
      s.s1_lang = collectChecks('s1_lang_box');
      s.s1_lang_note = document.getElementById('s1_lang_note').value;
      // 視聽
      s.s1_vision = document.getElementById('s1_vision').value;
      s.s1_vision_note = collectChecks('s1_vision_note_box','s1_vision_other');
      s.s1_glasses_adherence = document.getElementById('s1_glasses_adherence').value;
      s.s1_hearing_level = document.getElementById('s1_hearing_level').value;
      s.s1_hearing_details = collectHearingDetails();
      s.s1_hearing_device_adherence = document.getElementById('s1_hearing_device_adherence').value;
      // 吞嚥與口腔
      s.s1_swallow = document.getElementById('s1_swallow').value;
      s.s1_swallow_sx = collectChecks('s1_swallow_sx_box');
      s.s1_diet_texture = collectChecks('s1_diet_texture_box');
      s.s1_feeding_tubes = collectChecks('s1_feeding_tube_box');
      s.s1_oral = collectChecks('s1_oral_box');
      s.s1_oral_note = document.getElementById('s1_oral_note').value;
      // 疼痛/皮膚 + 部位
      s.s1_pain = document.getElementById('s1_pain').value;
      s.s1_pain_score = document.getElementById('s1_pain_score').value;
      const painLoc = getLocationData('pain');
      s.s1_body_region = painLoc.region;
      s.s1_subregion_choice = painLoc.subChoice;
      s.s1_subregion_other = painLoc.subOther;
      s.s1_subregion = painLoc.subValue;
      s.s1_laterality = painLoc.laterality;

      s.s1_lesion_has = document.getElementById('s1_lesion_has').value;
      const lesionLoc = getLocationData('lesion');
      s.s1_lesion_region = lesionLoc.region;
      s.s1_lesion_subregion_choice = lesionLoc.subChoice;
      s.s1_lesion_subregion_other = lesionLoc.subOther;
      s.s1_lesion_subregion = lesionLoc.subValue;
      s.s1_lesion_laterality = lesionLoc.laterality;
      let layer = document.getElementById('s1_lesion_layer').value;
      if(layer==='其他'){
        const lo=(document.getElementById('s1_lesion_layer_other').value||'').trim();
        layer = lo;
      }
      s.s1_lesion_layer = layer || '無';
      const lesionSizeState=getLesionSizeState();
      s.s1_lesion_length_cm = lesionSizeState.lengthRaw;
      s.s1_lesion_width_cm  = lesionSizeState.widthRaw;
      s.s1_lesion_area_cm2  = lesionSizeState.area!==null ? lesionSizeState.area.toFixed(2) : '';
      s.s1_lesion_size_text = buildLesionSizeText(lesionSizeState);
      s.s1_lesion_symptom_mode = lesionSymptomMode;
      s.s1_lesion_sx    = collectChecks('s1_lesion_sx_box');
      if(s.s1_lesion_has==='有' && Array.isArray(s.s1_lesion_sx) && s.s1_lesion_sx.length===0 && s.s1_lesion_symptom_mode !== 'symptom'){ s.s1_lesion_sx=['無不適']; }
      s.s1_lesion_eval  = document.getElementById('s1_lesion_eval').value;
      s.s1_lesion_hospital = document.getElementById('s1_lesion_hospital').value;

      // 行動/ADL/排泄
      s.s1_transfer = document.getElementById('s1_transfer').value;
      s.s1_transfer_how = document.getElementById('s1_transfer_how').value;
      s.s1_walk_indoor = document.getElementById('s1_walk_indoor').value;
      s.s1_walk_outdoor = document.getElementById('s1_walk_outdoor').value;
      s.s1_stairs = document.getElementById('s1_stairs').value;
      s.s1_weak_laterality = document.getElementById('s1_weak_laterality').value;
      s.s1_fall_history = document.getElementById('s1_fall_history').value;
      s.s1_fall_times = document.getElementById('s1_fall_times').value;
      s.s1_balance = collectChecks('s1_balance_box');
      s.s1_sitting_stability = document.getElementById('s1_sitting_stability').value;
      s.s1_sitting_supports = collectChecks('s1_sitting_support_box');
      s.s1_gait = document.getElementById('s1_gait').value;
      s.s1_gait_note = document.getElementById('s1_gait_note').value;
      s.s1_adl_eating = document.getElementById('s1_adl_eating').value;
      s.s1_adl_eating_how = document.getElementById('s1_adl_eating_how').value;
      s.s1_adl_groom = document.getElementById('s1_adl_groom').value;
      s.s1_adl_groom_how = document.getElementById('s1_adl_groom_how').value;
      s.s1_adl_bathing = document.getElementById('s1_adl_bathing').value;
      s.s1_adl_bathing_how = document.getElementById('s1_adl_bathing_how').value;
      s.s1_adl_dressing = document.getElementById('s1_adl_dressing').value;
      s.s1_adl_dressing_how = document.getElementById('s1_adl_dressing_how').value;
      s.s1_excretion_aids = collectChecks('s1_excretion_aids_box');
      const urineDaySel = document.getElementById('s1_urine_day').value;
      const urineDayOther = (document.getElementById('s1_urine_day_other').value||'').trim();
      s.s1_urine_day_choice = urineDaySel;
      s.s1_urine_day_is_other = (urineDaySel==='其他' && !!urineDayOther);
      s.s1_urine_day_other = s.s1_urine_day_is_other ? urineDayOther : '';
      s.s1_urine_day = s.s1_urine_day_is_other ? urineDayOther : urineDaySel;

      const urineNightSel = document.getElementById('s1_urine_night').value;
      const urineNightOther = (document.getElementById('s1_urine_night_other').value||'').trim();
      s.s1_urine_night_choice = urineNightSel;
      s.s1_urine_night_is_other = (urineNightSel==='其他' && !!urineNightOther);
      s.s1_urine_night_other = s.s1_urine_night_is_other ? urineNightOther : '';
      s.s1_urine_night = s.s1_urine_night_is_other ? urineNightOther : urineNightSel;
      s.s1_nocturia_count = document.getElementById('s1_nocturia_count').value;
      s.s1_post_toilet = document.getElementById('s1_post_toilet').value;
      s.s1_post_toilet_how = document.getElementById('s1_post_toilet_how').value;

      // 生活管理
      s.s1_phone = document.getElementById('s1_phone').value;
      s.s1_phone_notes = collectChecks('s1_phone_note_box','s1_phone_note_other');
      s.s1_shopping = document.getElementById('s1_shopping').value;
      s.s1_shopping_how = document.getElementById('s1_shopping_how').value;
      s.s1_shopping_how_other = document.getElementById('s1_shopping_how_other').value;
      s.s1_meal_prep = document.getElementById('s1_meal_prep').value;
      s.s1_meal_prep_how = document.getElementById('s1_meal_prep_how').value;
      s.s1_dishwash = document.getElementById('s1_dishwash').value;
      s.s1_dishwash_how = document.getElementById('s1_dishwash_how').value;
      s.s1_dishwash_how_other = document.getElementById('s1_dishwash_how_other').value;
      s.s1_housework = document.getElementById('s1_housework').value;
      s.s1_housework_how = document.getElementById('s1_housework_how').value;
      s.s1_finance = document.getElementById('s1_finance').value;
      s.s1_finance_how = document.getElementById('s1_finance_how').value;
      s.s1_sleep = document.getElementById('s1_sleep').value;
      s.s1_sleep_reason = document.getElementById('s1_sleep_reason').value;
      s.s1_sleep_reason_detail = document.getElementById('s1_sleep_reason_detail').value;
      s.s1_sleep_reason_other = document.getElementById('s1_sleep_reason_other').value;
      s.s1_daytime = document.getElementById('s1_daytime').value;
      s.s1_mood_behaviors = collectChecks('s1_mood_behaviors_box');
      s.s1_motivation = document.getElementById('s1_motivation').value;
      s.s1_devices = collectChecks('s1_devices_box');
      s.s1_devices_note = document.getElementById('s1_devices_note').value;

      // 疾病/用藥/就醫
      s.s1_dhx = collectChecks('s1_dhx_box','s1_dhx_other');
      s.s1_surgery = document.getElementById('s1_surgery').value;
      s.s1_allergy = document.getElementById('s1_allergy').value;
      s.s1_follow_clinic = document.getElementById('s1_follow_clinic').value;
      s.s1_rx_type = document.getElementById('s1_rx_type').value;
      s.s1_med_manage = document.getElementById('s1_med_manage').value;
      let vt = document.getElementById('s1_visit_transport').value;
      const vtOther = (document.getElementById('s1_visit_transport_other').value||'').trim();
      if(vt==='其他') vt = vtOther;
      s.s1_visit_transport = vt;
      s.s1_med_classes = collectChecks('s1_med_classes_box','s1_med_classes_other');

      // 身障
      const disLevelEl=document.getElementById('s2_dis_level');
      const disCatEl=document.getElementById('s2_dis_cat');
      const disLevel = disLevelEl ? disLevelEl.value : '';
      let disCat = '';
      if(disLevel && disLevel !== '無' && disCatEl){
        disCat = disCatEl.value || '';
      }
      s.s1_dis_level = disLevel; // 段一身障等級（讀取自段二）
      s.s1_dis_cat = disCat;     // 段一身障類別（讀取自段二）

      // 補充
      s.s1_actions = collectActionEntries();
      s.s1_notes = document.getElementById('s1_notes').value;

      return s;
    }

    function validateSection1(){
      resetSection1Validation();
      const messages=[];

      const hearingDetails = collectHearingDetails();
      const needDeviceStatus = Array.isArray(hearingDetails) && hearingDetails.some(item => /助聽器|擴音/.test(item));
      if (needDeviceStatus) {
        const adherence = (document.getElementById('s1_hearing_device_adherence')?.value || '').trim();
        if (!adherence) {
          messages.push('請選擇助聽器/擴音使用情形');
          markSection1Invalid('s1_hearing_device_adherence');
        }
      }

      const phoneStatus = (document.getElementById('s1_phone')?.value || '').trim();
      if (phoneStatus && phoneStatus !== '會撥打與接聽') {
        const phoneChecks = [...document.querySelectorAll('#s1_phone_note_box input[type=checkbox]:checked')];
        if (!phoneChecks.length) {
          messages.push('請勾選電話使用原因');
          markSection1Invalid('s1_phone_note_box');
        }
        const otherPhone = document.querySelector('#s1_phone_note_box input[value="其他"]');
        if (otherPhone && otherPhone.checked) {
          const otherVal = (document.getElementById('s1_phone_note_other')?.value || '').trim();
          if (!otherVal) {
            messages.push('請填寫電話使用其他原因');
            markSection1Invalid('s1_phone_note_other');
          }
        }
      }

      const nocturiaInput=document.getElementById('s1_nocturia_count');
      const nocturiaCount=nocturiaInput ? Number(nocturiaInput.value) : 0;
      const hasNightBag=!!document.querySelector('#s1_excretion_aids_box input[value="夜間集尿袋"]:checked');
      if(!Number.isNaN(nocturiaCount) && nocturiaCount >= 1 && hasNightBag){
        messages.push('夜間記錄排尿次數時不可同時勾選夜間集尿袋');
        markSection1Invalid('s1_nocturia_count');
        markSection1Invalid('s1_excretion_aids_box');
      }

      const painOn = document.getElementById('s1_pain').value === '有';
      let painScoreError='';
      let painLocationError='';
      if(painOn){
        const score = document.getElementById('s1_pain_score').value;
        const scoreNum = Number(score);
        if(!score || Number.isNaN(scoreNum) || scoreNum < 1 || scoreNum > 10){
          messages.push('請填寫疼痛強度（1-10）');
          markSection1Invalid('s1_pain_score');
          painScoreError='請輸入 1–10 分的疼痛強度';
        }
        const painLoc = getLocationData('pain');
        let missingLocation=false;
        if(!painLoc.region){
          messages.push('請選擇疼痛部位大分類');
          switchLocationContext('pain');
          markSection1Invalid('s1_location_region');
          missingLocation=true;
        }
        if(!painLoc.subChoice){
          messages.push('請選擇疼痛細部分位');
          switchLocationContext('pain');
          markSection1Invalid('s1_location_subregion');
          missingLocation=true;
        }else if(painLoc.subChoice==='其他' && !painLoc.subOther){
          messages.push('請填寫疼痛細部分位（其他）');
          switchLocationContext('pain');
          markSection1Invalid('s1_location_subregion_other');
          missingLocation=true;
        }
        if(SYMMETRIC_PARTS.has(getLocationSubregionText(painLoc))){
          if(!painLoc.laterality){
            messages.push('請選擇疼痛側別');
            switchLocationContext('pain');
            markSection1Invalid('s1_location_laterality');
            missingLocation=true;
          }
        }
        if(missingLocation){
          painLocationError='請完整填寫疼痛部位';
        }
      }
      setFieldError('s1_pain_score_error', painOn ? painScoreError : '');
      setFieldError('s1_pain_location_error', painOn ? painLocationError : '');

      const lesionOn = document.getElementById('s1_lesion_has').value === '有';
      let lesionSizeError='';
      if(lesionOn){
        const lesionLoc = getLocationData('lesion');
        if(!lesionLoc.region){
          messages.push('請選擇病灶部位大分類');
          switchLocationContext('lesion');
          markSection1Invalid('s1_location_region');
        }
        if(!lesionLoc.subChoice){
          messages.push('請選擇病灶細部分位');
          switchLocationContext('lesion');
          markSection1Invalid('s1_location_subregion');
        }else if(lesionLoc.subChoice==='其他' && !lesionLoc.subOther){
          messages.push('請填寫病灶細部分位（其他）');
          switchLocationContext('lesion');
          markSection1Invalid('s1_location_subregion_other');
        }
        if(SYMMETRIC_PARTS.has(getLocationSubregionText(lesionLoc))){
          if(!lesionLoc.laterality){
            messages.push('請選擇病灶側別');
            switchLocationContext('lesion');
            markSection1Invalid('s1_location_laterality');
          }
        }

        const layerSel = document.getElementById('s1_lesion_layer').value;
        const layerOther = (document.getElementById('s1_lesion_layer_other').value||'').trim();
        if(!layerSel){ messages.push('請選擇病灶層次'); markSection1Invalid('s1_lesion_layer'); }
        else if(layerSel==='其他' && !layerOther){ messages.push('請填寫病灶層次（其他）'); markSection1Invalid('s1_lesion_layer_other'); }

        const sizeState=getLesionSizeState();
        if(sizeState.lenNum===null || sizeState.widNum===null){
          messages.push('請填寫病灶大小（長、寬）');
          if(sizeState.lenNum===null) markSection1Invalid('s1_lesion_length');
          if(sizeState.widNum===null) markSection1Invalid('s1_lesion_width');
          lesionSizeError='請輸入長度與寬度（需大於 0 cm）';
        }

        const sx = collectChecks('s1_lesion_sx_box');
        if(!Array.isArray(sx) || !sx.length){ messages.push('請勾選至少一項病灶症狀'); markSection1Invalid('s1_lesion_sx_box'); }

      const evalSel = document.getElementById('s1_lesion_eval').value;
      if(evalSel && evalSel!=='未評估'){
        const hosp = (document.getElementById('s1_lesion_hospital').value||'').trim();
        if(!hosp){ messages.push('請填寫醫療院所名稱'); markSection1Invalid('s1_lesion_hospital'); }
      }
    }
    setFieldError('s1_lesion_size_error', lesionOn ? lesionSizeError : '');

      const actionEntries = readActionEntries();
      let actionError='';
      actionEntries.forEach(entry=>{
        const hasSource = !!entry.source;
        const hasText = !!entry.text;
        if(hasText && !hasSource){
          if(!actionError){ messages.push('請為建議措施選擇來源'); }
          if(entry.select) entry.select.classList.add('input-invalid');
          actionError = actionError || '請為建議措施選擇來源';
        }else if(hasSource && !hasText){
          if(!actionError){ messages.push('請填寫建議措施內容'); }
          if(entry.textarea) entry.textarea.classList.add('input-invalid');
          actionError = actionError || '請填寫建議措施內容';
        }
      });
      setFieldError('s1_actions_error', actionError);

      const box=document.getElementById('section1_errors');
      if(box){
        if(messages.length){
          box.innerHTML = `<ul>${messages.map(msg=>`<li>${msg}</li>`).join('')}</ul>`;
          box.style.display='';
        }else{
          box.innerHTML='';
          box.style.display='none';
        }
      }

      return { ok: messages.length===0, messages };
    }

    // 產文（新版）
    function buildSection1Text_v2(s) {
      const has = v => {
        if(Array.isArray(v)) return v.length > 0;
        return v !== undefined && v !== null && String(v).trim() !== "";
      };
      const join = arr => arr.filter(Boolean).join("，");
      const listCN = arr => arr.filter(Boolean).join("、");
      const sexWord = g => g === "男" ? "男性" : g === "女" ? "女性" : (g || "");
      function formatLocation(region, subChoice, subValue, subOther, laterality) {
        const parts = [];
        if (has(region)) parts.push(region);
        let subText = '';
        if (subChoice === '其他') {
          subText = has(subOther) ? `其他（${subOther}）` : '其他';
        } else {
          subText = subValue;
        }
        if (has(subText)) parts.push(subText);
        let text = parts.join('－');
        if (has(laterality)) text += `（${laterality}）`;
        return text;
      }
      function formatUrination(choice, isOther, value, extra) {
        if (isOther) {
          return has(value) ? `其他（${value}）` : '其他';
        }
        let text = choice || value || '';
        if (has(extra) && text && text !== '夜間未起夜') {
          text += `（夜尿 ${extra} 次）`;
        }
        return text;
      }
      function formatFallHistory(history, times) {
        if (!has(history)) return '';
        const count = has(times) ? Number(times) : NaN;
        switch (String(history)) {
          case '無':
            return '近一年無跌倒紀錄';
          case '過去1年1次':
            if (!Number.isNaN(count) && count > 0) return `過去一年曾跌倒${count}次`;
            return '過去一年曾跌倒1次';
          case '過去1年≧2次':
            if (!Number.isNaN(count) && count > 0) return `過去一年曾跌倒${count}次`;
            return '過去一年跌倒兩次以上';
          case '不明':
            return '跌倒史不明';
          default:
            return `跌倒史：${history}`;
        }
      }

      const EXCRETION_OUTPUT_MAP = {
        '紙尿褲': '使用紙尿褲',
        '尿墊': '使用尿墊',
        '便盆椅': '排泄依靠便盆椅',
        '尿壺': '使用尿壺協助排尿',
        '留置導尿管': '以留置導尿管排尿',
        '間歇導尿管': '以間歇導尿管排尿',
        '尿造口袋': '使用尿造口袋收集尿液',
        '糞造口袋': '使用糞造口袋收集排泄物',
        '夜間集尿袋': '夜間需使用集尿袋'
      };
      function formatExcretionAids(list) {
        const arr = Array.isArray(list) ? list : [];
        return arr.map(item => EXCRETION_OUTPUT_MAP[item] || `使用${item}`);
      }

      const DEVICE_OUTPUT_MAP = {
        '鼻胃管': '目前以鼻胃管進食',
        '胃造口管（PEG）': '使用胃造口管餵食',
        '氣切管': '留置氣切管維持呼吸道暢通',
        '鼻導管氧氣': '使用鼻導管給氧',
        '氧氣機': '使用氧氣機輔助呼吸',
        '中心靜脈導管': '留置中心靜脈導管',
        'PICC 導管': '留置 PICC 導管',
        '呼吸輔助器（CPAP）': '持續使用 CPAP 呼吸輔助器',
        '雙水平呼吸器（BiPAP）': '持續使用 BiPAP 呼吸輔助器',
        '血糖機': '透過血糖機監測血糖',
        '藥盒': '使用藥盒管理用藥'
      };
      function formatDeviceUsage(list, note) {
        const arr = Array.isArray(list) ? list : [];
        const sentences = arr.map(item => DEVICE_OUTPUT_MAP[item] || item);
        if (sentences.length && has(note)) {
          sentences[sentences.length - 1] += `（${note}）`;
        } else if (!sentences.length && has(note)) {
          sentences.push(note);
        }
        return sentences;
      }

      const PHONE_STATUS_TEXT = {
        '會撥打與接聽': '電話操作無困難',
        '僅能接聽': '僅能接聽電話，不會撥打',
        '不會使用': '電話使用困難'
      };
      const PHONE_NOTE_TEXT = {
        '重聽需擴音': '需擴音設備',
        '易受詐騙': '曾多次受詐騙電話干擾'
      };
      function formatPhoneUsage(status, notes) {
        if (!has(status)) return '';
        const base = PHONE_STATUS_TEXT[status] || `電話${status}`;
        const extras = (Array.isArray(notes) ? notes : []).map(note => PHONE_NOTE_TEXT[note] || note);
        if (extras.length) {
          return `${base}，${extras.join('，')}`;
        }
        return base;
      }

      function phraseAwareness(v) {
        if (!has(v)) return "";
        switch (String(v)) {
          case "清楚": return "意識清楚";
          case "遲鈍": return "意識遲鈍";
          case "混亂": return "意識混亂";
          case "模糊": return "意識模糊";
          case "嗜睡": return "呈嗜睡狀態";
          case "昏迷": return "呈昏迷狀態";
          default: return `意識${v}`;
        }
      }
      function phraseCognition(v) {
        if (!has(v)) return "";
        switch (String(v)) {
          case "清楚可應答":     return "認知清楚可應答";
          case "需重複或放慢":   return "認知需重複或放慢";
          case "健忘／短期記憶不佳": return "認知健忘明顯";
          case "表達或理解困難": return "表達或理解困難";
          case "無法溝通":       return "無法溝通";
          case "無法評估":       return "認知狀態無法評估";
          default:               return `認知${v}`;
        }
      }
      function phraseVision(v) {
        if (!has(v)) return "";
        switch (String(v)) {
          case "視力清晰": return "視力清晰";
          case "靠近才能辨識": return "辨識時需額外光源及靠近物體";
          case "即使配戴眼鏡，仍難以辨識": return "即使配戴眼鏡，仍難以辨識";
          case "僅能分辨明暗，無法辨識人臉或物體輪廓": return "僅能分辨明暗，無法辨識人臉或物體輪廓";
          case "完全失去視覺功能，無法感知光線": return "完全失去視覺功能，無法感知光線";
          default: return v;
        }
      }

      // ① 基本
      const header = [];
      if (has(s.s1_age) || has(s.s1_gender)) header.push(`${s.s1_age||""}歲${sexWord(s.s1_gender)||""}`);
      const aw = phraseAwareness(s.s1_awareness);
      const cg = phraseCognition(s.s1_cognition);
      if (aw || cg) header.push([aw, cg].filter(Boolean).join("，"));
      const langArr = Array.isArray(s.s1_lang) ? s.s1_lang : [];
      if (langArr.length) {
        let langText = `溝通以${listCN(langArr)}為主`;
        if (has(s.s1_lang_note)) langText += `（${s.s1_lang_note}）`;
        header.push(langText);
      }
      const p1 = header.join("，");

      // ② 視聽
      let visionPhrase = phraseVision(s.s1_vision);
      const vNotesRaw = [].concat(Array.isArray(s.s1_vision_note) ? s.s1_vision_note : (has(s.s1_vision_note) ? [s.s1_vision_note] : []));
      const vNotes = vNotesRaw.map(note=>{
        if (note === '配戴眼鏡' && has(s.s1_glasses_adherence)) {
          return `${note}（${s.s1_glasses_adherence}）`;
        }
        return note;
      });
      if (visionPhrase && vNotes.length) visionPhrase += `（${listCN(vNotes)}）`;
      let hearingPhrase = '';
      if (has(s.s1_hearing_level)) {
        hearingPhrase = `聽力${s.s1_hearing_level}`;
        const hearingDetails = Array.isArray(s.s1_hearing_details) ? s.s1_hearing_details.slice() : [];
        if (hearingDetails.length && has(s.s1_hearing_device_adherence)){
          for (let i=0;i<hearingDetails.length;i++){
            const detail = hearingDetails[i];
            if(detail==='借助助聽器才能理解' || detail==='使用擴音設備'){
              hearingDetails[i] = `${detail}（${s.s1_hearing_device_adherence}）`;
            }
          }
        }
        if (hearingDetails.length){
          hearingPhrase += `（${listCN(hearingDetails)}）`;
        }
      }
      const p2 = [visionPhrase, hearingPhrase].filter(Boolean).join("，");

      // ③ 疼痛/皮膚（合併）
      const painBits = [];
      if (String(s.s1_pain) === "有") {
        const painSite = formatLocation(
          s.s1_body_region,
          s.s1_subregion_choice,
          s.s1_subregion,
          s.s1_subregion_other,
          s.s1_laterality
        );
        painBits.push(`${painSite || '部位'}疼痛`);
        if (has(s.s1_pain_score)) painBits.push(`疼痛強度約 ${s.s1_pain_score}/10`);
      }
      const lesionBits = [];
      if (String(s.s1_lesion_has) === "有") {
        const lesionSite = formatLocation(
          s.s1_lesion_region,
          s.s1_lesion_subregion_choice,
          s.s1_lesion_subregion,
          s.s1_lesion_subregion_other,
          s.s1_lesion_laterality
        );
        const layer = has(s.s1_lesion_layer) ? s.s1_lesion_layer : '無';
        const size  = has(s.s1_lesion_size_text) ? s.s1_lesion_size_text : '無';
        const sxArr = Array.isArray(s.s1_lesion_sx) ? s.s1_lesion_sx : [];
        const sxTxt = sxArr.length ? listCN(sxArr) : '無不適';
        if (lesionSite) lesionBits.push(`病灶位於${lesionSite}`);
        lesionBits.push(`病灶層次：${layer}`);
        lesionBits.push(`大小：${size}`);
        lesionBits.push(`症狀：${sxTxt}`);
        lesionBits.push(`醫療評估：${s.s1_lesion_eval||'未評估'}`);
        if (has(s.s1_lesion_hospital) && s.s1_lesion_eval && s.s1_lesion_eval!=='未評估') {
          lesionBits.push(`醫療院所名稱：${s.s1_lesion_hospital}`);
        }
      }
      const p3 = [painBits.join('，'), lesionBits.join('，')].filter(Boolean).join('；');

      // 吞嚥/飲食/口腔
      const swallowBits=[];
      if (has(s.s1_swallow)) {
        let txt = `吞嚥${s.s1_swallow}`;
        if (s.s1_swallow !== '無困難') {
          const sxArr = Array.isArray(s.s1_swallow_sx) ? s.s1_swallow_sx : [];
          if (sxArr.length) txt += `（${listCN(sxArr)}）`;
        }
        swallowBits.push(txt);
      }
      const dietBits=[];
      const dietArr = Array.isArray(s.s1_diet_texture) ? s.s1_diet_texture : [];
      if (dietArr.length) dietBits.push(`飲食質地：${listCN(dietArr)}`);
      const tubeArr = Array.isArray(s.s1_feeding_tubes) ? s.s1_feeding_tubes : [];
      if (tubeArr.length) dietBits.push(`管灌方式：${listCN(tubeArr)}`);
      if (dietBits.length) swallowBits.push(dietBits.join('，'));
      const oralArr = Array.isArray(s.s1_oral) ? s.s1_oral : [];
      if (oralArr.length) {
        let oralText = `口腔狀況：${listCN(oralArr)}`;
        if (has(s.s1_oral_note)) oralText += `（${s.s1_oral_note}）`;
        swallowBits.push(oralText);
      }
      const pSwallow = swallowBits.join('；');

      // ④ 行動
      const moveBits=[];
      if (has(s.s1_transfer)) {
        let txt=`起身移位${s.s1_transfer}`;
        if((s.s1_transfer==='中度協助' || s.s1_transfer==='重度協助') && has(s.s1_transfer_how)){
          txt+=`（協助方式：${s.s1_transfer_how}）`;
        }
        moveBits.push(txt);
      }
      if (has(s.s1_walk_indoor)) moveBits.push(`在家${s.s1_walk_indoor}行走`);
      if (has(s.s1_walk_outdoor)) moveBits.push(`外出${s.s1_walk_outdoor}輔助`);
      if (has(s.s1_stairs)) moveBits.push(`上下樓${s.s1_stairs}`);
      if (has(s.s1_weak_laterality) && s.s1_weak_laterality !== '無') {
        moveBits.push(`偏側無力：${s.s1_weak_laterality}`);
      }
      const fallText = formatFallHistory(s.s1_fall_history, s.s1_fall_times);
      if (has(fallText)) moveBits.push(fallText);
      const balanceArr = Array.isArray(s.s1_balance) ? s.s1_balance : [];
      if (balanceArr.length) moveBits.push(`平衡狀態：${listCN(balanceArr)}`);
      if (has(s.s1_sitting_stability)) {
        let sitText = s.s1_sitting_stability === '穩定' ? '坐姿穩定' : `坐姿${s.s1_sitting_stability}`;
        const supportArr = Array.isArray(s.s1_sitting_supports) ? s.s1_sitting_supports : [];
        if (supportArr.length) sitText += `，需${listCN(supportArr)}`;
        moveBits.push(sitText);
      }
      if (has(s.s1_gait)) {
        let gaitText = s.s1_gait;
        if (gaitText === '其他' && has(s.s1_gait_note)) {
          gaitText = s.s1_gait_note;
        } else if (has(s.s1_gait_note)) {
          gaitText += `（${s.s1_gait_note}）`;
        }
        moveBits.push(`步態${gaitText}`);
      }
      const p4 = moveBits.join("，");

      // ⑤ ADL/排泄
      const adlBits=[];
      if (has(s.s1_adl_eating)){
        let txt=`進食${s.s1_adl_eating}`;
        if(s.s1_adl_eating==='部分協助' && has(s.s1_adl_eating_how)) txt+=`（部分協助方式：${s.s1_adl_eating_how}）`;
        adlBits.push(txt);
      }
      const adlSubArr=[];
      if (has(s.s1_adl_groom)){
        let txt=`刷牙/洗臉${s.s1_adl_groom}`;
        if(s.s1_adl_groom==='部分協助' && has(s.s1_adl_groom_how)) txt+=`（部分協助方式：${s.s1_adl_groom_how}）`;
        adlSubArr.push(txt);
      }
      if (has(s.s1_adl_bathing)){
        let txt=`洗澡${s.s1_adl_bathing}`;
        if(s.s1_adl_bathing==='部分協助' && has(s.s1_adl_bathing_how)) txt+=`（部分協助方式：${s.s1_adl_bathing_how}）`;
        adlSubArr.push(txt);
      }
      if (has(s.s1_adl_dressing)){
        let txt=`穿脫衣${s.s1_adl_dressing}`;
        if(s.s1_adl_dressing==='部分協助' && has(s.s1_adl_dressing_how)) txt+=`（部分協助方式：${s.s1_adl_dressing_how}）`;
        adlSubArr.push(txt);
      }
      const adlSub=adlSubArr.join("、");
      if (adlSub) adlBits.push(adlSub);
      const deviceArr = Array.isArray(s.s1_devices) ? s.s1_devices : [];
      const deviceSentences = formatDeviceUsage(deviceArr, s.s1_devices_note);
      if (deviceSentences.length) {
        adlBits.push(deviceSentences.join('、'));
      }
      const toiletBits=[];
      const dayUrine = formatUrination(s.s1_urine_day_choice, s.s1_urine_day_is_other, s.s1_urine_day);
      const excretionArr = Array.isArray(s.s1_excretion_aids) ? s.s1_excretion_aids : [];
      const nightCatheter = excretionArr.some(v=>['留置導尿管','間歇導尿管','尿造口袋','糞造口袋','夜間集尿袋'].includes(v));
      const excretionSentences = formatExcretionAids(excretionArr);
      if (excretionSentences.length) toiletBits.push(excretionSentences.join('、'));
      if (has(dayUrine)) toiletBits.push(`白天排尿${dayUrine}`);
      if (nightCatheter) {
        toiletBits.push('夜間以導尿／集尿袋處理，不以起夜次數評估');
      } else {
        const nightUrine = formatUrination(s.s1_urine_night_choice, s.s1_urine_night_is_other, s.s1_urine_night, s.s1_nocturia_count);
        if (has(nightUrine)) toiletBits.push(`夜間排尿${nightUrine}`);
      }
      if (has(s.s1_post_toilet)){
        let txt=`如廁後清潔${s.s1_post_toilet}`;
        if(s.s1_post_toilet==='部分協助' && has(s.s1_post_toilet_how)) txt+=`（部分協助方式：${s.s1_post_toilet_how}）`;
        toiletBits.push(txt);
      }
      const p5 = [adlBits.join("；"), toiletBits.join("，")].filter(Boolean).join("；");

      // ⑥ 生活管理/睡眠
      const lifeBits=[];
      if (has(s.s1_phone)) {
        const phoneArr = Array.isArray(s.s1_phone_notes) ? s.s1_phone_notes : [];
        const phoneText = formatPhoneUsage(s.s1_phone, phoneArr);
        if (has(phoneText)) lifeBits.push(phoneText);
      }
      if (has(s.s1_shopping)){
        let shopping = s.s1_shopping;
        if((shopping==='需陪同' || shopping==='不外出') && has(s.s1_shopping_how)){
          let how = s.s1_shopping_how;
          if(how==='其他' && has(s.s1_shopping_how_other)) how = s.s1_shopping_how_other;
          if(has(how)) shopping += `（${how}）`;
        }
        lifeBits.push(`外出購物${shopping}`);
      }
      const mealBits=[];
      if (has(s.s1_meal_prep)){
        let txt=`備餐${s.s1_meal_prep}`;
        if(s.s1_meal_prep==='部分協助' && has(s.s1_meal_prep_how)) txt+=`（部分協助方式：${s.s1_meal_prep_how}）`;
        mealBits.push(txt);
      }
      if (has(s.s1_dishwash)){
        if(s.s1_dishwash==='無法自行清洗'){
          let how = s.s1_dishwash_how;
          if(how==='其他' && has(s.s1_dishwash_how_other)) how = s.s1_dishwash_how_other;
          if(!has(how)) how='由他人代辦';
          mealBits.push(`無法自行清洗餐具（${how}）`);
        }else{
          mealBits.push(`餐具清洗${s.s1_dishwash}`);
        }
      }
      if (has(s.s1_housework)){
        let txt=`家務整理${s.s1_housework}`;
        if(s.s1_housework==='部分協助' && has(s.s1_housework_how)) txt+=`（部分協助方式：${s.s1_housework_how}）`;
        mealBits.push(txt);
      }
      if (mealBits.length) lifeBits.push(mealBits.join("、"));
      if (has(s.s1_finance)){
        let txt=`具金錢觀念，財務管理${s.s1_finance}`;
        if(s.s1_finance==='部分協助' && has(s.s1_finance_how)) txt+=`（部分協助方式：${s.s1_finance_how}）`;
        lifeBits.push(txt);
      }
      if (has(s.s1_sleep)){
        let sleep = s.s1_sleep;
        if(s.s1_sleep!=='良好' && has(s.s1_sleep_reason)){
          let reason = s.s1_sleep_reason;
          if(reason==='其他' && has(s.s1_sleep_reason_other)){
            reason = s.s1_sleep_reason_other;
          }else if(has(s.s1_sleep_reason_detail)){
            reason += `：${s.s1_sleep_reason_detail}`;
          }
          sleep += `（${reason}）`;
        }
        lifeBits.push(`睡眠${sleep}`);
      }
      if (has(s.s1_daytime)) lifeBits.push(`白天活動以${s.s1_daytime}為主`);
      const moodArr = Array.isArray(s.s1_mood_behaviors) ? s.s1_mood_behaviors : [];
      if (moodArr.length) lifeBits.push(`情緒／行為：${listCN(moodArr)}`);
      if (has(s.s1_motivation)) lifeBits.push(`執行動機：${s.s1_motivation}`);
      const p6 = lifeBits.join("，");

      // ⑦ 疾病/用藥/就醫
      const dxArr = Array.isArray(s.s1_dhx)? s.s1_dhx : (has(s.s1_dhx)?[s.s1_dhx]:[]);
      const medArr= Array.isArray(s.s1_med_classes)? s.s1_med_classes : (has(s.s1_med_classes)?[s.s1_med_classes]:[]);
      const rxBits = [s.s1_rx_type, medArr.length ? listCN(medArr) : null].filter(Boolean);
      const p7 = join([
        dxArr.length ? `慢性病史包含：${listCN(dxArr)}` : null,
        has(s.s1_surgery) ? s.s1_surgery : null,
        (has(s.s1_follow_clinic)||rxBits.length)
          ? `定期於${s.s1_follow_clinic||"既定醫療院所"}就醫${rxBits.length?`（${rxBits.join("、")}）`:''}` : null,
        (has(s.s1_med_manage)||has(s.s1_visit_transport))
          ? `平時${s.s1_med_manage||""}，並以${s.s1_visit_transport||"既定方式"}就醫` : null
      ]);

      // ⑧ 身障資訊移至經濟收入段落，故此不輸出
      const p8 = "";

      // ⑨ 補充（有才輸出）
      const p9 = has(s.s1_notes) ? s.s1_notes : "";
      function formatActions(actions){
        if(Array.isArray(actions)){
          const items = actions.filter(item=>item && has(item.source) && has(item.text));
          if(!items.length) return "";
          const parts = items.map(item=>`【${item.source}】${item.text}`);
          return `建議措施：${parts.join('；')}`;
        }
        if(has(actions)) return String(actions);
        return "";
      }

      const actionText = formatActions(s.s1_actions);

      const segments=[p1,p2,p3,p4,pSwallow,p5,p6,p7,actionText,p9].filter(Boolean);
      return `${segments.join("。")}。`;
    }

    function buildSection1(presetValidation){
      const validation = presetValidation || validateSection1();
      if(!validation.ok){
        document.getElementById('section1_out').value = '';
        const msg = validation.messages.length ? validation.messages.join('、') : '請補齊必填欄位';
        document.getElementById('section1_preview').textContent = `（一）身心概況：${msg}`;
        return '';
      }
      const s = collectS1();
      const text = buildSection1Text_v2(s);
      document.getElementById('section1_out').value = text;
      document.getElementById('section1_preview').textContent = `（一）身心概況：${text}`;
      return text;
    }

    /* ===== 四-(二) 經濟收入：原程式 ===== */
    const S2_SOURCES = ['退休金（軍公教/勞退）','老人福利津貼','勞保/農保年金','身心障礙生活補助','社會福利補助','子女/親屬支持','儲蓄/投資收益','房租收入','其他'];
    const S2_CATS = [
      '第一類：神經系統構造及精神、心智功能',
      '第二類：眼、耳及相關構造與感官功能及疼痛',
      '第三類：涉及聲音與言語構造及其功能',
      '第四類：循環、造血、免疫與呼吸系統構造及其功能',
      '第五類：消化、新陳代謝與內分泌系統相關構造及其功能',
      '第六類：泌尿與生殖系統相關構造及其功能',
      '第七類：神經、肌肉、骨骼之移動相關構造及其功能',
      '第八類：皮膚與相關構造及其功能',
      '未註明'
    ];
    function renderS2(){
      const host=document.getElementById('s2_sources'); host.innerHTML='';
      S2_SOURCES.forEach((name,i)=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="buildS2()"> ${name}`;
        host.appendChild(lab);
      });
      const catSel=document.getElementById('s2_dis_cat');
      if(catSel){
        catSel.innerHTML=''; // 段二身障類別選單
        S2_CATS.forEach(c=>{ // 產生類別選項
          const o=document.createElement('option'); o.textContent=c; catSel.appendChild(o); // 段二加入選項
        });
      }
    }
    function toggleDisCategory(){
      const levelEl=document.getElementById('s2_dis_level');
      if(!levelEl) return;
      const catEl=document.getElementById('s2_dis_cat');
      const level = levelEl ? levelEl.value : '';
      const cat = catEl ? catEl.value : '';
      const showCat = level && level !== '無';
      const box2=document.getElementById('disCatBox');
      if(box2) box2.style.display = showCat ? '' : 'none';

      const levelText=document.getElementById('s1_dis_level_text');
      if(levelText) levelText.textContent = level || '—';
      const box1=document.getElementById('s1_dis_cat_box');
      if(box1) box1.style.display = showCat ? '' : 'none';
      const catText=document.getElementById('s1_dis_cat_text');
      if(catText) catText.textContent = showCat ? (cat || '未註明') : '—';

      buildS2(); // 更新經濟收入段落
    }
    function buildS2(){
      const srcs=[...document.querySelectorAll('#s2_sources input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      const id=document.getElementById('s2_id').value;
      const lv=document.getElementById('s2_dis_level').value;
      const catSel=document.getElementById('s2_dis_cat'); const cat=(catSel && catSel.value)? catSel.value : '';
      let s='';
      if(srcs.length) s+=`主要經濟來源為${srcs.join('、')}`;
      if(id){ s += (s? '，':'') + `戶籍/福利身分為${id}`; }
      if(lv && lv!=='無'){ s += `；身障等級：${lv}${cat? '（'+cat+'）':''}`; }
      if(s) s+='。';
      document.getElementById('section2_out').value=s;
    }

    /* ===== 四-(三) 居住環境：原程式 ===== */
    const S3_FAC = ['扶手','止滑','斜坡','樓梯升降設備'];
    const S3_AIDS= ['輪椅','助行器','拐杖','照顧床','氣墊床','便盆椅','助行拐'];
    function renderS3(){
      const facHost=document.getElementById('s3_fac'); facHost.innerHTML='';
      S3_FAC.forEach((name)=>{const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" value="${name}" onchange="buildS3()"> ${name}`; facHost.appendChild(lab);});
      const aidsHost=document.getElementById('s3_aids'); aidsHost.innerHTML='';
      S3_AIDS.forEach((name)=>{const lab=document.createElement('label'); lab.innerHTML=`<input type="checkbox" value="${name}" onchange="buildS3()"> ${name}`; aidsHost.appendChild(lab);});
    }
    function toggleOtherType(){
      const sel=document.getElementById('s3_type'); const on= sel.value==='其他';
      document.getElementById('s3_type_other').style.display= on?'':'none';
      buildS3();
    }
    function toggleRentFields(){
      const ownSelect=document.getElementById('s3_own');
      const amountWrap=document.getElementById('s3_rent_amount_wrap');
      const feeWrap=document.getElementById('s3_rent_fee_wrap');
      const isRent=ownSelect && ownSelect.value==='租賃';
      if(amountWrap) amountWrap.style.display = isRent ? '' : 'none';
      if(feeWrap) feeWrap.style.display = isRent ? '' : 'none';
      if(!isRent){
        const amountInput=document.getElementById('s3_rent_amount');
        const feeSelect=document.getElementById('s3_rent_fee');
        if(amountInput){ amountInput.value=''; amountInput.classList.remove('input-invalid'); }
        if(feeSelect){ feeSelect.value=''; feeSelect.classList.remove('input-invalid'); }
      }
      buildS3();
    }
    function buildS3(){
      const typeSel=document.getElementById('s3_type'); let type=typeSel.value;
      if(type==='其他'){ const t=document.getElementById('s3_type_other').value.trim(); if(t) type=t; }
      const own=document.getElementById('s3_own').value;
      const rentAmountInput=document.getElementById('s3_rent_amount');
      const rentFeeSelect=document.getElementById('s3_rent_fee');
      let rentInfo='';
      if(own==='租賃'){
        const rawAmount=(rentAmountInput?.value || '').trim();
        const feeValue=(rentFeeSelect?.value || '').trim();
        if(rawAmount){
          const numeric=parseInt(rawAmount,10);
          const formatted=!Number.isNaN(numeric) && numeric>=0 ? numeric.toLocaleString('zh-TW') : rawAmount;
          rentInfo = `月租${formatted}元`;
          if(feeValue){ rentInfo += `（${feeValue}）`; }
        }else if(feeValue){
          rentInfo = feeValue;
        }
      }
      const clean=document.getElementById('s3_clean').value;
      const smell=document.getElementById('s3_smell').value;
      const fac=[...document.querySelectorAll('#s3_fac input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      const aids=[...document.querySelectorAll('#s3_aids input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      if(!type) { document.getElementById('section3_out').value=''; return; }
      let base=`現居住於${own}${type}`;
      if(rentInfo){ base += `，${rentInfo}`; }
      let s=`${base}，環境整潔度${clean}，${smell==='無'?'無異味':(smell+'異味')}。`;
      if(fac.length) s+=`無障礙設施：${fac.join('、')}。`;
      if(aids.length) s+=`已備輔具：${aids.join('、')}。`;
      document.getElementById('section3_out').value=s;
    }

    /* ===== 四-(四) 社會支持：原程式 ===== */
    const FORMAL = ['居家服務','專業服務','日間照顧','喘息服務','交通接送','無障礙及輔具','營養送餐'];
    const DEFAULT_SERVICE_CATALOG = {
      needLevelCaps: {
        '2': 10020,
        '3': 15460,
        '4': 18580,
        '5': 24100,
        '6': 28070,
        '7': 32090,
        '8': 36180
      },
      dayCareRequirements: {},
      dayCareLevels: {},
      serviceRates: {},
      transportRoundTrips: 2
    };
    let SERVICE_CATALOG = JSON.parse(JSON.stringify(DEFAULT_SERVICE_CATALOG));
    const HOME_CARE_ITEMS = [
      {
        code: 'BA01',
        name: '基本身體清潔',
        short: '協助個案完成基本身體清潔，維持良好衛生狀態，提升個人舒適感與自尊。',
        mid: '持續安排身體清潔服務，確保個案日常生活中維持清爽與健康，避免感染風險。',
        long: '建立穩定的清潔照護習慣，確保個案長期維持身體衛生與健康品質。'
      },
      {
        code: 'BA02',
        name: '基本日常照顧',
        short: '協助個案完成基本日常照顧活動，改善生活便利性。',
        mid: '持續提供日常照護支持，讓個案逐步形成規律生活，減少依賴與不便。',
        long: '透過長期支持，協助個案穩定自理能力，提升日常生活品質與安全感。'
      },
      {
        code: 'BA03',
        name: '測量生命徵象',
        short: '協助測量生命徵象，掌握個案即時健康狀態。',
        mid: '持續安排定期測量，讓健康狀況獲得追蹤與管理，及時回應變化。',
        long: '透過長期監測生命徵象，維持穩定的健康管理，預防突發狀況。'
      },
      {
        code: 'BA04',
        name: '協助進食或管灌餵食',
        short: '協助個案進食或管灌餵食，確保營養攝取充足，避免饑餓或體力下降。',
        mid: '持續安排餵食服務，維持營養平衡與健康狀況。',
        long: '建立穩定飲食支持機制，確保個案長期營養狀態良好，促進生活品質。'
      },
      {
        code: 'BA05',
        name: '餐食照顧',
        short: '協助個案處理餐食，確保用餐便利與安全。',
        mid: '持續安排餐食照顧，幫助個案維持飲食規律與營養。',
        long: '透過餐食支持，協助個案養成健康飲食習慣，長期維持良好營養狀態。'
      },
      {
        code: 'BA07',
        name: '協助沐浴及洗頭',
        short: '協助個案完成沐浴與洗頭，改善個人清潔與舒適度。',
        mid: '持續提供沐浴服務，協助維持個人衛生與清爽狀態。',
        long: '透過穩定支持，確保個案長期維持良好的身體清潔與尊嚴。'
      },
      {
        code: 'BA08',
        name: '足部照護',
        short: '協助進行足部清潔與照護，改善足部舒適與行動便利。',
        mid: '持續安排足部照護，預防感染或相關併發症，維持健康。',
        long: '確保持續照護，讓個案足部健康穩定，提升生活功能與行動力。'
      },
      {
        code: 'BA09',
        name: '到宅沐浴車服務—第一型',
        short: '安排到宅沐浴車（第一型），由專業人員與設備協助安全完成全身沐浴與清潔。',
        mid: '持續規劃第一型到宅沐浴車服務，確保定期洗浴、觀察皮膚狀況並降低跌倒風險。',
        long: '建立穩定的第一型到宅沐浴車服務流程，讓個案長期維持衛生習慣並減輕照顧者負擔。'
      },
      {
        code: 'BA09a',
        name: '到宅沐浴車服務—第二型',
        short: '安排到宅沐浴車（第二型），提供高照護需求者安全完整的沐浴與清潔支持。',
        mid: '持續使用第二型沐浴車服務，配合雙人協助與專業設備維持皮膚健康與舒適。',
        long: '長期串接第二型到宅沐浴車服務，確保高需求個案規律沐浴並維持身體潔淨。'
      },
      {
        code: 'BA10',
        name: '翻身拍背',
        short: '協助翻身拍背，預防壓瘡與改善呼吸狀況。',
        mid: '持續提供翻身支持，確保身體循環與舒適度。',
        long: '建立長期照護機制，減少壓瘡與呼吸道問題，確保健康穩定。'
      },
      {
        code: 'BA11',
        name: '肢體關節活動',
        short: '協助個案進行肢體關節活動，促進血液循環並改善活動力。',
        mid: '持續安排關節活動，維持肢體功能與肌肉力量。',
        long: '透過長期支持，預防關節僵硬或退化，確保持續活動能力。'
      },
      {
        code: 'BA12',
        name: '協助上下樓梯',
        short: '協助個案安全上下樓梯，改善行動便利與生活範圍。',
        mid: '持續提供上下樓梯支持，讓個案能穩定參與日常活動。',
        long: '建立穩定照護，確保個案長期安全行動，減少跌倒風險。'
      },
      {
        code: 'BA13',
        name: '陪同外出',
        short: '協助陪同外出，增加社會參與與心理支持。',
        mid: '持續安排外出陪伴，維持社交互動與生活樂趣。',
        long: '透過長期支持，協助個案保持社交網絡，提升生活品質。'
      },
      {
        code: 'BA14',
        name: '陪同就醫',
        short: '協助陪同就醫，確保醫療需求能即時獲得處理。',
        mid: '持續安排就醫陪伴，協助醫療追蹤與健康管理。',
        long: '透過長期就醫支持，維持個案健康穩定，減少延誤風險。'
      },
      {
        code: 'BA15',
        name: '家務協助',
        short: '協助處理家務，改善生活環境與便利性。',
        mid: '持續提供家務支持，確保日常生活穩定與整潔。',
        long: '建立長期家務支持，讓個案生活環境持續舒適與安全。'
      },
      {
        code: 'BA16',
        name: '代購或代領或代送服務',
        short: '協助代購、代領或代送生活物品，滿足即時需求並降低外出風險。',
        mid: '持續提供代購支持，確保生活所需穩定供應。',
        long: '透過長期協助，維持生活便利並減輕個案與家屬負擔。'
      },
      {
        code: 'BA17a',
        name: '人工氣道管內分泌物抽吸',
        short: '協助進行人工氣道管內分泌物抽吸，改善呼吸道通暢與舒適。',
        mid: '持續安排人工氣道分泌物抽吸支持，確保呼吸道暢通與健康。',
        long: '透過長期呼吸照護，維持個案呼吸安全並減少併發症。'
      },
      {
        code: 'BA17b',
        name: '口腔分泌物抽吸',
        short: '協助口腔分泌物抽吸，減輕不適與提升舒適度。',
        mid: '持續安排口腔照護，維持健康與安全。',
        long: '建立長期支持，避免併發症，確保生活品質。'
      },
      {
        code: 'BA17c',
        name: '尿管及鼻胃管之清潔與固定',
        short: '協助尿管及鼻胃管的清潔與固定，降低感染與滑脫風險。',
        mid: '持續安排管路照護，維持穩定使用。',
        long: '透過長期管路照護，減少併發症並確保生活品質。'
      },
      {
        code: 'BA17d1',
        name: '血糖機驗血糖',
        short: '協助血糖測量，掌握健康狀況。',
        mid: '持續追蹤血糖值，及時調整照護需求。',
        long: '建立長期監測，維持穩定健康管理。'
      },
      {
        code: 'BA17d2',
        name: '甘油球通便',
        short: '協助通便，緩解排便困難。',
        mid: '持續安排通便支持，維持腸道功能。',
        long: '透過長期照護，確保腸道健康與生活品質。'
      },
      {
        code: 'BA17e',
        name: '依指示置入藥盒',
        short: '協助依指示置入藥盒，改善用藥管理。',
        mid: '持續安排用藥支持，確保規律服藥。',
        long: '建立長期用藥管理，提升健康維護品質。'
      },
      {
        code: 'BA18',
        name: '安全看視',
        short: '協助安全看視，降低意外風險。',
        mid: '持續安排看視支持，確保日常安全。',
        long: '透過長期安全監護，維持穩定生活品質。'
      },
      {
        code: 'BA20',
        name: '陪伴服務',
        short: '協助陪伴，減輕孤單感並提供心理支持。',
        mid: '持續安排陪伴，維持社交互動與情感連結。',
        long: '建立長期陪伴關係，提升心理健康與生活滿意度。'
      },
      {
        code: 'BA22',
        name: '巡視服務',
        short: '協助巡視，關懷生活狀況與安全需求。',
        mid: '持續安排巡視服務，掌握個案生活穩定性。',
        long: '透過長期巡視支持，確保個案安全與生活品質。'
      },
      {
        code: 'BA23',
        name: '協助洗頭',
        short: '協助個案洗頭，改善清潔與舒適度。',
        mid: '持續安排洗頭支持，維持衛生與自尊。',
        long: '透過長期支持，確保持續清潔與健康。'
      },
      {
        code: 'BA24',
        name: '協助排泄',
        short: '協助排泄，維持基本生理需求。',
        mid: '持續安排排泄支持，確保健康與舒適。',
        long: '建立長期照護，避免併發症，維持生活品質。'
      }
    ];
    const HOME_CARE_MAP = {};
    HOME_CARE_ITEMS.forEach(item => { HOME_CARE_MAP[item.code] = item; });
    const DAY_CARE_ITEMS = [
      {
        code: 'BB01',
        name: '日間照顧（全日）—第一型',
        short: '安排第一型全日型日間照顧，依照評估提供生活照顧、健康促進與社交活動，協助建立規律作息並減輕照顧者壓力。',
        mid: '持續參與第一型全日日照，穩定完成生活照護與團體活動，團隊定期追蹤健康變化並與家屬討論調整。',
        long: '長期規律使用第一型全日日照，維持生活功能與情緒穩定，建立完整紀錄並與家庭合作支持照護。'
      },
      {
        code: 'BB02',
        name: '日間照顧（半日）—第一型',
        short: '安排第一型半日型日間照顧，提供生活照顧、健康促進及社交互動，協助建立固定出席並給予照顧者喘息。',
        mid: '持續參與第一型半日日照，穩定完成照護與訓練，團隊追蹤健康狀態並與家屬分享照護重點。',
        long: '長期使用第一型半日日照，維持作息與社交參與，並透過紀錄與回饋支持家庭照護安排。'
      },
      {
        code: 'BB03',
        name: '日間照顧（全日）—第二型',
        short: '安排第二型全日型日間照顧，強化生活照顧、復能訓練與團體參與，協助高需求者維持穩定作息。',
        mid: '持續參與第二型全日日照，依功能狀態調整活動強度，團隊定期與家屬檢視照顧成果。',
        long: '長期使用第二型全日日照，建立完整照護紀錄並維持自理度與情緒穩定，提供家屬長期支持。'
      },
      {
        code: 'BB04',
        name: '日間照顧（半日）—第二型',
        short: '安排第二型半日型日間照顧，結合生活照護與健康促進，協助高需求者在安全環境中參與團體。',
        mid: '持續參與第二型半日日照，依個案狀態調整訓練與活動，並由團隊提供照護建議。',
        long: '長期規律使用第二型半日日照，維持生活節奏與社交參與，並與家屬共同檢視照護策略。'
      },
      {
        code: 'BB05',
        name: '日間照顧（全日）—第三型',
        short: '安排第三型全日型日間照顧，提供密集生活照護、復能及健康監測，支援失能程度較高之個案。',
        mid: '持續參與第三型全日日照，透過團隊合作調整照護介入並追蹤健康變化。',
        long: '長期使用第三型全日日照，維持生活品質並記錄照護成效，協助家屬掌握狀況與資源。'
      },
      {
        code: 'BB06',
        name: '日間照顧（半日）—第三型',
        short: '安排第三型半日型日間照顧，提供高照護密度的生活協助與訓練，確保安全參與。',
        mid: '持續參與第三型半日日照，依健康狀況調整照護重點並提供家屬教學。',
        long: '長期使用第三型半日日照，維持生活功能與情緒穩定，減輕照顧者負擔。'
      },
      {
        code: 'BB07',
        name: '日間照顧（全日）—第四型',
        short: '安排第四型全日型日間照顧，結合專業照護與復能活動，支援複合型需求者。',
        mid: '持續參與第四型全日日照，團隊整合護理、復健與社交活動，滾動調整照護。',
        long: '長期使用第四型全日日照，建立跨專業照護模式，維持健康與社交參與。'
      },
      {
        code: 'BB08',
        name: '日間照顧（半日）—第四型',
        short: '安排第四型半日型日間照顧，提供複合照護需求者短時段支持與團體參與。',
        mid: '持續參與第四型半日日照，透過團隊監測健康與行為變化並提供策略。',
        long: '長期使用第四型半日日照，維持功能並支援家屬銜接照顧計畫。'
      },
      {
        code: 'BB09',
        name: '日間照顧（全日）—第五型',
        short: '安排第五型全日型日間照顧，提供高度照護與醫療協調，支援複雜照護需求。',
        mid: '持續參與第五型全日日照，團隊密切觀察病情並調整照護流程。',
        long: '長期使用第五型全日日照，確保醫療與社會資源串連，維持生活品質。'
      },
      {
        code: 'BB10',
        name: '日間照顧（半日）—第五型',
        short: '安排第五型半日型日間照顧，提供密集照護與醫療銜接，確保安全參與。',
        mid: '持續參與第五型半日日照，透過團隊協調追蹤健康並提供照護建議。',
        long: '長期使用第五型半日日照，穩定功能並支援家庭照顧安排。'
      },
      {
        code: 'BB11',
        name: '日間照顧（全日）—第六型',
        short: '安排第六型全日型日間照顧，整合專業照護、醫療協調與行為管理，支援高度失能或失智者。',
        mid: '持續參與第六型全日日照，團隊依病程調整照護策略並與家屬緊密合作。',
        long: '長期使用第六型全日日照，維持安全環境與照護紀錄，協助家庭落實長期支持。'
      },
      {
        code: 'BB12',
        name: '日間照顧（半日）—第六型',
        short: '安排第六型半日型日間照顧，提供高強度照護與行為支持，協助家庭喘息。',
        mid: '持續參與第六型半日日照，團隊即時回饋健康與行為變化，協助家屬調整。',
        long: '長期使用第六型半日日照，維持生活品質並減少家庭照護壓力。'
      },
      {
        code: 'BB13',
        name: '日間照顧（全日）—第七型',
        short: '安排第七型全日型日間照顧，結合專業醫護、復能與安全監測，支援極高照護需求者。',
        mid: '持續參與第七型全日日照，團隊跨專業合作掌握病況並調整計畫。',
        long: '長期使用第七型全日日照，確保高度照護需求獲得穩定支持並維持生活品質。'
      },
      {
        code: 'BB14',
        name: '日間照顧（半日）—第七型',
        short: '安排第七型半日型日間照顧，提供極高照護需求者短時段專業支持與安全陪伴。',
        mid: '持續參與第七型半日日照，團隊密切掌握身心狀況並回饋照護建議。',
        long: '長期使用第七型半日日照，協助家庭維持高需求個案之照護品質。'
      },
      {
        code: 'BD01',
        name: '社區式協助沐浴',
        short: '個案將於日間照顧中心或托顧家庭接受協助沐浴服務，包含引導至浴間、協助穿脫衣物、全身淋浴或坐浴（含洗頭）、口腔及臉部清潔，並於沐浴後完成環境整理，以確保基本衛生與安全。',
        mid: '穩定使用社區式協助沐浴服務，維持規律清潔習慣。服務過程除執行洗浴與頭部清潔外，並持續監測皮膚狀況（如紅腫、壓痕），透過照護人員操作協助減少跌倒風險，同時提升舒適度與自我形象。',
        long: '長期持續於社區據點完成規律沐浴，保持身體清潔與皮膚健康，並建立穩定的清潔照護流程。透過專業協助降低感染及跌倒風險，提升生活品質與尊嚴，並減輕主要照顧者的負擔。'
      },
      {
        code: 'BD02',
        name: '社區式晚餐',
        short: '個案將於日間照顧中心或托顧家庭接受社區式晚餐服務，包括準備適合個別需求的餐點、協助進食或餵食，以及餐後口腔清潔，確保基本營養攝取。',
        mid: '穩定使用社區式晚餐服務，確保營養攝取均衡並維持適當進食量。餐食提供將依照個案狀況調整（如軟質、低鹽、糖尿病飲食），並落實餐後口腔清潔，以降低嗆咳與感染風險。',
        long: '長期維持晚餐服務使用，透過專業規劃與協助，確保個案獲得持續且均衡的營養，進而支持身體健康與活動參與。餐食紀錄與口腔清潔紀錄將定期檢核，確保飲食衛教與習慣養成。'
      },
      {
        code: 'BD03',
        name: '社區式服務交通接送',
        short: '個案將使用社區式交通接送服務，安全往返住家與日間照顧中心、托顧家庭或小規模多機能據點，以確保能順利參與日間照顧或其他社區服務。',
        mid: '穩定使用交通接送，確保每次行程安全準點。服務人員將提供上下車協助與必要保護，並持續觀察個案上下車動作與身體狀況，確保安全無跌倒或不適事件。',
        long: '長期規律使用交通接送，確保個案能穩定參與社區服務，減少因交通不便而放棄活動的情況。透過持續追蹤與紀錄，建立固定路線與服務流程，確保安全率與準點率，並協助家屬降低接送壓力。'
      }
    ];
    const DAY_CARE_MAP = {};
    DAY_CARE_ITEMS.forEach(item => { DAY_CARE_MAP[item.code] = item; });
    const PROFESSIONAL_SERVICE_ITEMS = [
      {
        code: 'CA07',
        name: 'IADLs/ADLs 復能照護',
        short: '完成功能與生活能力初評，並與個案及家屬討論復能重點，擬定個別化計畫。安排基本日常活動訓練（如穿衣、如廁、進食、移位），由專業人員示範並記錄進展，協助個案建立參與信心。',
        mid: '持續執行復能計畫，逐步增加活動強度與複雜度，並透過專業人員監測功能變化。個案能在協助下完成部分日常活動，並透過重複練習提升耐力與技巧。家屬將接受照護技巧指導，以在居家情境中延續復能訓練。',
        long: '個案能穩定完成復能計畫中多數的日常生活活動，並逐步減少協助需求。透過規律性訓練維持自理能力，避免退化；服務單位定期檢核成果，將改善情況與困難處回饋家屬，並滾動修正計畫內容。'
      },
      {
        code: 'CA08',
        name: '個別化服務計畫（ISP）擬定與執行',
        short: '完成個案功能與心理社交評估，並與家屬討論需求。擬定個別化服務計畫，涵蓋生活自理、人際互動、社交技巧、休閒與健康促進等面向，設定近期可達成之行為與生活目標。',
        mid: '穩定執行 ISP，逐步提升個案生活自理能力，並參與社交與休閒活動。由專業人員持續追蹤效果，針對退化或困難項目調整策略，並提供家屬支持與訓練，使家庭能共同配合服務計畫。',
        long: '透過持續執行 ISP，協助個案維持並強化自理功能與社會參與，延緩退化。服務單位將依據評估結果與家屬回饋，定期修正與優化計畫，確保個案在生活、健康與社交等層面均獲得持續支持。'
      },
      {
        code: 'CB01',
        name: '營養照護',
        short: '完成營養狀況初評（包含體重、飲食習慣、吞嚥能力），並提出飲食改善建議。提供家屬與個案飲食衛教，建立飲食紀錄，以利後續追蹤。',
        mid: '持續監測個案營養狀態，並依實際情況調整餐食內容或質地。透過專業人員指導，改善營養攝取不足或偏差的情況。必要時轉介醫師或營養師進一步評估。',
        long: '維持均衡飲食與營養良好狀態，避免體重異常變化與營養不良。服務單位定期檢視營養紀錄，持續提供衛教，協助個案及家屬養成健康飲食習慣。'
      },
      {
        code: 'CB02',
        name: '進食與吞嚥照護',
        short: '完成吞嚥與進食功能評估，確認風險並給予初步指導。安排合適的飲食質地（如軟質、泥狀），並透過姿勢與口腔運動訓練，降低嗆咳風險。',
        mid: '持續進行吞嚥訓練與飲食調整，提升個案口腔與吞嚥肌群功能。專業人員追蹤進食過程，必要時指導家屬協助，減少誤吸與嗆咳事件。',
        long: '維持進食與吞嚥安全，確保個案能長期攝取足夠營養。持續監測進食過程，避免併發症（如吸入性肺炎），並建立穩定的照護模式，支持個案生活品質。'
      },
      {
        code: 'CB03',
        name: '困擾行為照護',
        short: '完成困擾行為評估，記錄發生頻率與情境，並給予初步安撫策略。與家屬討論行為誘因，建立紀錄基準。',
        mid: '持續執行行為介入策略，降低困擾行為發生率。透過正向強化與環境調整，協助個案改善行為模式，並提供家屬因應技巧，提升家庭照護能力。',
        long: '建立穩定行為管理模式，使困擾行為大幅減少或控制在可接受範圍。服務單位將定期回饋成效，並持續調整介入策略，以確保個案生活品質與家庭照護負擔的改善。'
      },
      {
        code: 'CB04',
        name: '臥床或長期活動受限照護',
        short: '完成全面性評估，確認臥床或活動受限相關風險（如壓瘡、肌肉萎縮）。提供翻身、肢體關節活動與皮膚護理的初步指導。',
        mid: '持續執行翻身與肢體活動，並監測皮膚完整性與關節活動度。專業人員指導家屬日常照護技巧，降低壓瘡及感染風險。',
        long: '建立長期臥床照護模式，確保翻身與護理規律執行。透過持續追蹤與紀錄，預防併發症，並維持個案在可行範圍內的活動與生活品質。'
      },
      {
        code: 'CC01',
        name: '居家環境安全或無障礙空間規劃',
        short: '完成居家環境與動線安全評估，提出優先改善建議，並提供家屬基本安全指導。',
        mid: '執行居家環境改善（如增設扶手、防滑設施），並安排輔具使用。由專業人員示範正確操作方式，確保日常生活動線更安全。',
        long: '維持環境安全，避免跌倒與意外事件。服務單位定期檢視改善效果與輔具使用狀況，並持續提供調整建議，以符合個案長期需求。'
      },
      {
        code: 'CD02',
        name: '居家護理指導與諮詢',
        short: '進行居家護理需求與家庭功能評估，擬定初步護理計畫，並提供基本照護技巧指導。',
        mid: '執行居家護理計畫，持續指導個案與家屬進行正確照護（如傷口處理、管路照護）。進行跨專業轉介與社區資源連結，並持續追蹤成效。',
        long: '建立長期護理支持系統，提升個案與家屬的自我照護能力。透過定期成效評估，持續改善照護策略，確保生活品質與健康狀態獲得提升。'
      }
    ];
    const PROFESSIONAL_SERVICE_MAP = {};
    PROFESSIONAL_SERVICE_ITEMS.forEach(item => { PROFESSIONAL_SERVICE_MAP[item.code] = item; });
    const TRANSPORT_SERVICE_ITEMS = [
      {
        code: 'DA01',
        name: '交通接送（就醫/復健/透析）',
        short: '個案將開始使用交通接送服務，協助往返居家與醫療院所、復健中心或透析治療地點。服務提供單位安排具職業駕照之駕駛，並於上車及下車過程給予必要的協助，確保安全。透過此服務，個案能準時參與治療與檢查，減少因交通不便而影響就醫之情況，並協助家屬減輕接送壓力。',
        mid: '個案已能穩定使用交通接送服務完成定期就醫與復健治療，行程安排逐步固定化。服務單位將持續追蹤準點率與安全性，並在必要時進行路線或時間調整，以符合醫療需求。服務人員在接送過程中同時觀察個案身體狀況，如發現異常將即時回報，確保醫療銜接不中斷。',
        long: '個案能長期規律地透過交通接送服務完成就醫、復健或透析，維持治療連續性。服務單位建立完善的交通排程與紀錄制度，確保安全、準時並提升使用滿意度。藉由穩定的接送服務，降低家屬長期負擔，並支持個案健康狀態維持與醫療成效之落實。'
      }
    ];
    const TRANSPORT_SERVICE_MAP = {};
    TRANSPORT_SERVICE_ITEMS.forEach(item => { TRANSPORT_SERVICE_MAP[item.code] = item; });
    const RESPITE_SERVICE_ITEMS = [
      {
        code: 'GA03',
        name: '日間照顧中心喘息—全日',
        short: '個案將開始使用日間照顧中心全日喘息服務，服務內容包含生活起居協助（更衣、如廁、移位）、護理照護（服藥管理、健康監測）、協助沐浴、餐食供應與進食協助，以及文康休閒活動的參與。服務期間含交通接送，確保個案能準時到達與返家。此階段的重點在於協助個案熟悉中心環境與人員，建立規律的日間生活型態，並讓主要照顧者獲得整日的休息與喘息機會。',
        mid: '個案能穩定出席全日喘息服務，並逐步建立參與日間活動的習慣。服務單位將持續監測健康狀況（如血壓、血糖、營養狀態），確保進食與服藥安全，並透過規律的文康休閒活動提升認知與情緒狀態。同時，服務團隊將定期與家屬溝通，提供健康與生活回饋，幫助家屬在居家時延續照護品質。',
        long: '個案能長期規律使用全日喘息服務，並在安全環境中維持生活自理功能與社交參與。服務單位會建立完整的照顧紀錄（出席率、健康檢視、活動參與度），定期檢討照顧成果並回饋給家屬。透過長期喘息支持，不僅能延緩個案退化，也能有效降低家庭主要照顧者的負荷，達到長期穩定的支持系統。'
      },
      {
        code: 'GA04',
        name: '日間照顧中心喘息—半日',
        short: '個案將使用日間照顧中心半日喘息服務，接受生活照顧（移位、如廁、整潔協助）、護理照護、餐食供應與進食協助，以及文康休閒活動參與。含交通接送，以減少家屬接送負擔，並提供主要照顧者半日的休息時段。',
        mid: '個案能穩定參與半日服務，保持生活照顧品質與日常活動參與。服務單位持續觀察健康狀況，確保餐食與用藥安全，並透過適當的活動安排維持社交互動與認知參與。家屬能獲得固定的喘息時間，以緩解長期照護壓力。',
        long: '個案能長期規律參與半日喘息服務，並在此環境中維持身體健康與社交參與，避免因長期居家而產生孤立或退化。服務單位將定期提供參與紀錄與健康追蹤，確保計畫成效，並與家屬保持溝通，共同支持長期照護安排。'
      },
      {
        code: 'GA05',
        name: '機構住宿式喘息服務',
        short: '個案將入住住宿式長照機構，接受 24 小時照顧與護理，內容涵蓋生活起居協助、護理照護（用藥管理、健康監測）、沐浴、餐食與進食協助，以及規律活動安排。含交通接送，確保入住與返家過程順利。主要照顧者可因此獲得完整休養時間。',
        mid: '個案能穩定適應機構住宿環境，並接受完整的生活與健康照護。服務團隊將建立規律的日夜間照護模式，持續追蹤營養狀態、睡眠品質與皮膚健康，避免壓瘡與感染。家屬可透過喘息獲得生活調整的空間，並透過服務單位回饋掌握個案狀況。',
        long: '長期使用住宿式喘息服務，個案在專業照護下維持穩定健康與生活品質，避免功能快速退化。服務單位會建立完整的住宿照顧紀錄，包含健康監測與活動參與情況，並定期回饋給家屬，確保家庭與機構照護銜接順暢，減輕長期照顧壓力。'
      },
      {
        code: 'GA06',
        name: '小規模多機能—夜間喘息',
        short: '個案於夜間（18:00–08:00）至小規模多機能中心接受喘息服務，由工作人員提供夜間生活照顧（如如廁、翻身、進食）、服藥管理、沐浴及住宿。此安排讓主要照顧者能獲得夜間睡眠與休息，減少長期疲憊。',
        mid: '個案能穩定參與夜間喘息，服務單位將持續監測夜間睡眠品質、排泄與行動安全，避免跌倒或夜間意外事件。主要照顧者能透過固定的夜間休息，改善身心狀態並提升白天照護品質。',
        long: '長期使用夜間喘息服務，個案能維持規律作息，健康狀態穩定，並避免夜間失能惡化或安全事件發生。服務單位將建立夜間照護紀錄，並定期與家屬檢討，確保照護策略與家庭需求一致。'
      },
      {
        code: 'GA07',
        name: '巷弄長照站喘息（時）',
        short: '個案將至巷弄長照站接受短時段喘息服務，內容包含進食、服藥協助及簡單活動安排。此服務能讓主要照顧者獲得暫時喘息，減輕即時負擔。',
        mid: '個案能穩定參與巷弄長照站活動，維持基本社交互動與日常生活規律。照顧者可在此期間獲得喘息，並透過服務紀錄了解個案狀況，增進家庭照護信心。',
        long: '長期規律使用巷弄長照站喘息，個案能透過社區互動維持身心功能，避免孤立與退化。服務單位會定期提供健康與參與回饋，協助家屬規劃長期照顧。'
      },
      {
        code: 'GA09',
        name: '居家喘息服務（2小時為一單位）',
        short: '由受過專業訓練之照顧服務員至個案家中，提供如廁、沐浴、更衣、進食、服藥、翻身拍背、肢體活動與上下床協助等照顧。此安排能讓主要照顧者即時獲得休息，並確保個案於熟悉環境中獲得基本生活支持。',
        mid: '穩定使用居家喘息，服務員能熟悉個案需求並提供規律照顧，確保衛生、營養及安全。服務過程中觀察並記錄個案狀況，若有異常立即回報，讓家屬在喘息同時也能掌握健康狀況。',
        long: '長期規律安排居家喘息，個案能在熟悉環境中獲得持續照顧，維持生活品質並避免功能退化或照護缺口。服務單位將建立完整紀錄，定期與家屬討論成效，確保家庭照護與喘息服務能長期銜接與互補。'
      }
    ];
    const RESPITE_SERVICE_MAP = {};
    RESPITE_SERVICE_ITEMS.forEach(item => { RESPITE_SERVICE_MAP[item.code] = item; });
    const MEAL_SERVICE_ITEMS = [
      {
        code: 'OT01',
        name: '營養送餐',
        short: '個案經本市長照管理中心評估後，將開始接受營養送餐服務，每日提供午餐與晚餐共二餐。餐點依個案吞嚥能力與身體狀況調整質地與份量，配送同時完成飲食衛教與保存加熱說明，並建立固定送餐時段與交付簽收紀錄。針對列冊低收入戶、中低收入戶及符合長照低收入戶、中低收補助者，全額或部分補助餐費，其他一般戶則由服務單位依規收取餐費。',
        mid: '個案持續接受每日二餐送餐，餐點內容隨季節與健康需求調整，涵蓋均衡營養、低油鹽飲食及高蛋白質攝取。服務團隊定期檢核個案的體重變化、食量與用餐狀況，並落實餐後回收紀錄。補助資格定期檢視並持續套用正確身分類別，確保餐食供應不中斷。',
        long: '個案長期維持每日二餐送餐服務，確保在居家情境中穩定獲得營養支持。服務單位建立長期的送餐追蹤紀錄，包括出餐準時率、餐食品質檢驗與個案身體狀況回報。定期向家屬提供完整用餐紀錄與健康狀態摘要，確保營養供應、生活品質與家庭照護三方面穩定銜接。'
      }
    ];
    const MEAL_SERVICE_MAP = {};
    MEAL_SERVICE_ITEMS.forEach(item => { MEAL_SERVICE_MAP[item.code] = item; });
    const RISKS = [
      ['被照顧者嚴重情緒/干擾行為','BPSD、自/他傷、攻擊破壞、遊走、妄想、吼叫等'],
      ['高齡照顧者','≥65歲；原住民≥55歲；<18歲應通報'],
      ['無照顧經驗/知能不足','家庭變故或病況改變致知能不足'],
      ['沒有照顧替手','每週≥20小時主要照顧、難求助/抗拒資源'],
      ['需照顧兩人以上','含雙老家庭、多名身障或精神病人'],
      ['照顧者疾病/身心影響能力或意願','精神疾患/憂鬱焦慮失眠/重大傷病'],
      ['資源不符/變動或突發緊急需求','不符補助或突發事故致負擔'],
      ['三個月內照顧情境改變','急性醫療、病況改變、外籍看護空窗、資源中斷'],
      ['家暴或照顧疏忽風險','含自述暴力意念、疑似未通報'],
      ['自殺風險','意念/企圖/具體計畫/準備']
    ];
    function renderFormal(){
      const host=document.getElementById('sp_formal');
      host.innerHTML='';
      ba02WeeklyDisplays = {};
      FORMAL.forEach((name)=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${name}" onchange="toggleGoalInputs()"> ${name}`;
        host.appendChild(lab);
      });
      const rHost=document.getElementById('sp_risks');
      rHost.innerHTML='';
      RISKS.forEach((it,i)=>{
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${it[0]}"> ${i+1}. ${it[0]} <span class="muted">（${it[1]}）</span>`;
        rHost.appendChild(lab);
      });
      toggleGoalInputs();
    }

    function setServiceCardSelected(card, selected){
      if(!card) return;
      card.dataset.selected = selected ? '1' : '0';
      card.setAttribute('aria-pressed', selected ? 'true' : 'false');
      card.classList.toggle('is-selected', selected);
      const status = card.querySelector('.home-care-status');
      if(status){ status.textContent = selected ? '已選取' : '未選取'; }
      const qty = card.querySelector('.home-care-qty');
      if(qty){
        qty.disabled = !selected;
        qty.tabIndex = selected ? 0 : -1;
        if(!selected){ qty.value=''; }
      }
    }

    function handleServiceCardToggle(card, shouldSelect, callback, focusQuantity){
      setServiceCardSelected(card, shouldSelect);
      if(typeof callback === 'function'){
        callback(card, shouldSelect);
      }
      if(shouldSelect && focusQuantity){
        const qty = card.querySelector('.home-care-qty');
        if(qty){ setTimeout(()=>{ qty.focus(); qty.select(); }, 0); }
      }
    }

    function createServiceCard(item, options){
      options = options || {};
      const card=document.createElement('div');
      card.className='home-care-item';
      card.dataset.code = item.code || '';
      card.dataset.selected='0';
      card.setAttribute('role','button');
      card.setAttribute('tabindex','0');
      card.setAttribute('aria-pressed','false');
      card.setAttribute('aria-label', `${item.code || ''} ${item.name || ''}`.trim());
      if(options.hasQuantity){ card.dataset.hasQty='1'; }

      const main=document.createElement('div');
      main.className='home-care-main';
      const title=document.createElement('div');
      title.className='home-care-title';
      const codeEl=document.createElement('span');
      codeEl.className='home-care-code';
      codeEl.textContent=item.code || '';
      const nameEl=document.createElement('span');
      nameEl.className='home-care-name';
      nameEl.textContent=item.name ? `[${item.name}]` : '';
      title.appendChild(codeEl);
      title.appendChild(nameEl);
      main.appendChild(title);
      const status=document.createElement('span');
      status.className='home-care-status';
      status.textContent='未選取';
      main.appendChild(status);
      card.appendChild(main);

      if(options.hasQuantity){
        const extra=document.createElement('div');
        extra.className='home-care-extra';
        const wrap=document.createElement('div');
        wrap.className='home-care-qty-wrap';
        const label=document.createElement('span');
        label.className='home-care-qty-label';
        label.textContent=options.quantityLabel || '月次';
        const input=document.createElement('input');
        input.type='number';
        input.className='home-care-qty';
        input.dataset.code=item.code || '';
        input.min='0';
        input.step=options.quantityStep || '1';
        input.placeholder=options.quantityPlaceholder || '數量';
        input.disabled=true;
        input.tabIndex=-1;
        input.setAttribute('aria-controls','planSummaryPreview planEditor');
        input.addEventListener('input', evt=>{ onHomeCareQuantityChange(evt.target); });
        input.addEventListener('keydown', evt=>{
          if(evt.key === 'Escape'){
            evt.stopPropagation();
            input.blur();
            card.focus();
          }
        });
        input.addEventListener('click', evt=>{ evt.stopPropagation(); });
        wrap.appendChild(label);
        wrap.appendChild(input);
        extra.appendChild(wrap);
        card.appendChild(extra);
      }

      const toggle = ()=>{
        const nextSelected = card.dataset.selected !== '1';
        handleServiceCardToggle(card, nextSelected, options.onToggle, options.hasQuantity);
      };
      card.addEventListener('click', evt=>{
        if(evt.target && evt.target.closest('.home-care-qty-wrap')) return;
        toggle();
      });
      card.addEventListener('keydown', evt=>{
        if(evt.key === ' ' || evt.key === 'Enter'){
          evt.preventDefault();
          toggle();
        }
      });
      return card;
    }

    function renderHomeCareServices(){
      const host=document.getElementById('homeCareList');
      if(!host) return;
      host.innerHTML='';
      HOME_CARE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          hasQuantity:true,
          quantityLabel:'月目標',
          onToggle:(card, selected)=>{ onHomeCareToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderDayCareServices(){
      const host=document.getElementById('dayCareList');
      if(!host) return;
      host.innerHTML='';
      DAY_CARE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onDayCareToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function ensureSingleDayCareSelection(activeCard){
      if(!activeCard || activeCard.dataset.selected !== '1') return;
      const code = activeCard.dataset.code || '';
      if(code.indexOf('BB') !== 0) return;
      document.querySelectorAll('#dayCareList .home-care-item[data-selected="1"]').forEach(card=>{
        if(card === activeCard) return;
        const otherCode = card.dataset.code || '';
        if(otherCode.indexOf('BB') === 0){
          handleServiceCardToggle(card, false, (node)=>{ onDayCareToggle(node, false); }, false);
        }
      });
    }

    function refreshDayCareAvailability(){
      const level = getCmsLevel();
      const requirementMap = SERVICE_CATALOG && SERVICE_CATALOG.dayCareRequirements ? SERVICE_CATALOG.dayCareRequirements : {};
      const levelStr = level ? String(level) : '';
      document.querySelectorAll('#dayCareList .home-care-item').forEach(card=>{
        const code = card.dataset.code || '';
        const required = requirementMap && Object.prototype.hasOwnProperty.call(requirementMap, code)
          ? String(requirementMap[code])
          : '';
        const allow = !levelStr || !required || required === levelStr;
        card.style.display = allow ? '' : 'none';
        if(!allow && card.dataset.selected === '1'){
          handleServiceCardToggle(card, false, (node)=>{ onDayCareToggle(node, false); }, false);
        }
      });
    }

    function renderProfessionalServices(){
      const host=document.getElementById('profServiceList');
      if(!host) return;
      host.innerHTML='';
      PROFESSIONAL_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onProfessionalToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderTransportServices(){
      const host=document.getElementById('transportServiceList');
      if(!host) return;
      host.innerHTML='';
      TRANSPORT_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onTransportToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderRespiteServices(){
      const host=document.getElementById('respServiceList');
      if(!host) return;
      host.innerHTML='';
      RESPITE_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onRespiteToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }

    function renderMealServices(){
      const host=document.getElementById('mealServiceList');
      if(!host) return;
      host.innerHTML='';
      MEAL_SERVICE_ITEMS.forEach(item=>{
        const card=createServiceCard(item, {
          onToggle:(card, selected)=>{ onMealToggle(card, selected); }
        });
        host.appendChild(card);
      });
    }


    const servicePlanState = {};
    let ba02WeeklyDisplays = {};
    const MISMATCH_REASON_OPTIONS = [
      { value:'身體狀況', label:'身體狀況變化', short:'身體狀況' },
      { value:'個案意願', label:'個案意願', short:'個案意願' },
      { value:'資源限制', label:'資源或額度限制', short:'資源限制' },
      { value:'經濟考量', label:'經濟考量', short:'經濟考量' },
      { value:'其他', label:'其他（請說明）', short:'其他' }
    ];
    const MISMATCH_CATEGORY_KEYS = new Set(['居家服務','日間照顧','專業服務','交通接送','喘息服務','無障礙及輔具','營養送餐']);
    const MISMATCH_REASON_LOOKUP = {};
    MISMATCH_REASON_OPTIONS.forEach(opt=>{ MISMATCH_REASON_LOOKUP[opt.value] = opt; });
    let mismatchReasonInitialized = false;
    let currentMismatchDiff = [];
    const planMetaState = {
      referralExtra: '',
      stationInfo: '',
      stationWillingness: '',
      emergencyNote: ''
    };

    function determineServiceCategory(code){
      if(!code) return '';
      if(code.startsWith('SC')) return 'SC';
      if(code.startsWith('OT')) return 'MEAL';
      if(code.startsWith('DA')) return 'D';
      const first = code.charAt(0);
      if(first === 'B') return 'B';
      if(first === 'C') return 'C';
      if(first === 'D') return 'D';
      if(first === 'E' || first === 'F') return 'EF';
      if(first === 'G') return 'G';
      return '';
    }

    function lookupServiceItem(code){
      return HOME_CARE_MAP[code] || DAY_CARE_MAP[code] || PROFESSIONAL_SERVICE_MAP[code] ||
        TRANSPORT_SERVICE_MAP[code] || RESPITE_SERVICE_MAP[code] || MEAL_SERVICE_MAP[code] || null;
    }

    function ensurePlanEntry(code, initialMonthlyUnits){
      if(!code) return null;
      const item = lookupServiceItem(code);
      if(!servicePlanState[code]){
        servicePlanState[code] = {
          code: code,
          name: item ? (item.name || '') : '',
          category: determineServiceCategory(code),
          vendorMode: '輪派',
          vendorName: '',
          monthlyUnits: '',
          monthlyUnitsComputed: '',
          autoMonthlyUnits: '',
          monthlyUnitsManual: false,
          weeklyFreq: '',
          unitPerVisit: '',
          monthlyExtraVisits: '',
          monthlyExtraUnit: '',
          monthlyExtraDesc: '',
          frequency: '',
          autoFrequencyText: '',
          frequencyManual: false,
          usage: '',
          extra: '',
          period: '',
          planned: '',
          remaining: '',
          original: '',
          mealsPerDay: '',
          mealType: '',
          autoPlanMonthlyVisits: null,
          autoPlanWeeklyVisits: null,
          autoPlanMonthlyUnits: null,
          autoPlanRemainingCap: null,
          autoPlanUnitLabel: '',
          autoUsageText: '',
          usageManual: false
        };
      }else if(item && !servicePlanState[code].name){
        servicePlanState[code].name = item.name || '';
      }
      if(item){
        // 由預設詞庫提供基本的「使用方式」描述，
        // 讓填寫者僅需微調即可完成內容；若使用者之後手動覆寫，
        // onPlanFieldChange 會將 usageManual 標記為 true，避免再被自動更新。
        applyAutoUsage(servicePlanState[code], item.short || '');
      }
      if(initialMonthlyUnits && !servicePlanState[code].monthlyUnits){
        servicePlanState[code].monthlyUnits = initialMonthlyUnits;
        servicePlanState[code].monthlyUnitsManual = true;
        servicePlanState[code].autoMonthlyUnits = null;
      }
      return servicePlanState[code];
    }

    function renderMismatchReasonOptions(){
      if(mismatchReasonInitialized) return;
      const host=document.getElementById('mismatch_reason_box');
      if(!host) return;
      host.innerHTML='';
      MISMATCH_REASON_OPTIONS.forEach(option=>{
        const label=document.createElement('label');
        const input=document.createElement('input');
        input.type='checkbox';
        input.value=option.value;
        input.dataset.mismatchReason='1';
        label.appendChild(input);
        label.appendChild(document.createTextNode(' '+option.label));
        host.appendChild(label);
      });
      mismatchReasonInitialized = true;
    }

    function getSelectedMismatchReasons(){
      return [...document.querySelectorAll('#mismatch_reason_box input[type=checkbox]:checked')]
        .map(input=>input.value);
    }

    function mapEntryToMismatchCategory(entry){
      if(!entry) return '';
      const code=(entry.code || '').trim();
      if(!code) return '';
      if(code.startsWith('BB')) return '日間照顧';
      if(code === 'BD03' || code.startsWith('DA')) return '交通接送';
      const first=code.charAt(0);
      if(first === 'B') return '居家服務';
      if(first === 'C') return '專業服務';
      if(first === 'D') return '交通接送';
      if(first === 'G') return '喘息服務';
      if(first === 'E' || first === 'F') return '無障礙及輔具';
      if(code.startsWith('OT')) return '營養送餐';
      return '';
    }

    function computeMismatchDifferences(){
      const recommended=[...document.querySelectorAll('#sp_formal input[type=checkbox]:checked')]
        .map(input=>input.value)
        .filter(value=>MISMATCH_CATEGORY_KEYS.has(value));
      if(!recommended.length) return [];
      const provided=new Set();
      Object.values(servicePlanState).forEach(entry=>{
        const cat=mapEntryToMismatchCategory(entry);
        if(cat && MISMATCH_CATEGORY_KEYS.has(cat)){
          provided.add(cat);
        }
      });
      const diff=[];
      recommended.forEach(cat=>{
        if(!provided.has(cat)) diff.push(cat);
      });
      return diff;
    }

    function setMismatchError(message){
      const box=document.getElementById('mismatch_reason_error');
      if(!box) return;
      if(message){
        box.textContent=message;
        box.dataset.show='1';
        box.style.display='';
      }else{
        box.textContent='';
        box.dataset.show='0';
        box.style.display='none';
      }
    }

    function updateMismatchReasonOtherVisibility(){
      const other=document.getElementById('mismatch_reason_other');
      if(!other) return;
      const selected=getSelectedMismatchReasons();
      const show=selected.includes('其他');
      other.style.display = show ? '' : 'none';
      if(!show){
        other.value='';
        other.classList.remove('input-invalid');
      }
    }

    function validateMismatchReasons(){
      const diff=currentMismatchDiff || [];
      const other=document.getElementById('mismatch_reason_other');
      const inputs=[...document.querySelectorAll('#mismatch_reason_box input[type=checkbox]')];
      inputs.forEach(input=>input.classList.remove('input-invalid'));
      if(other) other.classList.remove('input-invalid');
      if(!diff.length){
        setMismatchError('');
        return true;
      }
      const selected=getSelectedMismatchReasons();
      if(!selected.length){
        setMismatchError('請勾選不一致原因');
        inputs.forEach(input=>input.classList.add('input-invalid'));
        return false;
      }
      if(selected.includes('其他')){
        const text=(other?.value || '').trim();
        if(!text){
          setMismatchError('請填寫其他原因說明');
          if(other){
            other.classList.add('input-invalid');
            other.focus();
          }
          return false;
        }
      }
      setMismatchError('');
      return true;
    }

    function updateMismatchReasons(opts){
      opts = opts || {};
      const diff=computeMismatchDifferences();
      currentMismatchDiff = diff;
      const block=document.getElementById('mismatch_diff_block');
      const list=document.getElementById('mismatch_diff_list');
      const hint=document.getElementById('mismatch_diff_text');
      if(diff.length){
        if(block) block.style.display='';
        if(hint) hint.textContent=`與照專建議服務不一致項目：${diff.join('、')}`;
        if(list){
          list.innerHTML='';
          diff.forEach(name=>{
            const badge=document.createElement('span');
            badge.className='badge';
            badge.textContent=name;
            list.appendChild(badge);
          });
        }
      }else{
        if(block) block.style.display='none';
        if(list) list.innerHTML='';
        setMismatchError('');
      }
      updateMismatchReasonOtherVisibility();
      if(diff.length){
        validateMismatchReasons();
      }
      if(!opts.skipPreview){
        buildApprovalPlanPreview();
      }
    }

    function onMismatchReasonChange(evt){
      const target=evt && evt.target ? evt.target : null;
      if(target && target.type === 'checkbox'){
        target.classList.remove('input-invalid');
      }
      setMismatchError('');
      updateMismatchReasonOtherVisibility();
      updateMismatchReasons();
    }

    function initMismatchReasonControls(){
      renderMismatchReasonOptions();
      const box=document.getElementById('mismatch_reason_box');
      if(box){
        box.addEventListener('change', onMismatchReasonChange);
      }
      const other=document.getElementById('mismatch_reason_other');
      if(other){
        other.addEventListener('input', ()=>{
          other.classList.remove('input-invalid');
          setMismatchError('');
          buildApprovalPlanPreview();
        });
      }
      updateMismatchReasonOtherVisibility();
      updateMismatchReasons({skipPreview:true});
    }

    function getMismatchReasonSummary(){
      if(!currentMismatchDiff || !currentMismatchDiff.length) return '';
      const selected=getSelectedMismatchReasons();
      if(!selected.length) return '';
      const names=[];
      selected.forEach(value=>{
        const option=MISMATCH_REASON_LOOKUP[value];
        if(value === '其他'){
          const other=(document.getElementById('mismatch_reason_other')?.value || '').trim();
          if(other){
            names.push(other);
          }
        }else if(option && option.short){
          names.push(option.short);
        }else{
          names.push(value);
        }
      });
      const unique=[];
      names.forEach(name=>{
        if(name && unique.indexOf(name) === -1){
          unique.push(name);
        }
      });
      if(!unique.length) return '';
      return `不一致原因：${unique.join('、')}`;
    }

    function removePlanEntry(code){
      if(servicePlanState[code]) delete servicePlanState[code];
    }

    function getAllSelectedServiceCodes(){
      const codes = new Set();
      document.querySelectorAll('#homeCareList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#dayCareList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#profServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#transportServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#respServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      document.querySelectorAll('#mealServiceList .home-care-item[data-selected="1"]').forEach(card=>codes.add(card.dataset.code));
      return Array.from(codes);
    }

    function syncPlanStateWithSelections(){
      const selected = new Set(getAllSelectedServiceCodes());
      Object.keys(servicePlanState).forEach(code=>{
        if(!selected.has(code)) delete servicePlanState[code];
      });
      selected.forEach(code=>{
        let initial='';
        if(code.startsWith('BA') || code.startsWith('BD')){
          const qtyInput=document.querySelector(`#homeCareList .home-care-qty[data-code="${code}"]`);
          if(qtyInput && qtyInput.value.trim()) initial = qtyInput.value.trim();
        }
        ensurePlanEntry(code, initial);
      });
      applyAutomaticPlanning();
      renderServicePlanEditor();
      updateMismatchReasons({skipPreview:true});
      buildPlanSummaryPreview();
      buildApprovalPlanPreview();
    }

    function isFiniteNumber(value){
      return typeof value === 'number' && isFinite(value);
    }

    function formatAutoInteger(value){
      if(!isFiniteNumber(value)) return '';
      return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatAutoDecimal(value){
      if(!isFiniteNumber(value)) return '';
      const rounded = Math.round(value * 10) / 10;
      if(Math.abs(rounded - Math.round(rounded)) < 1e-6) return String(Math.round(rounded));
      return rounded.toFixed(1).replace(/\.0$/, '');
    }

    function getCmsMonthlyCap(level){
      if(!level) return 0;
      const catalogCaps = SERVICE_CATALOG && SERVICE_CATALOG.needLevelCaps ? SERVICE_CATALOG.needLevelCaps : {};
      if(catalogCaps && Object.prototype.hasOwnProperty.call(catalogCaps, level)){
        const cap = Number(catalogCaps[level]);
        if(!isNaN(cap)) return cap;
      }
      const fallback = DEFAULT_SERVICE_CATALOG.needLevelCaps[level];
      return fallback ? Number(fallback) : 0;
    }

    function getServiceRate(code){
      if(!code) return null;
      const rates = SERVICE_CATALOG && SERVICE_CATALOG.serviceRates ? SERVICE_CATALOG.serviceRates : null;
      if(rates && rates[code]) return rates[code];
      return null;
    }

    function applyAutoUsage(entry, text){
      if(!entry) return;
      const content = (text || '').trim();
      entry.autoUsageText = content;
      if(!content) return;
      if(!entry.usageManual || !entry.usage || entry.usage === content){
        entry.usage = content;
        entry.usageManual = false;
      }
    }

    function clearAutoPlan(entry){
      if(!entry) return;
      entry.autoPlanMonthlyVisits = null;
      entry.autoPlanWeeklyVisits = null;
      entry.autoPlanMonthlyUnits = null;
      entry.autoPlanRemainingCap = null;
      entry.autoPlanUnitLabel = '';
      entry.autoFrequencyText = '';
    }

    function updateEntryAutoValues(entry, info){
      if(!entry || !info) return;
      if(typeof info.monthlyVisits === 'number' && isFinite(info.monthlyVisits)){
        entry.autoPlanMonthlyVisits = Math.max(0, Math.floor(info.monthlyVisits));
      }else{
        entry.autoPlanMonthlyVisits = null;
      }
      if(typeof info.weeklyVisits === 'number' && isFinite(info.weeklyVisits)){
        entry.autoPlanWeeklyVisits = Math.max(0, info.weeklyVisits);
      }else{
        entry.autoPlanWeeklyVisits = null;
      }
      if(typeof info.monthlyUnits === 'number' && isFinite(info.monthlyUnits)){
        entry.autoPlanMonthlyUnits = Math.max(0, info.monthlyUnits);
      }else{
        entry.autoPlanMonthlyUnits = null;
      }
      if(typeof info.remaining === 'number' && isFinite(info.remaining)){
        entry.autoPlanRemainingCap = Math.max(0, info.remaining);
      }else{
        entry.autoPlanRemainingCap = null;
      }
      if(info.unitLabel){
        entry.autoPlanUnitLabel = info.unitLabel;
      }
    }

    function buildAutoSummaryText(entry){
      if(!entry) return '';
      const unitLabel = entry.autoPlanUnitLabel || (entry.code === 'BD03' ? '趟' : '次');
      const parts=[];
      if(isFiniteNumber(entry.autoPlanMonthlyVisits)){
        const monthly = formatAutoInteger(entry.autoPlanMonthlyVisits);
        const weekly = formatAutoDecimal(entry.autoPlanWeeklyVisits);
        if(weekly){
          const weekUnit = unitLabel === '趟' ? '趟' : '次';
          parts.push(`每月約${monthly}${unitLabel}（每週約${weekly}${weekUnit}）`);
        }else{
          parts.push(`每月約${monthly}${unitLabel}`);
        }
      }
      if(isFiniteNumber(entry.autoPlanMonthlyUnits)){
        parts.push(`預估耗用${formatAutoInteger(entry.autoPlanMonthlyUnits)}元`);
      }
      if(isFiniteNumber(entry.autoPlanRemainingCap)){
        parts.push(`預估餘額${formatAutoInteger(entry.autoPlanRemainingCap)}元`);
      }
      const freq = (entry.autoFrequencyText || '').trim();
      if(freq && parts.indexOf(freq) === -1){
        parts.push(freq);
      }
      return parts.join('，');
    }

    function applyAutomaticPlanning(){
      updateDayCareAutoPlan();
    }

    function updateDayCareAutoPlan(){
      const cmsLevel = getCmsLevel();
      const cap = getCmsMonthlyCap(cmsLevel);
      const dayCareEntries = getSelectedDayCareEntries();
      const dayCareCode = dayCareEntries
        .map(entry => entry && entry.code ? entry.code : '')
        .find(code => code.indexOf('BB') === 0);
      const dayCareEntry = dayCareCode ? ensurePlanEntry(dayCareCode) : null;
      const transportEntry = servicePlanState['BD03'] ? servicePlanState['BD03'] : null;
      const dayCareItem = dayCareEntry ? DAY_CARE_MAP[dayCareEntry.code] : null;
      const dayCareRate = dayCareEntry ? getServiceRate(dayCareEntry.code) : null;
      const transportRate = transportEntry ? getServiceRate('BD03') : null;
      const roundTrips = SERVICE_CATALOG && SERVICE_CATALOG.transportRoundTrips ? SERVICE_CATALOG.transportRoundTrips : 2;
      const transportItem = transportEntry ? lookupServiceItem('BD03') : null;
      const weeksPerMonth = 4.5; // 依據長照給付計算基準，平均每月約 4.5 週。

      if(dayCareEntry){
        applyAutoUsage(dayCareEntry, dayCareItem ? dayCareItem.short : '');
      }
      if(transportEntry){
        applyAutoUsage(transportEntry, transportItem ? transportItem.short : '');
      }

      if(!dayCareEntry || !dayCareItem || !dayCareRate){
        if(dayCareEntry) clearAutoPlan(dayCareEntry);
        if(transportEntry) clearAutoPlan(transportEntry);
        return;
      }

      const basePerVisit = Number(dayCareRate.price) || 0;
      const transportPerVisit = transportEntry && transportRate ? (Number(transportRate.price) || 0) * roundTrips : 0;
      const totalPerVisit = basePerVisit + transportPerVisit;

      if(cap <= 0 || totalPerVisit <= 0){
        clearAutoPlan(dayCareEntry);
        if(transportEntry) clearAutoPlan(transportEntry);
        dayCareEntry.autoFrequencyText = '請先設定 CMS 等級與可用額度。';
        if(transportEntry) transportEntry.autoFrequencyText = '待日間照顧額度確認後再安排交通。';
        return;
      }

      const monthlyVisits = Math.max(0, Math.floor(cap / totalPerVisit));
      const weeklyVisits = monthlyVisits > 0 ? (monthlyVisits / weeksPerMonth) : 0;
      const dayCareUsage = basePerVisit * monthlyVisits;
      const transportUsage = transportPerVisit * monthlyVisits;
      const remaining = cap - dayCareUsage - transportUsage;

      updateEntryAutoValues(dayCareEntry, {
        monthlyVisits: monthlyVisits,
        weeklyVisits: weeklyVisits,
        monthlyUnits: dayCareUsage,
        remaining: remaining,
        unitLabel: '次'
      });
      dayCareEntry.autoFrequencyText = monthlyVisits > 0
        ? `預估每月${monthlyVisits}次（約每週${formatAutoDecimal(weeklyVisits)}次）`
        : '額度不足以安排日間照顧，請調整服務組合。';

      if(transportEntry){
        const transportMonthly = monthlyVisits * roundTrips;
        const transportWeekly = monthlyVisits > 0 ? (transportMonthly / weeksPerMonth) : 0;
        updateEntryAutoValues(transportEntry, {
          monthlyVisits: transportMonthly,
          weeklyVisits: transportWeekly,
          monthlyUnits: transportUsage,
          remaining: remaining,
          unitLabel: '趟'
        });
        transportEntry.autoFrequencyText = monthlyVisits > 0
          ? `搭配日間照顧往返${roundTrips}趟／次，月計約${formatAutoInteger(transportEntry.autoPlanMonthlyVisits)}趟（每週約${formatAutoDecimal(transportWeekly)}趟）`
          : '待日間照顧額度確認後再安排交通。';
      }else if(monthlyVisits > 0 && transportRate){
        dayCareEntry.autoFrequencyText += '（如需交通接送，請勾選 BD03 以納入額度）';
      }
    }

    function createPlanInput(entry, field, label, opts){
      opts = opts || {};
      const wrap=document.createElement('div');
      wrap.className='plan-field' + (opts.className ? ' '+opts.className : '');
      const lab=document.createElement('label');
      lab.textContent=label;
      wrap.appendChild(lab);
      let input;
      if(opts.as === 'textarea'){
        input=document.createElement('textarea');
        input.value = entry[field] || '';
      }else if(opts.as === 'select'){
        input=document.createElement('select');
        (opts.options || []).forEach(opt=>{
          const option=document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          input.appendChild(option);
        });
        input.value = entry[field] || (opts.defaultValue || (opts.options && opts.options[0] ? opts.options[0].value : ''));
      }else{
        input=document.createElement('input');
        input.type = opts.type || 'text';
        if(opts.attrs){
          Object.keys(opts.attrs).forEach(key=> input.setAttribute(key, opts.attrs[key]));
        }
        input.value = entry[field] || '';
      }
      if(opts.placeholder) input.placeholder = opts.placeholder;
      input.dataset.planCode = entry.code;
      input.dataset.planField = field;
      input.addEventListener(opts.as === 'select' ? 'change' : 'input', onPlanFieldChange);
      wrap.appendChild(input);
      if(field === 'monthlyUnits'){
        const toolbar=document.createElement('div');
        toolbar.className='plan-qty-toolbar';
        const hint=document.createElement('span');
        hint.className='plan-qty-hint';
        hint.textContent='快速調整';
        toolbar.appendChild(hint);
        const steps=[
          {label:'－1', delta:-1},
          {label:'＋1', delta:1},
          {label:'＋5', delta:5},
          {label:'＋10', delta:10}
        ];
        steps.forEach(step=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='tiny';
          btn.textContent=step.label;
          btn.addEventListener('click', ()=>{ adjustMonthlyUnits(entry.code, step.delta); });
          toolbar.appendChild(btn);
        });
        const clearBtn=document.createElement('button');
        clearBtn.type='button';
        clearBtn.className='tiny';
        clearBtn.dataset.variant='ghost';
        clearBtn.textContent='清除';
        clearBtn.addEventListener('click', ()=>{ setMonthlyUnitsValue(entry.code, 0); });
        toolbar.appendChild(clearBtn);
        wrap.appendChild(toolbar);
      }
      return {wrap, input};
    }

    function onPlanFieldChange(evt){
      const field = evt.target.dataset.planField;
      const code = evt.target.dataset.planCode;
      if(!field || !code) return;
      const entry = servicePlanState[code];
      if(!entry) return;
      entry[field] = evt.target.value;
      let skipPreview=false;
      if(field === 'vendorMode'){
        updatePlanVendorVisibility(code);
      }else if(field === 'monthlyUnits'){
        if((entry[field]||'').trim()){
          entry.monthlyUnitsManual = true;
          entry.autoMonthlyUnits = null;
        }else{
          entry.monthlyUnitsManual = false;
          entry.autoMonthlyUnits = '';
          updatePlanMonthlyComputation(code);
          skipPreview=true;
        }
        if(code === 'BA02'){
          updateBa02WeeklyDisplay(code);
        }
      }else if(field === 'frequency'){
        if((entry[field]||'').trim()){
          entry.frequencyManual = true;
        }else{
          entry.frequencyManual = false;
          entry.autoFrequencyText = '';
          updatePlanMonthlyComputation(code);
          skipPreview=true;
        }
      }else if(field === 'weeklyFreq' || field === 'unitPerVisit' || field === 'monthlyExtraVisits' || field === 'monthlyExtraUnit' || field === 'monthlyExtraDesc'){
        updatePlanMonthlyComputation(code);
        skipPreview=true;
      }else if(field === 'usage'){
        entry.usageManual = !!((entry.usage || '').trim() && entry.usage !== entry.autoUsageText);
      }
      if(!skipPreview) buildApprovalPlanPreview();
    }

    function getPlanFieldElement(code, field){
      return document.querySelector(`[data-plan-code="${code}"][data-plan-field="${field}"]`);
    }

    function parsePlanNumber(value){
      if(value === undefined || value === null) return 0;
      const num=parseFloat(String(value).replace(/[^0-9\-\.]/g,''));
      return isNaN(num) ? 0 : num;
    }

    function formatPlanNumber(value){
      if(value === undefined || value === null) return '';
      const num = typeof value === 'number' ? value : parseFloat(value);
      if(!isFinite(num)) return '';
      const fixed = Math.round(num * 100) / 100;
      if(Math.abs(fixed - Math.round(fixed)) < 1e-6) return String(Math.round(fixed));
      return fixed.toFixed(2).replace(/\.00$/, '').replace(/0$/, '');
    }

    function updatePlanMonthlyComputation(code, opts){
      const entry = servicePlanState[code];
      if(!entry) return;
      const weekly = parsePlanNumber(entry.weeklyFreq);
      const perVisit = parsePlanNumber(entry.unitPerVisit);
      const extraVisits = parsePlanNumber(entry.monthlyExtraVisits);
      let extraUnit = parsePlanNumber(entry.monthlyExtraUnit);
      if(extraVisits > 0 && (!entry.monthlyExtraUnit || !entry.monthlyExtraUnit.trim()) && perVisit > 0){
        extraUnit = perVisit;
        entry.monthlyExtraUnit = formatPlanNumber(perVisit);
        const extraUnitInput = getPlanFieldElement(code, 'monthlyExtraUnit');
        if(extraUnitInput && extraUnitInput !== document.activeElement){
          extraUnitInput.value = formatPlanNumber(perVisit);
        }
      }
      const baseUnits = weekly > 0 && perVisit > 0 ? weekly * perVisit * 4.5 : 0;
      const extraUnits = extraVisits > 0 && extraUnit > 0 ? extraVisits * extraUnit : 0;
      const total = baseUnits + extraUnits;
      const computed = total > 0 ? String(Math.ceil(total)) : '';
      entry.monthlyUnitsComputed = computed;
      if(computed && entry.autoMonthlyUnits !== null){
        if(!entry.monthlyUnitsManual || !entry.monthlyUnits || entry.monthlyUnits === entry.autoMonthlyUnits || entry.autoMonthlyUnits === ''){
          entry.monthlyUnits = computed;
          entry.autoMonthlyUnits = computed;
          const monthlyInput = getPlanFieldElement(code, 'monthlyUnits');
          if(monthlyInput && monthlyInput !== document.activeElement){
            monthlyInput.value = computed;
          }
        }else{
          entry.autoMonthlyUnits = computed;
        }
      }
      if(!computed && entry.autoMonthlyUnits !== null && !entry.monthlyUnitsManual){
        entry.autoMonthlyUnits = '';
      }

      const freqParts=[];
      if(weekly > 0 && perVisit > 0){
        const baseText = `${formatPlanNumber(weekly)}×${formatPlanNumber(perVisit)}×4.5=${formatPlanNumber(baseUnits)}`;
        freqParts.push(`每週${formatPlanNumber(weekly)}次，每次${formatPlanNumber(perVisit)}單位（${baseText}）`);
      }
      if(extraVisits > 0){
        const unitEach = extraUnit > 0 ? formatPlanNumber(extraUnit) : '';
        const extraCalc = extraUnit > 0 ? `（${formatPlanNumber(extraVisits)}×${unitEach}=${formatPlanNumber(extraUnits)}）` : '';
        let extraDesc = `另每月${formatPlanNumber(extraVisits)}次`;
        if(unitEach) extraDesc += `，每次${unitEach}單位`;
        extraDesc += extraCalc;
        if(entry.monthlyExtraDesc){
          extraDesc += `，${entry.monthlyExtraDesc}`;
        }
        freqParts.push(extraDesc);
      }else if(entry.monthlyExtraDesc){
        freqParts.push(entry.monthlyExtraDesc);
      }
      if(total > 0){
        const baseText = formatPlanNumber(baseUnits);
        const extraText = formatPlanNumber(extraUnits);
        if(extraUnits > 0){
          freqParts.push(`共計${baseText}+${extraText}=${computed}（單位/月）`);
        }else{
          freqParts.push(`共計${computed || baseText}（單位/月）`);
        }
      }
      const freqText = freqParts.join('，');
      if(freqText){
        if(!entry.frequencyManual || !entry.frequency || entry.frequency === entry.autoFrequencyText){
          entry.frequency = freqText;
          entry.autoFrequencyText = freqText;
          const freqInput = getPlanFieldElement(code, 'frequency');
          if(freqInput && freqInput !== document.activeElement){
            freqInput.value = freqText;
          }
        }else{
          entry.autoFrequencyText = freqText;
        }
      }
      if(!(opts && opts.skipPreview)){
        buildApprovalPlanPreview();
      }
    }

    function setMonthlyUnitsValue(code, value){
      if(!code) return;
      const input = getPlanFieldElement(code, 'monthlyUnits');
      if(!input) return;
      let numeric = 0;
      if(typeof value === 'number' && isFinite(value)){
        numeric = value;
      }else if(typeof value === 'string' && value.trim()){
        numeric = parsePlanNumber(value);
      }
      const str = numeric > 0 ? formatPlanNumber(numeric) : '';
      input.value = str;
      input.dispatchEvent(new Event('input', { bubbles:true }));
    }

    function adjustMonthlyUnits(code, delta){
      if(!code) return;
      const numericDelta = (typeof delta === 'number' && isFinite(delta)) ? delta : parsePlanNumber(delta);
      if(!isFinite(numericDelta)) return;
      const input = getPlanFieldElement(code, 'monthlyUnits');
      if(!input) return;
      const current = parsePlanNumber(input.value);
      const next = Math.max(0, current + numericDelta);
      setMonthlyUnitsValue(code, next);
    }

    function updatePlanVendorVisibility(code){
      const entry = servicePlanState[code];
      const show = entry && entry.vendorMode === '指定';
      document.querySelectorAll(`[data-plan-vendor-name="${code}"]`).forEach(el=>{
        el.style.display = show ? '' : 'none';
      });
    }

    function planCategoryLabel(cat){
      switch(cat){
        case 'B': return 'B碼服務（居家／日照）';
        case 'C': return 'C碼專業服務';
        case 'D': return 'D碼／交通接送';
        case 'EF': return 'E.F碼（輔具與無障礙補助）';
        case 'G': return 'G碼（喘息服務）';
        case 'SC': return 'SC碼（短期照顧）';
        case 'MEAL': return '營養餐飲服務（OT碼）';
        default: return '其他服務';
      }
    }

    function formatSummaryVendorName(entry){
      if(!entry) return '';
      const mode = (entry.vendorMode || '').trim();
      if(mode === '指定'){
        return entry.vendorName || '（請填單位）';
      }
      return entry.vendorName || '';
    }

    function formatSummaryAmount(entry){
      if(!entry) return '';
      const category = (entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
      const lines = [];
      if(category === 'B'){
        const hasAuto = isFiniteNumber(entry.autoPlanMonthlyVisits) || isFiniteNumber(entry.autoPlanMonthlyUnits);
        if(hasAuto){
          if(isFiniteNumber(entry.autoPlanMonthlyVisits)){
            const unitLabel = entry.autoPlanUnitLabel || (entry.code === 'BD03' ? '趟' : '次');
            const monthly = formatAutoInteger(entry.autoPlanMonthlyVisits);
            if(isFiniteNumber(entry.autoPlanWeeklyVisits)){
              const weeklyUnit = unitLabel === '趟' ? '趟' : '次';
              lines.push(`每月約${monthly}${unitLabel}（每週約${formatAutoDecimal(entry.autoPlanWeeklyVisits)}${weeklyUnit}）`);
            }else{
              lines.push(`每月約${monthly}${unitLabel}`);
            }
          }
          if(isFiniteNumber(entry.autoPlanMonthlyUnits)){
            lines.push(`預估耗用${formatAutoInteger(entry.autoPlanMonthlyUnits)}元`);
          }
          if(isFiniteNumber(entry.autoPlanRemainingCap)){
            lines.push(`預估餘額${formatAutoInteger(entry.autoPlanRemainingCap)}元`);
          }
          if(lines.length) return lines.join('\n');
        }
      }
      if(category === 'EF'){
        if(entry.original) lines.push(`原額度：${entry.original}`);
        if(entry.planned)  lines.push(`核定：${entry.planned}`);
        if(entry.remaining) lines.push(`餘額：${entry.remaining}`);
      }else if(category === 'G' || category === 'SC'){
        if(entry.planned)  lines.push(`規劃：${entry.planned}`);
        if(entry.remaining) lines.push(`餘額：${entry.remaining}`);
      }else if(category === 'MEAL'){
        if(entry.mealsPerDay) lines.push(`每日${entry.mealsPerDay}餐`);
        if(entry.mealType) lines.push(entry.mealType);
      }else{
        if(category !== 'C'){
          const monthly = entry.monthlyUnits || entry.monthlyUnitsComputed;
          if(monthly) lines.push(`${monthly} 單位/月`);
          if(entry.monthlyExtraDesc) lines.push(entry.monthlyExtraDesc);
        }
      }
      if(!lines.length && entry.planned) lines.push(entry.planned);
      return lines.join('\n');
    }

    function formatSummaryUsage(entry){
      if(!entry) return '';
      const lines = [];
      const category = (entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
      if(entry.period) lines.push(`期間：${entry.period}`);
      const freq = entry.frequencyManual ? entry.frequency : (entry.autoFrequencyText || entry.frequency);
      if(freq && category !== 'C') lines.push(freq);
      if(entry.code === 'BA02'){
        const weeklyText=buildBa02WeeklyText(entry);
        if(weeklyText) lines.push(weeklyText);
      }
      if(entry.usage){
        lines.push(entry.usage);
      }else if(entry.autoUsageText){
        lines.push(entry.autoUsageText);
      }
      if(entry.extra) lines.push(entry.extra);
      return lines.join('\n');
    }

    function getEntryMonthlyUnits(entry){
      if(!entry) return {units:0, hasValue:false};
      const fields=['monthlyUnits','monthlyUnitsComputed','autoMonthlyUnits'];
      for(let i=0;i<fields.length;i++){
        const field=fields[i];
        if(entry[field] !== undefined && entry[field] !== null){
          const raw=String(entry[field]).trim();
          if(raw){
            return {units:parsePlanNumber(raw), hasValue:true};
          }
        }
      }
      return {units:0, hasValue:false};
    }

    function getEntryUsagePoints(entry){
      if(!entry) return {points:0, computed:false, missing:false};
      if(isFiniteNumber(entry.autoPlanMonthlyUnits)){
        const points=Math.max(0, entry.autoPlanMonthlyUnits);
        return {points:points, computed:true, missing:false};
      }
      const unitInfo=getEntryMonthlyUnits(entry);
      if(!unitInfo.hasValue){
        return {points:0, computed:false, missing:false};
      }
      if(unitInfo.units <= 0){
        return {points:0, computed:true, missing:false};
      }
      const rate=getServiceRate(entry.code);
      if(rate && rate.price !== undefined && rate.price !== null){
        const price=Number(rate.price);
        if(!isNaN(price) && isFinite(price)){
          const points=unitInfo.units * price;
          return {points:points, computed:true, missing:false};
        }
      }
      return {points:0, computed:false, missing:true};
    }

    function calculatePlanPointTotals(){
      const level=getCmsLevel();
      let capValue=null;
      if(level){
        const capNum=getCmsMonthlyCap(level);
        if(isFiniteNumber(capNum) && capNum > 0){
          capValue = capNum;
        }else{
          capValue = null;
        }
      }
      let totalPoints=0;
      let computedEntries=0;
      let totalEntries=0;
      const missingRates=[];
      Object.values(servicePlanState).forEach(entry=>{
        if(!entry) return;
        const category=(entry.category || determineServiceCategory(entry.code) || '').toUpperCase();
        if(category !== 'B' && category !== 'C') return;
        totalEntries++;
        const usageInfo=getEntryUsagePoints(entry);
        if(usageInfo.missing){
          missingRates.push(entry.code);
          return;
        }
        if(usageInfo.computed){
          computedEntries++;
          if(usageInfo.points > 0){
            totalPoints += usageInfo.points;
          }
        }
      });
      const uniqueMissing=Array.from(new Set(missingRates));
      const remaining=(capValue !== null && computedEntries > 0)
        ? capValue - totalPoints
        : null;
      return {
        level:level,
        cap:capValue,
        usage:totalPoints,
        computedEntries:computedEntries,
        totalEntries:totalEntries,
        missingRates:uniqueMissing,
        remaining:remaining
      };
    }

    function formatPointValue(value){
      if(!isFiniteNumber(value)) return '—';
      const roundedInt=Math.round(value);
      if(Math.abs(value - roundedInt) < 1e-4){
        return `${formatAutoInteger(roundedInt)} 元`;
      }
      const rounded=Math.round(value * 10) / 10;
      if(Math.abs(rounded - Math.round(rounded)) < 1e-6){
        return `${formatAutoInteger(Math.round(rounded))} 元`;
      }
      const fixed=rounded.toFixed(1);
      const sign=fixed.startsWith('-') ? '-' : '';
      const abs=sign ? fixed.slice(1) : fixed;
      const parts=abs.split('.');
      const intPart=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      const decimal=parts[1] ? `.${parts[1].replace(/0+$/, '')}` : '';
      return `${sign}${intPart}${decimal} 元`;
    }

    function updatePlanSummaryTotals(){
      const totals=calculatePlanPointTotals();
      const capBox=document.getElementById('planSummaryCap');
      if(capBox){
        if(totals.level){
          const levelText=`第${totals.level}級`;
          if(isFiniteNumber(totals.cap)){
            capBox.textContent=`${levelText}｜${formatAutoInteger(totals.cap)} 元`;
          }else{
            capBox.textContent=`${levelText}｜—`;
          }
        }else{
          capBox.textContent='—';
        }
      }
      const usageBox=document.getElementById('planSummaryUsage');
      if(usageBox){
        if(totals.computedEntries > 0){
          usageBox.textContent=formatPointValue(totals.usage);
        }else if(totals.totalEntries > 0){
          usageBox.textContent='—';
        }else{
          usageBox.textContent='—';
        }
      }
      const remainBox=document.getElementById('planSummaryRemaining');
      if(remainBox){
        if(totals.remaining !== null && totals.computedEntries > 0){
          remainBox.textContent=formatPointValue(totals.remaining);
          remainBox.classList.toggle('negative', totals.remaining < 0);
        }else{
          remainBox.textContent='—';
          remainBox.classList.remove('negative');
        }
      }
      const hintBox=document.getElementById('planSummaryTotalsHint');
      if(hintBox){
        const hints=[];
        if(!totals.level){
          hints.push('請設定 CMS 等級以計算月額度與餘額。');
        }else if(totals.cap === null){
          hints.push('查無對應的 CMS 月額度，請確認服務資料設定。');
        }
        if(totals.missingRates.length){
          hints.push(`缺少單價：${totals.missingRates.join('、')}，無法納入金額預估。`);
        }
        if(hints.length){
          hintBox.textContent=hints.join(' ');
          hintBox.dataset.show='1';
        }else{
          hintBox.textContent='';
          hintBox.dataset.show='0';
        }
      }
    }

    function buildPlanSummaryPreview(){
      updatePlanSummaryTotals();
      const host=document.getElementById('planSummaryPreview');
      if(!host) return;
      const entries=Object.values(servicePlanState);
      if(!entries.length){
        host.innerHTML='<div class="hint">尚未選擇服務項目。</div>';
        return;
      }
      const grouped={};
      entries.forEach(entry=>{
        if(!entry) return;
        const cat=(entry.category || determineServiceCategory(entry.code) || 'OTHER').toUpperCase();
        if(!grouped[cat]) grouped[cat]=[];
        grouped[cat].push(entry);
      });
      const order=['B','C','D','EF','G','SC','MEAL','OTHER'];
      let html='';
      order.forEach(cat=>{
        const list=grouped[cat];
        if(!list || !list.length) return;
        html += `<div class="summary-section"><div class="summary-title">${escapeHtml(planCategoryLabel(cat))}</div>`;
        html += '<table class="summary-table"><thead><tr><th>服務代碼</th><th>服務名稱</th><th>承接</th><th>指定單位</th><th>額度／單位</th><th>使用頻率／說明</th></tr></thead><tbody>';
        list.sort((a,b)=>{
          const ac=(a && a.code) ? a.code : '';
          const bc=(b && b.code) ? b.code : '';
          return ac.localeCompare(bc);
        });
        list.forEach(entry=>{
          const vendorMode = entry && entry.vendorMode ? entry.vendorMode : '輪派';
          const vendorName = formatSummaryVendorName(entry);
          const amount = formatSummaryAmount(entry);
          const usage = formatSummaryUsage(entry);
          html += '<tr>';
          html += `<td>${escapeHtml(entry && entry.code ? entry.code : '')}</td>`;
          html += `<td>${escapeHtml(entry && entry.name ? entry.name : '')}</td>`;
          html += `<td>${escapeHtml(vendorMode)}</td>`;
          html += `<td>${escapeHtml(vendorName)}</td>`;
          html += `<td>${amount ? nl2br(amount) : '—'}</td>`;
          html += `<td>${usage ? nl2br(usage) : '—'}</td>`;
          html += '</tr>';
        });
        html += '</tbody></table></div>';
      });
      if(!html){
        host.innerHTML='<div class="hint">尚未選擇服務項目。</div>';
        return;
      }
      host.innerHTML = html;
    }

    function renderServicePlanEditor(){
      const host=document.getElementById('planEditor');
      if(!host) return;
      host.innerHTML='';
      const entries=Object.values(servicePlanState);
      if(!entries.length){
        const empty=document.createElement('div');
        empty.className='hint';
        empty.textContent='尚未選擇服務項目。請先於「正式資源」區勾選服務。';
        host.appendChild(empty);
        return;
      }
      const grouped={};
      entries.forEach(entry=>{
        const cat=entry.category || 'OTHER';
        if(!grouped[cat]) grouped[cat]=[];
        grouped[cat].push(entry);
      });
      const order=['B','C','D','EF','G','SC','MEAL','OTHER'];
      order.forEach(cat=>{
        const list=grouped[cat];
        if(!list || !list.length) return;
        list.sort((a,b)=>a.code.localeCompare(b.code));
        const section=document.createElement('div');
        section.className='plan-category';
        const title=document.createElement('div');
        title.className='plan-category-title';
        title.textContent=planCategoryLabel(cat);
        section.appendChild(title);
        list.forEach(entry=>{
          const entryBox=document.createElement('div');
          entryBox.className='plan-entry';
          const header=document.createElement('div');
          header.className='plan-entry-header';
          header.textContent=`${entry.code}［${entry.name || ''}］`;
          entryBox.appendChild(header);
          const grid=document.createElement('div');
          grid.className='plan-entry-grid';
          if(cat==='B'){
            if(entry.code && entry.code.indexOf('BB') === 0){
              const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
              grid.appendChild(vendorField.wrap);
              const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○日照中心'});
              vendorNameField.wrap.dataset.planVendorName=entry.code;
              grid.appendChild(vendorNameField.wrap);
              appendAutoSummaryField(grid, entry, '預估使用概況');
              const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'系統已提供建議內容，可依個案調整',className:'full'});
              grid.appendChild(usageField.wrap);
            }else if(entry.code === 'BD03'){
              const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
              grid.appendChild(vendorField.wrap);
              const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○交通車'});
              vendorNameField.wrap.dataset.planVendorName=entry.code;
              grid.appendChild(vendorNameField.wrap);
              appendAutoSummaryField(grid, entry, '預估交通安排');
              const usageField=createPlanInput(entry,'usage','交通使用方式',{as:'textarea',placeholder:'系統已提供建議內容，可再補充乘車安排',className:'full'});
              grid.appendChild(usageField.wrap);
            }else if(entry.code === 'BA02'){
              const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
              grid.appendChild(vendorField.wrap);
              const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○服務單位'});
              vendorNameField.wrap.dataset.planVendorName=entry.code;
              grid.appendChild(vendorNameField.wrap);
              const unitField=createPlanInput(entry,'monthlyUnits','月目標',{placeholder:'例：10',attrs:{inputmode:'decimal'}});
              grid.appendChild(unitField.wrap);
              const weeklyWrap=document.createElement('div');
              weeklyWrap.className='plan-field';
              const weeklyLabel=document.createElement('label');
              weeklyLabel.textContent='換算每週次數';
              weeklyWrap.appendChild(weeklyLabel);
              const weeklyBox=document.createElement('div');
              weeklyBox.className='auto-summary-box empty';
              weeklyBox.dataset.planBa02Display = entry.code;
              weeklyWrap.appendChild(weeklyBox);
              grid.appendChild(weeklyWrap);
              ba02WeeklyDisplays[entry.code] = weeklyBox;
              const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'請描述服務內容、案主期待或家屬配合情況'});
              grid.appendChild(usageField.wrap);
            }else{
              const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
              grid.appendChild(vendorField.wrap);
              const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○服務單位'});
              vendorNameField.wrap.dataset.planVendorName=entry.code;
              grid.appendChild(vendorNameField.wrap);
              const weeklyField=createPlanInput(entry,'weeklyFreq','每週次數',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
              grid.appendChild(weeklyField.wrap);
              const unitVisitField=createPlanInput(entry,'unitPerVisit','每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
              grid.appendChild(unitVisitField.wrap);
              const extraVisitField=createPlanInput(entry,'monthlyExtraVisits','每月額外次數',{type:'number',attrs:{step:'1',min:'0',inputmode:'decimal'}});
              grid.appendChild(extraVisitField.wrap);
              const extraUnitField=createPlanInput(entry,'monthlyExtraUnit','額外每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
              grid.appendChild(extraUnitField.wrap);
              const extraDescField=createPlanInput(entry,'monthlyExtraDesc','額外使用說明',{placeholder:'例：搭配陪同就醫使用'});
              extraDescField.wrap.classList.add('full');
              grid.appendChild(extraDescField.wrap);
              const unitField=createPlanInput(entry,'monthlyUnits','月單位',{placeholder:'例：32',attrs:{inputmode:'decimal'}});
              grid.appendChild(unitField.wrap);
              const freqField=createPlanInput(entry,'frequency','頻率／計算說明',{as:'textarea',placeholder:'系統依數值自動產生，可再補充',className:'full'});
              grid.appendChild(freqField.wrap);
              const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'請描述服務內容、案主期待或家屬配合情況'});
              grid.appendChild(usageField.wrap);
            }
          }else if(cat==='D'){
            const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
            grid.appendChild(vendorField.wrap);
            const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○服務單位'});
            vendorNameField.wrap.dataset.planVendorName=entry.code;
            grid.appendChild(vendorNameField.wrap);
            const weeklyField=createPlanInput(entry,'weeklyFreq','每週次數',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
            grid.appendChild(weeklyField.wrap);
            const unitVisitField=createPlanInput(entry,'unitPerVisit','每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
            grid.appendChild(unitVisitField.wrap);
            const extraVisitField=createPlanInput(entry,'monthlyExtraVisits','每月額外次數',{type:'number',attrs:{step:'1',min:'0',inputmode:'decimal'}});
            grid.appendChild(extraVisitField.wrap);
            const extraUnitField=createPlanInput(entry,'monthlyExtraUnit','額外每次單位',{type:'number',attrs:{step:'0.5',min:'0',inputmode:'decimal'}});
            grid.appendChild(extraUnitField.wrap);
            const extraDescField=createPlanInput(entry,'monthlyExtraDesc','額外使用說明',{placeholder:'例：搭配陪同就醫使用'});
            extraDescField.wrap.classList.add('full');
            grid.appendChild(extraDescField.wrap);
            const unitField=createPlanInput(entry,'monthlyUnits','月單位',{placeholder:'例：32',attrs:{inputmode:'decimal'}});
            grid.appendChild(unitField.wrap);
            const freqField=createPlanInput(entry,'frequency','頻率／計算說明',{as:'textarea',placeholder:'系統依數值自動產生，可再補充',className:'full'});
            grid.appendChild(freqField.wrap);
            const usageField=createPlanInput(entry,'usage','使用方式或案主期待',{as:'textarea',placeholder:'請描述服務內容、案主期待或家屬配合情況'});
            grid.appendChild(usageField.wrap);
          }else if(cat==='C'){
            const vendorField=createPlanInput(entry,'vendorMode','供應模式',{as:'select',options:[{value:'輪派',label:'輪派'},{value:'指定',label:'指定'}]});
            grid.appendChild(vendorField.wrap);
            const vendorNameField=createPlanInput(entry,'vendorName','指定單位',{placeholder:'例：○○○專業服務單位'});
            vendorNameField.wrap.dataset.planVendorName=entry.code;
            grid.appendChild(vendorNameField.wrap);
            const periodField=createPlanInput(entry,'period','服務期間',{placeholder:'例：113年01月至113年03月'});
            grid.appendChild(periodField.wrap);
            const usageField=createPlanInput(entry,'usage','單次規劃說明',{as:'textarea',placeholder:'請描述專業服務內容與案主/家屬配合情況'});
            grid.appendChild(usageField.wrap);
          }else if(cat==='EF'){
            const periodField=createPlanInput(entry,'period','補助額度期間',{placeholder:'例：113年01月~113年12月'});
            grid.appendChild(periodField.wrap);
            const originalField=createPlanInput(entry,'original','原有額度（元）',{placeholder:'例：20000',attrs:{inputmode:'decimal'}});
            grid.appendChild(originalField.wrap);
            const approveField=createPlanInput(entry,'planned','本次核定（元）',{placeholder:'例：12000',attrs:{inputmode:'decimal'}});
            grid.appendChild(approveField.wrap);
            const remainField=createPlanInput(entry,'remaining','剩餘額度（元）',{placeholder:'例：8000',attrs:{inputmode:'decimal'}});
            grid.appendChild(remainField.wrap);
            const usageField=createPlanInput(entry,'usage','輔具／無障礙重點（選填）',{as:'textarea',placeholder:'例：浴室增設扶手、防滑墊；家屬可配合施工時程。'});
            grid.appendChild(usageField.wrap);
          }else if(cat==='G'){
            const periodField=createPlanInput(entry,'period','喘息額度期間',{placeholder:'例：113年01月~113年12月'});
            grid.appendChild(periodField.wrap);
            const plannedField=createPlanInput(entry,'planned','本次規劃（時數／單位）',{placeholder:'例：40單位',attrs:{inputmode:'decimal'}});
            grid.appendChild(plannedField.wrap);
            const remainField=createPlanInput(entry,'remaining','餘額',{placeholder:'例：剩餘20單位'});
            grid.appendChild(remainField.wrap);
            const usageField=createPlanInput(entry,'usage','喘息安排與配合狀況',{as:'textarea',placeholder:'例：安排週三全日喘息，主要照顧者於此時段休息並處理家務。'});
            grid.appendChild(usageField.wrap);
          }else if(cat==='SC'){
            const periodField=createPlanInput(entry,'period','短照額度期間',{placeholder:'例：113年01月~113年12月'});
            grid.appendChild(periodField.wrap);
            const noteField=createPlanInput(entry,'usage','比例或使用說明',{as:'textarea',placeholder:'例：本月短照占比18%，符合政策規範（≦20%）。'});
            grid.appendChild(noteField.wrap);
          }else if(cat==='MEAL'){
            const mealsField=createPlanInput(entry,'mealsPerDay','1日核定餐數',{placeholder:'例：2（午、晚餐）'});
            grid.appendChild(mealsField.wrap);
            const mealTypeField=createPlanInput(entry,'mealType','餐別／質地',{placeholder:'例：午餐、晚餐；軟質餐'});
            grid.appendChild(mealTypeField.wrap);
            const usageField=createPlanInput(entry,'usage','送餐備註',{as:'textarea',placeholder:'例：含到宅關懷與餐點保溫指導；列冊中低收入戶享有補助。'});
            grid.appendChild(usageField.wrap);
          }else{
            const usageField=createPlanInput(entry,'usage','服務說明',{as:'textarea',placeholder:'請填寫此服務之使用方式或補充說明'});
            grid.appendChild(usageField.wrap);
          }
          entryBox.appendChild(grid);
          section.appendChild(entryBox);
          if(entry.code === 'BA02'){
            updateBa02WeeklyDisplay(entry.code);
          }
          updatePlanVendorVisibility(entry.code);
          if(!(entry.code && entry.code.indexOf('BB') === 0) && entry.code !== 'BD03' && entry.code !== 'BA02'){
            updatePlanMonthlyComputation(entry.code, {skipPreview:true});
          }
        });
        host.appendChild(section);
      });
    }

    function updateBa02WeeklyDisplay(code){
      if(!code) return;
      const box=ba02WeeklyDisplays[code];
      if(!box || !box.isConnected){
        if(ba02WeeklyDisplays[code]) delete ba02WeeklyDisplays[code];
        return;
      }
      const entry=servicePlanState[code];
      const text=buildBa02WeeklyText(entry);
      if(text){
        box.textContent=text;
        box.classList.remove('empty');
      }else{
        box.textContent='尚未設定月目標';
        box.classList.add('empty');
      }
    }

    function appendAutoSummaryField(grid, entry, label){
      const wrap=document.createElement('div');
      wrap.className='plan-field full auto-summary';
      const lab=document.createElement('label');
      lab.textContent=label;
      wrap.appendChild(lab);
      const box=document.createElement('div');
      box.className='auto-summary-box';
      const summary = buildAutoSummaryText(entry);
      if(summary){
        box.textContent=summary;
      }else{
        box.textContent='尚未計算，請確認已設定 CMS 等級與服務項目。';
        box.classList.add('empty');
      }
      wrap.appendChild(box);
      grid.appendChild(wrap);
    }

    function getPlanEntriesByCategory(cat){
      return Object.values(servicePlanState)
        .filter(entry => (entry.category || '') === cat)
        .sort((a,b)=>a.code.localeCompare(b.code));
    }

    function buildBa02WeeklyText(entry){
      if(!entry || entry.code !== 'BA02') return '';
      const manualMonthly=(entry.monthlyUnits || '').trim();
      let monthlyValue=manualMonthly ? parsePlanNumber(manualMonthly) : 0;
      if(!(monthlyValue > 0)){
        const computed=(entry.monthlyUnitsComputed || '').trim();
        if(computed){
          monthlyValue=parsePlanNumber(computed);
        }
      }
      if(!(monthlyValue > 0) && isFiniteNumber(entry.autoPlanMonthlyVisits)){
        monthlyValue=entry.autoPlanMonthlyVisits;
      }
      if(!(monthlyValue > 0)) return '';
      const weeklyValue=Math.ceil(monthlyValue / 4.5);
      if(!(weeklyValue > 0)) return '';
      const weeklyText=formatPlanNumber(weeklyValue);
      if(!weeklyText) return '';
      return `每週 ${weeklyText} 次`;
    }

    function formatPlanEntryB(entry, idx){
      if(!entry) return '';
      let vendor='';
      if(entry.vendorMode === '指定'){
        vendor = `（指定${entry.vendorName || '○○○單位'}）`;
      }else if(entry.vendorMode === '輪派'){
        vendor = '（輪派）';
      }else if(entry.vendorMode){
        vendor = `（${entry.vendorMode}）`;
      }else{
        vendor = '（請填輪派或指定單位）';
      }
      const summary = buildAutoSummaryText(entry);
      const usageText = (entry.usage || entry.autoUsageText || '').trim();
      let text=`${idx}.${entry.code}[${entry.name || ''}]${vendor}`;
      const ba02WeeklyText = buildBa02WeeklyText(entry);
      if(summary){
        text += `，${summary}`;
        if(ba02WeeklyText){
          text += `；${ba02WeeklyText}`;
        }
        if(usageText){
          text += `；${usageText}`;
        }else{
          text += '；請補充使用方式或案主期待。';
        }
      }else{
        const monthly = entry.monthlyUnits ? `*${entry.monthlyUnits}` : '*（請填月單位）';
        const parts=[];
        if(entry.frequency) parts.push(entry.frequency);
        if(ba02WeeklyText) parts.push(ba02WeeklyText);
        if(usageText) parts.push(usageText);
        text=`${idx}.${entry.code}[${entry.name || ''}]${monthly}${vendor}`;
        if(parts.length){
          text += `，${parts.join('；')}`;
        }else{
          text += '，請補充頻率、計算說明及使用方式。';
        }
      }
      if(!text.endsWith('。')) text += '。';
      return text;
    }

    function formatPlanEntryC(entry, idx){
      if(!entry) return '';
      let vendor='';
      if(entry.vendorMode === '指定'){
        vendor = `（指定${entry.vendorName || '○○○單位'}）`;
      }else if(entry.vendorMode === '輪派'){
        vendor = '（輪派）';
      }else if(entry.vendorMode){
        vendor = `（${entry.vendorMode}）`;
      }
      const period=(entry.period || '').trim();
      const usageText=(entry.usage || entry.autoUsageText || '').trim();
      const parts=[];
      if(period) parts.push(`期間：${period}`);
      if(usageText){
        parts.push(usageText);
      }else{
        parts.push('請補充單次規劃說明');
      }
      let text=`${idx}.${entry.code}[${entry.name || ''}]${vendor}`;
      if(parts.length){
        text += `：${parts.join('；')}`;
      }else{
        text += '：請補充單次規劃說明。';
      }
      if(!text.endsWith('。')) text += '。';
      return text;
    }

    function formatPlanEntryD(entry, idx){
      if(!entry) return '';
      const vendor = entry.vendorMode === '指定'
        ? `指定${entry.vendorName || '○○○單位'}`
        : '輪派照會3家服務單位';
      const monthly = entry.monthlyUnits ? `*${entry.monthlyUnits}` : '';
      const parts=[];
      if(entry.frequency) parts.push(entry.frequency);
      if(entry.usage) parts.push(entry.usage);
      let text=`${idx}.${vendor} ${entry.code}[${entry.name || ''}]${monthly}`;
      if(parts.length){
        text += `，${parts.join('；')}`;
      }else{
        text += '，請補充頻率與使用方式。';
      }
      if(!text.endsWith('。')) text += '。';
      return text;
    }

    function gatherPlanReferrals(){
      const lines=[];
      const mapping=[
        {key:'pt', label:'據點'},
        {key:'nb', label:'鄰里'},
        {key:'rg', label:'宗教/社團'},
        {key:'fw', label:'財團/社會福利'}
      ];
      mapping.forEach(item=>{
        const chk=document.getElementById('sp_inf_'+item.key);
        if(chk && chk.checked){
          const name=(document.getElementById('sp_inf_'+item.key+'_name')?.value || '').trim();
          const freq=(document.getElementById('sp_inf_'+item.key+'_freq')?.value || '').trim();
          let text=item.label;
          if(name) text += `-${name}`;
          if(freq) text += `-${freq}`;
          lines.push(text);
        }
      });
      const extra=(planMetaState.referralExtra || '').trim();
      if(extra){
        extra.split(/\r?\n/).map(line=>line.trim()).filter(Boolean).forEach(line=>lines.push(line));
      }
      return lines;
    }

    function getSelectedProblemTexts(){
      if(typeof getSelectedProblems !== 'function') return [];
      const codes=getSelectedProblems();
      if(!codes || !codes.length) return [];
      return codes.map(code=>{
        const label = PROBLEMS && PROBLEMS[code] ? PROBLEMS[code] : '';
        return label ? `${code}.${label}` : `${code}`;
      });
    }

    function formatCaseDisplay(){
      const gender=(document.getElementById('s1_gender')?.value || '').trim();
      const caseName=(document.getElementById('caseName')?.value || '').trim();
      let prefix='案主';
      if(gender==='男') prefix='案男';
      else if(gender==='女') prefix='案女';
      return caseName ? `${prefix}-${caseName}` : prefix;
    }

    function buildApprovalPlanPreview(){
      const box=document.getElementById('plan_text');
      if(!box) return;
      const lines=[];
      lines.push('一、長照服務核定項目、頻率：');
      const bEntries=getPlanEntriesByCategory('B');
      if(bEntries.length){
        lines.push('（一）B碼（輪派/指定○○○單位）');
        lines.push('服務代碼*核定數量+使用頻率及方式');
        bEntries.forEach((entry,idx)=>{ const text=formatPlanEntryB(entry, idx+1); if(text) lines.push(text); });
      }else{
        lines.push('（一）B碼：暫無設定。');
      }
      const cEntries=getPlanEntriesByCategory('C');
      if(cEntries.length){
        lines.push('（二）C碼（輪派/指定○○○單位）');
        lines.push('服務代碼+案主最希望改善之項目及配合狀況');
        cEntries.forEach((entry,idx)=>{ const text=formatPlanEntryC(entry, idx+1); if(text) lines.push(text); });
      }else{
        lines.push('（二）C碼：暫無規劃。');
      }
      const dEntries=getPlanEntriesByCategory('D');
      if(dEntries.length){
        lines.push('（三）D碼：輪派照會3家服務單位／指定○○○單位（代碼＋名稱）');
        dEntries.forEach((entry,idx)=>{ const text=formatPlanEntryD(entry, idx+1); if(text) lines.push(text); });
      }else{
        lines.push('（三）D碼：暫無規劃。');
      }
      const efEntries=getPlanEntriesByCategory('EF');
      if(efEntries.length){
        lines.push('（四）E.F碼：');
        efEntries.forEach(entry=>{
          const period=entry.period || '（請填期間）';
          const original=entry.original || '（請填原額度）';
          const approved=entry.planned || '（請填本次核定）';
          const remaining=entry.remaining || '（請填剩餘額度）';
          let text=`期間${period}；原有額度${original}元，本次核定${approved}元，剩餘${remaining}元。`;
          if(entry.usage){
            text += entry.usage.endsWith('。') ? entry.usage : ` ${entry.usage}`;
          }
          lines.push(text);
        });
      }else{
        lines.push('（四）E.F碼：暫無申請。');
      }
      const gEntries=getPlanEntriesByCategory('G');
      if(gEntries.length){
        lines.push('（五）G碼：');
        gEntries.forEach(entry=>{
          const period=entry.period || '（請填期間）';
          const planned=entry.planned || '（請填規劃）';
          const remaining=entry.remaining || '（請填餘額）';
          let text=`喘息額度期間${period}；本次規劃${planned}，餘額${remaining}。`;
          if(entry.usage){
            text += entry.usage.endsWith('。') ? entry.usage : entry.usage + '。';
          }
          lines.push(text);
        });
      }else{
        lines.push('（五）G碼：暫無規劃。');
      }
      const scEntries=getPlanEntriesByCategory('SC');
      if(scEntries.length){
        lines.push('（六）SC碼：');
        scEntries.forEach(entry=>{
          const period=entry.period || '（請填期間）';
          const note=entry.usage || '（請敘明比例或使用狀況）';
          lines.push(`短照額度期間${period}；${note}`);
        });
      }else{
        lines.push('（六）SC碼：暫無規劃。');
      }
      const mealEntries=getPlanEntriesByCategory('MEAL');
      if(mealEntries.length){
        lines.push('（七）營養餐飲服務：');
        mealEntries.forEach(entry=>{
          const meals=entry.mealsPerDay || '（請填餐數）';
          const mealType=entry.mealType || '（請填午／晚餐）';
          let text=`1日核定${meals}餐（${mealType}）`;
          if(entry.usage){
            text += entry.usage.endsWith('。') ? entry.usage : `。${entry.usage}`;
          }else{
            text += '。';
          }
          lines.push(text);
        });
      }else{
        lines.push('（七）營養餐飲服務：尚未設定。');
      }
      const emergencyNote=(planMetaState.emergencyNote || '').trim();
      lines.push(`（八）緊急救援服務：${emergencyNote || '（請說明是否申請及啟用原因）'}`);
      lines.push('二、轉介其他服務資源：');
      const referralLines=gatherPlanReferrals();
      if(referralLines.length){
        referralLines.forEach(line=>{
          const trimmed=line.trim();
          if(!trimmed) return;
          if(/^[-•\u2022]/.test(trimmed)){ lines.push(trimmed); }
          else{ lines.push(`- ${trimmed}`); }
        });
      }else{
        lines.push('- （尚未填寫）');
      }
      const cmsLevel=getCmsLevel();
      if(cmsLevel==='2' || cmsLevel==='3'){
        const stationInfo=(planMetaState.stationInfo || '').trim() || '請補充鄰近巷弄長照站資訊';
        const willing=(planMetaState.stationWillingness || '').trim() || '請確認意願';
        lines.push(`- 鄰近巷弄長照站：${stationInfo}；意願：${willing}。將於AA02服務紀錄持續追蹤。`);
        lines.push('※另針對長照需要等級第2~3級長照服務使用者，請提供鄰近巷弄長照站資訊，並確認個案有／無意願，將於AA02服務紀錄持續追蹤。');
      }
      const problemTexts=getSelectedProblemTexts();
      if(problemTexts.length){
        lines.push(`（服務對應問題：${problemTexts.join('、')}）`);
      }
      const mismatchSummary=getMismatchReasonSummary();
      if(mismatchSummary){
        lines.push(mismatchSummary);
      }
      lines.push('告知與同意：');
      lines.push(`上述計畫，均告知${formatCaseDisplay()}其了解計畫內容並同意服務使用，並簽訂服務使用確認單。（請單位留存確認單備查）`);
      const manager=(document.getElementById('caseManagerName')?.value || '').trim() || '（請填寫個管師姓名）';
      lines.push(`個案管理員：${manager}`);
      box.value = lines.join('\n');
      buildPlanSummaryPreview();
    }

    function serializeServicePlan(){
      return Object.values(servicePlanState).map(entry=>Object.assign({}, entry));
    }

    function initPlanMetaFields(){
      const ref=document.getElementById('plan_referral_extra');
      if(ref){ ref.addEventListener('input', evt=>{ planMetaState.referralExtra = evt.target.value; buildApprovalPlanPreview(); }); }
      const stationInfo=document.getElementById('plan_station_info');
      if(stationInfo){ stationInfo.addEventListener('input', evt=>{ planMetaState.stationInfo = evt.target.value; buildApprovalPlanPreview(); }); }
      const stationWill=document.getElementById('plan_station_willingness');
      if(stationWill){ stationWill.addEventListener('change', evt=>{ planMetaState.stationWillingness = evt.target.value; buildApprovalPlanPreview(); }); }
      const emergency=document.getElementById('plan_emergency_note');
      if(emergency){ emergency.addEventListener('input', evt=>{ planMetaState.emergencyNote = evt.target.value; buildApprovalPlanPreview(); }); }
    }

    function setCmsLevel(level){
      const value = level ? String(level) : '';
      const hidden=document.getElementById('cmsLevelValue');
      if(hidden) hidden.value = value;
      document.querySelectorAll('#cmsLevelGroup button').forEach(btn=>{
        btn.dataset.active = btn.dataset.level === value ? '1' : '0';
      });
      refreshDayCareAvailability();
      syncPlanStateWithSelections();
    }

    function getCmsLevel(){
      return (document.getElementById('cmsLevelValue')?.value || '').trim();
    }

    function initCmsLevelButtons(){
      const group=document.getElementById('cmsLevelGroup');
      if(!group) return;
      group.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{ setCmsLevel(btn.dataset.level); });
      });
      const current = (document.getElementById('cmsLevelValue')?.value || '').trim();
      if(current) setCmsLevel(current);
    }

    function loadServiceCatalog(){
      google.script.run.withSuccessHandler(data=>{
        const nextCatalog = JSON.parse(JSON.stringify(DEFAULT_SERVICE_CATALOG));
        if(data && typeof data === 'object'){
          if(data.needLevelCaps) nextCatalog.needLevelCaps = data.needLevelCaps;
          if(data.dayCareRequirements) nextCatalog.dayCareRequirements = data.dayCareRequirements;
          if(data.dayCareLevels) nextCatalog.dayCareLevels = data.dayCareLevels;
          if(data.serviceRates) nextCatalog.serviceRates = data.serviceRates;
          if(typeof data.transportRoundTrips === 'number') nextCatalog.transportRoundTrips = data.transportRoundTrips;
        }
        SERVICE_CATALOG = nextCatalog;
        refreshDayCareAvailability();
        syncPlanStateWithSelections();
      }).getServiceCatalog();
    }

    function onHomeCareToggle(card, selected){
      if(!card) return;
      const code = card.dataset ? card.dataset.code : '';
      if(!code) return;
      if(!selected){
        const input = card.querySelector('.home-care-qty');
        if(input){ input.value=''; }
      }
      updateCareServicePhrases();
      syncPlanStateWithSelections();
    }

    function onHomeCareQuantityChange(input){
      if(!input) return;
      const card = input.closest('.home-care-item');
      if(!card || card.dataset.selected !== '1'){
        buildApprovalPlanPreview();
        return;
      }
      const code = card.dataset ? card.dataset.code : '';
      if(!code) return;
      updateCareServicePhrases();
      const value = input.value ? input.value.trim() : '';
      if(value){
        const entry = servicePlanState[code];
        if(entry && !entry.monthlyUnits){
          entry.monthlyUnits = value;
          const planInput=document.querySelector(`[data-plan-code="${code}"][data-plan-field="monthlyUnits"]`);
          if(planInput && planInput !== document.activeElement){ planInput.value = value; }
        }
      }
      buildApprovalPlanPreview();
    }

    function onDayCareToggle(card, selected){
      if(selected){
        ensureSingleDayCareSelection(card);
      }
      updateCareServicePhrases();
      syncPlanStateWithSelections();
    }
    function applyAutoText(id, text){
      const el=document.getElementById(id);
      if(!el) return;
      const prevAuto = el.dataset.autoValue === undefined ? undefined : el.dataset.autoValue;
      const userEdited = el.dataset.userEdited === 'true';
      const current = el.value;
      if(!userEdited || current === prevAuto){
        el.value = text;
        el.dataset.userEdited = 'false';
      }
      el.dataset.autoValue = text;
    }
    function bindAutoGoalField(id){
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{
        const auto = el.dataset.autoValue;
        if(auto === undefined){
          el.dataset.userEdited = el.value ? 'true' : 'false';
        }else{
          el.dataset.userEdited = el.value === auto ? 'false' : 'true';
        }
      });
    }
    function resetGoalAutoState(ids){
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.dataset.userEdited = 'false';
      });
    }
    function resetCareServicePhrases(){
      resetGoalAutoState(['short_care','mid_care','long_goal']);
      updateCareServicePhrases();
    }
    function resetProfessionalPhrases(){
      resetGoalAutoState(['short_prof','mid_prof','long_goal']);
      updateProfessionalServicePhrases();
    }
    function resetTransportPhrases(){
      resetGoalAutoState(['short_car','mid_car','long_goal']);
      updateTransportServicePhrases();
    }
    function resetRespitePhrases(){
      resetGoalAutoState(['short_resp','mid_resp','long_goal']);
      updateRespiteServicePhrases();
    }
    function resetMealPhrases(){
      resetGoalAutoState(['short_meal','mid_meal','long_goal']);
      updateMealServicePhrases();
    }
    function getSelectedHomeCareEntries(){
      const rows=[...document.querySelectorAll('#homeCareList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=HOME_CARE_MAP[code];
        if(!item) return null;
        const qtyInput=row.querySelector('.home-care-qty');
        const quantity = qtyInput ? qtyInput.value.trim() : '';
        return { code, item, quantity };
      }).filter(Boolean);
    }
    function getSelectedDayCareEntries(){
      const rows=[...document.querySelectorAll('#dayCareList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=DAY_CARE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function onProfessionalToggle(){
      updateProfessionalServicePhrases();
      syncPlanStateWithSelections();
    }
    function onTransportToggle(){
      updateTransportServicePhrases();
      syncPlanStateWithSelections();
    }
    function onRespiteToggle(){
      updateRespiteServicePhrases();
      syncPlanStateWithSelections();
    }
    function onMealToggle(){
      updateMealServicePhrases();
      syncPlanStateWithSelections();
    }
    function getSelectedProfessionalEntries(){
      const rows=[...document.querySelectorAll('#profServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=PROFESSIONAL_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedTransportEntries(){
      const rows=[...document.querySelectorAll('#transportServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=TRANSPORT_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedRespiteEntries(){
      const rows=[...document.querySelectorAll('#respServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=RESPITE_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedMealEntries(){
      const rows=[...document.querySelectorAll('#mealServiceList .home-care-item[data-selected="1"]')];
      return rows.map(row=>{
        const code = row.dataset.code || '';
        const item=MEAL_SERVICE_MAP[code];
        return item ? { code, item } : null;
      }).filter(Boolean);
    }
    function getSelectedHomeCareCodes(){
      return getSelectedHomeCareEntries().map(entry=>entry.code);
    }
    function isHomeCareSelected(){
      return !!document.querySelector('#sp_formal input[type=checkbox][value="居家服務"]:checked');
    }
    function isDayCareSelected(){
      return !!document.querySelector('#sp_formal input[type=checkbox][value="日間照顧"]:checked');
    }
    function getSelectedCareEntries(){
      let entries=[];
      if(isHomeCareSelected()) entries = entries.concat(getSelectedHomeCareEntries());
      if(isDayCareSelected()) entries = entries.concat(getSelectedDayCareEntries());
      return entries;
    }
    function updateCareServicePhrases(){
      const entries = getSelectedCareEntries();
      const shortText = entries.map(entry=>formatCareServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatCareServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_care', shortText);
      applyAutoText('mid_care', midText);
      buildLongGoal();
    }
    function updateProfessionalServicePhrases(){
      const entries = getSelectedProfessionalEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_prof', shortText);
      applyAutoText('mid_prof', midText);
      buildLongGoal();
    }
    function updateTransportServicePhrases(){
      const entries = getSelectedTransportEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_car', shortText);
      applyAutoText('mid_car', midText);
      buildLongGoal();
    }
    function updateRespiteServicePhrases(){
      const entries = getSelectedRespiteEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_resp', shortText);
      applyAutoText('mid_resp', midText);
      buildLongGoal();
    }
    function updateMealServicePhrases(){
      const entries = getSelectedMealEntries();
      const shortText = entries.map(entry=>formatGoalServiceSentence(entry, 'short')).filter(Boolean).join('\n');
      const midText = entries.map(entry=>formatGoalServiceSentence(entry, 'mid')).filter(Boolean).join('\n');
      applyAutoText('short_meal', shortText);
      applyAutoText('mid_meal', midText);
      buildLongGoal();
    }
    function toggleInfInput(key){
      const on  = document.getElementById('sp_inf_'+key).checked;
      const name= document.getElementById('sp_inf_'+key+'_name');
      const freq= document.getElementById('sp_inf_'+key+'_freq');
      if(name){
        name.style.display = on ? '' : 'none'; 
        if(!on) name.value='';
      }
      // 頻率僅在「有勾選且名稱非空」時顯示
      if(freq){
        const showFreq = on && name && name.value.trim();
        freq.style.display = showFreq ? '' : 'none';
        if(!showFreq) freq.value='';
      }
      buildApprovalPlanPreview();
    }
    function bindInfNameToFreq(key){
      const name = document.getElementById('sp_inf_'+key+'_name');
      const freq = document.getElementById('sp_inf_'+key+'_freq');
      if(!name || !freq) return;
      name.addEventListener('input', ()=>{
      if(name.value.trim()){
        freq.style.display='';
      }else{
        freq.style.display='none';
        freq.value='';
      }
      buildApprovalPlanPreview();
    });
    freq.addEventListener('change', buildApprovalPlanPreview);
    freq.addEventListener('input', buildApprovalPlanPreview);
  }

    function toggleGoalInputs(){
      const selected=[...document.querySelectorAll('#sp_formal input[type=checkbox]:checked')].map(b=>b.value);
      const hasCare = selected.includes('居家服務') || selected.includes('日間照顧');
      const hasHomeCare = selected.includes('居家服務');
      const hasDayCare = selected.includes('日間照顧');
      const hasProf = selected.includes('專業服務');
      const hasCar  = selected.includes('交通接送');
      const hasResp = selected.includes('喘息服務');
      const hasAcc  = selected.includes('無障礙及輔具');
      const hasMeal = selected.includes('營養送餐');
      setVisible('short_care_wrap', hasCare); setVisible('mid_care_wrap', hasCare);
      setVisible('short_prof_wrap', hasProf); setVisible('mid_prof_wrap', hasProf);
      setVisible('short_car_wrap', hasCar);   setVisible('mid_car_wrap', hasCar);
      setVisible('short_resp_wrap', hasResp); setVisible('mid_resp_wrap', hasResp);
      setVisible('short_access_wrap', hasAcc); setVisible('mid_access_wrap', hasAcc);
      setVisible('short_meal_wrap', hasMeal);  setVisible('mid_meal_wrap', hasMeal);
      setVisible('homeCareWrap', hasHomeCare);
      setVisible('dayCareWrap', hasDayCare);
      setVisible('profServiceWrap', hasProf);
      setVisible('transportServiceWrap', hasCar);
      setVisible('respServiceWrap', hasResp);
      setVisible('mealServiceWrap', hasMeal);
      if(!hasHomeCare){
        document.querySelectorAll('#homeCareList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
          const qty = card.querySelector('.home-care-qty');
          if(qty){ qty.value=''; }
        });
      }
      if(!hasDayCare){
        document.querySelectorAll('#dayCareList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasProf){
        document.querySelectorAll('#profServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasCar){
        document.querySelectorAll('#transportServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasResp){
        document.querySelectorAll('#respServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      if(!hasMeal){
        document.querySelectorAll('#mealServiceList .home-care-item').forEach(card=>{
          if(card.dataset.selected === '1'){ setServiceCardSelected(card, false); }
        });
      }
      updateCareServicePhrases();
      if(!hasProf) updateProfessionalServicePhrases();
      if(!hasCar)  updateTransportServicePhrases();
      if(!hasResp) updateRespiteServicePhrases();
      if(!hasMeal) updateMealServicePhrases();
      syncPlanStateWithSelections();
    }
    function setVisible(id,on){ const el=document.getElementById(id); if(el) el.style.display = on? '' : 'none'; }

    function bindQuickReasons(){
      ['rq1_no','rq1_alt','rq2_service'].forEach(id=>{
        const inp=document.getElementById(id);
        const span=document.getElementById(id+'_preview');
        if(inp && span){ const def=span.dataset.def; inp.addEventListener('input', ()=>{ span.textContent = inp.value || def; }); }
      });
      const rel=document.getElementById('sp_deciderRel');
      const name=document.getElementById('sp_deciderName');
      rel?.addEventListener('change', syncQuickWho);
      name?.addEventListener('input', syncQuickWho);
      syncQuickWho();
      document.getElementById('rq1')?.addEventListener('change', ()=>toggleQuick(1));
      document.getElementById('rq2')?.addEventListener('change', ()=>toggleQuick(2));
    }
    function syncQuickWho(){
      const rel=document.getElementById('sp_deciderRel')?.value || '案';
      const name=(document.getElementById('sp_deciderName')?.value || '').trim() || '○';
      const who=rel+name;
      ['rq1_who','rq2_who'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=who; });
    }
    function toggleQuick(idx){
      const area=document.getElementById('reason3');
      let text=''; let box;
      const who=document.getElementById('rq1_who')?.textContent || '案○';
      if(idx===1){
        box=document.getElementById('rq1');
        const no=document.getElementById('rq1_no').value || document.getElementById('rq1_no_preview').dataset.def;
        const alt=document.getElementById('rq1_alt').value || document.getElementById('rq1_alt_preview').dataset.def;
        text=`經與${who}討論，目前暫無${no}之需求，改為${alt}。`;
      }else if(idx===2){
        box=document.getElementById('rq2');
        const svc=document.getElementById('rq2_service').value || document.getElementById('rq2_service_preview').dataset.def;
        text=`經與${who}討論，目前因個案身體狀況，暫無${svc}需求，日後待個案狀況好轉後，依當下狀況核定，續追蹤。`;
      }
      if(!box) return;
      if(box.checked){
        area.value = appendSentence(area.value, text);
        box.dataset.text=text;
      }else{
        area.value = removeSentence(area.value, box.dataset.text);
        box.dataset.text='';
      }
    }
    function appendSentence(base, text){
      base=base.trim();
      if(!base) return text;
      if(!base.endsWith('。')) base+='。';
      return base+text;
    }
    function removeSentence(base, text){
      return (base||'').replace(text,'').trim();
    }

    function copyFromH1Primary(){
      const relSelect=document.getElementById('primaryRel');
      const nameInput=document.getElementById('primaryName');
      const caseName=(document.getElementById('caseName').value||'').trim();
      let rel=relSelect ? relSelect.value : '';
      let name=nameInput ? nameInput.value.trim() : '';
      if(!rel){ rel='本人'; if(!name) name=caseName; }
      if(!name){ alert('三、偕同訪視者的主要照顧者尚未完整。'); return; }
      const sourcePhone = (document.getElementById('primaryPhone')?.value
        || document.getElementById('primaryTel')?.value
        || document.getElementById('primaryContactPhone')?.value || '').trim();
      const deciderRel=document.getElementById('sp_deciderRel');
      const deciderName=document.getElementById('sp_deciderName');
      const deciderPhone=document.getElementById('sp_deciderPhone');
      if(deciderRel){
        const optionExists=[...deciderRel.options].some(opt=>opt.value===rel);
        deciderRel.value = optionExists ? rel : '';
        deciderRel.dispatchEvent(new Event('change', {bubbles:true}));
      }
      if(deciderName){
        deciderName.value = name;
        deciderName.dispatchEvent(new Event('input', {bubbles:true}));
      }
      if(deciderPhone){
        deciderPhone.value = sourcePhone;
        deciderPhone.dispatchEvent(new Event('input', {bubbles:true}));
      }
      syncQuickWho();
      buildSection4();
    }
    function addCoCare(){
      const host=document.getElementById('coCare');
      const idx=coCareIdx++;
      const wrap=document.createElement('div'); wrap.className='row'; wrap.id=`cc-${idx}`;
      wrap.innerHTML=`
        <div>
          <label>關係</label>
          <select id="cc-rel-${idx}" onchange="toggleCustomRole(${idx}, 'cc')">
            ${roleOptionsHTML()}
          </select>
          <input id="cc-custom-${idx}" type="text" placeholder="自訂角色" style="display:none; margin-top:6px;">
        </div>
        <div><label>姓名</label><input id="cc-name-${idx}" type="text" placeholder="例如：李○○"></div>
        <div style="flex:0; align-self:flex-end;"><button class="small" onclick="document.getElementById('cc-${idx}').remove()">移除</button></div>
      `;
      host.appendChild(wrap);
    }
    function collectCoCare(){
      const out=[]; const rows=[...document.querySelectorAll('[id^="cc-"]')];
      rows.forEach(row=>{
        const idx=row.id.split('-')[1];
        const sel=document.getElementById(`cc-rel-${idx}`), custom=document.getElementById(`cc-custom-${idx}`), nameEl=document.getElementById(`cc-name-${idx}`);
        let rel=(sel?sel.value:'').trim(); if(rel==='自訂角色') rel=(custom?custom.value:'').trim();
        const name=(nameEl?nameEl.value:'').trim();
        if(rel && name) out.push({rel, name});
      });
      return out;
    }
    function buildSection4(){
      // ① 主照者（改讀三、偕同訪視者）
      let pr = (document.getElementById('primaryRel').value || '').trim();
      let pn = (document.getElementById('primaryName').value || '').trim();
      const caseName=(document.getElementById('caseName').value||'').trim();
      if(!pr){ pr='本人'; if(!pn) pn=caseName; }
      const ch = (document.getElementById('sp_cohabit').value || '').trim();

      // ② 主要聯繫人/決策者（維持原機制）
      let dr = (document.getElementById('sp_deciderRel').value || '').trim();
      if(dr==='自訂角色') dr = '（自訂）';
      const dn = (document.getElementById('sp_deciderName').value || '').trim();

      // ③ 共同照顧者（原機制）
      const cc = collectCoCare();

      // ④ 正式資源（原機制）
      const formal=[...document.querySelectorAll('#sp_formal input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);

      // ⑤ 非正式資源（改為每類各自名稱＋頻率）
      function infText(key, label){
        const chk = document.getElementById('sp_inf_'+key);
        if(!chk || !chk.checked) return '';
        const name = (document.getElementById('sp_inf_'+key+'_name')?.value || '').trim();
        const freq = (document.getElementById('sp_inf_'+key+'_freq')?.value || '').trim();
        if(name && freq) return `${label}（單位：${name}；頻率：${freq}）`;
        if(name)         return `${label}（單位：${name}）`;
        return label;
      }
      const infParts = [
        infText('pt','據點'),
        infText('nb','鄰里'),
        infText('rg','宗教/社團'),
        infText('fw','財團/社會福利')
      ].filter(Boolean);

      // ⑥ 風險（原機制）
      const risks=[...document.querySelectorAll('#sp_risks input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);

      // ⑦ 組字（維持原用語順序；僅變更主照者來源與非正式資源格式）
      let s='';
      if(pr && pn) s += `主照者為${pr}(${pn})${ch? '（'+ch+'）':''}`;
      if(dr && dn) s += (s? '，':'') + `主要聯繫人/決策者為${dr}(${dn})`;
      if(cc.length){
        const list = cc.map(x=>`${x.rel}(${x.name})`).join('、');
        s += (s? '，':'') + `並由${list}等共同協助`;
      }
      s += (s? '；':'') + '社區整合型服務中心為福安';
      if(formal.length) s += `，目前可運用資源：${formal.join('、')}`;
      if(infParts.length) s += `；非正式資源：${infParts.join('、')}`;
      if(risks.length) s += `；高風險評估：${risks.join('、')}`;
      if(s) s+='。';
      document.getElementById('section4_out').value = s;
    }
    function syncSocialPrimary(){
      let rel  = document.getElementById('primaryRel')?.value || '';
      let name = (document.getElementById('primaryName')?.value || '').trim();
      const caseName = (document.getElementById('caseName')?.value || '').trim();
      if(!rel){ rel='本人'; if(!name) name=caseName; }
      const relBox  = document.getElementById('sp_primaryRel_text');
      const nameBox = document.getElementById('sp_primaryName_text');
      if(relBox)  relBox.textContent  = rel || '—';
      if(nameBox) nameBox.textContent = name || '—';
    }


    /* ===== (六) 複評（結構→單行） ===== */
    function buildSection6(){
      const b=(document.getElementById('s6_before').value||'').trim();
      const a=(document.getElementById('s6_after').value||'').trim();
      let s='';
      if(b) s += `介入前：${b}`;
      if(a) s += (s? '；':'') + `介入後：${a}`;
      if(s) s+='。'; else s='此個案為新案，無複評評值。';
      document.getElementById('section6_struct').value = s;
    }

    /* ===== 五、照顧目標（原程式） ===== */
    const PROBLEMS = {
      1:'進食問題',2:'洗澡問題',3:'個人修飾問題',4:'穿脫衣物問題',5:'大小便控制問題',
      6:'上廁所問題',7:'移位問題',8:'走路問題',9:'上下樓梯問題',10:'使用電話問題',
      11:'購物或外出問題',12:'備餐問題',13:'處理家務問題',14:'用藥問題',15:'處理財務問題',
      16:'溝通問題',17:'短期記憶障礙',18:'疼痛問題',19:'不動症候群風險',20:'皮膚照護問題',
      21:'傷口問題',22:'水份及營養問題',23:'吞嚥問題',24:'管路照顧問題',25:'其他醫療照護問題',
      26:'跌倒風險',27:'安全疑慮',28:'居住環境障礙',29:'社會參與需協助',30:'困擾行為',
      31:'照顧負荷過重',32:'輔具使用問題',33:'感染問題',34:'其他問題'
    };
    function renderProblems(){
      const host=document.getElementById('problemList'); host.innerHTML='';
      for(let n=1;n<=34;n++){
        const lab=document.createElement('label');
        lab.innerHTML=`<input type="checkbox" value="${n}" onchange="limitProblems()"> ${n}.${PROBLEMS[n]}`;
        host.appendChild(lab);
      }
    }
    function limitProblems(){
      const boxes=[...document.querySelectorAll('#problemList input[type=checkbox]')];
      const selected=boxes.filter(b=>b.checked);
      document.getElementById('problemCount').textContent=`已選 ${selected.length} / 5`;
      if (selected.length>=5){ boxes.forEach(b=>{ if(!b.checked) b.disabled=true; }); } else { boxes.forEach(b=>b.disabled=false); }
      buildApprovalPlanPreview();
    }
    function getSelectedProblems(){
      return [...document.querySelectorAll('#problemList input[type=checkbox]')].filter(b=>b.checked).map(b=>parseInt(b.value,10));
    }
    function buildLongGoal(){
      const careEntries = getSelectedCareEntries();
      const profEntries = getSelectedProfessionalEntries();
      const carEntries  = getSelectedTransportEntries();
      const respEntries = getSelectedRespiteEntries();
      const mealEntries = getSelectedMealEntries();
      const sections = [];

      const careLines = careEntries.map(entry=>formatCareServiceSentence(entry, 'long')).filter(Boolean);
      if(careLines.length){
        sections.push('照顧服務：');
        careLines.forEach(line=>sections.push(`- ${line}`));
      }

      const profSummary = gatherLongSummary('short_prof','mid_prof');
      const profLong = profEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(profLong.length){
        profLong.forEach(line=>profSummary.push(`長期：${line}`));
      }
      if(profSummary.length){
        sections.push('專業服務：');
        profSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const carSummary = gatherLongSummary('short_car','mid_car');
      const carLong = carEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(carLong.length){
        carLong.forEach(line=>carSummary.push(`長期：${line}`));
      }
      if(carSummary.length){
        sections.push('交通接送：');
        carSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const respSummary = gatherLongSummary('short_resp','mid_resp');
      const respLong = respEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(respLong.length){
        respLong.forEach(line=>respSummary.push(`長期：${line}`));
      }
      if(respSummary.length){
        sections.push('喘息服務：');
        respSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const accessSummary = gatherLongSummary('short_access','mid_access');
      if(accessSummary.length){
        sections.push('無障礙及輔具：');
        accessSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const mealSummary = gatherLongSummary('short_meal','mid_meal');
      const mealLong = mealEntries.map(entry=>formatGoalServiceSentence(entry, 'long')).filter(Boolean);
      if(mealLong.length){
        mealLong.forEach(line=>mealSummary.push(`長期：${line}`));
      }
      if(mealSummary.length){
        sections.push('營養送餐：');
        mealSummary.forEach(line=>sections.push(`- ${line}`));
      }

      const finalText = sections.join('\n');
      applyAutoText('long_goal', finalText);
      buildGoalPreview();
    }

    function formatCareServiceSentence(entry, key){
      if(!entry || !entry.item) return '';
      const item = entry.item;
      const desc = item[key] || '';
      if(!desc.trim()) return '';
      const quantity = entry.quantity ? entry.quantity.trim() : '';
      const qtyText = quantity ? `（數量：${quantity}）` : '';
      return `${item.code}[${item.name}]${qtyText}：${desc}`;
    }
    function formatGoalServiceSentence(entry, key){
      if(!entry || !entry.item) return '';
      const item = entry.item;
      const desc = item[key] || '';
      if(!desc.trim()) return '';
      return `${item.code}[${item.name}]：${desc}`;
    }

    function normalizeBulletLine(line){
      return (line || '').replace(/^[\-\u2022\u2023\u25E6．\s]+/, '').trim();
    }

    function extractLines(text){
      if(!text) return [];
      return text
        .split(/\r?\n/)
        .map(normalizeBulletLine)
        .filter(Boolean);
    }

    function gatherLongSummary(shortId, midId){
      const shortLines = extractLines(document.getElementById(shortId)?.value || '');
      const midLines = extractLines(document.getElementById(midId)?.value || '');
      const result=[];
      if(shortLines.length){
        result.push(`短期：${shortLines.join('；')}`);
      }
      if(midLines.length){
        result.push(`中期：${midLines.join('；')}`);
      }
      return result;
    }

    function parseLongGoalForPreview(){
      const map={};
      const text=(document.getElementById('long_goal')?.value || '').trim();
      if(!text) return map;
      const lines=text.split(/\r?\n/);
      let current='';
      lines.forEach(line=>{
        const trimmed=line.trim();
        if(!trimmed) return;
        const headingMatch=trimmed.match(/^(.+?)：$/);
        if(headingMatch){
          current=headingMatch[1].trim();
          if(!map[current]) map[current]=[];
          return;
        }
        if(current){
          const normalized=normalizeBulletLine(trimmed);
          if(normalized) map[current].push(normalized);
        }
      });
      return map;
    }

    function buildPreviewSection(period){
      let heading='';
      const categories=[];
      if(period==='short'){
        heading='(二) 短期目標（0–3 個月）';
        [
          ['照顧服務','short_care'],
          ['專業服務','short_prof'],
          ['交通接送','short_car'],
          ['喘息服務','short_resp'],
          ['無障礙及輔具','short_access'],
          ['營養送餐','short_meal']
        ].forEach(([label, field])=>{
          const lines = extractLines(document.getElementById(field)?.value || '');
          if(lines.length) categories.push({label, lines});
        });
      }else if(period==='mid'){
        heading='(三) 中期目標（3–4 個月）';
        [
          ['照顧服務','mid_care'],
          ['專業服務','mid_prof'],
          ['交通接送','mid_car'],
          ['喘息服務','mid_resp'],
          ['無障礙及輔具','mid_access'],
          ['營養送餐','mid_meal']
        ].forEach(([label, field])=>{
          const lines = extractLines(document.getElementById(field)?.value || '');
          if(lines.length) categories.push({label, lines});
        });
      }else if(period==='long'){
        heading='(四) 長期目標（4–6 個月）';
        const longMap = parseLongGoalForPreview();
        ['照顧服務','專業服務','交通接送','喘息服務','無障礙及輔具','營養送餐'].forEach(label=>{
          const lines = longMap[label] || [];
          if(lines.length) categories.push({label, lines});
        });
      }

      if(!categories.length) return '';
      const lines=['======================================', heading, '======================================'];
      categories.forEach((cat, idx)=>{
        lines.push(`${idx+1}.${cat.label}`);
        cat.lines.forEach(text=>{ lines.push(` - ${text}`); });
      });
      return lines.join('\n');
    }

    function buildGoalPreview(){
      const box=document.getElementById('goalPreview');
      if(!box) return;
      const sections=['short','mid','long'].map(buildPreviewSection).filter(Boolean);
      if(sections.length){
        box.textContent = sections.join('\n\n');
        box.classList.remove('goal-preview-empty');
      }else{
        box.textContent = '（尚未選擇服務或填寫內容）';
        box.classList.add('goal-preview-empty');
      }
    }

    /* ===== 送出 ===== */
    function validateConditionalRequired(msg){
      const items=[...document.querySelectorAll('[data-required-when]')];
      for(const field of items){
        const rule=field.dataset.requiredWhen;
        const sourceId=field.dataset.requiredSource;
        let required=false;
        if(rule==='partial' && sourceId){
          const source=document.getElementById(sourceId);
          required = source && source.value === '部分協助';
        }
        if(required){
          if(!field.value || !String(field.value).trim()){
            field.classList.add('input-invalid');
            const label=field.dataset.requiredLabel || '';
            if(msg) msg.textContent = label ? `請填寫：${label}` : '請補齊必要欄位';
            field.focus();
            return false;
          }
        }
        if(!required){
          field.classList.remove('input-invalid');
        }
      }
      return true;
    }

    function applyAndSave(){
      const msg=document.getElementById('msg'); msg.textContent='';
      const unitCode=document.getElementById('unitCode').value;
      const caseManagerName=document.getElementById('caseManagerName').value;
      const caseNameInput=document.getElementById('caseName');
      const caseName=(caseNameInput?.value||'').trim();
      const consultName=(document.getElementById('consultName').value||'').trim();
      if(!caseName){
        if(caseNameInput){ caseNameInput.classList.add('input-invalid'); caseNameInput.focus(); }
        msg.textContent='請輸入：個案姓名';
        return;
      }
      if(caseNameInput){ caseNameInput.classList.remove('input-invalid'); }

      let primaryCaregiverRel = (document.getElementById('primaryRel').value||'').trim();
      let primaryCaregiverName= (document.getElementById('primaryName').value||'').trim();
      if(!primaryCaregiverRel){ primaryCaregiverRel='本人'; if(!primaryCaregiverName) primaryCaregiverName = caseName; }

      if(!validateConditionalRequired(msg)) return;
      if(!validateParticipantConflicts(msg)) return;
      const section1Validation = validateSection1();
      if(!section1Validation.ok){
        msg.textContent = '請先完成身心概況：' + section1Validation.messages.join('、');
        return;
      }

      if(!validateMismatchReasons()){
        msg.textContent='請完成與照專建議服務不一致原因說明。';
        document.getElementById('mismatch_diff_block')?.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }

      // 組裝各段
      buildSection1(section1Validation);
      buildS2(); buildS3(); buildSection4(); buildSection6(); buildLongGoal();

      buildApprovalPlanPreview();

      const form = {
        unitCode, caseManagerName, caseName, consultName,
        cmsLevel: getCmsLevel(),
        callDate: getDateBox('callDate'),
        isConsultVisit: document.getElementById('isConsultVisit').checked,
        visitDate: getDateBox('visitDate'),
        isDischarge: document.getElementById('isDischarge').checked,
        dischargeDate: getDateBox('dischargeDate'),
        // 三、偕同訪視者
        primaryCaregiverRel: primaryCaregiverRel,
        primaryCaregiverName: primaryCaregiverName,
        includePrimary: true,              // 固定預設輸出
        extras: collectExtras(),
        // 四、個案概況（已組句）
        section1: (document.getElementById('section1_out').value || '').trim().replace(/^（一）身心概況：/, ''),
        section2: (document.getElementById('section2_out').value || '').trim(),
        section3: (document.getElementById('section3_out').value || '').trim(),
        section4: (document.getElementById('section4_out').value || '').trim(),
        section5: (document.getElementById('section5').value || '').trim(),
        section6: (document.getElementById('section6_struct').value || '').trim(),
        // 五、照顧目標
        problemKeys: getSelectedProblems(),
        problemNote: (document.getElementById('problemNote').value || '').trim(),
        short_care: (document.getElementById('short_care').value || '').trim(),
        short_prof: (document.getElementById('short_prof').value || '').trim(),
        short_car : (document.getElementById('short_car').value  || '').trim(),
        short_resp: (document.getElementById('short_resp').value || '').trim(),
        short_access: (document.getElementById('short_access').value || '').trim(),
        short_meal: (document.getElementById('short_meal').value || '').trim(),
        mid_care: (document.getElementById('mid_care').value || '').trim(),
        mid_prof: (document.getElementById('mid_prof').value || '').trim(),
        mid_car : (document.getElementById('mid_car').value  || '').trim(),
        mid_resp: (document.getElementById('mid_resp').value || '').trim(),
        mid_access: (document.getElementById('mid_access').value || '').trim(),
        mid_meal: (document.getElementById('mid_meal').value || '').trim(),
        long_goal: (document.getElementById('long_goal').value || '').trim(),
        servicePlan: serializeServicePlan(),
        planMeta: Object.assign({}, planMetaState),
        planText: (document.getElementById('plan_text').value || '').trim()
      };

      google.script.run
        .withSuccessHandler(res=>{
          renderOutputMessage(res);
          if (res && res.file && res.file.url) openProducedFile(res.file.url);
        })
        .withFailureHandler(err=>{
          msg.innerHTML = '<span class="danger">錯誤：</span>' + (err && err.message ? err.message : err);
        })
        .applyAndSave(form);
    }

    /* ===== 初始化 ===== */
    function setActivePage(pageId){
      if(!pageId) return;
      const sections=document.querySelectorAll('.page-section');
      sections.forEach(section=>{
        const active = section.dataset.page === pageId ? '1' : '0';
        section.dataset.active = active;
        section.style.display = active === '1' ? '' : 'none';
      });
      document.querySelectorAll('.page-tabs button').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.page === pageId);
      });
    }

    function initPageTabs(){
      const tabs=[...document.querySelectorAll('.page-tabs button')];
      if(!tabs.length) return;
      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>setActivePage(btn.dataset.page));
      });
      const initial = tabs.find(btn=>btn.classList.contains('active')) || tabs[0];
      if(initial){
        setActivePage(initial.dataset.page);
      }
    }

    function initSection1State(){
      toggleVisionNotes(); toggleTransportOther(); toggleDhxOther(); toggleMedOther();
      toggleUrineOther('day'); toggleUrineOther('night');
      toggleLesionCombined(); toggleLesionLayerOther(); togglePainCombined(); toggleLesionHospital();
      renderHearingDetails();
      applyLocationStateToUI();
      updateLocationVisibility();
      toggleAdlHow('s1_transfer');
      toggleAdlHow('s1_adl_eating'); toggleAdlHow('s1_adl_groom'); toggleAdlHow('s1_adl_bathing');
      toggleAdlHow('s1_adl_dressing'); toggleAdlHow('s1_post_toilet'); toggleAdlHow('s1_meal_prep');
      toggleAdlHow('s1_housework'); toggleAdlHow('s1_finance');
      toggleShoppingHow(); toggleDishwashHow(); toggleSleepReason();
      toggleSwallow(); toggleFallDetail(); toggleSittingSupports(); togglePhoneNotes();
      updateExcretionAidEffects(); toggleGlassesAdherence(); toggleHearingDeviceAdherence();
      syncNoDiscomfort('s1_lesion_sx_box'); // 初始化互斥狀態
      updateLesionAreaDisplay();

      const s1block = document.getElementById('section1_block');
      if(s1block){
        s1block.addEventListener('input', buildSection1);
        s1block.addEventListener('change', buildSection1);
      }

      initActionEntries();

      buildSection1(); // 初次預覽一次
    }

    window.addEventListener('load', ()=>{
      initPageTabs();
      initDateInputs();
      setDateBox('callDate', new Date());
      setDateBox('visitDate', new Date());
      loadManagers();
      loadConsultants();
      initCmsLevelButtons();
      loadServiceCatalog();

      // S1
      renderS1(); initSection1State();

      const extrasBox=document.getElementById('extras');
      if(extrasBox){
        extrasBox.addEventListener('input', updateParticipantConflictHint);
        extrasBox.addEventListener('change', updateParticipantConflictHint);
      }
      updateParticipantConflictHint();

      // 偕同訪視者：初次建立一筆空白行以利輸入（選配）
      // addExtraRow();

      // 其它原有初始化
      renderS2(); syncDisab();
      renderS3(); toggleOtherType(); toggleRentFields();
      const goalFields=['short_care','short_prof','short_car','short_resp','short_access','short_meal','mid_care','mid_prof','mid_car','mid_resp','mid_access','mid_meal'];
      goalFields.forEach(id=>{
        bindAutoGoalField(id);
        const el=document.getElementById(id);
        if(el){ el.addEventListener('input', ()=>{ buildLongGoal(); }); }
      });
      bindAutoGoalField('long_goal');
      document.getElementById('long_goal')?.addEventListener('input', buildGoalPreview);
      renderFormal();
      renderHomeCareServices();
      renderDayCareServices();
      renderProfessionalServices();
      renderTransportServices();
      renderRespiteServices();
      renderMealServices();
      initPlanMetaFields();
      initMismatchReasonControls();
      planMetaState.referralExtra = document.getElementById('plan_referral_extra')?.value || '';
      planMetaState.stationInfo = document.getElementById('plan_station_info')?.value || '';
      planMetaState.stationWillingness = document.getElementById('plan_station_willingness')?.value || '';
      planMetaState.emergencyNote = document.getElementById('plan_emergency_note')?.value || '';
      syncPlanStateWithSelections();
      buildApprovalPlanPreview();
      renderProblems(); limitProblems();
      updateCareServicePhrases();
      updateProfessionalServicePhrases();
      updateTransportServicePhrases();
      updateRespiteServicePhrases();
      updateMealServicePhrases();
      // 非正式資源：名稱→頻率 顯示/隱藏
      bindInfNameToFreq('pt');
      bindInfNameToFreq('nb');
      bindInfNameToFreq('rg');
      bindInfNameToFreq('fw');

      bindQuickReasons();

      // 主照者關係/姓名：自動連動到(四)唯讀展示
      syncSocialPrimary();
      document.getElementById('primaryRel')?.addEventListener('change', syncSocialPrimary);
      document.getElementById('primaryName')?.addEventListener('input',  syncSocialPrimary);
      const caseNameInput=document.getElementById('caseName');
      if(caseNameInput){
        caseNameInput.addEventListener('input', ()=>{ caseNameInput.classList.remove('input-invalid'); });
        caseNameInput.addEventListener('input', syncSocialPrimary);
        caseNameInput.addEventListener('input', updateConsultVisitText);
        caseNameInput.addEventListener('input', buildApprovalPlanPreview);
      }
      const consultSelect=document.getElementById('consultName');
      if(consultSelect){
        consultSelect.addEventListener('change', updateConsultVisitText);
      }
      document.getElementById('s1_gender')?.addEventListener('change', buildApprovalPlanPreview);
      document.getElementById('caseManagerName')?.addEventListener('change', buildApprovalPlanPreview);

      toggleCallDateByConsultVisit();
      updateConsultVisitText();
      buildApprovalPlanPreview();

    });
  </script>
</body>
</html>
