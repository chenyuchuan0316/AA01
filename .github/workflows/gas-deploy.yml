name: Deploy GAS Web App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install clasp
        run: npm i -g @google/clasp

      # ① 從 Base64 Secret 還原 ~/.clasprc.json，並驗證是有效 JSON
      - name: Restore ~/.clasprc.json from Base64
        run: |
          echo "${{ secrets.CLASPRC_JSON_B64 }}" | base64 -d > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          node -e "JSON.parse(require('fs').readFileSync(process.env.HOME+'/.clasprc.json','utf8')); console.log('✔ ~/.clasprc.json OK')"
          echo "Size of ~/.clasprc.json: $(wc -c < ~/.clasprc.json) bytes"

      # ② 產生乾淨的 .clasp.json（從 repo 變數 GAS_SCRIPT_ID）
      - name: Create clean .clasp.json (no BOM)
        env:
          GAS_SCRIPT_ID: ${{ vars.GAS_SCRIPT_ID }}
        run: |
          node -e "const fs=require('fs'); const id=process.env.GAS_SCRIPT_ID; if(!id){console.error('❌ Missing repo variable GAS_SCRIPT_ID'); process.exit(1);} fs.writeFileSync('.clasp.json', JSON.stringify({scriptId:id}));"
          # 除錯：檢查第一行是否為 {，也印出前 32 bytes（十六進位）
          head -n1 .clasp.json | cat -v
          hexdump -C -n 32 .clasp.json || true
          node -e "JSON.parse(require('fs').readFileSync('.clasp.json','utf8')); console.log('✔ .clasp.json OK')"

      # ③ 建議：忽略雜檔，避免把 node_modules 等推上 GAS
      - name: Ensure .claspignore
        run: |
          cat > .claspignore <<'EOF'
          node_modules/**
          .github/**
          .git/**
          dist/**
          build/**
          coverage/**
          .vscode/**
          *.map
          README*
          LICENSE*
          *.md
          scripts/**
          test/**
          package.json
          package-lock.json
          pnpm-lock.yaml
          yarn.lock
          EOF

      # ④ push 原始碼到 GAS
      - name: Push code to GAS
        run: clasp push --force

      # ⑤ 建版並更新既有部署（網址不變）
      - name: Create version & update existing deployment
        env:
          GAS_DEPLOY_ID: ${{ vars.GAS_DEPLOY_ID }}
        run: |
          DESC="ci build $GITHUB_SHA"
          OUT="$(clasp version "$DESC")"
          echo "$OUT"
          VER="$(echo "$OUT" | sed -n 's/.*version \([0-9]\+\).*/\1/p')"
          if [ -z "$VER" ]; then echo "Cannot parse version"; exit 1; fi
          clasp deploy -i "$GAS_DEPLOY_ID" -V "$VER" -d "$DESC"

      # ⑥ 簡單 smoke test：直接呼叫 Web App URL
      - name: Test deployed Web App
        run: |
          echo "Testing Web App..."
          curl -L --fail "${{ vars.GAS_WEBAPP_URL }}"
