name: Deploy GAS Web App

on:
  push:
    branches: [ "main" ]          # 合併到 main 自動部署
  workflow_dispatch: {}            # 也可在 Actions 手動觸發

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install clasp
        run: npm i -g @google/clasp

      # 用 Secret 還原登入憑證到 ~/
      - name: Restore ~/.clasprc.json
        run: |
          printf '%s' "${{ secrets.CLASPRC_JSON }}" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json

      # 推送專案檔（會讀取 repo 根目錄的 .clasp.json）
      - name: Push code to GAS
        run: clasp push --force

      # 建新版本並更新到 "固定的部署 ID"
      - name: Create version & update existing deployment
        env:
          GAS_DEPLOY_ID: ${{ vars.GAS_DEPLOY_ID }}
        run: |
          DESC="ci build $GITHUB_SHA"
          OUT="$(clasp version "$DESC")"
          echo "$OUT"
          VER="$(echo "$OUT" | sed -n 's/.*version \([0-9]\+\).*/\1/p')"
          if [ -z "$VER" ]; then echo "Cannot parse version"; exit 1; fi
          clasp deploy -i "$GAS_DEPLOY_ID" -V "$VER" -d "$DESC"

      # 直接呼叫 Web App URL 做 smoke test
      - name: Test deployed Web App
        run: |
          echo "Testing Web App..."
          curl -L --fail "${{ vars.GAS_WEBAPP_URL }}"
