name: Push & Deploy GAS (fixed deployment)

on:
  push:
    branches: [ "main" ]

jobs:
  gas:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Run unit tests
        if: hashFiles('package.json') != ''
        run: npm test

      - name: Install clasp
        run: npm i -g @google/clasp

      - name: Debug secret shape (length only)
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          node -e "const s=process.env.CLASPRC_JSON||''; console.log('len=',s.length,'mod4=',(s.replace(/\s+/g,'').length%4));"

      - name: Write ~/.clasprc.json (decode via Node) + validate
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then echo "CLASPRC_JSON is empty"; exit 1; fi
          node -e "const fs=require('fs');const p=process.env.HOME+'/.clasprc.json';let s=process.env.CLASPRC_JSON||'';s=s.replace(/\s+/g,'');fs.writeFileSync(p, Buffer.from(s,'base64'));"
          test -s "$HOME/.clasprc.json"
          node -e "JSON.parse(require('fs').readFileSync(process.env.HOME+'/.clasprc.json','utf8'))"

      - name: Ensure .clasp.json exists (safe)
        env:
          GAS_SCRIPT_ID: ${{ secrets.GAS_SCRIPT_ID }}
        run: |
          if [ -f ".clasp.json" ]; then
            echo "Found existing .clasp.json:"
            cat .clasp.json
            exit 0
          fi
          if [ -z "$GAS_SCRIPT_ID" ]; then
            echo ".clasp.json missing and GAS_SCRIPT_ID not set"; exit 1
          fi
          # 用 printf 一行一行寫，避免 heredoc 的縮排/行首問題
          printf '%s\n' '{' \
            "  \"scriptId\": \"$GAS_SCRIPT_ID\"," \
            '  "rootDir": "."' \
            '}' > .clasp.json
          cat .clasp.json


      - name: Push to Apps Script
        run: clasp push -f

      - name: Deploy with fixed Deployment ID
        env:
          DEPLOY_ID: ${{ secrets.GAS_DEPLOYMENT_ID }}
        run: |
          if [ -n "$DEPLOY_ID" ]; then
            clasp deploy --deploymentId "$DEPLOY_ID" -d "CI deploy ${GITHUB_SHA}"
          else
            clasp deploy --deploymentId "AKfycbyEPm9QNzdv5JLKYCIxX1kGOdkxOttYWsk-cruaKzH9Cc7oY-PuQcTeNCPRMAN5YE37" -d "CI deploy ${GITHUB_SHA}"
          fi
