name: Push & Deploy GAS (fixed deployment)

on:
  push:
    branches: [ "main" ]
  # 手動觸發，避免 Re-run 舊 run 用到舊 YAML
  workflow_dispatch:

concurrency:
  group: gas-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gas:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies (lockfile)
        if: ${{ hashFiles('package-lock.json') != '' }}
        run: npm ci

      - name: Install dependencies (no lockfile)
        if: ${{ hashFiles('package-lock.json') == '' && hashFiles('package.json') != '' }}
        run: npm install

      - name: Run unit tests (if any)
        if: ${{ hashFiles('package.json') != '' }}
        run: npm test --if-present

      - name: Install clasp v2
        run: npm i -g @google/clasp@2

      - name: Write ~/.clasprc.json (decode/normalize/validate)
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          set -euo pipefail
          if [ -z "${CLASPRC_JSON:-}" ]; then
            echo "::error::Missing secret CLASPRC_JSON"; exit 1
          fi
          node -e "const fs=require('fs');
            const p=process.env.HOME+'/.clasprc.json';
            let s=process.env.CLASPRC_JSON||'';
            try { const j=JSON.parse(s); fs.writeFileSync(p, JSON.stringify(j,null,2)); }
            catch(e){ s=s.replace(/\s+/g,''); fs.writeFileSync(p, Buffer.from(s,'base64')); }"
          node -e "const fs=require('fs');
            const p=process.env.HOME+'/.clasprc.json';
            const j=JSON.parse(fs.readFileSync(p,'utf8'));
            if (!j.token && j.tokens && j.tokens.default) { j.token = j.tokens.default; }
            fs.writeFileSync(p, JSON.stringify(j, null, 2));"
          test -s "$HOME/.clasprc.json"
          cp "$HOME/.clasprc.json" "$GITHUB_WORKSPACE/.clasprc.json"

      - name: Ensure .clasp.json exists (do not print it)
        run: |
          if [ ! -f ".clasp.json" ]; then
            echo "::error::.clasp.json missing. Commit one with your scriptId."; exit 1
          fi
          node -e "const j=require('./.clasp.json'); if(!j.scriptId){process.exit(2)}"

      # ---- 防呆 1：部署前快照 + 確認欲保護的部署在清單中（若有設定） ----
      - name: Snapshot deployments (before)
        run: |
          clasp list-deployments --json > before.json || echo "[]" > before.json

      - name: Ensure preserved deployments exist (before)  # 不存在也先放行，只警告
        env:
          PRESERVE_IDS: ${{ vars.PRESERVE_DEPLOYMENT_IDS }}
        run: |
          node -e "const fs=require('fs');
          const ids=(process.env.PRESERVE_IDS||'').split(/[,\s]+/).filter(Boolean);
          if(!ids.length){ console.log('No PRESERVE_DEPLOYMENT_IDS set; skip'); process.exit(0); }
          const b=JSON.parse(fs.readFileSync('before.json','utf8'));
          const has=id=>Array.isArray(b)&&b.some(x=>(x.deploymentId||x.deployment_id)===id);
          let miss=ids.filter(id=>!has(id));
          if(miss.length){ console.warn('WARN: preserved IDs not found BEFORE deploy:', miss.join(',')); } else { console.log('All preserved IDs exist BEFORE deploy'); }"

      # ---- 正式 push 原始碼 ----
      - name: Push to Apps Script
        run: clasp push -f

      # ---- 僅覆蓋：固定 Deployment ID ----
      - name: Deploy with fixed Deployment ID (v2)
        env:
          DEPLOY_ID: ${{ secrets.GAS_DEPLOYMENT_ID }}
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_ID:-}" ]; then
            echo "::error::GAS_DEPLOYMENT_ID not set"; exit 1
          fi
          # 只更新你指定的這筆，不新建
          clasp deploy --deploymentId "$DEPLOY_ID" -d "CI ${GITHUB_SHA}"

      # ---- 防呆 2：部署後檢查沒有多一筆、而且保護的部署仍存在 ----
      - name: Verify no new deployment was created
        env:
          DEPLOY_ID: ${{ secrets.GAS_DEPLOYMENT_ID }}
        run: |
          set -e
          clasp list-deployments --json > after.json || echo "[]" > after.json
          node -e "const fs=require('fs');
          const b=JSON.parse(fs.readFileSync('before.json','utf8'));
          const a=JSON.parse(fs.readFileSync('after.json','utf8'));
          const id=process.env.DEPLOY_ID;
          const cntB=Array.isArray(b)?b.length:0;
          const cntA=Array.isArray(a)?a.length:0;
          const has=a.some(x=>(x.deploymentId||x.deployment_id)===id);
          console.log('before=',cntB,'after=',cntA,'hasTarget=',has);
          if (!has) { console.error('Target deployment ID not found AFTER deploy'); process.exit(1); }
          if (cntA > cntB) { console.error('New deployment appears to have been created!'); process.exit(1); }"

      - name: Verify preserved deployments still exist (after)
        env:
          PRESERVE_IDS: ${{ vars.PRESERVE_DEPLOYMENT_IDS }}
        run: |
          node -e "const fs=require('fs');
          const ids=(process.env.PRESERVE_IDS||'').split(/[,\s]+/).filter(Boolean);
          if(!ids.length){ console.log('No PRESERVE_DEPLOYMENT_IDS set; skip'); process.exit(0); }
          const a=JSON.parse(fs.readFileSync('after.json','utf8'));
          const has=id=>Array.isArray(a)&&a.some(x=>(x.deploymentId||x.deployment_id)===id);
          let miss=ids.filter(id=>!has(id));
          if(miss.length){ console.error('Preserved deployments disappeared AFTER deploy:', miss.join(',')); process.exit(1); }
          console.log('All preserved IDs exist AFTER deploy');"
