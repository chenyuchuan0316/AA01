name: Push & Deploy GAS (fixed deployment)

on:
  push:
    branches: [ "main" ]

jobs:
  gas:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Run unit tests
        if: hashFiles('package.json') != ''
        run: npm test

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Write ~/.clasprc.json (from base64) + validate
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "$CLASPRC_JSON" ]; then
            echo "CLASPRC_JSON is empty"; exit 1
          fi
          printf '%s' "$CLASPRC_JSON" | base64 -d > "$HOME/.clasprc.json"
          test -s "$HOME/.clasprc.json"
          node -e "const fs=require('fs'); JSON.parse(fs.readFileSync(process.env.HOME+'/.clasprc.json','utf8'));"

      - name: Ensure .clasp.json exists
        env:
          GAS_SCRIPT_ID: ${{ secrets.GAS_SCRIPT_ID }}
        run: |
          if [ ! -f ".clasp.json" ]; then
            if [ -z "$GAS_SCRIPT_ID" ]; then
              echo ".clasp.json missing and GAS_SCRIPT_ID not set"; exit 1
            fi
            cat > .clasp.json <<EOF
            {
              "scriptId": "$GAS_SCRIPT_ID",
              "rootDir": "."
            }
            EOF
          fi
          cat .clasp.json

      - name: Push to Apps Script
        run: clasp push -f

      - name: Deploy with fixed Deployment ID
        env:
          DEPLOY_ID: ${{ secrets.GAS_DEPLOYMENT_ID }}
        run: |
          # 如果 Secret 裡有 DEPLOY_ID，優先用；若是空值就 fallback 用你給的 ID
          if [ -n "$DEPLOY_ID" ]; then
            clasp deploy --deploymentId "$DEPLOY_ID" -d "CI deploy $GITHUB_SHA"
          else
            clasp deploy --deploymentId "AKfycbyEPm9QNzdv5JLKYCIxX1kGOdkxOttYWsk-cruaKzH9Cc7oY-PuQcTeNCPRMAN5YE37" -d "CI deploy $GITHUB_SHA"
          fi
