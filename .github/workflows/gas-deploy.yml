name: Deploy GAS Web App

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Google clasp
        run: npm install -g @google/clasp

      - name: Authenticate clasp via .clasprc.json
        # 將 Base64 字串還原為憑證檔案
        run: |
          echo "${{ secrets.CLASPRC_JSON_B64 }}" | base64 -d > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          echo "Restored ~/.clasprc.json"

      - name: 檢查部署 ID 與 URL 設置 (Preflight)
        env:
          ID: ${{ vars.GAS_DEPLOY_ID }}
          URL: ${{ vars.GAS_WEBAPP_URL }}
        run: |
          echo "GAS_DEPLOY_ID=$ID"
          echo "GAS_WEBAPP_URL=$URL"
          # 確認 Web App URL 中包含部署 ID，避免變數設錯
          if echo "$URL" | grep -Fq "$ID"; then
            echo "✅ 部署 ID 與 Web App URL 匹配"
          else
            echo "::error ::GAS_DEPLOY_ID 與 GAS_WEBAPP_URL 不匹配，請確認填入正確的 Web App 部署 ID。"
            exit 1
          fi

      - name: 建立 .clasp.json 配置
        env:
          GAS_SCRIPT_ID: ${{ vars.GAS_SCRIPT_ID }}
        run: |
          # 用 Node.js 建立 .clasp.json，寫入 Apps Script 專案 scriptId
          node <<'EOF'
          const fs = require('fs');
          const id = process.env.GAS_SCRIPT_ID?.trim();
          if (!id) {
            console.error('❌ GAS_SCRIPT_ID 未設定或為空');
            process.exit(1);
          }
          fs.writeFileSync('.clasp.json', JSON.stringify({ scriptId: id }));
          console.log('✅ 已寫入 .clasp.json (scriptId)');
          EOF

      - name: 建立 .claspignore 檔案
        run: |
          cat > .claspignore <<'EOF'
          node_modules/**
          .github/**
          .git/**
          EOF
          echo '✅ 已建立 .claspignore，忽略無關檔案'

      - name: Push code to GAS (clasp push)
        run: clasp push --force

      - name: Create new version
        run: |
          # 建立新版本，取得版本號
          VERSION_DESC="CI auto version $GITHUB_SHA"
          OUTPUT="$(clasp version "$VERSION_DESC")"
          echo "$OUTPUT"
          # 提取版本號數字
          VER=$(echo "$OUTPUT" | sed -n 's/.*version \([0-9]\+\).*/\1/p')
          if [ -z "$VER" ]; then
            echo "::error ::無法解析 Apps Script 版本號"
            exit 1
          fi
          echo "✅ 建立版本成功，version = $VER"
          echo "VERSION_NUMBER=$VER" >> $GITHUB_ENV

      - name: Update Web App Deployment
        env:
          GAS_DEPLOY_ID: ${{ vars.GAS_DEPLOY_ID }}
          VER: ${{ env.VERSION_NUMBER }}
        run: |
          # 使用現有 deployment ID 部署新版本，保持 URL 不變
          DEPLOY_DESC="CI deploy $GITHUB_SHA"
          clasp deploy --deploymentId "$GAS_DEPLOY_ID" --versionNumber "$VER" --description "$DEPLOY_DESC"
          echo "✅ 已更新部署（ID=$GAS_DEPLOY_ID，版本=$VER）"

      - name: 匿名請求 Web App (Probe)
        id: probe
        env:
          WEBAPP_URL: ${{ vars.GAS_WEBAPP_URL }}
        run: |
          # 嘗試匿名存取 Web App，檢查是否回應 200 OK
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBAPP_URL")
          echo "HTTP Status=$STATUS"
          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
            echo "PROBE_OK=true" >> $GITHUB_ENV
            echo "匿名存取 Web App 成功 (HTTP $STATUS)"
          else
            echo "PROBE_OK=false" >> $GITHUB_ENV
            echo "匿名存取 Web App 未成功，可能需要授權或權限不符 (HTTP $STATUS)"
          fi

      - name: OAuth 驗證後存取 Web App
        if: env.PROBE_OK == 'false'
        env:
          WEBAPP_URL: ${{ vars.GAS_WEBAPP_URL }}
          GAS_OAUTH_CLIENT_ID: ${{ secrets.GAS_OAUTH_CLIENT_ID }}
          GAS_OAUTH_CLIENT_SECRET: ${{ secrets.GAS_OAUTH_CLIENT_SECRET }}
        run: |
          # 使用 OAuth Refresh Token 獲取 Access Token 並授權請求 Web App
          node <<'EOF'
          const fs = require('fs');
          const https = require('https');
          const cfg = JSON.parse(fs.readFileSync(process.env.HOME + '/.clasprc.json', 'utf8'));
          const refreshToken = cfg.token?.refresh_token || cfg.token?.refreshToken;
          if (!refreshToken) {
            console.error('❌ 找不到 refresh_token，請確認 CLASPRC_JSON_B64');
            process.exit(1);
          }
          const clientId = process.env.GAS_OAUTH_CLIENT_ID;
          const clientSecret = process.env.GAS_OAUTH_CLIENT_SECRET;
          const params = new URLSearchParams({
            client_id: clientId,
            client_secret: clientSecret,
            refresh_token: refreshToken,
            grant_type: 'refresh_token'
          });
          const options = {
            hostname: 'oauth2.googleapis.com',
            path: '/token',
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
          };
          const req = https.request(options, res => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              const resObj = JSON.parse(data);
              if (!resObj.access_token) {
                console.error('❌ 無法取得 access_token', data);
                process.exit(1);
              }
              fs.writeFileSync('ACCESS_TOKEN', resObj.access_token);
            });
          });
          req.on('error', err => { console.error('❌ OAuth 連線錯誤', err); process.exit(1); });
          req.write(params.toString());
          req.end();
          EOF

          ACCESS_TOKEN=$(cat ACCESS_TOKEN)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $ACCESS_TOKEN" "$WEBAPP_URL")
          echo "Authenticated HTTP Status=$STATUS"
          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
            echo "✅ OAuth 授權後存取 Web App 成功 (HTTP $STATUS)"
          else
            echo "::error ::即使使用 OAuth，Web App 回應碼仍非 2XX (HTTP $STATUS)。"
            exit 1
          fi
