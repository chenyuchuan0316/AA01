name: Deploy GAS via OAuth

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm ci

      # （可選）列印環境變數長度以安全確認 Secrets 是否注入（GitHub 會遮罩值）
      - name: Sanity check secrets (safe)
        run: |
          echo "SCRIPT_ID len = ${#SCRIPT_ID}"
          echo "CLIENT_ID len = ${#GAS_CLIENT_ID}"
          echo "CLIENT_SECRET len = ${#GAS_CLIENT_SECRET}"
          echo "REFRESH_TOKEN len = ${#GAS_OAUTH_REFRESH_TOKEN}"
        env:
          SCRIPT_ID: ${{ secrets.SCRIPT_ID }}
          GAS_CLIENT_ID: ${{ secrets.GAS_CLIENT_ID }}
          GAS_CLIENT_SECRET: ${{ secrets.GAS_CLIENT_SECRET }}
          GAS_OAUTH_REFRESH_TOKEN: ${{ secrets.GAS_OAUTH_REFRESH_TOKEN }}

      - name: Deploy by Apps Script API (OAuth)
        run: node gas-deploy.mjs
        env:
          SCRIPT_ID: ${{ secrets.SCRIPT_ID }}
          GAS_CLIENT_ID: ${{ secrets.GAS_CLIENT_ID }}
          GAS_CLIENT_SECRET: ${{ secrets.GAS_CLIENT_SECRET }}
          GAS_OAUTH_REFRESH_TOKEN: ${{ secrets.GAS_OAUTH_REFRESH_TOKEN }}
