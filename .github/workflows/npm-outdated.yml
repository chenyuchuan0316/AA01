name: npm outdated report

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash

on:
  schedule:
    - cron: '0 1 * * 1'   # 每週一 01:00 UTC
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run local @ui E2E (no secrets needed)'
        type: boolean
        default: false
        required: false

jobs:
  outdated:
    name: Generate outdated inventory
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}:${{ github.job }}:${{ github.ref }}
      cancel-in-progress: false
    env:
      RUN_LOCAL_E2E: ${{ format('{0}', github.event_name == 'workflow_dispatch' && inputs.run_e2e) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          HUSKY: '0'

      # 僅手動且勾選 run_e2e 時，安裝瀏覽器並跑本地 @ui（不需要 secrets）
      - name: Install Playwright browsers
        if: ${{ env.RUN_LOCAL_E2E == 'true' }}
        run: npx playwright install --with-deps

      - name: Run local UI E2E (@ui)
        if: ${{ env.RUN_LOCAL_E2E == 'true' }}
        run: npm run e2e:ui

      - name: Upload Playwright report
        if: ${{ always() && env.RUN_LOCAL_E2E == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore

      - name: Generate outdated.json
        run: |
          npm outdated --json > outdated.json || true

      - name: Publish summary
        run: |
          node --input-type=module <<'NODE'
          import fs from 'node:fs';
          const out = process.env.GITHUB_STEP_SUMMARY;
          const has = fs.existsSync('outdated.json');
          if (!has) { await fs.promises.appendFile(out, 'No outdated data produced.\n'); process.exit(0); }
          const raw = fs.readFileSync('outdated.json','utf8').trim();
          const data = raw ? JSON.parse(raw) : {};
          const rows = Object.entries(data).sort((a,b)=>a[0].localeCompare(b[0]));
          let md = '# npm outdated report\n\n';
          if (!rows.length) md += '✅ All dependencies are up-to-date.\n';
          else {
            md += '| Package | Current | Wanted | Latest |\n| --- | --- | --- | --- |\n';
            for (const [name, info] of rows)
              md += `| ${name} | ${info.current ?? '-'} | ${info.wanted ?? '-'} | ${info.latest ?? '-'} |\n`;
          }
          await fs.promises.appendFile(out, md);
          NODE

      - name: Upload outdated.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-outdated-report
          path: outdated.json
          if-no-files-found: warn
