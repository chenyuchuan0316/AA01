name: npm outdated report

env:
  CI: true
  HUSKY: 0

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash {0}

on:
  schedule:
    - cron: '0 1 * * 1'   # 每週一 01:00 UTC
  workflow_dispatch:

jobs:
  outdated:
    name: Generate outdated inventory
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ format('{0}-{1}', github.workflow, github.ref_name || github.run_id) }}
      cancel-in-progress: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          HUSKY: '0'

      - name: Generate outdated.json
        run: |
          set -euo pipefail
          npm outdated --json > outdated.json || true

      - name: Publish summary
        run: |
          set -euo pipefail
          node --input-type=module <<'NODE'
          import fs from 'node:fs';
          const out = process.env.GITHUB_STEP_SUMMARY;
          const has = fs.existsSync('outdated.json');
          if (!has) { await fs.promises.appendFile(out, 'No outdated data produced.\n'); process.exit(0); }
          const raw = fs.readFileSync('outdated.json','utf8').trim();
          const data = raw ? JSON.parse(raw) : {};
          const rows = Object.entries(data).sort((a,b)=>a[0].localeCompare(b[0]));
          let md = '# npm outdated report\n\n';
          if (!rows.length) md += '✅ All dependencies are up-to-date.\n';
          else {
            md += '| Package | Current | Wanted | Latest |\n| --- | --- | --- | --- |\n';
            for (const [name, info] of rows)
              md += `| ${name} | ${info.current ?? '-'} | ${info.wanted ?? '-'} | ${info.latest ?? '-'} |\n`;
          }
          await fs.promises.appendFile(out, md);
          NODE

      - name: Upload outdated.json artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-outdated-report
          path: outdated.json
          if-no-files-found: warn
