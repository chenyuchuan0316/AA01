permissions:
  contents: write
  pull-requests: write

name: npm auto upgrade

env:
  CI: true
  HUSKY: 0

defaults:
  run:
    shell: bash {0}

on:
  schedule:
    - cron: '30 1 * * 1'
  workflow_dispatch:
    inputs:
      strategy:
        description: Select upgrade strategy
        type: choice
        default: safe
        options:
          - safe
          - major

jobs:
  upgrade:
    name: Apply ${{ github.event.inputs.strategy || 'safe' }} updates
    runs-on: ubuntu-latest
    env:
      STRATEGY: ${{ github.event.inputs.strategy || 'safe' }}
      IS_MANUAL: ${{ github.event_name == 'workflow_dispatch' }}
      PR_TOKEN: ${{ secrets.NPM_UPGRADE_TOKEN != '' && secrets.NPM_UPGRADE_TOKEN || github.token }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.PR_TOKEN }}
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Install Playwright browsers
        if: ${{ env.IS_MANUAL == 'true' }}
        run: npx playwright install --with-deps

      - name: Capture outdated (before)
        run: npm outdated --json > before.json || true

      - name: Run safe updates
        if: ${{ env.STRATEGY == 'safe' }}
        run: npm update --no-audit --no-fund

      - name: Run major updates with npm-check-updates
        if: ${{ env.STRATEGY == 'major' }}
        run: |
          set -euo pipefail
          npx npm-check-updates@latest --target=latest -u
          npm install --no-audit --no-fund

      - name: Re-install dependencies to sync lockfile
        if: ${{ env.STRATEGY == 'safe' }}
        run: npm install --no-audit --no-fund

      - name: Capture outdated (after)
        run: npm outdated --json > after.json || true

      - name: Derive branch metadata
        id: metadata
        run: |
          set -euo pipefail
          today="$(date -u +%Y%m%d)"
          strategy="${STRATEGY:-safe}"
          case "$strategy" in
            safe)
              branch="chore/npm-upgrade/${today}-safe"
              ;;
            major)
              branch="chore/npm-upgrade/${today}-major"
              ;;
            *)
              branch="chore/npm-upgrade/${today}-${strategy}"
              ;;
          esac
          title="chore(deps): npm ${strategy} upgrade"
          echo "branch=${branch}" >> "$GITHUB_OUTPUT"
          echo "title=${title}" >> "$GITHUB_OUTPUT"
          echo "commit_message=${title}" >> "$GITHUB_OUTPUT"

      - name: Run unit tests
        if: ${{ env.IS_MANUAL == 'true' }}
        run: npm test -- --runInBand

      - name: Run E2E smoke tests (if configured)
        if: ${{ env.IS_MANUAL == 'true' }}
        run: npm run e2e
        env:
          TEST_DEPLOYMENT_ID: ${{ secrets.TEST_DEPLOYMENT_ID }}

      - name: Build upgrade summary
        run: |
          set -euo pipefail
          node --input-type=module <<'NODE'
          import fs from 'node:fs';
          const load = path => {
            if (!fs.existsSync(path)) return {};
            const raw = fs.readFileSync(path, 'utf8').trim();
            return raw ? JSON.parse(raw) : {};
          };
          const toTable = data => {
            const entries = Object.entries(data).sort((a, b) => a[0].localeCompare(b[0]));
            if (!entries.length) return 'âœ… No outdated packages.\n';
            let table = '| Package | Current | Wanted | Latest |\n| --- | --- | --- | --- |\n';
            for (const [name, info] of entries) {
              table += `| ${name} | ${info.current ?? '-'} | ${info.wanted ?? '-'} | ${info.latest ?? '-'} |\n`;
            }
            return table;
          };
          const before = load('before.json');
          const after = load('after.json');
          const strategy = process.env.STRATEGY ?? 'safe';
          let md = `# npm ${strategy} upgrade\n\n`;
          md += '## Before\n';
          md += `${toTable(before)}\n`;
          md += '## After\n';
          md += `${toTable(after)}\n`;
          fs.writeFileSync('upgrade-summary.md', md);
          const summaryPath = process.env.GITHUB_STEP_SUMMARY;
          if (summaryPath) {
            fs.writeFileSync(summaryPath, md);
          }
          NODE

      - name: Validate PR token permissions
        run: |
          set -euo pipefail
          if [ "${PR_TOKEN}" = "" ]; then
            echo "::error::PR token is not configured. Set the NPM_UPGRADE_TOKEN secret with a token that has repo scope."
            exit 1
          fi

      - name: Upload outdated comparison
        uses: actions/upload-artifact@v4
        with:
          name: npm-upgrade-${{ env.STRATEGY }}
          path: |
            before.json
            after.json
            upgrade-summary.md
          if-no-files-found: warn

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: ${{ steps.metadata.outputs.commit_message }}
          branch: ${{ steps.metadata.outputs.branch }}
          title: ${{ steps.metadata.outputs.title }}
          body-path: upgrade-summary.md
          labels: dependencies, automated-pr
