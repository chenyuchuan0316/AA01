
======================================
(一) 系統簡介
======================================
1.服務定位
- AA01 計畫助手是一套建置於 Google Apps Script 的附加元件，協助長照個管師在公版 Google 文件中透過側欄快速產製個案計畫書。
- 系統提供一致的輸入介面與自動化文字組織流程，讓前端表單與後端文件寫入保持同步並降低人工維護成本。

2.整體流程
- 使用者在公版文件開啟「計畫助手」，由 `showSidebar()` 載入 `Sidebar.html` 並初始化各區塊與預設值。
- 側欄收集完整表單資料，組合照顧目標與其他敘述後以 `google.script.run.applyAndSave(form)` 傳送至 Apps Script 後端。
- 後端依照命名規則複製模板、呼叫 `H1_*` 模組寫入段落，最終回傳新文件連結與狀態訊息。

3.輸出成果
- 新文件名稱遵循「單位代碼_家訪日期_個案姓名_V{版號}」格式，確保版本遞增與檔案可追蹤。
- 每個段落都以標題、分隔線與條列格式呈現，特別是照顧目標會根據短、中、長期設定自動產出完整描述。

======================================
(二) 執行環境與初始化
======================================
1.必要權限
- 專案必須在 Google Workspace 帳號下執行，並授予 `DocumentApp`、`DriveApp`、`SpreadsheetApp` 權限以便讀寫文件、複製模板與存取人員名單。
- 首次執行 `showSidebar` 或 `applyAndSave` 時，系統會提示授權流程，請以具有相關資源存取權的帳號完成授權。

2.常數設定
- `Constants.gs` 集中管理所有外部資源，部署前需依環境更新以下 ID 與名稱：
- `TEMPLATE_DOC_ID`：設定計畫書公版文件 ID，使系統能建立副本並作為寫入基礎。
- `OUTPUT_FOLDER_ID`：指定輸出目錄 ID，確保新檔案按組織政策存放於正確資料夾。
- `MANAGERS_SHEET_ID` 與 `MANAGERS_SHEET_NAME`：提供個管師名單來源，欄位需包含員工編號與姓名供下拉選單使用。
- `CONSULTANTS_BOOK_ID` 與 `CONSULTANTS_BOOK_NAME`：提供照專名單與狀態欄位，側欄會依單位代碼自動過濾可選擇人員。

3.部署與初始化步驟
- 在目標 Google 文件中使用 `Extensions → Apps Script` 建立專案，將儲存庫內所有 `.gs` 與 `Sidebar.html` 檔案複製貼上。
- 依實際資源更新 `Constants.gs`，並確認模板與輸出資料夾皆允許 Apps Script 執行帳號存取。
- 回到文件重新載入頁面，功能表應出現「計畫助手」項目，點選後即可開啟側欄進入測試。
- 初次測試建議以最小案例送出，確認成功建立新文件並正確填入各段落內容。

======================================
(三) 架構與程式檔案
======================================
1.前端側欄
- `Sidebar.html` 以原生 HTML、CSS 與 JavaScript 實作，負責表單結構、輸入驗證、文字組句與成果預覽顯示。
- `updateGoalBlocks()`、`renderFormal()` 等函式會根據使用者勾選服務自動更新短、中、長期目標區塊，並同步顯示碼別與可輸入數量欄位。

2.後端流程
- `Main.gs` 提供自訂功能表與核心函式 `applyAndSave(form)`，協調模板複製、段落寫入與結果回傳。
- `H1_CallDate.gs`、`H1_VisitDate.gs`、`H1_Attendees.gs`、`H1_CaseProfile.gs`、`H1_CareGoals.gs`、`H1_MismatchPlan.gs` 等模組各自處理一個文件段落，確保邏輯分層清楚且易於維護。

3.通用工具
- `Utils.gs` 集合重複使用的函式，其中 `replaceBlockUnderHeading` 會尋找指定標題並將下方多行文字整段替換，適用於照顧目標等長段落。
- `FilesVersion.gs` 以現有檔名計算版號，`HRLookup.gs` 負責讀取試算表提供人員名單，所有模組皆可重用這些工具以避免重複程式碼。

======================================
(四) 操作流程與介面細節
======================================
1.開啟與同步
- 使用者開啟文件後 `onOpen` 會掛載「計畫助手」選單，點選即可透過 `showSidebar()` 顯示側欄。
- 側欄初始化時會載入個管師與照專名單、預設日期與初始段落文字，確保使用者在第一時間即可檢視內容預覽。

2.表單輸入區塊
- 基本資料區塊會決定名單過濾與命名規則，必要欄位皆有驗證以避免遺漏關鍵資訊。
- 身心概況、經濟與家庭等段落使用即時組句函式，使用者每次更新輸入都能立即看到預覽結果以確認語句是否符合需求。
- 其他自填區塊保留自由輸入空間，並提供 AI 潤稿入口（目前回傳原文），維持與既有流程相容。

3.照顧目標設定
- `GOAL_SERVICE_GROUPS` 以服務群組分類呈現短期、中期與長期目標候選項目，每項服務都顯示碼別與名稱，例如「BA13[陪同外出]」，方便對照計畫書標準。
- 勾選服務後，系統會顯示對應的數量輸入框與描述提示，`updateGoalBlocks()` 會即時生成 `shortGoalBlock`、`midGoalBlock` 與 `longGoalBlock` 預覽文字。
- 每個目標區塊皆以分隔線「======================================」、子標題編號與條列項目輸出，確保匯入文件後維持統一格式。

======================================
(五) 自訂資料與擴充指南
======================================
1.GOAL_SERVICE_GROUPS 調整
- 若需新增或調整服務項目，可於 `Sidebar.html` 的 `GOAL_SERVICE_GROUPS` 中設定服務碼、顯示名稱、預設敘述與數量欄位提示。
- 每個項目需同時提供 `shortTerms`、`midTerms`、`longTerms` 描述，系統會根據勾選狀態自動產出對應段落。
- 調整完成後請手動測試，確認勾選、輸入數量與預覽同步更新且碼別顯示正確。

2.後端段落寫入
- `H1_CareGoals.gs` 使用 `replaceBlockUnderHeading` 取代文件內既有段落；若目標區塊沒有選項可寫入，函式會保留原本文字作為安全回退。
- 新增段落時可複製現有 `H1_*` 模組結構，並於 `Main.gs` 的 `applyAndSave` 內依序加入呼叫，以維持產出流程。

3.擴充實務建議
- 新增欄位時需同步更新前端表單、`applyAndSave` 的資料組裝以及對應 `H1_*` 模組，避免資料遺漏。
- 若要對接外部 API（例如真正的 AI 潤稿），請在後端增加權限檢查與錯誤處理，確保敏感資訊不會外洩。

======================================
(六) 測試與排錯
======================================
1.手動驗證流程
- 於測試文件開啟側欄並填寫必填欄位，確認勾選服務後 `updateGoalBlocks()` 能顯示短、中、長期預覽與數量欄位。
- 送出表單後應成功產製新文件，檢查各段落是否含有分隔線、編號與條列，特別留意照顧目標是否依碼別順序呈現。

2.常見排錯方向
- 若側欄無法載入名單，請檢查 `MANAGERS_SHEET_ID` 與 `CONSULTANTS_BOOK_ID` 是否更新為正確試算表並授權存取。
- 若文件未正確覆蓋舊文字，請確認 `replaceBlockUnderHeading` 的標題名稱是否與模板內完全相符，並檢查是否有額外表格或圖片阻擋段落。

3.版本控管建議
- Apps Script 專案可透過 `File → Manage Versions` 標記穩定版本；若使用多端協作，建議搭配 `clasp` 或 Git 儲存庫追蹤變更。
- 送交修改前請保持工作樹乾淨，移除暫存常數或測試輸出，並更新文件說明以利後續維護。

======================================
(七) 支援與貢獻
======================================
1.協作流程
- 建議以 Pull Request 方式提交修改，並在說明中註記變更內容與測試結果，讓其他維護者能快速審閱。
- 對於跨模組調整，請同步更新 `README.md` 與 `AGENTS.md`，確保所有協作者了解新的規則或資料結構。

2.回饋通道
- 若發現模板、名單或照顧目標字典需要更新，請先於 Issue 記錄需求，再行調整程式與文檔。
- 使用過程遇到錯誤時，請附上操作步驟、輸入資料概述與預期結果，協助開發者重現並修正問題。
=======
# AA01 計畫助手

AA01 是一套以 Google Apps Script 打造的 Google 文件附加功能。長照個管師可在計畫書公版文件中開啟「計畫助手」側欄，填入個案資訊後，由程式自動：

1. 依照命名規則複製公版文件到指定雲端硬碟資料夾。
2. 將側欄輸入內容寫入新文件的各個段落。
3. 回傳新檔資訊並自動開啟，節省大量手動編修時間。

本文說明整體架構、環境需求、運作流程以及每個檔案的角色，協助開發者或使用者快速了解系統。

---

## 系統架構概覽

```
Google Docs (使用者文件)
   ├── 自訂功能表：計畫助手 → showSidebar()
   └── HtmlService 側欄：Sidebar.html
          ├── 收集輸入、組句、基本驗證
          └── 呼叫 google.script.run.applyAndSave(form)
                  └── Main.gs / applyAndSave(form)
                        ├── 依資料夾檔名計算版號 (FilesVersion.gs)
                        ├── 依段落寫入內容 (H1_*.gs)
                        └── 通用工具 (Utils.gs)
```

* **前端 (Sidebar.html)**：使用原生 HTML/CSS/JavaScript 建立表單介面，並在提交前負責資料整理、文字重組、欄位驗證。
* **後端 (`*.gs`)**：在 Apps Script Runtime 中執行。主要負責複製模板文件、依段落更新內容、查詢 Google 試算表等。

---

## 關鍵檔案與模組

| 檔案 | 內容摘要 |
| --- | --- |
| `AGENTS.md` | 專案維護指南與開發原則。|
| `Main.gs` | 建立「計畫助手」選單、顯示側欄、接收前端表單並驅動整體流程。|
| `Constants.gs` | 集中管理外部資源 ID（模板文件、輸出資料夾、個管師/照專試算表）。部署前需依實際環境調整。|
| `FilesVersion.gs` | 依現有檔案命名計算下一版號 (`baseName_Vn` → `n+1`)。|
| `Utils.gs` | 共用函式：尋找標題段落、插入或取代段落內容、日期格式轉換等。所有 H1_* 模組皆仰賴這些工具。|
| `H1_CallDate.gs`~`H1_MismatchPlan.gs` | 各段落的寫入邏輯，將表單資料轉換為正式文字並寫入 Document Body。|
| `HRLookup.gs` | 透過 `SpreadsheetApp` 讀取 Google 試算表，依單位代碼抓取個管師/照專名單供前端下拉選單使用。|
| `Sidebar.html` | 側欄 UI 與邏輯。負責收集使用者輸入、產生描述文字、基本驗證與呼叫後端函式。|

---

## 執行環境與外部資源

AA01 需在 Google Workspace 環境執行，並取得下列服務權限：

* Google Docs API (`DocumentApp`)：讀寫公版文件內容。
* Google Drive API (`DriveApp`)：複製模板並寫入指定資料夾。
* Google Sheets API (`SpreadsheetApp`)：讀取個管師及照專名單。

部署前請在 `Constants.gs` 調整以下常數為自己環境的 ID：

| 常數 | 用途 |
| --- | --- |
| `TEMPLATE_DOC_ID` | 計畫書公版 Google 文件 ID。|
| `OUTPUT_FOLDER_ID` | 輸出文件的雲端硬碟資料夾 ID。|
| `MANAGERS_SHEET_ID` / `MANAGERS_SHEET_NAME` | 存放個管師名單的試算表與工作表名稱（B 欄=員工編號、H 欄=姓名）。|
| `CONSULTANTS_BOOK_ID` / `CONSULTANTS_BOOK_NAME` | 照專名單試算表資訊（A 欄=單位代碼、B 欄=姓名、C 欄=狀態）。|

> ⚠️ 這些 ID 為特定環境的資源。若未更新，程式將無法存取或寫入正確資料。

---

## 部署與初始化流程

1. **建立 Google 文件專案**
   - 在目標 Google 文件中開啟 `Extensions → Apps Script`，建立專案。
   - 將此儲存庫中的所有檔案（`.gs` 與 `Sidebar.html`）貼入 Apps Script IDE。

2. **設定常數**
   - 依實際資源填入 `Constants.gs`。
   - 確認模板文件與輸出資料夾的共用權限允許 Apps Script 帳號存取。

3. **授權**
   - 第一次執行 `showSidebar` 或 `applyAndSave` 時，需授權 Apps Script 存取 Docs/Drive/Sheets。

4. **測試**
   - 於模板文件中重新載入頁面，應看到「計畫助手」功能表。
   - 開啟側欄、填入測試資料並點選「產出」，確認能成功建立新檔。

### 選用：使用 `clasp` 本地開發

若需要在本地與 Apps Script 同步，可安裝 [clasp](https://github.com/google/clasp) 並將本專案連結至遠端 Apps Script 專案，以利版本控管。此儲存庫採平面檔案結構，與 `clasp` 預設格式相容。

---

## 運作流程細節

1. **顯示側欄**
   - `onOpen` 在文件載入時建立「計畫助手」功能表，使用者點選後執行 `showSidebar()`。
   - `showSidebar` 以 `HtmlService` 載入 `Sidebar.html`，側欄寬度 420px。

2. **側欄互動** (`Sidebar.html`)
   - 初始化時預設「電聯日期」「家訪日期」為今日，並透過 `google.script.run` 載入個管師及照專名單。
   - 使用者輸入資料時即時重組段落文字（特別是「(一)身心概況」等長段落），並顯示預覽。
   - 送出前執行驗證：必填欄位、部分協助的說明文字、皮膚病灶醫療院所等。
   - 將所有欄位整合成 `form` 物件，呼叫 `applyAndSave(form)`。

3. **後端寫入** (`Main.gs` + `H1_*.gs`)
   - `applyAndSave` 先計算新檔名稱（`單位代碼_家訪日期_個案姓名_V{版號}`）。
   - 於 `OUTPUT_FOLDER_ID` 指定的資料夾中，以 `TEMPLATE_DOC_ID` 為模板建立副本並開啟 Body。
   - 依序呼叫 `applyH1_*` 函式處理各段落：
     - `H1_CallDate` / `H1_VisitDate`：更新標題列文字或插入出院日期。
     - `H1_Attendees`：組出偕同訪視者句子（包含主照者、照專、其他參與者）。
     - `H1_CaseProfile`：分段處理個案概況六大小節，必要時補上預設文字。
     - `H1_CareGoals`：寫入照顧問題、短/中期四格、長期目標。
     - `H1_MismatchPlan`：整合不一致原因與常用快捷語句。
   - 完成後儲存關閉文件，回傳新檔資訊給前端。

4. **前端回饋**
   - 側欄顯示「已建立新檔並寫入內容」訊息並開啟新文件分頁。

---

## 介面重點說明（Sidebar.html）

* **基本資料**：單位代碼決定下拉選單內容（個管師、照專名單）。
* **(一) 身心概況**：
  - 內建多層邏輯（視力、聽力、疼痛、皮膚病灶、ADL、睡眠等），透過即時組句產生段落。
  - `buildSection1Text_v2` 會根據輸入產出完整句子並呈現在預覽框。
* **(二)~(四)**：經濟收入、居住環境、社會支持皆維持既有表單邏輯並組句。
* **(五)(六)**：其他與複評評值可手動輸入文字，提供 AI 潤稿按鈕（目前僅回傳原文）。
* **照顧目標**：支援問題清單（最多 5 項）及短/中/長期目標；長期目標會彙整短中期欄位。
* **不一致原因與追蹤計畫**：常用快捷語句可勾選後自動附加在第三欄。
* **產出按鈕**：送出前進行欄位驗證並組成 `form` 物件。

---

## 常見維護與擴充建議

* 新增段落：建立 `H1_NewSection.gs`，撰寫 `applyH1_NewSection(body, form)`，並在 `Main.gs` 中按段落順序呼叫。
* 調整輸出格式：優先修改對應的 `H1_*` 模組，必要時更新 `Utils.gs` 的輔助函式。
* 新增欄位：
  1. 在 `Sidebar.html` 新增 UI 與資料整合邏輯。
  2. 調整 `applyAndSave` 的 `form` 組裝。
  3. 在適當的 `H1_*` 函式使用新欄位。
* 對接真實 AI 潤稿：在 `Main.gs` 的 `polishSection` 實作串接外部 API，並遵守資料隱私規範。

---

## 測試建議

因專案沒有自動化測試，建議在每次修改後手動進行：

1. 於測試文件中開啟側欄，完成一份最小案例（僅必填欄位），確保能產生文件且內容完整。
2. 嘗試含有全部欄位的完整案例，確認段落組句格式正確（包含多重選項、快捷語句）。
3. 測試外部資源失敗情境（如撤除試算表權限），確認錯誤訊息清楚易懂。

---

## 版本控管

* 目前程式碼以平面檔案管理，適合直接複製到 Apps Script IDE。
* 建議在雲端端開啟 `File → Manage Versions`，將穩定版標記版本，以便回復。
* 若與多名開發者協作，建議採用 Git 儲存庫（如本專案）搭配 `clasp` 同步程式碼。

---

## 支援與回饋

若使用者或同仁發現：

* 字典/下拉選項需更新。
* 新段落文字格式與政策調整。
* 產出文件內容有誤或漏填。

請更新 Issues 或直接修改程式後提交 PR，並確保 README 與 `Constants.gs` 的說明保持同步。

祝開發順利！

