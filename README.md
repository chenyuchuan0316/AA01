======================================
(一) 系統簡介
======================================
1.服務定位
- AA01 計畫助手是一套建置於 Google Apps Script 的附加元件，協助長照個管師在公版 Google 文件中透過側欄快速產製個案計畫書。
- 系統提供一致的輸入介面與自動化文字組織流程，讓前端表單與後端文件寫入保持同步並降低人工維護成本。

2.整體流程
- 使用者在公版文件開啟「計畫助手」，由 `showSidebar()` 載入 `Sidebar.html` 並初始化各區塊與預設值。
- 側欄收集完整表單資料，組合照顧目標與其他敘述後以 `google.script.run.applyAndSave(form)` 傳送至 Apps Script 後端。
- 後端依照命名規則複製模板、呼叫 `H1_*` 模組寫入段落，最終回傳新文件連結與狀態訊息。

3.輸出成果
- 新文件名稱遵循「單位代碼_家訪日期_個案姓名_V{版號}」格式，確保版本遞增與檔案可追蹤。
- 每個段落都以標題、分隔線與條列格式呈現，特別是照顧目標會根據短、中、長期設定自動產出完整描述。

======================================
(二) 執行環境與初始化
======================================
1.必要權限
- 專案必須在 Google Workspace 帳號下執行，並授予 `DocumentApp`、`DriveApp`、`SpreadsheetApp` 權限以便讀寫文件、複製模板與存取人員名單。
- 首次執行 `showSidebar` 或 `applyAndSave` 時，系統會提示授權流程，請以具有相關資源存取權的帳號完成授權。

2.常數設定
- `Constants.gs` 集中管理所有外部資源，部署前需依環境更新以下 ID 與名稱：
- `TEMPLATE_DOC_ID`：設定計畫書公版文件 ID，使系統能建立副本並作為寫入基礎。
- `OUTPUT_FOLDER_ID`：指定輸出目錄 ID，確保新檔案按組織政策存放於正確資料夾。
- `MANAGERS_SHEET_ID` 與 `MANAGERS_SHEET_NAME`：提供個管師名單來源，欄位需包含員工編號與姓名供下拉選單使用。
- `CONSULTANTS_BOOK_ID` 與 `CONSULTANTS_BOOK_NAME`：提供照專名單與狀態欄位，側欄會依單位代碼自動過濾可選擇人員。

3.部署與初始化步驟
- 在目標 Google 文件中使用 `Extensions → Apps Script` 建立專案，將儲存庫內所有 `.gs` 與 `Sidebar.html` 檔案複製貼上。
- 依實際資源更新 `Constants.gs`，並確認模板與輸出資料夾皆允許 Apps Script 執行帳號存取。
- 回到文件重新載入頁面，功能表應出現「計畫助手」項目，點選後即可開啟側欄進入測試。
- 初次測試建議以最小案例送出，確認成功建立新文件並正確填入各段落內容。

======================================
(三) 架構與程式檔案
======================================
1.前端側欄
- `Sidebar.html` 以原生 HTML、CSS 與 JavaScript 實作，負責表單結構、輸入驗證、文字組句與成果預覽顯示。
- `updateGoalBlocks()`、`renderFormal()` 等函式會根據使用者勾選服務自動更新短、中、長期目標區塊，並同步顯示碼別與可輸入數量欄位。

2.後端流程
- `Main.gs` 提供自訂功能表與核心函式 `applyAndSave(form)`，協調模板複製、段落寫入與結果回傳。
- `H1_CallDate.gs`、`H1_VisitDate.gs`、`H1_Attendees.gs`、`H1_CaseProfile.gs`、`H1_CareGoals.gs`、`H1_MismatchPlan.gs` 等模組各自處理一個文件段落，確保邏輯分層清楚且易於維護。

3.通用工具
- `Utils.gs` 集合重複使用的函式，其中 `replaceBlockUnderHeading` 會尋找指定標題並將下方多行文字整段替換，適用於照顧目標等長段落。
- `FilesVersion.gs` 以現有檔名計算版號，`HRLookup.gs` 負責讀取試算表提供人員名單，所有模組皆可重用這些工具以避免重複程式碼。

======================================
(四) 操作流程與介面細節
======================================
1.開啟與同步
- 使用者開啟文件後 `onOpen` 會掛載「計畫助手」選單，點選即可透過 `showSidebar()` 顯示側欄。
- 側欄初始化時會載入個管師與照專名單、預設日期與初始段落文字，確保使用者在第一時間即可檢視內容預覽。

2.表單輸入區塊
- 基本資料區塊會決定名單過濾與命名規則，必要欄位皆有驗證以避免遺漏關鍵資訊。
- 身心概況、經濟與家庭等段落使用即時組句函式，使用者每次更新輸入都能立即看到預覽結果以確認語句是否符合需求。
- 其他自填區塊保留自由輸入空間，並提供 AI 潤稿入口（目前回傳原文），維持與既有流程相容。

3.照顧目標設定
- `GOAL_SERVICE_GROUPS` 以服務群組分類呈現短期、中期與長期目標候選項目，每項服務都顯示碼別與名稱，例如「BA13[陪同外出]」，方便對照計畫書標準。
- 勾選服務後，系統會顯示對應的數量輸入框與描述提示，`updateGoalBlocks()` 會即時生成 `shortGoalBlock`、`midGoalBlock` 與 `longGoalBlock` 預覽文字。
- 每個目標區塊皆以分隔線「======================================」、子標題編號與條列項目輸出，確保匯入文件後維持統一格式。

======================================
(五) 自訂資料與擴充指南
======================================
1.GOAL_SERVICE_GROUPS 調整
- 若需新增或調整服務項目，可於 `Sidebar.html` 的 `GOAL_SERVICE_GROUPS` 中設定服務碼、顯示名稱、預設敘述與數量欄位提示。
- 每個項目需同時提供 `shortTerms`、`midTerms`、`longTerms` 描述，系統會根據勾選狀態自動產出對應段落。
- 調整完成後請手動測試，確認勾選、輸入數量與預覽同步更新且碼別顯示正確。

2.後端段落寫入
- `H1_CareGoals.gs` 使用 `replaceBlockUnderHeading` 取代文件內既有段落；若目標區塊沒有選項可寫入，函式會保留原本文字作為安全回退。
- 新增段落時可複製現有 `H1_*` 模組結構，並於 `Main.gs` 的 `applyAndSave` 內依序加入呼叫，以維持產出流程。

3.擴充實務建議
- 新增欄位時需同步更新前端表單、`applyAndSave` 的資料組裝以及對應 `H1_*` 模組，避免資料遺漏。
- 若要對接外部 API（例如真正的 AI 潤稿），請在後端增加權限檢查與錯誤處理，確保敏感資訊不會外洩。

======================================
(六) 測試與排錯
======================================
1.手動驗證流程
- 於測試文件開啟側欄並填寫必填欄位，確認勾選服務後 `updateGoalBlocks()` 能顯示短、中、長期預覽與數量欄位。
- 送出表單後應成功產製新文件，檢查各段落是否含有分隔線、編號與條列，特別留意照顧目標是否依碼別順序呈現。

2.常見排錯方向
- 若側欄無法載入名單，請檢查 `MANAGERS_SHEET_ID` 與 `CONSULTANTS_BOOK_ID` 是否更新為正確試算表並授權存取。
- 若文件未正確覆蓋舊文字，請確認 `replaceBlockUnderHeading` 的標題名稱是否與模板內完全相符，並檢查是否有額外表格或圖片阻擋段落。

3.版本控管建議
- Apps Script 專案可透過 `File → Manage Versions` 標記穩定版本；若使用多端協作，建議搭配 `clasp` 或 Git 儲存庫追蹤變更。
- 送交修改前請保持工作樹乾淨，移除暫存常數或測試輸出，並更新文件說明以利後續維護。

======================================
(七) 支援與貢獻
======================================
1.協作流程
- 建議以 Pull Request 方式提交修改，並在說明中註記變更內容與測試結果，讓其他維護者能快速審閱。
- 對於跨模組調整，請同步更新 `README.md` 與 `AGENTS.md`，確保所有協作者了解新的規則或資料結構。

2.回饋通道
- 若發現模板、名單或照顧目標字典需要更新，請先於 Issue 記錄需求，再行調整程式與文檔。
- 使用過程遇到錯誤時，請附上操作步驟、輸入資料概述與預期結果，協助開發者重現並修正問題。
